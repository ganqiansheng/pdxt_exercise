unit DBAccess;

interface

uses
  SysUtils, Classes, DB, ADODB,XComboBox, Variants, ComCtrls,StdCtrls,Dialogs,
 GblVariable,GblConstant,  GblFunction, GblMessage,DateUtils,Printers,Types,
 excel2000, comobj,StrUtils, te_controls, ksthemestdcontrol, ksthemeprogress,
  ksthemedbgrids, XTeThemeComboBox,forms, SPComm,Math,Windows,scktcomp,uwincepj;

type
  TCmdBlock = Packed  record
    LedNo    : array[0..1] of char;  //屏号
    Cmd      : array[0..7] of char;  //命令码
    WParam   : array[0..63] of char;  //参数
    LParam   : array[0..511] of char;  //参数
  end;
//{$IFNDEF WIN32}
//const MAX_PATH = 144;
//{$ENDIF}

type
  TdmDBAccess = class(TDataModule)
    ADOConnection: TADOConnection;
    ADOStoredProc: TADOStoredProc;
    ADODataSet: TADODataSet;
    ADODataSet1: TADODataSet;
    ADODataSet2: TADODataSet;
    ADOQuery: TADOQuery;
    DataSource1: TDataSource;
    adoconnApp: TADOConnection;
    AdoConnHis: TADOConnection;
    procedure DataModuleCreate(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    {数据库连接函数}
    function Connect(): Boolean;
    function DisConnect(): Boolean;
    function ErrProc():boolean;

    {共通部分}
    function SetItems(var XComboBox: TXTeThemeComboBox;
        const TypeName: string): Boolean;
//    function SetItems_temp(var XComboBox: TXTeThemeComboBox;
//        const TypeName: string): Boolean;
    function SetAllItems(var ListView: TTeThemeSListView;
       const TypeName: string): Boolean;
    function SetAllItemsKBXX(var ListView: TTeThemeSListView;
      const TypeName: string;const akbmc:string;const aksmc:string): Boolean;
    function GetID(const TypeName,ID: string; var param1, param2, param3,
        param4,param5,param6,param7,param8: string;param9:integer): Boolean;
    function GetUserID(const TypeName,ID: string; var param1, param2, param3,
      param4,param5,param6,param7: string;param8: integer; var param9,  param10, param11,param12:string): Boolean;
    function GetID1(const TypeName,inparam1,inparam2: string; var param1, param2, param3,
        param4,param5,param6,param7: string;param8:integer): Boolean;
    function CheckID(const TypeName,ID: string): Boolean;
    function CheckID1(const TypeName,inparam1,inparam2: string): Boolean;

    function NewID(const TypeName,ID, param1, param2, param3,
        param4,param5,param6,param7, param8,param9: string;param10:integer): Boolean;
    function DB_GetHJFS(const p_hszh:integer;const p_yhid:string):integer;
    function NewuserID(const TypeName,ID, param1, param2, param3,param4,param5,param6,
        param7, param8,param9: string;param10:integer;param11,param12,param13: string): Boolean;
    function Newks_xsp(const ksid:string;const xspid:integer;const xsms:string): Boolean;
    function EditID(const Typename,ID, parm1, parm2, parm3,
       parm4,parm5,parm6,parm7,parm8: string): Boolean;
    function EdituserID(const Typename,ID, parm1, parm2, parm3,
       parm4,parm5,parm6,parm7,parm8,parm10,parm11,parm12: string): Boolean;
    function DeleteID(const TypeName,ID: string): Boolean;
    function DeleteID1(const TypeName,inparam1,inparam2: string): Boolean;

    ///显示科室窗口信息//
    function SetDHXXItems(var ListView:TTeThemeDBGrid;  lbl:TLabel;
       const KSID:string;const HSZH:integer;var AdoQuery :tadoquery):Boolean;

    function SetGHXXItems(var ListView: TTeThemeDBGrid; lbl:TLabel;
      const KSID: string; const HSZH:integer;var AdoQuery :tadoquery ): Boolean;

    function SetYSXXItems(var ListView:TTeThemeSListView;
       const HSZH:integer):Boolean;

    function SetFZZHItems(var ListView:TTeThemeSListView;
       const KSID :string;const HSZH:integer;const ordertype:integer):Boolean;
    function SetQTHSZItems(var ListView:TTeThemeSListView;
       const acardno:string;const abrdm:string;const abrxm:string):Boolean;
    function FBGG(const Aggnr:string;const Abfyy:integer;const Ayywj:string;const Axssc:integer;const Axsph:string;const AHSZH:integer):boolean;
    function PutWakeupIDAtPos(const aid:string;const ahszh:Integer):Boolean;
    function DB_PutWakeupIDAtPos(const aid:string;const ahszh:Integer):Boolean;
    function DB_ReSortGroup(const agroup: string;
      const ahszh: Integer): Boolean;
    function DB_GetGroupPatientPos(const aksid:string;const asjdbz:Integer;
      const aghhm:string;const ahszh:Integer;const ajzbz:Integer):Integer;
    function DB_SetSpecialPosByID(const aid:string;
      const ayxjid:string): Boolean;
    function DB_RebackPatientByID(const aid:string;
      const ahszh:Integer;const akeepyh:Integer;const ayhid:string;
      const afzzhtype:Integer;const afzorzh:integer): Boolean;
    function DB_SetHisPatientStatus(const aid:string): Boolean;
    function GetSBCardNo():String;//得到社保卡号.
    function GetSBCardNo_F10():String;//得到社保卡号.
    Function GetSBYYJKKCardNO():string; //得到苏北健康卡卡号
    function GetSHSBCardNo():String;//得到上海社保卡号.
    function GetSHSBCardNo4():String;//得到上海社保卡号.(华旭金卡)
    function GetSHSBCardNo5(const sQRCode:string):String;//得到二维码对应电子医保卡卡号
    function GetLSSBCardNo():String;//得到上海社保卡号.
    function GetNBSBCardNO:String;//得到宁波象山社保卡号.
    function GetNBJKKCardNO:String;//宁波健康卡

    function GetTZSBCardNO:String;  //得到台州社保卡//
    function GetTZJKKCardNO:string; //得到台州健康卡、市民卡//
    function GetJXSBCardNO:String;  //得到嘉兴社保卡//
    function hex2asc(strhex: string; var strasc: string;
      len: integer): integer;
    function SetKS(var ksxx:array of udfks ;
       const HSZH:integer):integer;
    function SetAllKS(var ksxx:array of udfks;
       const HSZH:integer):integer;
    function SetDQBR(var lblGHHM: TLabel; lblBRXM:TLabel;
       const KSID: string; const HSZH:integer ): Boolean;
    function SetGroupCount(var lbl:TLabel;
       const KSID: string; const HSZH:integer ): Boolean;
    function GetZDZT(const zdid: string): string;//得到呼叫器的状态
    function GetRoom(const ARoomName:string):string;//得到呼叫终端的编号:
    function GetZDID(const Ayhid: string;const Afjh:string): string;
    function GetInsideFunction(const AoldFunction:string):string;//得到内部的功能码;
    function CheckFuncCode(const Azdid:string;const ARequst:string):string;//得到按功能键后的功能码。
    function YHLogin(const zdid:string;const cmd:string;
      const YHID:string;const YHxm:string;
      const Aip:string;const Aport:Integer;
      const Ayhmm:string ;
      const Abz:integer):string;
    function YHInsertYH(const ZDID: string; const cmd:string;const YHID:string;const YHxm:string): string;
    function YJLink(const Aip:string):string;
    function YHLogOut(const zdid:string;const cmd:string):string;
    //function YHCallNext(const zdid:string;const cmd:string):string;
    function YHCallNextKeySet(const zdid:string;const cmd:string;const Akeyset:string):string;
    function YHCallNextKeySet_new(const zdid:string;const cmd:string;const Akeyset:string):string;
    function YHAutoCallNext(const ksid:string;const ACount:integer):Boolean;
    function YHCallNext_ks(const Ksid:string;const ACount:integer):string;
    function YHReCall(const zdid:string;const cmd:string):string;
    function YHEnterCall(const ZDID: string; const cmd:string; const callno:string): string;
    function YHEnterCallByID(const ZDID: string; const cmd:string; const callno:string): string;
    function YHQHCall(const ZDID: string; const cmd:string;const Acallno:string): string;
    function YHNoCall(const zdid:string;const cmd:string;const AKeySet:string):string;   //忽略
    function YHDontCall(const ZDID: string; const cmd:string;const Abrdm:string): string;// //忽略,不呼叫下一位
    function YHstopCall(const zdid:string;const cmd:string):string; //暂停
    function YHcontinueCall(const zdid, cmd: string): string;//继续
    function YHRebackCall(const zdid:string;const cmd:string;const CallNO :string):string;  //召回
    function YHSelCall(const zdid:string;const cmd:string;const CallNO :string):string;//选呼
    function YHSelCallByID(const zdid:string;const cmd:string;const CallNO :string):string;//选呼
    function YHSelCallBrdm(const zdid:string;const cmd:string;const CallNO :string):string;//选呼按病人代码
    function YHBreakCall(const zdid:string;const cmd:string;const aCallNO :string):string;
    function YHBreakCallBrdm(const zdid:string;const cmd:string;const CallNO :string):string;//按BRDM消号
    function YHGoCheckBrdm(const zdid:string;const cmd:string;const CallNO :string):string;
    function YHSelCall1(const zdid:string;const cmd:string;const CallNO :string):string;//选呼但不改变状态
    function YHAskRoom(const zdid:string;const cmd:string;const CallNO :string):string;//查询号码对应的医生和诊室
    function YHSeleCall_ks(const KsID: string;const Ghhm:string;const AFJH:string): boolean;overload;
    function YHSeleCall_ks(const KsID: string;const Ghhm:string;const AFJH:string;const Astatus:Integer): boolean;overload;
    function YHSeleKeShi(const zdid: string;const cmd:string;const ksid:string;const yhid:string): string;
    function YHRequst(const zdid:string;const cmd:string):string;
    function YHGetZdid(const AIP:string):string;
    function YHSendWaitNum(const Aksid:string;const Atype:integer):string;
    function YHSendWaitNumSZ(const Aksid:string;const Atype:integer):string;//发送预设科室病人数。
    function YHInsertTopCall(const ZDID: string; const cmd:string;const Callno:string): string;
    function YHInsertBottomCall(const ZDID: string; const cmd:string;const Callno:string): string;
    function YHMoveToNext(const ZDID: string; const cmd:string;const Callno:string): string;
    function YHMoveToNextByID(const ZDID: string; const cmd:string;const ajrid:string): string;
    function YHWakeupByID(const ZDID: string; const cmd:string;const ajrid:string): string;
    function YHGetKeySet(const zdid:string;const cmd:string;const Callno:string):string;
    function YHCallGroupSet(const zdid, cmd, Callno: string): string;
    function YHYXJCall(const zdid:string;const cmd:string;const CallNO :string):string;
    function YHGetSelfInfo(const zdid:string;const cmd:string;const CallNO :string):string;
    function YHSetSelfInfo(const zdid:string;const cmd:string;const CallNO :string;
      const recIp:string;const recPort:integer):string;
    function YHSetCallZJ(const zdid:string;const cmd:string;const CallNO :string;
      const recIp:string;const recPort:integer):string;
    function YHChangeVolue(const zdid,cmd,avolue:string):string;
    function YHChangecheckinshow(const zdid, cmd,
      avolue: string): string;
    function YHSelectHJFS(const ZDID: string; const cmd:string;const ahjfs:string): string;
    function GetSendList(const zdid:string;const cmd:string):string;
    function GetSendListOrderByGHHM(const zdid:string;const cmd:string):string;
    function GetSendListOrderBySXID(const zdid:string;const cmd:string):string;
    function GetSendListOrderByGHSJ(const zdid:string;const cmd:string):string;
    function ShowYHMessage(const zdid:string;const msgid:string):boolean;
    function YHGetWaitNum(const zdid:string;const cmd:string):string;
    function YHGetWaitNumKS(const zdid:string;const cmd:string):string;
    function GetHJWaitNumKS(const AKSID: string): integer;
    function GetHJWaitNumYH(const Ayhid: string): integer;
    function GetSysTitle(const Asys:integer):boolean;
    procedure  WriteDispMsg(const zdid :string;fjh:string;fjmc:string;
             zth:string;ztmc:string;
             ksid :string;ksmc:string;
             ghhm:string;brxm:string;
             yhid:string; yhmc:string;
             yxjid:string;yxjmc:string;
             by6:string;
             ddrs:integer;ztbz:integer;acallnos:string;acallnames:string;by4:string);

    //召回
    function FZZH(const JRID:string;const KSID:string;const AkeepYH:integer;const AYHID:string;const afzorzh:integer):boolean;
    function FZZHByHszh(const JRID:string;const KSID:string;
      const AkeepYH:integer;const AYHID:string;const ahszh:Integer):boolean;
    //弃号
    function Qh(const JRID :string;const kssxid :string;const ksid:string):Boolean;

    //清除
    function QingChu(const Kssj :string;const Jssj :string;const QingChuAll:integer;const QCDL :integer;const HMFW:integer):Boolean;
    //清除某一时间段的数据
    function QingChuSJD(asjd:integer;const HMFW :integer ):Boolean;
    //消号按时间段
    function XiaoHaoSJ(const Kssj :string;const Jssj :string;const AKsid:string):Boolean;
    //消号按挂号号码段
    function XiaoHaoGhhm(const KsGhhm :string;const JSGhhm :string;const AKsid:string):Boolean;
    //消号按序号段
    function XiaoHaoXH(const KsXh :integer;const JSxh :integer;const AKsid:string):Boolean;
    //选择医生
    function XZYS(const JRID :string;const YHID:string):Boolean;
    //提前退后
    function TQTH(const JRID :string;const KSID :string;
             const kssxid:string;const TQFS:integer;const TQWS:integer):Boolean;
    //换科室
    function HKS(const JRID :string;const kssxid :string ;
             const KSID:string;const NewKsid:string):Boolean;
    //换科室
    function ksJzh(const JRID,kssxid,KSID, NewKsid,newksmc:string;const number:integer):Boolean;
    //设置优先级.
    function SZYXJ(const JRID :string;const YXJID:string):Boolean;
    //设置普通优先
    function SZPtYx(const JRID:string;const YXJID:string):Integer;
    //设置预约优先
    function SZYyYx(const JRID:string;const YXJID:string):Integer;
    //打印票单
    // TickNum 为张数
    function PrintTick(const TickNum:integer):Boolean;
    //打印票单串口
    // TickNum 为张数
    function PrintTickCom(const TickNum:integer):Boolean;
    //显示医生信息.
    function SetYSXXList(var ListView:TTeThemeSListView;const KSID:string;const isLogin:integer;
       const HSZH:integer):Boolean ;
    function SetYSPBXXList(var ListView:TTeThemeSListView;const KSID:string;const isLogin:integer;
       const HSZH:integer):Boolean ;
    //显示科室医生列表.
    function SetYSItems(var XComboBox: TXTeThemeComboBox;
             const KSID: string;const hszh:integer ): Boolean;
    //显示科室分诊医生列表
    function SetFZYSItems(var XComboBox: TXTeThemeComboBox;
             const KSID: string;const hszh:integer ): Boolean;

    //显示优先级信息.
    function SetYXJXXList(var ListView:TTeThemeSListView;
       const HSZH:integer):Boolean ;
  //     dmdbaccess.QuHao(newksid,brdm,brxm,yhid);
    //取号
   function QuHao(const newKSID:string;const newKSMC:string;
    const newBRDM:string; const newBRXM:string;const newYHID:string;
    const newButtonName:string;const newby7:string;const newby3:string;
    const newysxm:string;const newby4:string;const newghhm:string;const newyksdm:string):Boolean;

  //按时间段取号
  function QuHao2(const newKSID:string;const newKSMC:string;
      const newBRDM:string; const newBRXM:string;const newYHID:string;
      const newButtonName:string;const newby7:string;
      const newby3:string;const newysxm:string;
      const newby4:string;const newghhm:string;const newyksdm:string):Boolean;

   //终端取号
   function ZDQuHao(const AJH:string):Boolean;

   //显示科室信息.
    function SetKSXXList(var ListView:TTeThemeSListView;
       const HSZH:integer;iscrossgroup:boolean;ksid:string;
       havewait:boolean):Boolean ;

    function SetksXXListQH(var ListView:TTeThemeSListView;
           const HSZH:integer;iscrossgroup:boolean;ksid:string):Boolean ;
    //显示时间段信息。
    function SetSjdXXlist(var ListView:TTeThemeSListView;
         const hszh:integer):boolean;
    //初始化数据;
    function InitDatabase(const HSZH:integer):boolean;
    function GroupClearMorning(const AKsid:string):Boolean;
    //检查此护士站的情况，如果没有此护士站的信息，弹出自动设立界面。
    //如果有，则读出相关信息。
    function CheckHSZ(const HSZH:integer):integer;
    function ReadFromHszSZ(const hszh:integer):integer;
    function CHeckHszH(const hszh:integer):integer;
    function SaveToHszSZ(const hszh:integer):integer;
    function CheckGroupPatient(const hszh:integer):boolean;
    function CheckGroupDhxxPatient(const hszh:integer):boolean;
    function CheckGroupDhxxCantCallPatient(const hszh:integer):boolean;
    function CheckGroupDhxxSpecialPatient(const hszh:integer):boolean;
    // 从GHXX表中读取相关数据放入DHXX表中.
    function ReadFromGhxxToDhxx(const hszh:integer;const AGroupID:string):boolean;
    // 从hzxx表中读取回诊病人放入DHXX表中
    function ReadFromHzxxToDhxx(const hszh:integer;const AgroupID:string):boolean;
    //取得登录在ZDID上的医生姓名及房间号.
    function GetZsXm(const ZDId:string):string;
    function GetOp(const AOp:integer;const AOpName:string;const AopKey:string):boolean;
    // 检查时间段复位。
    function CheckSjdFw(const Sj:Tdatetime):boolean;
    //检查是否要自动重启 1--是,其它--否
    function CheckZDFw():integer;
    //工作量分析
    function SetGzlXXlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const bzslsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime):boolean;

  function SetDrGzlXXlist(var ListView:TTeThemeSListView;
               var ProgressBar:TTeThemeProgressBar;
               const ksid :string;
               const ksmc :string;
               const bzslsj:integer;
               const kssj:tdatetime;
               const jssj:tdatetime):boolean;

   function SetFZTJlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const bzslsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime):boolean;

  //取号时间统计
  function SetQHRSTJlist(var ListView:TTeThemeSListView;
               var ProgressBar:TTeThemeProgressBar;
               const ksid :string;
               const ksmc :string;
               const bzslsj:integer;
               const kssj:tdatetime;
               const jssj:tdatetime):boolean;
   //工作状况日报分析
   function SetGzZKRBlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const yhid:string;
             const yhmc:string;
             const bzddsj:integer;
             const bzslsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime;
             const noperson:boolean):boolean;
   //工作状况时报分析
   function SetGzZKSBlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const yhid:string;
             const yhmc:string;
             const bzddsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime;
             const sdkssj:tdatetime;
             const sdjssj:tdatetime):boolean;

   //等待时间分析
   function SetDDSJFXlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const yhid:string;
             const yhmc:string;
             const bzddsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime;
             const ztbz:integer;
             const noperson:boolean):boolean;
   //受理时间分析
   function SetJZSJFXlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const yhid:string;
             const yhmc:string;
             const bzjzsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime;
             const ztbz:integer;
             const noperson:boolean):boolean;

    function SetHMXXlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const bzddsj:integer;
             const bzslsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime;
             const noperson:boolean;
             const aWait,aDiscard:Boolean):boolean;
    //写入EXCEL
    function ListViewToExcel(var listview:TTeThemeSListView;var progressbar:TTeThemeProgressBar;
         const BBTitle:string;
         const BBTitle1:string;
         const BBTitle2:string;
         const BBYHMC:string):boolean ;

    function ListViewToExcelEx(var listview:TTeThemeSListView;
          var progressbar:TTeThemeProgressBar;
         const BBTitle:string;
         const BBTitle1:string;
         const BBTitle2:string;
         const BBYHMC:string;
         const aline:Integer):boolean ;
    {用户登录窗体,密码修改窗体}
    function CheckPassword(const UserID,Password: string): Boolean;

    {用户登录窗体,密码修改窗体}
//    function CheckPassword(const UserID,Password: string): Boolean;
    function EditPassword(const UserID,NewPassword: string): Boolean;

    //处理从其他护士站过来的病人信息
    function arraypatientfrmother(const hszh:integer):boolean;

    //显示每种显示方式中的具体内容
    procedure ShowData(const lvwDataList:TTeThemeSListView);

    //查看暂停状态如果所有用户都暂停则队列暂停
    Function PauseKs(const AYHID:String):integer;
    //查看暂停状态如果暂停则开放队列
    Function ContinueKs(const AYHID:String):integer;

    //修改主科室状态
    Function ChangeFirstGrpState(const AYHID:String;const AState:Integer):Integer;

    //    //选择医生
    function CheckTm(const astrTM :string;const acklx:string):Boolean;
    function WakeupOtherNurseStationNumber(const astrTm:string):Boolean;
    function GetCardInfo(const astrTm :string;aksrq:string;ajsrq:string;
     var patinfo:array of string):Boolean;
    function WakeUpByID(const strID :string):Boolean;
    procedure addlog(filename:string;s:string);
    function  CXPXKSXX():boolean;
    function  CXHMPXKS(const Aksid:string):boolean;
    function CXHMPXKS_ghsj(const Aksid:string):boolean;
    function AutoFillzbbr():boolean;
    function YHQZCall(const zdid, cmd: string): string;//求助
    function YHToNextTurn(const ZDID,cmd:string;const Nksid:string): string;//将最后一个呼叫的号码换到一个指定的科室
    function YHPJ(const ZDID,cmd:string;pj:string): string;//评价
    function YHSetRollMsg(const ZDID,cmd:string;const msg:string):string;
    function GetDBValue(const TypeName,ID,AfieldName:string): string;//得到表中指定行的一个字段值,如果没有找到返回'';
    function SetDBValue(const TypeName,ID,AFieldName,AValue:string): boolean;//设置表中指定行的一个字段值,不成功返回false,成功返回TRUE;
    //护士暂离处理
    function NurseLeave(const AFlag:integer): string;
    //重新打印票单
    function PrintNO(const JRID :string):Boolean;
    function GetScreenSoundStr(const Aksid:string;fjh:string;fjmc:string;
             zth:string;ztmc:string;ksmc:string;
             ghhm:string;brxm:string;yhmc:string;yxjmc:string;
             by6:string;acallnos:string;acallnames:string;by4:string;
             zbharray:array of string;zbxmarray:array of string;
             zbby4:string;zbxx:string):string;
    function UpdateHJZDDiscon(const Aip:string;const Aport:Integer):Boolean;
    function CheckLockIP(const Azdid:string;const Aip:string):Boolean;

    function GetYHCallKS(const Ayhid:string;
       var CallKsCount:Integer;
       var CallGroups: array of CallGroup_Info):Boolean;
    function GetYHPBCallKS(const Ayhid: string;
      const AXQ:string;
      var CallKsCount: Integer;
      var CallGroups: array of CallGroup_Info): Boolean;
    function SendUdps: Boolean;
    function ChangeUserGroup(const auser,
      newgroup: string): Boolean;
    function UpdateGroupHided(): Boolean;
    function getMaxSeqStr(jrid:string;tmpghhm:string;tmpby7:string;
      YXJID:string):string;
    function getMinSeqStr(jrid:string;tmpghhm:string;tmpby7:string;
      YXJID:string):string;
    function CreateAView(const vname:string;const vSql:string):Boolean;
    function DeleteAView(const vname:string):Boolean;
    function GetZBBRMaxKSSXID(const ksid,jrid:string;const ahszh:Integer):Integer;
    function GetSendSmsMaxKSSXID(const ksid,jrid:string;ahszh:Integer):Integer;
    function GetYYBRMaxKSSXID(const ksid,by7,jrid,sjdbz:string;ahszh:Integer):Integer;
    function GetYXBRMaxKssxid(const ksid,yxjid,JRID:string):Integer;
    function ReplaceNoTTS(const SourceStr:string):string;
    function GetYSBH: Boolean;
    function ReplaceYSBH(const str:string;const YSBH:Integer;const YSBHZF:string):string;
    function GetMinSjdbzPos(const aksid,asjdbz,jrid:string;const ahszh:integer):Integer;
    function GetSameSjdbzPos(const aksid,asjdbz,aghhm,jrid:string;const ahszh:integer):Integer;
    function GetLargeSjdbzPos(const aksid, asjdbz,
        aghhm,jrid: string;const ahszh:integer): Integer;
    function GetNotWakeupMaxKSSXID(const aksid,asjdbz,jrid:string;const ahszh:integer):Integer;
    function ReadHISPBForHide():Boolean;
    function CheckMzh():Boolean;
    function CheckXMSP():Boolean;
    function CheckField(const afieldname:string): Boolean;
    function getcalltermgif(const typename:string;const aid:string):string;
    function UpdateRuntime(const ahszh:Integer): Boolean;
    function DB_WakeupByID(const aid: string;const ahszh:Integer;const aTQJH:boolean): integer;
    function DB_GetGroupPrepareCount(const AGroupID:string):Integer;
    function CheckNotifyGroupToRefresh(const ahszh: Integer): Boolean;
    function insertnotifygrouptorefresh(const atohszh:Integer;const agroupid:string;
        const ahszh:Integer):Boolean;
    function InsertToOrder(const ahszh:Integer;const arankid:Integer;
      const aksid:string;const aorderid:Integer):Boolean;
    function ClearOrderTable(const ahszh:Integer):Boolean;
    function DeleteOrder(const ahszh:Integer;
      const aksid:string):Boolean;
    function GetPatientAge(const aseleid:string):Integer;
    function WriteLogInfo(const logtype:string;const logmsg:string):Integer;
    function ChangeUserShowGroup(const azdid:string;const ayhid:string;const aksid:string):Boolean;
    function GetWaitListByby7(const agroups:string;var pwaitnum:Integer):string;
    function DB_GetServerTime(): TDateTime;
    //显示病人的检查项目信息
    procedure ShowPatGroupInfo(const acardno:string;aksrq:string;ajsrq:string;
      var lvwDataList:TTeThemeSListView);
      //得到年龄
    function getpatage(const abirthday:string):string;
    function ChangeHostVolue(const hostip,avolue:string):boolean;
    function GetPrepareInfo(const ahszh:integer;agroupid:string;adocid:string):string;
    function DB_SetGroupPreparePos(const agroupcode:string;aid:string;
        aoldpos:integer;anewpos:integer):boolean;
    function getPatInfobyBrdm(const abrdm:string;
      const aksdm:string;
      var patinfo:array of Print_Info):integer;
    function getYHCallPatInfo(const azdid: string;
      var patinfo:Print_Info): integer;
    function isLogin(const azdid:string;const ayhid:string;
      var yhxm:string;var ksmc:string):boolean;
    function isInGroup(const azdid:string;const aksid:string):boolean;
    function GotoNoonPause():boolean;
    function RebackWorking():boolean;
    function getReadStr(const astr:string;const atype:string):string;
    function getwaitcount(const agroupcode:string;const asjdbz:integer):integer;
    function SetAllHJZD(const HSZH:integer):integer;
    function SetHJZDYHID(const zdid:string;const ayhid:string):integer;
    function SetHJZDIP(const zdid:string;const aip:string;const aport:integer):integer;
    function SetHJZDRecvtime(const zdid :string;const atime:tdatetime):integer;
    function SetHJZDDDRS(const zdid:string;const addrs:integer):integer;
    //硬件呼叫终端与wince评价器交互新增的过程//
    function SetWincePJ():integer;
    Function InsertDefApp_UserInfo(const apjqid:string;const ayhid:string;const userinfo:string):integer;
    function PutPJValueToDb(const aValue: string;const apjqid:string;const apjxxid:integer;const ayhid:string): string;
    //
    function doPutSpecialForward(const agroupcode:string;const aseq:integer):boolean;
    function doUpdateWaitlistPos(const agroupcode:string;const ajrid:string;
      const ayhid:string;const afjh:string;const ahszh:integer):boolean;
    function getksyxhj(const agroupcode:string):integer;
    function getroomyxhj(const azdid:string):integer;
    function yhcancall(const ajrid:string;const ayhid:string;const abrdys:string):boolean;
    function addyhcancall(const ajrid, ayhid,aflag: string): boolean;
    function addyhcannotcall(const ajrid: string): boolean;
    function doLockOtherGroupSamePat(const ajrid:string):boolean;
    function doUnLockOtherGroupSamePat(const ajrid:string):boolean;
    //从排班表中得到此科室对应的医生//
    function getHisPbYSDM(const anewksid:string;const ayksdm:string;var pnewyhid:string):integer;
    function Db_getysghxx(const anewbrdm:string;const anewbrxm:string;const aby4:string;const anewyhid:string):boolean;
    function SetHisYSDM(const aby4: string;const anewyhid: string): integer;
    //将预约病人自动分诊到对应医生//
    function RequeueMarkedPat():boolean;    
  end;

var
    dmDBAccess: TdmDBAccess;

implementation
uses Graphics, IniFiles, SDQH, uHSZSZ, main, uErrShow, USendRcv,
  ufrmSelectFunc, uMD5, PYIndexUnit, uSDQHMR,declare_unit,
  udeclare_unit_tz,  UHX_Reader, uandroidpj, ufrmQTHSZbrxx;//, //ScIcReader_TLB,
  //tfrhcapi_declare_unit;//GblConstant,  GblFunction, GblMessage, GblVariable;


{$R *.dfm}

{ TdmDBAccess }

function TdmDBAccess.CheckPassword(const UserID,
  Password: string): Boolean;
var
  intResult: Integer;
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_CheckPassword';
      Parameters.Clear;
      Parameters.CreateParameter('UserID',
        ftString, pdInput, 10, UserID);
      //2016-01-03 修改 吴刚
      if gblcodepassword=1 then
      begin
        Parameters.CreateParameter('Password',
          ftString, pdInput, 255, hashstring(trim(Password)));
      end
      else
      begin
        Parameters.CreateParameter('Password',
          ftString, pdInput, 255, trim(Password));
      end;
      Parameters.CreateParameter('hszh',
        ftInteger, pdInput, 4, gblhszh);
      Parameters.CreateParameter('Result',
        ftInteger, pdOutput, 0, 1);

      ExecProc;
      intResult := Parameters.ParamValues['Result'];
      Close;
      if intResult = 1 then
      begin
        //用户密码无效
        result := False;
        Exit;
      end;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;

  //用户密码有效
  result := True;

end;

function TdmDBAccess.CheckID(const TypeName,ID: string): Boolean;
var
  intResult: Integer;
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_CheckID';
      Parameters.Clear;
      Parameters.CreateParameter('TypeName',
        ftString, pdInput, 128, TypeName);
      Parameters.CreateParameter('ID',
        ftString, pdInput, 80, ID);
      Parameters.CreateParameter('inparam1',
        ftString, pdInput, 80, '');
      Parameters.CreateParameter('inparam2',
        ftString, pdInput, 80, '');
      Parameters.CreateParameter('gblHSZH',
        ftInteger, pdInput, 4, gblHSZH);
      Parameters.CreateParameter('ModeId',
        ftInteger, pdInput, 4, strtoint(ModeId));
      Parameters.CreateParameter('Result',
        ftInteger, pdOutput, 0, 1);

      ExecProc;
      intResult := Parameters.ParamValues['Result'];
      Close;
      if intResult = 1 then
      begin
        //用户ID无效
        result := False;
        Exit;
      end;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;

  //用户ID有效
  result := True;
end;
function TdmDBAccess.YJLink(const Aip:string):string;
var
  qr:TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
  try
    qr.Connection := ADOConnection;
    result:='';
    qr.Close;
    //在等待T_hjzd表中查找zdid.
    qr.sql.Text:=' select zdid,yhid from  ' +
                            ' t_hjzd left outer join t_hjzd_scr on ' +
                            ' t_hjzd.zdid =t_hjzd_scr.hjzdid and t_hjzd.hszh=t_hjzd_scr.hszh ' +
                            ' left outer join t_screen on '+
                            ' t_hjzd_scr.screenid=t_screen.screenid '+
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and t_screen.HostIp=''' + Aip +''''+
                            ' and (t_hjzd.yhid<>'''' and t_hjzd.yhid is not null) ';
    qr.Open;
    ///////////
    with qr do
    begin
       if not qr.Eof  then
         begin
          result:=qr.Fieldbyname('yhid').AsString;
         end
       else
         begin
           result:='';
         end;
         close ;
         exit;
    end;
  except
    result:='';
  end;
  finally
    freeandnil(qr);
  end;
end;
function TdmDBAccess.CheckID1(const TypeName,inparam1,inparam2: string): Boolean;
var
  intResult: Integer;
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_CheckID';
      Parameters.Clear;
      Parameters.CreateParameter('TypeName',
        ftString, pdInput, 128, TypeName);
      Parameters.CreateParameter('ID',
        ftString, pdInput, 80, '');
      Parameters.CreateParameter('inparam1',
        ftString, pdInput, 80, inparam1);
      Parameters.CreateParameter('inparam2',
        ftString, pdInput, 80, inparam2);
      Parameters.CreateParameter('gblHSZH',
        ftInteger, pdInput, 4, gblHSZH);
      Parameters.CreateParameter('ModeId',
        ftInteger, pdInput, 4, strtoint(ModeId));
      Parameters.CreateParameter('Result',
        ftInteger, pdOutput, 0, 1);

      ExecProc;
      intResult := Parameters.ParamValues['Result'];
      Close;
      if intResult = 1 then
      begin
        //用户ID无效
        result := False;
        Exit;
      end;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;

  //用户ID有效
  result := True;
end;
{*******************************************************************************
*函数名:Connect                                                                *
*函数机能:连接数据库                                                           *
*******************************************************************************}
function TdmDBAccess.Connect: Boolean;
begin
  try
    ADOConnection.ConnectionString :=connstr;//'Provider=SQLOLEDB.1;Integrated Security=SSPI;Persist Security Info=False;Initial Catalog=PDXT_DATA;Data Source=.';
//      'Provider=SQLOLEDB.1;Integrated Security=SSPI;Persist Security Info=False;Initial Catalog=sichuang;Data Source=' + GetComputerName+'\思创';
    adoconnection.Open;
    ADOConnection.Connected := True;
    result := True;
  except
    on  e:Exception do
    begin
      addlog('errorlog.txt','连接数据库失败:'+inttostr(e.HelpContext)+e.Message);
      result := False;
    end;
  end;
end;
function TdmDBAccess.ErrProc: Boolean;
var
//  tmpFrm:tform;
  i:integer;
  cmdstr:string;
begin
//  try
//    ADOConnection.ConnectionString :=connstr;//'Provider=SQLOLEDB.1;Integrated Security=SSPI;Persist Security Info=False;Initial Catalog=PDXT_DATA;Data Source=.';
//      'Provider=SQLOLEDB.1;Integrated Security=SSPI;Persist Security Info=False;Initial Catalog=sichuang;Data Source=' + GetComputerName+'\思创';
//    ADOConnection.Connected := True;
//    result := True;
//  except
//    result := False;
//  end;
   //tmpfrm:=frmerrshow.Create(nil);
   //frmerrshow.Create(nil);
//   frmerrshow.ShowModal;
//   frmerrshow.listbox1.items.clear;
//   frmerrshow.ListBox1.Items.Add(datetostr(date)+'  '+ timetostr(time) +' 数据库连接错误！');
   frmmain.sbrInfo.Panels.Items[0].Text:= datetostr(date)+'  '+ timetostr(time) +' 数据库连接错误！';
   disconnect;
   frmmain.sbrInfo.Panels.Items[0].Text:= datetostr(date)+'  '+ timetostr(time) +' 数据库连接错误！';

//   frmerrshow.ListBox1.Items.Add(datetostr(date)+'  '+ timetostr(time) +' 断开连接！');
   sleep(2000);
//   frmerrshow.ListBox1.Items.Add(datetostr(date)+'  '+ timetostr(time) +' 尝试连接...！');
   frmmain.sbrInfo.Panels.Items[0].Text:= datetostr(date)+'  '+ timetostr(time) +' 尝试连接...！！';

   try
     if not connect then
     begin
       frmmain.sbrInfo.Panels.Items[0].Text:= datetostr(date)+'  '+ timetostr(time) +' 连接失败！';
       result:=true;
     end
     else
     begin
      try
         with adoconnection do
         begin
               //将运行状态写入到数据库；；
             if gblrunappmode=0 then
             begin
               cmdstr:='update t_hsz set yxbz=1  where hszh='+ inttostr(gblhszh);
               execute(cmdstr,cmdtext);
               dmDBAccess.WriteLogInfo('1001','运行程序-重新连接');
             end;
         end;
      except

      end;
       frmmain.sbrInfo.Panels.Items[0].Text:= datetostr(date)+'  '+ timetostr(time) +' 连接成功！';
       frmmain.sbrInfo.Panels.Items[0].Text:= '版权所有：上海思创电子有限公司';
       gblisindo:=false;
       for i:=0 to groupnumber-1 do
       begin
          gbledit_ks[i].ksid := groupserial[i].ksid;
          gbledit_ks[i].ksmc := groupserial[i].ksmc;
          adoqdhxxarray[i].close;
          adoqdhxxarray[i].open;
       end;
       gbledit_ks_count:=groupnumber;
          //刷新窗口;
       if gbledit_ks_count>0 then
          frmmain.SXKSXX();
//    frmmain.sbrInfo.Panels.Items[1].Text:= 'datetostr(date)+'  '+ timetostr(time) +' 连接成功！';

     //     frmerrshow.ListBox1.Items.Add(datetostr(date)+'  '+ timetostr(time) +' 连接成功...！');
//     frmerrshow.hide;
     result:=true;
     end;
   except
//     frmerrshow.ListBox1.Items.Add(datetostr(date)+'  '+ timetostr(time) +' 连接失败...！');
//     frmerrshow.hide;
     frmmain.sbrInfo.Panels.Items[0].Text:= datetostr(date)+'  '+ timetostr(time) +' 连接失败！';
     result:=false;
   end;
end;
function TdmDBAccess.DeleteID(const TypeName,ID: string): Boolean;
var
  intResult: Integer;
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_DeleteID';
      Parameters.Clear;
      Parameters.CreateParameter('TypeName',
        ftString, pdInput, 128, TypeName);
      Parameters.CreateParameter('ID',
        ftString, pdInput, 80, ID);
      Parameters.CreateParameter('inparam1',
        ftString, pdInput, 80, '');
      Parameters.CreateParameter('inparam2',
        ftString, pdInput, 80, ModeID);
      Parameters.CreateParameter('gblHSZH',
        ftInteger, pdInput, 4, gblHSZH);
      Parameters.CreateParameter('Result',
        ftInteger, pdOutput, 0, 1);

      ExecProc;
      intResult := Parameters.ParamValues['Result'];
      Close;
      if intResult = 1 then
      begin
        //用户删除失败
        result := False;
        Exit;
      end;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;

  //用户删除成功
  result := True;
end;
function TdmDBAccess.DeleteID1(const TypeName,inparam1,inparam2: string): Boolean;
var
  intResult: Integer;
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_DeleteID';
      Parameters.Clear;
      Parameters.CreateParameter('TypeName',
        ftString, pdInput, 128, TypeName);
      Parameters.CreateParameter('ID',
        ftString, pdInput, 20, '');
      Parameters.CreateParameter('inparam1',
        ftString, pdInput, 80, inparam1);
      Parameters.CreateParameter('inparam2',
        ftString, pdInput, 80, inparam2);
      Parameters.CreateParameter('gblHSZH',
        ftInteger, pdInput, 4, gblHSZH);
      Parameters.CreateParameter('Result',
        ftInteger, pdOutput, 0, 1);

      ExecProc;
      intResult := Parameters.ParamValues['Result'];
      Close;
      if intResult = 1 then
      begin
        //用户删除失败
        result := False;
        Exit;
      end;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;

  //用户删除成功
  result := True;
end;
{*******************************************************************************
*函数名:DisConnect                                                             *
*函数机能:断开库连接                                                           *
*******************************************************************************}
function TdmDBAccess.DisConnect: Boolean;
var
cmdstr:widestring;
begin
  try
     with adoconnection do
     begin
           //将运行状态写入到数据库；；
         if gblrunappmode=0 then
         begin
           cmdstr:='update t_hsz set yxbz=0  where hszh='+ inttostr(gblhszh);
           execute(cmdstr,cmdtext);
           dmDBAccess.WriteLogInfo('1002','关闭程序');
         end;
     end;
  except

  end;
  try
    Adoconnection.Close;
    ADOConnection.Connected := False;
    result := True;
  except
    result := False;
  end;
end;

function TdmDBAccess.EditPassword(const UserID,
  NewPassword: string): Boolean;
var
  intResult: Integer;
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_EditPassword';
      Parameters.Clear;
      Parameters.CreateParameter('UserID',
        ftString, pdInput, 10, UserID);
      Parameters.CreateParameter('NewPassword',
        ftString, pdInput, 255, NewPassword);
      Parameters.CreateParameter('hszh',
        ftInteger, pdInput, 4, gblhszh);
      Parameters.CreateParameter('Result',
        ftInteger, pdOutput, 0, 1);

      ExecProc;
      intResult := Parameters.ParamValues['Result'];
      Close;
      if intResult = 1 then
      begin
        {密码修改失败}
        result := False;
        Exit;
      end;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;
  {密码修改成功}
  result := True;
end;

function TdmDBAccess.EditID(const Typename,ID, parm1, parm2, parm3,
  parm4,parm5,parm6,parm7,parm8: string): Boolean;
var
  intResult: Integer;
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_EditID';
      Parameters.Clear;
      Parameters.CreateParameter('Typename',
        ftString, pdInput, 128, Typename);
      Parameters.CreateParameter('ID',
        ftString, pdInput, 80, ID);
      Parameters.CreateParameter('parm1',          //诊室号码
        ftString, pdInput, 1024, parm1);
      Parameters.CreateParameter('parm2',          //诊室名称
        ftString, pdInput, 80, parm2);
      Parameters.CreateParameter('parm3',          //诊台号码
        ftString, pdInput, 40, parm3);
      Parameters.CreateParameter('parm4',          //备注
        ftString, pdInput, 80, parm4);
      Parameters.CreateParameter('parm5',          //用户ID
        ftString, pdInput, 80, parm5);
      Parameters.CreateParameter('parm6',
        ftString, pdInput, 80, parm6);
      Parameters.CreateParameter('parm7',
        ftString, pdInput, 80, parm7);
      Parameters.CreateParameter('parm8',
        ftString, pdInput, 10, parm8);
      Parameters.CreateParameter('gblHSZH',
        ftInteger, pdInput, 4, gblHSZH);
      Parameters.CreateParameter('ModeId',
        ftInteger, pdInput, 4, strtoint(ModeId));
      Parameters.CreateParameter('Result',
        ftInteger, pdOutput, 0, 1);


      ExecProc;
      intResult := Parameters.ParamValues['Result'];
      Close;
      if intResult = 1 then
      begin
        //用户修改失败
        result := False;
        Exit;
      end;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;

  //用户修改成功
  result := True;
end;

function TdmDBAccess.GetID(const TypeName,ID: string; var param1, param2, param3,
  param4,param5,param6,param7,param8: string;param9:integer): Boolean;
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_GetID';
      Parameters.Clear;
      Parameters.CreateParameter('TypeName',
        ftString, pdInput, 20, TypeName);
      Parameters.CreateParameter('ID',
        ftString, pdInput, 80, ID);
      Parameters.CreateParameter('inparam1',
        ftString, pdInput, 80, Modeid);
      Parameters.CreateParameter('inparam2',
        ftString, pdInput, 80, '');
      Parameters.CreateParameter('param1',
        ftString, pdOutput,1024, '');
      Parameters.CreateParameter('param2',
        ftString, pdOutput, 50, '');
      Parameters.CreateParameter('param3',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param4',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param5',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param6',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param7',
        ftString, pdOutput, 10, '');
      Parameters.CreateParameter('param8',
        ftString, pdOutput, 10, '');
      Parameters.CreateParameter('param9',
        ftInteger, pdInput, 4, param9);

      ExecProc;
      param1 := VarToStr(Parameters.ParamValues['param1']);
      param2 := VarToStr(Parameters.ParamValues['param2']);
      param3 := VarToStr(Parameters.ParamValues['param3']);
      param4 := VarToStr(Parameters.ParamValues['param4']);
      param5 := VarToStr(Parameters.ParamValues['param5']);
      param6 := VarToStr(Parameters.ParamValues['param6']);
      param7 := vartostr(parameters.ParamValues['param7']);
      param8 := vartostr(parameters.ParamValues['param8']);
      Close;
    end;
  except
    begin
      {用户信息取得失败}
      result := False;
      Exit;
    end;
  end;

  {用户信息取得成功}
  result := True;

end;
function TdmDBAccess.GetID1(const TypeName,inparam1,inparam2: string; var param1, param2, param3,
  param4,param5,param6,param7: string;param8:integer): Boolean;        // 排班表
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_GetID';
      Parameters.Clear;
      Parameters.CreateParameter('TypeName',
        ftString, pdInput, 20, TypeName);
      Parameters.CreateParameter('ID',
        ftString, pdInput, 80, '');
      Parameters.CreateParameter('inparam1',
        ftString, pdInput, 80, inparam1);
      Parameters.CreateParameter('inparam2',
        ftString, pdInput, 80, inparam2);
      Parameters.CreateParameter('param1',
        ftString, pdOutput,200, '');
      Parameters.CreateParameter('param2',
        ftString, pdOutput, 50, '');
      Parameters.CreateParameter('param3',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param4',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param5',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param6',     //显示模式
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param7',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param8',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param9',
        ftInteger, pdInput, 4, param8);

      ExecProc;
      param1 := VarToStr(Parameters.ParamValues['param1']);
      param2 := VarToStr(Parameters.ParamValues['param2']);
      param3 := VarToStr(Parameters.ParamValues['param3']);
      param4 := VarToStr(Parameters.ParamValues['param4']);
      param5 := VarToStr(Parameters.ParamValues['param5']);
      param6 := VarToStr(Parameters.ParamValues['param6']);
      param7 := VarToStr(Parameters.ParamValues['param7']);
      Close;
    end;
  except
    begin
      {用户信息取得失败}
      result := False;
      Exit;
    end;
  end;

  {用户信息取得成功}
  result := True;

end;
function TdmDBAccess.NewID(const TypeName,ID, param1, param2, param3,
  param4,param5,param6,param7, param8,param9: string;param10:integer): Boolean;
var
  intResult: Integer;
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_NewID';
      Parameters.Clear;
      Parameters.CreateParameter('TypeName',
        ftString, pdInput, 128, TypeName);
      Parameters.CreateParameter('ID',
        ftString, pdInput, 80, ID);
      Parameters.CreateParameter('param1',
        ftString, pdInput, 1024, param1);
      Parameters.CreateParameter('param2',
        ftString, pdInput, 50, param2);
      Parameters.CreateParameter('param3',
        ftString, pdInput, 10, param3);
      Parameters.CreateParameter('param4',
        ftString, pdInput, 80, param4);
      Parameters.CreateParameter('param5',
        ftString, pdInput, 10, param5);
      Parameters.CreateParameter('param6',
        ftString, pdInput, 10, param6);
      Parameters.CreateParameter('param7',
        ftString, pdInput, 20, param7);
      Parameters.CreateParameter('param8',
        ftString, pdInput, 10, param8);
      Parameters.CreateParameter('param9',
        ftString, pdInput, 10, param9);
      Parameters.CreateParameter('param10',
        ftInteger, pdInput, 4, param10);
      Parameters.CreateParameter('ModeId',
        ftInteger, pdInput, 4, strtoint(ModeId));
      Parameters.CreateParameter('Result',
        ftInteger, pdOutput, 0, 1);

      ExecProc;
      intResult := Parameters.ParamValues['Result'];
      Close;
      if intResult = 1 then
      begin
        //用户登录失败
        result := False;
        Exit;
      end;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;
  //用户登录成功
  result := True;

end;
//////////////////////////////////////////////////////////
//得到该医生的呼叫方式,1--按科室,2-按挂号号码,3-按挂号时间
//////////////////////////////////////////////////////////
function TdmDBAccess.DB_GetHJFS(const p_hszh:integer;const p_yhid:string):integer;
var
   qr:Tadoquery;
   i,j:integer;
begin
   qr:=tadoquery.Create(nil);
   try
     with qr do
     begin
        Connection:=adoconnection;
        sql.Text :='SELECT hjfs from T_YH'+
                ' WHERE (YHID =:p1)'+
                ' AND (HSZH =:p2)'  ;
         Parameters.ParamByName('p1').Value:=p_yhid;
         Parameters.ParamByName('p2').Value:=p_hszh;
         try
         open;
         except;
         result:=1;
         end;
         if not eof then
         begin
            result:=fields.Fields[0].AsInteger;
         end
         else
         begin
            result:=1
         end;
         close;
      end;
    finally
    FreeAndNil(qr);
    end;
end;

function TdmDBAccess.SetAllItems(var ListView: TTeThemeSListView;
  const TypeName: string): Boolean;
var
  ListItem: TListItem;
  intFieldIndex: integer;
  i:integer;
begin
  ListView.Items.Clear;
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_GetAllItems';
      Parameters.Clear;
      Parameters.CreateParameter('TypeName',
        ftString, pdInput, 128, TypeName);
      Parameters.CreateParameter('gblHSZH',
        ftinteger, pdInput, 4, gblHSZH);
      Parameters.CreateParameter('ModeId',
        ftinteger, pdInput, 4, strtoint(ModeId));
      Open;

      if ListView.Columns.Count = 0 then
      begin
        for intFieldIndex := 0 to Fields.Count -1 do
        begin
            with ListView.Columns.Add do
            begin
              Caption := Fields[intFieldIndex].FieldName;
              if  typename='PBXX' then
                  caption:=ansireplacetext(caption,'ttl_ks',ttl_ks)
              else if typename='QHAJ' then
                  caption:=ansireplacetext(caption,'ttl_ks',ttl_ks)
              else if typename='HJZD' then
              begin
                  caption:=ansireplacetext(caption,'ttl_zs',ttl_zs);
                  caption:=ansireplacetext(caption,'ttl_zt',ttl_zt);
                  caption:=ansireplacetext(caption,'ttl_ks',ttl_ks);
              end
              else if typename='KS' then
                  caption:=ansireplacetext(caption,'ttl_ks',ttl_ks)
              else if typename='YH' then
                  caption:=ansireplacetext(caption,'ttl_ks',ttl_ks);

              if (typename='pbxx') and (intfieldindex=1) then
                  width:=0
              else
                  Width := (Length(Fields[intFieldIndex].FieldName)+2) * ListView.Canvas.TextWidth('A');
            end;
        end;
      end;
      i:=2;
      while not ADOStoredProc.Eof do
      begin
        if typename='HJZD' then
        begin
          if (Fields[0].AsInteger<=gblHJZDCount) then
          begin
            ListItem := ListView.Items.Add;
            ListItem.Caption := Fields[0].AsString;
            ListItem.ImageIndex := i;
            i:=i+1;
            for intFieldIndex := 1 to Fields.Count -1 do
            begin
                ListItem.SubItems.Add(Fields[intFieldIndex].AsString);
            end;
          end;
        end
        else
        begin
          ListItem := ListView.Items.Add;
          ListItem.Caption := Fields[0].AsString;
          ListItem.ImageIndex := i;
          i:=i+1;
          for intFieldIndex := 1 to Fields.Count -1 do
          begin
              ListItem.SubItems.Add(Fields[intFieldIndex].AsString);
          end;
        end;
        Next;
      end;
      Close;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;
  result := True;

end;
function TdmDBAccess.SetAllItemsKBXX(var ListView: TTeThemeSListView;
  const TypeName: string;const akbmc:string;const aksmc:string): Boolean;
var
  ListItem: TListItem;
  intFieldIndex: integer;
  i:integer;
  qr:TADOQuery;
  cmdstr:string;
begin
  ListView.Items.Clear;
  try
  try
    qr := TADOQuery.Create(nil);
    qr.Connection := ADOConnection;
    cmdstr :='select kbdm ''代    码'',kbmc ''名称'',类别,科室, 医生 from ('+
      ' select rtrim(kbdm) kbdm,rtrim(kbmc) kbmc,''普通'' 类别,'''' ''科室'','''' ''医生'''+
      ' from t_hiskbxx  where scbz=''0'''+
      ' union all'+
      ' select rtrim(swjzks)+rtrim(yybh) as kbdm,rtrim(yybhmc)+''专家'' as kbmc,'+
        '''专家'' ''类别'',rtrim(swzjzy),rtrim(yybhmc)  from t_hispbxx'+
    	' where rq=convert(varchar(10),getdate(),120) and yylb=3 and rtrim(swjzks)=rtrim(xwjzks)'+
      ' union all'+
      ' select rtrim(xwjzks)+rtrim(yybh) as kbdm,rtrim(yybhmc)+''专家'' as kbmc,'+
        '''专家'' ''类别'',rtrim(xwzjzy),rtrim(yybhmc) from t_hispbxx'+
      ' where rq=convert(varchar(10),getdate(),120) and yylb=3  and rtrim(swjzks)<>rtrim(xwjzks)'+
      ' ) a'+
      ' where kbdm not in (select ksid from t_ks where hszh='+inttostr(gblHSZH)+')';
    if Length(akbmc)>0 then
    begin
      cmdstr := cmdstr +' and kbmc like ''%'+akbmc+'%''';
    end;
    if Length(aksmc)>0 then
    begin
      cmdstr := cmdstr +' and 科室 like ''%'+aksmc+'%''';
    end;
    qr.SQL.Text :=  cmdstr;
    qr.Open;
    with qr do
    begin
      if ListView.Columns.Count = 0 then
      begin
        for intFieldIndex := 0 to Fields.Count -1 do
        begin
            with ListView.Columns.Add do
            begin
              Caption := Fields[intFieldIndex].FieldName;
              if  typename='PBXX' then
                  caption:=ansireplacetext(caption,'ttl_ks',ttl_ks)
              else if typename='QHAJ' then
                  caption:=ansireplacetext(caption,'ttl_ks',ttl_ks)
              else if typename='HJZD' then
              begin
                  caption:=ansireplacetext(caption,'ttl_zs',ttl_zs);
                  caption:=ansireplacetext(caption,'ttl_zt',ttl_zt);
                  caption:=ansireplacetext(caption,'ttl_ks',ttl_ks);
              end
              else if typename='KS' then
                  caption:=ansireplacetext(caption,'ttl_ks',ttl_ks)
              else if typename='YH' then
                  caption:=ansireplacetext(caption,'ttl_ks',ttl_ks);

              if (typename='pbxx') and (intfieldindex=1) then
                  width:=0
              else
                  Width := (Length(Fields[intFieldIndex].FieldName)+2) * ListView.Canvas.TextWidth('A');
            end;
        end;
      end;
      i:=2;
      while not qr.Eof do
      begin
        if typename='HJZD' then
        begin
          if (Fields[0].AsInteger<=gblHJZDCount) then
          begin
            ListItem := ListView.Items.Add;
            ListItem.Caption := Fields[0].AsString;
            ListItem.ImageIndex := i;
            i:=i+1;
            for intFieldIndex := 1 to Fields.Count -1 do
            begin
                ListItem.SubItems.Add(Fields[intFieldIndex].AsString);
            end;
          end;
        end
        else
        begin
          ListItem := ListView.Items.Add;
          ListItem.Caption := Fields[0].AsString;
          ListItem.ImageIndex := i;
          i:=i+1;
          for intFieldIndex := 1 to Fields.Count -1 do
          begin
              ListItem.SubItems.Add(Fields[intFieldIndex].AsString);
          end;
        end;
        Next;
      end;
      Close;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
  result := True;

end;
{*******************************************************************************
*函数名:SetItems                                                               *
*函数机能:设置下拉框Items,CodeItems                                            *
*******************************************************************************}
function TdmDBAccess.SetItems(var XComboBox: TXTeThemeComboBox;
  const TypeName: string): Boolean;
var
  Items: TStrings;
  IDItems: TStrings;
  adosp:TadoStoredProc;
begin
  Items := TStringList.Create;
  IDItems := TStringList.Create;
  try
    try
      adosp :=  TadoStoredProc.Create(nil);
      adosp.Connection := ADOConnection;
      with adosp do
      begin
        ProcedureName  := 'MY_GetItems';
        Parameters.Clear;
        Parameters.CreateParameter('TypeName',
          ftString, pdInput, 128, TypeName);
        Parameters.CreateParameter('gblHSZH',
          ftInteger, pdInput, 4, gblHSZH);
        Open;
        if (TypeName='KS') then
        begin
           if gblsys=1 then
           begin
              Items.Add('所有科室');
              IDItems.Add('0');
           end
           else
           begin
              Items.Add('所有队列');
              IDItems.Add('0');
           end;
        end
        else if (TypeName='LC') then
        begin
          Items.Add('无流程');
          IDItems.Add('0');
        end
        else if (TypeName='YYSJD') then
        begin
          Items.Add('不选择');
          IDItems.Add('0');
        end
        else if (TypeName='YXJSZ') then
        begin
          Items.Add('无优先');
          IDItems.Add('0');
        end;


        while not adosp.Eof do
        begin
            if (TypeName = 'YYSJD') then
            begin
              Items.Add(Fields[1].AsString);
              IDItems.Add(Fields[0].AsString);
              Next;
            end
            else
            if (TypeName <> 'PDWB') AND (TypeName <> 'XSZD')  AND (TypeName <> 'XSFS')  then
            begin
              Items.Add(Fields[0].AsString
                + '.' + Fields[1].AsString);
              IDItems.Add(Fields[0].AsString);
              Next;
            end
            else
            begin
              Items.Add(Fields[0].AsString);
              IDItems.Add(Fields[0].AsString);
              Next;
            end;
        end;

        Close;
      end;

      XComboBox.Items := Items;
      XComboBox.IDItems := IDItems;
      Items.Clear;
      IDItems.Clear;
    except
      begin
        result := False;
        Exit;
      end;
    end;
    result := True;
  finally
    freeandnil(adosp);
  end;
end;


function TdmDBAccess.Newks_xsp(const ksid:string;const xspid: integer;const xsms:string): Boolean;
var
  intResult: Integer;
  adosp:Tadostoredproc;
begin
  try
    try
      adosp :=  TadoStoredProc.Create(nil);
      adosp.Connection := ADOConnection;
    with adosp do
    begin
      ProcedureName := 'MY_Newks_xsp';
      Parameters.Clear;
      Parameters.CreateParameter('ksid',
        ftString, pdInput, 20, ksid);
      Parameters.CreateParameter('xspid',
        ftString, pdInput, 10, xspid);
      Parameters.CreateParameter('xspid',
        ftString, pdInput, 10, xsms);
      Parameters.CreateParameter('hszh',
        ftString, pdInput, 4, gblHSZH);
     Parameters.CreateParameter('Result',
        ftInteger, pdOutput, 0, 1);

      ExecProc;
      intResult := Parameters.ParamValues['Result'];
      Close;
      if intResult = 1 then
      begin
        //用户登录失败
        result := False;
        Exit;
      end;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;
  //用户登录成功
  result := True;
  finally
    freeandnil(adosp);
  end;
end;


{*******************************************************************************
*函数名:SetYSItems                                                               *
*函数机能:设置下拉框Items,CodeItems                                            *
*设置科室中的医生列表.
*******************************************************************************}
function TdmDBAccess.SetYSItems(var XComboBox: TXTeThemeComboBox;
  const KSID: string;const hszh:integer ): Boolean;
var
  Items: TStrings;
  IDItems: TStrings;
begin
  Items := TStringList.Create;
  IDItems := TStringList.Create;
  try
    with ADOStoredProc do
    begin
      ProcedureName  := 'MY_GetYSItems';
      Parameters.Clear;
      Parameters.CreateParameter('Y_KSID',
        ftString, pdInput, 128, KSID);
      Parameters.CreateParameter('Y_HSZH',
        ftinteger, pdInput, 128, hszh);

      Open;
      if gblsys=1 then
      begin
        Items.Add('0'
          + '.' + '所有医生');
        IDItems.Add('0');
      end
      else
      begin
        Items.Add('0'
          + '.' + '所有员工');
        IDItems.Add('0');
      end;
      while not ADOStoredProc.Eof do
      begin
        Items.Add(Fields[0].AsString
          + '.' + Fields[1].AsString);
        IDItems.Add(Fields[0].AsString);
        Next;
      end;

      Close;
    end;

    XComboBox.Items := Items;
    XComboBox.IDItems := IDItems;
    Items.Clear;
    IDItems.Clear;
  except
    begin
      result := False;
      Exit;
    end;
  end;
  result := True;

end;

{*******************************************************************************
*函数名:SetYSItems                                                               *
*函数机能:设置下拉框Items,CodeItems                                            *
*设置科室中的医生列表.
*******************************************************************************}
function TdmDBAccess.SetFZYSItems(var XComboBox: TXTeThemeComboBox;
  const KSID: string;const hszh:integer ): Boolean;
var
  Items: TStrings;
  IDItems: TStrings;
begin
  Items := TStringList.Create;
  IDItems := TStringList.Create;
  try
    with ADOStoredProc do
    begin
      ProcedureName  := 'MY_GetFZYSItems';
      Parameters.Clear;
      Parameters.CreateParameter('Y_KSID',
        ftString, pdInput, 128, KSID);
      Parameters.CreateParameter('Y_HSZH',
        ftinteger, pdInput, 128, hszh);

      Open;
      if gblsys=1 then
      begin
        Items.Add('0'
          + '.' + '所有医生');
        IDItems.Add('0');
      end
      else
      begin
        Items.Add('0'
          + '.' + '所有员工');
        IDItems.Add('0');
      end;
      while not ADOStoredProc.Eof do
      begin
        Items.Add(Fields[0].AsString
          + '.' + Fields[1].AsString);
        IDItems.Add(Fields[0].AsString);
        Next;
      end;

      Close;
    end;

    XComboBox.Items := Items;
    XComboBox.IDItems := IDItems;
    Items.Clear;
    IDItems.Clear;
  except
    begin
      result := False;
      Exit;
    end;
  end;
  result := True;

end;
{*******************************************************************************
*函数名:SetDHXXItems
                                           *
*函数机能:设置listview.Items,lbl.caption                                            *
*******************************************************************************}
function TdmDBAccess.SetDHXXItems(var ListView: TTeThemeDBGrid; lbl:TLabel;
  const KSID: string; const HSZH:integer;var AdoQuery :tadoquery ): Boolean;
var
  selectedrec:array of string;
  selectedreccount:integer;
  i:integer;
  j:integer;
//  ListItem: TListItem;
  intFieldIndex: integer;
//  tmpdatasource:TdataSource;
  rest:boolean;
//  bm:Tbookmark;
  qr:TADOQuery;
begin
  if listview<>nil then
      selectedreccount:=listview.SelectedRows.Count
  else
      selectedreccount:=0;
  if selectedreccount>0 then
     setlength(selectedrec,selectedreccount);
  //adoquery.DisableControls;
  j:=0;
  for i:=0 to selectedreccount-1 do
  begin
        listview.DataSource.DataSet.GotoBookmark(pointer(listview.SelectedRows.Items[i]));
        selectedrec[j]:=listview.DataSource.DataSet.Fields[7].AsString ;
        j:=j+1;
  end;
  //adoquery.EnableControls;
//  if not adoquery.eof then
//  begin
//    selectedreccount:=1;
//    setlength(selectedrec,1);
//    selectedrec[0]:=adoquery.Fields[7].AsString;
//  end
//  else
//    selectedreccount:=0;
//  adoquery.DisableControls;
//  BM := adoquery.GetBookmark;
  rest:=false;
//  ListView.Items.Clear;
  try
    adoquery.Close;
    adoquery.Connection:=adoconnection;
    //在等待T_DHXX表中查找科室为KSID的本护士站的未就诊的病人信息.
    adoquery.sql.Clear;
    if gblhavemzh=1 then
    begin
      adoquery.SQL.Add(' select kssxid,brxm,ghhm,t_YH.yhmc,t_jzzt.ztmc,t_yxjsz.yxjmc,'+
        'ghsj,t_dhxx.id,t_dhxx.by4,t_dhxx.by6,t_dhxx.by7,s.sjdmc,mzh,xb,nl,convert(varchar(8),jhsj,108) jhsj from  ');
  //      'ghsj,t_dhxx.id,t_dhxx.by4,t_dhxx.by6,t_dhxx.by7,s.sjdmc,mzh,xb,nl from  ');
      adoquery.SQL.Add(' t_dhxx left OUTER join t_ks on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh ');
      adoquery.SQL.Add(' left OUTER join t_YH on t_dhxx.yhid=t_YH.yhid and t_dhxx.hszh=t_YH.hszh ');
      adoquery.SQL.Add(' left OUTER join t_jzzt on t_dhxx.ztbz=t_jzzt.ztbz and t_dhxx.hszh=t_jzzt.hszh');
      adoquery.SQL.Add(' left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' );
      adoquery.SQL.Add(' left OUTER join t_sjdsz s on t_dhxx.sjdbz=s.sjdbz and t_dhxx.hszh=s.hszh ' );
      adoquery.SQL.Add(' where t_dhxx.ksid=''' + ksid + '''' + ' and t_dhxx.jzbz<>''0''' + ' and t_dhxx.hszh=' + inttostr(hszh));
      adoquery.SQL.Add(' order by t_dhxx.kssxid ');
    end
    else
    begin

      adoquery.SQL.Add(' select kssxid,brxm,ghhm,t_YH.yhmc,t_jzzt.ztmc,t_yxjsz.yxjmc,'+
        'ghsj,t_dhxx.id,t_dhxx.by4,t_dhxx.by6,t_dhxx.by7,s.sjdmc,convert(varchar(8),jhsj,108) jhsj from  ');
  //      'ghsj,t_dhxx.id,t_dhxx.by4,t_dhxx.by6,t_dhxx.by7,s.sjdmc,mzh,xb,nl from  ');
      adoquery.SQL.Add(' t_dhxx left OUTER join t_ks on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh ');
      adoquery.SQL.Add(' left OUTER join t_YH on t_dhxx.yhid=t_YH.yhid and t_dhxx.hszh=t_YH.hszh ');
      adoquery.SQL.Add(' left OUTER join t_jzzt on t_dhxx.ztbz=t_jzzt.ztbz and t_dhxx.hszh=t_jzzt.hszh');
      adoquery.SQL.Add(' left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' );
      adoquery.SQL.Add(' left OUTER join t_sjdsz s on t_dhxx.sjdbz=s.sjdbz and t_dhxx.hszh=s.hszh ' );
      adoquery.SQL.Add(' where t_dhxx.ksid=''' + ksid + '''' + ' and t_dhxx.jzbz<>''0''' + ' and t_dhxx.hszh=' + inttostr(hszh));
      adoquery.SQL.Add(' order by t_dhxx.kssxid ');
    end;
    adoquery.Open;
    //tmpdatasource:=tdatasource.Create(nil);
    //tmpdatasource.DataSet :=adoquery;
    //listview.DataSource:=tmpdatasource;
{    for groupnumber_index:=0 to groupnumber-1 do
    begin
        if groupserial[groupnumber_index].ksid=ksid then
        begin
           break;
        end;
    end;}
    //listview.DataSource.DataSet:=adoquery;

    with adoquery do
    begin
//       while not adoquery.Eof do
//       begin
//          if selectedreccount>0 then
//             for j:=0 to selectedreccount-1 do
//             begin
//                if selectedrec[j]= adoquery.fields.Fields[7].AsString then
//                begin
//                   rest:=true;
//                   //listview.
//                   //listview.SelectedRows.CurrentRowSelected:=true;
//                   break;
//                end;
//             end;
//          if rest=true then
//             break
//          else
//             Next;
//       end;
////       Close;
       for j:=0 to selectedreccount-1 do
       begin
         if Locate('id',selectedrec[j],[]) then
         begin
           listview.SelectedRows.CurrentRowSelected:=true;
           rest := true;
         end;
       end;
    end;
//    tmpdatasource.Free;
//    adoquery.EnableControls;
    if (not rest) and (AdoQuery.RecordCount>0) then
    begin
      AdoQuery.First;
      listview.SelectedRows.CurrentRowSelected:=true;
    end;
//    try
//      if not rest then
//      begin
//         if (adoquery.RecordCount>0) then
//            try
//            adoquery.GotoBookmark(BM);
//            except
//            end;
//      end;
//    except
//      on E: Exception do
//        addlog('ErrorLog.txt',E.message+'刷新等待列表出错GotoBookmark');
//    end;
//    adoquery.FreeBookmark(BM);
///    showmessage(adoquery.Fields[0].AsString);
    ///////设置信息窗口的科室名称////////
    qr:= TADOQuery.Create(nil);
    try
      qr.Connection := ADOConnection;
      qr.Close;
      qr.SQL.Text:=' select ksmc from  ' +
                              ' t_ks ' +
                              ' where ksid=''' + ksid +'''' + ' and hszh=' + inttostr(hszh);

      qr.Open;
      with qr do
      begin
         if not qr.Eof then
         begin
            lbl.Caption:=fields.Fields[0].AsString;
         end;
         Close;
      end;
    finally
      FreeAndNil(qr);
    end;
  except
    on E: Exception do
    begin
      addlog('ErrorLog.txt',E.message+' 刷新等待列表出错,'+KSID);
      result := False;
      Exit;
    end;
  end;
  result := True;
end;
{*******************************************************************************
*函数名:SetGHXXItems
                                           *
*函数机能:设置listview.Items                                            *
*******************************************************************************}
function TdmDBAccess.SetGHXXItems(var ListView: TTeThemeDBGrid; lbl:TLabel;
  const KSID: string; const HSZH:integer;var AdoQuery :tadoquery ): Boolean;
var
  selectedrec:array of string;
  selectedreccount:integer;
  i:integer;
  j:integer;
//  ListItem: TListItem;
  intFieldIndex: integer;
//  tmpdatasource:TdataSource;
  rest:boolean;
//  bm:Tbookmark;
  qr:TADOQuery;
begin
  if listview<>nil then
      selectedreccount:=listview.SelectedRows.Count
  else
      selectedreccount:=0;
  if selectedreccount>0 then
     setlength(selectedrec,selectedreccount);
  //adoquery.DisableControls;
  j:=0;
  for i:=0 to selectedreccount-1 do
  begin
        listview.DataSource.DataSet.GotoBookmark(pointer(listview.SelectedRows.Items[i]));
        selectedrec[j]:=listview.DataSource.DataSet.Fields[4].AsString ;
        j:=j+1;
  end;
  //adoquery.EnableControls;
//  if not adoquery.eof then
//  begin
//    selectedreccount:=1;
//    setlength(selectedrec,1);
//    selectedrec[0]:=adoquery.Fields[7].AsString;
//  end
//  else
//    selectedreccount:=0;
//  adoquery.DisableControls;
//  BM := adoquery.GetBookmark;
  rest:=false;
//  ListView.Items.Clear;
  try
    adoquery.Close;
    adoquery.Connection:=adoconnection;
    //在等待T_DHXX表中查找科室为KSID的本护士站的未就诊的病人信息.
    adoquery.sql.Clear;
    {brxm,ghhm,yhmc,ghsj,id,by6,by7}
    AdoQuery.SQL.Text :='select brxm,ghhm,y.yhmc,ghsj,g.id,g.by4,g.by6,g.by7'+
       ',case when g.ztbz=9 then ''是'' else ''否'' end as "read" from'+
       ' t_ghxx g '+
       ' left OUTER join t_YH y on g.yhid=y.yhid and g.hszh=y.hszh'+
       ' where g.ksid=''' + ksid + '''' + //' and g.ztbz<>''9''' +
       ' and g.jzbz=1 '+
       ' and g.hszh=' + inttostr(hszh)+
       ' and g.by1 in (88,89)'+
       ' order by g.ghsj ';
    adoquery.Open;

    with adoquery do
    begin
       for j:=0 to selectedreccount-1 do
       begin
         if Locate('id',selectedrec[j],[]) then
         begin
           listview.SelectedRows.CurrentRowSelected:=true;
           rest := true;
         end;
       end;
    end;

    if (not rest) and (AdoQuery.RecordCount>0) then
    begin
      AdoQuery.First;
      listview.SelectedRows.CurrentRowSelected:=true;
    end;

  except
    on E: Exception do
    begin
      addlog('ErrorLog.txt',E.message+' 刷新等待列表出错,'+KSID);
      result := False;
      Exit;
    end;
  end;
  result := True;
end;
{*******************************************************************************
*函数名:SetYSXXItems
                                           *
*函数机能:设置listview.Items                                          *
*******************************************************************************}
function TdmDBAccess.SetYSXXItems(var listview :TTeThemeSListView;
         const HSZH :integer):boolean;
var
  ListItem: TListItem;
  intFieldIndex: integer;
  qry:Tadoquery;
  qry1:Tadoquery;
begin
  ListView.Items.Clear;
  qry:=Tadoquery.Create(nil);
  qry.Connection:=adoconnection;
  qry1:=Tadoquery.Create(nil);
  qry1.Connection:=adoconnection;

  try
    qry1.SQL.Text:=' SELECT ZDID,t_hjzd.YHID,YHMC,FJH' +
          ' FROM  t_hjzd left outer join t_yh '+
          ' on t_hjzd.yhid=t_yh.yhid and t_hjzd.hszh=t_yh.hszh '+
          ' where t_hjzd.yhid<>'''' and t_hjzd.yhid is not null '+
          ' and t_hjzd.hszh=' +    INTTOSTR(hszh)+
          ' and t_hjzd.zt<>''暂停'''+
          ' order by t_hjzd.zdid';
    qry1.Open;

    //设置医生信息窗口中的列宽
    listview.Columns[0].Width :=1;
    for intfieldindex:=1 to 3 do
    begin
       listview.Columns[intfieldindex].Width := (Length(listview.Columns[intfieldindex].Caption)+2) * ListView.Canvas.TextWidth('A');
    end;


    ///////////将数据放入LISTVIEW中.
    with qry1 do
    begin
       while not qry1.Eof do
       begin
         //Application.ProcessMessages;
          listItem:=listview.Items.add;
          ListItem.Caption := Fields[1].AsString;
          for intFieldIndex := 2 to 3 do
          begin
            ListItem.SubItems.Add(fields.Fields[intFieldIndex].AsString);
          end;
          //qry1.Close ;
          //当前选此医生病人数
          qry.SQL.Text := 'SELECT count(*) as num  ' +
                  ' FROM t_DHXX  '+
                  ' WHERE t_DHXX.JZBZ = ''1'' '+
                  ' and t_dhxx.yhid='''+ fields.Fields[1].AsString+''''+
                  ' and t_dhxx.hszh=' + INTTOSTR(hszh);
          qry.Open;
          ListItem.SubItems.Add(qry.Fields.Fields[0].AsString);
          qry.Close ;
          //已就诊人数
          qry.SQL.Text := 'SELECT count(*) as num  ' +
                  ' FROM t_DHXX  '+
                  ' WHERE t_DHXX.JZBZ = ''0'' '+
                  ' and t_dhxx.ztbz<>''3'''+
                  ' and t_dhxx.yhid='''+ fields.Fields[1].AsString+''''+
                  ' and t_dhxx.hszh=' + INTTOSTR(hszh);
          qry.Open;
          ListItem.SubItems.Add(qry.Fields.Fields[0].AsString);
          qry.Close ;

          Next;
       end;
       Close;
    end;
    FreeAndNil(qry1);
    FreeAndNil(qry);
  except
       on e:exception do
       begin
          //showmessage(e.Message +'EoleExcetpion');
          addlog('ErrorLog.txt',e.Message+' 刷新'+ttl_yh+ttl_br+'数 ');
          errproc();
          FreeAndNil(qry1);
          FreeAndNil(qry);
          result:=false;
          //disconnect;
          //sleep(1000);
          //connect;
          exit ;
       end;
  end;
  result := True;
end;
{*******************************************************************************
*函数名:SetKS
                                           *
*函数机能:设置groupserial[].                                         *
*******************************************************************************}
function TdmDBAccess.SetKS(var ksxx:array of udfks;
       const HSZH:integer):integer;
var
  tmpgrpnumber:integer;
  isEXSIT:boolean;
  qr:TADOQuery;
  orderid:string;
begin
  qr := TADOQuery.Create(nil);
  try
  try
    qr.Connection := ADOConnection;
    qr.Close;
    ClearOrderTable(gblHSZH);
    //从T_HJZD,T_YH中查找已登录的医生所要呼叫的窗口
//    qr.SQL.Text:=' SELECT distinct ksid,ksmc,hided from ' +
//          ' t_ks ' +
//          ' where ((ksid in ' +
//          '            (SELECT DISTINCT t_yh.ksid1 FROM ' +
//          '             t_yh LEFT OUTER JOIN  t_hjzd '+
//          '                  ON t_yh.yhid = t_hjzd.yhid AND t_yh.hszh = t_hjzd.hszh ' +
//          '             WHERE t_hjzd.yhid IS NOT NULL AND t_yh.hszh =' + inttostr(hszh) + ')) ' +
//          ' or (ksid in '+
//          '            (SELECT DISTINCT t_yh.ksid2 FROM '+
//          '             t_yh LEFT OUTER JOIN  t_hjzd ' +
//          '                 ON t_yh.yhid = t_hjzd.yhid AND t_yh.hszh = t_hjzd.hszh ' +
//          '         WHERE t_hjzd.yhid IS NOT NULL AND t_yh.hszh =' + inttostr(hszh) + ')) ' +
//          ' or (ksid in '+
//          '           (SELECT DISTINCT t_yh.ksid3 FROM '+
//          '            t_yh LEFT OUTER JOIN  t_hjzd '+
//          '                 ON t_yh.yhid = t_hjzd.yhid AND t_yh.hszh = t_hjzd.hszh ' +
//          '         WHERE t_hjzd.yhid IS NOT NULL AND t_yh.hszh =' + inttostr(hszh) + '))) ' +
//          ' AND hszh=' + inttostr(hszh)+
//          //' and hided=0'+
//          ' order by ksid' ;
///2014-07-23 吴刚 修改
///不显示已登录医生的呼叫科室
//    qr.SQL.Text:=' SELECT distinct ksid,ksmc,hided from ' +
//          ' t_ks ' +
//          ' where ((ksid in ' +
//          '            (SELECT DISTINCT yk.ksid FROM ' +
//          '             t_yh_ks yk LEFT OUTER JOIN  t_hjzd h '+
//          '                  ON yk.yhid = h.yhid AND yk.hszh = h.hszh ' +
//          '             WHERE h.yhid IS NOT NULL AND yk.hszh =' + inttostr(hszh) + '))) ' +
//          ' AND hszh=' + inttostr(hszh)+
//          ' order by ksid' ;
//    try
//      qr.Open;
//    except
////      qr.SQL.Text:=' SELECT distinct ksid,ksmc,0 as hided from ' +
////            ' t_ks ' +
////            ' where ((ksid in ' +
////            '            (SELECT DISTINCT t_yh.ksid1 FROM ' +
////            '             t_yh LEFT OUTER JOIN  t_hjzd '+
////            '                  ON t_yh.yhid = t_hjzd.yhid AND t_yh.hszh = t_hjzd.hszh ' +
////            '             WHERE t_hjzd.yhid IS NOT NULL AND t_yh.hszh =' + inttostr(hszh) + ')) ' +
////            ' or (ksid in '+
////            '            (SELECT DISTINCT t_yh.ksid2 FROM '+
////            '             t_yh LEFT OUTER JOIN  t_hjzd ' +
////            '                 ON t_yh.yhid = t_hjzd.yhid AND t_yh.hszh = t_hjzd.hszh ' +
////            '         WHERE t_hjzd.yhid IS NOT NULL AND t_yh.hszh =' + inttostr(hszh) + ')) ' +
////            ' or (ksid in '+
////            '           (SELECT DISTINCT t_yh.ksid3 FROM '+
////            '            t_yh LEFT OUTER JOIN  t_hjzd '+
////            '                 ON t_yh.yhid = t_hjzd.yhid AND t_yh.hszh = t_hjzd.hszh ' +
////            '         WHERE t_hjzd.yhid IS NOT NULL AND t_yh.hszh =' + inttostr(hszh) + '))) ' +
////            ' AND hszh=' + inttostr(hszh)+
////            ' order by ksid' ;
//        qr.SQL.Text:=' SELECT distinct ksid,ksmc,0 as hided from ' +
//            ' t_ks ' +
//            ' where ((ksid in ' +
//            '            (SELECT DISTINCT yk.ksid FROM ' +
//            '             t_yh_ks yk LEFT OUTER JOIN  t_hjzd h '+
//            '                  ON yk.yhid = h.yhid AND yk.hszh = h.hszh ' +
//            '             WHERE h.yhid IS NOT NULL AND yk.hszh =' + inttostr(hszh) + '))) ' +
//            ' AND hszh=' + inttostr(hszh)+
//            ' order by ksid' ;
//      qr.Open;
//    end;
//    groupnumber:=qr.RecordCount;
//    if groupnumber>0 then
//       setlength(groupserial,groupnumber)
//    else
//       begin
//       result:=0 ;
//     //  exit;
//       end;
//    ///////////将数据放入ksxx中.
//    tmpgrpnumber:=0;
//    with qr do
//    begin
//       while not qr.Eof do
//       begin
//          groupserial[tmpgrpnumber].ksid:=fields.Fields[0].AsString;
//          groupserial[tmpgrpnumber].ksmc:=fields.Fields[1].AsString;
//          try
//            GroupSerial[tmpgrpnumber].hided:=fields.Fields[2].AsInteger;
//          except
//            GroupSerial[tmpgrpnumber].hided:=0;
//          end;
//          inc(tmpgrpnumber,1);
//          Next;
//       end;
//       Close;
//    end;
/////////////////////////////////////////
    if gblRunAppMode=0 then
    begin
      ///从T_DHXX表中查找要打开的窗口
      if gblShowNoWaitGroup=1 then
      begin
        qr.SQL.Text:=' SELECT  t_KS.ksid,t_ks.ksmc,hided ' +
                 ' from t_ks ' +
                 ' where t_ks.ksid' +
                 ' in (select distinct ksid from t_dhxx where  hszh=' + inttostr(gblhszh) +
//                 ' union select distinct ksid from t_yh_ks '+
//                 ' where yhid in (select yhid from t_hjzd where hszh=' + inttostr(gblhszh) +
//                 ' and isnull(yhid,'''')<>'''') and seq=1'+
                 ')' +
                 ' and hszh='+ inttostr(gblHSZH)+
                 ' and kfbz=0'+
                 //' and hided=0'+
                 ' order by ksid';
      end
      else
      begin
//        qr.SQL.Text:=' SELECT  t_KS.ksid,t_ks.ksmc,hided ' +
//                 ' from t_ks ' +
//                 ' where t_ks.ksid' +
//                 ' in (select distinct ksid from t_dhxx where  jzbz<>0 and hszh=' + inttostr(gblhszh) +')' +
//                 ' and hszh='+ inttostr(gblHSZH)+
//                 ' union SELECT  t_KS.ksid,t_ks.ksmc,hided ' +
//                 ' from t_ks ' +
//                 ' where t_ks.ksid' +
//                 ' in (select distinct ksid from t_hjzd h,t_yh_ks  yk where h.hszh=yk.hszh and h.yhid=yk.yhid and h.hszh=' + inttostr(gblhszh) +')' +
//                 ' and hszh='+ inttostr(gblHSZH)+
//                 ' and kfbz=0'+
//                 //' and hided=0'+
//                 ' order by ksid';
        qr.SQL.Text:=' SELECT  t_KS.ksid,t_ks.ksmc,hided ' +
                 ' from t_ks ' +
                 ' where t_ks.ksid' +
                 ' in (select distinct ksid from t_dhxx where '+
                 ' jzbz<>0 and hszh=' + inttostr(gblhszh) +
//                 'union select distinct ksid from t_yh_ks '+
//                 ' where yhid in (select yhid from t_hjzd where hszh=' + inttostr(gblhszh) +
//                 ' and isnull(yhid,'''')<>'''') and seq=1'+
                 ')' +
                 ' and hszh='+ inttostr(gblHSZH)+
                 ' order by ksid';
      end;
      try
      qr.Open;
      except
        if gblShowNoWaitGroup=1 then
        begin
          qr.SQL.Text:=' SELECT  t_KS.ksid,t_ks.ksmc,0 as hided ' +
                     ' from t_ks ' +
                     ' where t_ks.ksid' +
                     ' in (select distinct ksid from t_dhxx where hszh=' + inttostr(gblhszh) +')' +
                     ' and hszh='+ inttostr(gblHSZH)+
                     ' and kfbz=0'+
                     ' order by ksid';
        end
        else
        begin
          qr.SQL.Text:=' SELECT  t_KS.ksid,t_ks.ksmc,0 as hided ' +
                     ' from t_ks ' +
                     ' where t_ks.ksid' +
                     ' in (select distinct ksid from t_dhxx where  jzbz<>0 and hszh=' + inttostr(gblhszh) +')' +
                     ' and hszh='+ inttostr(gblHSZH)+
                     ' and kfbz=0'+
                     ' order by ksid';
        end;
        qr.Open;
      end;
    end
    else
    begin
      ///从T_DHXX表中查找要打开的窗口
      qr.SQL.Text:=' SELECT  t_KS.ksid,t_ks.ksmc,hided ' +
                 ' from t_ks ' +
                 ' where hszh='+ inttostr(gblHSZH)+
                 ' and kfbz=0'+
                 ' order by ksid';
      try
      qr.Open;
      except
        qr.SQL.Text:=' SELECT  t_KS.ksid,t_ks.ksmc,0 as hided ' +
                   ' from hszh='+ inttostr(gblHSZH)+
                   ' and kfbz=0'+
                   ' order by ksid';
        qr.Open;
      end;
    end;
    ///////////将数据放入ksxx中.
    with qr do
    begin
       while not qr.Eof do
       begin
          isEXSIT:=false;
          for tmpgrpnumber:=0 to groupnumber-1 do
          begin
              if groupserial[tmpgrpnumber].ksid=fields.Fields[0].AsString then
              begin
                   isEXSIT:=true;
                   break;
              end;
          end;
          if isEXSIT then
          begin
             next;
          end
          else
          begin
            setlength(groupserial,groupnumber+1);
            groupserial[groupnumber].ksid:=fields.Fields[0].AsString;
            groupserial[groupnumber].ksmc:=fields.Fields[1].AsString;
            try
              groupserial[groupnumber].hided:=fields.Fields[2].AsInteger;
            except
              groupserial[groupnumber].hided:=0;
            end;
            orderid := GetDBValue('KS',groupserial[groupnumber].ksid,'orderid');
            if orderid='' then
            begin
              orderid :='9999';
            end;
            if (GroupSerial[GroupNumber].hided=0) then//不隐藏
            begin
              //插入一条数据到t_ks_order表中;
              if gblrunappmode=0 then
              InsertToOrder(gblHSZH,GroupNumber,groupserial[groupnumber].ksid,StrToInt(orderid));
            end;
            groupserial[groupnumber].newno := false;
            Next;
            groupnumber:=groupnumber+1;
          end;
       end;
       Close;
    end;

  except
    begin
      result := 0;
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
  result := groupnumber;

end;

{*******************************************************************************
*函数名:SetAllKS
                                           *
*函数机能:设置grouplistserial[].                                         *
*******************************************************************************}
function TdmDBAccess.SetAllKS(var ksxx:array of udfks;
       const HSZH:integer):integer;
var
  tmpgrpnumber:integer;
  isEXSIT:boolean;
  qr:TADOQuery;
  i,hided:integer;
begin
  qr := TADOQuery.Create(nil);
  try
  try
    qr.Connection := ADOConnection;
    qr.Close;
    //从T_HJZD,T_YH中查找已登录的医生所要呼叫的窗口
//    qr.SQL.Text:=' SELECT distinct ksid,ksmc,hided from ' +
//          ' t_ks ' +
//          ' where hszh=' + inttostr(hszh)+
//          ' and kfbz=0'+
//          ' and hided=0'+
//          ' and ksid in (select ksid from t_ghxx '+
//            ' where hszh='+inttostr(HSZH)+' group by ksid'+
//            ' union select ksid from t_dhxx '+
//            ' where hszh='+inttostr(HSZH)+' group by ksid'+
//            ')'+
//          ' order by ksid' ;
    if gblShowNoWaitGroup=1 then
    begin
      qr.SQL.Text:=' SELECT distinct ksid,ksmc,hided,memo from ' +
            ' t_ks ' +
            ' where hszh=' + inttostr(hszh)+
            ' and kfbz=0'+
            ' and hided=0'+
            ' and ksid in (select ksid from t_dhxx '+
              ' where hszh='+inttostr(HSZH)+
              ' group by ksid'+
//               ' union select distinct ksid from t_yh_ks '+
//               ' where yhid in (select yhid from t_hjzd where hszh=' + inttostr(gblhszh) +
//               ' and isnull(yhid,'''')<>'''') and seq=1'+
              ')'+
            ' order by ksid' ;
    end
    else
    begin
      qr.SQL.Text:=' SELECT distinct ksid,ksmc,hided,memo from ' +
            ' t_ks ' +
            ' where hszh=' + inttostr(hszh)+
            ' and kfbz=0'+
            ' and hided=0'+
            ' and ksid in (select ksid from t_dhxx '+
              ' where hszh='+inttostr(HSZH)+
              ' and jzbz<>0'+
              ' group by ksid'+
//               ' union select distinct ksid from t_yh_ks '+
//               ' where yhid in (select yhid from t_hjzd where hszh=' + inttostr(gblhszh) +
//               ' and isnull(yhid,'''')<>'''') and seq=1'+
              ')'+
            ' order by ksid' ;
    end;
    qr.Open;
    //此处要加入一个判断条件//如果当前时间段没有排班则不显示
    //wugang 2014-11-14
    ///////////////////////////////////////////////////////
    GroupListNumber:=qr.RecordCount;
    if GroupListNumber>0 then
       setlength(GroupListSerial,GroupListNumber)
    else
     begin
     result:=0 ;
   //  exit;
     end;
    ///////////将数据放入ksxx中.
    tmpgrpnumber:=0;
    with qr do
    begin
       while not qr.Eof do
       begin
         hided:=0;
          if gblHideNoon = 1 then  //是否要在13点后隐藏只有上午病人的科室//
          begin
            if (formatdatetime('hh:nn', now) >= '13:00') then //下午时间
            begin
                if (dmdbaccess.getwaitcount(fields.Fields[0].AsString, 2) = 0) then
                begin
                  hided:=1;
                end;
            end;
          end;
         if hided=0 then
         begin
            GroupListSerial[tmpgrpnumber].ksid:=fields.Fields[0].AsString;
            if trim(fields.Fields[3].AsString) ='' then  //备注为空,取科室名称，否则取备注//
              GroupListSerial[tmpgrpnumber].ksmc:=fields.Fields[1].AsString
            else
              GroupListSerial[tmpgrpnumber].ksmc:=fields.Fields[3].AsString;
            try
              GroupListSerial[tmpgrpnumber].hided:=fields.Fields[2].AsInteger;
            except
              GroupListSerial[tmpgrpnumber].hided:=0;
            end;
            inc(tmpgrpnumber,1);
         end;
         Next;
       end;
       Close;
    end;
    GroupListNumber:=tmpgrpnumber;
    setlength(GroupListSerial,GroupListNumber);
  except
    begin
      result := 0;
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
  result := grouplistnumber;

end;
{*******************************************************************************
*函数名:SetAllHJZD
                                           *
*函数机能:设置gblhjzdarray[].                                         *
*******************************************************************************}
function TdmDBAccess.SetAllHJZD(const HSZH:integer):integer;
var
  tmpgrpnumber:integer;
  qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
  try
    //    zdid:string;
//    zdmc:string;
//    ip:string;
//    port:integer;
//    recvtime:tdatetime;
//    yhid:string;
//    ddrs:integer;
    qr.Connection := ADOConnection;
    qr.Close;
    qr.SQL.Text:=' SELECT zdid,fjmc,'''' ip,0 port,getdate() as recvtime,yhid,0 ddrs from ' +
          ' t_hjzd ' +
          ' where hszh=' + inttostr(hszh)+
          ' order by zdid';
    qr.Open;
    gblhjzdsl:=qr.RecordCount;
    if gblhjzdsl>0 then
       setlength(gblhjzdarray,gblhjzdsl)
    else
    begin
      result:=0 ;
     end;
    ///////////将数据放入gblhjzdarray中.
    tmpgrpnumber:=0;
    with qr do
    begin
       while not qr.Eof do
       begin
          gblhjzdarray[tmpgrpnumber].zdid := fields.Fields[0].AsString;
          gblhjzdarray[tmpgrpnumber].zdmc := fields.Fields[1].AsString;
          gblhjzdarray[tmpgrpnumber].ip := fields.Fields[2].AsString;
          gblhjzdarray[tmpgrpnumber].port := fields.Fields[3].AsInteger;
          gblhjzdarray[tmpgrpnumber].recvtime := fields.Fields[4].AsDateTime;
          gblhjzdarray[tmpgrpnumber].yhid := fields.Fields[5].AsString;
          gblhjzdarray[tmpgrpnumber].ddrs := fields.Fields[6].AsInteger;
          inc(tmpgrpnumber,1);
          Next;
       end;
       Close;
    end;
  except
    begin
      result := 0;
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
  result := gblhjzdsl;
end;

{*******************************************************************************
*函数名:SetDQBR;
                                           *
*函数机能:设置lblGHHM,lblBRXM                                           *
*******************************************************************************}
function TdmDBAccess.SetDQBR(var lblGHHM: TLabel; lblBRXM:TLabel;
  const KSID: string; const HSZH:integer ): Boolean;
var
  qr :TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
    qr.Close;
    //在等待T_DHXX表中查找科室为KSID的本护士站的未就诊的病人信息.
    qr.SQL.Text:=' select ghhm,brxm from  ' +
                            ' t_dhxx ' +
                            ' where ksid=''' + ksid + '''' + ' and jzbz=''0''' +
                            ' and hszh=' + inttostr(hszh) +
                            ' and jzsj is not null ' +
                            ' order by jzsj desc ' ;
    qr.Open;
    ///////////将数据放入LISTVIEW中.
    with qr do
    begin
       if not qr.Eof  then
         begin
          lblGHHM.caption:=fields.fields[0].AsString;
          lblBRXM.caption:=fields.fields[1].AsString;
         end
       else
         begin
          lblGHHM.caption:='';
          lblBRXM.caption:='';
         end;
       Close;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;
  result := True;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:SetGroupCount;
                                           *
*函数机能:设置等待人数/总数label                                          *
*******************************************************************************}
function TdmDBAccess.SetGroupCount(var lbl:TLabel;
  const KSID: string; const HSZH:integer ): Boolean;
var
  qr :TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
    qr.Close;
    //在等待T_DHXX表中查找科室为KSID的本护士站的未就诊的病人信息.
    qr.SQL.Text:=' select count(*),isnull(sum(case when jzbz=0 then 0'+
                 '  when jzbz=2 then 0 else 1 end ),0) from  ' +
                            ' t_dhxx ' +
                            ' where ksid=''' + ksid + ''''+
                            ' and hszh=' + inttostr(hszh);
    qr.Open;
    ///////////将数据放入LISTVIEW中.
    with qr do
    begin
       if not qr.Eof  then
         begin
          lbl.caption:=fields.fields[1].AsString +'/'+fields.fields[0].AsString+'人';
         end
       else
         begin
          lbl.caption:='0/0人';
         end;
       Close;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;
  result := True;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:YHSeleKeshi;
                                           *
*函数机能:设置                                           *
*******************************************************************************}
function TdmDBAccess.YHSeleKeshi(const ZDID: string; const cmd:string;
  const KSID:string;const yhid:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc:string ;
   hjksid,hjksmc:string;
   isexsit :boolean;
   fjh,fjmc,zth,ztmc:string;
   YJPIP:string;
   i:integer;
   tmpquery,qr:Tadoquery;
   retint:integer;
   newksid:string;
   newksmc:string;
   LockGroup:string;
   RoomType:integer;
   TypePreStr:string;
   intpos:integer;
   tmpAdoSp:TADOStoredProc;
   waitlisttype:integer;
   callks:array of string;
   callkscnt:integer;
   tmpstr:string;
   changemoregroup:boolean;
   intcallkscount:integer;
   ksarray: array[0..99] of CallGroup_Info;
   ksmc:string;
begin
  newksid:=ksid;
  ////
  //2017-08-04修改,加入多个科室的切换功能,多个科室用,分开//
  ////
  intpos:=foundchar('#',newksid);
  if intpos>0 then
  begin
    if RightStr(newksid,1)<>'#' then
      newksid := newksid+'#';
    newksid := AnsiReplaceStr(newksid,'#','|');
    newksmc := getpartstr(newksid,'2');
    newksid := getpartstr(newksid,'1');
  end
  else
  begin
    newksmc :='';
  end;
  ///
  newksid:=trim(newksid);
  newksmc:=trim(newksmc);
  dmdbaccess.addlog('errorlog.txt','设置呼叫科室YHSeleKeshi-001:'+newksid+ ' '+ newksmc );
  if newksid='' then
  begin
    if GetYHCallKS(yhid,intcallkscount,ksarray) then
    begin
      if intcallkscount>0 then
        ksmc :=ksarray[0].TGroupName;
    end;
    result:=zdid+cmd + '01'+ksmc;
    exit;
  end;
  intpos:=foundchar(',',newksid);
  changemoregroup:=false;
  if intpos>0 then
  begin
    changemoregroup := true;
    newksid := AnsiReplaceStr(newksid,',','|');
    tmpstr :=  getpartstr(newksid,'1');
    callkscnt:=1;
    while true do
    begin
      tmpstr := getpartstr(newksid,inttostr(callkscnt+1));
      if tmpstr='' then
      begin
        break;
      end
      else
      begin
        callkscnt:=callkscnt+1;
      end;
    end;
    setlength(callks,callkscnt);
    tmpstr :=  getpartstr(newksid,'1');
    callkscnt:=1;
    callks[callkscnt-1] :=tmpstr;
    while true do
    begin
      tmpstr := getpartstr(newksid,inttostr(callkscnt+1));
      if tmpstr='' then
      begin
        break;
      end
      else
      begin
        callkscnt:=callkscnt+1;
        callks[callkscnt-1] :=tmpstr;
      end;
    end;
  end
  else
  begin
    callkscnt :=1;
    setlength(callks,1);
    callks[0] := newksid;
  end;
  dmdbaccess.addlog('errorlog.txt','设置呼叫科室YHSeleKeshi-002:'+inttostr(callkscnt)+ ' '+ callks[0] );
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
    result:='';
    qr.Close;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc,LockGroup,Type from  ' +
                           ' t_hjzd left outer join t_yh on ' +
                           ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                           ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;

    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
         begin
           if yhid='' then
            zdyhid:=fields.fields[4].asstring
           else
            zdyhid:=yhid;
          zdyhmc:=fields.fields[5].asstring ;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          LockGroup :=fields.Fields[7].AsString;
          RoomType :=fields.Fields[8].AsInteger;
          waitlisttype := strtoint(getdbvalue('HJZD',zdid,'waitlisttype'));
          if waitlisttype=0 then
            waitlisttype:=gblwaitlisttype;
          dmdbaccess.addlog('errorlog.txt','设置呼叫科室YHSeleKeshi-003:'+inttostr(waitlisttype) );
//          if (waitlisttype=4) or (waitlisttype=5) or (waitlisttype=6) then//如果是虚拟呼叫终端v3.0版.
//          begin
//            //清除所有呼叫科室
//              tmpquery:=Tadoquery.Create(nil);
//              try
//                tmpquery.Connection:=adoconnection;
//                tmpquery.SQL.Clear;
//                tmpquery.Parameters.Clear;
//                tmpquery.SQL.Text:=' delete t_yh_ks where yhid=:p1 and hszh=:p2';
//                tmpquery.Parameters.ParamByName('p1').Value :=zdyhid;
//                tmpquery.Parameters.ParamByName('p2').Value :=gblhszh;
//                tmpquery.ExecSQL;
//                tmpquery.Close;
//              finally
//                tmpquery.Free;
//              end;
//              //暂时去掉修改呼叫方式功能,20181123 南西 wugang
////              tmpquery:=Tadoquery.Create(nil);
////              try
////                tmpquery.Connection:=adoconnection;
////                tmpquery.SQL.Clear;
////                tmpquery.Parameters.Clear;
////                tmpquery.SQL.Text:=' update t_yh '+
////                    ' set hjfs=1 '+
////                    ' where yhid=:p1 and hszh=:p2';
////                tmpquery.Parameters.ParamByName('p1').Value :=zdyhid;
////                tmpquery.Parameters.ParamByName('p2').Value :=gblhszh;
////                tmpquery.ExecSQL;
////                tmpquery.Close;
////              finally
////                tmpquery.Free;
////              end;
//          end;
          dmdbaccess.addlog('errorlog.txt','设置呼叫科室YHSeleKeshi-004:'+(LockGroup) );
          if (LockGroup<>'') and (LockGroup<>'0') then //锁定科室
          begin
            newksid :=LockGroup;
          end
          else
          begin
            if newksid='0' then//切换所有科室
            begin
              if (waitlisttype=4) or (waitlisttype=5) or (waitlisttype=6) then//如果是虚拟呼叫终端v3.0版.
              begin
                //清除所有呼叫科室
                  tmpquery:=Tadoquery.Create(nil);
                  try
                    tmpquery.Connection:=adoconnection;
                    tmpquery.SQL.Clear;
                    tmpquery.Parameters.Clear;
                    tmpquery.SQL.Text:=' delete t_yh_ks where yhid=:p1 and hszh=:p2';
                    tmpquery.Parameters.ParamByName('p1').Value :=zdyhid;
                    tmpquery.Parameters.ParamByName('p2').Value :=gblhszh;
                    tmpquery.ExecSQL;
                    tmpquery.Close;
                  finally
                    tmpquery.Free;
                  end;
               end;
              dmdbaccess.addlog('errorlog.txt','设置呼叫科室YHSeleKeshi-004-01:'+(newksid) );
              //修改这个员工呼叫的科室为预设的所有科室。
              //先将这个员工的呼叫科室清除.
              //将预设的呼叫科室设置为这个员工的就诊科室
              tmpquery:=Tadoquery.Create(nil);
              try
                try
                tmpquery.Connection:=adoconnection;
//                tmpquery.SQL.Clear;
//                tmpquery.Parameters.Clear;
//                tmpquery.SQL.Text:=' delete t_yh_ks where yhid=:p1 and hszh=:p2';
//                tmpquery.Parameters.ParamByName('p1').Value :=zdyhid;
//                tmpquery.Parameters.ParamByName('p2').Value :=gblhszh;
//                tmpquery.ExecSQL;
//                tmpquery.Close;
                //呼叫预设的所有科室
                tmpquery.SQL.Clear;
                tmpquery.Parameters.Clear;
                tmpquery.SQL.Text:=' insert into t_yh_ks(hszh,ksid,yhid,seq,'+
                    ' ZCGH, Prepare, CallCount, CalledCount)'+
                    ' select hszh,ksid,yhid,seq,'+
                    ' ZCGH, Prepare, CallCount, 0'+
                    ' from t_yh_ks_sz '+
                    ' where yhid=:p1 and hszh=:p2';
                tmpquery.Parameters.ParamByName('p1').Value :=zdyhid;
                tmpquery.Parameters.ParamByName('p2').Value :=gblhszh;
                tmpquery.ExecSQL;
                tmpquery.Close;
                //改为按时间先后呼叫。
//                tmpquery.SQL.Clear;
//                tmpquery.Parameters.Clear;
//                tmpquery.SQL.Text:=' update t_yh '+
//                    ' set hjfs=3 '+
//                    ' where yhid=:p1 and hszh=:p2';
//                tmpquery.Parameters.ParamByName('p1').Value :=zdyhid;
//                tmpquery.Parameters.ParamByName('p2').Value :=gblhszh;
//                tmpquery.ExecSQL;
//                tmpquery.Close;

                tmpquery.SQL.Clear;
                tmpquery.Parameters.Clear;
                tmpquery.SQL.Text:=' select ksid'+
                    ' from t_yh_ks_sz '+
                    ' where yhid=:p1 and hszh=:p2'+
                    ' order by seq';
                tmpquery.Parameters.ParamByName('p1').Value :=zdyhid;
                tmpquery.Parameters.ParamByName('p2').Value :=gblhszh;
                tmpquery.Open;
                if tmpquery.Eof then
                begin
                  newksid := '';
                end
                else
                begin
                  newksid := tmpquery.fieldbyname('ksid').AsString;
                end;
                tmpquery.Close;
                except

                end;
              finally
                tmpquery.Free;
              end;
            end;
            if newksid='' then
            begin
              //result:=zdid+cmd + '016666';
              if GetYHCallKS(zdyhid,intcallkscount,ksarray) then
              begin
                if intcallkscount>0 then
                  ksmc :=ksarray[0].TGroupName;
              end;
              result:=zdid+cmd + '01'+ksmc;
              exit;
            end;
            dmdbaccess.addlog('errorlog.txt','设置呼叫科室YHSeleKeshi-004-02:'+inttostr(RoomType) );
            if RoomType<>0 then //
            begin
              TypePreStr :=GetDBValue(D026,IntToStr(Roomtype),'PreStr');
              newksid := TypePreStr+zdyhid
              //YHSeleKeShi(zdid,'DC',TypePreStr+YHID);
            end
            else //否则就要判断 存储过程MY_InsertYszjks的返回值.
            begin
               dmdbaccess.addlog('errorlog.txt','设置呼叫科室YHSeleKeshi-004-03:'+inttostr(retint) );
              //查看有无此存储过程
                retint:=0;
                tmpquery:=Tadoquery.Create(nil);
                try
                  try
                    tmpquery.Connection:=adoconnection;
                    tmpquery.SQL.Text:=' select * from dbo.sysobjects where '+
                    ' id = object_id(N''[dbo].[My_InsertYszjks]'')';
                    tmpquery.Open;
                    if tmpquery.eof then
                    begin
                       retint :=0;
                    end
                    else
                      retint :=1;
                    tmpquery.Close;
                  except
                    retint:=0;
                  end;
                finally
                  tmpquery.Free;
                end;
                dmdbaccess.addlog('errorlog.txt','设置呼叫科室YHSeleKeshi-004-04:'+inttostr(retint) );
                //有则执行
                if retint >0 then
                begin
                  retint :=0;
                  tmpAdoSp := TADOStoredProc.Create(nil);
                  try
                    try
                    tmpAdoSp.Connection := ADOConnection;
                    with tmpAdoSp do
                    begin
                      ProcedureName := 'My_InsertYszjks';
                      Parameters.Clear;
                      Parameters.CreateParameter('HSZH',
                        ftInteger, pdInput, 20, gblHSZH);
                      Parameters.CreateParameter('KSID',
                        ftString, pdInput, 20, newksid);
                      Parameters.CreateParameter('KSMC',
                        ftString, pdInput, 80, newksmc);
                      Parameters.CreateParameter('YSDM',
                        ftString, pdInput, 80, zdyhid);
                      Parameters.CreateParameter('YSXM',
                        ftString, pdInput, 80, zdyhmc);
                      Open;
                      if tmpAdoSp.RecordCount>0 then
                      begin
                        retint := tmpAdoSp.fieldbyname('ret').AsInteger;
                      end
                    end;
                    except
                      retint:=0;
                    end;
                  finally
                    tmpAdoSp.Free;
                  end;
                  if retint=0 then//普通
                  begin
                    newksid := newksid;
                  end
                  else//专家或特需  不需要执行切换科室
                  begin
                    zdyhid:='';
                  end;
                end
                else//否则就按切换的科室切换
                begin
                  newksid := newksid;
                end;
            end;
          end;
          dmdbaccess.addlog('errorlog.txt','设置呼叫科室YHSeleKeshi-005:'+(newksid) );
          if ( zdyhid <>'')  then
          begin
              tmpquery:=Tadoquery.Create(nil);
              tmpquery.Connection:=adoconnection;
              if changemoregroup then     //如果切换的科室多于1个，则先清除呼叫科室，再逐个添加
                begin
                  dmdbaccess.addlog('errorlog.txt','设置呼叫科室YHSeleKeshi-005-1:'+(newksid) );
                  //1.清除呼叫科室
                  tmpquery.SQL.Clear;
                  tmpquery.Parameters.Clear;
                  tmpquery.SQL.Text:=' delete t_yh_ks where yhid=:p1 and hszh=:p2';
                  tmpquery.Parameters.ParamByName('p1').Value :=zdyhid;
                  tmpquery.Parameters.ParamByName('p2').Value :=gblhszh;
                  tmpquery.ExecSQL;
                  tmpquery.Close;
                  //2.逐个添加呼叫科室
                  for i:=0 to callkscnt-1 do
                  begin
                    tmpquery.SQL.Clear;
                    tmpquery.Parameters.Clear;
                    tmpquery.sql.text := ' insert into t_yh_ks(hszh,ksid,yhid,seq,'+
                      'ZCGH, Prepare, CallCount, CalledCount)'+
                      ' values('+inttostr(gblhszh)+','+
                      quotedstr(callks[i])+','+
                      quotedstr(zdyhid)+','+inttostr(i+1)+',1,1,0,0)';
                    retint:=tmpquery.execsql;
                    if  retint>0 then
                    begin
                       result:=zdid+cmd + '016666'; ///成功;
                       //修改显示信息表中的呼叫科室ksid,ksmc     ---20161114去掉  by wugang
                       //ChangeUserShowGroup(zdid,zdyhid,newksid);
                    end
                    else
                     result:=zdid+cmd + '048888'; ///不成功;
                  end;
                  if retint>0  then
                  begin
                    if GetYHCallKS(zdyhid,intcallkscount,ksarray) then
                    begin
                      if intcallkscount>0 then
                      begin
                        ksmc :=ksarray[0].TGroupName;
                        hjksid := ksarray[0].TGroupid;
                        hjksmc := ksarray[0].TGroupName;
                      end;
                    end;
                    //if intcallkscount>0 then
                    //  WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjksid,hjksmc,'欢迎光临','',YHID,ZDYHMC,'','','',0,1,'','','');
                    result:=zdid+cmd + '01'+ksmc;
                  end;
                end
                else
                  begin
                   dmdbaccess.addlog('errorlog.txt','设置呼叫科室YHSeleKeshi-005-2:'+(newksid) );

                tmpquery.SQL.Text:=' SELECT 1 FROM T_KS WHERE ksid='''+newksid+''''+' and hszh='+inttostr(gblhszh);
                tmpquery.Open;
                if tmpquery.Eof then
                begin
                  tmpquery.Close;
                  if ChangeUserGroup(zdyhid,'') then
                  begin
                    if GetYHCallKS(zdyhid,intcallkscount,ksarray) then
                    begin
                      if intcallkscount>0 then
                      begin
                        ksmc :=ksarray[0].TGroupName;
                        hjksid := ksarray[0].TGroupid;
                        hjksmc := ksarray[0].TGroupName;
                      end;
                    end;
                    if intcallkscount>0 then
                      WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjksid,hjksmc,'欢迎光临','',zdyhid,ZDYHMC,'','','',0,1,'','','');
                    result:=zdid+cmd + '01'+ksmc;
                     //result:=zdid+cmd + '016666'; ///成功;
                     //修改显示信息表中的呼叫科室ksid,ksmc   ---20161114去掉  by wugang
                     //ChangeUserShowGroup(zdid,zdyhid,'');
                  end
                  else
                     result:=zdid+cmd + '048888'; ///不成功;
  //                if retint>0 then
  //                   result:=zdid+cmd + '016666' ///成功;
  //                else
  //                   result:=zdid+cmd + '048888'; ///不成功;
                  tmpquery.Close;
                  FreeAndNil(tmpquery);
  //                result:=zdid+cmd + '028888';///无此科室
  //                tmpquery.Close;
  //                FreeAndNil(tmpquery);
                end
                else
                begin
                  tmpquery.Close;

                  begin
                    if ChangeUserGroup(zdyhid,newksid) then
                    begin
                      if GetYHCallKS(zdyhid,intcallkscount,ksarray) then
                      begin
                        if intcallkscount>0 then
                        begin
                          ksmc :=ksarray[0].TGroupName;
                          hjksid := ksarray[0].TGroupid;
                          hjksmc := ksarray[0].TGroupName;
                        end;
                      end;
                      if intcallkscount>0 then
                        WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjksid,hjksmc,'欢迎光临','',zdyhid,ZDYHMC,'','','',0,1,'','','');

                      result:=zdid+cmd + '01'+ksmc;
                       //result:=zdid+cmd + '016666'; ///成功;
                       //修改显示信息表中的呼叫科室ksid,ksmc   ---20161114去掉  by wugang
                       //ChangeUserShowGroup(zdid,zdyhid,newksid);
                    end
                    else
                    begin
                      tmpquery.sql.text := ' insert into t_yh_ks(hszh,ksid,yhid,seq,'+
                        'ZCGH, Prepare, CallCount, CalledCount)'+
                        ' values('+inttostr(gblhszh)+','+
                        quotedstr(newksid)+','+
                        quotedstr(zdyhid)+','+'1,1,1,0,0)';
                      retint:=tmpquery.execsql;
                      if  retint>0 then
                      begin
                        if GetYHCallKS(zdyhid,intcallkscount,ksarray) then
                        begin
                          if intcallkscount>0 then
                          begin
                            ksmc :=ksarray[0].TGroupName;
                            hjksid := ksarray[0].TGroupid;
                            hjksmc := ksarray[0].TGroupName;
                          end;
                        end;
                        if intcallkscount>0 then
                          WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjksid,hjksmc,'欢迎光临','',zdyhid,ZDYHMC,'','','',0,1,'','','');

                        result:=zdid+cmd + '01'+ksmc;
                         //result:=zdid+cmd + '016666'; ///成功;
                         //修改显示信息表中的呼叫科室ksid,ksmc     ---20161114去掉  by wugang
                         //ChangeUserShowGroup(zdid,zdyhid,newksid);
                      end
                      else
                       result:=zdid+cmd + '048888'; ///不成功;
                    end;
                    tmpquery.Close;
                  end;
                end;
                FreeAndNil(tmpquery);
              end;
              close;
//             exit ;
          end
          else
             begin
               result:=zdid+cmd + '016666'; ///成功;
               //result:=zdid + cmd + '028888';  ///没有此呼叫器
                close;
             end;
        end
       else
         begin
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
         end;
    end;
  except
    begin
      dmdbaccess.addlog('errorlog.txt','设置呼叫科室YHSeleKeshi-006:'+(newksid) );
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.YHInsertYH(const ZDID: string; const cmd:string;const YHID:string;const YHxm:string): string;
var
   ksid1:string;
   tmpquery,qr:Tadoquery;
   tmpyhid:string;
   tmpyhmc:string;
   intpos:integer;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
   intpos:=pos('#',YHID);
   if intpos=0 then
   begin
      tmpyhid:=yhid;
      tmpyhmc:=YHxm;
   end
   else
   begin
     tmpyhid:=copy(yhid,1,intpos-1);
     tmpyhmc:=Copy(YHID,intpos+1,255);
     intpos := pos('#',tmpyhmc);
     if intpos>0 then
       tmpyhmc:=copy(tmpyhmc,1,intpos-1);
   end;
   ////////////Added by WuGang @2007-03-22     start
   qr.close;
   if yhid<>'' then
   begin
      qr.SQL.Text:=' select y.yhid,yhmc,ksid from T_yh y left outer join t_yh_ks yk '+
        ' on y.yhid=yk.yhid and y.hszh=yk.hszh and yk.seq=1'+
        ' where y.yhid='''+tmpyhid+''' and y.hszh='+inttostr(gblhszh);
      qr.Open;
      if qr.Eof then//没有此员工
      begin
          tmpquery:=Tadoquery.Create(nil);
          tmpquery.Connection:=adoconnection;
          tmpquery.SQL.Text:=' Insert into t_yh(yhid,yhmc,qxid,ksid1,ztbz,hszh,zcgh1,zcgh2,zcgh3,prepare1,memo) '+
                             ' values('''+tmpyhid+''','+
                             ' '''+tmpyhmc+''','+
                             '3,'+
                             ' '''+''+''','+
                             ' ''0'','+
                             ''+inttostr(gblhszh)+
                             ''+',1,0,0,1'+
                             ',''程序自动添加'''+
                             ')';
          tmpquery.ExecSQL;
          tmpquery.SQL.Text :='insert into t_zjxx(dm,xm,hszh)'+
            ' select '+quotedstr(tmpyhid)+','+quotedstr(tmpyhmc)+
            ','+inttostr(gblHSZH)+' where not exists(select 1 from t_zjxx'+
            ' where dm='+quotedstr(tmpyhid)+')';
          try
            tmpquery.ExecSQL;
          except
          end;
          tmpquery.SQL.Text :='update t_zjxx set zp=z.zp '+
            ' from t_zjxx inner join (select a.dm,b.zp from t_zjxx a,'+
            ' (select zp from t_zjxx where dm=''6666'') b '+
            ' where dm='+quotedstr(tmpyhid) +' and a.zp is null) z'+
            ' on t_zjxx.dm=z.dm';
          try
            tmpquery.ExecSQL;
          except
          end;
          FreeAndNil(tmpquery);
          result:=zdid+cmd+'016666';//成功
      end
      else
      begin
        //更新此医生的姓名
          if tmpyhmc<>'' then
          begin
            tmpquery:=Tadoquery.Create(nil);
            tmpquery.Connection:=adoconnection;
            tmpquery.SQL.Text:=' update t_yh set yhmc=:p1'+
                ' where yhid=:p2 and yhmc<>:p3 and hszh=:p4';
            tmpquery.Parameters.ParamByName('p1').Value := tmpyhmc;
            tmpquery.Parameters.ParamByName('p2').Value := tmpyhid;
            tmpquery.Parameters.ParamByName('p3').Value := tmpyhmc;
            tmpquery.Parameters.ParamByName('p4').Value := gblhszh;
            try
            tmpquery.ExecSQL;
            except
            end;
            tmpquery.SQL.Clear;
            tmpquery.Parameters.Clear;
            tmpquery.SQL.Text :=' update t_zjxx set xm=:p1'+
                ' where dm=:p2 and xm<>:p3';
            tmpquery.Parameters.ParamByName('p1').Value := tmpyhmc;
            tmpquery.Parameters.ParamByName('p2').Value := tmpyhid;
            tmpquery.Parameters.ParamByName('p3').Value := tmpyhmc;
            try
              tmpquery.ExecSQL;
            except
            end;
            FreeAndNil(tmpquery);
          end;
        ////////////////////////////////////////////////////////


        ksid1:=qr.Fields[2].AsString;
        if ksid1='' then
        begin
           result:=zdid+cmd+'016666';//成功;
        end
        else
        begin
          qr.close;
          result:=zdid+cmd+'015555';//已经设置了科室;
        end;
      end;
   end
   else
      result:=zdid+cmd+'038888';//yhid为空;
   ////////////Added by WuGang @2007-03-22     end;
  finally
    FreeAndNil(qr);
  end;
end;


{*******************************************************************************
*函数名:YHLOgin;
                                           *
*函数机能:设置                                           *
*******************************************************************************}
function TdmDBAccess.YHLogin(const ZDID: string; const cmd:string;
  const YHID:string;const YHxm:string;
  const Aip:string;const Aport:Integer;
  const Ayhmm:string;
  const Abz:integer): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc:string ;
   hjksid,hjksmc:string;
   isexsit :boolean;
   fjh,fjmc,zth,ztmc:string;
   YJPIP:string;
   i:integer;
   ksid1:string;
   tmpquery:Tadoquery;
   ksbrdys:string;
   qr:TADOQuery;
   LockGroup:string;
   RoomType:integer;
   TypePreStr:string;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   tmpstr:string;
   zjbz:string;//'1'-是，'0'-否.
begin
  qr:= TADOQuery.Create(nil);
  try
  try
    qr.Connection := ADOConnection;
    //gbledit_ks_count:=0;
    result:='';
    zjbz:='0';
    qr.Close;
//    if Abz=0 then
//    begin
//      try
//        qr.SQL.Text :=' check_doctor_zj '+quotedstr(yhid);
//        qr.Open;
//        if not qr.Eof then//是专家医生
//        begin
//          zjbz:='1';
//          while not qr.Eof do
//          begin
//            zdyhid := qr.fieldbyname('ysdm').AsString;
//            zdyhmc := qr.fieldbyname('ysxm').AsString;
//            hjksid := qr.fieldbyname('ksid').AsString;
//            hjksmc := qr.fieldbyname('ksmc').AsString;
//            tmpstr :=zdyhid+'#'+zdyhmc+'#'+'1#'+hjksid+'#'+hjksmc+'#';
//            yhsetselfinfo(zdid,'G4',tmpstr,Aip,Aport);
//            qr.Next;
//          end;
//        end;
//      except
//      end;
//      qr.Close;
//    end;
    //在等待T_hjzd表中查找zdid.
    qr.sql.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc,LockGroup,Type from  ' +
                           ' t_hjzd left outer join t_yh on ' +
                           ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                           ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;

    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
         begin
          zdyhid:=fields.fields[4].asstring ;
          //zdyhmc:=fields.fields[4].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          LockGroup :=fields.Fields[7].AsString;
          RoomType :=fields.Fields[8].AsInteger;
          if ( zdyhid <>'')  then
             begin
               if (cmd='30') or (cmd='60') then
                  result:=zdid+cmd + '呼叫器被占用!  请先退出'///呼叫器被占用.
               else
                  result:=zdid+cmd + '028888';///呼叫器被占用.
               close;
//             exit ;
               // WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,'','','停止服务','',zdyhid,ZDYHMC,'','','',0,1,'','','');
                if zdyhid<>yhid then
                WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,'','','停止服务','',ZDYHID,'','','','',0,1,'','','');
             end
          else
             begin
//             adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+ ' where zdid=' + inttostr(zdid) + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
//             result:=inttostr(zdid)+cmd +'01'  ;
             close;
             end;
          end
       else
         begin
           if (cmd='30') or (cmd='60') then
           result:=zdid + cmd +'没有此呼叫器!  请管理员设置!'
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
         end;
    end;
    SetHJZDip(inttostr(strtoint(zdid)),aip,aport);
    //插入一个医生
    if gblAutoInsertDoctor=0 then  //不需要自动插入医生
    begin

    end
    else
    begin
      YHInsertYH(zdid,'DD',YHID,YHxm);
    end;
    if (LockGroup<>'') and (LockGroup<>'0') then //锁定科室
    begin
      YHSeleKeShi(zdid,'DC',LockGroup,yhid);
    end
    else
    begin
      if RoomType<>0 then //
      begin
        TypePreStr :=GetDBValue(D026,IntToStr(Roomtype),'PreStr');
        YHSeleKeShi(zdid,'DC',TypePreStr+YHID,yhid);
      end;
    end;
    if gblcodepassword=1 then
    begin
    //密码判断。
    if not CheckPassword(yhid,ayhmm) then
    begin
       if (cmd='30') or (cmd='60') then
       result:=zdid + cmd +'密码不正确  !  请管理员设置'
       else
       result:=zdid + cmd + '008888';  //没有此用户号
       exit;
    end;
    end;
    //在等待T_YH表中查找YHID信息.
    tmpquery:=Tadoquery.create(nil);
    tmpquery.Connection:=adoconnection;

    tmpquery.SQL.Text :='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + YHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    tmpquery.Open;
    ///////////将中.
    with tmpquery do
    begin
       if not tmpquery.Eof  then
       begin
          zdyhmc:=tmpquery.fields.fields[1].asstring;
          isexsit:=false;
          GetYHCallKS(YHID,hjksnum,hjks);
          SetHJZDYHID(inttostr(strtoint(zdid)),yhid);
          if hjksnum>0 then
          begin
             if (cmd='80') or (cmd='30') or (cmd='60') then
             begin
                 try
                   adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
                   ',zt='''''+
                   ',state=''登录'''+
                   ',checkinshow=0'+
                   ',ip='''',port=0 where zdid=' + zdid +
                   ' and hszh=' + inttostr(gblhszh) ,cmdtext)
                 except
                   adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
                   ',zt='''''+
                   ',state=''登录'''+
                   ',ip='''',port=0 where zdid=' + zdid +
                   ' and hszh=' + inttostr(gblhszh) ,cmdtext)
                 end;
             end
             else
             begin
                try
                 adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
                   ',ip='''+Aip+''''+',port='+inttostr(Aport)+
                   ',zt='''''+
                   ',state=''登录'''+
                   ',checkinshow=0'+
                   ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
                except
                 adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
                   ',ip='''+Aip+''''+',port='+inttostr(Aport)+
                   ',zt='''''+
                   ',state=''登录'''+
                   ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
                end;
             end;
             for i:=1 to hjksnum do
             begin
               hjksid:=hjks[i].TGroupid;
               hjksmc:=hjks[i].TGroupName;
               ///2014-07-23 吴刚 修改
               ///不显示登录医生的呼叫科室
//               if gblshownowaitgroup=1 then
//               begin
//                 gbledit_ks[gbledit_ks_count].ksid:=hjksid;
//                 gbledit_ks[gbledit_ks_count].ksmc:=hjksmc;
//                 gbledit_ks_count:=gbledit_ks_count+1;
//               end;
               /////////////
               if isexsit=false then
               begin
                 if cmd='80'  then
                    result:=zdid+cmd +'01'//6666'//+ yhid
                 else if (cmd='30') or (cmd='60') then
                 begin
                   result:=zdid + cmd +getstrwithnotbadcode('登陆成功!',15);
                 end
                 else
                    result:=zdid+cmd +'01'+ hjksmc+',' + fields.fields[1].asstring;//+','+zjbz ;
                 //登录后显示欢迎光临
                 if zdyhid<>yhid then
                 WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjksid,hjksmc,'欢迎光临','',YHID,ZDYHMC,'','','',0,1,'','','');
                 //写入准备信息.
                 //if gblzbrs>0 then
                 //   WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid,hjksmc,'','',YHID,ZDYHMC,'','','',0,1);
               end;
               isexsit:=true;
             end;
             if gblCallWithGrpState=1 then ChangeFirstGrpState(YHID,1);
             SetYSXXItems(frmmain.lstvysxx,gblhszh);
          end
          else
          begin
             if (cmd='80') or (cmd='30') or (cmd='60') then
             begin
                 try
                   adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
                   ',zt='''''+
                   ',state=''登录'''+
                   ',checkinshow=0'+
                   ',ip='''',port=0 where zdid=' + zdid +
                   ' and hszh=' + inttostr(gblhszh) ,cmdtext)
                 except
                   adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
                   ',zt='''''+
                   ',state=''登录'''+
                   ',ip='''',port=0 where zdid=' + zdid +
                   ' and hszh=' + inttostr(gblhszh) ,cmdtext)
                 end;
             end
             else
             begin
                try
                 adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
                   ',ip='''+Aip+''''+',port='+inttostr(Aport)+
                   ',zt='''''+
                   ',state=''登录'''+
                   ',checkinshow=0'+
                   ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
                except
                 adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
                   ',ip='''+Aip+''''+',port='+inttostr(Aport)+
                   ',zt='''''+
                   ',state=''登录'''+
                   ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
                end;
             end;
             if cmd='80'  then
                result:=zdid+cmd +'01'//6666'//+ yhid
             else if (cmd='30') or (cmd='60') then
             begin
               result:=zdid + cmd +getstrwithnotbadcode('登陆成功!',15);
             end
             else
                result:=zdid+cmd +'01'+ '无呼叫'+ttl_ks+',' + fields.fields[1].asstring ;
             close;
             //登录后显示欢迎光临
             WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,'','','欢迎光临','',YHID,ZDYHMC,'','','',0,1,'','','');
             //FreeAndNil(tmpquery);
             SetYSXXItems(frmmain.lstvysxx,gblhszh);
          end;


//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   if (cmd='80') or (cmd='30') or (cmd='60') then
//                   begin
//                       try
//                         adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
//                         ',zt='''''+
//                         ',state=''登录'''+
//                         ',ip='''',port=0 where zdid=' + zdid +
//                         ' and hszh=' + inttostr(gblhszh) ,cmdtext)
//                       except
//                         adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
//                         ',zt='''''+
//                         ',state=''登录'''+
//                         ',ip='''' where zdid=' + zdid +
//                         ' and hszh=' + inttostr(gblhszh) ,cmdtext)
//                       end;
//                   end
//                   else
//                   begin
//                      try
//                       adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
//                         ',ip='''+Aip+''''+',port='+inttostr(Aport)+
//                         ',zt='''''+
//                         ',state=''登录'''+
//                         ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
//                      except
//                       adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
//                         ',ip='''+Aip+''''+
//                         ',zt='''''+
//                         ',state=''登录'''+
//                         ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
//                      end;
//                   end;
//                   hjksid:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc:=fields.Fields[intFieldsIndex].AsString;
//                   gbledit_ks[gbledit_ks_count].ksid:=hjksid;
//                   gbledit_ks[gbledit_ks_count].ksmc:=hjksmc;
//                   gbledit_ks_count:=gbledit_ks_count+1;
//                   if isexsit=false then
//                   begin
//                     if cmd='80'  then
//                        result:=zdid+cmd +'01'//6666'//+ yhid
//                     else if (cmd='30') or (cmd='60') then
//                     begin
//                       result:=zdid + cmd +getstrwithnotbadcode('登陆成功!',15);
//                     end
//                     else
//                        result:=zdid+cmd +'01'+ fields.Fields[intFieldsIndex].AsString+',' + fields.fields[1].asstring ;
//                     //登录后显示欢迎光临
//                     WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid,hjksmc,'欢迎光临','',YHID,ZDYHMC,'','','',0,1,'','','');
//                     //写入准备信息.
//                     //if gblzbrs>0 then
//                     //   WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid,hjksmc,'','',YHID,ZDYHMC,'','','',0,1);
//                   end;
//                   isexsit:=true;
//                 end;
//          end;
//          if isexsit=false then
//          begin
////             if (cmd='30') or (cmd='60') then
////                result:=zdid + cmd +'未设置呼叫队列!请管理员设置'
////             else
////                result:=zdid + cmd + '048888';  //没有找到呼叫的科室
//             if (cmd='80') or (cmd='30') or (cmd='60') then
//             begin
//                 try
//                   adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
//                   ',zt='''''+
//                   ',state=''登录'''+
//                   ',ip='''',port=0 where zdid=' + zdid +
//                   ' and hszh=' + inttostr(gblhszh) ,cmdtext)
//                 except
//                   adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
//                   ',zt='''''+
//                   ',state=''登录'''+
//                   ',ip='''' where zdid=' + zdid +
//                   ' and hszh=' + inttostr(gblhszh) ,cmdtext)
//                 end;
//             end
//             else
//             begin
//                try
//                 adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
//                   ',ip='''+Aip+''''+',port='+inttostr(Aport)+
//                   ',zt='''''+
//                   ',state=''登录'''+
//                   ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
//                except
//                 adoconnection.Execute('update t_hjzd set yhid=''' + yhid +''''+
//                   ',ip='''+Aip+''''+
//                   ',zt='''''+
//                   ',state=''登录'''+
//                   ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
//                end;
//             end;
//             if cmd='80'  then
//                result:=zdid+cmd +'01'//6666'//+ yhid
//             else if (cmd='30') or (cmd='60') then
//             begin
//               result:=zdid + cmd +getstrwithnotbadcode('登陆成功!',15);
//             end
//             else
//                result:=zdid+cmd +'01'+ '无呼叫'+ttl_ks+',' + fields.fields[1].asstring ;
//             close;
//             //登录后显示欢迎光临
//             WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,'','','欢迎光临','',YHID,ZDYHMC,'','','',0,1,'','','');
//             //FreeAndNil(tmpquery);
//             SetYSXXItems(frmmain.lstvysxx,gblhszh);
//             exit;
//          end
//          else
//          begin
//            if gblCallWithGrpState=1 then ChangeFirstGrpState(YHID,1);
//            SetYSXXItems(frmmain.lstvysxx,gblhszh);
//          end;
          close;
          FreeAndNil(tmpquery);
{          //除了刚开机的时候，取号按照诊区管理软件的设置，
          //此后当用户登陆时，取号软件才能取号，当用户退出后，取号软件不能取号
          adoconnection.Execute('update t_yh set zcgh1=1 where yhid= '''+ yhid+ ''''+ ' and ksid1<>'''+''''+' and ksid1 is not null'+ ' and hszh=' + inttostr(gblhszh));
          adoconnection.Execute('update t_yh set zcgh2=1 where yhid= '''+ yhid+ ''''+ ' and ksid2<>'''+''''+' and ksid2 is not null'+ ' and hszh=' + inttostr(gblhszh));
          adoconnection.Execute('update t_yh set zcgh3=1 where yhid= '''+ yhid+ ''''+ ' and ksid3<>'''+''''+' and ksid3 is not null'+ ' and hszh=' + inttostr(gblhszh));
}
       end
       else
       begin
           if (cmd='30') or (cmd='60') then
           result:=zdid + cmd +'未设置此工员!  请管理员设置'
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           FreeAndNil(tmpquery);
           exit;
       end;
    end;

    if Length(hjksid)>0 then
    begin
      ////查找T_DHXX表中此科室的人数.
      ksbrdys := dmdbaccess.GetDBValue('KS',hjksid,'SelDoctor');
      if ksbrdys='' then ksbrdys:='0';
      if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
        qr.SQL.text:=' select count(*) as WaitNum from  ' +
                              ' t_DHXX ' +
                              ' where ksid=''' +  hjksid + '''' + ' and JZBZ<>0' +
                              ' and (yhid='''+yhid+''''+
                              ' or yhid='''' or yhid is null)'+
                              ' and hszh=' + inttostr(gblhszh)
      else
        qr.SQL.text:=' select count(*) as WaitNum from  ' +
                              ' t_DHXX ' +
                              ' where ksid=''' +  hjksid + '''' + ' and JZBZ<>0' +
                              ' and hszh=' + inttostr(gblhszh) ;
      qr.Open;
      ///////////将中.
      with qr do
      begin
         if not qr.Eof  then
           begin
             if (cmd='30') or (cmd='60') then
                result:=result+getstrwithnotbadcode(hjksmc,8)+'人数:'+fields.fields[0].asstring
             else if cmd<>'80' then
               result:=result +',' + fields.fields[0].asstring
             else if cmd='80' then
               result:=result + Format('%04d',[fields.fields[0].asinteger]);
           end;
         close;
      end;
    end;

  except
    begin
      if (cmd='30') or (cmd='60') then
      result :=zdid+cmd+'登录失败      !登录时有错误!'
      else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:YHLOgout;
                                           *
*函数机能:设置                                           *
*******************************************************************************}
function TdmDBAccess.YHLogout(const ZDID: string; const cmd:string): string;
var
    zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string;
    YJPIP:string;
    i:integer;
    hjksnum:integer;
    intFieldsIndex:integer;
    hjks:array[1..20] of CallGroup_Info;
//     hjksid:array [1..3] of string;
//     hjksmc:array [1..3] of string;
     qr,qr1 : TADOQuery;
    cmdstr:widestring;
    cmdstrks:widestring;
    jrid:string;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
     SetHJZDip(inttostr(strtoint(zdid)),'',0);
      result:='';
     if (cmd='31') then
        result:=zdid + cmd + '登出成功!      请登录工号'
     else
        result:=zdid + cmd + '01'+'000000';  //
        qr.Close;
        //在等待T_hjzd表中查找zdid.
        qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                                ' t_hjzd left outer join t_yh on ' +
                                ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                                ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
        qr.Open;
        ///////////将中.
        with qr do
        begin
           if not qr.Eof  then
           begin
              SetHJZDYHID(inttostr(strtoint(zdid)),'');
              zdyhid:=fields.fields[4].asstring ;
              zdyhmc:=fields.fields[5].asstring;
              fjh:=fields.Fields[1].AsString;
              fjmc:=fields.Fields[6].AsString;
              zth:=fields.Fields[2].AsString;
              ztmc:=fields.Fields[3].AsString;
              qr.close;
              qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
                        ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
                        ' FROM t_YH LEFT OUTER JOIN ' +
                        ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
                        ' LEFT OUTER JOIN  ' +
                        ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
                        ' LEFT OUTER JOIN  ' +
                        ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
                        ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
              qr.Open;

             //登出后显示暂停服务
                 if not qr.Eof  then
                 begin
                   GetYHCallKS(zdyhid,hjksnum,hjks);
                    if hjksnum>0 then
                    begin
                       try
                       qr1:= TADOQuery.Create(nil);
                       qr1.Connection := ADOConnection;
                       cmdstr:='';
                       cmdstrks:='';
                       i:=1;
                       for i:=1 to hjksnum do
                       begin
                          if length(cmdstrks)>0 then
                             cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
                          else
                             cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
                       end;
                       //查询出上一个呼叫病人。//
                       if Length(cmdstrks)>0 then
                          cmdstrks :='('+ cmdstrks+')';
                       cmdstr:=' select top 1 id,jzjssj,ztbz,yhlcs from' +
                               ' t_dhxx ' +
                               ' where (' + cmdstrks  +')' +
                               ' and t_dhxx.jzbz=0' +
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and t_dhxx.yhid=''' + zdyhid + ''''+
                               ' and t_dhxx.jzsj is not null ' +
                               ' order by t_dhxx.jzsj desc ';
                        qr1.SQL.Text := cmdstr;
                        qr1.Open ;
                        jrid:='';
                        if not qr1.Eof  then
                        begin
                            //将上一个呼叫病人的jzjssj改为当前时间//
                            jrid:=qr1.fields.Fields[0].AsString;
                            if qr1.fields.Fields[1].AsString='' then
                            begin
                              cmdstr:=' UPDATE t_dhxx '+
                                      ' SET jzjssj=getdate()' +
                                      ' where id=' + jrid ;
                              adoconnection.Execute(cmdstr ,cmdText);
                            end;
                            doUnLockOtherGroupSamePat(jrid);
                        end;
                        qr1.Close;
                        freeandnil(qr1);
                       except

                       end;
                   end;
                   if hjksnum>0 then
                   begin
                     WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[1].TGroupid,hjks[1].TGroupName,'停止服务','',ZDYHID,ZDYHMC,'','','',0,1,'','','');
                   end
                   else
                   begin
                     WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,'','','停止服务','',zdyhid,ZDYHMC,'','','',0,1,'','','');
                   end;
//                    hjksnum:=1;
//                    for intFieldsIndex:=2 to 7 do
//                    begin
//                        if intFieldsIndex mod 2 =0 then Continue ;
//                        if qr.fields.fields[intFieldsIndex].asstring<>''  then
//                           begin
//                             hjksid[hjksnum]:=qr.fields.Fields[intFieldsIndex-1].AsString;
//                             hjksmc[hjksnum]:=qr.fields.Fields[intFieldsIndex].AsString;
//                             hjksnum:=hjksnum+1;
//                           end;
//                    end;
//                    if hjksnum>1 then
//                     begin
//                       WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[1],hjksmc[1],'停止服务','',ZDYHID,ZDYHMC,'','','',0,1,'','','');
//                     end
//                     else
//                     begin
//                       WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,'','','停止服务','',zdyhid,ZDYHMC,'','','',0,1,'','','');
//                     end;
                     qr.close;
                     if gblCallWithGrpState=1 then ChangeFirstGrpState(zdyhid,0);
                 end
                 else
                 begin
                     Close;
                 end;
                if gblClearDoctorIDWhileLogout=1 then  //是否开启这个功能///
                begin
                  //修改t_dhxx表中准备并且选择这个医生的病人，修改此病人的选择医生为空
                  adoconnection.Execute('update t_dhxx set yhid='''''+
                          ' where yhid='+quotedstr(zdyhid)+
                          ' and jzbz=1'+
                          ' and ztbz=5' ,cmdtext);
                  adoconnection.Execute('update t_dhxx set yhid='''''+
                          ' where yhid='+quotedstr(zdyhid)+
                          ' and jzbz=1'+
                          ' and exists(select 1 from t_hjzd where zt=''暂停'''+
                          ' and zdid=' + zdid + ' and hszh=' + inttostr(gblhszh)+')'
                           ,cmdtext);
                end;
           end
           else
             begin
               if (cmd='31') then
               result:=zdid + cmd + '没有此呼叫器!  请管理员设置!'
               else
               result:=zdid + cmd + '038888';  ///没有此呼叫器
               close ;
               exit;
             end;
        end;
        //修改状态
        try
          adoconnection.Execute('update t_hjzd set yhid='+ ''''''+ ',ip='''''+
                           ',port=0'+
                           ',zt='''''+
                           ',state=''登出'''+
                           ',calltime=getdate() where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
        except
          adoconnection.Execute('update t_hjzd set yhid='+ ''''''+ ',ip='''''+
                           ',zt='''''+
                           ',state=''登出'''+
                           ',calltime=getdate() where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
        end;

      SetYSXXItems(frmmain.lstvysxx,gblhszh);
  except
    begin
      if (cmd='31') then
        result:=zdid + cmd + '登出失败!      登出时有错误!'
      else
        result := zdid + cmd + '000000';  //
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:YHCallNext;
                                           *
*函数机能:设置                                           *
*******************************************************************************}
(*
function TdmDBAccess.YHCallNext(const ZDID: string; const cmd:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
   hjksid:array[1..3] of string;
   hjksmc:array[1..3] of string ;
   callcount:array[1..3] of Integer;
   calledcount:array[1..3] of Integer;
   ksCallState:array[1..3] of integer;//0-科室无人,1-呼叫人数到,2-呼叫成功
   clearCalledCount:Boolean;
   i :integer;
   hjksnum:integer;
   cmdstr:widestring;
   cmdstrks:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc:string;
   zdzt,zdstate:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   tmpghhm:string;
   hjfs:integer;
   tmpksid:string;
   tmpksmc:string;
   hjrs:integer;//呼叫人数
   yhjrs:integer;//
   by6:string;
   lc:integer;
   qr:Tadoquery;
   ksbrdys:string;
   nextdelay:Integer;
   strCallnos,strCallnames,strby4:string;
   qr1 : TADOQuery;
   hjks:array [1..20] of CallGroup_Info;
begin
  qr1 := TADOQuery.Create(nil);
  try
    qr1.Connection := ADOConnection;
  try
    gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    qr1.Close;
    //在等待T_hjzd表中查找zdid.
    qr1.sql.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc,hjrs,zt,state'+
                            ',case when callnexttime is NULL then 999999 else '+
                            ' datediff(s,callnexttime,getdate()) end as nextdelay'+
                            ' from t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    try
      qr1.Open;
    except
      qr1.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc,hjrs,zt,state'+
                            ',999999 as nextdelay'+
                            ' from t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
      qr1.Open;
    end;
    ///////////将中.
    with qr1 do
    begin
       if not qr1.Eof  then
         begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          hjrs:=fields.Fields[7].AsInteger;
          zdzt:=fields.Fields[8].AsString;
          zdstate:=fields.Fields[9].AsString;
          nextdelay := fields.Fields[10].AsInteger;
           if ( zdyhid <>'')  then
           begin
             if nextdelay>=gblSHJG then
               close
             else
             begin
               if (cmd='32') or (cmd='67') then
                 result:=zdid+cmd + '顺呼太快  !    请稍候再试     '///没有登录.
               else
                 result:=zdid+cmd + '068888';///没有登录.
               close;
               exit;
             end;
           end
           else
             begin
             if (cmd='32') or (cmd='67') then
             result:=zdid+cmd + '还没有登录!    请登录工号     '///没有登录.
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
          end
       else
         begin
           if (cmd='32') or (cmd='67') then
             result:=zdid+cmd + '无此呼叫器!    请管理员设置!'///没有登录.
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
         end;
    end;
    yhjrs:=0;
    //在等待T_YH表中查找YHID信息.
    if gblCallWithGrpState=0 then
    begin
      qr1.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')';
    end
    else
    begin
      qr1.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' and table2.ztbz=0'+
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' and table3.ztbz=0'+
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')';
    end;
    qr1.Open;
    //////////.
    with qr1 do
    begin
       if not qr1.Eof  then
       begin
          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   callcount[hjksnum]:=StrToInt(GetDBValue(D001,zdyhid,'CallCount'+inttostr(hjksnum)));
//                   calledcount[hjksnum]:=StrToInt(GetDBValue(D001,zdyhid,'CalledCounts'+inttostr(hjksnum)));
//                   ksCallState[hjksnum]:=-1;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
//          if hjksnum=1 then
//           begin
//           if (cmd='32') or (cmd='67') then
//             result:=zdid+cmd + '未设置呼叫队列!请管理员设置!'
//           else
//             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
//             exit;
//           end;
           close;
           //add by wugang @20111028
           GetYHCallKS(zdyhid,hjksnum,hjks);
           if hjksnum=0 then
           begin
             if (cmd='32') or (cmd='67') then
               result:=zdid+cmd + '未设置呼叫队列!请管理员设置!'
             else
               result:=zdid + cmd + '048888';  //没有找到呼叫的科室
               exit;
           end;
           if hjksnum>0 then hjksnum:=hjksnum+1;
           ///////add end/////////////
       end
       else
       begin
           if (cmd='32') or (cmd='67') then
             result:=zdid+cmd + '未设置此工号!  请管理员设置!'
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    //修改呼叫终端状态
    try
      adoconnection.Execute('update t_hjzd set state=''顺呼'''+
        ',calltime=getdate(),callnexttime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
    except
      adoconnection.Execute('update t_hjzd set state=''顺呼'''+
        ',calltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
    end;
    ////查找T_DHXX表中此科室的病人.
    if hjksnum>1 then
    begin
       qr:= TADOQuery.Create(nil);
       qr.Connection := ADOConnection;

       cmdstr:='';
       cmdstrks:='';
       for i:=1 to hjksnum-1 do
       begin
          if length(cmdstrks)>0 then
             cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjksid[i] +''''
          else
             cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
       end;
       cmdstr:=' select top 1 id,jzjssj from' +
               ' t_dhxx ' +
               ' where (' + cmdstrks  +')' +
               ' and t_dhxx.jzbz=0' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.yhid=''' + zdyhid + ''''+
               ' and t_dhxx.jzsj is not null ' +
               ' order by t_dhxx.jzsj desc ';
        qr.SQL.Text := cmdstr;
        qr.Open ;
       if not qr.Eof  then
        begin
            //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
            jrid:=qr.fields.Fields[0].AsString;
            if qr.fields.Fields[1].AsString='' then
            begin
              cmdstr:=' UPDATE t_dhxx '+
                      ' SET jzjssj=getdate()' +
                      ' where id=' + jrid ;
              adoconnection.Execute(cmdstr ,cmdText);
            end;
        end;
        qr.Close;
        cmdstr:='';
        hjfs:=DB_GetHJFS(gblhszh,zdyhid);
       if hjfs=1 then
       begin
         for i:= 1 to hjksnum-1 do
         begin
           if (calledcount[i]>=callcount[i]) and (callcount[i]>0) then
           begin
              ksCallState[i]:=1;
              Continue;
           end
           else if (callcount[i]=0) or  (calledcount[i]<callcount[i]) then//不指定呼叫人数
           begin
             //查询此科室等候人数:
              if zdzt='暂停' then
              begin
                ksbrdys := dmdbaccess.GetDBValue('KS',hjksid[i],'SelDoctor');
                if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                //if gblBRDYS=1 then
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjksid[i] + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.ztbz=5'+
                           ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                else
                   begin
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjksid[i] + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.ztbz=5'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                   end   ;
              end
              else
              begin
                ksbrdys := dmdbaccess.GetDBValue('KS',hjksid[i],'SelDoctor');
                if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                //if gblBRDYS=1 then
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjksid[i] + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                else
                   begin
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjksid[i] + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                   end   ;
              end;
              qr.SQL.Text := cmdstr;
              qr.Open;
              with qr do
              begin
                  if qr.Eof then
                  begin
                    ksCallState[i]:=0;
                  end
                  else
                  begin
                    ksCallState[i]:=2;
                    while  not qr.Eof  do
                    begin
                        //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                        jrid:=fields.Fields[0].AsString;
                        kssxid:=fields.fields[1].asstring;
                        Brxm:=Fields.Fields[2].AsString;
                        GHHM:=fields.fields[3].asstring;
                        YXJID:=Fields.Fields[4].asString;
                        yxjmc:=fields.fields[5].asstring;
                        DDRs:=RecordCount-1;
                        brdm:=fields.fields[6].asstring;
                        by4:=fields.fields[7].asstring;
                        by6:=fields.fields[8].asstring;
                        tmpksid:=hjksid[i];
                        if cmd='82' then
                        begin
                           tmpghhm:=ghhm;
                           if length(tmpghhm)=0  then
                              tmpghhm:='0000'
                           else if length(tmpghhm)=1  then
                              tmpghhm:='000'+tmpghhm
                           else if length(tmpghhm)=2  then
                              tmpghhm:='00'+tmpghhm
                           else if length(tmpghhm)=3  then
                              tmpghhm:='0'+tmpghhm
                           else
                              tmpghhm:=RightStr(tmpghhm,4);//copy(tmpghhm,1,4);
                           result:=zdid +cmd  +'01' + tmpghhm  ;
                        end
                        else if (cmd='32') or (cmd='67') then
                        begin
        {                   tmpghhm:=ghhm;
                           if length(tmpghhm)=0  then
                              tmpghhm:='0000'
                           else if length(tmpghhm)=1  then
                              tmpghhm:='000'+tmpghhm
                           else if length(tmpghhm)=2  then
                              tmpghhm:='00'+tmpghhm
                           else if length(tmpghhm)=3  then
                              tmpghhm:='0'+tmpghhm
                           else
                              tmpghhm:=copy(tmpghhm,1,4);}
                           result:=zdid+cmd + getstrwithnotbadcode(hjksmc[i],8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                        end
                        else
                           result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjksid[i];
                        //并将数据放入显示信息表中
                        //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                        gbledit_ks[gbledit_ks_count].ksid:=hjksid[i];
                        gbledit_ks[gbledit_ks_count].ksmc:=hjksmc[i];
                        gbledit_ks_count:=gbledit_ks_count+1;
                        //修改其它病人的排队序号
                        cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                                ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
                                ' and ksid=''' +hjksid[i] + '''' +
                                ' and hszh=' + inttostr(gblHszh);
                        adoconnection.Execute(cmdstr ,cmdText);
                        //修改T_dhxx中的数据，将本条数据改为就诊
                        cmdstr:=' UPDATE t_dhxx SET JZBZ=0' +
                                ' ,yhid=''' + zdyhid + ''''+
                                ' ,ckhm='+fjh+
                                ' ,jzsj=getdate()' +
                                ' ,kssxid=0' +
                                ' where id=' + jrid ;
                        adoconnection.Execute(cmdstr ,cmdText);

                      //添加显示信息
                      ///delete by wugang @2010-03-16
                      //将多个号的信息合到一条显示信息记录中.
                      //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                      ///delete end ///
                      ///add by wugang @2010-03-16
                      //将多个号的信息合到一条显示信息记录中.
                      strCallnos := strCallnos+ghhm+'|';
                      strCallnames := strCallnames+brxm+'|';
                      strby4 := strby4+by4+'|';
                      ///add end ///
                      iscall:=true;
                      yhjrs:=yhjrs+1;
                      if yhjrs=hjrs then
                      begin
                         //add by wugang @2010-03-16
                         //在呼叫人数到时将信息保存到显示信息表中.
                         WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                         ///add end///
                         break;
                      end
                      else
                      begin
                         qr.Next;
                         //add by wugang @2010-03-16
                         //在呼叫人数到时将信息保存到显示信息表中.
                         if qr.Eof then
                         begin
                            WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                         end;
                         ///add end ///
                      end;

                    end;
                  end;
                  close;
              end;//end with
              if ksCallState[i]=0 then
                 Continue
              else
              begin
                 //修改此员工此呼叫科室的呼叫人数;
                 cmdstr :=' update t_yh set CalledCounts'+inttostr(i)+'=CalledCounts'+inttostr(i)+'+1'+
                          ' where yhid='''+ZDYHID+''''+
                          ' and hszh='+inttostr(gblhszh);
                 qr.SQL.Text := cmdstr;
                 try
                   qr.ExecSQL;
                   calledcount[i]:= calledcount[i]+1;
                 except

                 end;
                 Break;
              end;
           end;
         end;
         if  not iscall then
         begin
           for i:=1 to hjksnum-1 do
           begin
             if ksCallState[i]=1 then
             begin
              if zdzt='暂停' then
              begin
                ksbrdys := dmdbaccess.GetDBValue('KS',hjksid[i],'SelDoctor');
                if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                //if gblBRDYS=1 then
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjksid[i] + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.ztbz=5'+
                           ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                else
                   begin
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjksid[i] + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.ztbz=5'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                   end   ;
              end
              else
              begin
                ksbrdys := dmdbaccess.GetDBValue('KS',hjksid[i],'SelDoctor');
                if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                //if gblBRDYS=1 then
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjksid[i] + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                else
                   begin
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjksid[i] + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                   end   ;
              end;
              qr.SQL.Text := cmdstr;
              qr.Open;
              ///////////将中.
              with qr do
              begin
                 while  not qr.Eof  do
                  begin
                      //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                      jrid:=fields.Fields[0].AsString;
                      kssxid:=fields.fields[1].asstring;
                      Brxm:=Fields.Fields[2].AsString;
                      GHHM:=fields.fields[3].asstring;
                      YXJID:=Fields.Fields[4].asString;
                      yxjmc:=fields.fields[5].asstring;
                      DDRs:=RecordCount-1;
                      brdm:=fields.fields[6].asstring;
                      by4:=fields.fields[7].asstring;
                      by6:=fields.fields[8].asstring;
                      tmpksid :=hjksid[i];
                      if cmd='82' then
                      begin
                         tmpghhm:=ghhm;
                         if length(tmpghhm)=0  then
                            tmpghhm:='0000'
                         else if length(tmpghhm)=1  then
                            tmpghhm:='000'+tmpghhm
                         else if length(tmpghhm)=2  then
                            tmpghhm:='00'+tmpghhm
                         else if length(tmpghhm)=3  then
                            tmpghhm:='0'+tmpghhm
                         else
                            tmpghhm:=RightStr(tmpghhm,4);
                         result:=zdid +cmd  +'01' + tmpghhm  ;
                      end
                      else if (cmd='32') or (cmd='67') then
                      begin
      {                   tmpghhm:=ghhm;
                         if length(tmpghhm)=0  then
                            tmpghhm:='0000'
                         else if length(tmpghhm)=1  then
                            tmpghhm:='000'+tmpghhm
                         else if length(tmpghhm)=2  then
                            tmpghhm:='00'+tmpghhm
                         else if length(tmpghhm)=3  then
                            tmpghhm:='0'+tmpghhm
                         else
                            tmpghhm:=copy(tmpghhm,1,4);}
                         result:=zdid+cmd + getstrwithnotbadcode(hjksmc[i],8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                      end
                      else
                         result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjksid[i];
                      //并将数据放入显示信息表中
                      //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                      gbledit_ks[gbledit_ks_count].ksid:=hjksid[i];
                      gbledit_ks[gbledit_ks_count].ksmc:=hjksmc[i];
                      gbledit_ks_count:=gbledit_ks_count+1;
                      //修改其它病人的排队序号
                      cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                              ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
                              ' and ksid=''' +hjksid[i] + '''' +
                              ' and hszh=' + inttostr(gblHszh);
                      adoconnection.Execute(cmdstr ,cmdText);
                      //修改T_dhxx中的数据，将本条数据改为就诊
                      cmdstr:=' UPDATE t_dhxx SET JZBZ=0' +
                              ' ,yhid=''' + zdyhid + ''''+
                              ' ,ckhm='+fjh+
                              ' ,jzsj=getdate()' +
                              ' ,kssxid=0' +
                              ' where id=' + jrid ;
                      adoconnection.Execute(cmdstr ,cmdText);


                      //添加显示信息
                      ///delete by wugang @2010-03-16
                      //将多个号的信息合到一条显示信息记录中.
                      //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                      ///delete end ///
                      ///add by wugang @2010-03-16
                      //将多个号的信息合到一条显示信息记录中.
                      strCallnos := strCallnos+ghhm+'|';
                      strCallnames := strCallnames+brxm+'|';
                      strby4 := strby4+by4+'|';
                      ///add end ///
                      iscall:=true;
                      yhjrs:=yhjrs+1;
                      if yhjrs=hjrs then
                      begin
                         //add by wugang @2010-03-16
                         //在呼叫人数到时将信息保存到显示信息表中.
                         WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                         ///add end///
                         break;
                      end
                      else
                      begin
                         qr.Next;
                         //add by wugang @2010-03-16
                         //在呼叫人数到时将信息保存到显示信息表中.
                         if qr.Eof then
                         begin
                            WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                         end;
                         ///add end ///
                      end;
                  end;
                  close;
              end;//end with
              if iscall then
              begin
                 //修改此员工此呼叫科室的呼叫人数;
                 cmdstr :=' update t_yh set CalledCounts'+inttostr(i)+'=CalledCounts'+inttostr(i)+'+1'+
                          ' where yhid='''+ZDYHID+''''+
                          ' and hszh='+inttostr(gblhszh);
                 qr.SQL.Text := cmdstr;
                 try
                   qr.ExecSQL;
                   calledcount[i]:= calledcount[i]+1;
                 except
                 end;
                 break;
              end;
             end;
           end; //end for
         end;
         if iscall then
         begin
           clearCalledCount:=True;
           for i:=1 to hjksnum-1 do//查询是否要清除呼叫人数
           begin
             if  (calledcount[i]<callcount[i]) and (callcount[i]>0) then
             begin
               clearCalledCount:=False;
               Break;
             end
             else
             begin
               clearCalledCount:=true;
             end;
           end;

           if clearCalledCount then//将员工的呼叫人数清0
           begin
             cmdstr :=' update t_yh set calledcounts1=0,calledcounts2=0,'+
                  ' calledcounts3=0 '+
                  ' where yhid='''+zdyhid+''''+
                  ' and hszh='+inttostr(gblHSZH);
             qr.SQL.Text :=cmdstr;
             try
               qr.ExecSQL;
             except
             end;
           end;
         end;
       end
       else if hjfs=2 then
       begin
           cmdstrks:='';
           for i:=1 to hjksnum-1 do
           begin
              if length(cmdstrks)>0 then
                 cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjksid[i] +''''
              else
                 cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
           end;
          ksbrdys := dmdbaccess.GetDBValue('KS',hjksid[1],'SelDoctor');
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
//          if gblBRDYS=1 then
             cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,ksid from  ' +
                     ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' where (' +cmdstrks+')'+
                     ' and t_dhxx.jzbz=1' +
                     ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                     ' order by replicate(''0'',10-len(ghhm))+ghhm,kssxid '
          else
             begin
             cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,ksid from  ' +
                     ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' where ('+cmdstrks+')'+
                     ' and t_dhxx.jzbz=1' +
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                     ' order by replicate(''0'',10-len(ghhm))+ghhm,kssxid '
             end   ;
          qr.SQL.Text := cmdstr;
          qr.Open;

          ///////////将中.
          with qr do
          begin
             while not qr.Eof  do
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  GHHM:=fields.fields[3].asstring;
                  YXJID:=Fields.Fields[4].asString;
                  yxjmc:=fields.fields[5].asstring;
                  DDRs:=RecordCount-1;
                  brdm:=fields.fields[6].asstring;
                  by4:=fields.fields[7].asstring;
                  tmpksid:=fields.fields[8].asstring;
                  for i:=1 to hjksnum do
                  begin
                     if tmpksid=hjksid[i] then
                        tmpksmc:=hjksmc[i];
                  end;
                  if cmd='82' then
                  begin
                     tmpghhm:=ghhm;
                     if length(tmpghhm)=0  then
                        tmpghhm:='0000'
                     else if length(tmpghhm)=1  then
                        tmpghhm:='000'+tmpghhm
                     else if length(tmpghhm)=2  then
                        tmpghhm:='00'+tmpghhm
                     else if length(tmpghhm)=3  then
                        tmpghhm:='0'+tmpghhm
                     else
                        tmpghhm:=RightStr(tmpghhm,4);
                     result:=zdid +cmd  +'01' + tmpghhm  ;
                  end
                  else if (cmd='32') or (cmd='67') then
                  begin
  {                   tmpghhm:=ghhm;
                     if length(tmpghhm)=0  then
                        tmpghhm:='0000'
                     else if length(tmpghhm)=1  then
                        tmpghhm:='000'+tmpghhm
                     else if length(tmpghhm)=2  then
                        tmpghhm:='00'+tmpghhm
                     else if length(tmpghhm)=3  then
                        tmpghhm:='0'+tmpghhm
                     else
                        tmpghhm:=copy(tmpghhm,1,4);}
                     result:=zdid+cmd + getstrwithnotbadcode(tmpksmc[i],8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                  end
                  else
                     result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+tmpksid;
                  //并将数据放入显示信息表中
                  //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                  gbledit_ks[gbledit_ks_count].ksid:=tmpksid;
                  gbledit_ks[gbledit_ks_count].ksmc:=tmpksmc;
                  gbledit_ks_count:=gbledit_ks_count+1;


                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                          ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
                          ' and ksid=''' +tmpksid + '''' +
                          ' and hszh=' + inttostr(gblHszh);
                  adoconnection.Execute(cmdstr ,cmdText);
                  //修改T_dhxx中的数据，将本条数据改为就诊
                  cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
                          ' ,yhid=''' + zdyhid + ''''+
                          ' ,ckhm='+fjh+
                          ' ,jzsj=getdate()' +
                          ' ,kssxid=0' +
                          ' where id=' + jrid ;
                  adoconnection.Execute(cmdstr ,cmdText);
                 { //添加显示信息
                  WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,'',DDRS,1);
                  iscall:=true;
                  yhjrs:=yhjrs+1;
                  if yhjrs=hjrs then
                     break
                  else
                     qr.Next;
                     }
                  //添加显示信息
                  ///delete by wugang @2010-03-16
                  //将多个号的信息合到一条显示信息记录中.
                  //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,'',DDRS,1);
                  ///delete end ///
                  ///add by wugang @2010-03-16
                  //将多个号的信息合到一条显示信息记录中.
                  strCallnos := strCallnos+ghhm+'|';
                  strCallnames := strCallnames+brxm+'|';
                  strby4:=strby4+by4+'|';
                  ///add end ///
                  iscall:=true;
                  yhjrs:=yhjrs+1;
                  if yhjrs=hjrs then
                  begin
                     //add by wugang @2010-03-16
                     //在呼叫人数到时将信息保存到显示信息表中.
                     WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                     ///add end///
                     break;
                  end
                  else
                  begin
                     qr.Next;
                     //add by wugang @2010-03-16
                     //在呼叫人数到时将信息保存到显示信息表中.
                     if qr.Eof then
                     begin
                        WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                     end;
                     ///add end ///
                  end;
              end;
              close;
            end;
       end
       else if hjfs=3 then
       begin
           cmdstrks:='';
           for i:=1 to hjksnum-1 do
           begin
              if length(cmdstrks)>0 then
                 cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjksid[i] +''''
              else
                 cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
           end;
          ksbrdys := dmdbaccess.GetDBValue('KS',hjksid[1],'SelDoctor');
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          //if gblBRDYS=1 then
             cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,ksid from  ' +
                     ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' where (' +cmdstrks+')'+
                     ' and t_dhxx.jzbz=1' +
                     ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                     ' order by ghsj,kssxid '
          else
             begin
             cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,ksid from  ' +
                     ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' where ('+cmdstrks+')'+
                     ' and t_dhxx.jzbz=1' +
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                     ' order by ghsj,kssxid '
             end   ;
          qr.SQL.Text := cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
             while not qr.Eof  do
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  GHHM:=fields.fields[3].asstring;
                  YXJID:=Fields.Fields[4].asString;
                  yxjmc:=fields.fields[5].asstring;
                  DDRs:=RecordCount-1;
                  brdm:=fields.fields[6].asstring;
                  by4:=fields.fields[7].asstring;
                  tmpksid:=fields.fields[8].asstring;
                  for i:=1 to hjksnum do
                  begin
                     if tmpksid=hjksid[i] then
                        tmpksmc:=hjksmc[i];
                  end;
                  if cmd='82' then
                  begin
                     tmpghhm:=ghhm;
                     if length(tmpghhm)=0  then
                        tmpghhm:='0000'
                     else if length(tmpghhm)=1  then
                        tmpghhm:='000'+tmpghhm
                     else if length(tmpghhm)=2  then
                        tmpghhm:='00'+tmpghhm
                     else if length(tmpghhm)=3  then
                        tmpghhm:='0'+tmpghhm
                     else
                        tmpghhm:=RightStr(tmpghhm,4);
                     result:=zdid +cmd  +'01' + tmpghhm  ;
                  end
                  else if (cmd='32') or (cmd='67') then
                  begin
  {                   tmpghhm:=ghhm;
                     if length(tmpghhm)=0  then
                        tmpghhm:='0000'
                     else if length(tmpghhm)=1  then
                        tmpghhm:='000'+tmpghhm
                     else if length(tmpghhm)=2  then
                        tmpghhm:='00'+tmpghhm
                     else if length(tmpghhm)=3  then
                        tmpghhm:='0'+tmpghhm
                     else
                        tmpghhm:=copy(tmpghhm,1,4);}
                     result:=zdid+cmd + getstrwithnotbadcode(tmpksmc[i],8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                  end
                  else
                     result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+tmpksid;
                  //并将数据放入显示信息表中
                  //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                  gbledit_ks[gbledit_ks_count].ksid:=tmpksid;
                  gbledit_ks[gbledit_ks_count].ksmc:=tmpksmc;
                  gbledit_ks_count:=gbledit_ks_count+1;


                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                          ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
                          ' and ksid=''' +tmpksid + '''' +
                          ' and hszh=' + inttostr(gblHszh);
                  adoconnection.Execute(cmdstr ,cmdText);
                  //修改T_dhxx中的数据，将本条数据改为就诊
                  cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
                          ' ,yhid=''' + zdyhid + ''''+
                          ' ,ckhm='+fjh+
                          ' ,jzsj=getdate()' +
                          ' ,kssxid=0' +
                          ' where id=' + jrid ;
                  adoconnection.Execute(cmdstr ,cmdText);
                  //添加显示信息
                  ///delete by wugang @2010-03-16
                  //将多个号的信息合到一条显示信息记录中.
                  //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                  ///delete end ///
                  ///add by wugang @2010-03-16
                  //将多个号的信息合到一条显示信息记录中.
                  strCallnos := strCallnos+ghhm+'|';
                  strCallnames := strCallnames+brxm+'|';
                  strby4 := strby4+by4+'|';
                  ///add end ///
                  iscall:=true;
                  yhjrs:=yhjrs+1;
                  if yhjrs=hjrs then
                  begin
                     //add by wugang @2010-03-16
                     //在呼叫人数到时将信息保存到显示信息表中.
                     WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                     ///add end///
                     break;
                  end
                  else
                  begin
                     qr.Next;
                     //add by wugang @2010-03-16
                     //在呼叫人数到时将信息保存到显示信息表中.
                     if qr.Eof then
                     begin
                        WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                     end;
                     ///add end ///
                  end;
              end;
              close;
            end;
       end;
       qr.Close;
       Freeandnil(qr);
     end;
       if iscall=false  then
          begin
            //写入此时此呼叫器空闲???
            // add by wugang @2010-07-20
            //修改呼叫终端状态
            try
              adoconnection.Execute('update t_hjzd set state=''空闲'''+
                ',calltime=getdate()'+
                ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
            except
              adoconnection.Execute('update t_hjzd set state=''空闲'''+
                ',calltime=getdate()'+
                ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
            end;
            /////////////////////////
            ///////add end////////
            if (cmd='32') or (cmd='67') then
            result:=zdid +cmd  +'等待人数:0     '+''
            else
            result:=zdid +cmd  +'000000'  ;
          end
          else
          begin
            //查看流程是否自动流转;
            qr1.SQL.Text :='select lc from t_dhxx where id='+jrid;
            qr1.Open;
            if not qr1.Eof then
            begin
              lc := qr1.fieldbyname('lc').AsInteger;
              if lc<>0 then
              begin
                qr1.Close;
                qr1.SQL.Text :=' select top 1 lcfs  from t_lcxx'+
                     ' where lcid='+inttostr(lc)+
                     ' and lcxh>(select lcxh from t_lcxx'+
                      ' where lcid='+inttostr(lc)+' and ksid='+quotedstr(tmpksid)+')'+
                     ' order by lcxh';
                qr1.Open;
                if not qr1.Eof then
                begin
                  if (qr1.FieldByName('lcfs').AsInteger=0) then  //自动
                  begin
                    if (cmd='32') or (cmd='67') then
                      YHMoveToNext(zdid,'45','')
                    else
                      YHMoveToNext(zdid,'95','');
                  end;
                end;
                qr1.Close;
              end;
            end;
            qr1.Close;
          end;


  except
    begin
       if (cmd='32') or (cmd='67') then
            result:=zdid +cmd  +'呼叫失败!      '+'呼叫时有错误!'
      else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    freeandnil(qr1);
  end;
end;
*)
{*******************************************************************************
*函数名:YHCallNext_ks;
                                           *
*函数机能:按科室呼叫病人                                           *
*******************************************************************************}
function TdmDBAccess.YHCallNext_ks(const KsID: string;const ACount:integer): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
//   i :integer;
//   hjksnum:integer;
//   hjks:array[1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc:string;
   DDRS:integer;
   iscall :boolean;
   ksmc:string;
   icallNum:integer;
   qrtmp:Tadoquery;
   by6,by4:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
    //gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT ksid,ksmc from t_ks '+
              ' WHERE (ksid = ''' + ksid +''''+ ') AND (HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    if qr.RecordCount>0 then
       ksmc:=qr.fields.Fields[1].AsString;

    qr.Close;
    ////查找T_DHXX表中此科室的病人.
     cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,by6,by4 from  ' +
             ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
             ' where t_dhxx.ksid=''' + ksid + '''' +
             ' and t_dhxx.jzbz=1' +
             ' and t_dhxx.hszh=' +inttostr(gblhszh) +
             ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm ';
    qr.SQL.Text:=cmdstr;
    qr.Open;
    qrtmp:=Tadoquery.Create(nil);
    qrtmp.Connection:=adoconnection;
    //////////
    with qr do
    begin
       icallNum:=1;
       while (not qr.eof) do
       begin
            //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
            jrid:=fields.Fields[0].AsString;
            qrtmp.SQL.Text:='Select kssxid from t_dhxx where id='+jrid;
            qrtmp.Open;
            if not qrtmp.Eof then
               kssxid:=qrtmp.fieldbyname('kssxid').asstring
            else
               kssxid:=fields.Fields[1].AsString;
            qrtmp.Close;
            Brxm:=Fields.Fields[2].AsString;
            GHHM:=fields.fields[3].asstring;
            YXJID:=Fields.Fields[4].asString;
            yxjmc:=fields.fields[5].asstring;
            by6:= fields.fields[6].asstring;
            by4 :=fields.fields[7].asstring+'|';
            DDRs:=RecordCount-1;
            //并将数据放入显示信息表中
            //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
            gbledit_ks[gbledit_ks_count].ksid:=ksid;
            gbledit_ks[gbledit_ks_count].ksmc:=ksmc;
            gbledit_ks_count:=gbledit_ks_count+1;
            fjh:='0';


//            cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                    ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
//                    ' and ksid=''' +ksid + '''' +
//                    ' and hszh=' + inttostr(gblHszh);
//            adoconnection.Execute(cmdstr ,cmdText);
//            //将这个科室已呼叫过的病人的kssxid-1
//            cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                    ' where jzbz=0'+
//                    ' and ksid=''' +ksid + '''' +
//                    ' and hszh=' + inttostr(gblHszh);
//            adoconnection.Execute(cmdstr ,cmdText);
//
//            //修改T_dhxx中的数据，将本条数据改为就诊
//            cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
//                    ' ,yhid='''''+
//                    ' ,ckhm='+fjh+
//                    ' ,jzsj=getdate()' +
//                    ' ,kssxid=0' +
//                    ' where id=' + jrid ;
//            adoconnection.Execute(cmdstr ,cmdText);
            doUpdatewaitlistpos(ksid,jrid,'',fjh,gblhszh);
            //添加显示信息
            WriteDispMsg('0','0','','0','',ksid,ksmc,GHHM,BRxm,'','',YXJID,YXJMC,by6,DDRS,1,'','',by4);
            iscall:=true;
            if icallNum=Acount then break;
            icallNum:=icallNum+1;
            qr.next;
       end;//end of        while (not qr.eof) do
        FreeAndNil(qrtmp);
        close;
    end;
    if iscall then
       result:='ok'
    else
       result:='';
  except
    begin
      result := ' ';//zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;

{*******************************************************************************
*函数名:YHSeleCall_ks;
                                           *
*函数机能:按科室呼叫病人                                           *
*******************************************************************************}
function TdmDBAccess.YHSeleCall_ks(const KsID: string;const Ghhm:string;const AFJH:string): boolean;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   i :integer;
//   hjksnum:integer;
   cmdstr:widestring;
   tmpkssxid,tmpJRID,tmpGHHM,tmpBRXM,tmpYXJID,tmpyxjmc:string;
   DDRS:integer;
   iscall :boolean;
   ksmc:string;
   by6,by4:string;
   qr,tmpqr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
    //gbledit_ks_count:=0;
//    result:='';
    iscall:=false;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT ksid,ksmc from t_ks '+
              ' WHERE (ksid = ''' + ksid +''''+ ') AND (HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    if qr.RecordCount>0 then
       ksmc:=qr.fields.Fields[1].AsString;

    qr.Close;
    ////查找T_DHXX表中此科室的病人.
     cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,by6,by4 from  ' +
             ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
             ' where t_dhxx.ksid=''' + ksid + '''' +
             ' and t_dhxx.ghhm='''+ghhm+''''+
             ' and t_dhxx.jzbz=1' +
             ' and t_dhxx.hszh=' +inttostr(gblhszh) +
             ' order by t_dhxx.kssxid ';
    qr.SQL.Text:=cmdstr;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
        begin
            //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
            tmpjrid:=fields.Fields[0].AsString;
            tmpkssxid:=fields.fields[1].asstring;
            tmpBrxm:=Fields.Fields[2].AsString;
            tmpGHHM:=fields.fields[3].asstring;
            tmpYXJID:=Fields.Fields[4].asString;
            tmpyxjmc:=fields.fields[5].asstring;
            by6:=fields.Fields[6].AsString;
            by4:=fields.Fields[7].AsString+'|';
            DDRs:=RecordCount-1;
            //并将数据放入显示信息表中
            //WriteDispMsgWriteDispMsg(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
            gbledit_ks[gbledit_ks_count].ksid:=ksid;
            gbledit_ks[gbledit_ks_count].ksmc:=ksmc;
            gbledit_ks_count:=gbledit_ks_count+1;
            if isint(AFJH) then
            begin
               fjh:=AFJH;
               zth :='0';
            end
            else
            begin
               fjh:='0';
               zth :='0';
            end;

//            cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                    ' where kssxid >(select kssxid from t_dhxx where id=' + tmpjrid +')'+
//                    ' and ksid=''' +ksid + '''' +
//                    ' and hszh=' + inttostr(gblHszh);
//            adoconnection.Execute(cmdstr ,cmdText);
//            //将这个科室已呼叫过的病人的kssxid-1
//            cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                    ' where jzbz=0'+
//                    ' and ksid=''' +ksid + '''' +
//                    ' and hszh=' + inttostr(gblHszh);
//            adoconnection.Execute(cmdstr ,cmdText);
//            //修改T_dhxx中的数据，将本条数据改为就诊
//            cmdstr:=' UPDATE t_dhxx SET JZBZ=0' +
//                    ' ,yhid='''''+
//                    ' ,jzsj=getdate()' +
//                    ' ,kssxid=0' +
//                    ' where id=' + tmpjrid ;
//            adoconnection.Execute(cmdstr ,cmdText);
            doUpdatewaitlistpos(ksid,tmpjrid,'',fjh,gblhszh);

            tmpqr:= TADOQuery.Create(nil);
            tmpqr.Connection := ADOConnection;
            tmpqr.SQL.Text := 'select fjmc,zth,ztmc from t_hjzd where fjh='+Afjh+
              ' and hszh='+inttostr(gblHSZH);
            try
              tmpqr.Open;
              if not tmpqr.Eof then
              begin
              fjmc := tmpqr.fieldbyname('fjmc').asstring;
              zth :=  tmpqr.fieldbyname('zth').asstring;
              ztmc := tmpqr.fieldbyname('ztmc').asstring;
              end;
              tmpqr.Close;
            finally
              FreeAndNil(tmpqr);
            end;
            //showmessage(fjh);
            //添加显示信息
            WriteDispMsg('0',fjh,fjmc,zth,ztmc,ksid,ksmc,tmpGHHM,tmpBRxm,'','',tmpYXJID,tmpYXJMC,by6,DDRS,1,'','',by4);
            iscall:=true;
        end;
        close;
    end;
    if iscall then
       result:=true
    else
       result:=false;
  except
    begin
      result := false;//zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;

{*******************************************************************************
*函数名:YHReCall;
                                           *
*函数机能:复呼                                          *
*******************************************************************************}
function TdmDBAccess.YHReCall(const ZDID: string; const cmd:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks :array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   cmdstrks:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   tmpghhm:string;
   by6,by3:string;
   ksbrdys:string;
   nextdelay:integer;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection :=ADOConnection;
  try
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc'+
                            ',case when recalltime is NULL then 999999 else '+
                            ' datediff(s,recalltime,getdate()) end as nextdelay'+
                            ' from t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    try
      qr.Open;
    except
      qr.sql.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc'+
                            ',999999 as nextdelay'+
                            ' from t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;

      qr.Open;
    end;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
         begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          nextdelay :=fields.Fields[7].AsInteger;
          if ( zdyhid <>'')  then
             begin
               if nextdelay>=gblFHJG  then
                 close
               else
               begin
                 if (cmd='33') or (cmd='66') then
                 result:=zdid+cmd + '复呼太快  !    请稍候再试'
                 else
                 result:=zdid+cmd + '068888';///没有登录.
                 close;
                 exit;
               end;
             end
          else
             begin
             if (cmd='33') or (cmd='66') then
             result:=zdid+cmd + '还没有登录!    请登录工号'
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
          end
       else
         begin
           if (cmd='33') or (cmd='66') then
           result:=zdid+cmd + '无此呼叫器!    请管理员设置!'
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
         end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//            if intFieldsIndex mod 2 =0 then Continue ;
//            if fields.fields[intFieldsIndex].asstring<>''  then
//            begin
//              hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//              hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//              hjksnum:=hjksnum+1;
//            end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             if (cmd='33') or (cmd='66') then
             result:=zdid+cmd + '未设置呼叫队列!请管理员设置!'
             else
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           if (cmd='33') or (cmd='66') then
           result:=zdid+cmd + '未设置此工号!  请管理员设置!'
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    //修改呼叫终端状态
    try
      adoconnection.Execute('update t_hjzd set state=''复呼'''+
        ',calltime=getdate(),recalltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
    except
      adoconnection.Execute('update t_hjzd set state=''复呼'''+
        ',calltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
    end;
    ////查找T_DHXX表中此科室的病人.
    if hjksnum>0 then
    begin
       cmdstr:='';
       cmdstrks:='';
       for i:=1 to hjksnum do
       begin
          if length(cmdstrks)>0 then
             cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
          else
             cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
       end;
       if Length(cmdstrks)>0 then
          cmdstrks :='('+ cmdstrks+')';
       ksbrdys := dmdbaccess.GetDBValue('KS',hjks[1].TGroupid,'SelDoctor');
       if ksbrdys='' then ksbrdys:='0';
       if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
       //if gblBRDYS= 1 then
       begin
         cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where (' + cmdstrks  +')' +
               ' and (t_dhxx.yhid='''+zdyhid+''''+
               ' or t_dhxx.yhid='''' or t_dhxx.yhid is null)'+
               ' and t_dhxx.jzbz<>0' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh) ;
       end
       else
       begin
         cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where (' + cmdstrks  +')' +
               ' and t_dhxx.jzbz<>0' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh) ;
       end;
        qr.SQL.Text:=cmdstr;
        qr.Open;
        ddrs:=qr.RecordCount;
        qr.Close ;

       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,brdm,by4,by6,by3 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where (' + cmdstrks  +')' +
               ' and t_dhxx.jzbz=0' +
               ' and t_dhxx.ztbz<>7 '+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.yhid=''' + zdyhid + ''''+
               ' and t_dhxx.jzsj is not null ' +
               ' order by t_dhxx.jzsj desc ';
        qr.SQL.Text:=cmdstr;
        qr.Open;
        ///////////将中.
        with qr do
        begin
           if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                for i:=1 to hjksnum do
                begin
                    if hjks[i].TGroupid= fields.Fields[6].AsString then
                       break;
                end;
                brdm:=fields.Fields[7].AsString;
                by4:=fields.Fields[8].AsString;
                by6:=fields.Fields[9].AsString;
                by3:=fields.Fields[10].AsString;
               // DDRs:=RecordCount;
                if cmd='83' then
                begin
                   tmpghhm:=ghhm;
                   if length(tmpghhm)=0  then
                      tmpghhm:='0000'
                   else if length(tmpghhm)=1  then
                      tmpghhm:='000'+tmpghhm
                   else if length(tmpghhm)=2  then
                      tmpghhm:='00'+tmpghhm
                   else if length(tmpghhm)=3  then
                      tmpghhm:='0'+tmpghhm
                   else
                      tmpghhm:=RightStr(tmpghhm,4);
                   result:=zdid +cmd  +'01' + tmpghhm;
                end
                else if (cmd='33') or (cmd='66') then
                begin
                   result:=zdid+cmd + getstrwithnotbadcode(hjks[i].TGroupName,8)+'人数'+getstrwithnotbadcode(inttostr(ddrs),3)+
                           getstrwithnotbadcode(brxm,8)+ '  '+ getstrwithnotbadcode(ghhm,5);
                end
                else
                  result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid;
                   //result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid+','+by3;
                //并将数据放入显示信息表中
                //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,'','',by4+'|');
                //修改T_dhxx中的数据，将本条数据改为就诊
                cmdstr:=' UPDATE t_dhxx SET yhid=''' + zdyhid + ''''+
                        ' ,ckhm='+fjh+
                        //' ,jzsj=getdate()' +
                        ' where id=' + jrid ;
                adoconnection.Execute(cmdstr ,cmdText);
                iscall:=true;
            end;
            close;
        end;
       end;
       if iscall=false  then
          begin
            if (cmd='33') or (cmd='66') then
            result:=zdid +cmd  +'重呼失败!      '+''
            else
            result:=zdid +cmd  +'000000'  ;
          end;


  except
    begin
      if (cmd='33') or (cmd='66') then
      result:=zdid +cmd  +'重呼失败!      '+'重呼时有错误!'
      else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHEnterCall;
                                           *
*函数机能:完成                                         *
*******************************************************************************}
function TdmDBAccess.YHEnterCall(const ZDID: string; const cmd:string; const callno:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array[1..20] of CallGroup_Info;
   cmdstr:widestring;
   cmdstrks:widestring;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   tmpghhm:string;
   by6:string;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   retstr:string;
   tmpadoquery:Tadoquery;
   ksbrdys:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  if callno='' then
  begin
    try
      result:='';
      iscall:=false;
      //在等待T_hjzd表中查找zdid.
      qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                              ' t_hjzd left outer join t_yh on ' +
                              ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                              ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
      qr.Open;
      ///////////将中.
      with qr do
      begin
         if not qr.Eof  then
           begin
            zdyhid:=fields.fields[4].asstring ;
            zdyhmc:=fields.fields[5].asstring;
            fjh:=fields.Fields[1].AsString;
            fjmc:=fields.Fields[6].AsString;
            zth:=fields.Fields[2].AsString;
            ztmc:=fields.Fields[3].AsString;
            if ( zdyhid <>'')  then
               begin
               close;
               end
            else
               begin
               if (cmd='33') or (cmd='66') then
               result:=zdid+cmd + '还没有登录!    请登录工号'
               else
               result:=zdid+cmd + '028888';///没有登录.
               close;
               exit;
               end;
            end
         else
           begin
             if (cmd='33') or (cmd='66') then
             result:=zdid+cmd + '无此呼叫器!    请管理员设置!'
             else
             result:=zdid + cmd + '038888';  ///没有此呼叫器
             close ;
             exit;
           end;
      end;
      //在等待T_YH表中查找YHID信息.
      qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
                ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
                ' FROM t_YH LEFT OUTER JOIN ' +
                ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
                ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
      qr.Open;
      ///////////将中.
      with qr do
      begin
         if not qr.Eof  then
         begin
//            hjksnum:=1;
//            for intFieldsIndex:=2 to 7 do
//            begin
//                if intFieldsIndex mod 2 =0 then Continue ;
//                if fields.fields[intFieldsIndex].asstring<>''  then
//                   begin
//                     hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                     hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                     hjksnum:=hjksnum+1;
//                   end;
//            end;
            GetYHCallKS(zdyhid,hjksnum,hjks);
            if hjksnum=0 then
             begin
               if (cmd='33') or (cmd='66') then
               result:=zdid+cmd + '未设置呼叫队列!请管理员设置!'
               else
               result:=zdid + cmd + '048888';  //没有找到呼叫的科室
               exit;
             end;
             close;
         end
         else
         begin
             if (cmd='33') or (cmd='66') then
             result:=zdid+cmd + '未设置此工号!  请管理员设置!'
             else
             result:=zdid + cmd + '008888';  //没有此用户号
             Close;
             exit;
         end;
      end;
      //修改呼叫终端状态
       adoconnection.Execute('update t_hjzd set state=''完成'''+
          ',calltime=getdate()'+
          ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
      ////查找T_DHXX表中此科室的病人.
      if hjksnum>0 then
      begin
         cmdstr:='';
         cmdstrks:='';
         for i:=1 to hjksnum do
         begin
            if length(cmdstrks)>0 then
               cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
            else
               cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
         end;
         if Length(cmdstrks)>0 then
            cmdstrks :='('+ cmdstrks+')';
         ksbrdys := dmdbaccess.GetDBValue('KS',hjks[1].TGroupid,'SelDoctor');
         if ksbrdys='' then ksbrdys:='0';
         if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
         //if gblBRDYS= 1 then
         begin
           cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where (' + cmdstrks  +')' +
                 ' and (t_dhxx.yhid='''+zdyhid+''''+
                 ' or t_dhxx.yhid='''' or t_dhxx.yhid is null)'+
                 ' and t_dhxx.jzbz<>0' +
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) ;
         end
         else
         begin
           cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where (' + cmdstrks  +')' +
                 ' and t_dhxx.jzbz<>0' +
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) ;
         end;
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ddrs:=qr.RecordCount;
          qr.Close ;

         cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,brdm,by4,by6,jzbz from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where (' + cmdstrks  +')' +
                 ' and t_dhxx.jzbz=0' +
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and t_dhxx.yhid=''' + zdyhid + ''''+
                 ' and t_dhxx.jzsj is not null ' +
                 ' order by t_dhxx.jzsj desc ';
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
             if not qr.Eof  then
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  GHHM:=fields.fields[3].asstring;
                  YXJID:=Fields.Fields[4].asString;
                  yxjmc:=fields.fields[5].asstring;
                  for i:=1 to hjksnum do
                  begin
                      if hjks[i].TGroupid= fields.Fields[6].AsString then
                         break;
                  end;
                  brdm:=fields.Fields[7].AsString;
                  by4:=fields.Fields[8].AsString;
                  by6:=fields.Fields[9].AsString;
                  jzbz :=fields.fields[10].asstring;
                 // DDRs:=RecordCount;
                  if cmd='83' then
                  begin
                     tmpghhm:=ghhm;
                     if length(tmpghhm)=0  then
                        tmpghhm:='0000'
                     else if length(tmpghhm)=1  then
                        tmpghhm:='000'+tmpghhm
                     else if length(tmpghhm)=2  then
                        tmpghhm:='00'+tmpghhm
                     else if length(tmpghhm)=3  then
                        tmpghhm:='0'+tmpghhm
                     else
                        tmpghhm:=RightStr(tmpghhm,4);
                     result:=zdid +cmd  +'01' + tmpghhm;
                  end
                  else if (cmd='33') or (cmd='66') then
                  begin
                     result:=zdid+cmd + getstrwithnotbadcode(hjks[i].TGroupName,8)+'人数'+getstrwithnotbadcode(inttostr(ddrs),3)+
                             getstrwithnotbadcode(brxm,8)+ '  '+ getstrwithnotbadcode(ghhm,5);
                  end
                  else
                     result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid;
                  //并将数据放入显示信息表中
                  //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                  //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                  //修改T_dhxx中的数据，将本条数据改为完成
                  if jzbz='0' then
                  begin
                    cmdstr:=' UPDATE t_dhxx SET yhid=''' + zdyhid + ''''+
                            ' ,ckhm='+fjh+
                            ' ,jzsj=getdate()' +
                            ' ,ztbz=7'+
                            ' where id=' + jrid ;
                    adoconnection.Execute(cmdstr ,cmdText);
                  end
                  else
                  begin
                    YHBreakCallBrdm(ZDID,'E7',brdm);
                    cmdstr:=' UPDATE t_dhxx SET yhid=''' + zdyhid + ''''+
                            ' ,ckhm='+fjh+
                            ' ,jzsj=getdate()' +
                            ' ,ztbz=7'+
                            ' where id=' + jrid ;
                    adoconnection.Execute(cmdstr ,cmdText);
                  end;
                  iscall:=true;
                  DB_SetHisPatientStatus(jrid);
                  doUnlockothergroupsamepat(jrid);
              end;
              close;
          end;
         end;
         if iscall=false  then
            begin
              if (cmd='33') or (cmd='66') then
              result:=zdid +cmd  +'完成失败!      '+''
              else
              result:=zdid +cmd  +'000000'  ;
            end;


    except
      begin
        if (cmd='33') or (cmd='66') then
        result:=zdid +cmd  +'完成失败!      '+'完成时有错误!'
        else
        result := zdid + cmd + '068888';  ///有错误发生.
        Exit;
      end;
    end;
  end
  else
  begin
    try
      //gbledit_ks_count:=0;
      result:='';
      iscall:=false;
      qr.Close;
      //在等待T_hjzd表中查找zdid.
      qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                              ' t_hjzd left outer join t_yh on ' +
                              ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                              ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
      qr.Open;
      ///////////将中.
      with qr do
      begin
         if not qr.Eof  then
         begin
            zdyhid:=fields.fields[4].asstring ;
            zdyhmc:=fields.fields[5].asstring;
            fjh:=fields.Fields[1].AsString;
            fjmc:=fields.Fields[6].AsString;
            zth:=fields.Fields[2].AsString;
            ztmc:=fields.Fields[3].AsString;
            if ( zdyhid <>'')  then
               begin
               close;
               end
            else
               begin
               if (cmd='40') or (cmd='57') then
                result:=zdid +cmd  +'还没有登录!    '+'请登录工号    '
               else
               result:=zdid+cmd + '028888';///没有登录.
               close;
               exit;
               end;
         end
         else
         begin
             if (cmd='40') or (cmd='57') then
              result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置  '
             else
             result:=zdid + cmd + '038888';  ///没有此呼叫器
             close ;
             exit;
         end;
      end;
      //在等待T_YH表中查找YHID信息.
      qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
                ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
                ' FROM t_YH LEFT OUTER JOIN ' +
                ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
                ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
      qr.Open;
      ///////////将中.
      with qr do
      begin
         if not qr.Eof  then
         begin
//            hjksnum:=1;
//            for intFieldsIndex:=2 to 7 do
//            begin
//                if intFieldsIndex mod 2 =0 then Continue ;
//                if fields.fields[intFieldsIndex].asstring<>''  then
//                   begin
//                     hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                     hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                     hjksnum:=hjksnum+1;
//                   end;
//            end;
            GetYHCallKS(zdyhid,hjksnum,hjks);
            if hjksnum=0 then
             begin
               if (cmd='40') or (cmd='57') then
                result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置! '
               else
               result:=zdid + cmd + '048888';  //没有找到呼叫的科室
               exit;
             end;
             close;
         end
         else
         begin
             if (cmd='40') or (cmd='57') then
              result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置  '
             else
             result:=zdid + cmd + '008888';  //没有此用户号
             Close;
             exit;
         end;
      end;
      //修改呼叫终端状态
       adoconnection.Execute('update t_hjzd set state=''选呼'''+
          ',calltime=getdate()'+
          ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);

      ////查找此科室的病人.
      if hjksnum>0 then
      begin
         for i:=1 to hjksnum do
         begin
  //          cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
            ////////根据是不否使用选医生功能.
            if iscall then
                break;
            ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
            if ksbrdys='' then ksbrdys:='0';
            if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
            //if gblBRDYS=1 then
            begin
              cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6 from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where ksid=''' + hjks[i].TGroupid +''''+
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and t_dhxx.ghhm=''' + callno + ''''+
                 ' and t_dhxx.jzbz=0'+
                 ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                 ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                 ' order by t_dhxx.kssxid ';
            end
            else
            begin
              cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6 from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where ksid=''' + hjks[i].TGroupid +''''+
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and t_dhxx.ghhm=''' + callno + ''''+
                 ' and t_dhxx.jzbz=0'+
                 ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                 ' order by t_dhxx.kssxid ';
            end;
            ////////////
            qr.SQL.Text:=cmdstr;
            qr.Open;
            ///////////将中.
            with qr do
            begin
              if not qr.Eof  then
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  GHHM:=fields.fields[3].asstring;
                  YXJID:=Fields.Fields[4].asString;
                  yxjmc:=fields.fields[5].asstring;
                  tmpadoquery:=Tadoquery.Create(nil);
                  tmpadoquery.Connection:=adoconnection;
                  tmpadoquery.SQL.Clear;
                  tmpadoquery.SQL.Text:=' select 1 from  ' +
                 ' t_dhxx ' +
                 ' where ksid=''' + hjks[i].TGroupid +''''+
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and jzbz<>''0'' ';
                  tmpadoquery.Open;
                  DDrs:=tmpadoquery.RecordCount;
                  tmpadoquery.Close;
                  FreeAndNil(tmpadoquery);

                  JZBZ:=fields.fields[7].asstring;
                  brdm:=fields.fields[8].asstring;
                  by4:=fields.fields[9].asstring;
                  by6:=fields.fields[10].asstring;
                  if jzbz='0' then
                     DDRs:=DDRs
                  else
                     DDRs:=DDrs-1;
                  if (cmd='90') or (cmd='93') then
                  begin
                    retstr:=ghhm;
                    if length(retstr)=0 then
                       retstr:='0000'
                    else if length(retstr)=1 then
                       retstr:='000'+retstr
                    else if length(retstr)=2 then
                       retstr:='00'+retstr
                    else if length(retstr)=3 then
                       retstr:='0'+retstr
                    else
                       retstr:=RightStr(retstr,4);
                     result:=zdid +cmd  +'01' + retstr;
                  end
                  else if (cmd='40') or (cmd='57') then
                    result:=zdid +cmd  +getstrwithnotbadcode(hjks[i].TGroupName,8)+'人数'+ getstrwithnotbadcode(inttostr(DDRS),3)+
                            getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5)
                   else
                     result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid;
                  gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid;
                  gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;
                  gbledit_ks_count:=gbledit_ks_count+1;

                  // 修改T_DHXX中的顺序.
                  if jzbz<>'0' then
                  begin
                    cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                          ' where kssxid >=(select kssxid from t_dhxx where id=' + jrid +')'+
                          ' and ksid=''' +hjks[i].TGroupid + '''' +
                          ' and hszh=' + inttostr(gblHszh);
                    adoconnection.Execute(cmdstr ,cmdText);
                    //将这个科室已呼叫过的病人的kssxid-1
                    cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                            ' where jzbz=0'+
                            ' and ksid=''' +hjks[i].TGroupid + '''' +
                            ' and hszh=' + inttostr(gblHszh);
                    adoconnection.Execute(cmdstr ,cmdText);
                  end;
                   //修改T_dhxx中的数据，将本条数据改为就诊
                  cmdstr:=' UPDATE t_dhxx SET JZBZ=0' +
                          ' ,ztbz=7'+
                          ' ,yhid='''+ ZDyhid +''''+
                          ' ,kssxid=0' +
                          ' ,ckhm='+fjh+
                          ' ,jzsj=getdate()' +
                          ' where id=' + jrid ;
                  adoconnection.Execute(cmdstr ,cmdText);
                  {//并将数据放入显示信息表中
                  if (cmd='90') or (cmd='D9') or (cmd='40') or (cmd='57') or (cmd='93') then
                      WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1)
                  else
                      WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],'',BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                  }
                  iscall:=true;
                  {///修改HIS接口中的数据.
                  CREATE procedure usp_yf_jk_dpkz
                   @yfdm  ut_ksdm,  --药房代码
                   @yflsh  integer,  --药房流水号
                   @spxpbz  integer   --上屏下屏标志0上屏1下屏
                  exec usp_yf_jk_dpkz '4041',9,1  }
                  {if NeedUpdateHis=1 then
                  begin
                     with frmmain.ADOStoredProcHis do
                     begin
                        try
                        ProcedureName:='usp_yf_jk_dpkz';
                        Parameters.Clear;
                        Parameters.CreateParameter('yfdm',
                          ftString, pdInput, 10, hjksid[i]);
                        Parameters.CreateParameter('yflsh',
                          ftInteger, pdInput, 4, strtoint(ghhm));
                        Parameters.CreateParameter('spxpbz',
                          ftInteger, pdInput, 4, 0);
                        ExecProc;
                        Close;
                        except
                            on E:exception do
                               dmdbaccess.addlog('ErrorLog.txt',datetimetostr(now)+' '+ E.message+' 更新HIS标志失败');
                        end;
                     end;
                  end;  }

              end;
              close;
            end;

         end;
         if iscall=false  then
            begin
             if (cmd='40') or (cmd='57') then
              result:=zdid +cmd  +'完成没有成功!  '+'未找到此号码! '
             else
              result:=zdid +cmd  +'000000'  ;
            end;
      end;
    except
      begin
         if (cmd='40') or (cmd='57') then
          result:=zdid +cmd  +'完成没有成功!  '+'操作时有错误! '
         else
        result := zdid + cmd + '068888';  ///有错误发生.
        Exit;
      end;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHEnterCall; 按ID查找病人
                                           *
*函数机能:复呼                                          *
*******************************************************************************}
function TdmDBAccess.YHEnterCallByID(const ZDID: string; const cmd:string; const callno:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array[1..20] of CallGroup_Info;
   cmdstr:widestring;
   cmdstrks:widestring;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   tmpghhm:string;
   by6:string;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   retstr:string;
   tmpadoquery:Tadoquery;
   ksbrdys:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;

  begin
    try
      //gbledit_ks_count:=0;
      result:='';
      iscall:=false;
      qr.Close;
      //在等待T_hjzd表中查找zdid.
      qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                              ' t_hjzd left outer join t_yh on ' +
                              ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                              ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
      qr.Open;
      ///////////将中.
      with qr do
      begin
         if not qr.Eof  then
         begin
            zdyhid:=fields.fields[4].asstring ;
            zdyhmc:=fields.fields[5].asstring;
            fjh:=fields.Fields[1].AsString;
            fjmc:=fields.Fields[6].AsString;
            zth:=fields.Fields[2].AsString;
            ztmc:=fields.Fields[3].AsString;
            if ( zdyhid <>'')  then
               begin
               close;
               end
            else
               begin
               if (cmd='40') or (cmd='57') then
                result:=zdid +cmd  +'还没有登录!    '+'请登录工号    '
               else
               result:=zdid+cmd + '028888';///没有登录.
               close;
               exit;
               end;
         end
         else
         begin
             if (cmd='40') or (cmd='57') then
              result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置  '
             else
             result:=zdid + cmd + '038888';  ///没有此呼叫器
             close ;
             exit;
         end;
      end;
      //在等待T_YH表中查找YHID信息.
      qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
                ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
                ' FROM t_YH LEFT OUTER JOIN ' +
                ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
                ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
      qr.Open;
      ///////////将中.
      with qr do
      begin
         if not qr.Eof  then
         begin
            GetYHCallKS(zdyhid,hjksnum,hjks);
            if hjksnum=0 then
             begin
               if (cmd='40') or (cmd='57') then
                result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置! '
               else
               result:=zdid + cmd + '048888';  //没有找到呼叫的科室
               exit;
             end;
             close;
         end
         else
         begin
             if (cmd='40') or (cmd='57') then
              result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置  '
             else
             result:=zdid + cmd + '008888';  //没有此用户号
             Close;
             exit;
         end;
      end;
      //修改呼叫终端状态
       adoconnection.Execute('update t_hjzd set state=''完成'''+
          ',calltime=getdate()'+
          ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);

      ////查找此科室的病人.
      if hjksnum>0 then
      begin
         for i:=1 to hjksnum do
         begin
  //          cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
            ////////根据是不否使用选医生功能.
            if iscall then
                break;
            ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
            if ksbrdys='' then ksbrdys:='0';
            if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
            //if gblBRDYS=1 then
            begin
              cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6 from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where ksid=''' + hjks[i].TGroupid +''''+
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and t_dhxx.id=' + callno +
                 //' and t_dhxx.jzbz=0'+
                 ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                 ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                 ' order by t_dhxx.kssxid ';
            end
            else
            begin
              cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6 from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where ksid=''' + hjks[i].TGroupid +''''+
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and t_dhxx.id=' + callno +
                 //' and t_dhxx.jzbz=0'+
                 ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                 ' order by t_dhxx.kssxid ';
            end;
            ////////////
            qr.SQL.Text:=cmdstr;
            qr.Open;
            ///////////将中.
            with qr do
            begin
              if not qr.Eof  then
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  GHHM:=fields.fields[3].asstring;
                  YXJID:=Fields.Fields[4].asString;
                  yxjmc:=fields.fields[5].asstring;
                  tmpadoquery:=Tadoquery.Create(nil);
                  tmpadoquery.Connection:=adoconnection;
                  tmpadoquery.SQL.Clear;
                  tmpadoquery.SQL.Text:=' select 1 from  ' +
                 ' t_dhxx ' +
                 ' where ksid=''' + hjks[i].TGroupid +''''+
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and jzbz<>''0'' ';
                  tmpadoquery.Open;
                  DDrs:=tmpadoquery.RecordCount;
                  tmpadoquery.Close;
                  FreeAndNil(tmpadoquery);

                  JZBZ:=fields.fields[7].asstring;
                  brdm:=fields.fields[8].asstring;
                  by4:=fields.fields[9].asstring;
                  by6:=fields.fields[10].asstring;
                  if jzbz='0' then
                     DDRs:=DDRs
                  else
                     DDRs:=DDrs-1;
                  if (cmd='90') or (cmd='93') then
                  begin
                    retstr:=ghhm;
                    if length(retstr)=0 then
                       retstr:='0000'
                    else if length(retstr)=1 then
                       retstr:='000'+retstr
                    else if length(retstr)=2 then
                       retstr:='00'+retstr
                    else if length(retstr)=3 then
                       retstr:='0'+retstr
                    else
                       retstr:=RightStr(retstr,4);
                     result:=zdid +cmd  +'01' + retstr;
                  end
                  else if (cmd='40') or (cmd='57') then
                    result:=zdid +cmd  +getstrwithnotbadcode(hjks[i].TGroupName,8)+'人数'+ getstrwithnotbadcode(inttostr(DDRS),3)+
                            getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5)
                   else
                     result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid;
                  gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid;
                  gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;
                  gbledit_ks_count:=gbledit_ks_count+1;

                  // 修改T_DHXX中的顺序.
                  if jzbz<>'0' then
                  begin
                    cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                          ' where kssxid >=(select kssxid from t_dhxx where id=' + jrid +')'+
                          ' and ksid=''' +hjks[i].TGroupid + '''' +
                          ' and hszh=' + inttostr(gblHszh);
                    adoconnection.Execute(cmdstr ,cmdText);
                    //将这个科室已呼叫过的病人的kssxid-1
                    cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                            ' where jzbz=0'+
                            ' and ksid=''' +hjks[i].TGroupid + '''' +
                            ' and hszh=' + inttostr(gblHszh);
                    adoconnection.Execute(cmdstr ,cmdText);
                  end;
                   //修改T_dhxx中的数据，将本条数据改为就诊
                  cmdstr:=' UPDATE t_dhxx SET JZBZ=0' +
                          ' ,ztbz=7'+
                          ' ,yhid='''+ ZDyhid +''''+
                          ' ,kssxid=0' +
                          ' ,ckhm='+fjh+
                          ' ,jzsj=getdate()' +
                          ' where id=' + jrid ;
                  adoconnection.Execute(cmdstr ,cmdText);
                  {//并将数据放入显示信息表中
                  if (cmd='90') or (cmd='D9') or (cmd='40') or (cmd='57') or (cmd='93') then
                      WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1)
                  else
                      WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],'',BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                  }
                  iscall:=true;
                  DB_SetHisPatientStatus(jrid);
                  {///修改HIS接口中的数据.
                  CREATE procedure usp_yf_jk_dpkz
                   @yfdm  ut_ksdm,  --药房代码
                   @yflsh  integer,  --药房流水号
                   @spxpbz  integer   --上屏下屏标志0上屏1下屏
                  exec usp_yf_jk_dpkz '4041',9,1  }
                  {if NeedUpdateHis=1 then
                  begin
                     with frmmain.ADOStoredProcHis do
                     begin
                        try
                        ProcedureName:='usp_yf_jk_dpkz';
                        Parameters.Clear;
                        Parameters.CreateParameter('yfdm',
                          ftString, pdInput, 10, hjksid[i]);
                        Parameters.CreateParameter('yflsh',
                          ftInteger, pdInput, 4, strtoint(ghhm));
                        Parameters.CreateParameter('spxpbz',
                          ftInteger, pdInput, 4, 0);
                        ExecProc;
                        Close;
                        except
                            on E:exception do
                               dmdbaccess.addlog('ErrorLog.txt',datetimetostr(now)+' '+ E.message+' 更新HIS标志失败');
                        end;
                     end;
                  end;  }

              end;
              close;
            end;

         end;
         if iscall=false  then
            begin
             if (cmd='40') or (cmd='57') then
              result:=zdid +cmd  +'完成没有成功!  '+'未找到此号码! '
             else
              result:=zdid +cmd  +'000000'  ;
            end;
      end;
    except
      begin
         if (cmd='40') or (cmd='57') then
          result:=zdid +cmd  +'完成没有成功!  '+'操作时有错误! '
         else
        result := zdid + cmd + '068888';  ///有错误发生.
        Exit;
      end;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHQHCall;
                                           *
*函数机能:将刚呼叫的病人弃号*
*******************************************************************************}
function TdmDBAccess.YHQHCall(const ZDID: string; const cmd:string;const Acallno:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array[1..20] of CallGroup_Info;
   cmdstr:widestring;
   ksid,kssxid,JRID,GHHM,BRXM,YXJID,yxjmc:string;
   jzbz:integer;
   DDRS:integer;
   iscall :boolean;
   ydws:integer;   //忽略移动的位数
   hlcs,yhlcs:integer;  //已忽略次数
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
         begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
          end
       else
         begin
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
         end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    ////查找T_DHXX表中此科室的病人.
    if hjksnum>0 then
    begin
       cmdstr:='';
       for i:=1 to hjksnum do
       begin
          if length(cmdstr)>0 then
             cmdstr:=cmdstr + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
          else
             cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
       end;
       if length(cmdstr)>0 then
        cmdstr :='('+cmdstr+')';
       qr.Close;
//       if Length(Acallno)>0 then
//       begin
//         cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,yhlcs,jzbz from  ' +
//               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
//               ' where ' + cmdstr +
//               ' and t_dhxx.ghhm='+quotedstr(Acallno) +
//               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
//               ' order by t_dhxx.ghsj desc ';
//       end
//       else
       begin
         cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,yhlcs,jzbz from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ' + cmdstr +
               ' and t_dhxx.jzbz=0' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.yhid=''' + zdyhid + ''''+
               ' and t_dhxx.jzsj is not null ' +
               ' order by t_dhxx.jzsj desc ';
       end;
        qr.SQL.Text:=cmdstr;
        qr.Open;
        ///////////将中.
        with qr do
        begin
           if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                ksid :=fields.fields[6].asstring;
                yhlcs:=fields.fields[7].AsInteger;
                jzbz :=fields.fields[8].AsInteger;
                //修改T_dhxx中的数据，将本条数据改为已就诊弃号
                cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
                        ' ,kssxid=0'+
                        ' ,ztbz=3'+
                        ' where id=' + jrid ;
                adoconnection.Execute(cmdstr ,cmdText);
//                gbledit_ks[gbledit_ks_count].ksid:=ksid;
//                gbledit_ks[gbledit_ks_count].ksmc:=ksid;
//                gbledit_ks_count:=gbledit_ks_count+1;
                iscall:=true;
                if cmd='F3' then
                   result:=zdid+cmd+'01'+ghhm+'号弃号成功'
                else
                   result:=zdid+cmd+'01'+'6666';
            end;
            close;
        end;
    end;
       if iscall=false  then
          begin
            result:=zdid +cmd  +'000000'  ;
          end;
  except
    begin
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHNOCall;
                                           *
*函数机能:忽略刚呼叫的病人,转而呼叫下一位病人.                                          *
*******************************************************************************}
function TdmDBAccess.YHNoCall(const ZDID: string; const cmd:string;const AKeySet:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc:string;
   DDRS:integer;
   iscall :boolean;
   ydws:integer;   //忽略移动的位数
   hlcs,yhlcs:integer;  //已忽略次数
   qr:tadoquery;
   ghsj:string;
   qry:TADOQuery;
   yhid:string;
begin
  qry := TADOQuery.Create(nil);
  try
    qry.Connection := ADOConnection;
  try
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qry.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qry.Open;
    ///////////将中.
    with qry do
    begin
       if not qry.Eof  then
         begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             //result:=zdid+cmd + '028888';///没有登录.
             if (cmd='34') then
             result:=zdid+cmd + '还没有登录!    请登录工号     '///没有登录.
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
          end
       else
         begin
           //result:=zdid + cmd + '038888';  ///没有此呼叫器
           if (cmd='34') then
             result:=zdid+cmd + '无此呼叫器!    请管理员设置!'///没有登录.
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
         end;
    end;
    //在等待T_YH表中查找YHID信息.
    qry.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qry.Open;
    ///////////将中.
    with qry do
    begin
       if not qry.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             if (cmd='34') then
                result:=zdid+cmd + '未设置呼叫队列!请管理员设置!'
             else
                result:=zdid+ cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           if (cmd='34') then
             result:=zdid+cmd + '未设置此工号!  请管理员设置!'
           else
             result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    ////查找T_DHXX表中此科室的病人.
    if hjksnum>0 then
    begin
       cmdstr:='';
       for i:=1 to hjksnum do
       begin
          if length(cmdstr)>0 then
             cmdstr:=cmdstr + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
          else
             cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
       end;
       if length(cmdstr)>0 then
        cmdstr :='('+cmdstr+')';
       qry.Close;
       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,yhlcs from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ' + cmdstr +
               ' and t_dhxx.jzbz=0' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.yhid=''' + zdyhid + ''''+
               ' and t_dhxx.jzsj is not null ' +
               ' order by t_dhxx.jzsj desc ';
        qry.SQL.Text:=cmdstr;
        qry.Open;
        ///////////将中.
        with qry do
        begin
           if not qry.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                yhlcs:=fields.fields[7].AsInteger;
                qr:=TADOQuery.Create(nil);
                try
                  qr.Connection := ADOConnection;
                  for i:=1 to hjksnum do
                  begin
                      if hjks[i].TGroupid= fields.Fields[6].AsString then
                      begin
                                //查询忽略次数
                                if  gblhlfs=1 then
                                begin
                                      cmdstr:='select hlcs from t_ks_hlydws where ksid=''' + hjks[i].TGroupid + ''' and hszh= ' + inttostr(gblhszh);
                                      qr.SQL.Text:=cmdstr;
                                      qr.Open;
                                      if qr.Eof then
                                            hlcs:=gblhlcs
                                      else
                                      hlcs:=qr.Fields.Fields[0].AsInteger;
                                      qr.Close;
                                end
                                else
                                begin
                                      hlcs:=gblhlcs;
                                end;

                                //确定移动位数
                                if  gblhlydfs=1 then
                                begin
                                   qr.Close;
                                   cmdstr:='select ydws from t_ks_hlydws where ksid=''' + hjks[i].TGroupid + ''' and hszh= ' + inttostr(gblhszh);
                                   qr.SQL.Text:=cmdstr;
                                   qr.Open;
                                   if qr.Eof then
                                      ydws:=gblhlydws   //如果科室移动位数未设置，则按照统一的位数来移动
                                   else
                                      ydws:=qr.Fields.Fields[0].AsInteger;
                                   qr.Close;
                                end
                                else
                                      ydws:=gblhlydws;
                         break;
                      end;
                  end;
                finally
                  FreeAndNil(qr);
                end;
                if yhlcs>=hlcs then
                begin
                ////已经忽略的次数大于等于可忽略的次数,直接呼叫下一位，对本次呼叫的病人不作操作
                        //修改T_dhxx中的数据，将本条数据改为未就诊
                        cmdstr:=' UPDATE t_dhxx SET yhid='''''+
                                ' ,jzsj=getdate()' +
                                ' where id=' + jrid ;
                        adoconnection.Execute(cmdstr ,cmdText);
                end
                else
                begin

                        //DDRs:=RecordCount;
        {                result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS);
                        //并将数据放入显示信息表中
                        //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                        WriteDispMsgTT(zdid,fjh,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,DDRS,1);
        }
                        //修改T_dhxx中的数据，将其它的信息顺序修改

                        cmdstr:=' Select 1  from t_dhxx (nolock)' +
                                ' where ksid=''' +hjks[i].TGroupid + '''' +
                                ' and jzbz=''1'''+
                                ' and hszh=' + inttostr(gblHszh);
                        DDRs:=adoconnection.execute(cmdstr,cmdtext).RecordCount;
                        if ddrs>=ydws+1 then
                        begin
                           kssxid:=inttostr(ydws+1)
                        end
                        else
                        begin
                           kssxid:=inttostr(ddrs+1);

                        end;
                        qr := TADOQuery.Create(nil);
                        qr.Connection := ADOConnection;
                        cmdstr:='select ghsj from t_dhxx'+
                                ' where kssxid>='+kssxid+
                                ' and jzbz=1'+
                                ' and ksid='''+hjks[i].TGroupid+''''+
                                ' and hszh='+ inttostr(gblHSZH)+
                                ' order by ghsj';
                        qr.SQL.Text :=cmdstr;
                        ghsj:='';
                        try
                          qr.Open;
                          if not qr.Eof then
                            ghsj :=CDateToStr(qr.fieldbyname('ghsj').AsDateTime)+' '
                                +ctimetostr(qr.fieldbyname('ghsj').AsDateTime)
                          else
                          begin
                            qr.Close;
                            cmdstr:='select ghsj from t_dhxx'+
                                    ' where ksid='''+hjks[i].TGroupid+''''+
                                    ' and jzbz=1'+
                                    ' and hszh='+ inttostr(gblHSZH)+
                                    ' order by ghsj desc';
                            qr.SQL.Text :=cmdstr;
                            qr.Open;
                            if not qr.Eof then
                            begin
                              ghsj:=CDateToStr(qr.fieldbyname('ghsj').AsDateTime)+' '
                                +ctimetostr(qr.fieldbyname('ghsj').AsDateTime+1/60/60/24);
                            end;
                          end;
                        except

                        end;
                        qr.Close;
                        qr.Free;
                        cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid+1' +
                                ' where kssxid >=' + kssxid +
                                ' and ksid=''' +hjks[i].TGroupid + '''' +
                                ' and hszh=' + inttostr(gblHszh);
                        adoconnection.Execute(cmdstr ,cmdText);
                        //修改T_dhxx中的数据，将本条数据改为未就诊
                        if gblhlblys=1 then
                           yhid :=zdyhid
                        else
                           yhid :='';
                        if ghsj='' then
                        begin
                          cmdstr:=' UPDATE t_dhxx SET JZBZ=''1''' +
                                ' ,ztbz=''2'''+
                                ' ,yxjid=1'+
                                ' ,yhid='+quotedstr(yhid)+
                                ' ,jzsj=null' +
                                ' ,kssxid=' + kssxid +
                                ' ,yhlcs= ' + inttostr(yhlcs+1) +
                                ' where id=' + jrid ;
                        end
                        else
                        begin
                          cmdstr:=' UPDATE t_dhxx SET JZBZ=''1''' +
                                ' ,ztbz=''2'''+
                                ' ,yxjid=1'+
                                ' ,yhid='+quotedstr(yhid)+
                                ' ,jzsj=null' +
                                ' ,kssxid=' + kssxid +
                                ' ,ghsj=convert(datetime,'+''''+ghsj+''''+',102)'+
                                ' ,yhlcs= ' + inttostr(yhlcs+1) +
                                ' where id=' + jrid ;
                        end;
                        adoconnection.Execute(cmdstr ,cmdText);
                end;
                if cmd='84' then
                   result:=YHCallNextKeySet(zdid,'82','')      //硬件呼叫
                else if cmd='34' then
                   result:=YHCallNextKeySet(zdid,'32','')     //硬件呼叫2
                else
                begin
                  if AKeySet<>'' then
                    result:=YHCallNextKeySet(zdid,'D5',AKeySet)
                  else
                   result:=YHCallNextKeySet(zdid,'D5',AKeySet);     //软件呼叫
                end;
                iscall:=true;
            end;
            close;
        end;
    end;
       if iscall=false  then
          begin
            //result:=zdid +cmd  +'000000'  ;
           if (cmd='34')  then
             result:=zdid+cmd + '忽略失败                   !'
           else
           result:=zdid + cmd + '000000';
          end;
  except
    begin
      //result := zdid + cmd + '068888';  ///有错误发生.
       if (cmd='34')  then
          result:=zdid+cmd + '忽略失败                   !'
       else
          result:=zdid + cmd + '068888';
      Exit;
    end;
  end;
  finally
    qry.Free;
  end;
end;
{*******************************************************************************
*函数名:YHGetWaitNum;
                                           *
*函数机能:查询等候的病人人数.                                          *
*******************************************************************************}
function TdmDBAccess.YHGetWaitNum(const ZDID: string; const cmd:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
  // kssxid,JRID,GHHM,BRXM,YXJID,yxjmc:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
         begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          //fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             if (cmd='38') or (cmd='62') then
             result:=zdid+cmd + '还未登录!      请登录工号     '
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
          end
       else
         begin
           if (cmd='38') or (cmd='62') then
           result:=zdid+cmd + '未设置呼叫器!  请管理员设置'
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
         end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             if (cmd='38') or (cmd='62') then
             result:=zdid+cmd + '未设置呼叫队列!请管理员设置!'
             else
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           if (cmd='38') or (cmd='62') then
           result:=zdid+cmd + '没有设置此工号!请管理员设置!'
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    ////查找T_DHXX表中此科室的病人.
    if hjksnum>0 then
    begin
       cmdstr:='';
       for i:=1 to hjksnum do
       begin
          if length(cmdstr)>0 then
             cmdstr:=cmdstr + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
          else
             cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
       end;
       cmdstr:=' select 1 from  ' +
               ' t_dhxx (nolock) ' +
               ' where (' + cmdstr  +')' +
               ' and t_dhxx.jzbz=1' +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
               ' and t_dhxx.hszh=' +inttostr(gblhszh);
        qr.SQL.Text:=cmdstr;
        qr.Open;
        ///////////将中.
        with qr do
        begin
           if not qr.Eof  then
            begin
                DDRs:=RecordCount;
                if cmd='88' then
                begin
                  retstr:= inttostr(ddrs)  ;
                  if length(retstr)=0 then
                     retstr:='0000'
                  else if length(retstr)=1 then
                     retstr:='000'+retstr
                  else if length(retstr)=2 then
                     retstr:='00'+retstr
                  else if length(retstr)=3 then
                     retstr:='0'+retstr
                  else
                     retstr:=RightStr(retstr,4);
                  result:=zdid +cmd + '01' + retstr;
                end
                else if (cmd='38') or (cmd='62') then
                begin
                   result:=zdid+cmd + '等待人数:'+inttostr(ddrs);
                end
                else
                  result:=zdid +cmd + '01' + inttostr(ddrs);
                iscall:=true;
            end
           else
            begin
                DDRs:=RecordCount;
                if cmd='88' then
                begin
                  retstr:= inttostr(ddrs)  ;
                  if length(retstr)=0 then
                     retstr:='0000'
                  else if length(retstr)=1 then
                     retstr:='000'+retstr
                  else if length(retstr)=2 then
                     retstr:='00'+retstr
                  else if length(retstr)=3 then
                     retstr:='0'+retstr
                  else
                     retstr:=RightStr(retstr,4);
                   result:=zdid +cmd + '01' + retstr;
                end
                else if (cmd='38') or (cmd='62') then
                begin
                   result:=zdid+cmd + '等待人数:'+inttostr(ddrs);
                end
                else
                   result:=zdid +cmd + '01' + inttostr(ddrs);
                iscall:=true;
            end;
            close;

        end;
    end;
    if iscall=false  then
    begin
        if (cmd='38') or (cmd='62') then
        begin
           result:=zdid+cmd + '查询不成功!';
        end
        else
           result:=zdid +cmd  +'000000'  ;
    end;
  except
    begin
      if (cmd='38') or (cmd='62') then
      begin
         result:=zdid+cmd + '查询不成功!    有错误发生!';
      end
      else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;

{*******************************************************************************
*函数名:YHGetWaitNumKS;
*
                                           *
*函数机能:查询用户呼叫科室内等候的病人人数.                                          *
*******************************************************************************}
function TdmDBAccess.YHGetWaitNumKS(const ZDID: string; const cmd:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
  // kssxid,JRID,GHHM,BRXM,YXJID,yxjmc:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
         begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          //fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             if (cmd='36') then
             result:=zdid+cmd + '还未登录!      请登录工号     '
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
          end
       else
         begin
           if (cmd='36') then
           result:=zdid+cmd + '未设置呼叫器!  请管理员设置'
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
         end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             if (cmd='36') then
             result:=zdid+cmd + '未设置呼叫队列!请管理员设置!'
             else
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           if (cmd='36')  then
           result:=zdid+cmd + '没有设置此工号!请管理员设置!'
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    ////查找T_DHXX表中此科室的病人.
    if hjksnum>0 then
    begin
       cmdstr:='';
       //for i:=1 to hjksnum-1 do
       //begin
          //if length(cmdstr)>0 then
          //   cmdstr:=cmdstr + ' or t_dhxx.ksid=''' + hjksid[i] +''''
          //else
         cmdstr:=' t_dhxx.ksid=''' + hjks[1].TGroupid +'''' ;

         cmdstr:=' select 1 from  ' +
                 ' t_dhxx (nolock) ' +
                 ' where (' + cmdstr  +')' +
                 ' and t_dhxx.jzbz=''1''' +
                 ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                 ' and t_dhxx.hszh=' +inttostr(gblhszh);
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
             if not qr.Eof  then
             begin
                  DDRs:=RecordCount;
                  if cmd='86' then
                  begin
                    retstr:= inttostr(ddrs)  ;
                    if length(retstr)=0 then
                       retstr:='0000'
                    else if length(retstr)=1 then
                       retstr:='000'+retstr
                    else if length(retstr)=2 then
                       retstr:='00'+retstr
                    else if length(retstr)=3 then
                       retstr:='0'+retstr
                    else
                       retstr:=RightStr(retstr,4);
                    result:=zdid +cmd + '01' + retstr;
                  end
                  else if (cmd='36') then
                  begin
                     result:=zdid+cmd + '等待人数:'+inttostr(ddrs);
                  end
                  else
                    result:=zdid +cmd + '01' + inttostr(ddrs);
                  //if ddrs>0 then
                  //begin
                    iscall:=true;
                  //   break ;
                  //end;
              end
              else
              begin
                if (cmd='36') then
                begin
                   result:=zdid+cmd + '等待人数:'+inttostr(0);
                end
                else
                    result:=zdid +cmd + '010000';
                  //if ddrs>0 then
                  //begin
                    iscall:=true;
              end;
              close;
            end;
        //end;
    end;
    if iscall=false  then
    begin
        if (cmd='36') then
        begin
           result:=zdid+cmd + '查询不成功!';
        end
        else
         result:=zdid +cmd  +'000000'  ;
    end;
  except
    begin
      if (cmd='36') then
      begin
         result:=zdid+cmd + '查询不成功!    有错误发生!';
      end
      else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:GetHJWaitNumKS;
*
                                           *
*函数机能:查询科室内可呼叫病人人数.                                          *
*******************************************************************************}
function TdmDBAccess.GetHJWaitNumKS(const AKSID: string): integer;
var
   cmdstr:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      result:=0;
      cmdstr:='';
      cmdstr:=' t_dhxx.ksid=''' + Aksid +'''' ;
      cmdstr:=' select count(1) as br_count from  ' +
             ' t_dhxx (nolock) ' +
             ' where (' + cmdstr  +')' +
             ' and t_dhxx.jzbz=''1''' +
             ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
             ' and t_dhxx.hszh=' +inttostr(gblhszh);
      qr.SQL.Text := cmdstr;
      qr.Open;
      result:=qr.fieldbyname('br_count').asinteger;
      qr.Close;
    except
      begin
        result := 0;  ///有错误发生.
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

{*******************************************************************************
*函数名:GetHJWaitNumYH;
*
                                           *
*函数机能:查询医生的病人人数.                                          *
*******************************************************************************}
function TdmDBAccess.GetHJWaitNumYH(const Ayhid: string): integer;
var
   cmdstr:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      result:=0;
      cmdstr:='';
      cmdstr:=' t_dhxx.ksid in (select ksid from t_yh_ks where yhid='+quotedstr(ayhid)+
        ' and hszh='+inttostr(gblhszh)+')' ;
      cmdstr:=' select count(1) as br_count from  ' +
             ' t_dhxx (nolock) ' +
             ' where (' + cmdstr  +')' +
             ' and t_dhxx.jzbz=''1''' +
             ' and (yhid='+quotedstr(ayhid)+' or isnull(yhid,'''')='''')'+
             ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
             ' and t_dhxx.hszh=' +inttostr(gblhszh);
      qr.SQL.Text := cmdstr;
      qr.Open;
      result:=qr.fieldbyname('br_count').asinteger;
      qr.Close;
    except
      begin
        result := 0;  ///有错误发生.
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

{*******************************************************************************
*函数名:YHSelCall;
                                           *
*函数机能:选择选呼.                                          *
*******************************************************************************}

function TdmDBAccess.YHSelCall(const zdid:string;const cmd:string;const CallNO :string):string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   tmpadoquery:Tadoquery;
   by6,by3:string;
   ksbrdys:string;
   strCallNo,strCallKsid:string;
   ps : integer;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection :=ADOConnection;
  try
    strCallKsid := '';
    ps := FoundChar(',',CallNO);
    if ps>0 then
    begin
      strCallNo := Copy(CallNO,1,ps-1);
      strCallKsid :=Copy(CallNO,ps+1,Length(CallNO)-ps);
    end
    else
      strCallNo := CallNO;
    //gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    qr.Close;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             if (cmd='40') or (cmd='57') or (cmd='43') then
              result:=zdid +cmd  +'还没有登录!    '+'请登录工号    '
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
       end
       else
       begin
           if (cmd='40') or (cmd='57') or (cmd='43') then
            result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置  '
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             if (cmd='40') or (cmd='57') or (cmd='43') then
              result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置! '
             else
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           if (cmd='40') or (cmd='57') or (cmd='43') then
            result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置  '
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    //修改呼叫终端状态
     adoconnection.Execute('update t_hjzd set state=''选呼'''+
        ',calltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);

    ////查找此科室的病人.
    if hjksnum>0 then
    begin
       for i:=1 to hjksnum do
       begin
//          cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
          if Length(strCallKsid)>0 then
          begin
            if strCallKsid<>hjks[i].TGroupid then
             Continue;
          end;
          ////////根据是不否使用选医生功能.
          if iscall then
              break;
          ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
          if ksbrdys='' then ksbrdys:='0';
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          //if gblBRDYS=1 then
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6,by3 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.ghhm=''' + strCallNo + ''''+
               ' and ((jzbz=1 and (yhid='''' or yhid is null or yhid =''' + zdyhid +'''))'+ //未被呼叫过要指定医生
               ' or (jzbz=0 and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')))'+
//               ' or (jzbz=0))'+ //已被呼叫过，则不用指定医生
//               ' and (t_dhxx.jzbz=1 or (t_dhxx.jzbz=0 and t_dhxx.ztbz<>3))'+
//               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
               ' order by t_dhxx.jzbz desc,t_dhxx.kssxid ';
          end
          else
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6,by3 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.ghhm=''' + strCallNo + ''''+
               ' and (t_dhxx.jzbz=1 or (t_dhxx.jzbz=0))'+
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
               ' order by t_dhxx.jzbz desc,t_dhxx.kssxid ';
          end;
          ////////////
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                tmpadoquery:=Tadoquery.Create(nil);
                tmpadoquery.Connection:=adoconnection;
                tmpadoquery.SQL.Clear;
                tmpadoquery.SQL.Text:=' select 1 from  ' +
               ' t_dhxx ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and jzbz<>''0'' ';
                tmpadoquery.Open;
                DDrs:=tmpadoquery.RecordCount;
                tmpadoquery.Close;
                FreeAndNil(tmpadoquery);

                JZBZ:=fields.fields[7].asstring;
                brdm:=fields.fields[8].asstring;
                by4:=fields.fields[9].asstring;
                by6:=fields.fields[10].asstring;
                by3:=fields.fields[11].asstring;
                if jzbz='0' then
                   DDRs:=DDRs
                else
                   DDRs:=DDrs-1;
                if (cmd='90') or (cmd='93') then
                begin
                  retstr:=ghhm;
                  if length(retstr)=0 then
                     retstr:='0000'
                  else if length(retstr)=1 then
                     retstr:='000'+retstr
                  else if length(retstr)=2 then
                     retstr:='00'+retstr
                  else if length(retstr)=3 then
                     retstr:='0'+retstr
                  else
                     retstr:=RightStr(retstr,4);
                   result:=zdid +cmd  +'01' + retstr;
                end
                else if (cmd='40') or (cmd='57') or (cmd='43') then
                  result:=zdid +cmd  +getstrwithnotbadcode(hjks[i].TGroupName,8)+'人数'+ getstrwithnotbadcode(inttostr(DDRS),3)+
                          getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5)
                 else
                   result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid;
                   //result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid+','+by3;
                gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid;
                gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;
                gbledit_ks_count:=gbledit_ks_count+1;

                // 修改T_DHXX中的顺序.
                if jzbz<>'0' then
                begin
//                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                        ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
//                        ' and ksid=''' +hjks[i].TGroupid + '''' +
//                        ' and hszh=' + inttostr(gblHszh);
//                  adoconnection.Execute(cmdstr ,cmdText);
//                  //将这个科室已呼叫过的病人的kssxid-1
//                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                          ' where jzbz=0'+
//                          ' and ksid=''' +hjks[i].TGroupid + '''' +
//                          ' and hszh=' + inttostr(gblHszh);
//                  adoconnection.Execute(cmdstr ,cmdText);
//                   //修改T_dhxx中的数据，将本条数据改为就诊
//                  cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
//                          ' ,yhid='''+ ZDyhid +''''+
//                          ' ,kssxid=0' +
//                          ' ,ckhm='+fjh+
//                          ' ,jzsj=getdate()' +
//                          ' where id=' + jrid ;
//                  adoconnection.Execute(cmdstr ,cmdText);
                    doUpdatewaitlistpos(hjks[i].TGroupid,jrid,zdyhid,fjh,gblhszh);
                end
                else
                begin
                   //修改T_dhxx中的数据，将本条数据改为就诊
                  cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
                          ' ,yhid='''+ ZDyhid +''''+
                          ' ,ckhm='+fjh+
                          ' ,jzsj=getdate()' +
                          ' where id=' + jrid ;
                  adoconnection.Execute(cmdstr ,cmdText);
                end;
                DB_SetHisPatientStatus(jrid);
                //并将数据放入显示信息表中
                if (cmd='90') or (cmd='D9') or (cmd='40') or (cmd='57') or (cmd='93') or (cmd='43') then
                    if  (cmd='93') or (cmd='43') then
                      WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,'',BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,'','',by4+'|')
                    else
                      WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,'','',by4+'|')
                else
                    WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,'',BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,'','',by4+'|');
                iscall:=true;
                {///修改HIS接口中的数据.
                CREATE procedure usp_yf_jk_dpkz
                 @yfdm  ut_ksdm,  --药房代码
                 @yflsh  integer,  --药房流水号
                 @spxpbz  integer   --上屏下屏标志0上屏1下屏
                exec usp_yf_jk_dpkz '4041',9,1  }
                if NeedUpdateHis=1 then
                begin
                   with frmmain.ADOStoredProcHis do
                   begin
                      try
                      ProcedureName:='usp_yf_jk_dpkz';
                      Parameters.Clear;
                      Parameters.CreateParameter('yfdm',
                        ftString, pdInput, 10, hjks[i].TGroupid);
                      Parameters.CreateParameter('yflsh',
                        ftInteger, pdInput, 4, strtoint(ghhm));
                      Parameters.CreateParameter('spxpbz',
                        ftInteger, pdInput, 4, 0);
                      ExecProc;
                      Close;
                      except
                          on E:exception do
                             dmdbaccess.addlog('ErrorLog.txt',datetimetostr(now)+' '+ E.message+' 更新HIS标志失败');
                      end;
                   end;
                end;

            end;
            close;
          end;

       end;
       if iscall=false  then
          begin
           if (cmd='40') or (cmd='57') then
            result:=zdid +cmd  +'选呼没有成功!  '+'未找到此号码! '
           else
            result:=zdid +cmd  +'000000'  ;
          end;
    end;
  except
    begin
       if (cmd='40') or (cmd='57') then
        result:=zdid +cmd  +'选呼没有成功!  '+'操作时有错误! '
       else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHSelCall;  按ID
                                           *
*函数机能:选择选呼.                                          *
*******************************************************************************}

function TdmDBAccess.YHSelCallByID(const zdid:string;const cmd:string;const CallNO :string):string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr,cmdstrks:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   tmpadoquery:Tadoquery;
   by6:string;
   ksbrdys:string;
   strCallNo,strCallKsid:string;
   ps : integer;
   qr:TADOQuery;
   yksdm:string;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection :=ADOConnection;
  try
    strCallKsid := '';
    ps := FoundChar(',',CallNO);
    if ps>0 then
    begin
      strCallNo := Copy(CallNO,1,ps-1);
      strCallKsid :=Copy(CallNO,ps+1,Length(CallNO)-ps);
    end
    else
      strCallNo := CallNO;
    //gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    qr.Close;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             if (cmd='40') or (cmd='57') or (cmd='43') then
              result:=zdid +cmd  +'还没有登录!    '+'请登录工号    '
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
       end
       else
       begin
           if (cmd='40') or (cmd='57') or (cmd='43') then
            result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置  '
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             if (cmd='40') or (cmd='57') or (cmd='43') then
              result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置! '
             else
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           if (cmd='40') or (cmd='57') or (cmd='43') then
            result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置  '
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    //修改呼叫终端状态
     adoconnection.Execute('update t_hjzd set state=''选呼'''+
        ',calltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);

      //查询呼叫科室//修改上一呼叫病人的呼叫结束时间
      if hjksnum>0 then
      begin
         cmdstr:='';
         cmdstrks:='';
         i:=1;
         for i:=1 to hjksnum do
         begin
            if length(cmdstrks)>0 then
               cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
            else
               cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
         end;
         //查询出上一个呼叫病人。//
         if Length(cmdstrks)>0 then
            cmdstrks :='('+ cmdstrks+')';
         cmdstr:=' select top 1 id,jzjssj,ztbz,yhlcs from' +
                 ' t_dhxx ' +
                 ' where (' + cmdstrks  +')' +
                 ' and t_dhxx.jzbz=0' +
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and t_dhxx.yhid=''' + zdyhid + ''''+
                 ' and t_dhxx.jzsj is not null ' +
                 ' order by t_dhxx.jzsj desc ';
          qr.SQL.Text := cmdstr;
          qr.Open ;
          jrid:='';
          if not qr.Eof  then
          begin
              //将上一个呼叫病人的jzjssj改为当前时间//
              jrid:=qr.fields.Fields[0].AsString;
              if qr.fields.Fields[1].AsString='' then
              begin
                cmdstr:=' UPDATE t_dhxx '+
                        ' SET jzjssj=getdate()' +
                        ' where id=' + jrid ;
                adoconnection.Execute(cmdstr ,cmdText);
                doUnLockOtherGroupSamePat(jrid);
              end;
          end;
          qr.Close;
     end;

    ////查找此科室的病人.
    if hjksnum>0 then
    begin
       for i:=1 to hjksnum do
       begin
//          cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
          if Length(strCallKsid)>0 then
          begin
            if strCallKsid<>hjks[i].TGroupid then
             Continue;
          end;
          ////////根据是不否使用选医生功能.
          if iscall then
              break;
          ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
          if ksbrdys='' then ksbrdys:='0';
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          //if gblBRDYS=1 then
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6,yksdm from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.id=' + strCallNo +
//               ' and t_dhxx.jzbz in (0,1)'+
//               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
               ' and ((jzbz=1 and (yhid='''' or yhid is null or yhid =''' + zdyhid +'''))'+ //未被呼叫过要指定医生
               ' or (jzbz=0))'+ //已被呼叫过，则不用指定医生
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
               ' order by t_dhxx.jzbz desc,t_dhxx.kssxid ';
          end
          else
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6,yksdm from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.id=' + strCallNo +
//               ' and t_dhxx.jzbz in (0,1)'+
               ' and (t_dhxx.jzbz=1 or (t_dhxx.jzbz=0))'+
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
               ' order by t_dhxx.jzbz desc,t_dhxx.kssxid ';
          end;
          ////////////
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
              jrid:=fields.Fields[0].AsString;
              if (yhcancall(jrid,zdyhid,ksbrdys)) then  //如果当前医生可以呼叫此病人，则呼叫，否则不呼叫//
              begin
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;

                tmpadoquery:=Tadoquery.Create(nil);
                tmpadoquery.Connection:=adoconnection;
                tmpadoquery.SQL.Clear;
                tmpadoquery.SQL.Text:=' select 1 from  ' +
               ' t_dhxx ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and jzbz<>''0'' ';
                tmpadoquery.Open;
                DDrs:=tmpadoquery.RecordCount;
                tmpadoquery.Close;
                FreeAndNil(tmpadoquery);

                JZBZ:=fields.fields[7].asstring;
                brdm:=fields.fields[8].asstring;
                by4:=fields.fields[9].asstring;
                by6:=fields.fields[10].asstring;
                yksdm:=fields.fields[11].asstring;
                if jzbz='0' then
                   DDRs:=DDRs
                else
                   DDRs:=DDrs-1;
                if (cmd='90') or (cmd='93') then
                begin
                  retstr:=ghhm;
                  if length(retstr)=0 then
                     retstr:='0000'
                  else if length(retstr)=1 then
                     retstr:='000'+retstr
                  else if length(retstr)=2 then
                     retstr:='00'+retstr
                  else if length(retstr)=3 then
                     retstr:='0'+retstr
                  else
                     retstr:=RightStr(retstr,4);
                   result:=zdid +cmd  +'01' + retstr;
                end
                else if (cmd='40') or (cmd='57') or (cmd='43') then
                  result:=zdid +cmd  +getstrwithnotbadcode(hjks[i].TGroupName,8)+'人数'+ getstrwithnotbadcode(inttostr(DDRS),3)+
                          getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5)
                 else
                 begin
                   if yksdm<>'' then
                     result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+yksdm
                   else
                     result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid;
                 end;
                gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid;
                gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;
                gbledit_ks_count:=gbledit_ks_count+1;

                // 修改T_DHXX中的顺序.
                if jzbz<>'0' then
                begin
//                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                        ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
//                        ' and ksid=''' +hjks[i].TGroupid + '''' +
//                        ' and hszh=' + inttostr(gblHszh);
//                  adoconnection.Execute(cmdstr ,cmdText);
//                  //将这个科室已呼叫过的病人的kssxid-1
//                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                          ' where jzbz=0'+
//                          ' and ksid=''' +hjks[i].TGroupid + '''' +
//                          ' and hszh=' + inttostr(gblHszh);
//                  adoconnection.Execute(cmdstr ,cmdText);
//
//                   //修改T_dhxx中的数据，将本条数据改为就诊
//                  cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
//                          ' ,yhid='''+ ZDyhid +''''+
//                          ' ,kssxid=0' +
//                          ' ,ckhm='+fjh+
//                          ' ,jzsj=getdate()' +
//                          ' where id=' + jrid ;
//                  adoconnection.Execute(cmdstr ,cmdText);
                    doUpdatewaitlistpos(hjks[i].TGroupid,jrid,zdyhid,fjh,gblhszh);
                end
                else
                begin
                   //修改T_dhxx中的数据，将本条数据改为就诊
                  cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
                          ' ,yhid='''+ ZDyhid +''''+
                          ' ,ckhm='+fjh+
                          ' ,jzsj=getdate()' +
                          ' where id=' + jrid ;
                  adoconnection.Execute(cmdstr ,cmdText);
                end;
                DB_SetHisPatientStatus(jrid);
                //并将数据放入显示信息表中
                if (cmd='90') or (cmd='D9') or (cmd='40') or (cmd='57') or (cmd='93') or (cmd='43') then
                    if  (cmd='93') or (cmd='43') then
                      WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,'',BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,'','',by4+'|')
                    else
                      WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,'','',by4+'|')
                else
                    WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,'',BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,'','',by4+'|');
                iscall:=true;
                //呼叫成功
                doLockOtherGroupSamePat(jrid);
                addyhcancall(jrid,zdyhid,'-1');   //插入排除医生信息
                {///修改HIS接口中的数据.
                CREATE procedure usp_yf_jk_dpkz
                 @yfdm  ut_ksdm,  --药房代码
                 @yflsh  integer,  --药房流水号
                 @spxpbz  integer   --上屏下屏标志0上屏1下屏
                exec usp_yf_jk_dpkz '4041',9,1  }
                if NeedUpdateHis=1 then
                begin
                   with frmmain.ADOStoredProcHis do
                   begin
                      try
                      ProcedureName:='usp_yf_jk_dpkz';
                      Parameters.Clear;
                      Parameters.CreateParameter('yfdm',
                        ftString, pdInput, 10, hjks[i].TGroupid);
                      Parameters.CreateParameter('yflsh',
                        ftInteger, pdInput, 4, strtoint(ghhm));
                      Parameters.CreateParameter('spxpbz',
                        ftInteger, pdInput, 4, 0);
                      ExecProc;
                      Close;
                      except
                          on E:exception do
                             dmdbaccess.addlog('ErrorLog.txt',datetimetostr(now)+' '+ E.message+' 更新HIS标志失败');
                      end;
                   end;
                end;

              end
              else
              begin
                iscall := false;
              end;
              close;
            end;
          end;
       end;
       if iscall=false  then
        begin
         if (cmd='40') or (cmd='57') then
          result:=zdid +cmd  +'选呼没有成功!  '+'未找到此号码! '
         else
          result:=zdid +cmd  +'000000'  ;
        end;
    end;
  except
    begin
       if (cmd='40') or (cmd='57') then
        result:=zdid +cmd  +'选呼没有成功!  '+'操作时有错误! '
       else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHSelCallBrdm;
                                           *
*函数机能:选择选呼.                                          *
*******************************************************************************}

function TdmDBAccess.YHSelCallBrdm(const zdid:string;const cmd:string;const CallNO :string):string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array[1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   tmpadoquery:Tadoquery;
   by6:string;
   ksbrdys:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
   //gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             if (cmd='40') or (cmd='57') then
              result:=zdid +cmd  +'还没有登录!    '+'请登录工号    '
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
       end
       else
       begin
           if (cmd='40') or (cmd='57') then
            result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置  '
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             if (cmd='40') or (cmd='57') then
              result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置! '
             else
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           if (cmd='40') or (cmd='57') then
            result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置  '
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    //修改呼叫终端状态
     adoconnection.Execute('update t_hjzd set state=''选呼'''+
        ',calltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);

    ////查找此科室的病人.
    if hjksnum>0 then
    begin
       for i:=1 to hjksnum do
       begin
//          cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
          ////////根据是不否使用选医生功能.
          if iscall then
              break;
          ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
          if ksbrdys='' then ksbrdys:='0';
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          //if gblBRDYS=1 then
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.brdm=''' + callno + ''''+
               ' and ((jzbz=1 and (yhid='''' or yhid is null or yhid =''' + zdyhid +'''))'+ //未被呼叫过要指定医生
               ' or (jzbz=0))'+ //已被呼叫过，则不用指定医生
               //' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
               ' order by jzbz desc,t_dhxx.kssxid ';
          end
          else
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.brdm=''' + callno + ''''+
               ' and (t_dhxx.jzbz=1 or (t_dhxx.jzbz=0))'+
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
               ' order by jzbz desc,t_dhxx.kssxid ';
          end;
          ////////////
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                tmpadoquery:=Tadoquery.Create(nil);
                tmpadoquery.Connection:=adoconnection;
                tmpadoquery.SQL.Clear;
                tmpadoquery.SQL.Text:=' select 1 from  ' +
               ' t_dhxx ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and jzbz<>''0'' ';
                tmpadoquery.Open;
                DDrs:=tmpadoquery.RecordCount;
                tmpadoquery.Close;
                FreeAndNil(tmpadoquery);

                JZBZ:=fields.fields[7].asstring;
                brdm:=fields.fields[8].asstring;
                by4:=fields.fields[9].asstring;
                by6:=fields.fields[10].asstring;
                if jzbz='0' then
                   DDRs:=DDRs
                else
                   DDRs:=DDrs-1;
                if (cmd='90') or (cmd='93') then
                begin
                  retstr:=ghhm;
                  if length(retstr)=0 then
                     retstr:='0000'
                  else if length(retstr)=1 then
                     retstr:='000'+retstr
                  else if length(retstr)=2 then
                     retstr:='00'+retstr
                  else if length(retstr)=3 then
                     retstr:='0'+retstr
                  else
                     retstr:=RightStr(retstr,4);
                   result:=zdid +cmd  +'01' + retstr;
                end
                else if (cmd='40') or (cmd='57') then
                  result:=zdid +cmd  +getstrwithnotbadcode(hjks[i].TGroupName,8)+'人数'+ getstrwithnotbadcode(inttostr(DDRS),3)+
                          getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5)
                 else
                   result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid;
                gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid;
                gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;
                gbledit_ks_count:=gbledit_ks_count+1;

                // 修改T_DHXX中的顺序.
                if jzbz<>'0' then
                begin
//                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                        ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
//                        ' and ksid=''' +hjks[i].TGroupid + '''' +
//                        ' and hszh=' + inttostr(gblHszh);
//                  adoconnection.Execute(cmdstr ,cmdText);
//                  //将这个科室已呼叫过的病人的kssxid-1
//                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                          ' where jzbz=0'+
//                          ' and ksid=''' +hjks[i].TGroupid + '''' +
//                          ' and hszh=' + inttostr(gblHszh);
//                  adoconnection.Execute(cmdstr ,cmdText);
//                   //修改T_dhxx中的数据，将本条数据改为就诊
//                  cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
//                          ' ,yhid='''+ ZDyhid +''''+
//                          ' ,kssxid=0' +
//                          ' ,ckhm='+fjh+
//                          ' ,jzsj=getdate()' +
//                          ' where id=' + jrid ;
//                  adoconnection.Execute(cmdstr ,cmdText);
                     doUpdatewaitlistpos(hjks[i].TGroupid,jrid,ZDyhid,fjh,gblhszh);
                end
                else
                begin
                   //修改T_dhxx中的数据，将本条数据改为就诊
                  cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
                          ' ,yhid='''+ ZDyhid +''''+
                          ' ,ckhm='+fjh+
                          ' ,jzsj=getdate()' +
                          ' where id=' + jrid ;
                  adoconnection.Execute(cmdstr ,cmdText);
                end;
                //并将数据放入显示信息表中
                if (cmd='FA') or (cmd='90') or (cmd='D9') or (cmd='40') or (cmd='57') or (cmd='93') then
                    WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName
                      ,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,'','',by4+'|')
                else
                    WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName
                      ,'',BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,'','',by4+'|');
                iscall:=true;
                {///修改HIS接口中的数据.
                CREATE procedure usp_yf_jk_dpkz
                 @yfdm  ut_ksdm,  --药房代码
                 @yflsh  integer,  --药房流水号
                 @spxpbz  integer   --上屏下屏标志0上屏1下屏
                exec usp_yf_jk_dpkz '4041',9,1  }
                if NeedUpdateHis=1 then
                begin
                   with frmmain.ADOStoredProcHis do
                   begin
                      try
                      ProcedureName:='usp_yf_jk_dpkz';
                      Parameters.Clear;
                      Parameters.CreateParameter('yfdm',
                        ftString, pdInput, 10, hjks[i].TGroupid);
                      Parameters.CreateParameter('yflsh',
                        ftInteger, pdInput, 4, strtoint(ghhm));
                      Parameters.CreateParameter('spxpbz',
                        ftInteger, pdInput, 4, 0);
                      ExecProc;
                      Close;
                      except
                          on E:exception do
                             dmdbaccess.addlog('ErrorLog.txt',datetimetostr(now)+' '+ E.message+' 更新HIS标志失败');
                      end;
                   end;
                end;

            end;
            close;
          end;

       end;
       if iscall=false  then
          begin
           if (cmd='40') or (cmd='57') then
            result:=zdid +cmd  +'选呼没有成功!  '+'未找到此号码! '
           else
            result:=zdid +cmd  +'000000'  ;
          end;
    end;
  except
    begin
       if (cmd='40') or (cmd='57') then
        result:=zdid +cmd  +'选呼没有成功!  '+'操作时有错误! '
       else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHBreakCall;
                                           *
*函数机能:消号.                                          *
*******************************************************************************}

function TdmDBAccess.YHBreakCall(const zdid:string;const cmd:string;const aCallNO :string):string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array[1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   by6,by4:string;
   ksbrdys:string;
   qr:TADOQuery;
   CallNO:string;
   callksid:string;
begin
  callno := acallno;
  if pos(',',callno)>0 then  //如果带呼叫科室，则要根据科室来查询病人，否则按号码查询
  begin
    callno  := AnsiReplaceStr(callno,',','|');
    callksid := getpartstr(callno+'|','2');
    callno := getpartstr(callno,'1');
  end;
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
   //gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    qr.Close;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
       end
       else
       begin
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    ////查找此科室的病人.
    if hjksnum>0 then
    begin
       for i:=1 to hjksnum do
       begin
//          cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
          ////////根据是不否使用选医生功能.
          if iscall then
              break;
          if (callksid<>'') and (callksid<> hjks[i].TGroupid) then //如果按科室查询则判断科室是否相同，不相同则跳到下一科室。
          begin
            continue;
          end;
          ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
          if ksbrdys='' then ksbrdys:='0';
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          //if gblBRDYS=1 then
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,by6,by4 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.ghhm=''' + callno + ''''+
               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
               ' order by t_dhxx.kssxid ';
          end
          else
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,by6,by4 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.ghhm=''' + callno + ''''+
               ' order by t_dhxx.kssxid ';
          end;
          ////////////
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                DDRs:=RecordCount-1;
                JZBZ:=fields.fields[7].asstring;
                by6:=fields.Fields[8].AsString;
                by4:=fields.fields[9].asstring;
                if (cmd='71') or (cmd='21') then
                begin
                  retstr:=ghhm;
                  if length(retstr)=0 then
                     retstr:='0000'
                  else if length(retstr)=1 then
                     retstr:='000'+retstr
                  else if length(retstr)=2 then
                     retstr:='00'+retstr
                  else if length(retstr)=3 then
                     retstr:='0'+retstr
                  else
                     retstr:=RightStr(retstr,4);//copy(retstr,1,4);
                   result:=zdid +cmd  +'01' + '9999';
                end
                else
                   result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS);

                // 修改T_DHXX中的顺序.
                if jzbz<>'0' then
                begin
                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                        ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
                        ' and ksid=''' +hjks[i].TGroupid + '''' +
                        ' and hszh=' + inttostr(gblHszh);
                  adoconnection.Execute(cmdstr ,cmdText);
                  //将这个科室已呼叫过的病人的kssxid-1
                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                          ' where jzbz=0'+
                          ' and ksid=''' +hjks[i].TGroupid + '''' +
                          ' and hszh=' + inttostr(gblHszh);
                  adoconnection.Execute(cmdstr ,cmdText);
                  gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid;
                  gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;
                  gbledit_ks_count:=gbledit_ks_count+1;
                end;
                 //修改T_dhxx中的数据，将本条数据改为就诊
                cmdstr:=' UPDATE t_dhxx SET JZBZ=0' +
                        ' ,yhid='''+ ZDyhid +''''+
                        ' ,ckhm='+fjh+
                        ' ,kssxid=0' +
                        ' ,ztbz=7'+
                        ' ,jzsj=getdate()' +
                        ' where id=' + jrid ;
                adoconnection.Execute(cmdstr ,cmdText);
                DB_SetHisPatientStatus(jrid);
                //并将数据放入显示信息表中  t_xsxx.ztbz=2
                WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName
                  ,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,2,'','',by4+'|');
                if NeedUpdateHis=1 then
                begin
                   with frmmain.ADOStoredProcHis do
                   begin
                      try
                      ProcedureName:='usp_yf_jk_dpkz';
                      Parameters.Clear;
                      Parameters.CreateParameter('yfdm',
                        ftString, pdInput, 10, hjks[i].TGroupid);
                      Parameters.CreateParameter('yflsh',
                        ftInteger, pdInput, 4, strtoint(ghhm));
                      Parameters.CreateParameter('spxpbz',
                        ftInteger, pdInput, 4, 1);
                      ExecProc;
                      Close;
                      except
                          on E:exception do
                             dmdbaccess.addlog('ErrorLog.txt',datetimetostr(now)+' '+ E.message+' 更新HIS标志失败'+'1');
                      end;
                   end;
                end;
                iscall:=true;
            end;
            close;
          end;

       end;
       if iscall=false  then
          begin
            result:=zdid +cmd  +'000000'  ;
          end;
    end;
  except
    begin
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHBreakCallBrdm;
                                           *
*函数机能:按BRDM消号.                                          *
*******************************************************************************}

function TdmDBAccess.YHBreakCallBrdm(const zdid:string;const cmd:string;const CallNO :string):string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   ksid,kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   by6,by4:string;
   ksbrdys:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
   //gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
       end
       else
       begin
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    ////查找此科室的病人.
    if hjksnum>0 then
    begin
       for i:=1 to hjksnum do
       begin
          ////////根据是不否使用选医生功能.
          if iscall then
              break;
          ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
          if ksbrdys='' then ksbrdys:='0';
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,by6,by4 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               //' where ksid=''' + hjks[i].TGroupid +''''+
               ' where t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.brdm=''' + callno + ''''+
               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
               //' and t_dhxx.jzbz=1'+
               ' order by t_dhxx.kssxid ';
          end
          else
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,by6,by4 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               //' where ksid=''' + hjks[i].TGroupid +''''+
               ' where t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.brdm=''' + callno + ''''+
               //' and t_dhxx.jzbz=1'+
               ' order by t_dhxx.kssxid ';
          end;
          ////////////
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                ksid :=fields.fields[6].asstring;
                DDRs:=RecordCount-1;
                JZBZ:=fields.fields[7].asstring;
                by6:=fields.Fields[8].AsString;
                by4:=fields.fields[9].asstring;
                if cmd='87' then
                begin
                  retstr:=ghhm;
                  if length(retstr)=0 then
                     retstr:='0000'
                  else if length(retstr)=1 then
                     retstr:='000'+retstr
                  else if length(retstr)=2 then
                     retstr:='00'+retstr
                  else if length(retstr)=3 then
                     retstr:='0'+retstr
                  else
                     retstr:=RightStr(retstr,4);
                   result:=zdid +cmd  +'01' + '9999';
                end
                else
                   result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS);

                // 修改T_DHXX中的顺序.
                if jzbz<>'0' then
                begin
                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                        ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
                        ' and ksid=''' +ksid + '''' +
                        ' and hszh=' + inttostr(gblHszh);
                  adoconnection.Execute(cmdstr ,cmdText);
                  //将这个科室已呼叫过的病人的kssxid-1
                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                          ' where jzbz=0'+
                          ' and ksid=''' +hjks[i].TGroupid + '''' +
                          ' and hszh=' + inttostr(gblHszh);
                  adoconnection.Execute(cmdstr ,cmdText);
                  gbledit_ks[gbledit_ks_count].ksid:=ksid;
                  gbledit_ks[gbledit_ks_count].ksmc:=ksid;
                  gbledit_ks_count:=gbledit_ks_count+1;
                end;
                 //修改T_dhxx中的数据，将本条数据改为就诊
                cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
                        ' ,yhid='''+ ZDyhid +''''+
                        ' ,ckhm='+fjh+
                        ' ,kssxid=0' +
                        ' ,ztbz=7'+
                        ' ,jzsj=getdate()' +
                        ' where id=' + jrid ;
                adoconnection.Execute(cmdstr ,cmdText);
                //并将数据放入显示信息表中
                iscall:=true;
            end;
            close;
          end;

       end;
       if iscall=false  then
          begin
            result:=zdid +cmd  +'000000'  ;
          end;
    end;
  except
    begin
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHGoCheckBrdm;
                                           *
*函数机能:按BRDM改状态.                                          *
*******************************************************************************}

function TdmDBAccess.YHGoCheckBrdm(const zdid:string;const cmd:string;const CallNO :string):string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array[1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   by6,by4:string;
   ksbrdys:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
   //gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
       end
       else
       begin
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    ////查找此科室的病人.
    if hjksnum>0 then
    begin
       for i:=1 to hjksnum do
       begin
//          cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
          ////////根据是不否使用选医生功能.
          if iscall then
              break;
          ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
          if ksbrdys='' then ksbrdys:='0';
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          //if gblBRDYS=1 then
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,by6,by4 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.brdm=''' + callno + ''''+
               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
               ' order by t_dhxx.kssxid ';
          end
          else
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,by6,by4 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.brdm=''' + callno + ''''+
               ' order by t_dhxx.kssxid ';
          end;
          ////////////
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                DDRs:=RecordCount-1;
                JZBZ:=fields.fields[7].asstring;
                by6:=fields.Fields[8].AsString;
                by4:=fields.fields[9].asstring;
                if cmd='87' then
                begin
                  retstr:=ghhm;
                  if length(retstr)=0 then
                     retstr:='0000'
                  else if length(retstr)=1 then
                     retstr:='000'+retstr
                  else if length(retstr)=2 then
                     retstr:='00'+retstr
                  else if length(retstr)=3 then
                     retstr:='0'+retstr
                  else
                     retstr:=RightStr(retstr,4);
                   result:=zdid +cmd  +'01' + '9999';
                end
                else
                   result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS);

                // 修改T_DHXX中的顺序.
                if jzbz<>'0' then
                begin
                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                        ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
                        ' and ksid=''' +hjks[i].TGroupid + '''' +
                        ' and hszh=' + inttostr(gblHszh);
                  adoconnection.Execute(cmdstr ,cmdText);
                  //将这个科室已呼叫过的病人的kssxid-1
                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                          ' where jzbz=0'+
                          ' and ksid=''' +hjks[i].TGroupid + '''' +
                          ' and hszh=' + inttostr(gblHszh);
                  adoconnection.Execute(cmdstr ,cmdText);
                  gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid;
                  gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;
                  gbledit_ks_count:=gbledit_ks_count+1;
                end;
                 //修改T_dhxx中的数据，将本条数据改为就诊
                cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
                        ' ,yhid='''+ ZDyhid +''''+
                        ' ,ckhm='+fjh+
                        ' ,kssxid=0' +
                        ' ,ztbz=8'+
                        ' ,jzsj=getdate()' +
                        ' where id=' + jrid ;
                adoconnection.Execute(cmdstr ,cmdText);
                //并将数据放入显示信息表中
                //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,2,'','',by4+'|');
                iscall:=true;
            end;
            close;
          end;

       end;
       if iscall=false  then
          begin
            result:=zdid +cmd  +'000000'  ;
          end;
    end;
  except
    begin
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHSelCall1;
                                           *
*函数机能:选择选呼. 只呼叫不改变就诊状态                                         *
*******************************************************************************}

function TdmDBAccess.YHSelCall1(const zdid:string;const cmd:string;const CallNO :string):string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array[1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   by6:string;
   ksbrdys:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
   //gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
       end
       else
       begin
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    ////查找此科室的病人.
    if hjksnum>0 then
    begin
       for i:=1 to hjksnum do
       begin
//          cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
          ////////根据是不否使用选医生功能.
          if iscall then
              break;
          ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
          if ksbrdys='' then ksbrdys:='0';
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          //if gblBRDYS=1 then
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.ghhm=''' + callno + ''''+
               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
               ' order by t_dhxx.kssxid ';
          end
          else
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.ghhm=''' + callno + ''''+
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
               ' order by t_dhxx.kssxid ';
          end;
          ////////////
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                DDRs:=RecordCount-1;
                JZBZ:=fields.fields[7].asstring;
                brdm:= fields.fields[8].asstring;
                by4:=fields.fields[9].asstring;
                by6:=fields.Fields[10].AsString;
                if cmd='90' then
                begin
                  retstr:=ghhm;
                  if length(retstr)=0 then
                     retstr:='0000'
                  else if length(retstr)=1 then
                     retstr:='000'+retstr
                  else if length(retstr)=2 then
                     retstr:='00'+retstr
                  else if length(retstr)=3 then
                     retstr:='0'+retstr
                  else
                     retstr:=RightStr(retstr,4);
                   result:=zdid +cmd  +'01' + retstr;
                end
                else
                   result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid;
               { //gbledit_ks[gbledit_ks_count].ksid:=hjksid[i];
                //gbledit_ks[gbledit_ks_count].ksmc:=hjksmc[i];
                //gbledit_ks_count:=gbledit_ks_count+1;
                 //修改T_dhxx中的数据，将本条数据改为就诊
                cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
                        ' ,yhid='''+ ZDyhid +''''+
                        ' ,kssxid=0' +
                        ' ,jzsj=''' + cdatetostr(date) +' '+  ctimetostr(time) + '''' +
                        ' where id=' + jrid ;
                adoconnection.Execute(cmdstr ,cmdText);
                // 修改T_DHXX中的顺序.
                if jzbz<>'0' then
                begin
                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                        ' where kssxid >=' + kssxid +
                        ' and ksid=''' +hjksid[i] + '''' +
                        ' and hszh=' + inttostr(gblHszh);
                  adoconnection.Execute(cmdstr ,cmdText);
                end;   }
                //并将数据放入显示信息表中
                WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,'','',by4+'|');

                iscall:=true;
            end;
            close;
          end;

       end;
       if iscall=false  then
          begin
            result:=zdid +cmd  +'000000'  ;
          end;
    end;
  except
    begin
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHReBackCall;
                                           *
*函数机能:召回.                                          *
*******************************************************************************}

function TdmDBAccess.YHReBackCall(const zdid:string;const cmd:string;const CallNO :string):string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   ksbrdys:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
   //gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
       end
       else
       begin
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    ////查找此科室的病人.
    if hjksnum>0 then
    begin
       for i:=1 to hjksnum do
       begin
//          cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
          ////////根据是不否使用选医生功能.
          if iscall then
              break;
          ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
          if ksbrdys='' then ksbrdys:='0';
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          //if gblBRDYS=1 then
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.ghhm=''' + callno + ''''+
               ' and t_dhxx.jzbz=0' +
               ' and t_dhxx.ztbz<>7'+
               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
               ' order by t_dhxx.kssxid ';
          end
          else
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.ghhm=''' + callno + ''''+
               ' and t_dhxx.jzbz=0' +
               ' and t_dhxx.ztbz<>7'+
               ' order by t_dhxx.kssxid ';
          end;
          ////////////
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                DDRs:=RecordCount-1;
                JZBZ:=fields.fields[7].asstring;
                if cmd='90' then
                begin
                  retstr:=ghhm;
                  if length(retstr)=0 then
                     retstr:='0000'
                  else if length(retstr)=1 then
                     retstr:='000'+retstr
                  else if length(retstr)=2 then
                     retstr:='00'+retstr
                  else if length(retstr)=3 then
                     retstr:='0'+retstr
                  else
                     retstr:=RightStr(retstr,4);
                   result:=zdid +cmd  +'01' + retstr;
                end
                else
                   result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS);

                if fzzh(jrid,hjks[i].TGroupid,1,'',1) then
                begin
                  gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid;
                  gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;
                  gbledit_ks_count:=gbledit_ks_count+1;
                end;
               {  //修改T_dhxx中的数据，将本条数据改为就诊

                cmdstr:=' UPDATE t_dhxx SET JZBZ=''1''' +
                        ' ,yhid='''+ ZDyhid +''''+
                        ' ,kssxid=1' +
                        ' ,jzsj=''' + cdatetostr(date) +' '+  ctimetostr(time) + '''' +
                        ' where id=' + jrid ;
                adoconnection.Execute(cmdstr ,cmdText);
                kssxid:=1;
                // 修改T_DHXX中的顺序.
                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
                        ' where kssxid >=' + kssxid +
                        ' and ksid=''' +hjksid[i] + '''' +
                        ' and hszh=' + inttostr(gblHszh);
                  adoconnection.Execute(cmdstr ,cmdText);
                //并将数据放入显示信息表中
                //WriteDispMsgTT(zdid,fjh,fjmc,zth,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,DDRS);
                }
                iscall:=true;
            end;
            close;
          end;

       end;
       if iscall=false  then
          begin
            result:=zdid +cmd  +'000000'  ;
          end;
    end;
  except
    begin
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHRequst;
                                           *
*函数机能:.                                          *
*******************************************************************************}
function TdmDBAccess.YHRequst(const zdid:string;const cmd:string):string;
begin
    result:='';
end;
{*******************************************************************************
*函数名:GetSendList;
                                           *
*函数机能:得到病人等待列表..                                          *
*******************************************************************************}
function TdmDBAccess.GetSendList(const zdid:string;const cmd:string):string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,yhmc,YXJID,yxjmc,JZBZ,ztbz,by6,ksid,ksmc,brdm,by4:string;
   by7,mzh,xb,nl,strghsj,xmsp,sjdmc:string;
   DDRS:integer;
   iscall :boolean;
   listwaitNum:integer;//在等待的病人数
   listcallnum:integer;//已呼叫的病人数
   listStrWait:string;   //在等待的病人列表
   listStrCall:string;   //已呼叫的病人列表
   ksbrdys:string;
   tmphjksstr:string;
   qr:TADOQuery;
   waitlisttype:integer;
   hjfs:integer;
begin

  try
    waitlisttype := strtoint(getdbvalue('HJZD',zdid,'waitlisttype'));
  except
    waitlisttype :=0;
  end;

  if waitlisttype=0 then
    waitlisttype:=gblwaitlisttype;

//  if waitlisttype=4 then//直接返回按ghhm排序的病人列表  (目前9院门诊在用)
//  begin
//    Result := GetSendListOrderByGHHM(zdid,cmd);
//    Exit;
//  end;
//  if waitlisttype=5 then//直接返回按顺序id排序的病人列表  (目前9院门诊在用)
//  begin
//    Result := GetSendListOrderBySXID(zdid,cmd);
//    Exit;
//  end;
//  if waitlisttype=6 then//直接返回按ghsj排序的病人列表  (目前9院门诊在用)
//  begin
//    Result := GetSendListOrderByGHSJ(zdid,cmd);
//    Exit;
//  end;
  qr := TADOQuery.Create(nil);
  try
  try
    qr.Connection := ADOConnection;

    result:='';
    listStrWait:='' ;
    listStrCall:='';
    listwaitnum:=0;
    listcallnum:=0;
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text :=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
         begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          //fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             result:=zdid+cmd + '028888';///没有登录.
             close;
             //qr.Free;
             exit;
             end;
          end
       else
         begin
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           //qr.Free;
           exit;
         end;
    end;
    //修改当  waitlisttype=4,5,6时，判断员工的呼叫方式，并按呼叫方式返回等待队列.
    if ((waitlisttype=4) or (waitlisttype=5) or (waitlisttype=6)) then
    begin
      //hjfs:=DB_GetHJFS(gblhszh,zdyhid);
      if waitlisttype=4 then//直接返回按ghhm排序的病人列表  (目前9院门诊在用)
      begin
        Result := GetSendListOrderByGHHM(zdid,cmd);
      end;
      if waitlisttype=5 then//直接返回按顺序id排序的病人列表  (目前9院门诊在用)
      begin
        Result := GetSendListOrderBySXID(zdid,cmd);
      end;
      if waitlisttype=6 then//直接返回按ghsj排序的病人列表  (目前9院门诊在用)
      begin
        Result := GetSendListOrderByGHSJ(zdid,cmd);
      end;
//      hjfs:=DB_GetHJFS(gblhszh,zdyhid);
//      if hjfs=2 then//直接返回按ghhm排序的病人列表  (目前9院门诊在用)
//      begin
//        Result := GetSendListOrderByGHHM(zdid,cmd);
//      end;
//      if hjfs=1 then//直接返回按顺序id排序的病人列表  (目前9院门诊在用)
//      begin
//        Result := GetSendListOrderBySXID(zdid,cmd);
//      end;
//      if hjfs=3 then//直接返回按ghsj排序的病人列表  (目前9院门诊在用)
//      begin
//        Result := GetSendListOrderByGHSJ(zdid,cmd);
//      end;
      exit;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             qr.Close;
             //qr.Free;
             exit;
           end;
           close;
       end
       else
       begin
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           //qr.Free;
           exit;
       end;
    end;
    ////查找T_DHXX表中此科室的病人.
    tmphjksstr:='';
    if hjksnum>0 then
    begin
       tmphjksstr:=''''+hjks[1].TGroupid+'''';
       for i:=1 to hjksnum do
       begin
          if i>1 then
            tmphjksstr:=tmphjksstr+','''+hjks[i].TGroupid+'''';
          if WaitListType<>3 then
          begin
          ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
          if ksbrdys='' then ksbrdys:='0';
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          //if gblbrdys=1 then
          begin
            if WaitListType=1 then
            begin
              if gblhavemzh=1 then
              begin
                cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                   ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
                   ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                   ' left OUTER join t_yh on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                   ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                   ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                   ' and jzbz<>0'+
                   ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                   ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                   ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                   ' order by t_dhxx.kssxid,JZSJ DESC ';
              end
              else
              begin
                cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                   ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
                   ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                   ' left OUTER join t_yh on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                   ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                   ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                   ' and jzbz<>0'+
                   ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                   ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                   ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                   ' order by t_dhxx.kssxid,JZSJ DESC ';
              end;
            end
            else
            begin
              if gblhavemzh=1 then
              begin
                cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
                     ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                     ' and jzbz<>0'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     ' order by t_dhxx.kssxid,JZSJ DESC ';
              end
              else
              begin
                cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
                     ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                     ' and jzbz<>0'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     ' order by t_dhxx.kssxid,JZSJ DESC ';
              end;
            end;
          end
          else
          begin
            if gblhavemzh=1 then
            begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                   ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
                   ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                   ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                   ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                   ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                   ' and jzbz<>0'+
                   ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                   ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                   ' order by t_dhxx.kssxid,JZSJ DESC ';
            end
            else
            begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                   ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
                   ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                   ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                   ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                   ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                   ' and jzbz<>0'+
                   ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                   ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                   ' order by t_dhxx.kssxid,JZSJ DESC ';
            end;
          end;
          qr.SQL.Text := cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            while not qr.Eof  do
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                BRXM := ReplaceCallListPatName(BRXM);
                GHHM:=fields.fields[3].asstring;
                yhmc:=fields.fields[4].asstring;
                YXJID:=Fields.Fields[5].asString;
                yxjmc:=fields.fields[6].asstring;
                jzbz:=fields.Fields[7].asstring;
                ztbz:=fields.fields[8].asstring;
                by6:=fields.fields[9].asstring;
                brdm :=fields.fields[10].asstring;
                by4 := fields.fields[11].asstring;
                by7 := fields.fields[12].asstring;
                mzh :=fields.fields[13].asstring;
                xb :=fields.fields[14].asstring;
                nl :=fields.fields[15].asstring;
                strghsj := FormatDateTime('hh:nn',fields.fields[16].AsDateTime);
                xmsp :=fields.fields[17].asstring;
                sjdmc := fields.fields[18].asstring;
                begin
                   if listwaitnum<99 then
                   begin
//                     liststrwait := liststrwait +ghhm+spaces(4-length(ghhm)) +' '+
//                              GetStrWithnotBadCode(brxm,8);// brxm+spaces(8-length(brxm));
//                     liststrwait := liststrwait + GetStrWithnotBadCode(hjks[i].TGroupName,8);
//                     liststrwait := liststrwait + GetStrWithnotBadCode(by6,8);
//                     liststrwait:=liststrwait+GetStrWithnotBadCode(yxjmc,8);// yxjmc+spaces(8-length(yxjmc));
//                     liststrwait := liststrwait +  GetStrWithnotBadCode(yhmc,8);// yhmc+spaces(8-length(yhmc));
//                     If Ztbz = '1' Then
//                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)//  ttl_cz +spaces(8-length(ttl_cz))
//                     Else If ztbz= '2' Then
//                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)//  ttl_fz + spaces(8-length(ttl_fz))
//                     Else If ztbz= '5' Then
//                        liststrwait := liststrwait +GetStrWithnotBadCode('准  备',8)//  '准  备' + spaces(8-length('准  备'))
//                     Else If ztbz= '6' Then
//                        liststrwait := liststrwait +GetStrWithnotBadCode('未激活',8)//  '未激活' + spaces(8-length('未激活'))
//                     else if ztbz='7' then
//                        liststrwait := liststrwait +GetStrWithnotBadCode('已完成',8)//  '已完成' + spaces(8-length('已完成'))
//                     Else
//                        liststrwait := liststrwait +GetStrWithnotBadCode('未呼叫',8);// '未呼叫'+ spaces(8-length('未呼叫'));

                     liststrwait := liststrwait +ghhm+spaces(4-length(ghhm)) +' '+'^'+
                              brxm+spaces(8-length(brxm))+'^';
                     liststrwait := liststrwait + hjks[i].TGroupName+spaces(8-length(hjks[i].TGroupName))+'^';
                     liststrwait := liststrwait + by6+spaces(8-length(by6))+'^';//+spaces(8-length(by6));
                     liststrwait:=liststrwait+yxjmc+spaces(8-length(yxjmc))+'^';//+spaces(8-length(yxjmc));
                     liststrwait := liststrwait +yhmc+spaces(8-length(yhmc))+'^';//+spaces(8-length(yhmc));
                     If Ztbz = '1' Then
                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'//  ttl_cz +spaces(8-length(ttl_cz))
                     Else If ztbz= '2' Then
                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'//  ttl_fz + spaces(8-length(ttl_fz))
                     Else If ztbz= '5' Then
                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'//  '准  备' + spaces(8-length('准  备'))
                     Else If ztbz= '6' Then
                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'//  '未激活' + spaces(8-length('未激活'))
                     else if ztbz='7' then
                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'//  '已完成' + spaces(8-length('已完成'))
                     Else
                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';// '未呼叫'+ spaces(8-length('未呼叫'));
                     liststrwait := liststrwait + hjks[i].TGroupid+'^';
                     liststrwait := liststrwait + brdm+'^';
                     liststrwait := liststrwait + by4+'^';
                     liststrwait := liststrwait + strghsj+'^';
                     liststrwait := liststrwait + by7+'^';
                     liststrwait := liststrwait + xb+'^';
                     liststrwait := liststrwait + nl+'^';
                     liststrwait := liststrwait + mzh+'^';
                     liststrwait := liststrwait + ztbz+'^';
                     liststrwait := liststrwait + jrid+'^';
                     liststrwait := liststrwait + xmsp+'^';
                     liststrwait := liststrwait + sjdmc;
                     liststrwait := liststrwait + ';';
                     listwaitnum:=listwaitnum+1;
                   end;
                end;
                next;
            end;
          end;
          qr.Close;
         end;
       end;
       if waitlisttype=3 then
       begin
         listStrWait := GetWaitListByby7(tmphjksstr,listwaitnum);
       end;
       if tmphjksstr<>'' then
       begin
         if (gblHJBrPx=0) or (gblHJBrPx=1) or (gblHJBrPx=4) or (gblHJBrPx=5) then
         begin
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          //if gblbrdys=1 then
          begin
            if gblHJBrPx=0 then
            begin
              if gblhavemzh=1 then
              begin
             cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
//               ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by jzsj desc,replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end
              else
              begin
             cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
//               ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by jzsj desc,replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end;
            end
            else if gblHJBrPx=1 then
            begin
              if gblhavemzh=1 then
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
//               ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end
              else
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
//               ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end;
            end
            else if gblHJBrPx=5 then
            begin
              if gblhavemzh=1 then
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
               ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end
              else
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
               ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end;
            end
            else //if gblHJBrPx=4 then
            begin
              if gblhavemzh=1 then
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
               ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by jzsj desc,replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end
              else
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
               ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by jzsj desc,replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end;
            end;
          end
          else
          begin
            if gblHJBrPx=0 then
            begin
              if gblhavemzh=1 then
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by jzsj desc,replicate(''0'',10-len(ghhm))+ghhm DESC ';
//               ' order by replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end
              else
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by jzsj desc,replicate(''0'',10-len(ghhm))+ghhm DESC ';
//               ' order by replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end;
            end
            else if gblHJBrPx=1 then
            begin
              if gblhavemzh=1 then
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end
              else
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end;
            end
            else if gblHJBrPx=5 then
            begin
              if gblhavemzh=1 then
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
               ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end
              else
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
               ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end;
            end
            else //if gblHJBrPx=4 then
            begin
              if gblhavemzh=1 then
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
               ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by jzsj desc,replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end
              else
              begin
              cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
               ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
               ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
               ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
               ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
               ' where t_dhxx.ksid in (' + tmphjksstr +')'+
               ' and jzbz=0'+
               ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
               ' order by jzsj desc,replicate(''0'',10-len(ghhm))+ghhm DESC ';
              end;
            end;
          end;
          qr.SQL.Text := cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            while not qr.Eof  do
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                yhmc:=fields.fields[4].asstring;
                YXJID:=Fields.Fields[5].asString;
                yxjmc:=fields.fields[6].asstring;
                jzbz:=fields.Fields[7].asstring;
                ztbz:=fields.fields[8].asstring;
                by6:= fields.fields[9].asstring;
                ksid :=fields.fields[10].asstring;
                ksmc :=fields.fields[11].asstring;
                brdm :=fields.fields[12].asstring;
                by4 := fields.fields[13].asstring;
                by7 := fields.fields[14].asstring;
                mzh :=fields.fields[15].asstring;
                xb :=fields.fields[16].asstring;
                nl :=fields.fields[17].asstring;
                strghsj := FormatDateTime('hh:nn',fields.fields[18].AsDateTime);
                xmsp := fields.fields[19].asstring;
                sjdmc := fields.fields[20].asstring;
                begin
                   if listcallnum<99 then
                   begin
//                     liststrcall := liststrcall +ghhm+spaces(4-length(ghhm)) +' '+
//                              GetStrWithnotBadCode(brxm,8);
//                     liststrcall := liststrcall + GetStrWithnotBadCode(ksmc,8);
//                     liststrcall := liststrcall + GetStrWithnotBadCode(by6,8);//+spaces(8-length(by6));
//                     liststrcall:=liststrcall+GetStrWithnotBadCode(yxjmc,8);//+spaces(8-length(yxjmc));
//                     liststrcall := liststrcall +GetStrWithnotBadCode(yhmc,8);//+spaces(8-length(yhmc));
//                     if ztbz='7' then
//                        liststrcall := liststrcall + GetStrWithnotBadCode('已完成',8)
//                     else
//                        liststrcall := liststrcall + GetStrWithnotBadCode('已呼叫',8) ;
//                     liststrcall := liststrcall + ksid;
//                     liststrcall := liststrcall + ';';
                     //if ztbz<>'7' then  //2014-09-29 去掉 吴刚 //将所有数据都发过去
                     begin
                       liststrcall := liststrcall +ghhm+spaces(4-length(ghhm)) +' '+'^'+
                                GetStrWithnotBadCode(brxm,8)+'^';
                       liststrcall := liststrcall + GetStrWithnotBadCode(ksmc,8)+'^';
                       liststrcall := liststrcall + GetStrWithnotBadCode(by6,8)+'^';//+spaces(8-length(by6));
                       liststrcall:=liststrcall+GetStrWithnotBadCode(yxjmc,8)+'^';//+spaces(8-length(yxjmc));
                       liststrcall := liststrcall +GetStrWithnotBadCode(yhmc,8)+'^';//+spaces(8-length(yhmc));
                       if ztbz='7' then
                          liststrcall := liststrcall + GetStrWithnotBadCode('已完成',8)+'^'
                       else if ztbz='3' then
                          liststrcall := liststrcall + GetStrWithnotBadCode('已弃号',8)+'^'
                       else
                          liststrcall := liststrcall + GetStrWithnotBadCode('已呼叫',8)+'^' ;
                       liststrcall := liststrcall + ksid+'^';
                       liststrcall := liststrcall + brdm+'^';
                       liststrcall := liststrcall + by4+'^';
                       liststrcall := liststrcall + strghsj+'^';
                       liststrcall := liststrcall + by7+'^';
                       liststrcall := liststrcall + xb+'^';
                       liststrcall := liststrcall + nl+'^';
                       liststrcall := liststrcall + mzh+'^';
                       liststrcall := liststrcall + ztbz+'^';
                       liststrcall := liststrcall + jrid+'^';
                       liststrcall := liststrcall + xmsp+'^';
                       liststrcall := liststrcall + sjdmc;
                       liststrcall := liststrcall + ';';
                       listcallnum:=listcallnum+1;
                     end;
                   end;
                end;
                next;
            end;
          end;
          qr.Close;
        end
        else
        begin
           for i:=1 to hjksnum do
           begin
              if i>1 then
                tmphjksstr:=tmphjksstr+','''+hjks[i].TGroupid+'''';
              ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
              if ksbrdys='' then ksbrdys:='0';
              if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
              //if gblbrdys=1 then
              begin
                if gblHJBrPx=2 then
                begin
                  if gblhavemzh=1 then
                  begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,'+
                    't_yh.yhmc,t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
                   ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                   ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                   ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
                   ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                   ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                   ' and jzbz=0'+
                   ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                   ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                   ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                   ' order by jzsj desc,replicate(''0'',10-len(ghhm))+ghhm DESC ';
                  end
                  else
                  begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,'+
                    't_yh.yhmc,t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
                   ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                   ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                   ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
                   ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                   ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                   ' and jzbz=0'+
                   ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                   ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                   ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                   ' order by jzsj desc,replicate(''0'',10-len(ghhm))+ghhm DESC ';
                  end;
                end
                else
                begin
                  if gblhavemzh=1 then
                  begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,'+
                    't_yh.yhmc,t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
                   ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                   ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                   ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
                   ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                   ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                   ' and jzbz=0'+
                   ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                   ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                   ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                   ' order by replicate(''0'',10-len(ghhm))+ghhm DESC,jzsj desc';
                  end
                  else
                  begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,'+
                    't_yh.yhmc,t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
                   ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                   ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                   ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
                   ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                   ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                   ' and jzbz=0'+
                   ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                   ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                   ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+' order by replicate(''0'',10-len(ghhm))+ghhm DESC,jzsj desc';
                  end;
                end;

              end
              else
              begin
                if gblHJBrPx=2 then
                begin
                  if gblhavemzh=1 then
                  begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,'+
                   't_yh.yhmc,t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
                   ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                   ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
                   ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                   ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                   ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                   ' and jzbz=0'+
                   ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                   ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                   ' order by jzsj desc,replicate(''0'',10-len(ghhm))+ghhm DESC  ';
                  end
                  else
                  begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,'+
                   't_yh.yhmc,t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
                   ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                   ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
                   ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                   ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                   ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                   ' and jzbz=0'+
                   ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                   ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                   ' order by jzsj desc,replicate(''0'',10-len(ghhm))+ghhm DESC  ';
                  end;
                end
                else
                begin
                  if gblhavemzh=1 then
                  begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,'+
                   ' t_yh.yhmc,t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,mzh,xb,nl,ghsj,xmsp,sjdmc from  ' +
                   ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                   ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                   ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
                   ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                   ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                   ' and jzbz=0'+
                   ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                   ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                   ' order by replicate(''0'',10-len(ghhm))+ghhm DESC,jzsj desc';
                  end
                  else
                  begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,'+
                   ' t_yh.yhmc,t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.ksid,t_ks.ksmc,brdm,by4,'+
                   ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,xmsp,sjdmc from  ' +
                   ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                   ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                   ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
                   ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                   ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                   ' and jzbz=0'+
                   ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                   ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                   ' order by replicate(''0'',10-len(ghhm))+ghhm DESC,jzsj desc';
                  end;
                end;
              end;
              qr.SQL.Text := cmdstr;
              qr.Open;
              ///////////将中.
              with qr do
              begin
                while not qr.Eof  do
                begin
                    //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                    jrid:=fields.Fields[0].AsString;
                    kssxid:=fields.fields[1].asstring;
                    Brxm:=Fields.Fields[2].AsString;
                    GHHM:=fields.fields[3].asstring;
                    yhmc:=fields.fields[4].asstring;
                    YXJID:=Fields.Fields[5].asString;
                    yxjmc:=fields.fields[6].asstring;
                    jzbz:=fields.Fields[7].asstring;
                    ztbz:=fields.fields[8].asstring;
                    by6:=fields.fields[9].asstring;
                    ksid :=fields.fields[10].asstring;
                    ksmc :=fields.fields[11].asstring;
                    brdm :=fields.fields[12].asstring;
                    by4 := fields.fields[13].asstring;
                    by7 := fields.fields[14].asstring;
                    mzh :=fields.fields[15].asstring;
                    xb :=fields.fields[16].asstring;
                    nl :=fields.fields[17].asstring;
                    strghsj := FormatDateTime('hh:nn',fields.fields[18].AsDateTime);
                    xmsp :=fields.fields[19].asstring;
                    sjdmc :=fields.fields[20].asstring;
                    begin
                       if listcallnum<99 then
                       begin
    //                     liststrcall := liststrcall +ghhm+spaces(4-length(ghhm)) +' '+
    //                              GetStrWithnotBadCode(brxm,8);
    //                     liststrcall := liststrcall + GetStrWithnotBadCode(ksmc,8);
    //                     liststrcall := liststrcall + GetStrWithnotBadCode(by6,8);//+spaces(8-length(by6));
    //                     liststrcall:=liststrcall+GetStrWithnotBadCode(yxjmc,8);//+spaces(8-length(yxjmc));
    //                     liststrcall := liststrcall +GetStrWithnotBadCode(yhmc,8);//+spaces(8-length(yhmc));
    //                     if ztbz='7' then
    //                        liststrcall := liststrcall + GetStrWithnotBadCode('已完成',8)
    //                     else
    //                        liststrcall := liststrcall + GetStrWithnotBadCode('已呼叫',8) ;
    //                     liststrcall := liststrcall + ksid;
    //                     liststrcall := liststrcall + ';';
                         //if ztbz<>'7' then  //2014-09-29 去掉 吴刚 //将所有数据都发过去
                         begin
                           liststrcall := liststrcall +ghhm+spaces(4-length(ghhm)) +' '+'^'+
                                    GetStrWithnotBadCode(brxm,8)+'^';
                           liststrcall := liststrcall + GetStrWithnotBadCode(ksmc,8)+'^';
                           liststrcall := liststrcall + GetStrWithnotBadCode(by6,8)+'^';//+spaces(8-length(by6));
                           liststrcall:=liststrcall+GetStrWithnotBadCode(yxjmc,8)+'^';//+spaces(8-length(yxjmc));
                           liststrcall := liststrcall +GetStrWithnotBadCode(yhmc,8)+'^';//+spaces(8-length(yhmc));
                           if ztbz='7' then
                              liststrcall := liststrcall + GetStrWithnotBadCode('已完成',8)+'^'
                           else if ztbz='3' then
                              liststrcall := liststrcall + GetStrWithnotBadCode('已弃号',8)+'^'
                           else
                              liststrcall := liststrcall + GetStrWithnotBadCode('已呼叫',8)+'^' ;
                           liststrcall := liststrcall + ksid+'^';
                           liststrcall := liststrcall + brdm+'^';
                           liststrcall := liststrcall + by4+'^';
                           liststrcall := liststrcall + strghsj+'^';
                           liststrcall := liststrcall + by7+'^';
                           liststrcall := liststrcall + xb+'^';
                           liststrcall := liststrcall + nl+'^';
                           liststrcall := liststrcall + mzh+'^';
                           liststrcall := liststrcall + ztbz+'^';
                           liststrcall := liststrcall + jrid+'^';
                           liststrcall := liststrcall + xmsp+'^';
                           liststrcall := liststrcall + sjdmc;
                           liststrcall := liststrcall + ';';
                           listcallnum:=listcallnum+1;
                         end;
                       end;
                    end;
                    next;
                end;
              end;
              qr.Close;
           end;
        end;
       end;
       if listwaitnum>99 then
          listwaitnum:=99;
       if listcallnum>99 then
          listcallnum:=99;
       if (listwaitnum>0) or (listcallnum>0)  then
       begin
           result:=zdid + 'DD01'  + format('%2D',[listwaitnum]) +format('%2D',[listcallnum])+ liststrwait+ liststrcall;
       end
       else
       begin
            result:=zdid +'DD'  +'000000'  ;
       end;
     end
     else
        result:=zdid +'DD'  +'000000'  ;
     //qr.Free;
     exit;
  except
    begin
      result := zdid + cmd + '068888';  ///有错误发生.
      //qr.Free;
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:GetSendListOrderByGHHM;
                                           *
*函数机能:得到病人等待列表按号码从小到大排序                                          *
*******************************************************************************}
function TdmDBAccess.GetSendListOrderByGHHM(const zdid:string;const cmd:string):string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjfs:integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,yhmc,YXJID,yxjmc,JZBZ,ztbz,by6,ksid,ksmc,brdm,by4:string;
   by7,mzh,xb,nl,strghsj,xmsp,yhid,sjdmc:string;
   DDRS:integer;
   iscall :boolean;
   listwaitNum:integer;//在等待的病人数
   listcallnum:integer;//已呼叫的病人数
   listStrWait:string;   //在等待的病人列表
   listStrCall:string;   //已呼叫的病人列表
   ksbrdys:string;
   tmphjksstr:string;
   qr:TADOQuery;
   blsend:boolean;
begin
  qr := TADOQuery.Create(nil);
  try
  try
    qr.Connection := ADOConnection;

    result:='';
    listStrWait:='' ;
    listStrCall:='';
    listwaitnum:=0;
    listcallnum:=0;
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text :=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,hjfs from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;

    qr.Open;
    ///////////得到登录信息
    with qr do
    begin
       if not qr.Eof  then
       begin
        zdyhid:=fields.fields[4].asstring ;
        zdyhmc:=fields.fields[5].asstring;
        fjh:=fields.Fields[1].AsString;
        //fjmc:=fields.Fields[6].AsString;
        zth:=fields.Fields[2].AsString;
        ztmc:=fields.Fields[3].AsString;
        hjfs := fields.Fields[6].AsInteger;
        if ( zdyhid <>'')  then
           begin
           close;
           end
        else
           begin
           result:=zdid+cmd + '028888';///没有登录.
           close;
           //qr.Free;
           exit;
           end;
       end
       else
       begin
         result:=zdid + cmd + '038888';  ///没有此呼叫器
         close ;
         //qr.Free;
         exit;
         end;
    end;
    //在T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////
    with qr do
    begin
       if not qr.Eof  then
       begin
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             qr.Close;
             //qr.Free;
             exit;
           end;
           close;
       end
       else
       begin
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           //qr.Free;
           exit;
       end;
    end;
    ////查找T_DHXX表中此科室的病人.
    tmphjksstr:='';
    if hjksnum>0 then
    begin
       tmphjksstr:=''''+hjks[1].TGroupid+'''';
       for i:=1 to hjksnum do
       begin
          if i>1 then
            tmphjksstr:=tmphjksstr+','''+hjks[i].TGroupid+'''';
       end;
       tmphjksstr := '('+tmphjksstr+')';
       if hjfs=1 then
       begin
         for i:=1 to hjksnum do
         begin
            ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
            if ksbrdys='' then ksbrdys:='0';
            if (gblshowallwait=0) and (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
            //if gblbrdys=1 then
            begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,t_dhxx.yhid,sjdmc from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+' order by t_dhxx.sjdbz,replicate(''0'',10-len(ghhm))+ghhm,ghsj ';
            end
            else
            begin
                cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,t_dhxx.yhid,sjdmc from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+' order by t_dhxx.sjdbz, replicate(''0'',10-len(ghhm))+ghhm,ghsj';
            end;
            qr.SQL.Text := cmdstr;
            qr.Open;
            ///////////将中.
            with qr do
            begin
              while not qr.Eof  do
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  BRXM := ReplaceCallListPatName(BRXM);
                  GHHM:=fields.fields[3].asstring;
                  yhmc:=fields.fields[4].asstring;
                  YXJID:=Fields.Fields[5].asString;
                  yxjmc:=fields.fields[6].asstring;
                  jzbz:=fields.Fields[7].asstring;
                  ztbz:=fields.fields[8].asstring;
                  by6:=fields.fields[9].asstring;
                  brdm :=fields.fields[10].asstring;
                  by4 := fields.fields[11].asstring;
                  by7 := fields.fields[12].asstring;
                  mzh :=fields.fields[13].asstring;
                  xb :=fields.fields[14].asstring;
                  nl :=fields.fields[15].asstring;
                  strghsj := FormatDateTime('hh:nn',fields.fields[16].AsDateTime);
                  xmsp:=fields.fields[17].asstring;
                  yhid := fields.fields[18].asstring;
                  sjdmc := fields.fields[19].asstring;
                  blsend := true;
                  if (jzbz='0') and ((gblhjbrpx=4) or (gblhjbrpx=5)) then
                  begin
                    if (yhid<>zdyhid) and (yhid<>'') then
                      blsend := false;
                  end;
                  if blsend then
                  begin
                     //if listwaitnum<99 then
                     begin
                       //1号码(ghhm)，2姓名(brxm)
                       liststrwait := liststrwait +ghhm+spaces(4-length(ghhm)) +' '+'^'+
                                brxm+spaces(8-length(brxm))+'^';
                       //3科室(ksmc)
                       liststrwait := liststrwait + hjks[i].TGroupName+spaces(8-length(hjks[i].TGroupName))+'^';
                       //4类别(by6)
                       liststrwait := liststrwait + by6+spaces(8-length(by6))+'^';//+spaces(8-length(by6));
                       //5优先级(yxjmc)
                       liststrwait:=liststrwait+yxjmc+spaces(8-length(yxjmc))+'^';//+spaces(8-length(yxjmc));
                       //6医生姓名(ysxm)
                       liststrwait := liststrwait +yhmc+spaces(8-length(yhmc))+'^';//+spaces(8-length(yhmc));
                       //7状态（ztmc)
                       if JZBZ='2' then //未激活
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'
                       else if JZBZ='1' then //等待中
                       begin
                         if ztbz ='1' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'
                         else if ztbz='2' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'
                         Else If ztbz= '5' Then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'
                         Else
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';
                       end
                       else if JZBZ='0' then //已呼叫
                       begin
                         if ztbz='7' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'
                         else if ztbz='3' then
                          liststrwait := liststrwait +GetStrWithnotBadCode('已弃号',8)+'^'
                         else
                          liststrwait := liststrwait +GetStrWithnotBadCode('已呼叫',8)+'^'
                       end;
  //                     If Ztbz = '1' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'//  ttl_cz +spaces(8-length(ttl_cz))
  //                     Else If ztbz= '2' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'//  ttl_fz + spaces(8-length(ttl_fz))
  //                     Else If ztbz= '5' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'//  '准  备' + spaces(8-length('准  备'))
  //                     Else If ztbz= '6' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'//  '未激活' + spaces(8-length('未激活'))
  //                     else if ztbz='7' then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'//  '已完成' + spaces(8-length('已完成'))
  //                     Else
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';// '未呼叫'+ spaces(8-length('未呼叫'));
                       //8科室代码 (ksid)
                       liststrwait := liststrwait + hjks[i].TGroupid+'^';
                       // 9病人代码(brdm)
                       liststrwait := liststrwait + brdm+'^';
                       // 10病人标识、卡号(by4)
                       liststrwait := liststrwait + by4+'^';
                       // 11挂号时间(ghsj)
                       liststrwait := liststrwait + strghsj+'^';
                       // 12预约时间(by7)
                       liststrwait := liststrwait + by7+'^';
                       // 13性别(xb)
                       liststrwait := liststrwait + xb+'^';
                       // 14年龄(nl)
                       liststrwait := liststrwait + nl+'^';
                       // 15门诊号(mzh)
                       liststrwait := liststrwait + mzh+'^';
                       // 16就诊标志(jzbz)
                       liststrwait := liststrwait + jzbz+'^';
                       // 17状态(ztbz)
                       liststrwait := liststrwait + ztbz+'^';
                       // 18记录id(id)
                       liststrwait := liststrwait + jrid+'^';
                       // 19姓名首拼(xmsp)
                       liststrwait := liststrwait + xmsp+'^';
                       liststrwait := liststrwait + sjdmc;
                       liststrwait := liststrwait + ';';
                       listwaitnum:=listwaitnum+1;
                     end;
                  end;
                  next;
              end;
            end;
            qr.Close;
         end;
       end
       else
       begin
            ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
            if ksbrdys='' then ksbrdys:='0';
            if (gblshowallwait=0) and (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
            //if gblbrdys=1 then
            begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,t_yh.yhid,sjdmc from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid in ' + tmphjksstr +
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+' order by t_dhxx.sjdbz,replicate(''0'',10-len(ghhm))+ghhm,ghsj ';
            end
            else
            begin
                cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,t_yh.yhid,sjdmc from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid in ' + tmphjksstr +
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     ' order by t_dhxx.sjdbz, replicate(''0'',10-len(ghhm))+ghhm,ghsj';
            end;
            qr.SQL.Text := cmdstr;
            qr.Open;
            ///////////将中.
            with qr do
            begin
              while not qr.Eof  do
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  BRXM := ReplaceCallListPatName(BRXM);
                  GHHM:=fields.fields[3].asstring;
                  yhmc:=fields.fields[4].asstring;
                  YXJID:=Fields.Fields[5].asString;
                  yxjmc:=fields.fields[6].asstring;
                  jzbz:=fields.Fields[7].asstring;
                  ztbz:=fields.fields[8].asstring;
                  by6:=fields.fields[9].asstring;
                  brdm :=fields.fields[10].asstring;
                  by4 := fields.fields[11].asstring;
                  by7 := fields.fields[12].asstring;
                  mzh :=fields.fields[13].asstring;
                  xb :=fields.fields[14].asstring;
                  nl :=fields.fields[15].asstring;
                  strghsj := FormatDateTime('hh:nn',fields.fields[16].AsDateTime);
                  xmsp := fields.fields[17].asstring;
                  yhid := fields.fields[18].asstring;
                  sjdmc := fields.fields[19].asstring;
                  blsend := true;
                  if (jzbz='0') and ((gblhjbrpx=4) or (gblhjbrpx=5)) then
                  begin
                    if (yhid<>zdyhid) and (yhid<>'') then
                      blsend := false;
                  end;
                  if blsend then                  
                  begin
                     //if listwaitnum<99 then
                     begin
                       //1号码(ghhm)，2姓名(brxm)
                       liststrwait := liststrwait +ghhm+spaces(4-length(ghhm)) +' '+'^'+
                                brxm+spaces(8-length(brxm))+'^';
                       //3科室(ksmc)
                       liststrwait := liststrwait + hjks[i].TGroupName+spaces(8-length(hjks[i].TGroupName))+'^';
                       //4类别(by6)
                       liststrwait := liststrwait + by6+spaces(8-length(by6))+'^';//+spaces(8-length(by6));
                       //5优先级(yxjmc)
                       liststrwait:=liststrwait+yxjmc+spaces(8-length(yxjmc))+'^';//+spaces(8-length(yxjmc));
                       //6医生姓名(ysxm)
                       liststrwait := liststrwait +yhmc+spaces(8-length(yhmc))+'^';//+spaces(8-length(yhmc));
                       //7状态（ztmc)
                       if JZBZ='2' then //未激活
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'
                       else if JZBZ='1' then //等待中
                       begin
                         if ztbz ='1' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'
                         else if ztbz='2' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'
                         Else If ztbz= '5' Then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'
                         Else
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';
                       end
                       else if JZBZ='0' then //已呼叫
                       begin
                         if ztbz='7' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'
                         else if ztbz='3' then
                          liststrwait := liststrwait +GetStrWithnotBadCode('已弃号',8)+'^'
                         else
                          liststrwait := liststrwait +GetStrWithnotBadCode('已呼叫',8)+'^'
                       end;
  //                     If Ztbz = '1' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'//  ttl_cz +spaces(8-length(ttl_cz))
  //                     Else If ztbz= '2' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'//  ttl_fz + spaces(8-length(ttl_fz))
  //                     Else If ztbz= '5' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'//  '准  备' + spaces(8-length('准  备'))
  //                     Else If ztbz= '6' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'//  '未激活' + spaces(8-length('未激活'))
  //                     else if ztbz='7' then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'//  '已完成' + spaces(8-length('已完成'))
  //                     Else
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';// '未呼叫'+ spaces(8-length('未呼叫'));
                       //8科室代码 (ksid)
                       liststrwait := liststrwait + hjks[i].TGroupid+'^';
                       // 9病人代码(brdm)
                       liststrwait := liststrwait + brdm+'^';
                       // 10病人标识、卡号(by4)
                       liststrwait := liststrwait + by4+'^';
                       // 11挂号时间(ghsj)
                       liststrwait := liststrwait + strghsj+'^';
                       // 12预约时间(by7)
                       liststrwait := liststrwait + by7+'^';
                       // 13性别(xb)
                       liststrwait := liststrwait + xb+'^';
                       // 14年龄(nl)
                       liststrwait := liststrwait + nl+'^';
                       // 15门诊号(mzh)
                       liststrwait := liststrwait + mzh+'^';
                       // 16就诊标志(jzbz)
                       liststrwait := liststrwait + jzbz+'^';
                       // 17状态(ztbz)
                       liststrwait := liststrwait + ztbz+'^';
                       // 18记录id(id)
                       liststrwait := liststrwait + jrid+'^';
                       //姓名首拼(xmsp)
                       liststrwait := liststrwait + xmsp+'^';
                       liststrwait := liststrwait + sjdmc;
                       liststrwait := liststrwait + ';';
                       listwaitnum:=listwaitnum+1;
                     end;
                  end;
                  next;
              end;
            end;
            qr.Close;

       end;
       if (listwaitnum>0)  then
       begin
           //result:=zdid + 'DD01'  + format('%4D',[listwaitnum]) + liststrwait;
           result:=zdid + 'DD11'  + format('%4D',[listwaitnum]) + liststrwait;
           //临时修改，九院20160628
           //result:=zdid + 'DD01'  + format('%4D',[listwaitnum]) + liststrwait;
       end
       else
       begin
            result:=zdid +'DD'  +'000000'  ;
       end;
     end
     else
        result:=zdid +'DD'  +'000000'  ;
     //qr.Free;
     exit;
  except
    begin
      result := zdid + cmd + '068888';  ///有错误发生.
      //qr.Free;
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:ShowYHMessage;
                                           *
*函数机能:显示医生发送来的信息..                                          *
*******************************************************************************}

function TdmDBAccess.ShowYHMessage(const zdid:string;const msgid:string):boolean;
begin
  result:=true;
end;


{*******************************************************************************
*函数名:WriteDispMsg;
                                           *
*函数机能:将显示信息写入到数据库中                                          *
*******************************************************************************}
procedure  TdmDBAccess.WriteDispMsg(const zdid :string;fjh:string;fjmc:string;
             zth:string;ztmc:string;
             ksid :string;ksmc:string;
             ghhm:string;brxm:string;
             yhid:string; yhmc:string;
             yxjid:string;yxjmc:string;
             by6:string;
             ddrs:integer;ztbz:integer;acallnos:string;acallnames:string;by4:string);
var
   i,j:integer;
   dispstate:integer;
   xspip:string;
   xspid:string;
   sybz:string;
   cmdstr:widestring;
   soundisin:boolean;
   rsCount:integer;
   ysrs:integer;
   zbxx:string;
   zbharray:array [1..10] of string;
   zbxmarray:array [1..10] of string;
   strzbhm:string;
   strzbxm:string;
   zbby4:string;
   rs:tadoquery;
   nr,xxnr:string;
   kd,ztdx,ztys:integer;
   dq,tmpstr,tmpyjpstr:string;
   tmpyjpksmc:string;
   YJPIP:string;
   YJPtype:integer;
   tmpztbz:integer;
   needckp:integer;
   qr:Tadoquery;
   tmpghhm:string;
   ztcount:integer;
   ztposition:integer;
   ksbrdys:string;
   tmpSoundStr:string;
   CMD: TCmdBlock;
   StrLedNo,StrCmd,WParam,LParam : string;
   qry : TADOQuery;
   zb1yxjid:string;
   tmpbrxm:string;
   maxpreparepos:integer;
   tmpjrid:string;
begin
  soundisin:=false;
//  showmessage(fjh);
  qry := TADOQuery.Create(nil);
  try
    qry.Connection := ADOConnection;
    try
      qry.Close;
      qry.SQL.Text:=' select 1 from  ' +
                              ' t_xsnrsz (nolock) ' +
                              ' where hszh=' + inttostr(gblhszh)+
                              ' and xsms=99';
      qry.Open;
      if not qry.Eof then
         needckp:=1
      else
         needckp:=0;
      qry.Close;
      ///////////////////////
      ysrs:=dmDBAccess.DB_GetGroupPrepareCount(ksid);//gblzbrs;
      tmpztbz:=ztbz;
      if tmpztbz>=100 then
      begin
         ysrs:=tmpztbz-100+1;
         tmpztbz:=1;
      end;

      tmpghhm :=ghhm;
      tmpbrxm := brxm;
      if length(tmpghhm)=0 then
      begin
         //查找此员工上一次叫的号码.
         qr:=Tadoquery.Create(nil);
         qr.Connection:=adoconnection;
         qr.SQL.Text:='select top 1 ghhm,brxm,id from t_dhxx'+
                      ' where hszh='+inttostr(gblhszh)+
                      ' and ksid='''+ksid+''''+
                      ' and yhid='''+yhid+''''+
                      ' and jzbz=0'+
                      ' order by jzsj desc';
         try
            qr.Open;
            if not qr.Eof then
            begin
               tmpghhm:=qr.fieldbyname('ghhm').AsString;
               tmpbrxm:=qr.fieldbyname('brxm').AsString;
               tmpjrid:=qr.fieldbyname('id').AsString;
               doUnLockOtherGroupSamePat(tmpjrid);
            end;
            qr.Close;
         except
            qr.Close;
         end;
         FreeAndNil(qr);
      end;

      ///////查出本科室中的最前面ysrs个准备病人
      if (tmpghhm='暂停服务') or
       (tmpghhm='欢迎光临') or
       (tmpghhm='开诊')  or
       (tmpghhm='停诊')  or
       (tmpghhm='继续服务') or
       (tmpghhm='停止服务') then//不需要准备
       begin
          dispstate:=0;
       end
       else
       begin
            dispstate:=0;
            if length(tmpghhm)=0 then dispstate:=0;
            qry.Close;
            if yhid='' then
            begin
              qry.SQL.Text:=' select id,ztbz,ghhm,brxm,by4,yhid from t_dhxx (nolock) ' +
                                     ' where ksid = '''+ ksid +''''+
                                     ' and hszh=' + inttostr(gblhszh)+
                                     ' and  jzbz=''1'''+
                                     ' order by kssxid ';
              qry.Open;
            end
            else
            begin
              ksbrdys := dmdbaccess.GetDBValue('KS',ksid,'SelDoctor');
              if ksbrdys='' then ksbrdys:='0';
              if ((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1') then
              begin
                if gblkyhjdkstybr=0 then
                begin
                  qry.SQL.Text:=' select id,ztbz,ghhm,brxm,by4,yhid from t_dhxx a(nolock) ' +
                                       ' where ksid ='''+ ksid +''''+
                                       ' and (yhid='''+yhid+''''+
                                       ' or yhid='''' or yhid is null ) '+
                                       ' and hszh=' + inttostr(gblhszh)+
                                       ' and  jzbz=''1'''+
                                       ' and ID not in (select dhxxid from t_dhxx_yh '+
                                       ' where ksid=a.ksid and yhid='''+yhid+''')'+  //20181123，对于已排除此医生的病人不准备到此医生
                                       ' order by kssxid ';
                end
                else
                begin
                  qry.SQL.Text:=' select id,ztbz,ghhm,brxm,by4,yhid from t_dhxx a(nolock) ' +
                                       ' where ksid ='''+ ksid +''''+
                                       ' and (yhid='''+yhid+''''+
                                       ' or yhid='''' or yhid is null ) '+
                                       ' and hszh=' + inttostr(gblhszh)+
                                       ' and  jzbz=''1'''+
                                       ' order by kssxid ';
                end;
                try
                  qry.Open;
                except
                  qry.SQL.Text:=' select id,ztbz,ghhm,brxm,by4,yhid from t_dhxx a(nolock) ' +
                                       ' where ksid ='''+ ksid +''''+
                                       ' and (yhid='''+yhid+''''+
                                       ' or yhid='''' or yhid is null ) '+
                                       ' and hszh=' + inttostr(gblhszh)+
                                       ' and  jzbz=''1'''+
                                       ' order by kssxid ';
                  qry.Open;
                end;
              end
              else
              begin
                qry.SQL.Text:=' select id,ztbz,ghhm,brxm,by4,yhid from t_dhxx (nolock) ' +
                                     ' where ksid ='''+ ksid +''''+
                                     ' and hszh=' + inttostr(gblhszh)+
                                     ' and  jzbz=''1'''+
                                     ' order by kssxid ';
                qry.Open;
              end;
            end;
            zbxx:='';
            if not qry.Eof then
            begin
              rs:=tadoquery.Create(nil);
              rs.Connection:=adoconnection;
              //if ysrs>10 then ysrs:=10;
              ////////2008-12-03添加 吴刚////////////
              ////////根据t_hjzd.ks 与t_yh.ksid1决定是否要准备////////////////////////////
              ////////根据t_yh.prepare1,t_yh.prepare2,t_yh.prepare3决定是否要准备/////////
              try
                rs.SQL.Text:='select zdid,ksid1 from t_hjzd where zdid='+zdid+' and hszh='+inttostr(gblhszh);
                rs.Open;
                if rs.FieldByName('ksid1').AsString=ksid then
                begin
                   ysrs:=ysrs;//需要准备
                end
                else if rs.FieldByName('ksid1').AsString='0' then
                   ysrs:=ysrs//需要准备
                else
                begin
                   ysrs:=0;//不需要准备
                   dispstate:=99;
                end;
                rs.Close;
              except
              end;
              if ysrs>0 then
              begin
                try
                  rs.SQL.Text:='select yhid,ksid,prepare'+
                               ' from t_yh_ks'+
                               ' where yhid='+quotedstr(yhid)+' and hszh='+inttostr(gblhszh)+
                               ' order by seq';
                  rs.Open;
                  while not rs.Eof do
                  begin
                    if (rs.FieldByName('ksid').AsString=ksid)
                      and (rs.FieldByName('prepare').AsInteger<>1) then
                    begin
                       ysrs:=0;//不需要准备
                    end;
                    rs.Next;
                  end;
                  rs.Close;
                except

                end;
              end;
              if gblNeedZBXYS=1 then
              begin
                rs.SQL.Text:=' select count(*) as zb_count from t_dhxx (nolock) ' +
                                     ' where ksid ='''+ ksid +''''+
                                     ' and (yhid='''+yhid+''''+')'+
                                     ' and hszh=' + inttostr(gblhszh)+
                                     ' and jzbz=''1'''+
                                     ' and ztbz=5';
              end
              else
              begin
                rs.SQL.Text:=' select count(*) as zb_count from t_dhxx (nolock) ' +
                                     ' where ksid ='''+ ksid +''''+
                                     ' and hszh=' + inttostr(gblhszh)+
                                     ' and jzbz=''1'''+
                                     ' and ztbz=5';
              end;
              rs.Open;
              if (rs.FieldByName('zb_count').AsInteger<gblhjzbrs) or (gblhjzbrs=0) then//需要准备
              begin
                 ysrs:=ysrs;
                 dispstate:=0;
              end
              else
              begin
                 ysrs:=0;
                 //dispstate:=99;
              end;
              rs.Close;
              ///////////添加结束////////////////////////////
              if ysrs=0 then
              begin
                if gblNeedZBXYS=1 then
                begin
                  rs.SQL.Text:=' select ghhm,brxm,by4 from t_dhxx as a(nolock) ' +
                                       ' where ksid ='''+ ksid +''''+
                                       ' and (yhid='''+yhid+''''+')'+
                                       ' and hszh=' + inttostr(gblhszh)+
                                       ' and jzbz=''1'''+
                                       ' and ztbz=5'+
                                       ' order by kssxid,ghsj';
                end
                else
                begin
                  rs.SQL.Text:=' select ghhm,brxm,by4 from t_dhxx (nolock) ' +
                                       ' where ksid ='''+ ksid +''''+
                                       ' and hszh=' + inttostr(gblhszh)+
                                       ' and jzbz=''1'''+
                                       ' and ztbz=5'+
                                       ' order by kssxid,ghsj';
                end;
                rs.Open;
                if not rs.Eof then
                begin
                  i:=1;
                 // while (not rs.Eof) and (i<gblZBRS) do
                 while (not rs.Eof) and (i<dmDBAccess.DB_GetGroupPrepareCount(ksid)) do//20131114修改
                  begin
                    if i<=10 then
                    begin
                      if length(zbxx)>0 then
                          zbxx:=zbxx+' '+rs.fieldbyname('ghhm').asstring
                      else
                          zbxx:=rs.fieldbyname('ghhm').asstring;
                      zbharray[i]:=trim(rs.fieldbyname('ghhm').asstring);
                      zbxmarray[i]:=trim(rs.fieldbyname('brxm').asstring);
                      strzbhm := strzbhm+rs.fieldbyname('ghhm').asstring+'|';
                      strzbxm := strzbxm+rs.fieldbyname('brxm').asstring+'|';
                      zbby4 := zbby4+rs.fieldbyname('by4').asstring+'|';
                    end;
                    rs.Next;
                    i:=i+1;
                    if (i=10) or ((i<10) and rs.Eof) then
                      zbxx:=zbxx+'号';
                  end;
                  if (i>10) then
                  begin
                    rs.Last;
                    strzbhm := strzbhm+rs.fieldbyname('ghhm').asstring+'|';
                    strzbxm := strzbxm+rs.fieldbyname('brxm').asstring+'|';
                    zbby4 := zbby4+rs.fieldbyname('by4').asstring+'|';
                  end;
                end;
                rs.Close;
              end;
              for i:=1 to ysrs do
              begin
                  if qry.Eof then
                     break;
                  if (getzdzt(zdid)='暂停') and (qry.FieldByName('ztbz').AsInteger<>5) then
                  begin
                     //不再将等待表中的病人改为准备.
                  end
                  else
                  begin
                    if i<=10 then
                    begin
                      if length(zbxx)>0 then
                          zbxx:=zbxx+' '+qry.fieldbyname('ghhm').asstring
                      else
                          zbxx:=qry.fieldbyname('ghhm').asstring;
                      zbharray[i]:=trim(qry.fieldbyname('ghhm').asstring);
                      zbxmarray[i]:=trim(qry.fieldbyname('brxm').asstring);
                      strzbhm := strzbhm+qry.fieldbyname('ghhm').asstring+'|';
                      strzbxm := strzbxm+qry.fieldbyname('brxm').asstring+'|';
                      zbby4 := zbby4+trim(qry.fieldbyname('by4').asstring)+'|';
                    end;

                    rs.SQL.Clear;
                    if qry.FieldByName('ztbz').AsInteger<>5 then
                    begin
                       if dispstate=0 then
                       begin
                          if length(tmpghhm)=0 then
                             dispstate:=0
                          else
                             dispstate:=i;
                       end;
                    end;
                    //得到当前准备人员的最大排队序号

                    maxpreparepos := GetZBBRMaxKSSXID(ksid,qry.fieldbyname('id').asstring,gblhszh);

                    if trim(qry.FieldByName('yhid').AsString) ='' then //原来没有选择医生 。
                    begin
                       if gblNeedZBXYS=1 then
                       begin
                          if yhcancall(qry.fieldbyname('id').asstring,yhid,ksbrdys) then
                          begin
                            rs.SQL.Text:=' update t_dhxx set ZTBZ=''5'',yhid='''+yhid+''' where id='+ qry.fieldbyname('id').asstring;
                            addyhcancall(qry.fieldbyname('id').asstring,yhid,'-1');
                          end
                          else
                          begin
                            rs.SQL.Text:=' update t_dhxx set ZTBZ=''5'' where id='+ qry.fieldbyname('id').asstring;
                          end;
                       end
                       else
                          rs.SQL.Text:=' update t_dhxx set ZTBZ=''5'' where id='+ qry.fieldbyname('id').asstring;
                    end
                    else  //已经选择医生。
                       rs.SQL.Text:=' update t_dhxx set ZTBZ=''5'' where id='+ qry.fieldbyname('id').asstring;
                    try
                       rs.ExecSQL ;
                    except
                       ////修改状态标志失败;
                    end;
                    //如果当前准备病人位置大于当前准备人员的最大排队序号的后一个序号,对准备病人进行一次排序//
                    if strtoint(getdbvalue('DHXX',qry.fieldbyname('id').asstring,'kssxid'))
                      >maxpreparepos+1 then
                    begin
                      DB_Setgrouppreparepos(ksid,qry.fieldbyname('id').asstring,
                      strtoint(getdbvalue('DHXX',qry.fieldbyname('id').asstring,'kssxid')),
                      maxpreparepos+1);
                    end;
                  end;
                  qry.Next;
                  if (i=10) or ((i<10) and qry.Eof) then
                     zbxx:=zbxx+'号';
              end;
              FreeAndNil(rs);
              if (ysrs>10) then
              begin
                if (qry.recordcount>0) then
                begin
                  qry.Prior;
                  strzbhm := strzbhm+qry.fieldbyname('ghhm').asstring+'|';
                  strzbxm := strzbxm+qry.fieldbyname('brxm').asstring+'|';
                  zbby4 := zbby4+trim(qry.fieldbyname('by4').asstring)+'|';
                end;
              end;
            end;
            qry.Close;
            if (ztbz>=100) and (ysrs=0) then
            begin
              //不需要准备，退出
              exit;
            end;
           // if length(zbxx)>0 then
           //    zbxx:=zbxx+'准备';
         end;
      ////////////////////////////////////////////////

      if length(tmpghhm)>0 then
         if dispstate<>99 then dispstate:=0;//是叫号,否则为叫准备;
      qry.Close;

      qry.SQL.Text:=' select x.xspid,x.ip from t_ks_xszd kx,t_xszd x '+
                              ' where  kx.xspid=x.xspid and kx.hszh=x.hszh ' +
                              ' and kx.hszh=' + inttostr(gblhszh)+
                              ' and kx.ksid=''' + ksid +''''+
                              ' order by x.xspid ';

      try
        qry.Open;
      except
        qry.SQL.Text:=' select xspid,'''' as ip from  ' +
                                ' t_ks_xszd ' +
                                ' where hszh=' + inttostr(gblhszh)+
                                ' and ksid=''' + ksid +''''+
                                ' order by xspid ';
        qry.Open;
      end;

      ///////////////////////


      ///////////
  {    if tmpghhm='暂停服务' then  sybz:='0'
      else if tmpghhm='欢迎光临' then sybz:='0'
      else if tmpghhm='开诊'  then sybz:='0'
      else if tmpghhm='停诊'  then sybz:='0'
      else sybz:='1';}
      sybz:='0';
      rscount:=qry.RecordCount ;
      i:=1;
      with qry do
      begin
         while not qry.Eof do
         begin
            xspid := fields.fields[0].asstring ;
            xspip := fields.fields[1].asstring ;
            sybz:='0';
            if (i=1)  then
            begin
                //sybz:='1';
                if tmpghhm='暂停服务' then  sybz:='0'
                else if tmpghhm='欢迎光临' then sybz:='0'
                else if tmpghhm='开诊'  then sybz:='0'
                else if tmpghhm='停诊'  then sybz:='0'
                else if tmpghhm='继续服务'  then sybz:='0'
                else if tmpghhm='停止服务'  then sybz:='0'
                else
                begin
                  if (ztbz>=100) then
                    sybz:='0'
                  else
                    sybz:='1';
                  soundisin:=true;
                end;
                if (length(tmpghhm)=0) then
                begin
                  dispstate:=0;
  //                 delete by wugang @2010-11-03
                  //sybz:='0';
                end;
            end;
            if Length(zbxx)>100 then zbxx := Copy(zbxx,1,100);
            if Length(zbby4)>400 then zbby4 := Copy(zbby4,1,400);
            if Length(strzbhm)>100 then strzbhm := Copy(strzbhm,1,100);
            if Length(strzbxm)>200 then strzbxm := Copy(strzbxm,1,200);
            if tmpztbz=1 then
            begin
            cmdstr:=' insert into t_xsxx(xspid,hjid,fjh,fjmc,zth,ztmc,ksid,ksmc,ghhm,' +
                    ' yhid,yhmc,brxm,yxjid,yxjmc,ddrs,sybz,ZTBZ,zbxx,hszh,'+
                    ' zbh1,zbxm1,zbh2,zbxm2,zbh3,zbxm3,zbh4,zbxm4,zbh5,zbxm5,zbh6,zbxm6,zbh7,zbxm7,'+
                    ' zbh8,zbxm8,zbh9,zbxm9,zbh10,zbxm10,state,by6,callno,callname'+
                    ',by4,zbby4,zbhm,zbxm) ' +
                    ' values( ' +
                    ' ''' + xspid +''''+
                    ',''' +zdid + ''''+
                    ',''' +fjh + ''''+
                    ',''' +fjmc + ''''+
                    ',''' + zth + ''''+
                    ',''' +ztmc + ''''+
                    ','''+ ksid + ''''+
                    ','''+ksmc + '''' +
                    ','''+ tmpghhm+ ''''+
                    ','''+ yhid +''''+
                    ','''+yhmc + ''''+
                    ',''' + tmpbrxm + ''''+
                    ',''' + yxjid + ''''+
                    ',''' + yxjmc + ''''+
                    ','+ inttostr(ddrs) +
                    ',''' + sybz + ''''+
                    ',''1'''+
                    ','''+zbxx+''''+
                    ',' + inttostr(gblhszh) +
                    ','''+zbharray[1]+''''+
                    ','''+zbxmarray[1]+''''+
                    ','''+zbharray[2]+''''+
                    ','''+zbxmarray[2]+''''+
                    ','''+zbharray[3]+''''+
                    ','''+zbxmarray[3]+''''+
                    ','''+zbharray[4]+''''+
                    ','''+zbxmarray[4]+''''+
                    ','''+zbharray[5]+''''+
                    ','''+zbxmarray[5]+''''+
                    ','''+zbharray[6]+''''+
                    ','''+zbxmarray[6]+''''+
                    ','''+zbharray[7]+''''+
                    ','''+zbxmarray[7]+''''+
                    ','''+zbharray[8]+''''+
                    ','''+zbxmarray[8]+''''+
                    ','''+zbharray[9]+''''+
                    ','''+zbxmarray[9]+''''+
                    ','''+zbharray[10]+''''+
                    ','''+zbxmarray[10]+''''+
                    ','+inttostr(dispstate)+
                    ','''+by6+''''+
                    ','''+acallnos+''''+
                    ','''+acallnames+''''+
                    ','''+by4+''''+
                    ','''+zbby4+''''+
                    ','''+strzbhm+''''+
                    ','''+strzbxm+''''+
                    ')'
            end
            else if tmpztbz=2 then
            begin
            cmdstr:=' insert into t_xsxx(xspid,hjid,fjh,fjmc,zth,ztmc,ksid,ksmc,ghhm,' +
                    ' yhid,yhmc,brxm,yxjid,yxjmc,ddrs,sybz,ZTBZ,zbxx,hszh,'+
                    ' zbh1,zbxm1,zbh2,zbxm2,zbh3,zbxm3,zbh4,zbxm4,zbh5,zbxm5,zbh6,zbxm6,zbh7,zbxm7,'+
                    ' zbh8,zbxm8,zbh9,zbxm9,zbh10,zbxm10,state,by6,callno,callname'+
                    ',by4,zbby4,zbhm,zbxm) ' +
                    ' values( ' +
                    ' ''' + xspid +''''+
                    ',''' +zdid + ''''+
                    ',''' +fjh + ''''+
                    ',''' +fjmc + ''''+
                    ',''' + zth + ''''+
                    ',''' +ztmc + ''''+
                    ','''+ ksid + ''''+
                    ','''+ksmc + '''' +
                    ','''+ tmpghhm+ ''''+
                    ','''+ yhid +''''+
                    ','''+yhmc + ''''+
                    ',''' + tmpbrxm + ''''+
                    ',''' + yxjid + ''''+
                    ',''' + yxjmc + ''''+
                    ','+ inttostr(ddrs) +
                    ',''' + '0' + ''''+
                    ',''2'''+
                    ','''+zbxx+''''+
                    ',' + inttostr(gblhszh)+
                    ','''+zbharray[1]+''''+
                    ','''+zbxmarray[1]+''''+
                    ','''+zbharray[2]+''''+
                    ','''+zbxmarray[2]+''''+
                    ','''+zbharray[3]+''''+
                    ','''+zbxmarray[3]+''''+
                    ','''+zbharray[4]+''''+
                    ','''+zbxmarray[4]+''''+
                    ','''+zbharray[5]+''''+
                    ','''+zbxmarray[5]+''''+
                    ','''+zbharray[6]+''''+
                    ','''+zbxmarray[6]+''''+
                    ','''+zbharray[7]+''''+
                    ','''+zbxmarray[7]+''''+
                    ','''+zbharray[8]+''''+
                    ','''+zbxmarray[8]+''''+
                    ','''+zbharray[9]+''''+
                    ','''+zbxmarray[9]+''''+
                    ','''+zbharray[10]+''''+
                    ','''+zbxmarray[10]+''''+
                    ','+inttostr(dispstate)+
                    ','''+by6+''''+
                    ','''+acallnos+''''+
                    ','''+acallnames+''''+
                    ','''+by4+''''+
                    ','''+zbby4+''''+
                    ','''+strzbhm+''''+
                    ','''+strzbxm+''''+
                    ')';
            end;
            try
              adoconnection.execute(cmdstr,cmdtext);
            except
            begin
              if tmpztbz=1 then
              begin
              cmdstr:=' insert into t_xsxx(xspid,hjid,fjh,fjmc,zth,ztmc,ksid,ksmc,ghhm,' +
                      ' yhid,yhmc,brxm,yxjid,yxjmc,ddrs,sybz,ZTBZ,zbxx,hszh,'+
                      ' zbh1,zbxm1,zbh2,zbxm2,zbh3,zbxm3,zbh4,zbxm4,zbh5,zbxm5,zbh6,zbxm6,zbh7,zbxm7,'+
                      ' zbh8,zbxm8,zbh9,zbxm9,zbh10,zbxm10,state,by6) ' +
                      ' values( ' +
                      ' ''' + xspid +''''+
                      ',''' +zdid + ''''+
                      ',''' +fjh + ''''+
                      ',''' +fjmc + ''''+
                      ',''' + zth + ''''+
                      ',''' +ztmc + ''''+
                      ','''+ ksid + ''''+
                      ','''+ksmc + '''' +
                      ','''+ tmpghhm+ ''''+
                      ','''+ yhid +''''+
                      ','''+yhmc + ''''+
                      ',''' + tmpbrxm + ''''+
                      ',''' + yxjid + ''''+
                      ',''' + yxjmc + ''''+
                      ','+ inttostr(ddrs) +
                      ',''' + sybz + ''''+
                      ',''1'''+
                      ','''+zbxx+''''+
                      ',' + inttostr(gblhszh) +
                      ','''+zbharray[1]+''''+
                      ','''+zbxmarray[1]+''''+
                      ','''+zbharray[2]+''''+
                      ','''+zbxmarray[2]+''''+
                      ','''+zbharray[3]+''''+
                      ','''+zbxmarray[3]+''''+
                      ','''+zbharray[4]+''''+
                      ','''+zbxmarray[4]+''''+
                      ','''+zbharray[5]+''''+
                      ','''+zbxmarray[5]+''''+
                      ','''+zbharray[6]+''''+
                      ','''+zbxmarray[6]+''''+
                      ','''+zbharray[7]+''''+
                      ','''+zbxmarray[7]+''''+
                      ','''+zbharray[8]+''''+
                      ','''+zbxmarray[8]+''''+
                      ','''+zbharray[9]+''''+
                      ','''+zbxmarray[9]+''''+
                      ','''+zbharray[10]+''''+
                      ','''+zbxmarray[10]+''''+
                      ','+inttostr(dispstate)+
                      ','''+by6+''''+
                      ')'
              end
              else if tmpztbz=2 then
              begin
              cmdstr:=' insert into t_xsxx(xspid,hjid,fjh,fjmc,zth,ztmc,ksid,ksmc,ghhm,' +
                      ' yhid,yhmc,brxm,yxjid,yxjmc,ddrs,sybz,ZTBZ,zbxx,hszh,'+
                      ' zbh1,zbxm1,zbh2,zbxm2,zbh3,zbxm3,zbh4,zbxm4,zbh5,zbxm5,zbh6,zbxm6,zbh7,zbxm7,'+
                      ' zbh8,zbxm8,zbh9,zbxm9,zbh10,zbxm10,state,by6) ' +
                      ' values( ' +
                      ' ''' + xspid +''''+
                      ',''' +zdid + ''''+
                      ',''' +fjh + ''''+
                      ',''' +fjmc + ''''+
                      ',''' + zth + ''''+
                      ',''' +ztmc + ''''+
                      ','''+ ksid + ''''+
                      ','''+ksmc + '''' +
                      ','''+ tmpghhm+ ''''+
                      ','''+ yhid +''''+
                      ','''+yhmc + ''''+
                      ',''' + tmpbrxm + ''''+
                      ',''' + yxjid + ''''+
                      ',''' + yxjmc + ''''+
                      ','+ inttostr(ddrs) +
                      ',''' + '0' + ''''+
                      ',''2'''+
                      ','''+zbxx+''''+
                      ',' + inttostr(gblhszh)+
                      ','''+zbharray[1]+''''+
                      ','''+zbxmarray[1]+''''+
                      ','''+zbharray[2]+''''+
                      ','''+zbxmarray[2]+''''+
                      ','''+zbharray[3]+''''+
                      ','''+zbxmarray[3]+''''+
                      ','''+zbharray[4]+''''+
                      ','''+zbxmarray[4]+''''+
                      ','''+zbharray[5]+''''+
                      ','''+zbxmarray[5]+''''+
                      ','''+zbharray[6]+''''+
                      ','''+zbxmarray[6]+''''+
                      ','''+zbharray[7]+''''+
                      ','''+zbxmarray[7]+''''+
                      ','''+zbharray[8]+''''+
                      ','''+zbxmarray[8]+''''+
                      ','''+zbharray[9]+''''+
                      ','''+zbxmarray[9]+''''+
                      ','''+zbharray[10]+''''+
                      ','''+zbxmarray[10]+''''+
                      ','+inttostr(dispstate)+
                      ','''+by6+''''+
                      ')';
              end;
              try
                adoconnection.execute(cmdstr,cmdtext);
              except
                begin
                  if tmpztbz=1 then
                  begin
                  cmdstr:=' insert into t_xsxx(xspid,hjid,fjh,fjmc,zth,ztmc,ksid,ksmc,ghhm,' +
                          ' yhid,yhmc,brxm,yxjid,yxjmc,ddrs,sybz,ZTBZ,zbxx,hszh) ' +
                          ' values( ' +
                          ' ''' + xspid +''''+
                          ',''' +zdid + ''''+
                          ',''' +fjh + ''''+
                          ',''' +fjmc + ''''+
                          ',''' + zth + ''''+
                          ',''' +ztmc + ''''+
                          ','''+ ksid + ''''+
                          ','''+ksmc + '''' +
                          ','''+ tmpghhm+ ''''+
                          ','''+ yhid +''''+
                          ','''+yhmc + ''''+
                          ',''' + tmpbrxm + ''''+
                          ',''' + yxjid + ''''+
                          ',''' + yxjmc + ''''+
                          ','+ inttostr(ddrs) +
                          ',''' + sybz + ''''+
                          ',''1'''+
                          ','''+zbxx+''''+
                          ',' + inttostr(gblhszh) +')'
                  end
                  else if tmpztbz=2 then
                  begin
                  cmdstr:=' insert into t_xsxx(xspid,hjid,fjh,fjmc,zth,ztmc,ksid,ksmc,ghhm,' +
                          ' yhid,yhmc,brxm,yxjid,yxjmc,ddrs,sybz,ZTBZ,zbxx,hszh) ' +
                          ' values( ' +
                          ' ''' + xspid +''''+
                          ',''' +zdid + ''''+
                          ',''' +fjh + ''''+
                          ',''' +fjmc + ''''+
                          ',''' + zth + ''''+
                          ',''' +ztmc + ''''+
                          ','''+ ksid + ''''+
                          ','''+ksmc + '''' +
                          ','''+ (tmpghhm)+ ''''+
                          ','''+ yhid +''''+
                          ','''+yhmc + ''''+
                          ',''' + tmpbrxm + ''''+
                          ',''' + yxjid + ''''+
                          ',''' + yxjmc + ''''+
                          ','+ inttostr(ddrs) +
                          ',''' + '0' + ''''+
                          ',''2'''+
                          ','''+zbxx+''''+
                          ',' + inttostr(gblhszh) +')';
                  end;
                  adoconnection.execute(cmdstr,cmdtext);
                end;
              end;
            end;
            end;
            if xspip<>'' then
            begin
              CMD.LedNo :='0';
              CMD.Cmd :='1';
              CMD.WParam :='1';
              CMD.LParam :='1';
              StrLedNo := '1';
              StrCmd := 'SXSJ';
              WParam :='1';
              LParam :='1';
              StrCopy(CMD.LedNo,PChar(StrLedNo));
              StrCopy(CMD.Cmd,PChar(StrCmd));
              StrCopy(CMD.WParam,PChar(WParam));
              StrCopy(CMD.LParam,PChar(LParam));
              for j :=0 to frmMain.SrvSockDisplay.Socket.ActiveConnections-1 do
              begin
                if xspip= frmMain.SrvSockDisplay.Socket.Connections[j].RemoteAddress then
                begin
                  frmMain.SrvSockDisplay.Socket.Connections[j].SendBuf(CMD,SizeOf(CMD));
                end;
              end;
            end;
            i:=i+1;
            next;
         end;
         close;
      end;

        //如果是叫号,并且需要液晶显示屏。
      if (gblNeedYJP =1) and (ztbz<>2) then
      begin
            qry.close;
          //查找些呼叫器对应的液晶显示屏，
           qry.sql.Text:=' select HostType,HostIP from  ' +
                                  ' t_screen left outer join t_hjzd_scr on '+
                                  ' t_screen.screenid=t_hjzd_scr.screenid '+
                                  ' and t_screen.hszh=t_hjzd_scr.hszh '+
                                  ' where ' +
                                  ' t_hjzd_scr.hjzdid='+ zdid +
                                  ' and t_hjzd_scr.hszh=' + inttostr(gblhszh) ;
          qry.Open;
          /////
          with qry do
          begin
             if not qry.Eof  then
             begin
               //查询此房间号对应的诊台数.
               qr:=Tadoquery.Create(nil);
               qr.Connection:=adoconnection;
               qr.SQL.Text:='select count(*) as cnt from t_hjzd'+
                            ' where hszh='+inttostr(gblhszh)+
                            ' and fjh='+fjh+
                            ' and (yhid<>'''' and yhid is not null)';
               try
                  qr.Open;
                  if not qr.Eof then
                  begin
                     ztcount:=qr.fieldbyname('cnt').asinteger;
                  end;
                  qr.Close;
               except
                  ztcount := 1;
                  qr.Close;
               end;
               //qr.Free;
               if ztcount=0 then ztcount:=1;

               if zth='0' then
                 ztposition := 1
               else
               begin
                 qr.SQL.Text :=' select count(*) as cnt from t_hjzd'+
                            ' where hszh='+inttostr(gblhszh)+
                            ' and fjh='+fjh+
                            ' and (yhid<>'''' and yhid is not null)'+
                            ' and zth<'+zth;
                 try
                   qr.Open;
                   ztposition := qr.fieldbyname('cnt').AsInteger+1;
                 except
                   ztposition := strtoint(zth);
                 end;
                 qr.Close;
               end;
               FreeAndNil(qr);
              YJPtype:=qry.Fieldbyname('HostType').AsInteger;
              tmpyjpstr:='';
//              if (tmpghhm='暂停服务') then
//              begin
//                //tmpyjpstr:='C3';
//                //tmpyjpstr := 'C3'+inttostr(ztposition);
//                if YJPtype=1 then
//                  tmpyjpstr := 'C3'+inttostr(ztposition)
//                else
//                  tmpyjpstr := 'C3'+yhid;
//                tmpyjpksmc:='C4'+getstrwithnotbadcode(inttostr(gblyjpksfontsize),3)+getstrwithnotbadcode(inttostr(gblyjpksfontcolor),1)+'|';
//              end
//              else
              if (tmpghhm='欢迎光临') then
              begin
                tmpyjpstr:='C1'+yhid;
                tmpyjpksmc:='C4'+getstrwithnotbadcode(inttostr(gblyjpksfontsize),3)+getstrwithnotbadcode(inttostr(gblyjpksfontcolor),1)+ksmc+'|';
              end
              else if ((tmpghhm='开诊') or (tmpghhm='继续服务')) then
              begin
                 tmpyjpstr:='C1'+yhid;
                tmpyjpksmc:='C4'+getstrwithnotbadcode(inttostr(gblyjpksfontsize),3)+getstrwithnotbadcode(inttostr(gblyjpksfontcolor),1)+ksmc+'|';
              end
              else if ((tmpghhm='停诊') or (tmpghhm='停止服务')) then
              begin
                // tmpyjpstr:='C3';
                if YJPtype=1 then
                  tmpyjpstr := 'C3'+inttostr(ztposition)
                else
                  tmpyjpstr := 'C3'+yhid;
                tmpyjpksmc:='C4'+getstrwithnotbadcode(inttostr(gblyjpksfontsize),3)+getstrwithnotbadcode(inttostr(gblyjpksfontcolor),1)+'|';
              end
              else
              begin
                tmpyjpksmc:='C4'+getstrwithnotbadcode(inttostr(gblyjpksfontsize),3)+getstrwithnotbadcode(inttostr(gblyjpksfontcolor),1)+ksmc+'|';
                               //组合叫号信息。
                rs:=tadoquery.Create(nil);
                rs.Connection:=adoconnection;
                if zbharray[1]<>'' then
                begin
                  rs.SQL.Text :='select yxjid from t_dhxx where ksid='+quotedstr(ksid)+
                    ' and ghhm='+quotedstr(zbharray[1])+
                    ' and hszh='+inttostr(gblHSZH);
                  rs.Open;
                  if not rs.Eof then
                  begin
                    zb1yxjid:= rs.FieldByName('yxjid').asstring;
                  end;
                  rs.Close;
                end;
                if yjptype=1 then
                   rs.SQL.Text:='select xsnr,xxnr,xxkd,dqfs,ztdx,ztys from t_XSNRSCR (nolock) where xsms=101 and hszh='+inttostr(gblhszh) +' order by xssx'
                else
                   rs.SQL.Text:='select xsnr,xxnr,xxkd,dqfs,ztdx,ztys from t_XSNRSCR (nolock) where xsms=102 and hszh='+inttostr(gblhszh) +' order by xssx';
                rs.open ;
                tmpyjpstr:='';
                while not rs.Eof do
                begin
                   nr:=rs.fieldbyname('xsnr').AsString;
                   xxnr:=rs.fieldbyname('xxnr').AsString;
                   kd:=rs.fieldbyname('xxkd').AsInteger;
                   dq:=rs.fieldbyname('dqfs').asstring;
                   ztdx:=rs.fieldbyname('ztdx').AsInteger;
                   try
                   ztys:=rs.fieldbyname('ztys').AsInteger;
                   except
                   ztys:=0;
                   end;
                   if nr=ttl_ghhm then
                   begin
                      if (yxjid='88') or (yxjid='89') then
                      begin
                        if gblShowYXGhhm=1 then
                          tmpstr:=tmpghhm
                        else
                          tmpstr:='预约';
                      end
                      else
                        tmpstr:=tmpghhm ;
                   end
                   else if nr =ttl_br+'姓名' then
                   begin
                      if gblYSBH=0 then
                        tmpstr:=tmpbrxm
                      else
                        tmpstr := dmDBAccess.ReplaceYSBH(tmpbrxm,gblYSBH,gblYSBHZF);
                   end
                   else if nr =ttl_zs+'号码' then
                      tmpstr:=fjh
                   else if nr = ttl_zs+'名称' then
                      tmpstr:=fjmc
                   else if nr =ttl_zt+'号码' then
                      tmpstr:=zth
                   else if nr =ttl_zt+'名称' then
                      tmpstr:=ztmc
                   else if nr=ttl_ks+'名称' then
                      tmpstr:=ksmc
                   else if nr =ttl_yh+'代码' then
                      tmpstr:=yhid//yhmc
                   else if nr =ttl_yh+'姓名' then
                      tmpstr:=yhmc
                   else if nr = '优先名称' then
                      tmpstr:=yxjmc
                   else if nr ='任意字符' then
                      tmpstr:=xxnr
                   else if nr = '准备信息' then
                      tmpstr:=zbxx
                   else if nr ='准备号码1' then
                   begin
                      if (zb1yxjid='88') or (zb1yxjid='89') then
                      begin
                        if gblShowYXGhhm=1 then
                          tmpstr:=zbharray[1]
                        else
                          tmpstr:='预约';
                      end
                      else
                        tmpstr:=zbharray[1];
                   end
                   else if nr ='准备号码2' then
                      tmpstr:=zbharray[2]
                   else if nr ='准备号码3' then
                      tmpstr:=zbharray[3]
                   else if nr ='准备号码4' then
                      tmpstr:=zbharray[4]
                   else if nr ='准备号码5' then
                      tmpstr:=zbharray[5]
                   else if nr ='准备号码6' then
                      tmpstr:=zbharray[6]
                   else if nr ='准备号码7' then
                      tmpstr:=zbharray[7]
                   else if nr ='准备号码8' then
                      tmpstr:=zbharray[8]
                   else if nr ='准备号码9' then
                      tmpstr:=zbharray[9]
                   else if nr ='准备号码10' then
                      tmpstr:=zbharray[10]
                   else if nr ='准备姓名1' then
                   begin
                      if gblYSBH=0 then
                        tmpstr:=zbxmarray[1]
                      else
                        tmpstr := dmDBAccess.ReplaceYSBH(zbxmarray[1],gblYSBH,gblYSBHZF);
                   end
                   else if nr ='准备姓名2' then
                   begin
                      if gblYSBH=0 then
                        tmpstr:=zbxmarray[2]
                      else
                        tmpstr := dmDBAccess.ReplaceYSBH(zbxmarray[2],gblYSBH,gblYSBHZF);
                   end
                   else if nr ='准备姓名3' then
                   begin
                      if gblYSBH=0 then
                        tmpstr:=zbxmarray[3]
                      else
                        tmpstr := dmDBAccess.ReplaceYSBH(zbxmarray[3],gblYSBH,gblYSBHZF);
                   end
                   else if nr ='准备姓名4' then
                   begin
                      if gblYSBH=0 then
                        tmpstr:=zbxmarray[4]
                      else
                        tmpstr := dmDBAccess.ReplaceYSBH(zbxmarray[4],gblYSBH,gblYSBHZF);
                   end
                   else if nr ='准备姓名5' then
                   begin
                      if gblYSBH=0 then
                        tmpstr:=zbxmarray[5]
                      else
                        tmpstr := dmDBAccess.ReplaceYSBH(zbxmarray[5],gblYSBH,gblYSBHZF);
                   end
                   else if nr ='准备姓名6' then
                   begin
                      if gblYSBH=0 then
                        tmpstr:=zbxmarray[6]
                      else
                        tmpstr := dmDBAccess.ReplaceYSBH(zbxmarray[6],gblYSBH,gblYSBHZF);
                   end
                   else if nr ='准备姓名7' then
                   begin
                      if gblYSBH=0 then
                        tmpstr:=zbxmarray[7]
                      else
                        tmpstr := dmDBAccess.ReplaceYSBH(zbxmarray[7],gblYSBH,gblYSBHZF);
                   end
                   else if nr ='准备姓名8' then
                   begin
                      if gblYSBH=0 then
                        tmpstr:=zbxmarray[8]
                      else
                        tmpstr := dmDBAccess.ReplaceYSBH(zbxmarray[8],gblYSBH,gblYSBHZF);
                   end
                   else if nr ='准备姓名9' then
                   begin
                      if gblYSBH=0 then
                        tmpstr:=zbxmarray[9]
                      else
                        tmpstr := dmDBAccess.ReplaceYSBH(zbxmarray[9],gblYSBH,gblYSBHZF);
                   end
                   else if nr ='准备姓名10' then
                   begin
                      if gblYSBH=0 then
                        tmpstr:=zbxmarray[10]
                      else
                        tmpstr := dmDBAccess.ReplaceYSBH(zbxmarray[10],gblYSBH,gblYSBHZF);
                   end
                   else if nr ='准备标识1' then
                      tmpstr:=getpartstr(zbby4,'1')
                   else if nr ='准备标识2' then
                      tmpstr:=getpartstr(zbby4,'2')
                   else if nr ='准备标识3' then
                      tmpstr:=getpartstr(zbby4,'3')
                   else if nr ='准备标识4' then
                      tmpstr:=getpartstr(zbby4,'4')
                   else if nr ='准备标识5' then
                      tmpstr:=getpartstr(zbby4,'5')
                   else if nr ='准备标识6' then
                      tmpstr:=getpartstr(zbby4,'6')
                   else if nr ='准备标识7' then
                      tmpstr:=getpartstr(zbby4,'7')
                   else if nr ='准备标识8' then
                      tmpstr:=getpartstr(zbby4,'8')
                   else if nr ='准备标识9' then
                      tmpstr:=getpartstr(zbby4,'9')
                   else if nr ='准备标识10' then
                      tmpstr:=getpartstr(zbby4,'10')
                   else if nr = '备用6' then
                      tmpstr:=by6
                   else if nr = '标识' then
                      tmpstr:=by4
                   else if nr='字体大小' then
                   begin
                     tmpstr:=inttostr(ztdx);
                     kd:=3;
                   end
                   else if nr='字体颜色' then
                   begin
                     tmpstr:=inttostr(ztys);
                     kd:=1;
                   end
                   else if nr='分行符' then
                   begin
                     tmpstr:='|';
                     kd:=1;
                   end;
                   if nr<>'分行符' then
                     tmpstr := AnsiReplaceStr(tmpstr,'|','');
                   if kd>length(tmpstr) then
                   begin
                     if dq='左对齐'then
                     begin
                       tmpstr:=tmpstr+spaces(kd-length(tmpstr))
                     end
                     else if dq='右对齐' then
                       tmpstr:=spaces(kd-length(tmpstr))+tmpstr
                     else if dq='居中对齐' then
                       tmpstr:=spaces((kd-length(tmpstr)) div 2)+tmpstr+spaces((kd-length(tmpstr)) div 2);
                   end;
                   //if ztdx>999 then
                   //   ztdx:=999;
                   //if ztdx<0 then
                   //   ztdx:=20;
                   //tmpstr:=inttostr(ztdx)+tmpstr+'|';
                   tmpyjpstr:=tmpyjpstr+tmpstr;
                   rs.Next;
                end;
                FreeAndNil(rs);
                tmpyjpstr:='C2'+tmpyjpstr;
              end;
               YJPIP:=qry.Fieldbyname('HostIP').AsString;
  //             ztcount := 1;
  //             ztposition :=1;
              //查找infoSrvSocket中相同的IP，并发送。
               for i:=0 to frmmain.SrvSockInfo.Socket.ActiveConnections-1 do
               begin
                  if frmmain.SrvSockInfo.Socket.Connections[i].RemoteAddress =YJPIP then
                  begin
                     if length(tmpyjpstr)>0 then
                     begin
                        if YJPtype=1 then
                        begin
                           //if ztcount >1 then
                           //frmmain.SrvSockInfo.Socket.Connections[i].SendText('CA'+inttostr(ztcount)+'#');
                           //frmmain.SrvSockInfo.Socket.Connections[i].SendText('C7'+inttostr(ztposition)+'#');
                           if LeftStr(tmpyjpstr,2)='C3' then
                           begin
                             frmmain.SrvSockInfo.Socket.Connections[i].SendText(
                                tmpyjpstr+'#');
                             dmdbaccess.addlog('yjplog.txt',tmpyjpstr+'#');
                           end
                           else
                           begin
                             frmmain.SrvSockInfo.Socket.Connections[i].SendText(
                                'CA'+inttostr(ztcount)+'#'+
                                'C7'+inttostr(ztposition)+'#'+tmpyjpstr+'#');
                             dmdbaccess.addlog('yjplog.txt','CA'+inttostr(ztcount)+'#'+
                                'C7'+inttostr(ztposition)+'#'+tmpyjpstr+'#');
                           end;
                        end
                        else
                        begin
                           if rightstr(tmpyjpstr,1)<>'#' then tmpyjpstr:=tmpyjpstr+'#';
                           frmmain.SrvSockInfo.Socket.Connections[i].SendText(tmpyjpstr);
                           dmdbaccess.addlog('yjplog.txt',tmpyjpstr);

                           if LeftStr(tmpyjpstr,2)='C2' then
                           begin
                             Sleep(10);
                             //发送语音内容:
                              if tmpghhm='暂停服务' then
                              else if tmpghhm='欢迎光临' then
                              else if tmpghhm='开诊'  then
                              else if tmpghhm='停诊'  then
                              else if tmpghhm='继续服务'  then
                              else if tmpghhm='停止服务'  then
                              else
                              begin
                               tmpSoundStr :=GetScreenSoundStr(ksid,fjh,fjmc,
                                 zth,ztmc,ksmc,
                                 tmpghhm,brxm,yhmc,yxjmc,
                                 by6,acallnos,acallnames,by4,
                                 zbharray,zbxmarray,
                                 zbby4,zbxx);
                               frmmain.SrvSockInfo.Socket.Connections[i].SendText('CD'+tmpSoundStr+'#');
                               dmdbaccess.addlog('yjplog.txt','CD'+tmpSoundStr+'#');
                              end;
                             Sleep(10);
                           end;

                           if leftstr(tmpyjpstr,2)='C1' then
                           begin
                             tmpyjpstr := frmmain.GetYJPLoginStr(yhid);
                             if length(tmpyjpstr)>3 then
                             begin
                               sleep(100);
                               frmmain.SrvSockInfo.Socket.Connections[i].SendText(tmpyjpstr);
                               dmdbaccess.addlog('yjplog.txt',tmpyjpstr);
                             end;
                           end;
                        end;
                        sleep(100);
                     end;
                     if YJPtype=1 then
                     begin
                        frmmain.SrvSockInfo.Socket.Connections[i].SendText(tmpyjpksmc+'#');
                        dmdbaccess.addlog('yjplog.txt',tmpyjpksmc+'#');
                     end;

                     //else
                     //frmmain.SrvSockInfo.Socket.Connections[i].SendText(tmpyjpksmc);
                     //sleep(100);
                           //tmpyjpksmc:='C4'+ksmc;
                    { if yjptype=1 then
                     begin
                        dmdbaccess.addlog('errorlog.txt',tmpyjpksmc+'#');
                        dmdbaccess.addlog('errorlog.txt',tmpyjpstr+'#');
                     end
                     else
                     begin
                        dmdbaccess.addlog('errorlog.txt',tmpyjpksmc);
                        dmdbaccess.addlog('errorlog.txt',tmpyjpstr);
                     end;}

                  end;
               end;
             end;
          end;
          qry.Close;
      end;
      if soundisin then
      begin
        qry.Close;
        SendUdps();
        exit;
      end;
      qry.Close;
      qry.SQL.Text:=' select 1 from  ' +
                              ' t_xsnrsz (nolock) ' +
                              ' where hszh=' + inttostr(gblhszh)+
                              ' and xsms=99';
      qry.Open;
       if not soundisin then
       begin
             if tmpghhm='暂停服务' then  sybz:='0'
             else if tmpghhm='欢迎光临' then sybz:='0'
             else if tmpghhm='开诊'  then sybz:='0'
             else if tmpghhm='停诊'  then sybz:='0'
             else if tmpghhm='继续服务'  then sybz:='0'
             else if tmpghhm='停止服务'  then sybz:='0'
             else sybz:='1';
             if (length(tmpghhm)=0) then
             begin
              dispstate:=0;
              sybz:='0';
             end;
       end
       else
            sybz:='0';
      if  not qry.Eof then
      begin

            //    if i=1 then
        //       sybz:='1';
         //    else
        //       sybz:='0';
            if ztbz=1 then
            begin
            cmdstr:=' insert into t_xsxx(xspid,hjid,fjh,fjmc,zth,ztmc,ksid,ksmc,ghhm,' +
                    ' yhid,yhmc,brxm,yxjid,yxjmc,ddrs,sybz,ZTBZ,zbxx,hszh,'+
                    ' zbh1,zbxm1,zbh2,zbxm2,zbh3,zbxm3,zbh4,zbxm4,zbh5,zbxm5,zbh6,zbxm6,zbh7,zbxm7,'+
                    ' zbh8,zbxm8,zbh9,zbxm9,zbh10,zbxm10,state,by6) ' +
                    ' values( ' +
                    ' ''0'''+
                    ',''' +zdid + ''''+
                    ',''' +fjh + ''''+
                    ',''' +fjmc + ''''+
                    ',''' + zth + ''''+
                    ',''' +ztmc + ''''+
                    ','''+ ksid + ''''+
                    ','''+ksmc + '''' +
                    ','''+ tmpghhm+ ''''+
                    ','''+ yhid +''''+
                    ','''+yhmc + ''''+
                    ',''' + tmpbrxm + ''''+
                    ',''' + yxjid + ''''+
                    ',''' + yxjmc + ''''+
                    ','+ inttostr(ddrs) +
                    ',''' + sybz + ''''+
                    ',''1'''+
                    ','''+zbxx+''''+
                    ',' + inttostr(gblhszh) +
                    ','''+zbharray[1]+''''+
                    ','''+zbxmarray[1]+''''+
                    ','''+zbharray[2]+''''+
                    ','''+zbxmarray[2]+''''+
                    ','''+zbharray[3]+''''+
                    ','''+zbxmarray[3]+''''+
                    ','''+zbharray[4]+''''+
                    ','''+zbxmarray[4]+''''+
                    ','''+zbharray[5]+''''+
                    ','''+zbxmarray[5]+''''+
                    ','''+zbharray[6]+''''+
                    ','''+zbxmarray[6]+''''+
                    ','''+zbharray[7]+''''+
                    ','''+zbxmarray[7]+''''+
                    ','''+zbharray[8]+''''+
                    ','''+zbxmarray[8]+''''+
                    ','''+zbharray[9]+''''+
                    ','''+zbxmarray[9]+''''+
                    ','''+zbharray[10]+''''+
                    ','''+zbxmarray[10]+''''+
                    ','+inttostr(dispstate)+
                    ','''+by6+''''+
                    ')'
            end
            else if ztbz=2 then
            begin
            cmdstr:=' insert into t_xsxx(xspid,hjid,fjh,fjmc,zth,ztmc,ksid,ksmc,ghhm,' +
                    ' yhid,yhmc,brxm,yxjid,yxjmc,ddrs,sybz,ZTBZ,zbxx,hszh'+
                    ' zbh1,zbxm1,zbh2,zbxm2,zbh3,zbxm3,zbh4,zbxm4,zbh5,zbxm5,zbh6,zbxm6,zbh7,zbxm7,'+
                    ' zbh8,zbxm8,zbh9,zbxm9,zbh10,zbxm10,state,by6) ' +
                    ' values( ' +
                    ' ''0'''+
                    ',''' +zdid + ''''+
                    ',''' +fjh + ''''+
                    ',''' +fjmc + ''''+
                    ',''' + zth + ''''+
                    ',''' +ztmc + ''''+
                    ','''+ ksid + ''''+
                    ','''+ksmc + '''' +
                    ','''+ tmpghhm+ ''''+
                    ','''+ yhid +''''+
                    ','''+yhmc + ''''+
                    ',''' + tmpbrxm + ''''+
                    ',''' + yxjid + ''''+
                    ',''' + yxjmc + ''''+
                    ','+ inttostr(ddrs) +
                    ',''' + '0' + ''''+
                    ',''2'''+
                    ','''+zbxx+''''+
                    ',' + inttostr(gblhszh)+
                    ','''+zbharray[1]+''''+
                    ','''+zbxmarray[1]+''''+
                    ','''+zbharray[2]+''''+
                    ','''+zbxmarray[2]+''''+
                    ','''+zbharray[3]+''''+
                    ','''+zbxmarray[3]+''''+
                    ','''+zbharray[4]+''''+
                    ','''+zbxmarray[4]+''''+
                    ','''+zbharray[5]+''''+
                    ','''+zbxmarray[5]+''''+
                    ','''+zbharray[6]+''''+
                    ','''+zbxmarray[6]+''''+
                    ','''+zbharray[7]+''''+
                    ','''+zbxmarray[7]+''''+
                    ','''+zbharray[8]+''''+
                    ','''+zbxmarray[8]+''''+
                    ','''+zbharray[9]+''''+
                    ','''+zbxmarray[9]+''''+
                    ','''+zbharray[10]+''''+
                    ','''+zbxmarray[10]+''''+
                    ','+inttostr(dispstate)+
                    ','''+by6+''''+
                    ')';
            end;
            try
              if (ztbz=1) or (ztbz=2) then
                adoconnection.execute(cmdstr,cmdtext);
            except
                if ztbz=1 then
                begin
                cmdstr:=' insert into t_xsxx(xspid,hjid,fjh,fjmc,zth,ztmc,ksid,ksmc,ghhm,' +
                        ' yhid,yhmc,brxm,yxjid,yxjmc,ddrs,sybz,ZTBZ,zbxx,hszh) ' +
                        ' values( ' +
                        ' ''0'''+
                        ',''' +zdid + ''''+
                        ',''' +fjh + ''''+
                        ',''' +fjmc + ''''+
                        ',''' + zth + ''''+
                        ',''' +ztmc + ''''+
                        ','''+ ksid + ''''+
                        ','''+ksmc + '''' +
                        ','''+ tmpghhm+ ''''+
                        ','''+ yhid +''''+
                        ','''+yhmc + ''''+
                        ',''' + tmpbrxm + ''''+
                        ',''' + yxjid + ''''+
                        ',''' + yxjmc + ''''+
                        ','+ inttostr(ddrs) +
                        ',''' + sybz + ''''+
                        ',''1'''+
                        ','''+zbxx+''''+
                        ',' + inttostr(gblhszh) +')'
                end
                else if ztbz=2 then
                begin
                cmdstr:=' insert into t_xsxx(xspid,hjid,fjh,fjmc,zth,ztmc,ksid,ksmc,ghhm,' +
                        ' yhid,yhmc,brxm,yxjid,yxjmc,ddrs,sybz,ZTBZ,zbxx,hszh) ' +
                        ' values( ' +
                        ' ''0'''+
                        ',''' +zdid + ''''+
                        ',''' +fjh + ''''+
                        ',''' +fjmc + ''''+
                        ',''' + zth + ''''+
                        ',''' +ztmc + ''''+
                        ','''+ ksid + ''''+
                        ','''+ksmc + '''' +
                        ','''+ tmpghhm+ ''''+
                        ','''+ yhid +''''+
                        ','''+yhmc + ''''+
                        ',''' + tmpbrxm + ''''+
                        ',''' + yxjid + ''''+
                        ',''' + yxjmc + ''''+
                        ','+ inttostr(ddrs) +
                        ',''' + '0' + ''''+
                        ',''2'''+
                        ','''+zbxx+''''+
                        ',' + inttostr(gblhszh) +')';
                end;
                if (ztbz=1) or (ztbz=2) then
                adoconnection.execute(cmdstr,cmdtext);
            end;
      end;
      qry.Close;
      SendUdps();
    except
      begin
        addlog('errorlog.txt','写入显示信息表t_xsxx出现错误!');
        Exit;
      end;
    end;
  finally
    Freeandnil(qry);
  end;
end;

procedure TdmDBAccess.DataModuleCreate(Sender: TObject);
begin
//     tmpstr:=ADODB.PromptDataSource(Self.Handle, '');//调用设置字符串的窗口
//  adoconnection1.ConnectionString:=tmpstr;
end;
{*******************************************************************************
*函数名:SetFZZHItems;
                                           *
*函数机能:将T_DHXX表中JZBZ<>'1'的数据显示到LISTVIEW中.
//ordertype 1-按号码
//ordertype 2-按时间
//ordertype 3-按by6                                        *
*******************************************************************************}
function TdmDBAccess.SetFZZHItems(var ListView:TTeThemeSListView;
       const KSID :string;const HSZH:integer;const ordertype:integer):Boolean;
var
  ListItem: TListItem;
  intFieldIndex: integer;
  qr:TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    listview.Columns.Clear;
    ListView.Items.Clear;
    try
      qr.Close;
      //在等待T_DHXX表中查找科室为KSID的本护士站的就诊的病人信息.
      qr.SQL.Text:=' select t_dhxx.brxm as ''姓  名'''+
                               ',t_dhxx.ghhm as '''+ttl_ghhm+''''+
                               ',t_dhxx.brdm as '''+ttl_br+'编号'''+
                               ',t_yh.yhmc as '''+ttl_yh+'姓名'''+
                               ',t_dhxx.ckhm as '''+ttl_zs+''''+
                               ',t_dhxx.ghsj as ''    挂  号  时  间    '''+
                               ',t_dhxx.jzsj as ''    叫  号  时  间    '''+
                               ',t_dhxx.id as ''记录序号'' '+
                               ',t_dhxx.by7 as "预约时段" '+
                               ',t_dhxx.yxjid as "优先级" '+
                               ',s.sjdmc as "时间段" '+
                               ',t_dhxx.by6 as "号别" '+
                               ' from  ' +
                              ' t_dhxx left OUTER join t_YH on t_dhxx.yhid=t_YH.yhid and t_dhxx.hszh=t_YH.hszh ' +
                              ' left outer join t_sjdsz s on t_dhxx.sjdbz=s.sjdbz and t_dhxx.hszh=s.hszh '+
                              ' where t_dhxx.ksid=''' + ksid + '''' + ' and t_dhxx.jzbz=''0''' + ' and t_dhxx.hszh=' + inttostr(gblhszh);
      if (ordertype=1) then
         qr.SQL.Text:=qr.SQL.Text+
                      ' order by t_dhxx.sjdbz,replicate(''0'',10-len(ghhm))+ghhm ,t_dhxx.by6 '
      else if (ordertype=2) then
         qr.SQL.Text:=qr.SQL.Text+
                      ' order by t_dhxx.sjdbz,ghsj,t_dhxx.by6 '
      else
         qr.SQL.Text:=qr.SQL.Text+
                      ' order by t_dhxx.sjdbz,t_dhxx.by6,replicate(''0'',10-len(ghhm))+ghhm  ';

//                              ' order by replicate(''0'',10-len(ghhm))+ghhm  ';
      qr.Open;
      for intfieldindex:=0 to qr.Fields.Count-1 do
      begin
         listview.Columns.Add;
         listview.Columns[intfieldindex].Caption:=qr.Fields.Fields[intfieldindex].FieldName;
         listview.Columns[intfieldindex].Width := (Length(listview.Columns[intfieldindex].Caption)+2) * ListView.Canvas.TextWidth('A');
      end;
      //listview.Columns.Add;
      if qr.Fields.Count>7 then
      begin
        listview.Columns[7].Caption:=qr.Fields.Fields[7].FieldName;
        listview.Columns[7].Width := 0;
      end;
      if qr.Fields.Count>10 then
      begin
        //listview.Columns[7].Caption:=qr.Fields.Fields[7].FieldName;
        listview.Columns[10].Width := 0;
      end;
      ///////////将数据放入LISTVIEW中.
      with qr do
      begin
         while not qr.Eof do
         begin
            listItem:=listview.Items.add;
            ListItem.Caption := Fields[0].AsString;
            for intFieldIndex := 1 to qr.Fields.Count-1 do
            begin
               ListItem.SubItems.Add(fields.Fields[intFieldIndex].AsString);
            end;
            Next;
         end;
         Close;
      end;
    except
      begin
        result := False;
        Exit;
      end;
    end;
    result := True;
  finally
    FreeAndNil(qr);
  end;
end ;
{*******************************************************************************
*函数名:FZZH;
                                           *
*函数机能:复诊召回                                          *
*******************************************************************************}
function TdmDBAccess.FZZH(const JRID:string;const KSID:string;const AkeepYH:integer;const AYHID:string;
  const afzorzh:integer):boolean;
var
  cmdStr:wideString;
  ddbrrs:integer;
  ddbrfzrs:integer;
  ddbrfzZDXSID:integer;
  tmpFzws:integer;
  yhid:string;
  qr:TADOQuery;
  ghhm:string;
  kssxid,tmpkssxid:Integer;
  y:integer;
  x,sjdbz:Integer;
  yxjid:integer;//优先级
  by7:string;//预约时间段
begin
  //调用存储过程，如果成功则返回成功。
  if DB_RebackPatientByID(JRID,gblHSZH,AkeepYH,AYHID,gblfzzhtype,afzorzh) then
  begin
    result:=true;
    exit;
  end;

  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
       with adoconnection do
       begin
         if gblfzzhtype=1 then   //如果不按召回算法安排病人顺序只按号码大小序
         begin
           cmdstr:=' select ghhm,sjdbz,yxjid from t_dhxx (nolock) where'+
                   ' id=:pid';
           qr.SQL.Clear;
           qr.Parameters.Clear;
           qr.SQL.Text:=cmdstr;
           qr.Parameters.ParamByName('pid').Value := JRID;
           qr.Open;
           if not qr.Eof then
           begin
              ghhm := qr.fieldbyname('ghhm').AsString ;
              sjdbz := qr.fieldbyname('sjdbz').AsInteger;
              yxjid := qr.fieldbyname('yxjid').AsInteger;
//              by7 := qr.fieldbyname('by7').AsString;
           end
           else
           begin
              ghhm :='';
              sjdbz :=1;// qr.fieldbyname('sjdbz').AsInteger;
           end;
           qr.Close;
//           try
//             qr.Parameters.Clear;
//             qr.SQL.Text:=cmdstr;
//             cmdstr:=' select kssxid from t_dhxx (nolock) where'+
//                     ' replicate(''0'',10-len(ghhm))+ghhm>replicate(''0'',10-len(:p1))+:p2'+
//                     ' and ksid=:p3'+
//                     ' and hszh=:p4'+
//                     ' and jzbz=1'+
//                     ' and ztbz<>5'+
//                     ' and (yxjid=0)'+
//                     ' order by convert(varchar(10),ghsj,112),replicate(''0'',10-len(ghhm))+ghhm';
//             qr.SQL.Text:=cmdstr;
//             qr.Parameters.ParamByName('p1').Value := ghhm;
//             qr.Parameters.ParamByName('p2').Value := ghhm;
//             qr.Parameters.ParamByName('p3').Value := ksid;
//             qr.Parameters.ParamByName('p4').Value := gblHSZH;
//             qr.Open;
//           except
//
//           end;
//           if not qr.Eof then
//           begin
//              kssxid:=qr.fieldbyname('kssxid').AsInteger;
//           end
//           else
//           begin
//              qr.Close;
//              qr.SQL.Text :='select max(kssxid) as max_sxid from t_dhxx where '+
//                   ' ksid='''+ksid +''''+
//                   ' and hszh='+inttostr(gblhszh)+
//                   ' and jzbz=1';
//              qr.Open;
//              if qr.FieldByName('max_sxid').AsInteger=0 then
//                 kssxid:=1
//              else
//                 kssxid:=qr.FieldByName('max_sxid').AsInteger+1;
//           end;
//           qr.Close;
//           try
//
//             qr.Parameters.Clear;
//             qr.SQL.Text:=cmdstr;
//             cmdstr:=' select kssxid from t_dhxx (nolock) where'+
//                     ' replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len(:p1))+:p2'+
//                     ' and ksid=:p3'+
//                     ' and hszh=:p4'+
//                     ' and jzbz=1'+
//                     ' and ztbz<>5'+
//                     ' and (yxjid=0)'+
//                     ' order by kssxid desc';
//             qr.SQL.Text:=cmdstr;
//             qr.Parameters.ParamByName('p1').Value := ghhm;
//             qr.Parameters.ParamByName('p2').Value := ghhm;
//             qr.Parameters.ParamByName('p3').Value := ksid;
//             qr.Parameters.ParamByName('p4').Value := gblHSZH;
//             qr.Open;
//           except
//
//           end;
//           if not qr.Eof then
//           begin
//              tmpkssxid:=qr.fieldbyname('kssxid').AsInteger;
//           end
//           else
//              tmpkssxid:=0;
//           qr.Close;
//           try
//
//             qr.Parameters.Clear;
//             qr.SQL.Text:=cmdstr;
//             cmdstr:=' select max(kssxid) as kssxid from t_dhxx (nolock) where'+
//                     ' ksid=:p3'+
//                     ' and hszh=:p4'+
//                     ' and jzbz=1 and ztbz=5';
//             qr.SQL.Text:=cmdstr;
//             qr.Parameters.ParamByName('p3').Value := ksid;
//             qr.Parameters.ParamByName('p4').Value := gblHSZH;
//             qr.Open;
//           except
//
//           end;
//           if not qr.Eof then
//           begin
//              if qr.fieldbyname('kssxid').AsInteger>tmpkssxid then
//              begin
//                tmpkssxid:=qr.fieldbyname('kssxid').AsInteger;
//              end;
//           end;
//           qr.Close;
//           if tmpkssxid>=kssxid then
//              kssxid:=tmpkssxid+1;
//           try
//             qr.Parameters.Clear;
//             qr.SQL.Text:=cmdstr;
//             cmdstr:=' select min(kssxid) as kssxid from t_dhxx (nolock) where'+
//                     ' ksid=:p3'+
//                     ' and hszh=:p4'+
//                     ' and jzbz=2 and ztbz=6';
//             qr.SQL.Text:=cmdstr;
//             qr.Parameters.ParamByName('p3').Value := ksid;
//             qr.Parameters.ParamByName('p4').Value := gblHSZH;
//             qr.Open;
//           except
//
//           end;
//           if not qr.Eof then
//           begin
//              if ((qr.fieldbyname('kssxid').AsInteger>0) and
//                (qr.fieldbyname('kssxid').AsInteger<kssxid)) then
//              begin
//                kssxid:=qr.fieldbyname('kssxid').AsInteger;
//              end;
//           end;
//           qr.Close;
            kssxid :=0;
            //得到准备病人最大kssxid.
            x := GetZBBRMaxKSSXID(ksid,JRID,gblHSZH);
            if (x>0) and (x>=kssxid) then
              kssxid :=x+1;
            //得到已发短信病人最大kssxid
            x := GetSendSmsMaxKSSXID(ksid,JRID,gblHSZH);
            if (x>0) and (x>=kssxid) then
              kssxid :=x+1;
            //得到预约病人最大kssxid
            x := GetYYBRMaxKSSXID(ksid,'',JRID,IntToStr(sjdbz),gblHSZH);
            if (x>0) and (x>=kssxid) then
              kssxid:= x+1;
           //先找到t_dhxx.sjdbz<sjdbz的病人最大kssxid
            x := GetMinSjdbzPos(ksid,IntToStr(sjdbz),JRID,gblHSZH);
            if (x>0) and (x>=kssxid) then
              kssxid:= x+1;
           //再找t_dhxx.sjdbz=sjdbz前且号码比ghhm小的病人最大kssxid
            x := GetSameSjdbzPos(ksid,IntToStr(sjdbz),ghhm,JRID,gblHSZH);
            if (x>0) and (x>=kssxid) then
              kssxid := x+1;
            if kssxid=0 then kssxid:=1;
           cmdstr:=' UPDATE t_dhxx ' +
                  ' Set kssxid=kssxid+1 ' +
                  ' where jzbz<>0 and ksid=''' + ksid +'''' +
                  ' and hszh=' + inttostr(gblHSZH)+
                  ' and kssxid>=' + inttostr(kssxid);
           execute(cmdstr,cmdtext);
           if (gblBRDYS=0)  or (AkeepYH=0) then
              cmdStr:=' UPDATE t_dhxx ' +
                  ' Set JZBZ=1' +
                  ',ztbz=2'+
                  ',yhlcs=0'+
                  ',jzsj=null' +
                  ',yxjid=1'+
                  ',by1=''0'''+ //取消此人的预约优先。
                  ',yhid=null' +
                  ',kssxid=' +inttostr(kssxid) +
                  ' where id=' +jrid
           else if AkeepYH=2 then
           begin
              cmdStr:=' UPDATE t_dhxx ' +
                  ' Set JZBZ=1' +
                  ',ztbz=2'+
                  ',yhlcs=0'+
                  ',jzsj=null' +
                  ',yxjid=1'+
                  ',by1=''0'''+ //取消此人的预约优先。
                  ',yhid=''' +Ayhid+''''+
                  ',kssxid=' +inttostr(kssxid) +
                  ' where id=' +jrid
           end
           else
           begin
              cmdStr:=' UPDATE t_dhxx ' +
                  ' Set JZBZ=1' +
                  ',ztbz=2'+
                  ',jzsj=null' +
                  ',yxjid=1'+
                  ',by1=''0'''+ //取消此人的预约优先。
                  ',yhlcs=0'+
                  ',kssxid=' +inttostr(kssxid) +
                  ' where id=' +jrid;
           end;
            execute(cmdstr,cmdtext);
           FreeAndNil(qr);
           if yxjid=88 then
           begin
             SZYXJ(jrid,'88');
           end;
         end
         else
         begin
           //2013-07-08修改吴刚
           cmdstr:=' select ghhm,sjdbz from t_dhxx (nolock) where'+
                   ' id=:pid';
           qr.SQL.Clear;
           qr.Parameters.Clear;
           qr.SQL.Text:=cmdstr;
           qr.Parameters.ParamByName('pid').Value := JRID;
           qr.Open;
           if not qr.Eof then
           begin
              ghhm := qr.fieldbyname('ghhm').AsString ;
              sjdbz := qr.fieldbyname('sjdbz').AsInteger;
           end
           else
           begin
              ghhm :='';
              sjdbz :=1;// qr.fieldbyname('sjdbz').AsInteger;
           end;
           qr.Close;
            kssxid :=0;
            //得到准备病人最大kssxid.
            x := GetZBBRMaxKSSXID(ksid,JRID,gblHSZH);
            if (x>0) and (x>=kssxid) then
              kssxid :=x+1;
            //得到已发短信病人最大kssxid
            x := GetSendSmsMaxKSSXID(ksid,JRID,gblHSZH);
            if (x>0) and (x>=kssxid) then
              kssxid :=x+1;
            //得到预约病人最大kssxid
            x := GetYYBRMaxKSSXID(ksid,'',JRID,IntToStr(sjdbz),gblHSZH);
            if (x>0) and (x>=kssxid) then
              kssxid:= x+1;
           //先找到t_dhxx.sjdbz<sjdbz的病人最大kssxid
            x := GetMinSjdbzPos(ksid,IntToStr(sjdbz),JRID,gblHSZH);
            if (x>0) and (x>=kssxid) then
              kssxid:= x+1;
            if kssxid=0 then kssxid:=1;
            if (gblFZWS>kssxid) then
              kssxid := gblFZWS;
            if gblFZAYS=1 then
            begin
              qr.SQL.Text:=' select yhid from  ' +
                  ' t_dhxx ' +
                  ' where id='+JRID+
                  ' and hszh=' + inttostr(gblhszh);
              qr.Open;
              if not qr.Eof then
                 yhid:=qr.Fields.Fields[0].Asstring
              else
                 yhid:='';
              qr.Close;
              //得到科室中选择当前复诊病人所选医生队列中等待并复诊的病人最大顺序号.
              qr.SQL.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
                  ' t_dhxx ' +
                  ' where ksid=''' + ksid + ''''+
                  ' and yhid='''+yhid+''''+
                  //' and jzbz<>''0''' +
                  ' and jzbz=1 ' +
                  ' and ztbz=2 ' +
                  ' and hszh=' + inttostr(gblhszh);
              qr.Open;
              if qr.Fields.Fields[0].AsInteger=0 then
              begin
                 qr.Close;
                 qr.SQL.Text:=' select  top '+inttostr(gblfzws)+' KSSXID  from  ' +
                    ' t_dhxx ' +
                    ' where ksid=''' + ksid + ''''+
                    ' and yhid='''+yhid+''''+
                    //' and jzbz<>''0''' +
                    ' and jzbz=1 ' +
                    ' and hszh=' + inttostr(gblhszh) +
                    ' order by KSSXID';
                 qr.Open;
                 if qr.Eof then
                    ddbrfzZDXSID:=0
                 else
                 begin
                    qr.Last;
                    ddbrfzZDXSID:=qr.Fields.Fields[0].AsInteger;
                 end;
                 qr.Close;
      //             ddbrfzZDXSID:=gblfzws;
              end
              else
              begin
                 ddbrfzZDXSID:=qr.Fields.Fields[0].AsInteger;
                 qr.Close;
              end;
            end
            else
            begin
              //得到科室中等待并复诊的病人最大顺序号.
              qr.SQL.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
                  ' t_dhxx ' +
                  ' where ksid=''' + ksid + ''''+
                  //' and jzbz<>''0''' +
                  ' and jzbz=1 ' +
                  ' and ztbz=2 ' +
                  ' and hszh=' + inttostr(gblhszh);
              qr.Open;
              if qr.Fields.Fields[0].AsInteger=0 then
                 ddbrfzZDXSID:=0
              else
                 ddbrfzZDXSID:=qr.Fields.Fields[0].AsInteger;
              qr.Close;
            end;
            if (ddbrfzZDXSID>0) and (ddbrfzZDXSID>=kssxid) then
            begin
              kssxid :=ddbrfzZDXSID+1+gblfzjgws;
            end;

           //---------------------------------------
           //得到当前科室中的等待人数.
           qr.Close;
           qr.SQL.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
              ' t_dhxx ' +
              ' where ksid=''' + ksid + ''''+
              //' and jzbz<>''0'' ' +
              ' and jzbz=1 ' +
              ' and hszh=' + inttostr(gblhszh);
            qr.Open;
            ddbrrs:=qr.Fields.Fields[0].AsInteger;
           qr.Close;
//          //得到科室中等待并且是复诊的人数
//          qr.SQL.Text:=' select  count(*) as num  from  ' +
//              ' t_dhxx ' +
//              ' where ksid=''' + ksid + ''''+
//              //' and jzbz<>''0''' +
//              ' and jzbz=1 ' +
//              ' and ztbz=2 ' +
//              ' and hszh=' + inttostr(gblhszh);
//          qr.Open;
//          ddbrfzrs:=qr.Fields.Fields[0].AsInteger;
//          qr.Close;
//                  /////////// added by WuGang @2007-04-09 start
//          ////////当gblFZAYS=1时,要按照医生来定复诊的位置.
//          if gblFZAYS=1 then
//          begin
//            qr.SQL.Text:=' select yhid from  ' +
//                ' t_dhxx ' +
//                ' where id='+JRID+
//                ' and hszh=' + inttostr(gblhszh);
//            qr.Open;
//            if not qr.Eof then
//               yhid:=qr.Fields.Fields[0].Asstring
//            else
//               yhid:='';
//            qr.Close;
//            //得到科室中选择当前复诊病人所选医生队列中等待并复诊的病人最大顺序号.
//            qr.SQL.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
//                ' t_dhxx ' +
//                ' where ksid=''' + ksid + ''''+
//                ' and yhid='''+yhid+''''+
//                //' and jzbz<>''0''' +
//                ' and jzbz=1 ' +
//                ' and ztbz=2 ' +
//                ' and hszh=' + inttostr(gblhszh);
//            qr.Open;
//            if qr.Fields.Fields[0].AsInteger=0 then
//            begin
//               qr.Close;
//               qr.SQL.Text:=' select  top '+inttostr(gblfzws)+' KSSXID  from  ' +
//                  ' t_dhxx ' +
//                  ' where ksid=''' + ksid + ''''+
//                  ' and yhid='''+yhid+''''+
//                  //' and jzbz<>''0''' +
//                  ' and jzbz=1 ' +
//                  ' and hszh=' + inttostr(gblhszh) +
//                  ' order by KSSXID';
//               qr.Open;
//               if qr.Eof then
//                  ddbrfzZDXSID:=0
//               else
//               begin
//                  qr.Last;
//                  ddbrfzZDXSID:=qr.Fields.Fields[0].AsInteger;
//               end;
//               qr.Close;
//    //             ddbrfzZDXSID:=gblfzws;
//            end
//            else
//            begin
//               ddbrfzZDXSID:=qr.Fields.Fields[0].AsInteger;
//               qr.Close;
//            end;
//          end
//          ////////////added by WuGang @2007-04-09 end;
//          else
//          begin
//            //得到科室中等待并复诊的病人最大顺序号.
//            qr.SQL.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
//                ' t_dhxx ' +
//                ' where ksid=''' + ksid + ''''+
//                //' and jzbz<>''0''' +
//                ' and jzbz=1 ' +
//                ' and ztbz=2 ' +
//                ' and hszh=' + inttostr(gblhszh);
//            qr.Open;
//            if qr.Fields.Fields[0].AsInteger=0 then
//               ddbrfzZDXSID:=0
//            else
//               ddbrfzZDXSID:=qr.Fields.Fields[0].AsInteger;
//            qr.Close;
//          end;
//          tmpFzws:=ddbrfzZDXSID+gblfzjgws;
//          if tmpfzws<gblfzws then
//             tmpfzws:=gblfzws;
//          y := GetSendSmsMaxKSSXID(KSID,JRID);
//          if (y>0) and (tmpFzws<=y) then tmpFzws := y+1;
//          y := GetYYBRMaxKSSXID(KSID,'',JRID);
//          if (y>0) and (tmpFzws<=y) then tmpFzws := y+1;
          tmpFzws := kssxid;//+gblfzjgws;
          //得到时间段比sjdbz大的病人最小kssxid.
          x:=GetLargeSjdbzPos(ksid,IntToStr(sjdbz),ghhm,jrid,gblHSZH);
          if (x>0) and (tmpFzws>x) then
            tmpFzws := x;
          if ddbrrs>=tmpfzws then
          begin
             if 1<>1 then //ddbrfzZDXSID>=tmpFzws then
             //如果等待并且复诊的最大顺序大于要插入的位置
             //则将复诊的记录插入到ddbrfzZDXSID的后一位位置
             //将原来的等待队列中顺序号大于 要插入的位置向后退一位.
             begin
                 cmdstr:=' UPDATE t_dhxx ' +
                        ' Set kssxid=kssxid+1 ' +
                        ' where jzbz<>''0'' and ksid=''' + ksid +'''' +
                        ' and hszh=' + inttostr(gblHSZH)+
                        ' and kssxid>' + inttostr(ddbrfzZDXSID);
                 execute(cmdstr,cmdtext);
                 if (gblBRDYS=0)  or (AkeepYH=0) then
                    cmdStr:=' UPDATE t_dhxx ' +
                        ' Set JZBZ=1' +
                        ',ztbz=2'+
                        ',yxjid=1'+
                        ',by1=''0'''+ //取消此人的预约优先。
                        ',yhlcs=0'+
                        ',jzsj=null' +
                        ',yhid=null' +
                        ',kssxid=' +inttostr(ddbrfzZDXSID+1) +
                        ' where id=' +jrid
                 else if AkeepYH=2 then
                 begin
                    cmdStr:=' UPDATE t_dhxx ' +
                        ' Set JZBZ=1' +
                        ',ztbz=2'+
                        ',yxjid=1'+
                        ',by1=''0'''+ //取消此人的预约优先。
                        ',yhlcs=0'+
                        ',jzsj=null' +
                        ',yhid=''' +Ayhid+''''+
                        ',kssxid=' +inttostr(ddbrfzZDXSID+1) +
                        ' where id=' +jrid
                 end
                 else
                 begin
                    cmdStr:=' UPDATE t_dhxx ' +
                        ' Set JZBZ=1' +
                        ',ztbz=2'+
                        ',yxjid=1'+
                        ',by1=''0'''+ //取消此人的预约优先。
                        ',jzsj=null' +
                        ',yhlcs=0'+
                        ',kssxid=' +inttostr(ddbrfzZDXSID+1) +
                        ' where id=' +jrid;
                 end;
                  execute(cmdstr,cmdtext);
             end
             else
             //如果等待并且复诊的最大顺序小于要插入的位置
             //则将复诊的记录插入到gblFZWS的位置
             //并将原来的等待队列中顺序号大于要插入的位置向后退一位.
             begin
                 cmdstr:=' UPDATE t_dhxx ' +
                        ' Set kssxid=kssxid+1 ' +
                        ' where jzbz<>''0'' and ksid=''' + ksid +'''' +
                        ' and hszh=' + inttostr(gblHSZH)+
                        ' and kssxid>=' + inttostr(tmpFzws);
                 execute(cmdstr,cmdtext);
                 if (gblBRDYS=0)  or (AkeepYH=0) then
                    cmdStr:=' UPDATE t_dhxx ' +
                        ' Set JZBZ=''1''' +
                        ',ztbz=2'+
                        ',yxjid=1'+
                        ',by1=''0'''+ //取消此人的预约优先。
                        ',yhlcs=0'+
                        ',yhid=''''' +
                        ',jzsj=null' +
                        ',kssxid=' +inttostr(tmpFzws) +
                        ' where id=' +jrid
                 else if AkeepYH=2 then
                 begin
                    cmdStr:=' UPDATE t_dhxx ' +
                        ' Set JZBZ=''1''' +
                        ',ztbz=2'+
                        ',yxjid=1'+
                        ',by1=''0'''+ //取消此人的预约优先。
                        ',yhlcs=0'+
                        ',jzsj=null' +
                        ',yhid=''' +Ayhid+''''+
                        ',kssxid=' +inttostr(tmpFzws) +
                        ' where id=' +jrid
                 end
                 else
                    cmdStr:=' UPDATE t_dhxx ' +
                        ' Set JZBZ=''1''' +
                        ',ztbz=2'+
                        ',yxjid=1'+
                        ',by1=''0'''+ //取消此人的预约优先。
                        ',yhlcs=0'+
                        ',jzsj=null' +
                        ',kssxid=' +inttostr(tmpFzws) +
                        ' where id=' +jrid;
                  execute(cmdstr,cmdtext);
             end;
          end
          else
          //如果等待人数小于复诊召回要插入的位置就直接将本条记录的顺序号改为等待人数+1
          //即插入到最后.
          begin
             cmdstr:=' UPDATE t_dhxx ' +
                    ' Set kssxid=kssxid+1 ' +
                    ' where jzbz<>''0'' and ksid=''' + ksid +'''' +
                    ' and hszh=' + inttostr(gblHSZH)+
                    ' and kssxid>=' + inttostr(ddbrrs+1);
             execute(cmdstr,cmdtext);
             if (gblBRDYS=0) or (AkeepYH=0) then
                cmdStr:=' UPDATE t_dhxx ' +
                    ' Set JZBZ=''1''' +
                    ',ztbz=2'+
                    ',yxjid=1'+
                    ',by1=''0'''+ //取消此人的预约优先。
                    ',yhlcs=0'+
                    ',jzsj=null' +
                    ',yhid=''''' +
                    ',kssxid=' +inttostr(ddbrrs+1) +
                    ' where id=' +jrid
             else if AkeepYH=2 then
             begin
                cmdStr:=' UPDATE t_dhxx ' +
                    ' Set JZBZ=''1''' +
                    ',ztbz=2'+
                    ',yxjid=1'+
                    ',by1=''0'''+ //取消此人的预约优先。
                    ',yhlcs=0'+
                    ',jzsj=null' +
                    ',yhid=''' +Ayhid+''''+
                    ',kssxid=' +inttostr(ddbrrs+1) +
                    ' where id=' +jrid
             end
             else
                cmdStr:=' UPDATE t_dhxx ' +
                    ' Set JZBZ=''1''' +
                    ',ztbz=2'+
                    ',yxjid=1'+
                    ',by1=''0'''+ //取消此人的预约优先。
                    ',yhlcs=0'+
                    ',jzsj=null' +
                    ',kssxid=' +inttostr(ddbrrs+1) +
                    ' where id=' +jrid;
              execute(cmdstr,cmdtext);
          end;
           //如果召回的病人中有转移到其他科室但未处理的，把转移的标志改成已算处理
           cmdStr:='update t_ksJzh  set clbz=0 where tmpid = ' +  JRID;
           execute(cmdstr,cmdtext);
         end;
       end;
       result:=true;

    except
      begin
        result := False;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;


end;
{*******************************************************************************
*函数名:QH;
                                           *
*函数机能:弃号                                          *
*******************************************************************************}
function Tdmdbaccess.Qh(const jrid :string;const kssxid :string;const ksid:string):Boolean;
var
  cmdStr:wideString;
  tmpquery:tadoquery;
  tmpkssxid:integer;
begin
  try
     with adoconnection do
     begin
       tmpquery:=tadoquery.Create(nil);
       tmpquery.Connection:=adoconnection;
       tmpquery.SQL.Clear;
       tmpquery.SQL.Add('Select kssxid from t_dhxx where id=' + jrid);
       tmpquery.Open;
       if tmpquery.Eof then
       begin
          FreeAndNil(tmpquery);
          exit;
       end
       else
       begin
          tmpkssxid:=tmpquery.fieldbyname('kssxid').AsInteger;
          FreeAndNil(tmpquery);
       end;

       cmdstr:=' UPDATE t_dhxx ' +
              ' Set kssxid=kssxid-1 ' +
              ' where jzbz<>''0'' and ksid=''' + ksid +'''' +
              ' and kssxid>' + inttostr(tmpkssxid) +
              ' and hszh=' + inttostr(gblHSZH);
       execute(cmdstr,cmdtext);
       cmdStr:=' UPDATE t_dhxx ' +
              ' Set JZBZ='+''''+'0' +''''+
              ',jzsj=null' +
              ',ztbz='+''''+'3'+'''' +
              ',kssxid=0' +
              ',yhid=' + ''''+''''+
              '  where id=' +jrid;
        execute(cmdstr,cmdtext);
     end;
     result:=true;
  except
    begin
      result := False;
      Exit;
    end;
  end;
end;
{*******************************************************************************
*函数名:PrintNO;
                                           *
*函数机能:打印记录序号为jrid的排队票单                                         *
参数:jrid t_dhxx表中的唯一标识,
kssxid:此记录在本队列当前的排队位置
ksid:此记录所在的队列代码.
返回值:true-操作成功
false-操作失败
*******************************************************************************}

function Tdmdbaccess.PrintNO(const jrid :string):Boolean;
var
  cmdStr:wideString;
  tmpquery,tmpbtnquery:tadoquery;
  tmpkssxid:integer;
  ksid:string; //科室ID
  ksmc:string; //科室名称;
  brxm:string; //病人姓名
  brdm:string;  //病人代码;
  ghhm:string;  //挂号号码;
  hmqz:string;  //号码前缀。
  ghsj:tdatetime;//挂号时间
  ztbz:string;   //状态标志
  yhid:string;   //医生工号
  yhxm:string;//医生姓名
  jzbz:string;   //读取标志.
  by1:integer;   //
  by2:integer;
  by3:string;
  by4:string;
  by5:string;
  by6:string;
  sjdbz:integer;   //时间段标志
  ddrs:integer;    //等待人数
  dyzs:integer;//打印张数
  tmpstr:string;
begin
  Result := false;
  tmpquery:=tadoquery.Create(nil);
  tmpquery.Connection:=adoconnection;
  try

    tmpquery.SQL.Clear;
    tmpquery.SQL.Text :='select kssxid,ghhm,d.ksid,ksmc,brxm,brdm,by4,d.yhid,yhmc,by3 from t_dhxx d left outer join t_ks k on'+
      ' d.ksid = k.ksid and d.hszh=k.hszh '+
      ' left outer join t_yh y on d.yhid=y.yhid and d.hszh=y.hszh '+
      ' where id=' + jrid;
    tmpquery.Open;
     if tmpquery.Eof then
     begin
        FreeAndNil(tmpquery);
        exit;
     end
     else
     begin   //找到相应记录,可以打印票单
        tmpkssxid:=tmpquery.fieldbyname('kssxid').AsInteger;
        ghhm := tmpquery.fieldbyname('ghhm').AsString;
        ksid := tmpquery.fieldbyname('ksid').AsString;
        ksmc := tmpquery.fieldbyname('ksmc').AsString;
        brxm := tmpquery.fieldbyname('brxm').AsString;
        brdm := tmpquery.fieldbyname('brdm').AsString;
        ddrs := tmpkssxid-1;
        by3 := tmpquery.fieldbyname('by3').AsString;
        by4 := tmpquery.fieldbyname('by4').AsString;
        yhid := tmpquery.fieldbyname('yhid').AsString;
        yhxm := tmpquery.fieldbyname('yhmc').AsString;

        if gblDYPD=1 then//此参数确定要不要票单。
        begin
           //查找打印票单信息;
          tmpbtnquery:=tadoquery.Create(nil);
          tmpbtnquery.Connection:=adoconnection;
          tmpbtnquery.SQL.Clear;
          try
            tmpbtnquery.SQL.Text :=' select  t_qhajsz.pdid,t_pdwb.pdwb,t_qhajsz.dyzs from  ' +
              ' t_qhajsz left outer join t_pdwb on ' +
              ' t_qhajsz.pdid = t_pdwb.pdid and t_qhajsz.hszh =t_pdwb.hszh ' +
              ' where t_qhajsz.ksid=''' + ksid + ''''+
              ' and t_qhajsz.hszh=' + inttostr(gblhszh);
            tmpbtnquery.Open;

            with tmpbtnquery do
            begin
              if  not tmpbtnquery.Eof then
              begin
                 tick_print_info.TicketStr:=fields.Fields[1].AsString;
                 tick_print_info.TQno:=ghhm;
                 tick_print_info.TRoomNo:='1';
                 tick_print_info.TGroupCode:='';
                 tick_print_info.TGroupNo:=ksid;
                 tick_print_info.TGroupName:=ksmc;
                 tick_print_info.TCustName:=brxm;
                 tick_print_info.TCustNO:=brdm;
                 tick_print_info.TButtonName:='';
                 tick_print_info.TAVGWaitTime:='0';
                 tick_print_info.TWaitNum:=inttostr(ddrs);
                 tick_print_info.TJch:=by3;
                 tick_print_info.TBarCode:=by4;
                 tick_print_info.TYHCode :=currentuser.UserID ;
                 tick_print_info.TYHName :=currentuser.UserName;
                 tick_print_info.TYSCode :=yhid;
                 tick_print_info.TYSName :=yhxm;
                 dyzs:= fields.Fields[2].Asinteger;
                 ///打印票单;
                 dmdbaccess.PrintTick(dyzs);
                 sleep(200);
              end;
              close;
            end;
          finally
            FreeAndNil(tmpbtnquery);
          end;
          //////
        end
        else if gbldypd=2 then
        begin
            ///////////////////////
           ///使用串口发送代码打印。
           ///////////////////////
           //查找打印票单信息;
           tmpbtnquery:=tadoquery.Create(nil);
           tmpbtnquery.Connection:=adoconnection;
           tmpbtnquery.SQL.Clear;
          try
            tmpbtnquery.SQL.Text :=' select  t_qhajsz.pdid,t_pdwb.pdwb,t_qhajsz.dyzs from  ' +
              ' t_qhajsz left outer join t_pdwb on ' +
              ' t_qhajsz.pdid = t_pdwb.pdid and t_qhajsz.hszh =t_pdwb.hszh ' +
              ' where t_qhajsz.ksid=''' + ksid + ''''+
              ' and t_qhajsz.hszh=' + inttostr(gblhszh);
            tmpbtnquery.Open;

            with tmpbtnquery do
            begin
              if  not tmpbtnquery.Eof then
              begin
                 tick_print_info.TicketStr:=fields.Fields[1].AsString;
                 tick_print_info.TQno:=ghhm;
                 tick_print_info.TRoomNo:='1';
                 tick_print_info.TGroupCode:='';
                 tick_print_info.TGroupNo:=ksid;
                 tick_print_info.TGroupName:=ksmc;
                 tick_print_info.TCustName:=brxm;
                 tick_print_info.TCustNO:=brdm;
                 tick_print_info.TButtonName:='';
                 tick_print_info.TAVGWaitTime:='0';
                 tick_print_info.TWaitNum:=inttostr(ddrs);
                 tick_print_info.TJch:=by3;
                 tick_print_info.TBarCode:=by4;
                 tick_print_info.TYHCode :=currentuser.UserID ;
                 tick_print_info.TYHName :=currentuser.UserName;
                 tick_print_info.TYSCode :=yhid;
                 tick_print_info.TYSName :=yhxm;
                 dyzs:= fields.Fields[2].Asinteger;
                 ///打印票单;
                 dmdbaccess.PrintTickcom(dyzs);
                 sleep(200);
              end;
              close;
            end;
          finally
            FreeAndNil(tmpbtnquery);
          end;
          //////
        end;
        tmpquery.Close;
        FreeAndNil(tmpquery);
     end;
     result:=true;
  except
    begin
      FreeAndNil(tmpquery);
      result := False;
      Exit;
    end;
  end;
end;
{*******************************************************************************
*函数名:ReadFromHszSZ;
                                           *
*函数机能:读取护士站设置                                          *
*******************************************************************************}
function Tdmdbaccess.ReadFromHszSZ(const hszh:integer):integer;
var
  cmdStr:wideString;
  qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
       cmdstr:='select * from t_hsz (nolock) where hszh='+ inttostr(hszh);
       qr.Close;
       qr.SQL.Text:=cmdstr;
       qr.Open;
       if qr.RecordCount> 0 then
       begin
          gblhszmc:=qr.fieldbyname('hszmc').AsString ;
          gblzdfw:=qr.fieldbyname('zdfw').AsInteger ;
          gblzdpb:=qr.fieldbyname('zdpb').AsInteger ;
          gbltoday:=cdatetostr(qr.fieldbyname('zdfwsj').AsDateTime) ;
          gblzdld:=qr.fieldbyname('zdld').AsInteger ;
          gblsjdfw:=qr.fieldbyname('sjdfw').AsInteger ;
          gblyjhj:=qr.fieldbyname('yjhj').AsInteger ;
          gblzdcxjg:=qr.fieldbyname('zdcxjg').AsInteger ;
          gblbrdys:=qr.fieldbyname('brdys').AsInteger ;
          gbldypd:=qr.fieldbyname('dypd').AsInteger ;
          gblhlgn:=qr.fieldbyname('hlgn').AsInteger ;
          gblshjg:=qr.fieldbyname('shjg').AsInteger ;
          gblFhjg:=qr.fieldbyname('fhjg').AsInteger ;
          gblFZWs:=qr.fieldbyname('fzws').AsInteger ;
          gblFZJGWs:=qr.fieldbyname('fzjgws').AsInteger;
          gblhlydfs:=qr.fieldbyname('hlydfs').AsInteger;
          gblhlydws:=qr.fieldbyname('hlydws').AsInteger;
          gblhlfs:=qr.fieldbyname('hlfs').AsInteger;
          gblhlcs:=qr.fieldbyname('hlcs').AsInteger;
          gblZBRS:=qr.fieldbyname('ZBRS').AsInteger;
          gblyssjM:=qr.fieldbyname('YSSJ').asinteger;
          gblyssjN:=qr.fieldbyname('YSSJN').asinteger;
          gblTMJC:=qr.fieldbyname('TMJC').asinteger;
          gblyxjgws:=qr.fieldbyname('yxjgws').asinteger;
          gblhmpx:=qr.fieldbyname('hmpx').asinteger;
          try
            gblNeedYJP:=qr.fieldbyname('YJP').asinteger;
          except
            gblNeedYJP:=0;
          end;
          try
            gblNeedZBXYS:=qr.fieldbyname('ZBXYS').asinteger;
          except
            gblNeedZBXYS:=0;
          end;

          try
            gblFZAYS:=qr.fieldbyname('FZAYS').asinteger;
          except
            try
            dmdbaccess.ADOConnection.Execute('alter table t_hsz add FZAYS int default(0)',cmdtext);
            dmdbaccess.ADOConnection.Execute('update t_hsz set FZAYS=0',cmdtext);
            except
            end;
            gblFZAYS:=0;
          end;
          try
            gblHJYSSJ:=qr.fieldbyname('HJYSSJ').asinteger;
          except
            try
            dmdbaccess.ADOConnection.Execute('alter table t_hsz add HJYSSJ int default(0)',cmdtext);
            dmdbaccess.ADOConnection.Execute('update t_hsz set HJYSSJ=0',cmdtext);
            except
            end;
            gblHJYSSJ:=0;
          end;
          if gblHJYSSJ=0 then gblHJYSSJ :=-24*3600;
          try
            gblHJZbrs:=qr.fieldbyname('HJZbrs').asinteger;
          except
            try
            dmdbaccess.ADOConnection.Execute('alter table t_hsz add HJZbrs int default(0)',cmdtext);
            dmdbaccess.ADOConnection.Execute('update t_hsz set HJZbrs=0',cmdtext);
            except
            end;
            gblHJZbrs:=0;
          end;
          try
            gblCallEnable := qr.fieldbyname('callenable').AsInteger;
          except
            try
              dmdbaccess.ADOConnection.Execute('alter table t_hsz add callenable int default(2)',cmdtext);
              dmdbaccess.ADOConnection.Execute('update t_hsz set callenable=2',cmdtext);
            except
            end;
            gblCallEnable := 2;
          end;
          try
            gblCallWithGrpState := qr.fieldbyname('CallWithGrpState').AsInteger;
          except
            try
              dmdbaccess.ADOConnection.Execute('alter table t_hsz add CallWithGrpState int default(2)',cmdtext);
              dmdbaccess.ADOConnection.Execute('update t_hsz set CallWithGrpState=0',cmdtext);
            except
            end;
            gblCallWithGrpState := 0;
          end;
          try
            gblCallWithGrpStateAtPause := qr.fieldbyname('CallWithGrpStateAtPause').AsInteger;
          except
            try
              dmdbaccess.ADOConnection.Execute('alter table t_hsz add CallWithGrpStateAtPause int default(1)',cmdtext);
              dmdbaccess.ADOConnection.Execute('update t_hsz set CallWithGrpStateAtPause=1',cmdtext);
            except
            end;
            gblCallWithGrpStateAtPause := 1;
          end;
          try
            gblAutoCallNext := qr.fieldbyname('AutoCallNext').AsInteger;
          except
            try
              dmdbaccess.ADOConnection.Execute('alter table t_hsz add AutoCallNext int default(0)',cmdtext);
              dmdbaccess.ADOConnection.Execute('update t_hsz set AutoCallNext=0',cmdtext);
            except
            end;
            gblAutoCallNext := 0;
          end;
          try
            gblLockIP := qr.fieldbyname('LockIP').AsString;
          except
            try
              dmdbaccess.ADOConnection.Execute('alter table t_hsz add LockIP varchar(20) default('''')',cmdtext);
              dmdbaccess.ADOConnection.Execute('update t_hsz set LockIP=''''',cmdtext);
            except
            end;
            gblLockIP := '';
          end;
          try
            gblzdzb := qr.fieldbyname('AutoZB').AsInteger;
          except
            try
              dmdbaccess.ADOConnection.Execute('alter table t_hsz add AutoZB int default(0)',cmdtext);
              dmdbaccess.ADOConnection.Execute('update t_hsz set AutoZB=0',cmdtext);
            except
            end;
            gblzdzb := 0;
          end;
          try
            gblFormType := qr.fieldbyname('FormType').AsInteger;
          except
            try
              dmdbaccess.ADOConnection.Execute('alter table t_hsz add FormType int default(0)',cmdtext);
              dmdbaccess.ADOConnection.Execute('update t_hsz set FormType=0',cmdtext);
            except
            end;
            gblFormType := 0;
          end;
          if gblzbrs=0 then //如果不需要准备,则呼叫准备人数也设为0
             gblhjzbrs:=0;
          if (hourof(now)>12) or ((hourof(now)=12)  and (MinuteOf(now)>30)) then
          begin
             gblyssj:=gblyssjN;
             //frmMain.timer3.Enabled:=false;
          end
          else
             gblyssj:=gblyssjM;
          try
            gblhlblys := qr.fieldbyname('hlblys').AsInteger;
          except
            try
              dmdbaccess.ADOConnection.Execute('alter table t_hsz add hlblys int default(0)',cmdtext);
              dmdbaccess.ADOConnection.Execute('update t_hsz set hlblys=0',cmdtext);
            except
            end;
            gblhlblys := 0;
          end;
        end;
        qr.Close;
        result:=1;
    except
      begin
        result := 0;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:CHeckHsz;
                                           *
*函数机能:查看护士站号                                          *
*******************************************************************************}
function Tdmdbaccess.CHeckHszH(const hszh:integer):integer;
var
  cmdStr:wideString;
  qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
     qr.Connection := ADOConnection;
     if hszh=0 then
     begin
        result:=0;
        exit;
     end;
     cmdstr:='select * from t_hsz (nolock) where hszh='+ inttostr(hszh);
     qr.Close;
     qr.SQL.Text:=cmdstr;
     qr.Open;
     if qr.RecordCount= 0 then
     begin
        result:=1;
     end
     else
        result:=2;
     qr.Close;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:SaveToHszSZ;
                                           *
*函数机能:保存护士站设置                                          *
*******************************************************************************}
function Tdmdbaccess.SaveToHszSZ(const hszh:integer):integer;
var
  cmdStr:wideString;
  qr:TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
       cmdstr:='select * from t_hsz (nolock) where hszh='+ inttostr(hszh);
       qr.Close;
       qr.SQL.Text:=cmdstr;
       qr.Open;
       if qr.RecordCount= 0 then
       begin
           with adoconnection do
           begin
             cmdstr:=' Insert into t_hsz(hszh,hszmc ' +
                    ',zdfw,zdpb,zdfwsj,zdld,sjdfw,yjhj,zdcxjg,brdys,dypd,' +
                    'hlgn,shjg,fhjg,fzjgws,fzws,yxbz,memo,hlydfs,hlydws,hlfs,'+
                    'hlcs,yssj,yssjN,zbrs,tmjc,yxjgws,hmpx,yjp,zbxys,FZAYS,hjyssj,hjzbrs,callenable,'+
                    'CallWithGrpState,CallWithGrpStateAtPause,AutoCallNext,AutoZB,LockIP,'+
                    'ysbh,ysbhzf)'+
                    ' values(' +
                    ' '+ inttostr(hszh) +
                    ','''+gblhszmc + ''''+
                    ','+inttostr(gblzdfw) +
                    ','+inttostr(gblzdpb)+
                    ','''+cdatetostr(date)+''''+
                    ','+inttostr(gblzdld)+
                    ','+inttostr(gblsjdfw)+
                    ','+inttostr(gblyjhj)+
                    ','+inttostr(gblzdcxjg)+
                    ','+inttostr(gblbrdys)+
                    ','+inttostr(gbldypd)+
                    ','+inttostr(gblhlgn)+
                    ','+inttostr(gblshjg)+
                    ','+inttostr(gblFhjg)+
                    ','+inttostr(gblFZjgws)+
                    ','+inttostr(gblFZWs)+
                    ',0'+
                    ','''+cdatetostr(date)+'新增'''+
                    ','+inttostr(gblhlydfs)+
                    ','+inttostr(gblhlydws)+
                    ','+inttostr(gblhlfs)+
                    ','+inttostr(gblhlcs)+
                    ','+inttostr(gblyssjM)+
                    ','+inttostr(gblyssjN)+
                    ','+inttostr(gblzbrs)+
                    ','+inttostr(gbltmjc)+
                    ','+inttostr(gblyxjgws)+
                    ','+inttostr(gblhmpx)+
                    ','+inttostr(gblNeedYJP)+
                    ','+inttostr(gblNeedZBXYS)+
                    ','+inttostr(gblFZAYS)+
                    ','+inttostr(gblhjyssj)+
                    ','+inttostr(gblhjzbrs)+
                    ','+inttostr(gblCallEnable)+
                    ','+inttostr(gblCallWithGrpState)+
                    ','+inttostr(gblCallWithGrpStateAtPause)+
                    ','+inttostr(gblAutoCallNext)+','+inttostr(gblzdzb)+
                    ','+quotedstr(gblLockIP)+
                    ','+inttostr(gblysbh)+','+quotedstr(gblysbhzf)+
                    ')';
             execute(cmdstr,cmdtext);
           end;
           result:=1;
       end
       else
       begin

        {   if msgbox('已有此护士站信息,是否要更新此护士?' + #13#10+ '不正确的设置值将影响本系统的运行','警告',mb_okCancel+mb_iconQuestion)=idcancel then
           begin
              result:=3;
              exit;
           end; }
           with adoconnection do
           begin
             cmdstr:=' Update t_hsz  '+
                    ' set hszmc= '''  +gblhszmc + ''''+
                    ',zdfw='+inttostr(gblzdfw) +
                    ',zdpb='+inttostr(gblzdpb)+
                    ',zdfwsj='''+cdatetostr(date)+''''+
                    ',zdld='+inttostr(gblzdld)+
                    ',sjdfw='+inttostr(gblsjdfw)+
                    ',yjhj='+inttostr(gblyjhj)+
                    ',zdcxjg='+inttostr(gblzdcxjg)+
                    ',brdys='+inttostr(gblbrdys)+
                    ',dypd='+inttostr(gbldypd)+
                    ',hlgn='+inttostr(gblhlgn)+
                    ',shjg='+inttostr(gblshjg)+
                    ',fhjg='+inttostr(gblFhjg)+
                    ',fzjgws='+inttostr(gblFZjgWs)+
                    ',fzws='+inttostr(gblFZWs)+
                    ',memo='''+CurrentUser.Username +' ' +cdatetostr(date)+' 修改'''+
                    ',hlydfs='+inttostr(gblhlydfs)+
                    ',hlydws='+inttostr(gblhlydws) +
                    ',hlfs='+inttostr(gblhlfs) +
                    ',hlcs='+inttostr(gblhlcs) +
                    ',yssj='+inttostr(gblyssjM)  +
                    ',yssjN='+inttostr(gblyssjN)  +
                    ',zbrs='+inttostr(gblzbrs)  +
                    ',tmjc='+inttostr(gbltmjc)  +
                    ',yxjgws='+inttostr(gblyxjgws) +
                    ',hmpx='+inttostr(gblhmpx) +
                    ',yjp='+inttostr(gblNeedYJP) +
                    ',zbxys='+inttostr(gblNeedZBXYS) +
                    ',FZAYS='+inttostr(gblFZAYS)+
                    ',hjyssj='+inttostr(gblhjyssj)+
                    ',hjzbrs='+inttostr(gblhjzbrs)+
                    ',callenable='+inttostr(gblCallEnable)+
                    ',CallWithGrpState='+inttostr(gblCallWithGrpState)+
                    ',CallWithGrpStateAtPause='+inttostr(gblCallWithGrpStateAtPause)+
                    ',AutoCallNext='+inttostr(gblAutoCallNext)+
                    ',AutoZB='+inttostr(gblzdzb)+
                    ',LockIP='+quotedstr(gblLockIP)+
                    ',ysbh='+inttostr(gblysbh)+
                    ',ysbhzf='+quotedstr(gblysbhzf)+
                    ' where hszh='+inttostr(hszh);
             execute(cmdstr,cmdtext);
           end;
           result:=2;
       end;
       qr.Close;
    except
      begin
        result := 0;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:SetYSXXList;
                                           *
*函数机能:显示KSID的医生列表
                                         *
*******************************************************************************}
function Tdmdbaccess.SetYSXXList(var ListView:TTeThemeSListView;const KSID:string;const isLogin:integer;
       const HSZH:integer):Boolean ;
var
  ListItem: TListItem;
  intFieldIndex: integer;
  qr:TADOQuery;
  hjksnum:integer;
  hjks:array[1..20] of CallGroup_Info;
  i:integer;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    listview.Columns.Clear;
    ListView.Items.Clear;
    try
      qr.Close;
      //在等待T_DHXX表中查找科室为KSID的本护士站的未就诊的病人信息.
      if length(ksid)=0 then
      begin
        if islogin=1 then
           qr.SQL.Text:='SELECT t_YH.YHID as ''工号'', t_YH.YHMC as '''+ttl_yh+'姓名'',' +
                  //' table1.KSMC AS '''+ttl_ks+'1'', table2.KSMC AS '''+ttl_ks+'2'', table3.KSMC AS '''+ttl_ks+'3''' +
                  ' ''ksmc1'' AS ''   '+ttl_ks+'1   '', ''ksmc2'' AS ''   '+ttl_ks+'2   '', ''ksmc3'' AS ''   '+ttl_ks+'3   ''' +
                  ' ,t_hjzd.fjh as '''+ttl_zs+'号'' ,t_hjzd.zth as '''+ttl_zt+'号'',qxid ' +
                  ',t_YH.rsxe as ''人数限额'',t_YH.hjfs as ''呼叫方式'''+
                  ',t_YH.hjrs  as ''呼叫人数'''+
                  ' FROM t_YH LEFT OUTER JOIN ' +
                  ' t_hjzd ON t_YH.yhid = t_hjzd.yhID AND t_YH.HSZH = t_hjzd.HSZH ' +
                  ' WHERE (t_hjzd.yhid  <>'''' and t_hjzd.yhid is not null)' +
                  ' and qxid is not null'+
                  ' and (t_YH.HSZH = ' + inttostr(gblHszh) +')'
        else
            qr.SQL.Text:='SELECT t_YH.YHID as ''工号'', t_YH.YHMC as '''+ttl_yh+'姓名'',' +
                  //' table1.KSMC AS '''+ttl_ks+'1'', table2.KSMC AS '''+ttl_ks+'2'', table3.KSMC AS '''+ttl_ks+'3'' ' +
                  ' ''ksmc1'' AS ''   '+ttl_ks+'1   '', ''ksmc2'' AS ''   '+ttl_ks+'2   '', ''ksmc3'' AS ''   '+ttl_ks+'3   ''' +
                  ' ,t_hjzd.fjh as '''+ttl_zs+'号'' ,t_hjzd.zth as '''+ttl_zt+'号'',qxid ' +
                  ',t_YH.rsxe as ''人数限额'',t_YH.hjfs as ''呼叫方式'''+
                  ',t_YH.hjrs  as ''呼叫人数'''+
                  ' FROM t_YH LEFT OUTER JOIN ' +
                  ' t_hjzd ON t_YH.yhid = t_hjzd.yhID AND t_YH.HSZH = t_hjzd.HSZH ' +
                  ' WHERE (t_YH.HSZH = ' + inttostr(gblHszh) +')' +
                  ' and qxid is not null';
      end
      else
      begin
        if islogin=1 then
           qr.SQL.Text:='SELECT t_YH.YHID as ''工号'', t_YH.YHMC as '''+ttl_yh+'姓名'',' +
                  ' ''ksmc1'' AS ''   '+ttl_ks+'1   '', ''ksmc2'' AS ''   '+ttl_ks+'2   '', ''ksmc3'' AS ''   '+ttl_ks+'3   ''' +
                  ' ,t_hjzd.fjh as '''+ttl_zs+'号'' ,t_hjzd.zth as '''+ttl_zt+'号'',qxid ' +
                  ',t_YH.rsxe as ''人数限额'',t_YH.hjfs as ''呼叫方式'''+
                  ',t_YH.hjrs  as ''呼叫人数'''+
                  ' FROM t_YH LEFT OUTER JOIN ' +
                  ' t_hjzd ON t_YH.yhid = t_hjzd.yhID AND t_YH.HSZH = t_hjzd.HSZH ' +
                  ' WHERE (t_hjzd.yhid  <>'''' and t_hjzd.yhid is not null)' +
                  ' and t_yh.yhid in (select yhid from t_yh_ks where'+
                    ' ksid='+quotedstr(KSID)+' and hszh='+inttostr(gblHSZH)+')'+
                  ' and (t_YH.HSZH = ' + inttostr(gblHszh) +')'+
                  ' and qxid is not null'
        else
            qr.SQL.Text:='SELECT t_YH.YHID as ''工号'', t_YH.YHMC as '''+ttl_yh+'姓名'',' +
                  //' table1.KSMC AS '''+ttl_ks+'1'', table2.KSMC AS '''+ttl_ks+'2'', table3.KSMC AS '''+ttl_ks+'3'' ' +
                  ' ''ksmc1'' AS ''   '+ttl_ks+'1   '', ''ksmc2'' AS ''   '+ttl_ks+'2   '', ''ksmc3'' AS ''   '+ttl_ks+'3   ''' +
                  ' ,t_hjzd.fjh as '''+ttl_zs+'号'' ,t_hjzd.zth as '''+ttl_zt+'号'',qxid ' +
                  ',t_YH.rsxe as ''人数限额'',t_YH.hjfs as ''呼叫方式'''+
                  ',t_YH.hjrs  as ''呼叫人数'''+
                  ' FROM t_YH LEFT OUTER JOIN ' +
                  ' t_hjzd ON t_YH.yhid = t_hjzd.yhID AND t_YH.HSZH = t_hjzd.HSZH ' +
                  ' WHERE '+
                  ' t_yh.yhid in (select yhid from t_yh_ks where'+
                    ' ksid='+quotedstr(KSID)+' and hszh='+inttostr(gblHSZH)+')'+
                  ' and (t_YH.HSZH = ' + inttostr(gblHszh) +')'+
                  ' and qxid is not null';
      end;
      qr.Open;
      for intfieldindex:=0 to qr.Fields.Count-1 do
      begin
         listview.Columns.Add;
         listview.Columns[intfieldindex].Caption:=qr.Fields.Fields[intfieldindex].FieldName;
         listview.Columns[intfieldindex].Width := (Length(listview.Columns[intfieldindex].Caption)+2) * ListView.Canvas.TextWidth('A');
         if ListView.ViewStyle =vsreport then
           if qr.Fields.Fields[intfieldindex].FieldName='工号' then
              listview.Columns[intfieldindex].Width :=listview.Columns[intfieldindex].Width*2;
         if qr.Fields.Fields[intfieldindex].FieldName='qxid' then
            listview.Columns[intfieldindex].Width :=0;
      end;
      ///////////将数据放入LISTVIEW中.
      with qr do
      begin
         while not qr.Eof do
         begin
            listItem:=listview.Items.add;
            ListItem.Caption := Fields[0].AsString;
            if Fieldbyname('qxid').asinteger=3 then
              ListItem.ImageIndex := 5
            else
              ListItem.ImageIndex :=Fieldbyname('qxid').asinteger;

            ListItem.SubItems.Add(Fields.Fields[1].AsString);
            GetYHCallKS(Fields[0].AsString,hjksnum,hjks);
            for i:=1 to 3 do
            begin
              if i<=hjksnum then
              begin
                //ListItem.SubItems.Add(hjks[i].TGroupid);
                ListItem.SubItems.Add(hjks[i].TGroupName);
              end
              else
              begin
                //ListItem.SubItems.Add('');
                ListItem.SubItems.Add('');
              end;
            end;
            ListItem.SubItems.Add(Fields.Fields[5].AsString);
            ListItem.SubItems.Add(Fields.Fields[6].AsString);
            for i :=7 to  qr.Fields.Count-1 do
            begin
              ListItem.SubItems.Add(Fields.Fields[i].AsString);
            end;
            Next;
         end;
         Close;
      end;
    except
      begin
        result := False;
        Exit;
      end;
    end;
    result := True;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:SetYSXXList;
                                           *
*函数机能:显示KSID的医生排班列表
                                         *
*******************************************************************************}
function Tdmdbaccess.SetYSPBXXList(var ListView:TTeThemeSListView;const KSID:string;const isLogin:integer;
       const HSZH:integer):Boolean ;
var
  ListItem: TListItem;
  intFieldIndex: integer;
  qr:TADOQuery;
  hjksnum:integer;
  hjks:array[1..20] of CallGroup_Info;
  i:integer;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    listview.Columns.Clear;
    ListView.Items.Clear;
    try
      qr.Close;
      //在等待T_DHXX表中查找科室为KSID的本护士站的未就诊的病人信息.
      if length(ksid)=0 then
      begin
        if islogin=1 then
        begin
           qr.SQL.Text :='select pk.xq as ''星期'',pk.yhid ''工号'',y.yhmc ''姓名'','+
              ''''' as '' '+ttl_ks+'1 '','+''''' as '' '+ttl_ks+'2 '','+''''' as '' '+ttl_ks+'3 '''+
              'from t_pb_ks pk,t_yh y '+
              'where pk.hszh=y.hszh and pk.yhid=y.yhid '+
              'and pk.hszh=:p1 '+
              'and pk.yhid in (select yhid from t_hjzd where hszh=:p2 and yhid<>'''' and yhid is not null) '+
              'group by pk.xq,pk.hszh,pk.yhid,y.yhmc '+
              'order by pk.xq,pk.hszh,pk.yhid';
           qr.Parameters.ParamByName('p1').Value := gblHSZH;
           qr.Parameters.ParamByName('p2').Value := gblHSZH;
//
//           qr.SQL.Text:='SELECT t_YH.YHID as ''工号'', t_YH.YHMC as '''+ttl_yh+'姓名'',' +
//                  ' ''ksmc1'' AS ''   '+ttl_ks+'1   '', ''ksmc2'' AS ''   '+ttl_ks+'2   '', ''ksmc3'' AS ''   '+ttl_ks+'3   ''' +
//                  ' ,t_hjzd.fjh as '''+ttl_zs+'号'' ,t_hjzd.zth as '''+ttl_zt+'号'',qxid ' +
//                  ',t_YH.rsxe as ''人数限额'',t_YH.hjfs as ''呼叫方式'''+
//                  ',t_YH.hjrs  as ''呼叫人数'''+
//                  ' FROM t_pb_ks pk left outer join t_YH on '+
//                  ' pk.hszh=t_yh.hszh and pk.yhid=t_yh.yhid '+
//                  ' LEFT OUTER JOIN ' +
//                  ' t_hjzd ON t_YH.yhid = t_hjzd.yhID AND t_YH.HSZH = t_hjzd.HSZH ' +
//                  ' WHERE (t_hjzd.yhid  <>'''' and t_hjzd.yhid is not null)' +
//                  ' and qxid is not null'+
//                  ' and (pk.HSZH = ' + inttostr(gblHszh) +')'
        end
        else
        begin
           qr.SQL.Text :='select pk.xq  ''星期'',pk.yhid ''工号'',y.yhmc ''姓名'','+
              ''''' as '' '+ttl_ks+'1 '','+''''' as '' '+ttl_ks+'2 '','+''''' as '' '+ttl_ks+'3 '''+
              'from t_pb_ks pk,t_yh y '+
              'where pk.hszh=y.hszh and pk.yhid=y.yhid '+
              'and pk.hszh=:p1 '+
              'group by pk.xq,pk.hszh,pk.yhid,y.yhmc '+
              'order by pk.xq,pk.hszh,pk.yhid';
           qr.Parameters.ParamByName('p1').Value := gblHSZH;
        end;
      end
      else
      begin
        if islogin=1 then
        begin
           qr.SQL.Text :='select pk.xq as ''星期'',pk.yhid ''工号'',y.yhmc ''姓名'','+
              ''''' as '' '+ttl_ks+'1 '','+''''' as '' '+ttl_ks+'2 '','+''''' as '' '+ttl_ks+'3 '''+
              'from t_pb_ks pk,t_yh y '+
              'where pk.hszh=y.hszh and pk.yhid=y.yhid '+
              'and pk.hszh=:p1 '+
              'and pk.yhid in (select yhid from t_hjzd where hszh=:p2 and yhid<>'''' and yhid is not null) '+
              'and pk.ksid =:p3 '+
              'group by pk.xq,pk.hszh,pk.yhid,y.yhmc '+
              'order by pk.xq,pk.hszh,pk.yhid';
           qr.Parameters.ParamByName('p1').Value := gblHSZH;
           qr.Parameters.ParamByName('p2').Value := gblHSZH;
           qr.Parameters.ParamByName('p3').Value := KSID;
        end
        else
        begin
           qr.SQL.Text :='select pk.xq as ''星期'',pk.yhid ''工号'',y.yhmc ''姓名'','+
              ''''' as '' '+ttl_ks+'1 '','+''''' as '' '+ttl_ks+'2 '','+''''' as '' '+ttl_ks+'3 '''+
              'from t_pb_ks pk,t_yh y '+
              'where pk.hszh=y.hszh and pk.yhid=y.yhid '+
              'and pk.hszh=:p1 '+
              'and pk.ksid =:p3 '+
              'group by pk.xq,pk.hszh,pk.yhid,y.yhmc '+
              'order by pk.xq,pk.hszh,pk.yhid';
           qr.Parameters.ParamByName('p1').Value := gblHSZH;
           qr.Parameters.ParamByName('p3').Value := KSID;
        end;
      end;
      qr.Open;
      for intfieldindex:=0 to qr.Fields.Count-1 do
      begin
         listview.Columns.Add;
         listview.Columns[intfieldindex].Caption:=qr.Fields.Fields[intfieldindex].FieldName;
         listview.Columns[intfieldindex].Width := (Length(listview.Columns[intfieldindex].Caption)+2) * ListView.Canvas.TextWidth('A');
         if ListView.ViewStyle =vsreport then
           if qr.Fields.Fields[intfieldindex].FieldName='工号' then
              listview.Columns[intfieldindex].Width :=listview.Columns[intfieldindex].Width*2;
         if qr.Fields.Fields[intfieldindex].FieldName='qxid' then
            listview.Columns[intfieldindex].Width :=0;
      end;
      ///////////将数据放入LISTVIEW中.
      with qr do
      begin
         while not qr.Eof do
         begin
            listItem:=listview.Items.add;
            ListItem.Caption := Fields[0].AsString;
            ListItem.ImageIndex := 5;
            ListItem.SubItems.Add(Fields.Fields[1].AsString);
            ListItem.SubItems.Add(Fields.Fields[2].AsString);
            GetYHPBCallKS(Fields[1].AsString,Fields[0].AsString,hjksnum,hjks);
            for i:=1 to 3 do
            begin
              if i<=hjksnum then
              begin
                //ListItem.SubItems.Add(hjks[i].TGroupid);
                ListItem.SubItems.Add(hjks[i].TGroupName);
              end
              else
              begin
                //ListItem.SubItems.Add('');
                ListItem.SubItems.Add('');
              end;
            end;
//            ListItem.SubItems.Add(Fields.Fields[6].AsString);
//            ListItem.SubItems.Add(Fields.Fields[7].AsString);
//            for i :=7 to  qr.Fields.Count-1 do
//            begin
//              ListItem.SubItems.Add(Fields.Fields[i].AsString);
//            end;
            Next;
         end;
         Close;
      end;
    except
      begin
        result := False;
        Exit;
      end;
    end;
    result := True;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:XZYS;
                                           *
*函数机能:选择医生,如果YHID为空则为撤消已选择医生                                          *
*******************************************************************************}
function Tdmdbaccess.XZYS(const JRID :string;const YHID:string):Boolean;
var
  cmdStr:wideString;
begin
  try
     with adoconnection do
     begin
       cmdstr:=' UPDATE t_dhxx ' +
              ' Set YHID='''+ YHID +''''+
              ' where id=' +JRID;
        execute(cmdstr,cmdtext);
     end;
     result:=true;
  except
    begin
      result := False;
      Exit;
    end;
  end;
end;
{*******************************************************************************
*函数名:TQTH;
                                           *
*函数机能:选择提前后，如果TQFS=1，为提前TQWS，=2为退后TQWS，=0 ，为移到绝对位置TQWS；           *
*******************************************************************************}
function Tdmdbaccess.TQTH(const JRID :string;const KSID :string;const kssxid:string;const TQFS:integer;const TQWS:integer):Boolean;
var
  tmpquery:tADOQUERY;
  cmdStr:wideString;
  ddrs:integer;
  tmptqws:integer;
  tmpkssxid:string;
  tmpKsid:string;
  tmphszh:Integer;
begin
  try
       tmpquery:=tadoquery.Create(nil);
       tmpquery.Connection:=adoconnection;
       tmpquery.SQL.Clear;
       tmpquery.SQL.Add('Select ksid,kssxid,hszh from t_dhxx where id=' + jrid);
       tmpquery.Open;
       if tmpquery.Eof then
       begin
          FreeAndNil(tmpquery);
          Result := False;
          exit;
       end
       else
       begin
          tmpkssxid:=tmpquery.fieldbyname('kssxid').asstring;
          tmpKsid:= tmpquery.fieldbyname('ksid').asstring;
          tmphszh := tmpquery.fieldbyname('hszh').AsInteger;
          FreeAndNil(tmpquery);
       end;
     tmptqws:=tqws;
     with adoconnection do
     begin
       case tqfs of
            0:
            begin
              if strtoint(tmpkssxid)>tmptqws then
              begin
                 if tmptqws=0 then
                    tmptqws:=1 ;
                 try
                   BeginTrans;
                   cmdstr:=' UPDATE t_dhxx ' +
                      ' Set kssxid=kssxid+1 '+
                      ' where ksid=''' +tmpKsid +''''+
                      ' and kssxid>=' +inttostr(tmptqws) +
                      ' and kssxid<' + tmpkssxid +
                      ' and jzbz<>''0'' ' +
                      ' and hszh=' + inttostr(tmphszh);
                   execute(cmdstr,cmdtext);

                   cmdstr:=' UPDATE t_dhxx ' +
                      ' Set kssxid= '+ inttostr(tmptqws) +
                      ' where id=' +JRID;
                   execute(cmdstr,cmdtext);
                   CommitTrans;
                 except
                   RollbackTrans;
                 end;
              end
              else
              begin
                  if strtoint(tmpkssxid)<>tmptqws then
                  begin
                    try
                      BeginTrans;
                      cmdstr:=' select kssxid from t_dhxx ' +
                         ' where ksid=''' +tmpKsid +''''+
                         ' and jzbz<>''0'' ' +
                         ' and hszh=' + inttostr(tmphszh);

                      ddrs:=execute(cmdstr,cmdtext).RecordCount;
                      if tmptqws>ddrs then
                         tmptqws:=ddrs;
                      cmdstr:=' UPDATE t_dhxx ' +
                            ' Set kssxid=kssxid-1 '+
                            ' where ksid=''' +tmpKsid +''''+
                            ' and kssxid<=' +inttostr(tmptqws) +
                            ' and kssxid>' + tmpkssxid +
                            ' and jzbz<>''0'' ' +
                            ' and hszh=' + inttostr(tmphszh);
                      execute(cmdstr,cmdtext);
                      cmdstr:=' UPDATE t_dhxx ' +
                         ' Set kssxid= '+ inttostr(tmptqws) +
                         ' where id=' +JRID;
                      execute(cmdstr,cmdtext);
                      CommitTrans;
                    except
                      RollbackTrans;
                    end;
                  end;
              end;
            end;
            1:
            begin
              try
                BeginTrans;
                cmdstr:=' UPDATE t_dhxx ' +
                   ' Set kssxid=kssxid+1 '+
                   ' where ksid=''' +tmpKsid +''''+
                   ' and kssxid>=' +inttostr(strtoint(tmpkssxid)-tmptqws) +
                   ' and kssxid<' + tmpkssxid +
                   ' and jzbz<>''0'' ' +
                   ' and hszh=' + inttostr(tmphszh);
                execute(cmdstr,cmdtext);
                if strtoint(tmpkssxid) -tmptqws< 1 then
                begin
                   cmdstr:=' UPDATE t_dhxx ' +
                      ' Set kssxid=1 '+
                      ' where id=' +JRID;
                end
                else
                begin
                   cmdstr:=' UPDATE t_dhxx ' +
                      ' Set kssxid='+ inttostr(strtoint(tmpkssxid)-tmptqws) +
                      ' where id=' +JRID;
                end;
                execute(cmdstr,cmdtext);
                CommitTrans;
              except
                RollbackTrans;
              end;
            end;
            2:
            begin
              try
                BeginTrans;
                cmdstr:=' UPDATE t_dhxx ' +
                   ' Set kssxid=kssxid-1 '+
                   ' where ksid=''' +tmpKsid +''''+
                   ' and kssxid<=' +inttostr(strtoint(tmpkssxid)+tmptqws) +
                   ' and kssxid>' + tmpkssxid +
                   ' and jzbz<>''0'' ' +
                   ' and hszh=' + inttostr(tmphszh);
                execute(cmdstr,cmdtext);

                cmdstr:=' select kssxid from t_dhxx ' +
                   ' where ksid=''' +tmpKsid +''''+
                   ' and jzbz<>''0'' ' +
                   ' and hszh=' + inttostr(tmphszh);

                ddrs:=execute(cmdstr,cmdtext).RecordCount;

                if strtoint(tmpkssxid) +tmptqws> DDRS then
                begin
                   cmdstr:=' UPDATE t_dhxx ' +
                      ' Set kssxid= '+ inttostr(DDRS)  +
                      ' where id=' +JRID;
                end
                else
                begin
                   cmdstr:=' UPDATE t_dhxx ' +
                      ' Set kssxid='+ inttostr(strtoint(tmpkssxid)+tmptqws) +
                      ' where id=' +JRID;
                end;
                execute(cmdstr,cmdtext);
                CommitTrans;
              except
                RollbackTrans;
              end;
            end;
       end;
     end;
     result:=true;
  except
    begin
      addlog('errorlog.txt','提前退后操作出错!'+cmdstr);
      result := False;
      Exit;
    end;
  end;
end;
{*******************************************************************************
*函数名:SetksXXList;
                                           *
*函数机能:显示科室列表
                                         *
*******************************************************************************}
function Tdmdbaccess.SetksXXList(var ListView:TTeThemeSListView;
       const HSZH:integer;iscrossgroup:boolean;ksid:string;
       havewait:boolean):Boolean;
var
  ListItem: TListItem;
  intFieldIndex: integer;
  qr:TADOQuery;
  ksidstr:string;
  havewatstr:string;
begin
  if ksid<>'' then
    ksidstr :=' and ksid='''+ksid+'''';
  if havewait then
  begin
    havewatstr :=' and ksid in (select ksid from t_dhxx where hszh='+inttostr(gblhszh)+
      ' group by ksid)';
  end;
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    listview.Columns.Clear;
    ListView.Items.Clear;
    try
      qr.Close;
      //查询科室信息.
      if not iscrossgroup then
      begin
          qr.SQL.Text:='SELECT t_ks.ksID as '''+ttl_ks+'号'', t_ks.KSMC as '''+ttl_ks+'''' +
                    ',memo as ''备注'' '+
                    ' from t_ks ' +
                    ' WHERE t_ks.HSZH =' + inttostr(gblHszh) +
                    ' and kfbz=0 '+ //2018-03-08加，取有效的科室
                    ksidstr+
                    havewatstr+
                    ' order by hszh,memo,ksid';
      end
      else
      begin
          qr.SQL.Text:='SELECT t_ks.ksID as '''+ttl_ks+'号'', t_ks.KSMC as '''+ttl_ks+'''' +
                    ',memo as ''备注'' '+
                    ' from t_ks ' +
                    ' WHERE t_ks.HSZH <>' + inttostr(gblHszh)+
                    ' and kfbz=0 '+  //2018-03-08加，取有效的科室
                    ksidstr+
                    havewatstr+
                    ' order by hszh,memo,ksid';
      end;

      qr.Open;
      for intfieldindex:=0 to qr.Fields.Count-1 do
      begin
         listview.Columns.Add;
         listview.Columns[intfieldindex].Caption:=qr.Fields.Fields[intfieldindex].FieldName;
         listview.Columns[intfieldindex].Width :=(listview.Width-10) div (qr.Fields.Count);//(Length(listview.Columns[intfieldindex].Caption)+1) * ListView.Canvas.TextWidth('A')*2;
      end;
      ///////////将数据放入LISTVIEW中.
      with qr do
      begin
         while not qr.Eof do
         begin
            listItem:=listview.Items.add;
            ListItem.Caption := Fields[0].AsString;
            for intFieldIndex := 1 to qr.Fields.Count-1 do
            begin
               ListItem.SubItems.Add(fields.Fields[intFieldIndex].AsString);
            end;
            Next;
         end;
         Close;
      end;
    except
      begin
        result := False;
        Exit;
      end;
    end;
    result := True;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:SetksXXListQH;
                                           *
*函数机能:显示可取号科室列表
                                         *
*******************************************************************************}
function Tdmdbaccess.SetksXXListQH(var ListView:TTeThemeSListView;
       const HSZH:integer;iscrossgroup:boolean;ksid:string):Boolean ;
var
  ListItem: TListItem;
  intFieldIndex: integer;
  qr:TADOQuery;
  ksidstr:string;
begin
  if ksid<>'' then
    ksidstr :=' and ksid='''+ksid+'''';
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    listview.Columns.Clear;
    ListView.Items.Clear;
    try
      qr.Close;
      //查询科室信息.
      if not iscrossgroup then
      begin
          qr.SQL.Text:='SELECT t_ks.ksID as '''+ttl_ks+'号'', case when memo='''' then t_ks.KSMC else memo end  as '''+ttl_ks+'''' +
                    ' from t_ks ' +
                    ' WHERE t_ks.HSZH =' + inttostr(gblHszh) +
                    ' and kfbz=0 '+
                    ksidstr;
      end
      else
      begin
          qr.SQL.Text:='SELECT t_ks.ksID as '''+ttl_ks+'号'', case when memo='''' then t_ks.KSMC else memo end as '''+ttl_ks+'''' +
                    ' from t_ks ' +
                    ' WHERE t_ks.HSZH <>' + inttostr(gblHszh)+
                    ' and kfbz=0 '+
                    ksidstr;
      end;

      qr.Open;
      for intfieldindex:=0 to qr.Fields.Count-1 do
      begin
         listview.Columns.Add;
         listview.Columns[intfieldindex].Caption:=qr.Fields.Fields[intfieldindex].FieldName;
         listview.Columns[intfieldindex].Width :=(listview.Width-10) div (qr.Fields.Count);//(Length(listview.Columns[intfieldindex].Caption)+1) * ListView.Canvas.TextWidth('A')*2;
      end;
      ///////////将数据放入LISTVIEW中.
      with qr do
      begin
         while not qr.Eof do
         begin
            listItem:=listview.Items.add;
            ListItem.Caption := Fields[0].AsString;
            for intFieldIndex := 1 to qr.Fields.Count-1 do
            begin
               ListItem.SubItems.Add(fields.Fields[intFieldIndex].AsString);
            end;
            Next;
         end;
         Close;
      end;
    except
      begin
        result := False;
        Exit;
      end;
    end;
    result := True;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:HKS;
                                           *
*函数机能:换科室,将JRID的病人从KSID转到NEWKSID中,如果JRID为0 则将KSID中的所有未就诊
的病人换到NEWKSID中*
*******************************************************************************}
function Tdmdbaccess.HKS(const JRID :string;const kssxid :string ;
      const KSID :string;const NewKsid:string):Boolean;
var
  cmdStr:wideString;
  ddrs:integer;
  newddrs:integer;
  i:integer;
  newbrdm,newbrxm,newyhid,newksmc,by6,by3,by4,newghhm,yksdm:string;
  jzbz:integer;
  qr:Tadoquery;
  iRet:integer;
   blhaveysghxx:boolean;//
begin
  try
     with adoconnection do
     begin
        if jrid='0' then  //换所有病人。
        begin
           //得到新科室的人数
           cmdstr:=' select kssxid from t_dhxx ' +
                 ' where ksid=''' +newksid +''''+
                 ' and jzbz<>''0'' ' +
                 ' and hszh=' + inttostr(gblhszh);

           newddrs:=execute(cmdstr,cmdtext).RecordCount;
           //得到原科室的人数
           cmdstr:=' select kssxid from t_dhxx ' +
                 ' where ksid=''' +ksid +''''+
                 ' and jzbz<>''0'' ' +
                 ' and hszh=' + inttostr(gblhszh);

           ddrs:=execute(cmdstr,cmdtext).RecordCount;
           //逐个将原科室中的病人换到新科室中。
           for i:=1 to ddrs do
           begin
             cmdstr:=' UPDATE t_dhxx ' +
                 ' Set YHID='''''+
                 ' ,ksid=''' + newksid +'''' +
                 ' ,kssxid=' + inttostr(newddrs + i)+
                 ' ,yxjid=99'+
                 ' where kssxid=' + inttostr(i)+
                 ' and ksid=''' + ksid + ''''+
                 ' and hszh='+ inttostr(gblhszh)+
                 ' and jzbz<>''0''';
             execute(cmdstr,cmdtext);
           end;
           result:=true;
        end
        else  //换一个病人
        begin
           //得到新科室的人数
           cmdstr:=' select kssxid from t_dhxx ' +
                 ' where ksid=''' +newksid +''''+
                 ' and jzbz<>''0'' ' +
                 ' and hszh=' + inttostr(gblhszh);

           ddrs:=execute(cmdstr,cmdtext).RecordCount;
           qr:=TADOQuery.Create(nil);
           try
             qr.Connection := ADOConnection;
             qr.SQL.Text :='select brdm,brxm,yhid,jzbz,by6,by3,by4,ghhm,yksdm from t_dhxx where id='+jrid;
             qr.Open;
             if not qr.Eof then
             begin
                newBrdm := qr.fieldbyname('brdm').AsString;
                newBrxm := qr.fieldbyname('brxm').AsString;
                newyhid := qr.fieldbyname('yhid').AsString;
                jzbz := qr.fieldbyname('jzbz').AsInteger;
                by6 := qr.fieldbyname('by6').AsString;
                by3 := qr.fieldbyname('by3').AsString;
                by4 := qr.fieldbyname('by4').AsString;
                newghhm := qr.fieldbyname('ghhm').AsString;
                yksdm := qr.fieldbyname('yksdm').AsString;
             end;
             qr.Close;
           finally
             qr.free;
           end;
           //得到目录科室对应的医生//(需要读取排班);
           iRet:= getHisPbYSDM(newksid,yksdm,newyhid);
           if (iRet=0) and (newyhid<>'') then //如果有排班医生
           begin
             blhaveysghxx:=Db_getysghxx(newbrdm,newbrxm,by4,newyhid);
             if blhaveysghxx then iRet:=-1;  //在此医生newyhid处 已经有此病人则不能换.
           end;
           //如果 iRet=0表示可以换，否则提示不能换//
           if iret=0 then
           begin
             if jzbz=1 then
             begin
               //将原科室重新排序。。
               cmdstr:=' UPDATE t_dhxx SET ' +
                     ' kssxid=kssxid-1 ' +
                     ' where ksid=''' +ksid +''''+
                     ' and kssxid>'+
                     '(select kssxid from t_dhxx '+
                     ' where id=' + jrid  +
                     ' and hszh=' + inttostr(gblhszh)+ ')'+
                     ' and jzbz<>''0'' ' +
                     ' and hszh=' + inttostr(gblhszh);

               execute(cmdstr,cmdtext);
             end;
             if GetDBValue('KS',NewKsid,'GetNewNo')='1' then
             begin
               //得到一个新的号码.
  //             qr:=TADOQuery.Create(nil);
  //             try
  //               qr.Connection := ADOConnection;
  //               qr.SQL.Text :='select * from t_dhxx where id='+jrid;
  //               qr.Open;
  //               if not qr.Eof then
  //               begin
  //                  newBrdm := qr.fieldbyname('brdm').AsString;
  //                  newBrxm := qr.fieldbyname('brxm').AsString;
  //                  newyhid := qr.fieldbyname('yhid').AsString;
  //               end;
  //               qr.Close;
  //             finally
  //               qr.free;
  //             end;
               //将病人原科室改为已就诊。
               cmdstr:=' UPDATE t_dhxx ' +
                     ' Set YHID='''''+
                     ',jzbz=0'+
                     ',ztbz=4'+
                     ' ,kssxid=0'+
                     ' where id=' + JRID;
               execute(cmdstr,cmdtext);
               QuHao(NewKsid,NewKsid,newBrdm,newBrxm,newyhid,by6,'',by3,'',by4,'',yksdm);
             end
             else
             begin
               //if gblTMJC=1 then   //换科室变为新科室的召回病人
               if 1=1 then  //换科室变为新科室的召回病人
               begin
//               cmdstr:=' UPDATE t_dhxx ' +
//                     ' Set YHID='''''+
//                     ' ,ksid=''' + newksid +'''' +
//                     ' ,kssxid=' +  inttostr(ddrs +1)+
//                     ' ,yxjid=99'+
//                     ' ,jzbz=2'+
//                     ' ,ztbz=6'+
//                     ' where id=' + JRID;
               //改为已就诊
               cmdstr:=' UPDATE t_dhxx ' +
                     ' Set YHID='''''+
                     ' ,ksid=''' + newksid +'''' +
                     ' ,kssxid=' +  inttostr(ddrs +1)+
                     ' ,yxjid=0'+
                     ' ,jzbz=0'+
                     ' ,ztbz=1'+
                     ' where id=' + JRID;
               end
               else
               begin
                 if jzbz=1 then  //如果还未就诊，则改为已就诊(弃号)
                 begin
                   //将病人插到新科室的最后。
                   cmdstr:=' UPDATE t_dhxx ' +
                         ' Set kssxid=0'+
                         ',jzbz=0'+
                         ',yhid='''''+  //改成未选医生
                         ',ztbz=3'+ //改成已完成//
                         ' where id=' + JRID;
                 end;

                 //if jzbz=1 then  //如果还未就诊，则改为已就诊
                 begin

                   if QuHao(NewKsid,NewKsid,newBrdm,newBrxm,newyhid,by6,'',by3,'',by4,newghhm,yksdm) then
                   begin
                     //取号成功直接读取数据显示//
                     ReadFromGhxxToDhxx(gblhszh,newksid);
                   end;
                 end;


               end;
               execute(cmdstr,cmdtext);
               //if gblTMJC=1 then
               if 1=1 then
               begin
                 dmdbaccess.FZZH(jrid,newksid,0,'',2);
                 //dmdbaccess.WakeUpByID(JRID);
               end;
             end;
             result:=true;
             if (newyhid<>'') then //调用HIS更换医生存储过程
             begin
               SetHisYsdm(by4,newyhid);
             end;
          end
          else
          begin
            result := False;  //换科室失败
          end;
        end;
     end;

  except
    begin
      result := False;
      Exit;
    end;
  end;
end;
{*******************************************************************************
*函数名:SetksXXList;
                                           *
*函数机能:显示科室列表
                                         *
*******************************************************************************}
function Tdmdbaccess.SetYXJXXList(var ListView:TTeThemeSListView;
      const HSZH:integer):Boolean ;
var
  ListItem: TListItem;
  intFieldIndex: integer;
  qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    listview.Columns.Clear;
    ListView.Items.Clear;
    try
      qr.Close;
      //查询科室信息.
      qr.SQL.Text:='SELECT t_yxjsz.yxjID as ''优先级号'', t_yxjsz.yxjMC as ''优先级名称''' +
  //              ' ,case t_yxjsz.ydFS '  +
  //              ' when ''0'' then ''绝对'' ' +
  //              ' when ''1'' then ''相对提前'' ' +
  //              ' when ''2'' then ''相对退后'' ' +
  //              ' END as ''移动方式'' ' +
                ' ,ydfs as ''移动方式'' ' +
                ' ,t_yxjsz.ydWS as ''移动位数'' ' +
                ' from t_yxjsz ' +
                ' WHERE t_yxjsz.HSZH =' + inttostr(gblHszh) ;

      qr.Open;
      for intfieldindex:=0 to qr.Fields.Count-1 do
      begin
         listview.Columns.Add;
         listview.Columns[intfieldindex].Caption:=qr.Fields.Fields[intfieldindex].FieldName;
         listview.Columns[intfieldindex].Width :=(listview.Width-4) div (qr.Fields.Count);//(Length(listview.Columns[intfieldindex].Caption)+1) * ListView.Canvas.TextWidth('A')*2;
      end;
      ///////////将数据放入LISTVIEW中.
      with qr do
      begin
         while not qr.Eof do
         begin
            listItem:=listview.Items.add;
            ListItem.Caption := Fields[0].AsString;
            for intFieldIndex := 1 to qr.Fields.Count-1 do
            begin
               ListItem.SubItems.Add(fields.Fields[intFieldIndex].AsString);
            end;
            Next;
         end;
         Close;
      end;
    except
      begin
        result := False;
        Exit;
      end;
    end;
    result := True;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:SZYXJ;
                                           *
*函数机能:设置优先级.                                          *
*******************************************************************************}
function Tdmdbaccess.SZYXJ(const JRID :string;const YXJID:string):Boolean;
var
  cmdStr:wideString;
  ydfsmc:string;
  ydfs,ydws:integer;
  Maxkssxid:integer;
  ddbrfzZDXSID:integer;
  ddbrfzZxXSID:integer;
  ddbrZBXSID:integer;
  tmpadoquery:Tadoquery;
//  tmpadoquery1:Tadoquery;
  slKssxid:integer;
  tmpghhm:string;
  tmpyxjgws:integer;
  tmpby7:string;
begin
   if DB_SetSpecialPosByID(JRID,yxjid) then
   begin
     Result := True;
     Exit;
   end;

  if (YXJID='88') or (YXJID='89') or (yxjid='18') then
  begin
    tmpyxjgws :=0;
  end
  else
    tmpyxjgws := gblYXJGWS;
  try

      with adoconnection do
      begin
         cmdstr:=' UPDATE t_dhxx ' +
              ' Set yxjid='''+ yxjID +''''+
              ' where id=' +JRID;
         execute(cmdstr,cmdtext);
      end;
      ydfs :=0;
      if (YXJID='88') or (YXJID='89') or (yxjid='18') then
      begin
        ydws := SZYyYx(JRID,YXJID);
      end
      else
        ydws := SZPtYx(JRID,YXJID);
      //seleid:=jrid;
      TQTH(jrid,seleksid,inttostr(slkssxid),ydfs,ydws);
      result:=true;
  except
    begin
      result := False;
      Exit;
    end;
  end;
end;

//{*******************************************************************************
//*函数名:SZYXJ;
//                                           *
//*函数机能:设置优先级.                                          *
//*******************************************************************************}
//function Tdmdbaccess.SZYXJ(const JRID :string;const YXJID:string):Boolean;
//var
//  cmdStr:wideString;
//  ydfsmc:string;
//  ydfs,ydws:integer;
//  Maxkssxid:integer;
//  ddbrfzZDXSID:integer;
//  ddbrfzZxXSID:integer;
//  ddbrZBXSID:integer;
//  tmpadoquery:Tadoquery;
////  tmpadoquery1:Tadoquery;
//  slKssxid:integer;
//  tmpghhm:string;
//  tmpyxjgws:integer;
//  tmpby7:string;
//begin
//  if (YXJID='88') or (YXJID='89') or (yxjid='18') then
//  begin
//    tmpyxjgws :=0;
//  end
//  else
//    tmpyxjgws := gblYXJGWS;
//  try
//
//      with adoconnection do
//      begin
//         cmdstr:=' UPDATE t_dhxx ' +
//              ' Set yxjid='''+ yxjID +''''+
//              ' where id=' +JRID;
//         execute(cmdstr,cmdtext);
//      end;
//
//      tmpadoquery:=Tadoquery.Create(nil);
//      tmpadoquery.Connection:=Adoconnection;
//      tmpadoquery.Sql.Text:='select ghhm,by7 from t_dhxx where id='+jrid;
//      tmpadoquery.open;
//      if not tmpadoquery.eof then
//      begin
//         tmpghhm:=tmpadoquery.fieldbyname('ghhm').asstring;
//         tmpby7 :=tmpadoquery.fieldbyname('by7').asstring;
//      end;
//      tmpadoquery.close;
//      tmpadoquery.SQL.Text :=getMaxSeqStr(jrid,tmpghhm,tmpby7,YXJID);
////      if YXJID='88' then
////      begin
////
////        //判断有没有和当前号是同一预约时段并且号码比这个号大的
////        tmpadoquery.SQL.Text :='select count(*) as cnt from t_dhxx'+
////            ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
////            ' and yxjid=''' + yxjID + ''''+
////            ' and jzbz<>''0''' +
////            ' and hszh=' + inttostr(gblhszh)+
////            ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
////            ' and by7='+quotedstr(tmpby7)+
////            ' and replicate(''0'',10-len(ghhm))+ghhm>replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
////            ' and id<>'+jrid;
////        tmpadoquery.Open;
////        if tmpadoquery.FieldByName('cnt').AsInteger>0 then
////        begin
////          tmpadoquery.Close;
////          tmpadoquery.Sql.Text:=' select  Min(KSSXID) as Min_SXID  from  ' +
////              ' t_dhxx ' +
////              ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
////              ' and yxjid=''' + yxjID + ''''+
////              ' and jzbz<>''0''' +
////              ' and hszh=' + inttostr(gblhszh)+
////              ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
////              ' and replicate(''0'',10-len(ghhm))+ghhm>replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
////              ' and by7='+quotedstr(tmpby7)+
////              ' and id<>'+jrid;
////        end
////        else
////        begin
////          tmpadoquery.Close;
////          tmpadoquery.Sql.Text:=' select  Min(KSSXID) as Min_SXID  from  ' +
////            ' t_dhxx ' +
////            ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
////            ' and yxjid=''' + yxjID + ''''+
////            ' and jzbz<>''0''' +
////            ' and hszh=' + inttostr(gblhszh)+
////            ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
////            ' and by7>'+quotedstr(tmpby7)+
////            ' and id<>'+jrid;
////        end;
////      end
////      else
////      begin
////      tmpadoquery.Sql.Text:=' select  Min(KSSXID) as Min_SXID  from  ' +
////          ' t_dhxx ' +
////          ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
////          ' and yxjid=''' + yxjID + ''''+
////          ' and jzbz<>''0''' +
////          ' and hszh=' + inttostr(gblhszh)+
////          ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
////          ' and replicate(''0'',10-len(ghhm))+ghhm>replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
////          ' and id<>'+jrid;
////      end;
//      tmpadoquery.Open;
//      if tmpadoquery.Eof then
//         ddbrfzZDXSID:=0
//      else
//         ddbrfzZDXSID:=tmpadoquery.Fields.Fields[0].AsInteger;
//
//      tmpadoquery.Close;
//      tmpadoquery.SQL.Text := getMinSeqStr(jrid,tmpghhm,tmpby7,YXJID);
////      if YXJID='88' then
////      begin
////        //判断有没有和当前号是同一预约时段并且号码比这个号大的
////        tmpadoquery.SQL.Text :='select count(*) as cnt from t_dhxx'+
////            ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
////            ' and yxjid=''' + yxjID + ''''+
////            ' and jzbz<>''0''' +
////            ' and hszh=' + inttostr(gblhszh)+
////            ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
////            ' and by7='+quotedstr(tmpby7)+
////            ' and replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
////            ' and id<>'+jrid;
////        tmpadoquery.Open;
////        if tmpadoquery.FieldByName('cnt').AsInteger>0 then
////        begin
////          tmpadoquery.Close;
////          tmpadoquery.Sql.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
////              ' t_dhxx ' +
////              ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
////              ' and yxjid=''' + yxjID + ''''+
////              ' and jzbz<>''0''' +
////              ' and hszh=' + inttostr(gblhszh)+
////              ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
////              ' and by7='+quotedstr(tmpby7)+
////              ' and replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
////              ' and id<>'+jrid;
////        end
////        else
////        begin
////          tmpadoquery.Close;
////          tmpadoquery.Sql.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
////              ' t_dhxx ' +
////              ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
////              ' and yxjid=''' + yxjID + ''''+
////              ' and jzbz<>''0''' +
////              ' and hszh=' + inttostr(gblhszh)+
////              ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
////              ' and by7<'+quotedstr(tmpby7)+
////              ' and id<>'+jrid;
////        end;
////      end
////      else
////      begin
////        tmpadoquery.Sql.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
////            ' t_dhxx ' +
////            ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
////            ' and yxjid=''' + yxjID + ''''+
////            ' and jzbz<>''0''' +
////            ' and hszh=' + inttostr(gblhszh)+
////            ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
////            ' and replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
////            ' and id<>'+jrid;
////      end;
//      tmpadoquery.Open;
//      if tmpadoquery.Eof then
//         ddbrfzZxXSID:=0
//      else
//         ddbrfzZxXSID:=tmpadoquery.Fields.Fields[0].AsInteger;
//      tmpadoquery.Close;
//      if gblNeedZBXYS=0 then
//      begin
//      tmpadoquery.Sql.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
//          ' t_dhxx ' +
//          ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
//          ' and ztbz=''5'''+
//          ' and jzbz<>''0''' +
//          ' and hszh=' + inttostr(gblhszh)+
//          ' and id<>'+jrid;
//      end
//      else
//      begin
//      tmpadoquery.Sql.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
//          ' t_dhxx ' +
//          ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
//          ' and ztbz=''5'''+
//          ' and jzbz<>''0''' +
//          ' and hszh=' + inttostr(gblhszh)+
//          ' and yhid=(select yhid from t_dhxx where id='+jrid+')'+
//          ' and id<>'+jrid;
//      end;
//      tmpadoquery.Open;
//      if tmpadoquery.Eof then
//         ddbrZBXSID:=0
//      else
//         ddbrZBXSID:=tmpadoquery.Fields.Fields[0].AsInteger;
//      if ddbrZBXSID>ddbrfzZxXSID then
//         ddbrfzZxXSID:=ddbrZBXSID;
//      tmpadoquery.Close;
//      tmpadoquery.Sql.Text:='select kssxid from t_dhxx where id='+jrid;
//      tmpadoquery.Open;
//      if tmpadoquery.Eof then
//      begin
//         slkssxid:=0;
//         tmpadoquery.Close;
//         tmpadoquery.Free;
//         exit;
//      end
//      else
//      begin
//         slkssxid:=tmpadoquery.Fields.Fields[0].AsInteger;
//      end;
//      tmpadoquery.Close;
////      tmpadoquery1.Free;
//      tmpadoquery.SQL.Text:='select ydfs,ydws from t_yxjsz where ' +
//                              ' yxjid= ' + yxjid +
//                              ' and hszh= ' + inttostr(gblhszh);
//      tmpadoquery.Open;
//      if YXJID='18' then
//      begin
//        ydfsmc :='移动到';
//        if (ddbrfzZDXSID=0) and (ddbrfzZxXSID>0) then
//          ydws := ddbrfzZxXSID
//        else if (ddbrfzZDXSID>0) and (ddbrfzZxXSID=0) then
//          ydws := ddbrfzZDXSID
//        else if (ddbrfzZDXSID>0) and (ddbrfzZxXSID>0) then
//          ydws :=Max(ddbrfzZDXSID,ddbrfzZxXSID)
//        else ydws:=slKssxid;
////        if ddbrfzZDXSID>slKssxid then
////          ydws :=slKssxid
////        else
////          ydws :=ddbrfzZDXSID;
////        if ydws=0 then ydws:=1;
//      end
//      else
//      begin
//        ydfsmc:=tmpadoquery.Fields.Fields[0].AsString;
//        ydws:=tmpadoquery.Fields.Fields[1].AsInteger;
//      end;
//      tmpadoquery.Close;
//      FreeAndNil(tmpadoquery);
//      //如果本队列中有相同优先级的人在并且另一位病人在前间距不足移动位数，则移动到前一位的后面
//      if ydfsmc='移动到' then
//      begin
//          ydfs:=0;
//          if ddbrfzzdxsid=0 then
//          begin
//             if ddbrfzZxXSID=0 then
//             begin
//                if ddbrZBXSID>0 then
//                begin
//                   if ydws<=ddbrzbxsid then
//                      ydws:=ddbrzbxsid+1;
//                end;
//                if ydws>slkssxid then
//                   ydws:=-1;
//             end
//             else
//             begin
//                if ydws<=ddbrfzZxXSID then
//                   ydws:=ddbrfzZxXSID+tmpyxjgws+1
//                else
//                   ydws:=ydws+tmpyxjgws;
//                if yxjid<>'18' then
//                begin
//                  if ydws>slkssxid then
//                     ydws:=-1;
//                end;
//             end;
//          end
//          else
//          begin
//             if ydws>=ddbrfzzdxsid then
//             begin
//                ydws:=ddbrfzzdxsid;
//             end
//             else
//             begin
//                if ddbrfzZxXSID=0 then
//                begin
//                  if ddbrZBXSID>0 then
//                  begin
//                     if ydws<=ddbrzbxsid then
//                        ydws:=ddbrzbxsid+1;
//                  end;
//                  if ydws>slkssxid then
//                     ydws:=-1;
//                end
//                else
//                begin
//                   if ydws-tmpyxjgws>ddbrfzZxXSID then
//                      ydws:=ydws
//                   else if ddbrfzZxXSID+1+tmpyxjgws<= ddbrfzzdxsid then
//                      ydws:=ddbrfzZxXSID+1+tmpyxjgws
//                   else
//                      ydws:=ddbrfzzdxsid+1;
//                  if yxjid<>'18' then
//                  begin
//                    if ydws>slkssxid then
//                       ydws:=-1;
//                  end;
//                end;
//             end;
//{             if ydws-ddbrfzzdxsid<=gblyxjgws then
//                ydws:=ddbrfzzdxsid+gblyxjgws+1;
//             if ydws>strtoint(selekssxid) then
//                ydws:=strtoint(selekssxid);}
//          end;
//
//      end
//      else if ydfsmc='置前' then
//      begin
//          ydfs:=1;
//          ydws:=slkssxid-ydws;
//          if ydws<=0 then
//             ydws:=1;
//          ydfs:=0;
//          if ddbrfzzdxsid=0 then
//          begin
//             if ddbrfzZxXSID=0 then
//             begin
//                if ddbrZBXSID>0 then
//                begin
//                   if ydws<=ddbrzbxsid then
//                      ydws:=ddbrzbxsid+1;
//                end;
//                if ydws>slkssxid then
//                   ydws:=-1;
//             end
//             else
//             begin
//                if ydws<=ddbrfzZxXSID then
//                   ydws:=ddbrfzZxXSID+tmpyxjgws+1
//                else
//                   ydws:=ydws+tmpyxjgws;
//                if ydws>slkssxid then
//                   ydws:=-1;
//             end;
//          end
//          else
//          begin
//             if ydws>=ddbrfzzdxsid then
//             begin
//                ydws:=ddbrfzzdxsid;
//             end
//             else
//             begin
//                if ddbrfzZxXSID=0 then
//                begin
//                  if ddbrZBXSID>0 then
//                  begin
//                   if ydws<=ddbrzbxsid then
//                      ydws:=ddbrzbxsid+1;
//                  end;
//                  if ydws>slkssxid then
//                     ydws:=-1;
//                end
//                else
//                begin
//                   if ydws-tmpyxjgws>ddbrfzZxXSID then
//                      ydws:=ydws
//                   else if ddbrfzZxXSID+1+tmpyxjgws<= ddbrfzzdxsid then
//                      ydws:=ddbrfzZxXSID+1+tmpyxjgws
//                   else
//                      ydws:=ddbrfzzdxsid+1;
//                    if ydws>slkssxid then
//                       ydws:=-1;
//                end;
//             end;
//           end;
//{          if ddbrfzzdxsid=0 then
//          begin
//             if strtoint(selekssxid)-ydws>0 then
//                ydws:=strtoint(selekssxid)-ydws
//             else
//                ydws:=1;
//             ydfs:=0;
//          end
//          else
//          begin
//            if (strtoint(selekssxid)-ydws<=ddbrfzZDXSID) then
//            begin
//               ydfs:=0;
//               ydws:=ddbrfzZDXSID+gblyxjgws+1;
//               if ydws>strtoint(selekssxid) then
//                  ydws:=strtoint(selekssxid);
//            end
//            else if strtoint(selekssxid)-ydws-ddbrfzzdxsid<=gblyxjgws then
//            begin
//               ydfs:=0;
//               ydws:=ddbrfzZDXSID+gblyxjgws+1;
//               if ydws>strtoint(selekssxid) then
//                  ydws:=strtoint(selekssxid);
//            end
//            else
//            begin
//               ydfs:=0;
//               ydws:=strtoint(selekssxid)-ydws;
//               if ydws<=0 then
//                  ydws:=1;
//            end;
//          end;}
//      end
//      else
//      begin
//          ydfs:=2;
//      end;
//      if ydws<=0 then
//      begin
//         result:=true;
//         exit;
//      end;
//      seleid:=jrid;
//      TQTH(seleid,seleksid,inttostr(slkssxid),ydfs,ydws);
//      result:=true;
//  except
//    begin
//      result := False;
//      Exit;
//    end;
//  end;
//end;

{*******************************************************************************
*函数名:InitDatabase;
                                           *
*函数机能:初始化数据
.                                          *
*******************************************************************************}
function Tdmdbaccess.InitDatabase(const HSZH:integer):boolean;
var
  cmdStr:wideString;
  rec_index:integer;
  ini:Tinifile;
  tmpadoquery:Tadoquery;
  qr:TADOQuery;
  tmpsjdkssj,tmpsjdjssj:TDateTime;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
            qr.close;
            qr.SQL.Text:='select 1 from t_FUNCXX (nolock) ';
            qr.open;
            if qr.RecordCount=0 then
            begin
                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''80'',	''物理登录'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''81'',	''物理登出'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''82'',	''物理顺呼'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''83'',	''物理复呼'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''84'',	''物理忽略'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''85'',	''物理插后'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''86'',	''物理查询'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''87'',	''物理暂停'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''88'',	''物理查询'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''89'',	''物理'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''90'',	''物理选呼'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''91'',	''物理评价'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''92'',	''物理插前'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''95'',	''物理转移'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''97'',	''取号'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''71'',	''物理消号'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''DF'',	''虚拟登录'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''DE'',	''虚拟登出'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''D1'',	''虚拟暂停'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''D2'',	''虚拟继续'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''D3'',	''虚拟召回'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''D4'',	''虚拟直呼'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''D5'',	''虚拟顺呼'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''D6'',	''虚拟复呼'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''D7'',	''虚拟忽略'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''D9'',	''虚拟选呼'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''DA'',	''虚拟查询'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''DB'',	''虚拟信息'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''DC'',	''虚拟设'+ttl_ks+''')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''DD'',	''虚拟设用户'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''E1'',	''虚拟取顺呼间隔'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''E2'',	''虚拟取复呼间隔'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''E3'',	''虚拟取忽略标志'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''E4'',	''虚拟消号'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''F1'',	''虚拟插前'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(FunCode,FuncName) values '+
                '(''F2'',	''虚拟插后'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''30'',	''物理登录2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''31'',	''物理登出2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''32'',	''物理顺呼2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''33'',	''物理复呼2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''34'',	''物理忽略2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''35'',	''物理插后2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''36'',	''物理查询2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''37'',	''物理暂停2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''38'',	''物理查询2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''39'',	''物理2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''40'',	''物理选呼2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''41'',	''物理评价2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''42'',	''物理插前2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''47'',	''取号2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into T_FUNCXX(FunCode,FuncName) values '+
                '(''21'',	''物理消号2'')';
                adoconnection.Execute(cmdstr);

                cmdstr:='insert into t_funcxx(funcode,funcname,funcnote) '+
                  'values(''FF'',''功能键'',''切换功能键'')';
                adoconnection.Execute(cmdstr);

            end;
            qr.Close;
            qr.SQL.Text:='select 1 from t_FUNCDZB (nolock) where hszh='+inttostr(gblhszh);
            qr.open;
            if qr.RecordCount=0 then
            begin
                cmdstr:='insert into t_FUNCDZB(showcode,showname,FunCode,hszh)  '+
                        'select funcode,funcname,funcode,'+inttostr(gblhszh)+' from t_FUNCXX ';
                adoconnection.Execute(cmdstr);
            end;
            qr.Close;
    except
       showmessage('呼叫功能码表写入失败');
    end;
    try
      qr.Close;
      //查询时间段信息.
      qr.SQL.Text:='SELECT sjdbz,sjdmc,sjdkssj,sjdjssj '+
                ' from t_sjdsz ' +
                ' WHERE HSZH =' + inttostr(hszh);
      qr.Open;
      if qr.RecordCount=0 then
      begin
         ///如果没有时间段信息
         {1。加入时间段信息，
         2。}
            cmdstr:=' insert into t_sjdsz ' +
                    ' (sjdbz,sjdmc,sjdkssj,sjdjssj,hszh) ' +
                    ' values '+
                    ' (1,''上午'',''6:30:00'',''12:30:00'','+inttostr(hszh) + ') ';
            adoconnection.Execute(cmdstr);

            cmdstr:=' insert into t_sjdsz ' +
                    ' (sjdbz,sjdmc,sjdkssj,sjdjssj,hszh) ' +
                    ' values '+
                    ' (2,''下午'',''12:30:00'',''18:00:00'','+inttostr(hszh) + ') ';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_sjdsz ' +
                    ' (sjdbz,sjdmc,sjdkssj,sjdjssj,hszh) ' +
                    ' values '+
                    ' (3,''晚上'',''18:00:00'',''22:00:00'','+inttostr(hszh) + ') ';
            adoconnection.Execute(cmdstr);

            cmdstr:=' delete from t_Qx where hszh=' +inttostr(hszh);
            adoconnection.Execute(cmdstr);

            qr.Close;
            qr.SQL.Text:='select 1 from t_qx (nolock) ';
            qr.open;
            if qr.RecordCount=0 then
            begin
              IF gblsys=1 THEN
              BEGIN
                cmdstr:=' insert into t_qx ' +
                        ' (qxid,qxmc,qxjb,hszh) ' +
                        ' values '+
                        ' (1,''系统管理员'',''1'','+inttostr(hszh) + ') ';
                adoconnection.Execute(cmdstr);
                cmdstr:=' insert into t_qx ' +
                        ' (qxid,qxmc,qxjb,hszh) ' +
                        ' values '+
                        ' (2,''护士'',''1'','+inttostr(hszh) + ') ';
                adoconnection.Execute(cmdstr);
                cmdstr:=' insert into t_qx ' +
                        ' (qxid,qxmc,qxjb,hszh) ' +
                        ' values '+
                        ' (3,''医生'',''1'','+inttostr(hszh) + ') ';
                adoconnection.Execute(cmdstr);
                cmdstr:=' insert into t_qx ' +
                        ' (qxid,qxmc,qxjb,hszh) ' +
                        ' values '+
                        ' (4,''管理员'',''1'','+inttostr(hszh) + ') ';
                adoconnection.Execute(cmdstr);
              END
              ELSE
              BEGIN
                cmdstr:=' insert into t_qx ' +
                        ' (qxid,qxmc,qxjb,hszh) ' +
                        ' values '+
                        ' (1,''系统管理员'',''1'','+inttostr(hszh) + ') ';
                adoconnection.Execute(cmdstr);
                cmdstr:=' insert into t_qx ' +
                        ' (qxid,qxmc,qxjb,hszh) ' +
                        ' values '+
                        ' (2,''操作员'',''1'','+inttostr(hszh) + ') ';
                adoconnection.Execute(cmdstr);
                cmdstr:=' insert into t_qx ' +
                        ' (qxid,qxmc,qxjb,hszh) ' +
                        ' values '+
                        ' (3,''员工'',''1'','+inttostr(hszh) + ') ';
                adoconnection.Execute(cmdstr);
                cmdstr:=' insert into t_qx ' +
                        ' (qxid,qxmc,qxjb,hszh) ' +
                        ' values '+
                        ' (4,''管理员'',''1'','+inttostr(hszh) + ') ';
                adoconnection.Execute(cmdstr);
              END;
            end;
            qr.Close;

            cmdstr:=' insert into t_yh ' +
                    ' (YHID,YHMC,MM,QXID,hszh,ztbz) ' +
                    ' values '+
                    ' (''8888'',''系统管理员'',''123456'',1,'+inttostr(hszh) + ',''0'') ';
            adoconnection.Execute(cmdstr);


            cmdstr:=' delete from t_jzzt where hszh=' +inttostr(hszh);
            adoconnection.Execute(cmdstr);
//            if gblsys=1 then
            begin
              cmdstr:=' insert into t_jzzt ' +
                      ' (ztbz,ztmc,hszh) ' +
                      ' values '+
                      ' (1,'''+ttl_cz+''','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);

              cmdstr:=' insert into t_jzzt ' +
                      ' (ztbz,ztmc,hszh) ' +
                      ' values '+
                      ' (2,'''+ttl_fz+''','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);

              cmdstr:=' insert into t_jzzt ' +
                      ' (ztbz,ztmc,hszh) ' +
                      ' values '+
                      ' (3,''弃号'','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);

              cmdstr:=' insert into t_jzzt ' +
                      ' (ztbz,ztmc,hszh) ' +
                      ' values '+
                      ' (4,''换'+ttl_ks+''','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);

              cmdstr:=' insert into t_jzzt ' +
                      ' (ztbz,ztmc,hszh) ' +
                      ' values '+
                     ' (5,''准备'','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);

              cmdstr:=' insert into t_jzzt ' +
                      ' (ztbz,ztmc,hszh) ' +
                      ' values '+
                      ' (6,''未激活'','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);
            end;
//            else
//            begin
//              cmdstr:=' insert into t_jzzt ' +
//                      ' (ztbz,ztmc,hszh) ' +
//                      ' values '+
//                      ' (1,''初次受理'','+inttostr(hszh) + ') ';
//              adoconnection.Execute(cmdstr);
//
//              cmdstr:=' insert into t_jzzt ' +
//                      ' (ztbz,ztmc,hszh) ' +
//                      ' values '+
//                      ' (2,''二次受理'','+inttostr(hszh) + ') ';
//              adoconnection.Execute(cmdstr);
//
//              cmdstr:=' insert into t_jzzt ' +
//                      ' (ztbz,ztmc,hszh) ' +
//                      ' values '+
//                      ' (3,''弃号'','+inttostr(hszh) + ') ';
//              adoconnection.Execute(cmdstr);
//
//              cmdstr:=' insert into t_jzzt ' +
//                      ' (ztbz,ztmc,hszh) ' +
//                      ' values '+
//                      ' (4,''换队列'','+inttostr(hszh) + ') ';
//              adoconnection.Execute(cmdstr);
//
//              cmdstr:=' insert into t_jzzt ' +
//                      ' (ztbz,ztmc,hszh) ' +
//                      ' values '+
//                     ' (5,''准备'','+inttostr(hszh) + ') ';
//              adoconnection.Execute(cmdstr);
//
//              cmdstr:=' insert into t_jzzt ' +
//                      ' (ztbz,ztmc,hszh) ' +
//                      ' values '+
//                      ' (6,''未激活'','+inttostr(hszh) + ') ';
//              adoconnection.Execute(cmdstr);
//            end;
            cmdstr:=' delete from t_yxjsz where hszh=' +inttostr(hszh);
            adoconnection.Execute(cmdstr);
            if gblsys=1 then
            begin
              cmdstr:=' insert into t_yxjsz ' +
                      ' (yxjid,yxjmc,ydws,ydfs,hszh) ' +
                      ' values '+
                      ' (1,'''+ttl_fz+''',3,''移动到'','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);
              cmdstr:=' insert into t_yxjsz ' +
                      ' (yxjid,yxjmc,ydws,ydfs,hszh) ' +
                      ' values '+
                      ' (2,''老年人'',5,''置前'','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);
              cmdstr:=' insert into t_yxjsz ' +
                      ' (yxjid,yxjmc,ydws,ydfs,hszh) ' +
                      ' values '+
                      ' (3,''急诊'',2,''移动到'','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);
              cmdstr:=' insert into t_yxjsz ' +
                      ' (yxjid,yxjmc,ydws,ydfs,hszh) ' +
                      ' values '+
                      ' (4,''军人'',5,''置前'','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);
            end
            else
            begin
              cmdstr:=' insert into t_yxjsz ' +
                      ' (yxjid,yxjmc,ydws,ydfs,hszh) ' +
                      ' values '+
                      ' (1,''召回'',3,''移动到'','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);
              cmdstr:=' insert into t_yxjsz ' +
                      ' (yxjid,yxjmc,ydws,ydfs,hszh) ' +
                      ' values '+
                      ' (2,''老年人'',5,''置前'','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);
              cmdstr:=' insert into t_yxjsz ' +
                      ' (yxjid,yxjmc,ydws,ydfs,hszh) ' +
                      ' values '+
                      ' (3,''加急'',2,''移动到'','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);
              cmdstr:=' insert into t_yxjsz ' +
                      ' (yxjid,yxjmc,ydws,ydfs,hszh) ' +
                      ' values '+
                      ' (4,''军人'',5,''置前'','+inttostr(hszh) + ') ';
              adoconnection.Execute(cmdstr);
            end;
            //--插入显示屏类型
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 1,''A型'',''乐讯屏'' '+
                    ' where not exists(select 1 from t_xsplx where xh=1)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 2,''B型'',''信茂屏'' '+
                    ' where not exists(select 1 from t_xsplx where xh=2)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 3,''C型'',''汉德森屏'' '+
                    ' where not exists(select 1 from t_xsplx where xh=3)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 4,''D型A类卡'',''强力A类卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=4)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 5,''E型'',''虚拟屏'' '+
                    ' where not exists(select 1 from t_xsplx where xh=5)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 6,''D型B类卡'',''强力B类卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=6)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 7,''D型C类卡'',''强力C类卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=7)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 8,''D型D类卡'',''强力II型卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=8)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 9,''D型E类卡'',''强力I型卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=9)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 10,''F型A类卡'',''仰邦BX-S16FE卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=10)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 11,''F型B类卡'',''仰邦BX-SL条屏卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=11)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 12,''G型A类卡'',''博海卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=12)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 13,''H型A类卡'',''同济A卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=13)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 14,''H型B类卡'',''同济B卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=14)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 15,''I型A类卡'',''灵信Listen卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=15)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 16,''F型C类卡'',''仰邦新条屏卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=16)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 17,''J型A类卡'',''智慧6汉字条屏卡'' '+
                    ' where not exists(select 1 from t_xsplx where xh=17)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 19,''F型D类卡'',''bx-CII+'' '+
                    ' where not exists(select 1 from t_xsplx where xh=19)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 20,''F型E类卡'',''bx-e网络'' '+
                    ' where not exists(select 1 from t_xsplx where xh=20)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 21,''F型E类卡com'',''bx-e串口'' '+
                    ' where not exists(select 1 from t_xsplx where xh=21)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 22,''F型F类卡'',''bx-4t1'' '+
                    ' where not exists(select 1 from t_xsplx where xh=22)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 23,''F型G类卡'',''bx-4a'' '+
                    ' where not exists(select 1 from t_xsplx where xh=23)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 24,''F型H类卡'',''bx-4M1'' '+
                    ' where not exists(select 1 from t_xsplx where xh=24)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 25,''L型A类卡232'','''' '+
                    ' where not exists(select 1 from t_xsplx where xh=25)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 26,''L型A类卡Net'','''' '+
                    ' where not exists(select 1 from t_xsplx where xh=26)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 27,''L型A类卡4852'','''' '+
                    ' where not exists(select 1 from t_xsplx where xh=27)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 88,''电视显示'',''多屏显示'' '+
                    ' where not exists(select 1 from t_xsplx where xh=88)';
            adoconnection.Execute(cmdstr);
            cmdstr:=' insert into t_xsplx (xh,xsplx,memo) ' +
                    ' select 89,''LCD显示'',''与信息发布结合'' '+
                    ' where not exists(select 1 from t_xsplx where xh=89)';
            adoconnection.Execute(cmdstr);
            cmdstr:='insert into pd_x_area (id,mc,parentid)'+
                    ' select ''88'',''排队叫号'',0 '+
                    ' where not exists(select 1 from pd_x_area where id=88)';
            try
               adoconnection.Execute(cmdstr);
            except
            end;
            cmdstr:='insert into pd_x_yh (id,name,passowrd,qx,areaid,areaid,user_type)'+
                    ' select ''pdjh'',''排队叫号'',''pdjh'',''admin'',''88'',1 '+
                    ' where not exists(select 1 from pd_x_yh where id=''pdjh'')';
            try
               adoconnection.Execute(cmdstr);
            except
            end;
            //----增加旧综合服务终端显示内容
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	10,	''任意字符'',	'''+ttl_ks+'代码'',	10,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;

            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	20,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	30,	'''+ttl_ks+'名称'',	'''',	8,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	40,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	50,	'''+ttl_zs+'号码'',	'''',	2,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	60,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	70,	'''+ttl_zs+'名称'',	'''',	8,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	80,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	90,	'''+ttl_ghhm+''',	'''',	4,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	100,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	110,	'''+ttl_br+'姓名'',	'''',	8,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	120,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	130,	''准备号码1'',	'''',	2,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	140,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	150,	''准备姓名1'',	'''',	8,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	160,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	170,	''准备信息'',	'''',	8,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	180,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	190,	'''+ttl_yh+'代码'',	'''',	4,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (101,	200,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            //----增加液晶显示器显示内容
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	10,	''任意字符'',	'''+ttl_ks+'代码'',	10,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	20,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	30,	'''+ttl_ks+'名称'',	'''',	8,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	40,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	50,	'''+ttl_zs+'号码'',	'''',	2,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	60,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	70,	'''+ttl_zs+'名称'',	'''',	8,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	80,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	90,	'''+ttl_ghhm+''',	'''',	4,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	100,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	110,	'''+ttl_br+'姓名'',	'''',	8,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	120,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	130,	''准备号码1'',	'''',	2,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	140,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	150,	''准备姓名1'',	'''',	8,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	160,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	170,	''准备信息'',	'''',	8,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	180,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	190,	'''+ttl_yh+'代码'',	'''',	4,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
            cmdStr :=' insert into t_xsnrscr(xsms,xssx,xsnr,xxnr,xxkd,dqfs,hszh,ztdx,ztys)'+
              ' values (102,	200,	''分行符'',	'''',	1,	''左对齐'','+
              inttostr(gblhszh)+',	60	,2)';
            try
            adoconnection.Execute(cmdstr);
            except
            end;
      end;

      if not CheckXMSP() then
      begin
        cmdStr :=' alter table t_dhxx add xmsp varchar(30)';
        try
        adoconnection.Execute(cmdstr);
        except
        end;
      end;
      if not CheckField('ghhm_seq') then
      begin
        cmdStr :=' alter table t_dhxx add ghhm_seq varchar(10)';
        try
        adoconnection.Execute(cmdstr);
        except
        end;
      end;
      if not CheckField('jhsj') then
      begin
        cmdStr :=' alter table t_dhxx add jhsj datetime';
        try
        adoconnection.Execute(cmdstr);
        except
        end;
        cmdStr :=' alter table t_jzjl add jhsj datetime';
        try
        adoconnection.Execute(cmdstr);
        except
        end;
      end;
      if not CheckField('yksdm') then
      begin
        cmdStr :=' alter table t_dhxx add yksdm varchar(20)';
        try
        adoconnection.Execute(cmdstr);
        except
        end;
        cmdStr :=' alter table t_ghxx add yksdm varchar(20)';
        try
        adoconnection.Execute(cmdstr);
        except
        end;
        cmdStr :=' alter table t_jzjl add yksdm varchar(20)';
        try
        adoconnection.Execute(cmdstr);
        except
        end;
      end;
      qr.Close;
      //查询时间段信息.
      qr.SQL.Text:='SELECT sjdbz,sjdmc,sjdkssj,sjdjssj '+
                ' from t_sjdsz ' +
                ' WHERE HSZH =' + inttostr(hszh) +
                ' and CONVERT(datetime, CONVERT(varchar(10), SJDKSSJ, 8), 102) <=convert(datetime,'''+ ctimetostr(time)+''''+',102)' +
                ' and CONVERT(datetime, CONVERT(varchar(10), SJDJSSJ, 8), 102) >convert(datetime,'''+ ctimetostr(time)+''''+',102)' ;

      qr.Open;
      with qr do
      begin
         if  not qr.Eof then
         begin
            gblsjdbz:=fields.Fields[0].AsInteger;
            tmpsjdkssj:=fields.Fields[2].asdatetime;
         end
         else
         begin
            gblsjdbz :=1;
            tmpsjdkssj:=Date;
         end;
         Close;
      end;
       if (gblSJDFW=1) and (gblsjdbz>1) then   //
       begin
          //时间段复位:
          qr.SQL.Text:='SELECT min(sjdkssj),max(sjdjssj) '+
                    ' from t_sjdsz ' +
                    ' WHERE HSZH =' + inttostr(hszh) +
                    ' and CONVERT(datetime, CONVERT(varchar(10), SJDJSSJ, 8), 102)'+
                    '<=convert(datetime,'''+ FormatDateTime('hh:nn:ss',tmpsjdkssj)+''''+',102)' ;

          qr.Open;
          with qr do
          begin
             if  not qr.Eof then
             begin
                //gblsjdbz:=fields.Fields[0].AsInteger;
                tmpsjdkssj:=fields.Fields[0].asdatetime;
                tmpsjdjssj:=fields.Fields[1].asdatetime;
                QingChu(FormatDateTime('hh:nn:ss',tmpsjdkssj),
                FormatDateTime('hh:nn:ss',tmpsjdjssj),0,0,1);
             end;
             Close;
          end;
          //将上午未读进的数据sjdbz改为当前时间段
          try
            qr.SQL.Text :='update t_ghxx set sjdbz='+inttostr(gblsjdbz)+
              ',by5=convert(varchar,getdate(),120)+'' ''+convert(varchar,sjdbz)+''修改为''+'+quotedstr(inttostr(gblsjdbz))+
              ' where hszh='+inttostr(HSZH)+
              ' and ztbz<>9 and sjdbz<>'+inttostr(gblsjdbz);
            qr.ExecSQL;
          except
          end;
       end;
       with adoconnection do
       begin
             //将运行状态写入到数据库；；
           cmdstr:='update t_hsz set yxbz=1  where hszh='+ inttostr(gblhszh);
           execute(cmdstr,cmdtext);
           dmDBAccess.WriteLogInfo('1001','运行程序');

          if gbltoday<>cdatetostr(date) then
          begin
             if gblblts<=0 then
             begin
               cmdstr:='delete from t_xsxx where hszh='+inttostr(gblhszh);
               execute(cmdstr,cmdtext);
             end
             else
             begin
               cmdStr :='delete from t_xsxx where ztbz=0 and hszh='+inttostr(gblhszh);
               execute(cmdstr,cmdtext);
             end;
             UpdateGroupHided();
             gbltoday:=cdatetostr(date);
             if gblCallEnable<>2 then
                gblCallEnable := 0;//如果此项有效,则初始为不可呼叫.
             //写入到注册表.
             try
               ini:=Tinifile.create(ExtractFilepath(ParamStr(0))+'set.ini');
    //           gblhszh:=ini.ReadInteger('NurseST','NurseStNo',1);
               ini.WriteString('sys','Today',gbltoday);
               FreeAndNil(ini);
             except
             end;
             //写入到数据库；；
             cmdstr:='update t_hsz set zdfwsj='''+cdatetostr(date) + ''''+ ' where hszh='+ inttostr(gblhszh);
             execute(cmdstr,cmdtext);
             //update reset set commandtime=null
             if gblZDFW=1 then
             begin
                ////////将今天以前t_ghxx表中未处理过的病人放入到t_dhxx表中.
                try
                cmdstr:='insert into t_dhxx(ksid,ghhm,brxm,brdm,yhid,ghsj,hszh,by1,by2,jzbz,sjdbz,kssxid,ztbz) '+
                        ' select ksid,ghhm,brxm,brdm,yhid,ghsj,hszh,0,0,jzbz,sjdbz,0,1 from t_ghxx '+
                        ' where ghsj<'''  + gbltoday + ''' and ztbz<>''9'' and hszh=' + inttostr(hszh);
                execute(cmdstr,cmdtext);
                except
                end;
                ///////////删除今天以前t_ghxx表中的数据////////////
                try
                  cmdstr:='delete from t_ghxx where '+
                  ' ghsj<convert(datetime,'''  + gbltoday + ''')-2 and hszh=' + inttostr(hszh)+
                  ' and ksid in (select ksid from t_ks where hszh='+ inttostr(hszh)+' and fenzhen=1)';
                  execute(cmdstr,cmdtext);
                  cmdstr:='delete from t_ghxx where '+
                  ' ghsj<convert(datetime,'''  + gbltoday + ''') and hszh=' + inttostr(hszh)+
                  ' and ksid in (select ksid from t_ks where hszh='+ inttostr(hszh)+' and (fenzhen=0 or fenzhen=2))';
                  execute(cmdstr,cmdtext);
                except
                  cmdstr:='delete from t_ghxx where ghsj<'''  + gbltoday + ''' and hszh=' + inttostr(hszh);
                  execute(cmdstr,cmdtext);
                end;
                //////////将今天以前的等待病人改为已就诊病人
                try
                  cmdstr:=' update t_dhxx set jzbz=0 ,ztbz=3 '+
                          ' where ghsj<convert(datetime,'''+  gbltoday+''')-2'+
                          ' and jzbz<>0 and hszh=' + inttostr(hszh)+
                          ' and ksid in (select ksid from t_ks where hszh='+ inttostr(hszh)+' and fenzhen=1)';;
                  execute(cmdstr,cmdtext);
                  cmdstr:=' update t_dhxx set jzbz=0 ,ztbz=3 '+
                          ' where ghsj<convert(datetime,'''+  gbltoday+''')-'+floattostr(gblblts)+
                          ' and jzbz<>0 and hszh=' + inttostr(hszh)+
                          ' and ksid in (select ksid from t_ks where hszh='+ inttostr(hszh)+' and (fenzhen=0 or fenzhen=2))';
                  execute(cmdstr,cmdtext);
                except
                  cmdstr:=' update t_dhxx set jzbz=0 ,ztbz=3 '+
                          ' where ghsj<convert(datetime,'''+  gbltoday+''')-'+floattostr(gblblts)+
                          ' and jzbz<>0 and hszh=' + inttostr(hszh);
                  execute(cmdstr,cmdtext);
                end;
                ////////////将今天以前gblblts天的数据插入到就诊记录表中.
                cmdstr:=' Insert into t_jzjl(KSSXID, KSID, BRXM, BRDM, GHHM, GHSJ,'+
                        ' JZSJ, ZTBZ, YHID, YXJID, SJDBZ, JZBZ, BY1, BY2, BY3,'+
                        ' BY4, ID, HSZH, yhlcs, CKHM, JZJSSJ, LC, ZXH, by5, by6,by7)'+
                        ' select KSSXID, KSID, BRXM, BRDM, GHHM, GHSJ,'+
                        ' JZSJ, ZTBZ, YHID, YXJID, SJDBZ, JZBZ, BY1, BY2, BY3,'+
                        ' BY4, ID, HSZH, yhlcs, CKHM, JZJSSJ, LC, ZXH, by5, by6,by7'+
                        ' from t_dhxx (nolock) '+
                        ' Where  ghsj<convert(datetime,'''+  gbltoday+''')-'+floattostr(gblblts)+ ' and  hszh='+ inttostr(hszh);
                try
                  execute(cmdstr,cmdtext);
                except
                  cmdstr:=' Insert into t_jzjl(KSSXID, KSID, BRXM, BRDM, GHHM, GHSJ,'+
                          ' JZSJ, ZTBZ, YHID, YXJID, SJDBZ, JZBZ, BY1, BY2, BY3,'+
                          ' BY4, ID, HSZH, yhlcs, CKHM, JZJSSJ, LC, ZXH, by5, by6)'+
                          ' select KSSXID, KSID, BRXM, BRDM, GHHM, GHSJ,'+
                          ' JZSJ, ZTBZ, YHID, YXJID, SJDBZ, JZBZ, BY1, BY2, BY3,'+
                          ' BY4, ID, HSZH, yhlcs, CKHM, JZJSSJ, LC, ZXH, by5, by6'+
                          ' from t_dhxx (nolock) '+
                          ' Where  ghsj<convert(datetime,'''+  gbltoday+''')-'+floattostr(gblblts)+ ' and  hszh='+ inttostr(hszh);
                  execute(cmdstr,cmdtext);
                end;
                ///////////清除今天以前gblbljzjlts天的数据.////////
                if gblbljzjlts>0 then//大于零时才删除数据，=0表示保留全部.
                begin
                  cmdstr:=' delete from t_jzjl '+
                          ' where ghsj<convert(datetime,'''+  gbltoday+''')-'+floattostr(gblbljzjlts)+ ' and hszh=' + inttostr(hszh);
                  execute(cmdstr,cmdtext);
                end;
                ///////////清除今天以前gblblts天的数据.//////////
                try
                  cmdstr:=' delete from t_dhxx '+
                          ' where ghsj<convert(datetime,'''+  gbltoday+''')-2'+ ' and hszh=' + inttostr(hszh)+
                          ' and ksid in (select ksid from t_ks where hszh='+ inttostr(hszh)+' and fenzhen=1)';
                  execute(cmdstr,cmdtext);
                  cmdstr:=' delete from t_dhxx '+
                          ' where ghsj<convert(datetime,'''+  gbltoday+''')-'+floattostr(gblblts)+ ' and hszh=' + inttostr(hszh)+
                          ' and ksid in (select ksid from t_ks where hszh='+ inttostr(hszh)+' and (fenzhen=0 or fenzhen=2))';
                  execute(cmdstr,cmdtext);
                except
                  cmdstr:=' delete from t_dhxx '+
                          ' where ghsj<convert(datetime,'''+  gbltoday+''')-'+floattostr(gblblts)+ ' and hszh=' + inttostr(hszh);
                  execute(cmdstr,cmdtext);
                end;
                cmdstr:='delete from t_ksJzh where zhsj<'''+  gbltoday+''' and tohsz=' + inttostr(hszh);
                execute(cmdstr,cmdtext);

                //////////如果在等待信息表中已经没有今天以前的数据,科室的当前号码重置///////////
                  cmdstr:='Update t_ks set DQHM=QSHM where hszh=' + inttostr(hszh);
                  execute(cmdstr,cmdtext);
                ///////////////////////////////////////////////////

                if gblblts<=0 then
                begin

                  cmdstr:='update t_hjzd set yhid=null,zt='''',state='''','+
                    ' calltime=getdate(),callnexttime=null,recalltime=null'+
                    ' where hszh=' + inttostr(hszh);
                  try
                    execute(cmdstr,cmdtext);
                  except
                    cmdstr:='update t_hjzd set yhid=null,zt='''',state='''',calltime=getdate() where hszh=' + inttostr(hszh);
                    execute(cmdstr,cmdtext);
                  end;

                  if gblCallWithGrpState=1 then
                  begin
                    cmdstr:='update t_ks set ztbz=0 where hszh=' + inttostr(hszh);
                    execute(cmdstr,cmdtext);
                  end;
                end;
                if gblblts>0 then
                begin
                  cmdStr :=' select ksid from T_ks where hszh='+inttostr(hszh);
                  qr.Close;
                  qr.SQL.Text:=cmdstr;
                  qr.Open;
                  while not qr.Eof do
                  begin
                     CXHMPXKS_ghsj(qr.Fields.Fields[0].AsString);
                     qr.Next;
                  end;
                  qr.Close;
                end;
                if gblzdpb=1  then
                begin
                ////从排班表中读取呼叫科室.


                  qr.SQL.Text:='select yhid,xqh,ksid1,ksid2,ksid3 from t_pbxx where xqh=' +  inttostr(dayoftheweek(date))+
                              ' and hszh=' + inttostr(hszh);
                  qr.Open;
                  rec_index:=1;
                  with qr do
                  begin
                     while not qr.Eof do
                     begin
                        cmdstr := 'delete t_yh_ks where hszh=' + inttostr(hszh) +
                          ' and yhid=''' + fields.Fields[0].AsString + '''';
                        execute(cmdstr,cmdtext);
                        if (fields.Fields[2].AsString<>'') and  (fields.Fields[2].AsString<>'0') then
                        begin
                          cmdstr :=' insert into t_yh_ks(hszh,yhid,ksid,seq)'+
                            ' values('+inttostr(hszh) +','+
                            quotedstr(fields.Fields[0].AsString)+','+
                            quotedstr(fields.Fields[2].AsString)+','+
                            '1'+')';
                          execute(cmdstr,cmdtext);
                        end;
                        if (fields.Fields[3].AsString<>'') and  (fields.Fields[3].AsString<>'0') then
                        begin
                          cmdstr :=' insert into t_yh_ks(hszh,yhid,ksid,seq)'+
                            ' values('+inttostr(hszh) +','+
                            quotedstr(fields.Fields[0].AsString)+','+
                            quotedstr(fields.Fields[3].AsString)+','+
                            '2'+')';
                          execute(cmdstr,cmdtext);
                        end;
                        if (fields.Fields[4].AsString<>'') and  (fields.Fields[4].AsString<>'0') then
                        begin
                          cmdstr :=' insert into t_yh_ks(hszh,yhid,ksid,seq)'+
                            ' values('+inttostr(hszh) +','+
                            quotedstr(fields.Fields[0].AsString)+','+
                            quotedstr(fields.Fields[4].AsString)+','+
                            '3'+')';
                          execute(cmdstr,cmdtext);
                        end;
                        cmdstr:='update t_yh set ksid1=''' + fields.Fields[2].AsString + ''''+
                                ',ksid2=''' + fields.Fields[3].AsString + ''''+
                                ',ksid3=''' + fields.Fields[4].AsString + ''''+
                                ' where hszh=' + inttostr(hszh) +
                                ' and yhid=''' + fields.Fields[0].AsString + '''';
                        execute(cmdstr,cmdtext);
                        next;
                     end;
                     Close;
                  end;
                end;
             end;
          end;
       end;
       result:=true;
    except
      begin
        addlog('errorlog.txt','InitDatabase错误:'+cmdstr);
        result := False;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:CHeckHSZ;
                                           *
*函数机能:检查护士站，并读取参数！
.                                          *
*******************************************************************************}
function Tdmdbaccess.CheckHSZ(const HSZH:integer):integer;
var
  cmdStr:wideString;
  qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      qr.Close;
      //查询时间段信息.
      cmdstr:= 'select 1 from t_hsz (nolock) where hszh=' + inttostr(gblhszh);

      qr.SQL.Text:=cmdstr;
      qr.Open;
      if qr.RecordCount=0 then
      begin
         ///如果没有护士站信息
         {1。进入设置界面！ }
            application.CreateForm(tfrmhszsz,frmhszsz);
            with frmhszsz do
            begin
                caption:='新增'+ttl_hsz+',请配置'+ttl_hsz+'参数！';
                FRMHSZSZ.tEdtHSZH.Enabled:=TRUE;
                showmode:=1;
                ShowModal;
                free;
            end;
            //msgbox('新增护士站完成，要重启本系统后设置才有效','提示',mb_ok+mb_iconinformation);
            result:=1;
      end
      else
      begin
         //读取护士站信息
         dmdbaccess.ReadFromHszSZ(gblhszh);
         result:=2;
      end;
    except
      begin
        result := 0;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

{*******************************************************************************
*函数名:GetSysTitle;
                                           *
*函数机能:得到相应系统的标题！
.                                          *
*******************************************************************************}
function Tdmdbaccess.GetSysTitle(const Asys:integer):boolean;
var
  cmdStr:wideString;
begin
  try
    if Asys=1 then
    begin
       ttl_ks:='科室';//-队列
       ttl_yh:='医生';//-员工
       ttl_br:='病人';
       ttl_op:='护士';//-操作员
       ttl_jz:='就诊';//-工作
       ttl_zs:='诊室';//-窗口
       ttl_zt:='诊台';//-柜台
       ttl_ghsj:='挂号时间';//-取号时间
       ttl_hsz:='护士站';//-服务站
       ttl_cz:='初诊';//-初次受理
       ttl_fz:='召回';//'复诊';//-再次受理
       ttl_ghhm:='挂号号码';//-服务号码
       ttl_sysName:='思创排队管理软件';//'思创就诊管理系统';//,思创服务管理系统
       ttl_gh:='挂号';
       ttl_zb:='准  备';//准备
       ttl_weijihuo:='未激活';//未激活
       ttl_weihujiao:='未呼叫';//未呼叫.
       ttl_yiwancheng:='已完成';//已完成
       ttl_mzh:='门诊号';
    end
    else
    begin
       ttl_ks:='队列';//-队列
       ttl_yh:='员工';//-员工
       ttl_br:='客户';
       ttl_op:='操作员';//-操作员
       ttl_jz:='受理';//-工作
       ttl_zs:='窗口';//-窗口
       ttl_zt:='柜台';//-柜台
       ttl_ghsj:='取号时间';//-取号时间
       ttl_hsz:='服务站';//-服务站
       ttl_cz:='初次受理';//-初次受理
       ttl_fz:='再次受理';//-再次受理
       ttl_ghhm:='服务号码';//-服务号码
       ttl_sysName:='思创排队管理软件';//'思创服务管理系统';//,思创服务管理系统
       ttl_gh:='取号';
       ttl_zb:='准  备';;//准备
       ttl_weijihuo:='未激活';//未激活
       ttl_weihujiao:='未呼叫';//未呼叫.
       ttl_yiwancheng:='已完成';//已完成
       ttl_mzh:='客户编码';
    end;
  except
    begin
      result := false;
      Exit;
    end;
  end;
end;
function Tdmdbaccess.CheckGroupPatient(const hszh:integer):boolean;
var
  i:integer;
  sGroupID:string;
  bRet:Boolean;
  qr:TADOQuery;
  cmdstr:string;
  iWait,iWait1,iWait2:integer;
begin
  bRet := False;
  for i:=0 to GroupNumber-1 do
  begin
    iWait := -1;
    qr:=TADOQuery.Create(nil);
    try
      qr.Connection := ADOConnection;
      try
        cmdstr:='';
        cmdstr:=' t_dhxx.ksid=''' + GroupSerial[i].ksid +'''' ;
        cmdstr:=' select count(1) as br_count from  ' +
               ' t_dhxx (nolock) ' +
               ' where (' + cmdstr  +')' +
               ' and t_dhxx.jzbz=''1''' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh)+
               ' and  ((yxjid=88) or (yxjid=89))'+
               ' and  by7<=(convert(varchar(5),getdate(),108))';
        qr.SQL.Text := cmdstr;
        qr.Open;
        iWait:=qr.fieldbyname('br_count').asinteger;
        qr.Close;
      except
        begin
          iWait := -1;  ///有错误发生.
        end;
      end;
      iWait1 :=-1;
      try
        cmdstr:='';
        cmdstr:=' t_dhxx.ksid=''' + GroupSerial[i].ksid +'''' ;
        cmdstr:=' select count(1) as br_count from  ' +
               ' t_dhxx (nolock) ' +
               ' where (' + cmdstr  +')' +
               ' and t_dhxx.jzbz=''1''' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh)+
               ' and  yxjid not in (88,89) ';
        qr.SQL.Text := cmdstr;
        qr.Open;
        iWait1:=qr.fieldbyname('br_count').asinteger;
        qr.Close;
      except
        begin
          iWait1 := -1;  ///有错误发生.
        end;
      end;
      iWait2 :=-1;
      try
        cmdstr:='';
        cmdstr:=' t_ghxx.ksid=''' + GroupSerial[i].ksid +'''' ;
        cmdstr:=' select count(1) as br_count from  ' +
               ' t_ghxx (nolock) ' +
               ' where (' + cmdstr  +')' +
               ' and t_ghxx.jzbz=''1''' +
               ' and t_ghxx.hszh=' +inttostr(gblhszh)+
               ' and  by1 not in (88,89) ' +
               ' and t_ghxx.ztbz<>9';
        qr.SQL.Text := cmdstr;
        qr.Open;
        iWait2:=qr.fieldbyname('br_count').asinteger;
        qr.Close;
      except
        begin
          iWait2 := -1;  ///有错误发生.
        end;
      end;
    finally
      FreeAndNil(qr);
    end;
    if (iWait=0) and (iWait1=0) and (iWait2=0) then
    begin
      sGroupID := GroupSerial[i].ksid;
      bRet:=ReadFromGhxxToDhxx(gblHSZH,sGroupID);
    end;
  end;
  if bRet then
  begin
    Result := True;
  end
  else
  begin
    Result := False;
  end;
end;
function Tdmdbaccess.CheckGroupDhxxPatient(const hszh:integer):boolean;
var
  i:integer;
  sGroupID:string;
  bRet:Boolean;
  qr:TADOQuery;
  cmdstr:string;
  iWait,iWait1,iWait2:integer;
  jrid:string;
begin
  bRet := False;
  for i:=0 to GroupNumber-1 do
  begin
//    Application.ProcessMessages;
    iWait := -1;
    qr:=TADOQuery.Create(nil);
    try
      qr.Connection := ADOConnection;
      try
        cmdstr:='';
        cmdstr:=' t_dhxx.ksid=''' + GroupSerial[i].ksid +'''' ;
        cmdstr:=' select id from  ' +
               ' t_dhxx (nolock) ' +
               ' where (' + cmdstr  +')' +
               ' and t_dhxx.jzbz=''1''' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh)+
               ' and  (yxjid<>88)'+
               ' and by1=88 and by7<=(convert(varchar(5),dateadd(n,1,getdate()),108))'+
               ' order by by7,replicate(''0'',10-len(ghhm))+ghhm ';;
        qr.SQL.Text := cmdstr;
        qr.Open;
        iWait:=qr.RecordCount;
        while not qr.Eof do
        begin
          jrid := qr.fieldbyname('id').asstring;
          SZYXJ(jrid,'88');  //设置优先级;
          qr.Next;
        end;
        qr.Close;
      except
        begin
          iWait := -1;  ///有错误发生.
        end;
      end;
    finally
      FreeAndNil(qr);
    end;
    if iWait>0 then
    begin
      gbledit_ks[gbledit_ks_count].ksid:=groupserial[i].ksid;
      gbledit_ks[gbledit_ks_count].ksmc:=groupserial[i].ksmc;
      gbledit_ks_count:=gbledit_ks_count+1;
    end;
  end;
  if bRet then
  begin
    Result := True;
  end
  else
  begin
    Result := False;
  end;
end;
function Tdmdbaccess.CheckGroupDhxxCantCallPatient(const hszh:integer):boolean;
var
  i:integer;
  sGroupID:string;
  bRet:Boolean;
  qr:TADOQuery;
  cmdstr:string;
  iWait,iWait1,iWait2:integer;
  jrid:string;
begin
  bRet := False;
  for i:=0 to GroupNumber-1 do
  begin
//    Application.ProcessMessages;
    iWait := -1;
    qr:=TADOQuery.Create(nil);
    try
      qr.Connection := ADOConnection;
      try
        qr.SQL.Clear;
        qr.Parameters.Clear;
        cmdstr:='';
        //cmdstr:=' t_dhxx.ksid=''' + GroupSerial[i].ksid +'''' ;
        cmdstr:=' select id from  ' +
               ' t_dhxx (nolock) ' +
               ' where t_dhxx.ksid=:p1'+
               ' and t_dhxx.jzbz=2' +
               ' and t_dhxx.ztbz=8'+
               ' and t_dhxx.hszh=:p2'+// +inttostr(gblhszh)+
               ' and by1=88 and by7<=(convert(varchar(5),dateadd(n,1,getdate()),108))'+
               ' order by by7,replicate(''0'',10-len(ghhm))+ghhm ';
        qr.SQL.Text := cmdstr;
        qr.Parameters.ParamByName('p1').Value := GroupSerial[i].ksid;
        qr.Parameters.ParamByName('p2').Value := gblhszh;
        qr.Open;
        iWait:=qr.RecordCount;
        while not qr.Eof do
        begin
          jrid := qr.fieldbyname('id').asstring;
          if DB_WakeupByID(jrid,gblhszh,True)=1 then //激活成功并且是已经到时
          begin
            //WakeUpByID(jrid);
            PutWakeupIDAtPos(jrid,gblHSZH);
            //SZYXJ(jrid,'88');  //设置优先级;
            if not bRet then bRet := true;
          end;
          qr.Next;
        end;
        qr.Close;
        if gbljhxysdbr=1 then
        begin
          qr.SQL.Clear;
          qr.Parameters.Clear;
          //2015-10-09 去掉  wugang
          //如果没有等待的病人//则将下一时段的病人放入到等待队列中
          cmdstr :=' select count(*) cnt from t_dhxx'+
            ' where ksid=:p1'+
            ' and hszh=:p2'+
            ' and jzbz=1';
          qr.SQL.Text := cmdstr;
          qr.Parameters.ParamByName('p1').Value := GroupSerial[i].ksid;
          qr.Parameters.ParamByName('p2').Value := gblhszh;
          qr.Open;
          if qr.FieldByName('cnt').AsInteger=0 then
          begin
            qr.Close;
            qr.SQL.Clear;
            qr.Parameters.Clear;
            cmdstr:='';
            //cmdstr:=' t_dhxx.ksid=''' + GroupSerial[i].ksid +'''' ;
            cmdstr:=' select id from  ' +
                   ' t_dhxx (nolock) ' +
                   ' where t_dhxx.ksid=:p1'+
                   ' and t_dhxx.jzbz=2' +
                   ' and t_dhxx.ztbz=8'+
                   ' and t_dhxx.hszh=:p2'+// +inttostr(gblhszh)+
                   ' and by1=88 and by7<=(convert(varchar(5),dateadd(n,50,getdate()),108))'+
                   ' order by by7,replicate(''0'',10-len(ghhm))+ghhm ';
            qr.SQL.Text := cmdstr;
            qr.Parameters.ParamByName('p1').Value :=GroupSerial[i].ksid;
            qr.Parameters.ParamByName('p2').Value := gblHSZH;
            qr.Open;
            iWait:=iwait+qr.RecordCount;
            while not qr.Eof do
            begin
              jrid := qr.fieldbyname('id').asstring;
              if DB_WakeupByID(jrid,gblhszh,True)=1 then
              begin
                //WakeUpByID(jrid);
                PutWakeupIDAtPos(jrid,gblHSZH);
                //SZYXJ(jrid,'88');  //设置优先级;
                if not bRet then bRet := true;
                break;  //只对一个病人进行操作// edit by wugang @20161020
              end;
              qr.Next;
            end;
            qr.Close;
          end
          else
            qr.Close;
        end;
///////////////////////////////////////////////
        //bRet := true;
      except
        begin
          iWait := -1;  ///有错误发生.
        end;
      end;
    finally
      FreeAndNil(qr);
    end;
    if iWait>0 then
    begin
      gbledit_ks[gbledit_ks_count].ksid:=GroupSerial[i].ksid;
      gbledit_ks[gbledit_ks_count].ksmc:=groupserial[i].ksmc;
      gbledit_ks_count:=gbledit_ks_count+1;
      //insertnotifygrouptorefresh(gblhszh,
    end;
  end;
  if bRet then
  begin
    Result := True;
  end
  else
  begin
    Result := False;
  end;
end;

//查询是否有预约的病人排在后面。
function Tdmdbaccess.CheckGroupDhxxSpecialPatient(const hszh:integer):boolean;
var
  i:integer;
  sGroupID:string;
  bRet:Boolean;
  qr:TADOQuery;
  cmdstr:string;
  iWait,iWait1,iWait2:integer;
  jrid:string;
  ptsxid,yysxid:Integer;
begin
  bRet := False;
  for i:=0 to GroupNumber-1 do
  begin
    iWait := -1;
    qr:=TADOQuery.Create(nil);
    try
      qr.Connection := ADOConnection;
      try
        qr.SQL.Clear;
        qr.Parameters.Clear;
        cmdstr:='';
        //cmdstr:=' t_dhxx.ksid=''' + GroupSerial[i].ksid +'''' ;
//        if (gblfzzhtype=2) or (gblfzzhtype=3) then
//        begin
          cmdstr:=' select min(kssxid) min_sxid from  ' +
                 ' t_dhxx d(nolock)' +
                 ' where d.ksid=:p1'+
                 ' and d.jzbz=1' +
                 ' and d.ztbz<>5 and d.ztbz<>2 '+
                 ' and d.yxjid<>88'+
                 ' and d.hszh=:p2';
//        end
//        else
//        begin
//          cmdstr:=' select min(kssxid) min_sxid from  ' +
//                 ' t_dhxx d(nolock)  ' +
//                 ' where d.ksid=:p1'+
//                 ' and d.jzbz=1' +
//                 ' and d.ztbz<>5'+
//                 ' and d.yxjid<>88'+
//                 ' and d.hszh=:p2';
//        end;
        qr.SQL.Text := cmdstr;
        qr.Parameters.ParamByName('p1').Value := GroupSerial[i].ksid;
        qr.Parameters.ParamByName('p2').Value := gblhszh;
        qr.Open;
        if not qr.Eof then
          ptsxid := qr.fieldbyname('min_sxid').AsInteger
        else
          ptsxid :=0;
        qr.Close;
        qr.SQL.Clear;
        qr.Parameters.Clear;
        cmdstr:='';
        //cmdstr:=' t_dhxx.ksid=''' + GroupSerial[i].ksid +'''' ;
        cmdstr:=' select min(kssxid) min_sxid from  ' +
               ' t_dhxx d(nolock) ' +
               ' where d.ksid=:p1'+
               ' and d.jzbz=1' +
               ' and d.yxjid=88'+
               ' and d.hszh=:p2';
        qr.SQL.Text := cmdstr;
        qr.Parameters.ParamByName('p1').Value := GroupSerial[i].ksid;
        qr.Parameters.ParamByName('p2').Value := gblhszh;
        qr.Open;
        if not qr.Eof then
          yysxid := qr.fieldbyname('min_sxid').AsInteger
        else
          yysxid :=0;
        qr.Close;

        if (yysxid>0) and (ptsxid>0) and (yysxid>ptsxid) then
        begin
          qr.Close;
          qr.SQL.Clear;
          qr.Parameters.Clear;
          cmdstr:='';
          //cmdstr:=' t_dhxx.ksid=''' + GroupSerial[i].ksid +'''' ;
          cmdstr:=' select id from  ' +
                 ' t_dhxx d(nolock) ' +
                 ' where d.ksid=:p1'+
                 ' and d.jzbz=1' +
                 ' and d.yxjid=88'+
                 ' and d.hszh=:p2';
          qr.SQL.Text := cmdstr;
          qr.Parameters.ParamByName('p1').Value :=GroupSerial[i].ksid;
          qr.Parameters.ParamByName('p2').Value := gblHSZH;
          qr.Open;
          iWait:=iwait+qr.RecordCount;
          while not qr.Eof do
          begin
            jrid := qr.fieldbyname('id').asstring;
            //DB_WakeupByID(jrid,gblhszh,True);
            //WakeUpByID(jrid);
            //PutWakeupIDAtPos(jrid,gblHSZH);
            SZYXJ(jrid,'88');  //设置优先级;
            qr.Next;
          end;
          qr.Close;
        end;
      except
        begin
          iWait := -1;  ///有错误发生.
        end;
      end;
    finally
      FreeAndNil(qr);
    end;
    if iWait>0 then
    begin
      gbledit_ks[gbledit_ks_count].ksid:=groupserial[i].ksid;
      gbledit_ks[gbledit_ks_count].ksmc:=groupserial[i].ksmc;
      gbledit_ks_count:=gbledit_ks_count+1;
    end;
  end;
  if bRet then
  begin
    Result := True;
  end
  else
  begin
    Result := False;
  end;
end;
    // 从GHXX表中读取相关数据放入DHXX表中.
function Tdmdbaccess.ReadFromGhxxToDhxx(const hszh:integer;const AGroupID:string):boolean;
var
  i:integer;
  dyzs:integer;//打印票单张数;
  cmdStr:wideString; //SQL字符串;
  cmdstr_sjd:widestring;//SQL字符串
  kssxid,x:integer;
  tmpkssxid:integer;
  ksid:string; //科室ID
  ksmc:string; //科室名称;
  brxm:string; //病人姓名
  brdm:string;  //病人代码;
  ghhm:string;  //挂号号码;
  ghsj:tdatetime;//挂号时间
  ztbz:string;   //状态标志
  yhid:string;   //医生工号
  yhxm:string;//医生姓名.
  jzbz:string;   //读取标志.
  yxjid:integer;//优先级
  by1:integer;   //
  by2:integer;
  by3:string;
  by4:string;
  by5:string;
  by6:string;
  by7:string;
  lc:string;
  yksdm:string;
  rec_id:string;
  sjdbz:integer;   //时间段标志
  ddrs:integer;    //等待人数
  isExsit:boolean; //是否存在.
  maxkssxid:integer;
  dhztbz:string;
  tmpadoquery:tadoquery;
  jrid:string;
  tmpHMPX:integer;
  tmpghhm:integer;
  blRollback,bAtTime:Boolean;
  qr:Tadoquery;
  tmpadodataset,tmpadodataset1:Tadodataset;
  mzh,xb,nl:string;//门诊号，性别，年龄;
  xmsp:string;//姓名首拼
  rebackid:string;
  groupnumber_index:integer;
  yysjdjh:string;
  kstmjc:integer;
begin
    //addlog('errorlog.txt','进入读取ReadFromGhxxToDhxx');
    if gblisindo then
    begin
      if (now-gblindotime)*24*60*60>60 then
      begin
        addlog('errorlog.txt','进入读取ReadFromGhxxToDhxx，读取时间超过1分钟.');
        gblisindo := false;
      end
      else
      begin
       result:=false;
       exit;
      end;
    end;
  try
    gblisindo:=true;
    gblindotime := now;
    tmpadodataset := tadodataset.Create(nil);
    tmpadodataset1 := tadodataset.Create(nil);
  try
    tmpadodataset.Connection := adoconnection;
    tmpadodataset1.Connection := adoconnection;
    //gbledit_ks_count:=0;
    if gblZDLD=1 then
    begin
       if gblSJDFW=1 then
          cmdstr_sjd:=' and sjdbz='+ inttostr(gblsjdbz)  +
                    ' and ghsj >=''' + cdatetostr(date) +'''' +
                    ' and ghsj <''' + cdatetostr(date+1) + ''''
       else
          cmdstr_sjd:=' and ghsj >=''' + cdatetostr(date) +'''' +
                    ' and ghsj <''' + cdatetostr(date+1) + '''';
       if gblyssj>0 then
          cmdstr_sjd:=cmdstr_sjd + ' and  DATEDIFF(s,ghsj, getdate())>' + inttostr(gblyssj)
       else
       begin
          tmpadodataset.Close;
          tmpadodataset.CommandText :='select readdelay from t_ks';
          try
            tmpadodataset.Open;
            cmdstr_sjd:=cmdstr_sjd + ' and  DATEDIFF(s,ghsj, getdate())>('+
            'select top 1 case readdelay when 0 then -24*3600 else readdelay end'+
            ' from t_ks where ksid=g.ksid and (hszh='+inttostr(hszh)+'))';
          except
          end;
          tmpadodataset.Close;
       end;
       ///从GHXX表中取数据
       tmpadodataset.Close;
       if gblhavemzh=1 then
       begin
       tmpadodataset.Commandtext:='SELECT g.id '+
              ' ,g.ksid ' +
              ' ,g.brxm,g.brdm'+
              ' ,g.ghhm,g.ghsj' +
              ' ,g.ztbz,g.yhid' +
              ' ,g.by1,g.by2' +
              ' ,g.by3,g.by4' +
              ' ,g.jzbz,g.sjdbz' +
              ' ,k.ksmc  '+
              ' ,g.by5,g.by6'+
              ',g.by7,g.lc'+
              ',g.mzh,g.xb,g.nl,g.yksdm'+
              ' from t_ghxx g(nolock) inner join  ' +
              ' t_ks k on (g.ksid =k.ksid and k.hszh='+inttostr(hszh)+
              ' and (g.hszh=k.hszh or g.hszh=0))' +
              ' WHERE (g.HSZH =' + inttostr(hszh) +' or g.hszh=0)'+
              ' and g.ztbz<>9' +
              cmdstr_sjd +
              ' order by id ';
       end
       else
       begin
       tmpadodataset.Commandtext:='SELECT g.id '+
              ' ,g.ksid ' +
              ' ,g.brxm,g.brdm'+
              ' ,g.ghhm,g.ghsj' +
              ' ,g.ztbz,g.yhid' +
              ' ,g.by1,g.by2' +
              ' ,g.by3,g.by4' +
              ' ,g.jzbz,g.sjdbz' +
              ' ,k.ksmc  '+
              ' ,g.by5,g.by6'+
              ',g.by7,g.lc'+
              ' from t_ghxx g(nolock) inner join  ' +
              ' t_ks k on (g.ksid =k.ksid and k.hszh='+inttostr(hszh)+
              ' and (g.hszh=k.hszh or g.hszh=0))' +
              ' WHERE (g.HSZH =' + inttostr(hszh) +' or g.hszh=0)'+
              ' and g.ztbz<>9' +
              cmdstr_sjd +
              ' order by id ';
       end;
       tmpadodataset.Open;
       //查询还未处理的病人(t_ghxx表中ztbz<>9)//
       with tmpadodataset do
       begin
         while  not tmpadodataset.Eof do
         begin
             application.ProcessMessages;

             rec_id:=fields.Fields[0].AsString;
//             dmdbaccess.addlog('errorlog.txt',formatdatetime('yyyy-mm-dd hh:nn:ss:zzz',now)+' 开始读取rec_id:'+rec_id);
             ksid:=trim(fields.Fields[1].AsString);
             brxm:=trim(fields.Fields[2].AsString);
             xmsp:=GetStrPYIndex(StringReplace(Trim(brxm),' ','',[rfReplaceAll]));;//得到首拼
             brdm:=trim(fields.Fields[3].asstring);
             ghhm:=trim(fields.fields[4].asstring);
             ghsj:=fields.Fields[5].AsDateTime;
             ztbz:=fields.Fields[6].AsString;
             yhid:=trim(fields.Fields[7].AsString);
             yxjid:=fields.Fields[8].AsInteger;
             by1:=fields.Fields[8].AsInteger;
             by2:=fields.Fields[9].AsInteger;
             by3:=fields.Fields[10].AsString;
             by4:=trim(fields.Fields[11].AsString);
             jzbz:=fields.Fields[12].AsString;
             yysjdjh :=getdbvalue(D003,ksid,'yysjdjh');
             if yysjdjh='1' then
             begin
               yysjdjh := '2';
             end
             else if  yysjdjh='0' then
             begin
               yysjdjh := '0';
             end
             else
                yysjdjh :=inttostr(gblyysjdjh);

             if ztbz='2' then  //召回//
             begin
               ADOConnection.BeginTrans;
               blRollback := False;
               rebackid :='';
               try
                 try
                   cmdstr:=' UPDATE t_ghxx ' +
                         ' set ztbz=9 ' +
                         ' where id=' + rec_id;
                   adoconnection.Execute(cmdstr,cmdtext);

                   tmpadodataset1.Close;
                   tmpadodataset1.Commandtext:=' select ksid,brdm,id from t_dhxx ' +
                          ' where ksid=''' +ksid +''''+
                          ' and brdm='+quotedstr(brdm)+
                          ' and ghhm='+quotedstr(ghhm)+
                          ' and jzbz=0 ' +
                          ' and hszh=' + inttostr(gblhszh);
                   tmpadodataset1.Open;
                   if not tmpadodataset1.Eof then
                   begin
                     rebackid := tmpadodataset1.fieldbyname('id').AsString;
                   end;
                   tmpadodataset1.Close;
                   ADOConnection.CommitTrans;
                 except
                   ADOConnection.RollbackTrans;
                   blRollback := True;
                   addlog('errorlog.txt','查询召回数据时有错误发生!'+cmdstr);
                 end;
               finally

               end;
               if rebackid<>'' then
               begin
                 //召回
                 if dmdbaccess.FZZH(rebackid,ksid,1,'',1) then
                 begin
                    isExsit:=false;
                    for i :=0 to gbledit_ks_count -1 do
                    begin
                       if gbledit_ks[i].ksid=fields.Fields[1].AsString then
                          begin
                             isexsit:=true;
                             break;
                          end;
                    end;
                    if gblFormType=1 then
                    begin
                      if dmDBAccess.GetDBValue('KS',fields.Fields[1].AsString,'hided')='1' then
                      begin
                        dmDBAccess.SetDBValue('KS',fields.Fields[1].AsString,'hided','0');
                        frmMain.ReflushGroupList();
                      end;
                    end;
                    if isexsit=false then
                    begin
                       gbledit_ks_count:=gbledit_ks_count +1;
                       gbledit_ks[gbledit_ks_count-1].ksid:=ksid;
                       gbledit_ks[gbledit_ks_count-1].ksmc:=ksmc;   //fields.Fields[];
                    end;
                 end;
               end;
             end
             else
             begin
               //sjdbz:=gblsjdbz;//fields.Fields[13].AsInteger;
               ///2013-07-03 edit by wugang.  从ghxx表中读取时间段标志 。
               sjdbz:=fields.Fields[13].AsInteger;
               kstmjc := strtoint(GetDBValue('KS',ksid,'opencheckin'));
               if (gbltmjc=1) and (kstmjc=1) then //要刷卡激活
               begin
                  if ((ztbz='3') or (ztbz='4')) then  //主界面上取号/在取号机上取的号，则自动激活。
                  begin
                    dhztbz:='1';
                    if jzbz<>'0' then
                      jzbz:='1';
                  end
                  else
                  begin
                     if yxjid<>88 then
                     begin
                       by1:=yxjid;
                     end;
                     yxjid :=0;
                    dhztbz:='6';
                    if jzbz<>'0' then
                    begin
                      if frmMain.chkState.Checked then
                      begin
                         jzbz:='1';
                         dhztbz:='1';
                      end
                      else
                         jzbz:='2';
                    end;
                  end;
               end
               else
               begin
                 dhztbz:='1';
                 if jzbz<>'0' then
                    jzbz:='1';
               end;
               ksmc:=fields.Fields[14].AsString;
               by5:=fields.Fields[15].AsString;
               by6:=fields.Fields[16].AsString;
               by7:=fields.Fields[17].AsString;
               lc:= fields.Fields[18].AsString;
               if gblhavemzh=1 then
               begin
                 mzh := fields.Fields[19].AsString;
                 xb := fields.Fields[20].AsString;
                 nl := fields.Fields[21].AsString;
                 yksdm:= fields.Fields[22].AsString;
               end;
               if lc='' then lc:='0';
               //查找最大的排队顺序号
               tmpadodataset1.Close;
               tmpadodataset1.Commandtext:=' select max(kssxid) from t_dhxx ' +
                      ' where ksid=''' +ksid +''''+
                      ' and jzbz<>0 ' +
                      ' and hszh=' + inttostr(gblhszh);
               tmpadodataset1.Open;
               if not tmpadodataset1.Eof then
                   maxkssxid:=tmpadodataset1.Fields.Fields[0].AsInteger;

               cmdstr:=' select kssxid from t_dhxx ' +
                      ' where ksid=''' +ksid +''''+
                      ' and jzbz<>0 ' +
                      ' and hszh=' + inttostr(gblhszh);

               ddrs:=adoconnection.execute(cmdstr,cmdtext).RecordCount+1;
               //如果新增的科室中排队病人的序号与目前的最大序号重号，则再试
   //            if maxkssxid >= ddrs then break;

                   if jzbz<>'0' then //要就诊
                   begin
                     bAtTime:=true;
                     if yxjid=88 then//是预约号。
                     begin
                       if AGroupID='' then
                       begin
  //                       if by7<=(FormatDateTime('hh:nn',ghsj)) then
  //                       //在预约时间段内挂的号
  //                       begin
  //                         //读取，并设置优先
  //                       end
  //                       else if by7<(FormatDateTime('hh:nn',ghsj)) then
  //                       //在预约时间段后挂的号
  //                       begin
  //                         //读取，并设置优先（错过时间段）
  ////                         yxjid:=89;
  //                       end
  //                       else
  //                       //在预约时间段前挂的号//
                         begin
                           if by7<=(FormatDateTime('hh:nn',now)) then//当前时间已经到了预约时间段
                           begin
                             //读取，并设置优先
                             bAtTime := true;
                           end
                           else //当前时间还未到预约时间段
                           begin

                             if yysjdjh='1' then //预约时间段后叫号时//读取但是设置为普通号。
                             begin
                                yxjid :=0;
                             end
                             else if (yysjdjh='2') then //预约时间段后叫号，并且设置为未到时，不能被呼叫。
                             begin
                               yxjid :=0;
                               jzbz:='2';
                               dhztbz:='8'
                             end;
                             bAtTime:=True;
                           end;
                         end;
                       end
                       else
                       begin
                         if ksid=AGroupID then
                         begin
  //                         if by7=(FormatDateTime('hh:nn',ghsj)) then
  //                         //在预约时间段内挂的号
  //                         begin
  //                           //读取，并设置优先
  //                         end
  //                         else if by7<(FormatDateTime('hh:nn',ghsj)) then
  //                         //在预约时间段后挂的号
  //                         begin
  //                           //读取，并设置优先（错过时间段）
  //                           yxjid:=89;
  //                         end
  //                         else
                           //在预约时间段前挂的号//
                           begin
                             if by7<=(FormatDateTime('hh:nn',Now)) then
                             //当前时间已经到了预约时间段
                             begin
                               //读取，并设置优先
                             end
  //                           else if by7=(FormatDateTime('hh:nn',Now+1/24)) then
  //                           //预约时间段是下一个预约时间段。
  //                           begin
  //                             //读取，并设置优先
  //                           end
                             else //当前时间还未到预约时间段
                             begin
                               //不读取。
                               if yysjdjh='1' then //预约时间段后叫号时//读取但是设置为普通号。
                               begin
                                 yxjid :=0;
                               end
                               else if (yysjdjh='2') then //预约时间段后叫号，并且设置为未到时，不能被呼叫。
                               begin
                                 yxjid :=0;
                                 jzbz:='2';
                                 dhztbz:='8'
                               end;
                               bAtTime:=True;
                             end;
                           end;
                         end
                         else
                         begin
  //                         if by7=(FormatDateTime('hh:nn',ghsj)) then
  //                         //在预约时间段内挂的号
  //                         begin
  //                           //读取，并设置优先
  //                         end
  //                         else if by7<(FormatDateTime('hh:nn',ghsj)) then
  //                         //在预约时间段后挂的号
  //                         begin
  //                           //读取，并设置优先（错过时间段）
  //                           yxjid:=89;
  //                         end
  //                         else
                           //在预约时间段前挂的号//
                           begin
                             if by7<=(FormatDateTime('hh:nn',Now)) then//当前时间已经到了预约时间段
                             begin
                               //读取，并设置优先
                             end
                             else //当前时间还未到预约时间段
                             begin
                               //不读取。
                               yxjid:=0;
                               bAtTime:=True;
                             end;
                           end;
                         end;
                       end;
                     end;

                     if bAtTime then
                     begin
                       ADOConnection.BeginTrans;
                       blRollback := False;
                       try
                         try
                           cmdstr:=' UPDATE t_ghxx ' +
                                 ' set ztbz=9 ' +
                                 ' where id=' + rec_id;
                           adoconnection.Execute(cmdstr,cmdtext);
                            {2005-11-8加入按号码排序插入数据的功能}
  //                          cmdstr:=' select HMPX from t_ks (nolock) where ksid='''+ksid+''''+
  //                                  ' and hszh='+inttostr(gblhszh);
                            tmpadoquery:=tadoquery.Create(nil);
                            tmpadoquery.Connection:=adoconnection;
  //                          tmpadoquery.SQL.Text:=cmdstr;
  //                          tmpadoquery.Open;
  //                          if not tmpadoquery.Eof then
  //                             tmpHMPX:=tmpadoquery.Fieldbyname('HMPX').asinteger;
  //                          tmpadoquery.Close;
                            cmdstr:=' select yhmc from t_yh (nolock) where yhid='''+yhid+''''+
                                    ' and hszh='+inttostr(gblhszh);
                            tmpadoquery.SQL.Text:=cmdstr;
                            tmpadoquery.Open;
                            if not tmpadoquery.Eof then
                               yhxm:=tmpadoquery.Fieldbyname('yhmc').AsString;
                            tmpadoquery.Close;
  ///////////2014-09-15 吴刚去掉，改用存储过程///////////////////
  //                          if tmpHMPX=1 then //按号码重新排序
  //                          begin
  //                             //得到比当前病人挂号号码大的病人KSSXID;
  //                             {try
  //                                tmpghhm:=strtoint(ghhm);
  //                             except
  //                                tmpghhm:=99999;
  //                              end; }
  //                              kssxid :=0;
  //                              if jzbz='2' then
  //                              begin
  //                                x := GetNotWakeupMaxKSSXID(ksid,IntToStr(sjdbz),'0',gblHSZH);
  //                                if (x>0) and (x>=kssxid) then
  //                                  kssxid :=x+1
  //                                else
  //                                begin
  //                                  tmpadoquery.Close;
  //                                  tmpadoquery.SQL.Text :='select max(kssxid) as max_sxid from t_dhxx where '+
  //                                       ' ksid='''+ksid +''''+
  //                                       ' and hszh='+inttostr(gblhszh)+
  //                                       ' and jzbz<>''0''';
  //                                  tmpadoquery.Open;
  //                                  if tmpadoquery.FieldByName('max_sxid').AsInteger=0 then
  //                                     kssxid:=ddrs
  //                                  else
  //                                     kssxid:=tmpadoquery.FieldByName('max_sxid').AsInteger+1;
  //                                  tmpadoquery.Close;
  //                                end;
  //                              end
  //                              else
  //                              begin
  //                                //得到准备病人最大kssxid.
  //                                x := GetZBBRMaxKSSXID(ksid,'0',gblHSZH);
  //                                if (x>0) and (x>=kssxid) then
  //                                  kssxid :=x+1;
  //                                //得到已发短信的病人最大kssxid
  //                                x :=  GetSendSmsMaxKSSXID(ksid,'0',gblHSZH);
  //                                if (x>0) and (x>=kssxid) then
  //                                  kssxid:= x+1;
  //                                //得到预约病人最大kssxid;
  //                                x := GetYYBRMaxKSSXID(ksid,'','0',IntToStr(sjdbz),gblHSZH);
  //                                if (x>0) and (x>=kssxid) then
  //                                  kssxid:= x+1;
  //                               //先找到t_dhxx.sjdbz<sjdbz的病人最大kssxid
  //                                x := GetMinSjdbzPos(ksid,IntToStr(sjdbz),'0',gblHSZH);
  //                                if (x>0) and (x>=kssxid) then
  //                                  kssxid:= x+1;
  //                               //再找t_dhxx.sjdbz=sjdbz前且号码比ghhm小的病人最大kssxid
  //                                x := GetSameSjdbzPos(ksid,IntToStr(sjdbz),ghhm,'0',gblHSZH);
  //                                if (x>0) and (x>=kssxid) then
  //                                  kssxid := x+1;
  //
  //                              end;
  //                              if kssxid=0 then kssxid:=1;
  ////
  ////                               try
  ////
  ////                               cmdstr:=' select kssxid from t_dhxx (nolock) where'+
  ////                                       ' replicate(''0'',10-len(ghhm))+ghhm>replicate(''0'',10-len('''+ghhm+'''))+'''+ghhm+''''+
  ////                                       ' and ksid='''+ksid +''''+
  ////                                       ' and hszh='+inttostr(gblhszh)+
  ////                                       ' and jzbz<>''0'''+
  ////                                       ' and ztbz<>5'+
  ////                                       ' and (yxjid=0 or yxjid='+inttostr(yxjid)+')'+
  ////                                       ' order by convert(varchar(10),ghsj,112),replicate(''0'',10-len(ghhm))+ghhm';
  ////                               tmpadoquery.SQL.Text:=cmdstr;
  ////                               tmpadoquery.Open;
  ////                               except
  ////                               cmdstr:=' select kssxid from t_dhxx (nolock) where replicate(''0'',10-len(ghhm))+ghhm>replicate(''0'',10-len('''+ghhm+'''))+'''+ghhm+''''+
  ////                                       ' and ksid='''+ksid +''''+
  ////                                       ' and hszh='+inttostr(gblhszh)+
  ////                                       ' and jzbz<>''0'''+
  ////                                       ' and ztbz<>5'+
  ////                                       ' and (yxjid=0 or yxjid='+inttostr(yxjid)+')'+
  ////                                       ' order by convert(varchar(10),ghsj,112),replicate(''0'',10-len(ghhm))+ghhm';
  ////                               tmpadoquery.SQL.Text:=cmdstr;
  ////                               tmpadoquery.Open;
  ////
  ////                               end;
  ////                               if not tmpadoquery.Eof then
  ////                               begin
  ////                                  kssxid:=tmpadoquery.fieldbyname('kssxid').AsInteger;
  ////                               end
  ////                               else
  ////                               begin
  ////                                  tmpadoquery.Close;
  ////                                  tmpadoquery.SQL.Text :='select max(kssxid) as max_sxid from t_dhxx where '+
  ////                                       ' ksid='''+ksid +''''+
  ////                                       ' and hszh='+inttostr(gblhszh)+
  ////                                       ' and jzbz<>''0''';//+
  ////                                       //' and yxjid=0 ';
  ////                                  tmpadoquery.Open;
  ////                                  if tmpadoquery.FieldByName('max_sxid').AsInteger=0 then
  ////                                     kssxid:=ddrs
  ////                                  else
  ////                                     kssxid:=tmpadoquery.FieldByName('max_sxid').AsInteger+1;
  ////                               end;
  ////                               tmpadoquery.Close;
  ////                               try
  ////
  ////                               cmdstr:=' select kssxid from t_dhxx (nolock) where'+
  ////                                       ' replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len('''+ghhm+'''))+'''+ghhm+''''+
  ////                                       ' and ksid='''+ksid +''''+
  ////                                       ' and hszh='+inttostr(gblhszh)+
  ////                                       ' and jzbz<>''0'''+
  ////                                       ' and ztbz<>5'+
  ////                                       ' and (yxjid=0 or yxjid='+inttostr(yxjid)+')'+
  ////                                       ' order by kssxid desc';
  ////                               tmpadoquery.SQL.Text:=cmdstr;
  ////                               tmpadoquery.Open;
  ////                               except
  ////                               cmdstr:=' select kssxid from t_dhxx (nolock) where replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len('''+ghhm+'''))+'''+ghhm+''''+
  ////                                       ' and ksid='''+ksid +''''+
  ////                                       ' and hszh='+inttostr(gblhszh)+
  ////                                       ' and jzbz<>''0'''+
  ////                                       ' and ztbz<>5'+
  ////                                       ' and (yxjid=0 or yxjid='+inttostr(yxjid)+')'+
  ////                                       ' order by kssxid desc';
  ////                               tmpadoquery.SQL.Text:=cmdstr;
  ////                               tmpadoquery.Open;
  ////
  ////                               end;
  ////                               if not tmpadoquery.Eof then
  ////                               begin
  ////                                  tmpkssxid:=tmpadoquery.fieldbyname('kssxid').AsInteger;
  ////                               end
  ////                               else
  ////                                  tmpkssxid:=1;
  ////                               tmpadoquery.Close;
  ////                               if tmpkssxid>kssxid then
  ////                                  kssxid:=tmpkssxid+1;
  //
  //                               cmdstr:=' update t_dhxx set kssxid=kssxid+1 where kssxid>='+inttostr(kssxid)+
  //                                       ' and ksid='''+ksid+''''+
  //                                       ' and hszh='+inttostr(gblhszh)+
  //                                       ' and jzbz<>''0''' ;
  //                               adoconnection.Execute(cmdstr,cmdtext);
  //                          end
  //                          else
  //                          begin
  //                            tmpadoquery.Close;
  //                            tmpadoquery.SQL.Text :='select max(kssxid) as max_sxid from t_dhxx where '+
  //                                 ' ksid='''+ksid +''''+
  //                                 ' and hszh='+inttostr(gblhszh)+
  //                                 ' and jzbz<>''0''';
  //                            tmpadoquery.Open;
  //                            if tmpadoquery.FieldByName('max_sxid').AsInteger=0 then
  //                               kssxid:=ddrs
  //                            else
  //                               kssxid:=tmpadoquery.FieldByName('max_sxid').AsInteger+1;
  //                            tmpadoquery.Close;
  //                             //kssxid:=ddrs ;
  //                          end;
  ///////////2014-09-15去掉///////////////////
                            kssxid := DB_GetGroupPatientPos(ksid,sjdbz,ghhm,hszh,StrToInt(jzbz));  //此函数不修改排序
                            if kssxid=0 then kssxid :=ddrs;
                            if by1=99 then kssxid := ddrs;
                            FreeAndNil(tmpadoquery);
                            if gblNoonpause then
                            begin
                              kssxid := ddrs;
                            end;
                            //if (gblkeeprebackpos=0) then  //召回位置跟随挂号信息向后移动
                            begin
                              //修改病人排序
                              cmdstr:=' UPDATE t_dhxx ' +
                                 ' set kssxid=kssxid+1' +
                                 ' where kssxid>=' + inttostr(kssxid)+
                                 ' and jzbz<>0'+
                                 ' and ksid=''' + ksid +''''+
                                 ' and hszh=' + inttostr(gblhszh);
                              adoconnection.Execute(cmdstr,cmdtext);
                            end;
//                            else  //召回病人的位置不变
//                            begin
//                              //修改病人排序(将非召回病人序号向后推一位)
//                              cmdstr:=' UPDATE t_dhxx ' +
//                                 ' set kssxid=kssxid+1' +
//                                 ' where kssxid>=' + inttostr(kssxid)+
//                                 ' and jzbz<>0'+
//                                 ' and ztbz<>2 and yxjid<>1'+
//                                 ' and ksid='+ quotedstr(ksid)+
//                                 ' and hszh=' + inttostr(gblhszh);
//                              adoconnection.Execute(cmdstr,cmdtext);
//
//                              //修改病人排序（将与召回病人序号相同的向后再推一位)
//                              cmdstr:=' UPDATE t_dhxx ' +
//                                 ' set kssxid=kssxid+1' +
//                                 ' from t_DHXX d'+
//                                 ' where exists('+
//                                 ' select 1 from t_DHXX where KSID=d.ksid '+
//                                 ' and HSZH=d.hszh '+
//                                 ' and ZTBZ=2 and YXJID=1 and KSSXID=d.KSSXID '+
//                                 ' and HSZH='+inttostr(gblhszh)+' and KSID='+ quotedstr(ksid)+
//                                 ' and JZBZ<>0)
//                                 ' and d.HSZH='+inttostr(gblhszh)+' and KSID='+ quotedstr(ksid)+
//                                 ' and JZBZ<>0
//                                 ' and ZTBZ<>2 and YXJID<>1';
//                              adoconnection.Execute(cmdstr,cmdtext);
//                            end;
                            //加入到DHXX表中
                            if gblhavemzh=1 then
                            begin
                            cmdstr:='Insert into t_dhxx'  +
                                    '(kssxid,' +
                                    ' KSID,' +
                                    ' brxm,' +
                                    ' brdm,' +
                                    ' ghhm,'+
                                    ' ghsj,' +
                                    ' jzbz,' +
                                    ' YHID,' +
                                    ' sjdbz,' +
                                    ' ztbz,' +
                                    ' yxjid,'+
                                    ' by1,' +
                                    ' by2,' +
                                    ' by3,' +
                                    ' by4,' +
                                    ' by5,'+
                                    ' by6,by7,'+
                                    ' yhlcs,lc,' +
                                    ' mzh,xb,nl,'+
                                    ' xmsp,ghhm_seq,'+
                                    ' hszh,yksdm) ' +
                                    ' values '+
                                    ' (' + inttostr(kssxid) +
                                    ' ,'''+ ksid + ''''+
                                    ' ,'''+ brxm + ''''+
                                    ' ,'''+ brdm + ''''+
                                    ' ,''' + ghhm + ''''+
                                    ' ,''' + cdatetostr(ghsj) + ' ' + ctimetostr(ghsj) + ''''+
                                    ' ,' +iif(gblNoonpause,'2',jzbz)+'' +
                                    ' ,''' + yhid +''''+
                                    ' ,'+ inttostr(sjdbz) +
                                    ' ,' +iif(gblNoonpause,'6',dhztbz)+''+
                                    ' ,'+inttostr(yxjid)+//优先级
                                    ' ,' + inttostr(by1) +
                                    ' ,' + inttostr(by2) +
                                    ' ,'''+ by3 + ''''+
                                    ' ,'''+ by4 + ''''+
                                    ' ,'''+by5+''''+
                                    ' ,'''+by6+''''+','+quotedstr(by7)+
                                    ' ,0' + ','+lc+
                                    ' ,'+quotedstr(mzh)+','+quotedstr(xb)+','+quotedstr(nl)+
                                    ' ,'+quotedstr(xmsp)+',dbo.strtoint('+quotedstr(ghhm)+')'+
                                    ' ,' + inttostr(gblhszh)+','+ quotedstr(yksdm)+
                                    ' )' ;
                            end
                            else
                            begin
                            cmdstr:='Insert into t_dhxx'  +
                                    '(kssxid,' +
                                    ' KSID,' +
                                    ' brxm,' +
                                    ' brdm,' +
                                    ' ghhm,'+
                                    ' ghsj,' +
                                    ' jzbz,' +
                                    ' YHID,' +
                                    ' sjdbz,' +
                                    ' ztbz,' +
                                    ' yxjid,'+
                                    ' by1,' +
                                    ' by2,' +
                                    ' by3,' +
                                    ' by4,' +
                                    ' by5,'+
                                    ' by6,by7,'+
                                    ' yhlcs,lc,' +
                                    ' hszh) ' +
                                    ' values '+
                                    ' (' + inttostr(kssxid) +
                                    ' ,'''+ ksid + ''''+
                                    ' ,'''+ brxm + ''''+
                                    ' ,'''+ brdm + ''''+
                                    ' ,''' + ghhm + ''''+
                                    ' ,''' + cdatetostr(ghsj) + ' ' + ctimetostr(ghsj) + ''''+
                                    ' ,' +iif(gblNoonpause,2,jzbz)+'' +
                                    ' ,''' + yhid +''''+
                                    ' ,'+ inttostr(sjdbz) +
                                    ' ,' +iif(gblNoonpause,6,dhztbz)+''+
                                    ' ,'+inttostr(yxjid)+//优先级
                                    ' ,' + inttostr(by1) +
                                    ' ,' + inttostr(by2) +
                                    ' ,'''+ by3 + ''''+
                                    ' ,'''+ by4 + ''''+
                                    ' ,'''+by5+''''+
                                    ' ,'''+by6+''''+','+quotedstr(by7)+
                                    ' ,0' + ','+lc+
                                    ' ,' + inttostr(gblhszh)+
                                    ' )' ;
                            end;
                            adoconnection.execute(cmdstr,cmdtext);
                            ADOConnection.CommitTrans;
                         except on e1:exception do
                           begin
                             ADOConnection.RollbackTrans;
                             blRollback := True;
                             addlog('errorlog.txt','插入到等候信息时有错误发生!'+cmdstr+' '+e1.Message);
                             if e1.Message='连接失败' then
                             begin
                               errproc();
                               result:=false;
                               exit;
                             end;
                           end;
                         end;
                       finally
  //                       if not blRollback then
  //                         ADOConnection.CommitTrans;
                       end;
                       if not blRollback then
                       begin
                        //将修改过科室的信息放入到数组中.
                        jrid :='0';
                        if (yxjid<>0) or (gblkyhjdkstybr=0) then
                        begin
                           tmpadoquery:=Tadoquery.Create(nil);
                           tmpadoquery.Connection:=Adoconnection;
                           tmpadoquery.SQL.Text:='select kssxid,id from t_dhxx where ksid='''+ksid+''''+
                            ' and brdm='+quotedstr(brdm)+
                            ' and by4='+quotedstr(by4)+
                            ' and brxm='+quotedstr(brxm)+
                            ' and ghhm='''+ghhm+''''+' and hszh='+inttostr(gblhszh)+
                            ' order by id desc';
                           tmpadoquery.Open;
                           if not tmpadoquery.Eof then
                           begin
                              selekssxid:=tmpadoquery.fieldbyname('kssxid').asstring;
                              jrid:=tmpadoquery.fieldbyname('id').asstring;
                              tmpadoquery.Close;
                           end;
                           FreeAndNil(tmpadoquery);
                        end;
                        if (yxjid<>0) and (jrid<>'0') then
                        begin
                           szyxj(jrid,inttostr(yxjid));
                        end
                        else
                        begin
                            if (gblPutspecialForward=1) then
                            begin//有小号码提前时将优先的号码提前一位//
                              doPutSpecialForward(ksid,kssxid);
                            end;
                        end;
                        if (gblkyhjdkstybr=0) and (jrid<>'0') then  //如果不能呼叫多个科室同一病人，则需要添加排除医生
                        begin
                          addyhcannotcall(jrid);
                          if yhid<>'' then  //如果选了医生，则将此病人的其它号排除此医生
                          begin
                            addyhcancall(jrid,yhid,'-1');
                          end;
                        end;
                        isExsit:=false;
                        for i :=0 to gbledit_ks_count -1 do
                        begin
                           if gbledit_ks[i].ksid=fields.Fields[1].AsString then
                              begin
                                 isexsit:=true;
                                 break;
                              end;
                        end;
                        if gblFormType=1 then
                        begin
                          if dmDBAccess.GetDBValue('KS',fields.Fields[1].AsString,'hided')='1' then
                          begin
                            dmDBAccess.SetDBValue('KS',fields.Fields[1].AsString,'hided','0');
                            frmMain.ReflushGroupList();
                          end;
                        end;
                        if isexsit=false then
                        begin
                           gbledit_ks_count:=gbledit_ks_count +1;
        //                   setlength(edit_ks,edit_ks_count);
                           gbledit_ks[gbledit_ks_count-1].ksid:=ksid;
                           gbledit_ks[gbledit_ks_count-1].ksmc:=ksmc;   //fields.Fields[];
                           for groupnumber_index:=0 to groupnumber-1 do
                           begin
                              if groupserial[groupnumber_index].ksid=ksid then
                              begin
                                 groupserial[groupnumber_index].newno := true;
                                 break;
                              end;
                           end;
                        end;
    //                    if gbledit_ks_count>0 then
    //                    begin
    //                      frmMain.SXKSXX;
    //                    end;
                        if  ztbz='3' then //如果是从本系统界面中取号的将要打印票单。
                        begin
                          if gblDYPD=1 then//此参数确定要不要票单。
                          begin
                             //查找打印票单信息;
                             tmpadodataset1.Close;
                             tmpadodataset1.Commandtext:=' select  t_qhajsz.pdid,t_pdwb.pdwb,t_qhajsz.dyzs from  ' +
                                ' t_qhajsz left outer join t_pdwb on ' +
                                ' t_qhajsz.pdid = t_pdwb.pdid and t_qhajsz.hszh =t_pdwb.hszh ' +
                                ' where t_qhajsz.ksid=''' + ksid + ''''+
                                ' and t_qhajsz.hszh=' + inttostr(gblhszh);
                            tmpadodataset1.Open;
                            with tmpadodataset1 do
                            begin
                                if  not tmpadodataset1.Eof then
                                begin
                                   tick_print_info.TicketStr:=fields.Fields[1].AsString;
                                   tick_print_info.TQno:=ghhm;
                                   tick_print_info.TRoomNo:='1';
                                   tick_print_info.TGroupCode:='';
                                   tick_print_info.TGroupNo:=ksid;
                                   tick_print_info.TGroupName:=ksmc;
                                   tick_print_info.TCustName:=brxm;
                                   tick_print_info.TCustNO:=brdm;
                                   tick_print_info.TButtonName:='';
                                   tick_print_info.TAVGWaitTime:='0';
                                   tick_print_info.TWaitNum:=inttostr(ddrs);
                                   tick_print_info.TJch:=by3;
                                   tick_print_info.TBarCode:=by4;
                                   tick_print_info.TYHCode :=currentuser.UserID ;
                                   tick_print_info.TYHName :=currentuser.UserName;
                                   tick_print_info.TYSCode :=yhid;
                                   tick_print_info.TYSName :=yhxm;
                                   dyzs:= fields.Fields[2].Asinteger;


                                   ///打印票单;
                                   dmdbaccess.PrintTick(dyzs);
                                   sleep(200);
                                end;
                                close;
                            end;
                            //////
                          end
                          else if gbldypd=2 then
                          begin
                              ///////////////////////
                             ///使用串口发送代码打印。
                             ///////////////////////
                             //查找打印票单信息;
                             tmpadodataset1.Close;
                             tmpadodataset1.Commandtext:=' select  t_qhajsz.pdid,t_pdwb.pdwb,t_qhajsz.dyzs from  ' +
                                ' t_qhajsz left outer join t_pdwb on ' +
                                ' t_qhajsz.pdid = t_pdwb.pdid and t_qhajsz.hszh =t_pdwb.hszh ' +
                                ' where t_qhajsz.ksid=''' + ksid + ''''+
                                ' and t_qhajsz.hszh=' + inttostr(gblhszh);
                            tmpadodataset1.Open;
                            with tmpadodataset1 do
                            begin
                                if  not tmpadodataset1.Eof then
                                begin
                                   tick_print_info.TicketStr:=fields.Fields[1].AsString;
                                   tick_print_info.TQno:=ghhm;
                                   tick_print_info.TRoomNo:='1';
                                   tick_print_info.TGroupCode:='';
                                   tick_print_info.TGroupNo:=ksid;
                                   tick_print_info.TGroupName:=ksmc;
                                   tick_print_info.TCustName:=brxm;
                                   tick_print_info.TCustNO:=brdm;
                                   tick_print_info.TButtonName:='';
                                   tick_print_info.TAVGWaitTime:='0';
                                   tick_print_info.TWaitNum:=inttostr(ddrs);
                                   tick_print_info.TJch:=by3;
                                   tick_print_info.TBarCode:=by4;
                                   tick_print_info.TYHCode :=currentuser.UserID ;
                                   tick_print_info.TYHName :=currentuser.UserName;
                                   tick_print_info.TYSCode :=yhid;
                                   tick_print_info.TYSName :=yhxm;
                                   dyzs:= fields.Fields[2].Asinteger;

                                   ///打印票单;
                                   dmdbaccess.PrintTickcom(dyzs);
                                   sleep(200);
                                end;
                                close;
                            end;
                            //////
                          end;

                        end;
                       end;
                     end;
                   end
                   else
                   //要退号
                   begin
                     ADOConnection.BeginTrans;
                     blRollback := False;
                     try
                       try
                         cmdstr:=' UPDATE t_ghxx ' +
                               ' set ztbz=9 ' +
                               ' where id=' + rec_id;
                         adoconnection.Execute(cmdstr,cmdtext);

                          tmpadodataset1.Close;
                          tmpadodataset1.Commandtext:=' select id,ksid,kssxid,jzbz from t_dhxx ' +
                              //' where brdm=''' + brdm + ''''+
                              ' where by4=''' + by4 + ''''+
                              ' and brdm=''' + brdm + ''''+
                              //' and jzbz<>0' +
                              ' and ghhm=''' + ghhm +''''+
                              ' and brxm=''' + brxm +''''+
                              ' and ksid=''' + ksid +''''+
                              ' and hszh=' + inttostr(gblhszh);
                         tmpadodataset1.Open;
                         with tmpadodataset1 do
                         begin
                           if not tmpadodataset1.Eof then
                           begin
                             while not tmpadodataset1.Eof do
                             begin
                               if tmpadodataset1.FieldByName('jzbz').AsString='0' then
                               begin
                                 if (by5='完成') or (by5='已就诊') then
                                 begin
                                  cmdstr:=' update t_dhxx ' +
                                          ' set jzbz=0,ztbz=7 '+
                                          ',by5=''完成'''+
                                          ' where id=' + fields.Fields[0].AsString;
                                 end
                                 else //if (gblRegUser ='上海市中医药大学附属曙光医院') then
                                 begin
                                    cmdstr:=' update t_dhxx ' +
                                            ' set jzbz=0,ztbz=3 '+
                                            ',by5=''退号'''+
                                            ' where id=' + fields.Fields[0].AsString;
                                 end;
                                 adoconnection.Execute(cmdstr,cmdtext);
                                isExsit:=false;
                                for i :=0 to gbledit_ks_count -1 do
                                begin
                                    if gbledit_ks[i].ksid=fields.Fields[1].AsString then
                                    begin
                                       isexsit:=true;
                                       break;
                                    end;
                                end;
                                if isexsit=false then
                                begin
                                   gbledit_ks_count:=gbledit_ks_count +1;
                                   //setlength(edit_ks,edit_ks_count);
                                   gbledit_ks[gbledit_ks_count-1].ksid:=fields.Fields[1].AsString;
                                   gbledit_ks[gbledit_ks_count-1].ksmc:='';//fields.Fields[];
                                   for groupnumber_index:=0 to groupnumber-1 do
                                   begin
                                      if groupserial[groupnumber_index].ksid=ksid then
                                      begin
                                         groupserial[groupnumber_index].newno := true;
                                         break;
                                      end;
                                   end;
                                end
                                else
                                begin
                                   for groupnumber_index:=0 to groupnumber-1 do
                                   begin
                                      if groupserial[groupnumber_index].ksid=ksid then
                                      begin
                                         groupserial[groupnumber_index].newno := true;
                                         break;
                                      end;
                                   end;
                                end;
                               end
                               else
                               begin
                             ////删除此病人挂号信息
                                 if (by5='完成') or (by5='已就诊') then
                                 begin
                                  if (yhid='') then
                                     cmdstr:=' update t_dhxx ' +
                                          ' set jzbz=0,ztbz=7 '+
                                          ',by5=''完成'''+
                                          //' set jzbz=0,ztbz=7 '+
                                          ' where id=' + fields.Fields[0].AsString
                                  else
                                    cmdstr:=' update t_dhxx ' +
                                          ' set jzbz=0,ztbz=7 '+
                                          ',by5=''完成'''+
                                          ',yhid='+quotedstr(yhid)+
                                          //' set jzbz=0,ztbz=7 '+
                                          ' where id=' + fields.Fields[0].AsString;
                                 end
                                 else
                                  cmdstr:=' update t_dhxx ' +
                                          ' set jzbz=0,ztbz=3 '+
                                          ',by5=''退号'''+
                                          //' set jzbz=0,ztbz=7 '+
                                          ' where id=' + fields.Fields[0].AsString;

                                adoconnection.Execute(cmdstr,cmdtext);
                                //修改病人排序
                                cmdstr:=' UPDATE t_dhxx ' +
                                   ' set kssxid=kssxid-1' +
                                   ' where kssxid>' + inttostr(fields.Fields[2].AsInteger )+
                                   ' and ksid=''' + fields.Fields[1].AsString +''''+
                                   ' and hszh=' + inttostr(gblhszh);
                                adoconnection.Execute(cmdstr,cmdtext);
                                //将修改过科室的信息放入到数组中.
                                isExsit:=false;
                                for i :=0 to gbledit_ks_count -1 do
                                begin
                                    if gbledit_ks[i].ksid=fields.Fields[1].AsString then
                                    begin
                                       isexsit:=true;
                                       break;
                                    end;
                                end;
                                if isexsit=false then
                                begin
                                   gbledit_ks_count:=gbledit_ks_count +1;
                                   //setlength(edit_ks,edit_ks_count);
                                   gbledit_ks[gbledit_ks_count-1].ksid:=fields.Fields[1].AsString;
                                   gbledit_ks[gbledit_ks_count-1].ksmc:='';//fields.Fields[];
                                end
                                else
                                begin
                                   for groupnumber_index:=0 to groupnumber-1 do
                                   begin
                                      if groupserial[groupnumber_index].ksid=ksid then
                                      begin
                                         groupserial[groupnumber_index].newno := true;
                                         break;
                                      end;
                                   end;
                                end;

  //                              if gbledit_ks_count>0 then
  //                              begin
  //                                frmMain.SXKSXX;
  //                              end;
                               end;
                               tmpadodataset1.next;
                             end;
                            end
                            else  //t_dhxx表中无此病人//  则插入一条
                            begin
                              //加入到DHXX表中
                              if gblhavemzh=1 then
                              begin
                              cmdstr:='Insert into t_dhxx'  +
                                      '(kssxid,' +
                                      ' KSID,' +
                                      ' brxm,' +
                                      ' brdm,' +
                                      ' ghhm,'+
                                      ' ghsj,' +
                                      ' jzbz,' +
                                      ' YHID,' +
                                      ' sjdbz,' +
                                      ' ztbz,' +
                                      ' yxjid,'+
                                      ' by1,' +
                                      ' by2,' +
                                      ' by3,' +
                                      ' by4,' +
                                      ' by5,'+
                                      ' by6,by7,'+
                                      ' yhlcs,lc,' +
                                      ' mzh,xb,nl,'+
                                      ' xmsp,ghhm_seq,'+
                                      ' hszh,yksdm) ' +
                                      ' values '+
                                      ' (' + inttostr(0) +
                                      ' ,'''+ ksid + ''''+
                                      ' ,'''+ brxm + ''''+
                                      ' ,'''+ brdm + ''''+
                                      ' ,''' + ghhm + ''''+
                                      ' ,''' + cdatetostr(ghsj) + ' ' + ctimetostr(ghsj) + ''''+
                                      ' ,' +'0' +
                                      ' ,''' + yhid +''''+
                                      ' ,'+ inttostr(sjdbz) +
                                      ' ,' +iif(by5='完成','7','3')+
                                      ' ,'+inttostr(yxjid)+//优先级
                                      ' ,' + inttostr(by1) +
                                      ' ,' + inttostr(by2) +
                                      ' ,'''+ by3 + ''''+
                                      ' ,'''+ by4 + ''''+
                                      ' ,'''+by5+''''+
                                      ' ,'''+by6+''''+','+quotedstr(by7)+
                                      ' ,0' + ','+lc+
                                      ' ,'+quotedstr(mzh)+','+quotedstr(xb)+','+quotedstr(nl)+
                                      ' ,'+quotedstr(xmsp)+',dbo.strtoint('+quotedstr(ghhm)+')'+
                                      ' ,' + inttostr(gblhszh)+','+ quotedstr(yksdm)+
                                      ' )' ;
                              end
                              else
                              begin
                              cmdstr:='Insert into t_dhxx'  +
                                      '(kssxid,' +
                                      ' KSID,' +
                                      ' brxm,' +
                                      ' brdm,' +
                                      ' ghhm,'+
                                      ' ghsj,' +
                                      ' jzbz,' +
                                      ' YHID,' +
                                      ' sjdbz,' +
                                      ' ztbz,' +
                                      ' yxjid,'+
                                      ' by1,' +
                                      ' by2,' +
                                      ' by3,' +
                                      ' by4,' +
                                      ' by5,'+
                                      ' by6,by7,'+
                                      ' yhlcs,lc,' +
                                      ' hszh) ' +
                                      ' values '+
                                      ' (' + inttostr(0) +
                                      ' ,'''+ ksid + ''''+
                                      ' ,'''+ brxm + ''''+
                                      ' ,'''+ brdm + ''''+
                                      ' ,''' + ghhm + ''''+
                                      ' ,''' + cdatetostr(ghsj) + ' ' + ctimetostr(ghsj) + ''''+
                                      ' ,' +'0' +
                                      ' ,''' + yhid +''''+
                                      ' ,'+ inttostr(sjdbz) +
                                      ' ,' +iif(by5='完成','7','3')+
                                      ' ,'+inttostr(yxjid)+//优先级
                                      ' ,' + inttostr(by1) +
                                      ' ,' + inttostr(by2) +
                                      ' ,'''+ by3 + ''''+
                                      ' ,'''+ by4 + ''''+
                                      ' ,'''+by5+''''+
                                      ' ,'''+by6+''''+','+quotedstr(by7)+
                                      ' ,0' + ','+lc+
                                      ' ,' + inttostr(gblhszh)+
                                      ' )' ;
                              end;
                              adoconnection.execute(cmdstr,cmdtext);
                            end;
                         end;
                         ADOConnection.CommitTrans;
                       except  on e2:exception do
                       begin
                         ADOConnection.RollbackTrans;
                         blRollback := True;
                         addlog('errorlog.txt','退号时有错误发生!'+cmdstr+' '+ e2.Message);
                         if e2.Message='连接失败' then
                         begin
                           errproc();
                           result:=false;
                           exit;
                         end;
                       end;
                       end;
                     finally
  //                     if not blRollback then
  //                       ADOConnection.CommitTrans;
                     end;
                   end;
  //                 dmdbaccess.addlog('errorlog.txt',formatdatetime('yyyy-mm-dd hh:nn:ss:zzz',now)+' 开始结束rec_id:'+rec_id);
             end;
             next;
             sleep(10);
         end;
         Close;
       end;
    end;
    result:=true;
    gblisindo:=false;
  except
    on e:Exception do
      begin
         //showmessage(e.message+'eoleexception');
         //disconnect;
         //sleep(1000);
         //connect;
         gblisindo:=false;
         addlog('ErrorLog.txt',e.Message+cmdstr);
         errproc();
         result:=false;
         exit;
      end;
{      result := False;
      gblisindo:=false;
      Exit;
      }
  end;
  finally
    gblisindo:=false;
    freeandnil(tmpadodataset);
    freeandnil(tmpadodataset1);
  end;
end;

    //打印票单
    // TickNum 为张数
function Tdmdbaccess.PrintTick(const TickNum:integer):Boolean;
var
   temp_text:array[0..31] of string;
   need_print:boolean;
   tick_str_len:integer;
   xx_start:integer;
   xx:integer;
   tmpPrintinfo:string;
   i:integer;
   x:integer;  //打印位置
   y:integer;
   strect:TreCt;
   cmdChar:string;
   //old_font:TFont;

   Device: array[0..255] of char;
   Driver: array[0..255] of char;
   Port: array[0..255] of char;
   hDMode: THandle;
  // mybmp:Tbitmap;
   oldfontsize:integer;
   mypic:Tpicture;
   //PDMode: integer;
   pdmode: PDevMode ;
   tmpdyzs:integer;
   oldfontName:tfontname;
   tmpstr:string;
   tmpPrinterType:integer;
   tmpPrinterIndex:Integer;
        pDevice:pchar;
        pDriver:pchar;
        pPort:pchar;
        //hdMode:thandle;

begin
  try
//   if printer.
{  Printer.PrinterIndex := Printer.PrinterIndex;
  Printer.GetPrinter(Device, Driver, Port, hDMode);
  if hDMode <> 0 then
  begin
   pDMode := GlobalLock(hDMode);
    if pDMode <> nil then
    begin
        //Set to custom size
        pDMode^.dmFields := pDMode^.dmFields or
          DM_PAPERSIZE or
          DM_PAPERWIDTH or
          DM_PAPERLENGTH;
        pDMode^.dmPaperSize := DMPAPER_USER;
        pDMode^.dmPaperWidth := 288;// SomeValueInTenthsOfAMillimeter
        pDMode^.dmPaperLength := 192; //SomeValueInTenthsOfAMillimeter
      //设定纸张来源
      pDMode^.dmFields := pDMode^.dmFields or DMBIN_MANUAL;
      pDMode^.dmDefaultSource := DMBIN_MANUAL;

      GlobalUnlock(hDMode);
    end;

  end
  else
  begin
     //没有打印机,不能打印.
     exit ;

  end;
  Printer.PrinterIndex := Printer.PrinterIndex;}
  //以下开始打印
  //pirtner.
 // printer.PageHeight:=96*2;
 // printer.PageHeight:=96*3;
  {Printer.BeginDoc;
  Printer.Canvas.TextOut(100,100, 'Test 1');
  Printer.EndDoc;}
  if Printer.Printers.Count=0 then
  begin
     result:=false;
     exit;
  end
  else
  begin
    if gblPrinterType=0 then
    begin
      tmpstr:=printer.Printers[0];
      xx:=pos(' on ',tmpstr);
      if xx<>0 then
         tmpstr:=copy(tmpstr,1,xx-1);
      //if (printer.Printers[i]='EPSON Reduce35') or (tmpstr='EPSON Reduce35')  then
      if (printer.Printers[0]='EPSON TM-T88III Receipt')  or (tmpstr='EPSON Receipt') then
      begin
         tmpPrintertype:=1;
      end
      else if (printer.Printers[0]='EPSON TM-T88III Reduce35') or (tmpstr='EPSON Reduce35') then
         tmpPrintertype:=4
      else if (printer.Printers[0]='EPSON BA-T500 Full cut') or (tmpstr='EPSON BA-T500 Full cut')  then
         tmpPrintertype:=2
      else if (printer.Printers[0]='LTP2342 FULL CUT DOC MODE') or (tmpstr='LTP2342 FULL CUT DOC MODE')  then
         tmpPrintertype:=3
      else
         tmpPrintertype:=0;
    end
    else if gblPrinterType=1 then
    begin
       //TM88III;
        tmpPrinterIndex:=99;
        for i:=0 to printer.Printers.Count-1 do
        begin
            tmpstr:=printer.Printers[i];
            xx:=pos(' on ',tmpstr);
            if xx<>0 then
               tmpstr:=copy(tmpstr,1,xx-1);
            //if (printer.Printers[i]='EPSON Reduce35') or (tmpstr='EPSON Reduce35')  then
            if (printer.Printers[i]='EPSON TM-T88III Receipt') or (tmpstr='EPSON Reduce35')  then
            begin
               tmpPrinterIndex:=i;
               break;
            end;
        end;
        if tmpPrinterIndex=99 then
        begin
           Result:=false;
           exit ;
        end
        else
        begin
           tmpPrintertype:=1;
           printer.PrinterIndex:=i;
        end;
    end
    else if gblPrinterType=2 then
    begin
       //Bat-500;
        tmpPrinterIndex:=99;
        for i:=0 to printer.Printers.Count-1 do
        begin
            tmpstr:=printer.Printers[i];
            xx:=pos(' on ',tmpstr);
            if xx<>0 then
               tmpstr:=copy(tmpstr,1,xx-1);
            if (printer.Printers[i]='EPSON BA-T500 Full cut') or (tmpstr='EPSON BA-T500 Full cut')  then
            begin
               tmpPrinterIndex:=i;
               break;
            end;
        end;
        if tmpPrinterIndex=99 then
        begin
           Result:=false;
           exit ;
        end
        else
        begin
          tmpPrintertype:=2;
          printer.PrinterIndex:=i;
        end;
    end
    else if gblPrinterType=3 then
    begin
       //2342;
        tmpPrinterIndex:=99;
        for i:=0 to printer.Printers.Count-1 do
        begin
            tmpstr:=printer.Printers[i];
            xx:=pos(' on ',tmpstr);
            if xx<>0 then
               tmpstr:=copy(tmpstr,1,xx-1);
            if (printer.Printers[i]='LTP2342 FULL CUT DOC MODE') or (tmpstr='LTP2342 FULL CUT DOC MODE')  then
            begin
               tmpPrinterIndex:=i;
               break;
            end;
        end;
        if tmpPrinterIndex=99 then
        begin
           Result:=false;
           exit ;
        end
        else
        begin
          tmpPrintertype:=3;
          printer.PrinterIndex:=i;
        end;
    end
    else if gblPrinterType=4 then
    begin
       //2342;
        tmpPrinterIndex:=99;
        for i:=0 to printer.Printers.Count-1 do
        begin
            tmpstr:=printer.Printers[i];
            xx:=pos(' on ',tmpstr);
            if xx<>0 then
               tmpstr:=copy(tmpstr,1,xx-1);
            if (printer.Printers[i]='EPSON TM-T88III Reduce35') or (tmpstr='EPSON Reduce35')  then
            begin
               tmpPrinterIndex:=i;
               break;
            end;
        end;
        if tmpPrinterIndex=99 then
        begin
           Result:=false;
           exit ;
        end
        else
        begin
          tmpPrintertype:=3;
          printer.PrinterIndex:=i;
        end;
    end
    else if  gblPrinterType=9 then
    begin
      if gblPrinterName='' then
      begin
        Result := False;
        Exit;
      end;
      tmpPrinterIndex:=99;
      for i:=0 to printer.Printers.Count-1 do
      begin
          tmpstr:=printer.Printers[i];
          xx:=pos(gblPrinterName,tmpstr);
          if xx>0 then
          begin
             tmpPrinterIndex:=i;
             break;
          end;
      end;
      if tmpPrinterIndex=99 then
      begin
         Result:=false;
         exit ;
      end
      else
      begin
        tmpPrintertype:=3;
        printer.PrinterIndex:=i;
//        getmem(pdevice,cchdevicename);
//        getmem(pdriver,144);
//        getmem(pport,144);
//        //获取打印机信息，并显示在标签上
//        printer.GetPrinter(pdevice,pdriver,pport,hdmode);
//        //将打印内容输出到文件中
//        printer.SetPrinter(pdevice,pdriver, pport,hdmode);
        //freemem(pdevice,cchdevicename);
        //freemem(pdriver,144);
        //freemem(pport,144);

      end;
    end;
  end;
  for tmpdyzs:=1 to TickNum do
  begin
       tick_str_len := 0 ;
       xx_start := 1 ;
       tmpPrintinfo:=tick_print_info.ticketstr;
       tmpprintinfo:=AnsiReplaceText(tmpprintinfo,#13#10, '*');
  //     showmessage(tmpprintinfo);
       xx := pos('*',tmpPrintinfo);
       //'将以*分割开的句子分别放入TEMP_TEXT(I)中
       While xx > 0 do
       begin
          temp_text[tick_str_len]:= copy(tmpprintinfo,1,xx-1);
          tmpprintinfo:=copy(tmpprintinfo,xx+1,255);
          xx:=pos('*',tmpprintinfo);
          tick_str_len := tick_str_len + 1;
       end;
       //'将最近一条放入TEMP_TEXT中
       If length(tmpprintinfo)>0  Then
       begin
          temp_text[tick_str_len] := tmpprintinfo ;
          tick_str_len:=tick_str_len+1;
       end
       Else
          tick_str_len := tick_str_len - 1;
       need_print := True;
     //  'Printer.ScaleLeft = 2
       printer.BeginDoc;
       if tmpPrintertype=4 then
          printer.Canvas.Font.Size:=25
       else
          printer.Canvas.Font.Size:=10;
       printer.Canvas.Font.Name:='黑体';
       x:=10;
       y:=20;
       For i:= 0 To tick_str_len-1 do
       begin
           xx := pos('/', temp_text[i]);
           While xx > 0 do
           begin
              cmdChar:=copy(temp_text[i],xx+1,1);
              if cmdchar='O' then
              begin
                 if FileExists(picpath) then
                 begin
                    mypic:=tpicture.create;
                    mypic.LoadFromFile(picpath);
                    strect.Left:=x;
                    strect.Top:=y;
                    strect.Right:=mypic.width+10;//x+1000;
                    strect.Bottom:=y+mypic.Height;//y+100*2;
                    y:=y+mypic.Height;//y+100*2;
                    printer.Canvas.StretchDraw(strect,mypic.graphic);
                 end;
                 need_print:=false ;
                 break;
              end
              else if cmdchar='Q' then    //大的排队号码.
              begin
                oldfontsize:=printer.Canvas.Font.Size;
                if tmpPrintertype=4 then
                   printer.Canvas.Font.Size:=60
                else
                   printer.Canvas.Font.Size:=40;
                Printer.Canvas.Font.Style :=[fsbold];//	 old_fontsize * 2.5
                temp_text[i] :=copy(temp_text[i],1,xx-1) + tick_print_info.TQno+copy(temp_text[i],xx+2,255);

                printer.Canvas.TextOut(x,y,temp_text[i]);
                y:=y+printer.Canvas.TextHeight('A')*1+2;
                Printer.Canvas.Font.size :=oldfontsize;
                Printer.Canvas.Font.Style :=[];

                need_print := False;
                break;
              end
              else if cmdchar='A' then    //条形码
              begin
                oldfontsize:=printer.Canvas.Font.Size;
                oldfontName:=printer.Canvas.Font.name;
                if tmpPrintertype=4 then
                   printer.Canvas.Font.Size:=35
                else
                   printer.Canvas.Font.Size:=29;
                printer.Canvas.Font.Name:='C39HrP60DlTt';
                Printer.Canvas.Font.Style :=[];
                temp_text[i] :=copy(temp_text[i],1,xx-1) + '*' +tick_print_info.TBarCode+'*' +copy(temp_text[i],xx+2,255);

                printer.Canvas.TextOut(x,y,temp_text[i]);
                y:=y+printer.Canvas.TextHeight('A')*1+2;
                Printer.Canvas.Font.size :=oldfontsize;
                Printer.Canvas.Font.Name  :=oldfontName;
                Printer.Canvas.Font.Style :=[];

                need_print := False;
                break;
              end
              else if cmdchar='S' then //小的排队号码
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TQno + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='G' then                   //科室名称
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TGroupName + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='B' then                    //按键名称.
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TButtonName + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='H' then                               //字体高*3
              begin
                if tmpPrintertype=4 then
                   printer.Canvas.Font.Size:=40
                else
                   printer.Canvas.Font.Size:=25;
                temp_text[i] :=copy(temp_text[i],1,xx-1)+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='D' then
              begin
                if tmpPrintertype=4 then
                   printer.Canvas.Font.Size:=30
                else
                   printer.Canvas.Font.Size:=15;
                temp_text[i] :=copy(temp_text[i],1,xx-1)+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='I' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1)+ copy(temp_text[i],xx+2,255);
                printer.Canvas.Font.Style:=[];
              end
              else if cmdchar='M' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1)+ copy(temp_text[i],xx+2,255);
                printer.Canvas.Font.Style:=[fsBold];
              end
              else if cmdchar='N' then
              begin
                if tmpPrintertype=4 then
                   printer.Canvas.Font.Size:=25
                else
                   printer.Canvas.Font.Size:=10;
                temp_text[i] :=copy(temp_text[i],1,xx-1)+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='C' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +cdatetostr(date) + ' ' + ctimetostr(time)  + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='L' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TAVGWaitTime + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='W' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TWaitNum + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='Z' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='E' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='K' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='J' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='F' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TJch+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='P' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TCustName+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='T' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TCustNo+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='R' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TRoomNo+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='V' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TYSCode + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='Y' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TYSName+ copy(temp_text[i],xx+2,255);
              end
            else if cmdchar='U' then//操作员代码
            begin
              temp_text[i] :=copy(temp_text[i],1,xx-1)+ tick_print_info.TYHCode +copy(temp_text[i],xx+2,255);
              //printer.Canvas.Font.Style:=fsbold;
            end
            else if cmdchar='X' then//操作员姓名
            begin
              temp_text[i] :=copy(temp_text[i],1,xx-1)+ tick_print_info.TYHName +copy(temp_text[i],xx+2,255);
              //printer.Canvas.Font.Style:=fsbold;
            end
              else
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +copy(temp_text[i],xx+2,255);
              end;
              xx := pos('/', temp_text[i]);
              need_print:=true;
           end;
           if need_print=true then
           begin
              printer.Canvas.TextOut(x,y,temp_text[i]);
  //            y:=y+(printer.Canvas.Font.Size div 10)*100;
              y:=y+printer.Canvas.TextHeight('A')*1+2;
             //y:=y+printer.Canvas.Font.Size+1;
           end;
       end;
       printer.EndDoc;
       sleep(200);
  end;
     result:=true;
except
  msgbox('票单打印错误，请检查打印机连接是否正常       ','提示信息',mb_OK);
  result:=false;
  exit;
end;
end;


function Tdmdbaccess.PrintTickCom(const TickNum:integer):Boolean;
{    //使用串口命令打印票单
    // TickNum 为张数
    2005-02-24
    通过串口发送打印命令打印票单                           }
var
   temp_text:array[0..31] of string;
   need_print:boolean;
   tick_str_len:integer;
   xx_start:integer;
   xx:integer;
   tmpPrintinfo:string;
   i:integer;
   x:integer;  //打印位置
   y:integer;
   strect:TreCt;
   cmdChar:string;
   oldfontsize:integer; ///11--原始大小，22--放大一倍，33--放大两倍
   fontsize:integer;   //同上；
   mypic:Tpicture;
   tmpdyzs:integer;
   tmpSendbyte:array[0..40] of byte;
   tmpsendlen:integer;
   tmpByeAry:Array of byte;
   ii:integer;
   sleeptimes:integer;
begin
  try
  for tmpdyzs:=1 to TickNum do
  begin
       sleeptimes:=50;
       fontsize:=11;

       tick_str_len := 0 ;
       xx_start := 1 ;
       tmpPrintinfo:=tick_print_info.ticketstr;
       tmpprintinfo:=AnsiReplaceText(tmpprintinfo,#13#10, '*');
  //     showmessage(tmpprintinfo);
       xx := pos('*',tmpPrintinfo);
       //'将以*分割开的句子分别放入TEMP_TEXT(I)中
       While xx > 0 do
       begin
          temp_text[tick_str_len]:= copy(tmpprintinfo,1,xx-1);
          tmpprintinfo:=copy(tmpprintinfo,xx+1,255);
          xx:=pos('*',tmpprintinfo);
          tick_str_len := tick_str_len + 1;
       end;
       //'将最近一条放入TEMP_TEXT中
       If length(tmpprintinfo)>0  Then
       begin
          temp_text[tick_str_len] := tmpprintinfo ;
          tick_str_len:=tick_str_len+1;
       end
       Else
          tick_str_len := tick_str_len - 1;
       need_print := True;
     //  'Printer.ScaleLeft = 2
{       tmpsendbyte[0]:=$1B;
       tmpsendbyte[1]:=$31;
       tmpsendbyte[2]:=$08;
       //tmpsendbyte[3]:=$0A;
       tmpsendlen:=3;
       if not frmmain.Comm1.WriteCommData(@tmpsendbyte[0],tmpsendlen) then
       begin
         sleep(1);
       end;
       sleep(sleeptimes);   }
       For i:= 0 To tick_str_len-1 do
       begin
           xx := pos('/', temp_text[i]);
           While xx > 0 do
           begin
              cmdChar:=copy(temp_text[i],xx+1,1);
              if cmdchar='O' then
              begin
                 if FileExists(picpath) then
                 begin
                    /////////打印图标
                    mypic:=tpicture.create;
                    mypic.LoadFromFile(picpath);
                    /////////////////////////
                 end;
                 need_print:=false ;
                 break;
              end
              else if cmdchar='Q' then    //大的排队号码.
              begin
                oldfontsize:=fontsize;
                fontsize:=33;
                if oldfontsize<>fontsize then
                begin
                   //改变字体
                   tmpsendbyte[0]:=$1B;
                   tmpsendbyte[1]:=$57;
                   tmpsendbyte[2]:=$22;
                   //tmpsendbyte[3]:=$0A;
                   tmpsendlen:=3;
                   if not frmmain.Comm1.WriteCommData(@tmpsendbyte[0],tmpsendlen) then
                   begin
                     sleep(1);
                   end;
                   sleep(sleeptimes);
                end;
                temp_text[i] :=copy(temp_text[i],1,xx-1) + tick_print_info.TQno+copy(temp_text[i],xx+2,255);
                //打印内容；
                //////////发送文本信息
                   //加入文字
               tmpsendlen:=Length(temp_text[i]);
               Setlength(tmpByeAry,tmpsendlen+1);
               CopyMemory(tmpByeAry,Pchar(temp_text[i]),tmpsendlen);//String To Byte
               //tmpbyeary[tmpsendlen]:=$0D;
               tmpbyeary[tmpsendlen]:=$0A;
               if not frmmain.Comm1.WriteCommData(@tmpbyeary[0],tmpsendlen+1) then
               begin
                 sleep(1);
               end;
               sleep(sleeptimes);
               //还原字体
                if oldfontsize<>fontsize then
                begin
                   fontsize:=oldfontsize;
                   //改变字体
                   tmpsendbyte[0]:=$1B;
                   tmpsendbyte[1]:=$57;
                   if fontsize=11 then
                      tmpsendbyte[2]:=$11
                   else if fontsize=22 then
                      tmpsendbyte[2]:=$22
                   else
                      tmpsendbyte[2]:=$33;
                   //tmpsendbyte[3]:=$0A;
                   tmpsendlen:=3;
                   if not frmmain.Comm1.WriteCommData(@tmpsendbyte[0],tmpsendlen) then
                   begin
                     sleep(1);
                   end;
                  sleep(sleeptimes);
                end;

                need_print := False;
                break;
              end
              else if cmdchar='S' then //小的排队号码
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TQno + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='G' then                   //科室名称
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TGroupName + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='B' then                    //按键名称.
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TButtonName + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='H' then                               //字体高*3
              begin
                fontsize:=33;
                temp_text[i] :=copy(temp_text[i],1,xx-1)+ copy(temp_text[i],xx+2,255);
                //改变字体
                tmpsendbyte[0]:=$1B;
                tmpsendbyte[1]:=$57;
                tmpsendbyte[2]:=$33;
                //tmpsendbyte[3]:=$0A;
                tmpsendlen:=3;
                if not frmmain.Comm1.WriteCommData(@tmpsendbyte[0],tmpsendlen) then
                begin
                  sleep(1);
                end;
                sleep(sleeptimes);
              end
              else if cmdchar='D' then
              begin
                fontsize:=22;
                //改变字体
                tmpsendbyte[0]:=$1B;
                tmpsendbyte[1]:=$57;
                tmpsendbyte[2]:=$22;
                //tmpsendbyte[3]:=$0A;
                tmpsendlen:=3;
                if not frmmain.Comm1.WriteCommData(@tmpsendbyte[0],tmpsendlen) then
                begin
                  sleep(1);
                end;
                sleep(sleeptimes);
                temp_text[i] :=copy(temp_text[i],1,xx-1)+ copy(temp_text[i],xx+2,255);

               end
              else if cmdchar='I' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1)+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='M' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1)+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='N' then
              begin
                fontsize:=11;
                                //改变字体
                tmpsendbyte[0]:=$1B;
                tmpsendbyte[1]:=$57;
                tmpsendbyte[2]:=$11;
                //tmpsendbyte[3]:=$0A;
                tmpsendlen:=3;
                if not frmmain.Comm1.WriteCommData(@tmpsendbyte[0],tmpsendlen) then
                begin
                  sleep(1);
                end;
                sleep(sleeptimes);
                temp_text[i] :=copy(temp_text[i],1,xx-1)+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='C' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +cdatetostr(date) + ' ' + ctimetostr(time)  + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='L' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TAVGWaitTime + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='W' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TWaitNum + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='Z' then
              begin
                tmpsendbyte[0]:=$1B;
                tmpsendbyte[1]:=$4A;
                tmpsendbyte[2]:=$08;
                tmpsendlen:=3;
                if not frmmain.Comm1.WriteCommData(@tmpsendbyte[0],tmpsendlen) then
                begin
                  sleep(1);
                end;
                sleep(sleeptimes);
                tmpsendbyte[0]:=$1B;
                tmpsendbyte[1]:=$69;
                //tmpsendbyte[2]:=$0A;
                tmpsendlen:=2;
                if not frmmain.Comm1.WriteCommData(@tmpsendbyte[0],tmpsendlen) then
                begin
                  sleep(1);
                end;
                sleep(sleeptimes);
                temp_text[i] :=copy(temp_text[i],1,xx-1) + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='E' then
              begin
                //切纸
                tmpsendbyte[0]:=$1B;
                tmpsendbyte[1]:=$69;
                //tmpsendbyte[2]:=$0A;
                tmpsendlen:=2;
                if not frmmain.Comm1.WriteCommData(@tmpsendbyte[0],tmpsendlen) then
                begin
                  sleep(1);
                end;
                sleep(sleeptimes);
                temp_text[i] :=copy(temp_text[i],1,xx-1) + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='K' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='J' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) + copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='F' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TJch+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='P' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TCustName+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='T' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TCustNo+ copy(temp_text[i],xx+2,255);
              end
              else if cmdchar='R' then
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +tick_print_info.TRoomNo+ copy(temp_text[i],xx+2,255);
              end
              else
              begin
                temp_text[i] :=copy(temp_text[i],1,xx-1) +copy(temp_text[i],xx+2,255);
              end;
              xx := pos('/', temp_text[i]);
              need_print:=true;
           end;
           if i= tick_str_len-1 then
           begin
              if length(temp_text[i])=0 then
                 need_print:=false;
           end;
           if need_print=true then
           begin
              //打印 temp_text[i])
               tmpsendlen:=Length(temp_text[i]);
               Setlength(tmpByeAry,tmpsendlen+1);
               CopyMemory(tmpByeAry,Pchar(temp_text[i]),tmpsendlen);//String To Byte
               //tmpbyeary[tmpsendlen]:=$0D;
               tmpbyeary[tmpsendlen]:=$0A;
               //for ii:=0 to tmpsendlen+1 do
               begin
                 if not frmmain.Comm1.WriteCommData(@tmpbyeary[0],tmpsendlen+1) then
                 begin
                   sleep(1);
                 end;
               end;
                sleep(sleeptimes);
           end;
       end;

       sleep(200);
  end;
     result:=true;
except
  msgbox('票单打印错误，请检查打印机连接是否正常       ','提示信息',mb_OK);
  result:=false;
  exit;
end;
end;

   //取号
function Tdmdbaccess.QuHao(const newKSID:string;const newKSMC:string;
    const newBRDM:string; const newBRXM:string;const newYHID:string;
    const newButtonName:string;const newby7:string;
    const newby3:string;const newysxm:string;
    const newby4:string;const newghhm:string;const newyksdm:string):Boolean;
var
  cmdStr:wideString; //SQL字符串;
  ksid:string; //科室ID
  ksmc:string; //科室名称;
  brxm:string; //病人姓名
  brdm:string;  //病人代码;
  ghhm:string;  //挂号号码;
  hmqz:string;  //号码前缀。
  ghsj:tdatetime;//挂号时间
  ztbz:string;   //状态标志
  yhid:string;   //医生工号
  yhxm:string;
  jzbz:string;   //读取标志.
  by1:integer;   //
  by2:integer;
  by3:string;
  by4:string;
  by6:string;
  by7:string;
  sjdbz:integer;   //时间段标志
  ddrs:integer;    //等待人数
  isExsit:boolean;
  i:integer;
    args:integer;
  tmpstr:string;
  qr:TADOQuery;
  lc,priorityid:string;
  dyzs:integer;
  yksdm:string;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
       ksid:=newksid;//fields.Fields[1].AsString;
       brxm:=newbrxm;//fields.Fields[2].AsString;
       brdm:=newbrdm;//fields.Fields[3].asstring;
       //从T_KS的DQHM中取得GHHM


       //             ghhm:=fields.fields[4].asstring;

       qr.Close;
       if newghhm='' then
       begin
       qr.SQL.Text:=' select DQHM,ZDHM,QSHM,HMQZ from  ' +
                ' t_KS ' +
                ' where ksid=''' + newksid +''''+
                ' and hszh=' + inttostr(gblhszh);
       qr.Open;
       with qr do
       begin
          if not qr.Eof then
          begin
             ghhm:=fields.Fields[0].AsString;
             if isint(ghhm) then
             begin
                ghhm:=inttostr(strtoint(ghhm));
                if ((strtoint(ghhm))> fields.Fields[1].AsInteger) then//大于最大号码
                begin
                  if 1=1 then
                  begin
                   result:=false;
                   close;
                   exit;
                  end
                  else
                  begin
                   ghhm:=inttostr(fields.Fields[2].AsInteger);
                  end;
                end;
             end
             else
                ghhm:=inttostr(fields.Fields[2].AsInteger);
                ///修改当前科室的DQHM;
             cmdstr:=' UPDATE t_ks SET DQHM=''' + inttostr(strtoint(ghhm)+1) +''''+
              ' where ksid=''' +newksid +''''+
              ' and hszh=' + inttostr(gblhszh);
             adoconnection.execute(cmdstr,cmdtext);
             if fields.Fields[3].AsString <>'' then
                hmqz:=trim(fields.Fields[3].AsString)
             else
                hmqz:='';
             //   ghhm:=trim(fields.Fields[3].AsString)+ghhm ;
          end
          else
          begin
             result:=false;
             close;
             exit;
          end;
          close;
       end;
    end
    else
    begin
      ghhm := newghhm;
    end;
       //从按钮中取到流程
       qr.Close;
       qr.SQL.Clear;
       qr.Parameters.Clear;
       qr.SQL.Text:=' select lc,priorityid from  ' +
                ' t_qhajsz ' +
                ' where ksid=:p1'+//'' + newksid +''''+
                ' and hszh=:p2';// + inttostr(gblhszh);
       qr.Parameters.ParamByName('p1').Value :=newksid;
       qr.Parameters.ParamByName('p2').Value :=gblhszh;
       qr.Open;
       lc:='0';
       priorityid :='0';
       if not qr.Eof then
       begin
         lc := qr.fieldbyname('lc').AsString;
         priorityid := qr.fieldbyname('priorityid').AsString;
       end;
       qr.close;
       qr.SQL.Clear;
       qr.Parameters.Clear;
       ghsj:=now;//fields.Fields[5].AsDateTime;
       if gblrunappmode=0 then
       begin
         ztbz:='3';//fields.Fields[6].AsString;  //本护士站取号
       end
       else  //如果是浏览模式。
       begin
         ztbz:='4';
       end;
       yhid:=newyhid;//fields.Fields[7].AsString;
       if (priorityid<>'0') and (priorityid<>'') then
       begin
         by1 := strtoint(priorityid);
       end
       else
         by1:=0;//fields.Fields[8].AsInteger;

       by2:=0;//fields.Fields[9].AsInteger;
       by3:=newby3;//fields.Fields[10].AsString;
       by4:='';//fields.Fields[11].AsString;
      {条形码by4=年月日+科室代码+排队号码}
      by4:='';
      args:=monthof(now);
      FmtStr(tmpstr,'%.2d',[args]);
      by4:=by4+tmpstr;
      args:=dayof(now);
      FmtStr(tmpstr,'%.2d',[args]);
      by4:=by4+tmpstr;

      tmpstr:=ksid;
{            args:=strtoint(ksid);
      FmtStr(tmpstr,'%.4d',[args]);}
      by4:=by4+tmpstr;
      if newghhm='' then
      begin
        args:=strtoint(ghhm);
        FmtStr(tmpstr,'%.4d',[args]);
        by4:=by4+tmpstr;
        ghhm:=hmqz+ghhm;
      end
      else
      begin
        tmpstr:= ghhm;
        by4:=by4+tmpstr;
      end;
      if newby4<>'' then
      begin
        by4 := newby4;
      end;
      by6 := newButtonName;
      by7 := newBy7;
      yksdm := newyksdm;
       if length(by7)>0 then
       begin
         by1:=88;
       end;
       if by1=0 then
       begin
         if yksdm<>'' then
         begin
           by1:=99;
         end;
       end;       
       jzbz:='1';//fields.Fields[12].AsString;
       sjdbz:=gblsjdbz;//fields.Fields[13].AsInteger;
       ksmc:=newksmc;//fields.Fields[14].AsString;
       cmdstr:=' select kssxid from t_dhxx ' +
              ' where ksid=''' +newksid +''''+
              ' and jzbz<>''0'' ' +
              ' and hszh=' + inttostr(gblhszh);

       ddrs:=adoconnection.execute(cmdstr,cmdtext).RecordCount+1;
          //加入到DHXX表中
          cmdstr:='Insert into t_ghxx'  +
                  '(' +
                  ' KSID,' +
                  ' brxm,' +
                  ' brdm,' +
                  ' ghhm,'+
                  ' ghsj,' +
                  ' jzbz,' +
                  ' YHID,' +
                  ' sjdbz,' +
                  ' ztbz,' +
                  ' by1,' +
                  ' by2,' +
                  ' by3,' +
                  ' by4,' +
                  ' by6,'+
                  ' by7,lc,'+
                  ' hszh,yksdm) ' +
                  ' values '+
                  ' (' +
                  ''''+ ksid + ''''+
                  ' ,'''+ brxm + ''''+
                  ' ,'''+ brdm + ''''+
                  ' ,''' + ghhm + ''''+
                  ' ,getdate()'+//''' + cdatetostr(ghsj) + ' ' + ctimetostr(ghsj) + ''''+
                  ' ,''1''' +
                  ' ,''' + yhid +''''+
                  ' ,'+ inttostr(sjdbz) +
                  ' ,''' + ztbz + ''''+
                  ' ,' + inttostr(by1) +
                  ' ,' + inttostr(by2) +
                  ' ,'''+ by3 + ''''+
                  ' ,'''+ by4 + ''''+
                  ' ,'+quotedstr(by6)+
                  ' ,'+quotedstr(by7)+ ','+lc+
                  ' ,' +inttostr(gblhszh) +
                  ','+quotedstr(yksdm)+
                  ' )' ;
          adoconnection.execute(cmdstr,cmdtext);
      result:=true;
      if gblrunappmode=1 then  //如果运行的是浏览模式、、
      begin
        //打印票单。
            if gblDYPD=1 then//此参数确定要不要票单。
            begin
               //查找打印票单信息;
               adodataset1.Close;
               adodataset1.Commandtext:=' select  t_qhajsz.pdid,t_pdwb.pdwb,t_qhajsz.dyzs from  ' +
                  ' t_qhajsz left outer join t_pdwb on ' +
                  ' t_qhajsz.pdid = t_pdwb.pdid and t_qhajsz.hszh =t_pdwb.hszh ' +
                  ' where t_qhajsz.ksid=''' + ksid + ''''+
                  ' and t_qhajsz.hszh=' + inttostr(gblhszh);
              adodataset1.Open;
              with adodataset1 do
              begin
                  if  not adodataset1.Eof then
                  begin
                     tick_print_info.TicketStr:=fields.Fields[1].AsString;
                     tick_print_info.TQno:=ghhm;
                     tick_print_info.TRoomNo:='1';
                     tick_print_info.TGroupCode:='';
                     tick_print_info.TGroupNo:=ksid;
                     tick_print_info.TGroupName:=ksmc;
                     tick_print_info.TCustName:=brxm;
                     tick_print_info.TCustNO:=brdm;
                     tick_print_info.TButtonName:='';
                     tick_print_info.TAVGWaitTime:='0';
                     tick_print_info.TWaitNum:=inttostr(ddrs);
                     tick_print_info.TJch:=by3;
                     tick_print_info.TBarCode:=by4;
                     tick_print_info.TYHCode :=currentuser.UserID ;
                     tick_print_info.TYHName :=currentuser.UserName;
                     tick_print_info.TYSCode :=yhid;
                     tick_print_info.TYSName :=yhxm;
                     dyzs:= fields.Fields[2].Asinteger;
                     ///打印票单;
                     dmdbaccess.PrintTick(dyzs);
                     sleep(200);
                  end;
                  close;
              end;
              //////
            end
            else if gbldypd=2 then
            begin
                ///////////////////////
               ///使用串口发送代码打印。
               ///////////////////////
               //查找打印票单信息;
               adodataset1.Close;
               adodataset1.Commandtext:=' select  t_qhajsz.pdid,t_pdwb.pdwb,t_qhajsz.dyzs from  ' +
                  ' t_qhajsz left outer join t_pdwb on ' +
                  ' t_qhajsz.pdid = t_pdwb.pdid and t_qhajsz.hszh =t_pdwb.hszh ' +
                  ' where t_qhajsz.ksid=''' + ksid + ''''+
                  ' and t_qhajsz.hszh=' + inttostr(gblhszh);
              adodataset1.Open;
              with adodataset1 do
              begin
                  if  not adodataset1.Eof then
                  begin
                     tick_print_info.TicketStr:=fields.Fields[1].AsString;
                     tick_print_info.TQno:=ghhm;
                     tick_print_info.TRoomNo:='1';
                     tick_print_info.TGroupCode:='';
                     tick_print_info.TGroupNo:=ksid;
                     tick_print_info.TGroupName:=ksmc;
                     tick_print_info.TCustName:=brxm;
                     tick_print_info.TCustNO:=brdm;
                     tick_print_info.TButtonName:='';
                     tick_print_info.TAVGWaitTime:='0';
                     tick_print_info.TWaitNum:=inttostr(ddrs);
                     tick_print_info.TJch:=by3;
                     tick_print_info.TBarCode:=by4;
                     tick_print_info.TYHCode :=currentuser.UserID ;
                     tick_print_info.TYHName :=currentuser.UserName;
                     tick_print_info.TYSCode :=yhid;
                     tick_print_info.TYSName :=yhxm;
                     dyzs:= fields.Fields[2].Asinteger;

                     ///打印票单;
                     dmdbaccess.PrintTickcom(dyzs);
                     sleep(200);
                  end;
                  close;
              end;
              //////
            end;
      end;
    except
      begin
        result := False;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;


   //取号2，分时间段
function Tdmdbaccess.QuHao2(const newKSID:string;const newKSMC:string;
    const newBRDM:string; const newBRXM:string;const newYHID:string;
    const newButtonName:string;const newby7:string;
    const newby3:string;const newysxm:string;
    const newby4:string;const newghhm:string;const newyksdm:string):Boolean;
var
  cmdStr:wideString; //SQL字符串;
  ksid:string; //科室ID
  ksmc:string; //科室名称;
  brxm:string; //病人姓名
  brdm:string;  //病人代码;
  ghhm:string;  //挂号号码;
  hmqz:string;  //号码前缀。
  ghsj:tdatetime;//挂号时间
  ztbz:string;   //状态标志
  yhid:string;   //医生工号
  yhxm:string;
  jzbz:string;   //读取标志.
  by1:integer;   //
  by2:integer;
  by3:string;
  by4:string;
  by6:string;
  by7:string;
  sjdbz:integer;   //时间段标志
  ddrs:integer;    //等待人数
  isExsit:boolean;
  i:integer;
    args:integer;
  tmpstr:string;
  qr,qr1:TADOQuery;
  lc,priorityid:string;
  dyzs:integer;
  yksdm:string;
begin
  qr:=TADOQuery.Create(nil);
  qr1 := Tadoquery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr1.Connection := ADOConnection;
    try
       ksid:=newksid;//fields.Fields[1].AsString;
       brxm:=newbrxm;//fields.Fields[2].AsString;
       brdm:=newbrdm;//fields.Fields[3].asstring;
       //从T_KS的DQHM中取得GHHM


       //             ghhm:=fields.fields[4].asstring;

       qr.Close;
       if newghhm='' then
       begin
       qr.SQL.Text:=' select DQHM,ZDHM,QSHM,HMQZ from  ' +
                ' t_KS ' +
                ' where ksid=''' + newksid +''''+
                ' and hszh=' + inttostr(gblhszh);
       qr.Open;
       with qr do
       begin
          if not qr.Eof then
          begin
            //找到此时间段的病人数//newby7
            qr1.SQL.Text :=' select count(*) as cnt from t_ghxx where jzbz=1 and ksid='+quotedstr(newksid)+
               ' and by7='+quotedstr(newby7);
            qr1.Open;
            ddrs:= qr1.fieldbyname('cnt').AsInteger+1;
            qr1.Close;
            //组合号码 时间段+人数+1  ，如 0801
            args := ddrs;
            FmtStr(tmpstr,'%.2d',[args]);
            ghhm := copy(newby7,1,2)+tmpstr;
            //加上前缀//
             if fields.Fields[3].AsString <>'' then
                hmqz:=trim(fields.Fields[3].AsString)
             else
                hmqz:='';
             ghhm:=hmqz+ghhm ;
          end
          else
          begin
             result:=false;
             close;
             exit;
          end;
          close;
       end;
    end
    else
    begin
      ghhm := newghhm;
    end;
       //从按钮中取到流程
       qr.Close;
       qr.SQL.Clear;
       qr.Parameters.Clear;
       qr.SQL.Text:=' select lc,priorityid from  ' +
                ' t_qhajsz ' +
                ' where ksid=:p1'+//'' + newksid +''''+
                ' and hszh=:p2';// + inttostr(gblhszh);
       qr.Parameters.ParamByName('p1').Value :=newksid;
       qr.Parameters.ParamByName('p2').Value :=gblhszh;
       qr.Open;
       lc:='0';
       priorityid :='0';
       if not qr.Eof then
       begin
         lc := qr.fieldbyname('lc').AsString;
         priorityid := qr.fieldbyname('priorityid').AsString;
       end;
       qr.close;
       qr.SQL.Clear;
       qr.Parameters.Clear;
       ghsj:=now;//fields.Fields[5].AsDateTime;
       if gblrunappmode=0 then
       begin
         ztbz:='3';//fields.Fields[6].AsString;  //本护士站取号
       end
       else  //如果是浏览模式。
       begin
         ztbz:='4';
       end;
       yhid:=newyhid;//fields.Fields[7].AsString;
       if (priorityid<>'0') and (priorityid<>'') then
       begin
         by1 := strtoint(priorityid);
       end
       else
         by1:=0;//fields.Fields[8].AsInteger;

       by2:=0;//fields.Fields[9].AsInteger;
       by3:=newby3;//fields.Fields[10].AsString;
       by4:='';//fields.Fields[11].AsString;
      {条形码by4=年月日+科室代码+排队号码}
      by4:=newby4;
//      args:=monthof(now);
//      FmtStr(tmpstr,'%.2d',[args]);
//      by4:=by4+tmpstr;
//      args:=dayof(now);
//      FmtStr(tmpstr,'%.2d',[args]);
//      by4:=by4+tmpstr;
//
//      tmpstr:=ksid;
//{            args:=strtoint(ksid);
//      FmtStr(tmpstr,'%.4d',[args]);}
//      by4:=by4+tmpstr;
//      if newghhm='' then
//      begin
//        args:=strtoint(ghhm);
//        FmtStr(tmpstr,'%.4d',[args]);
//        by4:=by4+tmpstr;
//        ghhm:=hmqz+ghhm;
//      end
//      else
//      begin
//        tmpstr:= ghhm;
//        by4:=by4+tmpstr;
//      end;
//      if newby4<>'' then
//      begin
//        by4 := newby4;
//      end;
      by6 := newButtonName;
      by7 := newBy7;
      yksdm := newyksdm;
//       if length(by7)>0 then
//       begin
//         by1:=88;
//       end;
//       if by1=0 then
//       begin
//         if yksdm<>'' then
//         begin
//           by1:=99;
//         end;
//       end;       
       jzbz:='1';//fields.Fields[12].AsString;
       sjdbz:=gblsjdbz;//fields.Fields[13].AsInteger;
       ksmc:=newksmc;//fields.Fields[14].AsString;
       cmdstr:=' select kssxid from t_dhxx ' +
              ' where ksid=''' +newksid +''''+
              ' and jzbz<>''0'' ' +
              ' and hszh=' + inttostr(gblhszh);

       ddrs:=adoconnection.execute(cmdstr,cmdtext).RecordCount+1;
          //加入到DHXX表中
          cmdstr:='Insert into t_ghxx'  +
                  '(' +
                  ' KSID,' +
                  ' brxm,' +
                  ' brdm,' +
                  ' ghhm,'+
                  ' ghsj,' +
                  ' jzbz,' +
                  ' YHID,' +
                  ' sjdbz,' +
                  ' ztbz,' +
                  ' by1,' +
                  ' by2,' +
                  ' by3,' +
                  ' by4,' +
                  ' by6,'+
                  ' by7,lc,'+
                  ' hszh,yksdm) ' +
                  ' values '+
                  ' (' +
                  ''''+ ksid + ''''+
                  ' ,'''+ brxm + ''''+
                  ' ,'''+ brdm + ''''+
                  ' ,''' + ghhm + ''''+
                  ' ,getdate()'+//''' + cdatetostr(ghsj) + ' ' + ctimetostr(ghsj) + ''''+
                  ' ,''1''' +
                  ' ,''' + yhid +''''+
                  ' ,'+ inttostr(sjdbz) +
                  ' ,''' + ztbz + ''''+
                  ' ,' + inttostr(by1) +
                  ' ,' + inttostr(by2) +
                  ' ,'''+ by3 + ''''+
                  ' ,'''+ by4 + ''''+
                  ' ,'+quotedstr(by6)+
                  ' ,'+quotedstr(by7)+ ','+lc+
                  ' ,' +inttostr(gblhszh) +
                  ','+quotedstr(yksdm)+
                  ' )' ;
          adoconnection.execute(cmdstr,cmdtext);
      result:=true;
      if gblrunappmode=1 then  //如果运行的是浏览模式、、
      begin
        //打印票单。
            if gblDYPD=1 then//此参数确定要不要票单。
            begin
               //查找打印票单信息;
               adodataset1.Close;
               adodataset1.Commandtext:=' select  t_qhajsz.pdid,t_pdwb.pdwb,t_qhajsz.dyzs from  ' +
                  ' t_qhajsz left outer join t_pdwb on ' +
                  ' t_qhajsz.pdid = t_pdwb.pdid and t_qhajsz.hszh =t_pdwb.hszh ' +
                  ' where t_qhajsz.ksid=''' + ksid + ''''+
                  ' and t_qhajsz.hszh=' + inttostr(gblhszh);
              adodataset1.Open;
              with adodataset1 do
              begin
                  if  not adodataset1.Eof then
                  begin
                     tick_print_info.TicketStr:=fields.Fields[1].AsString;
                     tick_print_info.TQno:=ghhm;
                     tick_print_info.TRoomNo:='1';
                     tick_print_info.TGroupCode:='';
                     tick_print_info.TGroupNo:=ksid;
                     tick_print_info.TGroupName:=ksmc;
                     tick_print_info.TCustName:=brxm;
                     tick_print_info.TCustNO:=brdm;
                     tick_print_info.TButtonName:='';
                     tick_print_info.TAVGWaitTime:='0';
                     tick_print_info.TWaitNum:=inttostr(ddrs);
                     tick_print_info.TJch:=by3;
                     tick_print_info.TBarCode:=by4;
                     tick_print_info.TYHCode :=currentuser.UserID ;
                     tick_print_info.TYHName :=currentuser.UserName;
                     tick_print_info.TYSCode :=yhid;
                     tick_print_info.TYSName :=yhxm;
                     dyzs:= fields.Fields[2].Asinteger;
                     ///打印票单;
                     dmdbaccess.PrintTick(dyzs);
                     sleep(200);
                  end;
                  close;
              end;
              //////
            end
            else if gbldypd=2 then
            begin
                ///////////////////////
               ///使用串口发送代码打印。
               ///////////////////////
               //查找打印票单信息;
               adodataset1.Close;
               adodataset1.Commandtext:=' select  t_qhajsz.pdid,t_pdwb.pdwb,t_qhajsz.dyzs from  ' +
                  ' t_qhajsz left outer join t_pdwb on ' +
                  ' t_qhajsz.pdid = t_pdwb.pdid and t_qhajsz.hszh =t_pdwb.hszh ' +
                  ' where t_qhajsz.ksid=''' + ksid + ''''+
                  ' and t_qhajsz.hszh=' + inttostr(gblhszh);
              adodataset1.Open;
              with adodataset1 do
              begin
                  if  not adodataset1.Eof then
                  begin
                     tick_print_info.TicketStr:=fields.Fields[1].AsString;
                     tick_print_info.TQno:=ghhm;
                     tick_print_info.TRoomNo:='1';
                     tick_print_info.TGroupCode:='';
                     tick_print_info.TGroupNo:=ksid;
                     tick_print_info.TGroupName:=ksmc;
                     tick_print_info.TCustName:=brxm;
                     tick_print_info.TCustNO:=brdm;
                     tick_print_info.TButtonName:='';
                     tick_print_info.TAVGWaitTime:='0';
                     tick_print_info.TWaitNum:=inttostr(ddrs);
                     tick_print_info.TJch:=by3;
                     tick_print_info.TBarCode:=by4;
                     tick_print_info.TYHCode :=currentuser.UserID ;
                     tick_print_info.TYHName :=currentuser.UserName;
                     tick_print_info.TYSCode :=yhid;
                     tick_print_info.TYSName :=yhxm;
                     dyzs:= fields.Fields[2].Asinteger;

                     ///打印票单;
                     dmdbaccess.PrintTickcom(dyzs);
                     sleep(200);
                  end;
                  close;
              end;
              //////
            end;
      end;
    except
      begin
        result := False;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
    FreeAndNil(qr1);
  end;
end;

    //清除
function Tdmdbaccess.QingChu(const Kssj :string;const Jssj :string;const QingChuAll:integer;const QCDL :integer;const HMFW :integer ):Boolean;
var
  cmdstr:widestring;
  kssxid:integer;
  i:integer;
  groupnumber_index:integer;
  qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      if QingChuAll=1 then
      begin
         //清除所有记录；
          cmdstr:=' Delete from t_dhxx ' +
               ' where hszh=' + inttostr(gblhszh);
          adoconnection.Execute(cmdstr,cmdtext);
          cmdstr:=' Delete from t_ksJzh ' +
               ' where tohsz=' + inttostr(gblhszh);
          adoconnection.Execute(cmdstr,cmdtext);
          //科室当前号码复位,使下一位取号号码等于开始号码.
          if hmfw=1 then
          begin
            cmdstr:=' UPDATE t_ks ' +
               ' set DQHM=QSHM '+
               ' where hszh=' + inttostr(gblhszh);
            adoconnection.Execute(cmdstr,cmdtext);
          end;
           gbledit_ks_count:=0;
           for groupnumber_index:=0 to groupnumber-1 do
           begin
              gbledit_ks[groupnumber_index].ksid:=groupserial[groupnumber_index].ksid;
              gbledit_ks[groupnumber_index].ksmc:=groupserial[groupnumber_index].ksmc;
              gbledit_ks_count:=gbledit_ks_count+1;
           end;

          result:=true;
      end
      else
      begin
        //清除在时间段KSSJ-JSSJ中的记录。
        cmdstr:=' UPDATE t_dhxx ' +
              ' set ztbz=''3'' ' +
              ' ,jzbz=''0'' ' +
              ' ,kssxid=0 ' +
              ' where hszh=' + inttostr(gblhszh) +
              ' and jzbz<>0'+
              ' and ghsj <'''+ FormatDateTime('yyyy-mm-dd',date) + ' '+ jssj +'''' ;
        adoconnection.Execute(cmdstr,cmdtext);
        //并对科室中的病人重新排序。
        for i:=0 to groupnumber-1 do
        begin
           qr.close;
           qr.SQL.Text:=' select kssxid from  ' +
                    ' t_DHXX ' +
                    ' where ksid=''' + groupserial[i].ksid +''''+
                    ' and hszh=' + inttostr(gblhszh)+
                    ' and jzbz<>0 '+
                    ' order by kssxid';
           qr.Open;
           kssxid:=1;
           with qr do
           begin
              while not qr.Eof do
              begin
                  qr.Edit ;
                  qr.FieldByName('kssxid').AsInteger:=kssxid;
                  qr.Post;
                  kssxid:=kssxid+1;
                  next;
              end;
              close;
           end;
        end;
         gbledit_ks_count:=0;
         for groupnumber_index:=0 to groupnumber-1 do
         begin
            gbledit_ks[groupnumber_index].ksid:=groupserial[groupnumber_index].ksid;
            gbledit_ks[groupnumber_index].ksmc:=groupserial[groupnumber_index].ksmc;
            gbledit_ks_count:=gbledit_ks_count+1;
         end;

      end;
      //清除登录信息
      if qcdl=1 then
      begin
            cmdstr:=' UPDATE t_hjzd ' +
               ' set yhid='''' '+
               ',zt='''''+
               ',state='''''+
               ',calltime=getdate()'+
               ' where hszh=' + inttostr(gblhszh);
            adoconnection.Execute(cmdstr,cmdtext);
      end;
      //号码复位
      if HMFW=1 then    // 当没有上一个时间段的等待中病人时，将号码复位//
      begin
            cmdstr:=' UPDATE t_ks ' +
               ' set dqhm=qshm '+
               ' where hszh=' + inttostr(gblhszh)+
               ' and ksid not in (select distinct ksid from t_dhxx '+
               ' where sjdbz='+inttostr(gblsjdbz)+ ' and hszh='+inttostr(gblhszh)+
               ' and jzbz=1'+
               ')';
            adoconnection.Execute(cmdstr,cmdtext);
      end;
      result:=true;
    except
        begin
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;


    //清除
function Tdmdbaccess.QingChuSJD(asjd:integer;const HMFW :integer ):Boolean;
var
  cmdstr:widestring;
  kssxid:integer;
  i:integer;
  groupnumber_index:integer;
  qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
        //清除在时间段KSSJ-JSSJ中的记录。
        cmdstr:=' UPDATE t_dhxx ' +
              ' set ztbz=''3'' ' +
              ' ,jzbz=''0'' ' +
              ' ,kssxid=0 ' +
              ' where hszh=' + inttostr(gblhszh) +
              ' and jzbz<>0'+
              ' and sjdbz='+inttostr(asjd);
        adoconnection.Execute(cmdstr,cmdtext);
        //并对科室中的病人重新排序。
        for i:=0 to groupnumber-1 do
        begin
           qr.close;
           qr.SQL.Text:=' select kssxid from  ' +
                    ' t_DHXX ' +
                    ' where ksid=''' + groupserial[i].ksid +''''+
                    ' and hszh=' + inttostr(gblhszh)+
                    ' and jzbz<>0 '+
                    ' order by kssxid';
           qr.Open;
           kssxid:=1;
           with qr do
           begin
              while not qr.Eof do
              begin
                  qr.Edit ;
                  qr.FieldByName('kssxid').AsInteger:=kssxid;
                  qr.Post;
                  kssxid:=kssxid+1;
                  next;
              end;
              close;
           end;
        end;
         gbledit_ks_count:=0;
         for groupnumber_index:=0 to groupnumber-1 do
         begin
            gbledit_ks[groupnumber_index].ksid:=groupserial[groupnumber_index].ksid;
            gbledit_ks[groupnumber_index].ksmc:=groupserial[groupnumber_index].ksmc;
            gbledit_ks_count:=gbledit_ks_count+1;
         end;
      //号码复位
      if HMFW=1 then    // 当没有上一个时间段的等待中病人时，将号码复位//
      begin
            cmdstr:=' UPDATE t_ks ' +
               ' set dqhm=qshm '+
               ' where hszh=' + inttostr(gblhszh)+
               ' and ksid not in (select distinct ksid from t_dhxx '+
               ' where sjdbz='+inttostr(gblsjdbz)+ ' and hszh='+inttostr(gblhszh)+
               ' and jzbz=1'+
               ')';
            adoconnection.Execute(cmdstr,cmdtext);
      end;
      result:=true;
    except
        begin
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

    //清号按时间段
function Tdmdbaccess.XiaoHaoSJ(const Kssj :string;const Jssj :string;const AKsid:string):Boolean;
var
  cmdstr:widestring;
  kssxid:integer;
  i:integer;
  groupnumber_index:integer;
  qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      if Aksid='' then
      begin
          //清除在时间段KSSJ-JSSJ中的记录。
          cmdstr:=' UPDATE t_dhxx ' +
                ' set ztbz=''3'' ' +
                ' ,jzbz=''0'' ' +
                ' ,kssxid=0 ' +
                ' where hszh=' + inttostr(gblhszh) +
                ' and ghsj >='''+ cdatetostr(date) + ' '+ kssj +''''+
                ' and ghsj <='''+ cdatetostr(date) + ' '+ jssj +'''' ;
          adoconnection.Execute(cmdstr,cmdtext);
          //并对科室中的病人重新排序。
          for i:=0 to groupnumber-1 do
          begin
             qr.close;
             qr.SQL.Text:=' select kssxid from  ' +
                      ' t_DHXX ' +
                      ' where ksid=''' + groupserial[i].ksid +''''+
                      ' and jzbz<>0 '+
                      ' and hszh=' + inttostr(gblhszh)+
                      ' order by kssxid';
             qr.Open;
             kssxid:=1;
             with qr do
             begin
                while not qr.Eof do
                begin
                    qr.Edit ;
                    qr.FieldByName('kssxid').AsInteger:=kssxid;
                    qr.Post;
                    kssxid:=kssxid+1;
                    next;
                end;
                close;
             end;
          end;
         gbledit_ks_count:=0;
         for groupnumber_index:=0 to groupnumber-1 do
         begin
            gbledit_ks[groupnumber_index].ksid:=groupserial[groupnumber_index].ksid;
            gbledit_ks[groupnumber_index].ksmc:=groupserial[groupnumber_index].ksmc;
            gbledit_ks_count:=gbledit_ks_count+1;
         end;

      end
      else
      begin
          //清除在时间段KSSJ-JSSJ中的记录。
          cmdstr:=' UPDATE t_dhxx ' +
                ' set ztbz=''3'' ' +
                ' ,jzbz=''0'' ' +
                ' ,kssxid=0 ' +
                ' where hszh=' + inttostr(gblhszh) +
                ' and ksid='''+Aksid+''''+
                ' and ghsj >='''+  cdatetostr(date) + ' '+ kssj +'''' +
                ' and ghsj <'''+ cdatetostr(date) + ' '+ jssj +'''' ;
          adoconnection.Execute(cmdstr,cmdtext);
          //并对科室中的病人重新排序。
           qr.close;
           qr.SQL.Text:=' select kssxid from  ' +
                    ' t_DHXX ' +
                    ' where ksid=''' + Aksid +''''+
                    ' and jzbz<>0 '+
                    ' and hszh=' + inttostr(gblhszh)+
                    ' order by kssxid';
           qr.Open;
           kssxid:=1;
           with qr do
           begin
              while not qr.Eof do
              begin
                  qr.Edit ;
                  qr.FieldByName('kssxid').AsInteger:=kssxid;
                  qr.Post;
                  kssxid:=kssxid+1;
                  next;
              end;
              close;
           end;
         gbledit_ks_count:=0;
         gbledit_ks[0].ksid:=Aksid;
         gbledit_ks[0].ksmc:='';
         gbledit_ks_count:=gbledit_ks_count+1;
      end;
      result:=true;
    except
        begin
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
    //清号按挂号号码段
function Tdmdbaccess.XiaoHaoGhhm(const KsGhhm :string;const JSGhhm :string;const AKsid:string):Boolean;
var
  cmdstr:widestring;
  kssxid:integer;
  i:integer;
  groupnumber_index:integer;
  qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      if Aksid='' then
      begin
          //清除在时间段KSSJ-JSSJ中的记录。
          try
            cmdstr:=' UPDATE t_dhxx ' +
                  ' set ztbz=''3'' ' +
                  ' ,jzbz=''0'' ' +
                  ' ,kssxid=0 ' +
                  ' where hszh=' + inttostr(gblhszh) +
                  ' and replicate(''0'',10-len(ghhm))+ghhm >=replicate(''0'',10-len('''+ksghhm+'''))+'''+ ksghhm +''''+
                  ' and replicate(''0'',10-len(ghhm))+ghhm <=replicate(''0'',10-len('''+jsghhm+'''))+'''+ jsghhm +'''';
            adoconnection.Execute(cmdstr,cmdtext);
          except
            cmdstr:=' UPDATE t_dhxx ' +
                  ' set ztbz=''3'' ' +
                  ' ,jzbz=''0'' ' +
                  ' ,kssxid=0 ' +
                  ' where hszh=' + inttostr(gblhszh) +
                  ' and replicate(''0'',10-len(ghhm))+ghhm>=replicate(''0'',10-len('''+ksghhm+'''))'''+ksghhm+''''+
                  ' and replicate(''0'',10-len(ghhm))+ghhm<=replicate(''0'',10-len('''+jsghhm+'''))'''+jsghhm+'''' ;
            adoconnection.Execute(cmdstr,cmdtext);
          end;
          //并对科室中的病人重新排序。
          for i:=0 to groupnumber-1 do
          begin
             qr.close;
             qr.SQL.Text:=' select kssxid from  ' +
                      ' t_DHXX ' +
                      ' where ksid=''' + groupserial[i].ksid +''''+
                      ' and jzbz<>0 '+
                      ' and hszh=' + inttostr(gblhszh)+
                      ' order by kssxid';
             qr.Open;
             kssxid:=1;
             with qr do
             begin
                while not qr.Eof do
                begin
                    qr.Edit ;
                    qr.FieldByName('kssxid').AsInteger:=kssxid;
                    qr.Post;
                    kssxid:=kssxid+1;
                    next;
                end;
                close;
             end;
          end;
         gbledit_ks_count:=0;
         for groupnumber_index:=0 to groupnumber-1 do
         begin
            gbledit_ks[groupnumber_index].ksid:=groupserial[groupnumber_index].ksid;
            gbledit_ks[groupnumber_index].ksmc:=groupserial[groupnumber_index].ksmc;
            gbledit_ks_count:=gbledit_ks_count+1;
         end;

      end
      else
      begin
          //清除在时间段KSSJ-JSSJ中的记录。
          try
            cmdstr:=' UPDATE t_dhxx ' +
                  ' set ztbz=''3'' ' +
                  ' ,jzbz=''0'' ' +
                  ' ,kssxid=0 ' +
                  ' where hszh=' + inttostr(gblhszh) +
                  ' and ksid='''+Aksid+''''+
                  ' and replicate(''0'',10-len(ghhm))+ghhm >=replicate(''0'',10-len('''+ksghhm+'''))+'''+ ksghhm +''''+
                  ' and replicate(''0'',10-len(ghhm))+ghhm <=replicate(''0'',10-len('''+jsghhm+'''))+'''+ jsghhm +'''';
            adoconnection.Execute(cmdstr,cmdtext);
          except
            cmdstr:=' UPDATE t_dhxx ' +
                  ' set ztbz=''3'' ' +
                  ' ,jzbz=''0'' ' +
                  ' ,kssxid=0 ' +
                  ' where hszh=' + inttostr(gblhszh) +
                  ' and ksid='''+Aksid+''''+
                  ' and replicate(''0'',10-len(ghhm))+ghhm >=replicate(''0'',10-len('''+ksghhm+'''))+'''+ ksghhm +''''+
                  ' and replicate(''0'',10-len(ghhm))+ghhm <=replicate(''0'',10-len('''+jsghhm+'''))+'''+ jsghhm +'''';
            adoconnection.Execute(cmdstr,cmdtext);
          end;
          //并对科室中的病人重新排序。
           qr.close;
           qr.SQL.Text:=' select kssxid from  ' +
                    ' t_DHXX ' +
                    ' where ksid=''' + Aksid +''''+
                    ' and jzbz<>0 '+
                    ' and hszh=' + inttostr(gblhszh)+
                    ' order by kssxid';
           qr.Open;
           kssxid:=1;
           with qr do
           begin
              while not qr.Eof do
              begin
                  qr.Edit ;
                  qr.FieldByName('kssxid').AsInteger:=kssxid;
                  qr.Post;
                  kssxid:=kssxid+1;
                  next;
              end;
              close;
           end;
         gbledit_ks_count:=0;
         gbledit_ks[0].ksid:=Aksid;
         gbledit_ks[0].ksmc:='';
         gbledit_ks_count:=gbledit_ks_count+1;
      end;
      result:=true;
    except
        begin
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
//清除上午数据
function Tdmdbaccess.GroupClearMorning(const AKsid:string):Boolean;
var
  cmdstr:widestring;
  kssxid:integer;
  i:integer;
  groupnumber_index:integer;
  qr:TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      if Aksid='' then
      begin
          //清除在时间段KSSJ-JSSJ中的记录。
          cmdstr:=' Delete t_dhxx ' +
                ' where hszh=:p1'+
                ' and sjdbz=1';
          qr.SQL.Text := cmdstr;
          qr.Parameters.ParamByName('p1').Value := gblHSZH;
          qr.ExecSQL;
          //并对科室中的病人重新排序。
          for i:=0 to groupnumber-1 do
          begin
             qr.close;
             qr.SQL.Clear;
             qr.Parameters.Clear;
             qr.SQL.Text:=' select kssxid from  ' +
                      ' t_DHXX ' +
                      ' where ksid=''' + groupserial[i].ksid +''''+
                      ' and jzbz<>0 '+
                      ' and hszh=' + inttostr(gblhszh)+
                      ' order by kssxid';
             qr.Open;
             kssxid:=1;
             with qr do
             begin
                while not qr.Eof do
                begin
                    qr.Edit ;
                    qr.FieldByName('kssxid').AsInteger:=kssxid;
                    qr.Post;
                    kssxid:=kssxid+1;
                    next;
                end;
                close;
             end;
          end;
         gbledit_ks_count:=0;
         for groupnumber_index:=0 to groupnumber-1 do
         begin
            gbledit_ks[groupnumber_index].ksid:=groupserial[groupnumber_index].ksid;
            gbledit_ks[groupnumber_index].ksmc:=groupserial[groupnumber_index].ksmc;
            gbledit_ks_count:=gbledit_ks_count+1;
         end;
      end
      else
      begin
          //清除在时间段KSSJ-JSSJ中的记录。
          cmdstr:=' Delete t_dhxx ' +
                ' where hszh=:p1'+
                ' and ksid=:p2'+
                ' and sjdbz=1';
          qr.SQL.Text := cmdstr;
          qr.Parameters.ParamByName('p1').Value := gblHSZH;
          qr.Parameters.ParamByName('p2').Value := AKsid;
          qr.ExecSQL;
           qr.close;
           qr.SQL.Clear;
           qr.Parameters.Clear;
           qr.SQL.Text:=' select kssxid from  ' +
                    ' t_DHXX ' +
                    ' where ksid=:p2'+
                    ' and jzbz<>0 '+
                    ' and hszh=:p1'+
                    ' order by kssxid';
           qr.Parameters.ParamByName('p1').Value := gblHSZH;
           qr.Parameters.ParamByName('p2').Value := AKsid;
           qr.Open;
           kssxid:=1;
           with qr do
           begin
              while not qr.Eof do
              begin
                  qr.Edit ;
                  qr.FieldByName('kssxid').AsInteger:=kssxid;
                  qr.Post;
                  kssxid:=kssxid+1;
                  next;
              end;
              close;
           end;
          gbledit_ks_count:=0;
          gbledit_ks[0].ksid:=AKsid;
          gbledit_ks[0].ksmc:=dmDBAccess.GetDBValue('KS',AKsid,'KSMC');
          gbledit_ks_count:=gbledit_ks_count+1;
      end;
      result:=true;
    except
        begin
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
    //清号按序号段
function Tdmdbaccess.XiaoHaoXH(const KsXh :integer;const JSxh :integer;const AKsid:string):Boolean;
var
  cmdstr:widestring;
  kssxid:integer;
  i:integer;
  groupnumber_index:integer;
  qr:TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      if Aksid='' then
      begin
          //清除在时间段KSSJ-JSSJ中的记录。
          cmdstr:=' UPDATE t_dhxx ' +
                ' set ztbz=''3'' ' +
                ' ,jzbz=''0'' ' +
                ' ,kssxid=0 ' +
                ' where hszh=' + inttostr(gblhszh) +
                ' and kssxid >='''+ inttostr(ksxh) +''''+
                ' and kssxid<='''+ inttostr(jsxh) +'''' ;
          adoconnection.Execute(cmdstr,cmdtext);
          //并对科室中的病人重新排序。
          for i:=0 to groupnumber-1 do
          begin
             qr.close;
             qr.SQL.Text:=' select kssxid from  ' +
                      ' t_DHXX ' +
                      ' where ksid=''' + groupserial[i].ksid +''''+
                      ' and jzbz=''1'' '+
                      ' and hszh=' + inttostr(gblhszh);
             qr.Open;
             kssxid:=1;
             with qr do
             begin
                while not qr.Eof do
                begin
                    qr.Edit ;
                    qr.FieldByName('kssxid').AsInteger:=kssxid;
                    qr.Post;
                    kssxid:=kssxid+1;
                    next;
                end;
                close;
             end;
          end;
         //gbledit_ks_count:=0;
         for groupnumber_index:=0 to groupnumber-1 do
         begin
            gbledit_ks[groupnumber_index].ksid:=groupserial[groupnumber_index].ksid;
            gbledit_ks[groupnumber_index].ksmc:=groupserial[groupnumber_index].ksmc;
            gbledit_ks_count:=gbledit_ks_count+1;
         end;

      end
      else
      begin
          //清除在时间段KSSJ-JSSJ中的记录。
          cmdstr:=' UPDATE t_dhxx ' +
                ' set ztbz=''3'' ' +
                ' ,jzbz=''0'' ' +
                ' ,kssxid=0 ' +
                ' where hszh=' + inttostr(gblhszh) +
                ' and ksid='''+Aksid+''''+
                ' and kssxid >='''+ inttostr(ksxh) +''''+
                ' and kssxid<='''+ inttostr(jsxh) +'''' ;
          adoconnection.Execute(cmdstr,cmdtext);
          //并对科室中的病人重新排序。
           qr.close;
           qr.SQL.Text:=' select kssxid from  ' +
                    ' t_DHXX ' +
                    ' where ksid=''' + Aksid +''''+
                    ' and jzbz=''1'' '+
                    ' and hszh=' + inttostr(gblhszh);
           qr.Open;
           kssxid:=1;
           with qr do
           begin
              while not qr.Eof do
              begin
                  qr.Edit ;
                  qr.FieldByName('kssxid').AsInteger:=kssxid;
                  qr.Post;
                  kssxid:=kssxid+1;
                  next;
              end;
              close;
           end;
         gbledit_ks_count:=0;
         gbledit_ks[0].ksid:=Aksid;
         gbledit_ks[0].ksmc:='';
         gbledit_ks_count:=gbledit_ks_count+1;
      end;
      result:=true;
    except
        begin
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
function Tdmdbaccess.SetSjdXXlist(var ListView :TTeThemeSListView;const hszh:integer):boolean;
var
   intfieldindex:integer;
   listItem:Tlistitem;
   qr:TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      listview.Columns.Clear;
      listview.Clear;
      qr.Close;
      //查询科室信息.
      qr.SQL.Text:='SELECT sjdbz as 时间段标志,sjdmc as 名称,CONVERT(varchar(10), SJDKSSJ, 8) as 开始时间,CONVERT(varchar(10), SJDJSSJ, 8) as 结束时间 '+
                ' from t_sjdsz ' +
                ' WHERE HSZH =' + inttostr(hszh) ;
      qr.Open;
      for intfieldindex:=0 to qr.Fields.Count-1 do
      begin
         listview.Columns.Add;
         listview.Columns[intfieldindex].Caption:=qr.Fields.Fields[intfieldindex].FieldName;
         listview.Columns[intfieldindex].Width :=(listview.Width-4) div (qr.Fields.Count);//(Length(listview.Columns[intfieldindex].Caption)+1) * ListView.Canvas.TextWidth('A')*2;
      end;
      ///////////将数据放入LISTVIEW中.
      with qr do
      begin
         while not qr.Eof do
         begin
            listItem:=listview.Items.add;
            ListItem.Caption := Fields[0].AsString;
            for intFieldIndex := 1 to Fields.Count-1 do
            begin
               ListItem.SubItems.Add(fields.Fields[intFieldIndex].AsString);
            end;
            Next;
         end;
         Close;
      end;
      result:=true;
    except
        begin
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
//得到终端的房间号及医生姓名。
function Tdmdbaccess.GetZsXm(const ZDId:string):string;
var
   zdyhid:string;
   zdyhmc:string;
   fjh:string;
   zth,ztmc:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr.Close;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          //fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
          begin
               result:=fjh +ttl_zs+' ' + zdyhmc +ttl_yh;
          end
          else
          begin
                result:=fjh +ttl_zs+' ';///没有登录.
          end;
       end
       else
       begin
           result:='';  ///没有此呼叫器
       end;
       close;
    end;
  finally
    FreeAndNil(qr);
  end;
end;


//得权限值。
function Tdmdbaccess.GetOp(const AOp:integer;const AOpName:string;const AopKey:string):boolean;
var
   qr:Tadoquery;
begin
  if (gblRunAppMode=1) and (AopName<>'ActionQh') then
  begin
    Result := False;
    Exit;
  end;
   if aop=1 then
   begin
      result:=true;
      exit;
   end;
   qr:=Tadoquery.Create(nil);
   qr.Connection:=Adoconnection;
   qr.SQL.Text:='select * from t_userop'+
                ' where op='+inttostr(Aop)+
                ' and opid='''+AopName+'''';
   try
      qr.Open;
   except
      result:=false;
      FreeAndNil(qr);
      exit;
   end;
   if qr.Eof then
   begin
     qr.Close;
     qr.SQL.Text:='insert into t_userop'+
                  '(op, opname, opid, opboolean, optype, op_delete, op_save, op_new)'+
                  'values('+
                  inttostr(Aop)+
                  ','''+AopName+''''+
                  ','''+AopName+''''+
                  ',''0'''+
                  ',''1'''+
                  ',''0'''+
                  ',''0'''+
                  ',''0'''+
                  ')';
     try
     qr.ExecSQL;
     except
     end;
     result:=false;
   end
   else
   begin
     if Aopkey='opboolean' then
     begin
        if qr.FieldByName('opboolean').AsString ='1' then
           result:=true
        else
           result:=false;
     end
     else if Aopkey='op_new' then
     begin
        if qr.FieldByName('op_new').AsString ='1' then
           result:=true
        else
           result:=false;
     end
     else if Aopkey='op_save' then
     begin
        if qr.FieldByName('op_save').AsString ='1' then
           result:=true
        else
           result:=false;
     end
     else if Aopkey='op_delete' then
     begin
        if qr.FieldByName('op_delete').AsString ='1' then
           result:=true
        else
           result:=false;
     end
     else
       result:=false;
   end;
   qr.Close;
   FreeAndNil(qr);
end;
//工作量分析
function Tdmdbaccess.SetGzlXXlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const bzslsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime):boolean;
var
  listItem:Tlistitem;
  i,total:integer;

  cmdstr:widestring;
  searchType :integer;
  TotalFristCure :integer;         // '总的初诊数
  TotalSecCure :integer;             //   '总的复诊数
  TotalNoCall:integer;//总的弃号数
  Totalksrs:integer;//总人数
  ksrs:integer;//科室人数
  TotalWaitNum :integer;             //              '总的等候人数
  TotalDoctNum :integer;             //                '总的医生数
  TotalAvgWaitTime :integer;             //            '总的平均等待时间
  TotalAvgWaitNum :integer;             //             '平均等待时间统计的个数
  TotalMaxWaitTime :integer;             //           '总的最长等待时间
  TotalAvgAccept:integer;             //            '总的平均就诊时间
  TotalAvgAcceptNum :integer;             //         '平均就诊时间统计个数
  TotalMaxCureTime :integer;             //          '总的最长就诊时间
  TotalMinCureTime :integer;             //            '总的最短就诊时间
  TotalQh :integer;             //                    '总的弃号数
  TotalWaitless:integer;             //               '总的等待小于基准
  TotalAcceptless :integer;             //              '总的就诊小于基准

//
  AvgAccept :integer;             //                    '平均就诊时间
  MaxCureTime :integer;             //                    '最长就诊时间
  MinCureTime :integer;             //                   '最短就诊时间
  TempMaxCureTime :integer;             //                '当前就诊时间
  AvgCureTime :integer;             //                    '当前全部就诊时间
  AvgNum :integer;             //                         '当前全部就诊次数
  starttime :Tdatetime;             //                     '起始时间
  endtime :Tdatetime;             //                       '结束时间
  StartUserID :string;             //                '起始UserID
  EndUserID :string;             //                    '结束UserID
  LessNum :integer;             //                     '小于基准受理时间个数
  qr,qr1:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  qr1:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr1.Connection := ADOConnection;
    try
        listview.Columns.Clear;
        listview.Clear;
        ProgressBar.Position:=0;
        for i:=0 to 12 do
           listview.Columns.add;
        listview.Columns[0].Caption:=ttl_ks+'名称';
        listview.Columns[1].Caption:='  '+ttl_yh+'  ';
        listview.Columns[2].Caption:=ttl_cz+'人数';
        listview.Columns[3].Caption:=ttl_fz+'人数';
        listview.Columns[4].Caption:='未呼叫人数';
        listview.Columns[5].Caption:='总人数';
        listview.Columns[6].Caption:='平均受理时间';
        listview.Columns[7].Caption:='最短受理时间';
        listview.Columns[8].Caption:='最长受理时间';
        listview.Columns[9].Caption:='人数<Y';
        listview.Columns[10].Caption:='受理<Y(%)';
        listview.Columns[11].Caption:='选择医生患者人数';
        listview.Columns[12].Caption:='随机呼叫患者人数';
        for i:=0 to 12 do
        begin
            listview.columns[i].Alignment:=taCenter;
            listview.Columns[i].Width:=(Length(listview.Columns[i].Caption)+1) * ListView.Canvas.TextWidth('A');// .Font.Size ;
        end;
        progressbar.Position:=10;
        if length(ksid)>0 then
        begin
            cmdstr:='select distinct t_jzjl.yhid,t_yh.yhmc from t_jzjl '+
                  ' LEFT OUTER JOIN t_yh on t_jzjl.yhid=t_yh.yhid and t_jzjl.hszh=t_yh.hszh' +
                  ' Where t_jzjl.ksid=''' + ksid +''''+
                  ' and t_jzjl.hszh=' + inttostr(gblhszh)+
                  ' and (jzsj between ''' + cdatetostr(kssj) +'''' +
                  ' and '''+ cdatetostr(jssj) + ''')';
            searchType:=1 ;
        end
        else
        begin
            cmdstr:='select ksid,ksmc from t_ks '+
                  ' Where hszh=' + inttostr(gblhszh);
            searchType:=0;
        end;
        TotalMinCureTime:=999;

        //开始统计
      qr.Close;
      qr.SQL.Text:=cmdstr;
      qr.Open;
      total:=qr.RecordCount;
      ///////////将数据放入LISTVIEW中.
      with qr do
      begin
         while not qr.Eof do
         begin
            listItem:=listview.Items.Add;
            for i:=0 to 11  do
                listitem.subitems.add('');
  //          ListItem.Caption := Fields[0].AsString;
            If SearchType = 0 Then
               ListItem.Caption := Fields[1].AsString
            Else
            begin
               listitem.Caption:=ksmc;
               ListItem.SubItems[0] := Fields[1].AsString;
            end;
            ksrs:=0;
            /////////取得初诊人数;
            qr1.Close;
            if Searchtype=0 then
               qr1.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where (ztbz=1 or ztbz=5 or ztbz=7) and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and hszh=' + inttostr(gblhszh)
            else
               qr1.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where (ztbz=1 or ztbz=5 or ztbz=7 ) and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + ksid + ''''+
                                       ' and yhid='''+ fields[0].AsString+''''+
                                       ' and hszh=' + inttostr(gblhszh) ;
            qr1.Open;

            listitem.SubItems[1]:=qr1.Fields.Fields[0].AsString;
            TotalFristCure := TotalFristCure + qr1.Fields.Fields[0].AsInteger;
            ksrs:=ksrs+ qr1.Fields.Fields[0].AsInteger;
            //取得复诊人数;
            qr1.Close;
            if Searchtype=0 then
               qr1.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where yxjid=1 and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and hszh=' + inttostr(gblhszh)
            else
               qr1.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where yxjid=1 and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + ksid + ''''+
                                       ' and yhid='''+ fields[0].AsString+''''+
                                       ' and hszh=' + inttostr(gblhszh) ;
            qr1.Open;
            listitem.SubItems[2]:=qr1.Fields.Fields[0].AsString;
            TotalSecCure := TotalSecCure + qr1.Fields.Fields[0].AsInteger;
            ksrs:=ksrs+ qr1.Fields.Fields[0].AsInteger;
            //取得弃号人数;
            qr1.Close;
            if Searchtype=0 then
               qr1.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where (jzbz=''1'' or (ztbz=3 and jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and hszh=' + inttostr(gblhszh)
            else
               qr1.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where (jzbz=''1'' or (ztbz=3 and jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + ksid + ''''+
                                       ' and yhid='''+ fields[0].AsString+''''+
                                       ' and hszh=' + inttostr(gblhszh) ;
            qr1.Open;
            listitem.SubItems[3]:=qr1.Fields.Fields[0].AsString;
            TotalNoCall:= TotalNoCall + qr1.Fields.Fields[0].AsInteger;
            ksrs:=ksrs+ qr1.Fields.Fields[0].AsInteger;
            totalksrs:=totalksrs+ksrs;
            listitem.SubItems[4]:=inttostr(ksrs);
            qr1.Close;
            //取得选择医生人数;
            if Searchtype=0 then
               qr1.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where ((ztbz<>3) and (jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and isnull(oldyhid,'''')<>'''''+
                                       ' and hszh=' + inttostr(gblhszh)
            else
               qr1.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where ((ztbz<>3 and jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + ksid + ''''+
                                       ' and yhid='''+ fields[0].AsString+''''+
                                       ' and isnull(oldyhid,'''')<>'''''+
                                       ' and hszh=' + inttostr(gblhszh) ;
            qr1.Open;
            listitem.SubItems[10]:=qr1.Fields.Fields[0].AsString;
            qr1.Close;
            //取得随机呼叫患者人数;
            if Searchtype=0 then
               qr1.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where ((ztbz<>3 and jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and isnull(oldyhid,'''')='''''+
                                       ' and hszh=' + inttostr(gblhszh)
            else
               qr1.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where ((ztbz<>3 and jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + ksid + ''''+
                                       ' and yhid='''+ fields[0].AsString+''''+
                                       ' and isnull(oldyhid,'''')='''''+
                                       ' and hszh=' + inttostr(gblhszh) ;
            qr1.Open;
            listitem.SubItems[11]:=qr1.Fields.Fields[0].AsString;
            qr1.Close;
            AvgNum := 0 ;
            MaxCureTime := 0;
            MinCureTime := 999;
            LessNum := 0;
            AvgCureTime := 0;
            if Searchtype=0 then
               qr1.SQL.Text:=' select jzsj,yhid,jzjssj from t_jzjl '+
                                       ' where ghsj is not null and jzsj is not null ' +
                                       ' and ztbz in (1,2,5,7) ' +
                                       ' and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and hszh=' + inttostr(gblhszh)+
                                       ' order by yhid,jzsj'
            else
               qr1.SQL.Text:=' select jzsj,yhid,jzjssj from t_jzjl  '+
                                       ' where ghsj is not null and jzsj is not null ' +
                                       ' and ztbz in (1,2,5,7) '+
                                       ' and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + ksid + ''''+
                                       ' and yhid='''+ fields[0].AsString+''''+
                                       ' and hszh=' + inttostr(gblhszh) +
                                       ' order by yhid,jzsj';
            qr1.Open;
            with qr1 do
            begin
               while not qr1.Eof do
               begin
                  starttime:=fields.Fields[0].AsDateTime;
                  startuserid:=fields.Fields[1].AsString;
                  endtime:=fields.Fields[2].AsDateTime;
                  if True then //startuserid=enduserid then
                  begin
                       TempMaxCureTime := round((endtime- starttime)*24*60);
                       //'判断就诊时间是否在正常范围内
                       If (TempMaxCureTime <= 60) And (TempMaxCureTime >= 1) Then
                       begin
                          If TempMaxCureTime <= bzslsj Then
                          begin
                             LessNum := LessNum + 1;
                             TotalAcceptless := TotalAcceptless + 1;
                           end;

                          //'是否为最长就诊时间
                          If TempMaxCureTime > MaxCureTime Then
                             MaxCureTime := TempMaxCureTime;

                          If TempMaxCureTime < MinCureTime Then
                             MinCureTime := TempMaxCureTime;
                          AvgNum := AvgNum + 1 ;
                          AvgCureTime := AvgCureTime + TempMaxCureTime ;
                       End;
                  end;
                  qr1.next;
               end;
              //'显示平均就诊时间
              If AvgNum > 0 Then
              begin
                 listitem.SubItems[5]:= inttostr(AvgCureTime div AvgNum);
                 //'计算总就诊时间和个数
                 TotalAvgAccept := TotalAvgAccept + AvgCureTime;
                 //'统计的个数
                 TotalAvgAcceptNum := TotalAvgAcceptNum + AvgNum;
                 //'显示就诊<Y(%)
                 listitem.SubItems[9]:= inttostr(round(((LessNum / AvgNum) * 100))) + '%';
              end;
               //'显示人数<Y
              listitem.SubItems[8]:= inttostr(lessnum);

              //'显示最短,最长就诊时间
              if  mincuretime=999 then
                 listitem.SubItems[6]:= ''
              else
                 listitem.SubItems[6]:= inttostr(mincuretime);

              listitem.SubItems[7]:= inttostr(maxcuretime);
              If MaxCureTime > TotalMaxCureTime Then       //     '总的最长就诊时间
                 TotalMaxCureTime := MaxCureTime;
              If MinCureTime < TotalMinCureTime Then     //       '总的最短就诊时间
                 TotalMinCureTime := MinCureTime;
              close;
            end;
            Next;
            i:=i+1;
            progressbar.position:=20+round((i *80)/total);
         end;
         Close;
      end;
  //        '显示合并项
      listItem:=listview.Items.Add;
      for i:=0 to 9  do
          listitem.subitems.add('');
      listitem.Caption:='合    计';
      listitem.SubItems[1]:=inttostr(TotalFristCure);
      listitem.SubItems[2]:=inttostr(TotalSecCure);
      listitem.SubItems[3]:=inttostr(TotalNoCall);
      listitem.SubItems[4]:=inttostr(totalksrs);
      If TotalAvgAcceptNum > 0 Then
         listitem.SubItems[5]:= Inttostr(TotalAvgAccept div TotalAvgAcceptNum);
      if  TotalMinCureTime=999 then
         listitem.SubItems[6]:=''
      else
         listitem.SubItems[6]:=inttostr(TotalMinCureTime);
      listitem.SubItems[7]:=inttostr(TotalMaxCureTime);
      listitem.SubItems[8]:=inttostr(TotalAcceptless);
      If TotalAvgAcceptNum > 0 Then
         listitem.SubItems[9]:=inttostr(round(100 * TotalAcceptless / TotalAvgAcceptNum)) +'%'
      else
         listitem.SubItems[9]:='';//'不统计';
      progressbar.Position:=100;
      result:=true;
    except
        begin
          listview.clear;
          progressbar.position:=0;
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
    FreeAndNil(qr1);
  end;
end;

//工作量分析
function Tdmdbaccess.SetDrGzlXXlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const bzslsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime):boolean;
var
  listItem:Tlistitem;
  i,total:integer;

  cmdstr:widestring;
  searchType :integer;
  TotalFristCure :integer;         // '总的初诊数
  TotalSecCure :integer;             //   '总的复诊数
  TotalNoCall:integer;//总的弃号数
  Totalksrs:integer;//总人数
  ksrs:integer;//科室人数
  TotalWaitNum :integer;             //              '总的等候人数
  TotalDoctNum :integer;             //                '总的医生数
  TotalAvgWaitTime :integer;             //            '总的平均等待时间
  TotalAvgWaitNum :integer;             //             '平均等待时间统计的个数
  TotalMaxWaitTime :integer;             //           '总的最长等待时间
  TotalAvgAccept:integer;             //            '总的平均就诊时间
  TotalAvgAcceptNum :integer;             //         '平均就诊时间统计个数
  TotalMaxCureTime :integer;             //          '总的最长就诊时间
  TotalMinCureTime :integer;             //            '总的最短就诊时间
  TotalQh :integer;             //                    '总的弃号数
  TotalWaitless:integer;             //               '总的等待小于基准
  TotalAcceptless :integer;             //              '总的就诊小于基准

//
  AvgAccept :integer;             //                    '平均就诊时间
  MaxCureTime :integer;             //                    '最长就诊时间
  MinCureTime :integer;             //                   '最短就诊时间
  TempMaxCureTime :integer;             //                '当前就诊时间
  AvgCureTime :integer;             //                    '当前全部就诊时间
  AvgNum :integer;             //                         '当前全部就诊次数
  starttime :Tdatetime;             //                     '起始时间
  endtime :Tdatetime;             //                       '结束时间
  StartUserID :string;             //                '起始UserID
  EndUserID :string;             //                    '结束UserID
  LessNum :integer;             //                     '小于基准受理时间个数
  qr,qr1:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  qr1:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr1.Connection := ADOConnection;
    try
        listview.Columns.Clear;
        listview.Clear;
        ProgressBar.Position:=0;
        for i:=0 to 12 do
           listview.Columns.add;
        listview.Columns[0].Caption:=ttl_ks+'名称';
        listview.Columns[1].Caption:='  '+ttl_yh+'  ';
        listview.Columns[2].Caption:=ttl_cz+'人数';
        listview.Columns[3].Caption:=ttl_fz+'人数';
        listview.Columns[4].Caption:='未呼叫人数';
        listview.Columns[5].Caption:='总人数';
        listview.Columns[6].Caption:='平均受理时间';
        listview.Columns[7].Caption:='最短受理时间';
        listview.Columns[8].Caption:='最长受理时间';
        listview.Columns[9].Caption:='人数<Y';
        listview.Columns[10].Caption:='受理<Y(%)';
        listview.Columns[11].Caption:='选择医生患者数';
        listview.Columns[12].Caption:='随机呼叫患者数';
        for i:=0 to 12 do
        begin
            listview.columns[i].Alignment:=taCenter;
            listview.Columns[i].Width:=(Length(listview.Columns[i].Caption)+1) * ListView.Canvas.TextWidth('A');// .Font.Size ;
        end;
        progressbar.Position:=10;
        if length(ksid)>0 then
        begin
            cmdstr:='select distinct t_jzjl.yhid,t_yh.yhmc from t_dhxx t_jzjl '+
                  ' LEFT OUTER JOIN t_yh on t_jzjl.yhid=t_yh.yhid and t_jzjl.hszh=t_yh.hszh' +
                  ' Where t_jzjl.ksid=''' + ksid +''''+
                  ' and t_jzjl.hszh=' + inttostr(gblhszh)+
                  ' and (ghsj between ''' + cdatetostr(kssj) +'''' +
                  ' and '''+ cdatetostr(jssj) + ''')';
            searchType:=1 ;
        end
        else
        begin
            cmdstr:='select ksid,ksmc from t_ks '+
                  ' Where hszh=' + inttostr(gblhszh);
            searchType:=0;
        end;
        TotalMinCureTime:=999;

        //开始统计
      qr.Close;
      qr.SQL.Text:=cmdstr;
      qr.Open;
      total:=qr.RecordCount;
      ///////////将数据放入LISTVIEW中.
      with qr do
      begin
         while not qr.Eof do
         begin
            listItem:=listview.Items.Add;
            for i:=0 to 11  do
                listitem.subitems.add('');
  //          ListItem.Caption := Fields[0].AsString;
            If SearchType = 0 Then
               ListItem.Caption := Fields[1].AsString
            Else
            begin
               listitem.Caption:=ksmc;
               ListItem.SubItems[0] := Fields[1].AsString;
            end;
            ksrs:=0;
            /////////取得初诊人数;
            qr1.Close;
            if Searchtype=0 then
               qr1.SQL.Text:=' select count(*) as num from t_dhxx '+
                                       ' where (ztbz=1 or ztbz=5 or ztbz=7) and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and hszh=' + inttostr(gblhszh)
            else
               qr1.SQL.Text:=' select count(*) as num from t_dhxx '+
                                       ' where (ztbz=1 or ztbz=5 or ztbz=7 ) and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + ksid + ''''+
                                       ' and yhid='''+ fields[0].AsString+''''+
                                       ' and hszh=' + inttostr(gblhszh) ;
            qr1.Open;

            listitem.SubItems[1]:=qr1.Fields.Fields[0].AsString;
            TotalFristCure := TotalFristCure + qr1.Fields.Fields[0].AsInteger;
            ksrs:=ksrs+ qr1.Fields.Fields[0].AsInteger;
            //取得复诊人数;
            qr1.Close;
            if Searchtype=0 then
               qr1.SQL.Text:=' select count(*) as num from t_dhxx '+
                                       ' where yxjid=1 and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and hszh=' + inttostr(gblhszh)
            else
               qr1.SQL.Text:=' select count(*) as num from t_dhxx '+
                                       ' where yxjid=1 and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + ksid + ''''+
                                       ' and yhid='''+ fields[0].AsString+''''+
                                       ' and hszh=' + inttostr(gblhszh) ;
            qr1.Open;
            listitem.SubItems[2]:=qr1.Fields.Fields[0].AsString;
            TotalSecCure := TotalSecCure + qr1.Fields.Fields[0].AsInteger;
            ksrs:=ksrs+ qr1.Fields.Fields[0].AsInteger;
            //取得弃号人数;
            qr1.Close;
            if Searchtype=0 then
               qr1.SQL.Text:=' select count(*) as num from t_dhxx '+
                                       ' where ((ztbz=3 and jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and hszh=' + inttostr(gblhszh)
            else
               qr1.SQL.Text:=' select count(*) as num from t_dhxx '+
                                       ' where ((ztbz=3 and jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + ksid + ''''+
                                       ' and yhid='''+ fields[0].AsString+''''+
                                       ' and hszh=' + inttostr(gblhszh) ;
            qr1.Open;
            listitem.SubItems[3]:=qr1.Fields.Fields[0].AsString;
            TotalNoCall:= TotalNoCall + qr1.Fields.Fields[0].AsInteger;
            ksrs:=ksrs+ qr1.Fields.Fields[0].AsInteger;
            totalksrs:=totalksrs+ksrs;
            listitem.SubItems[4]:=inttostr(ksrs);
            qr1.Close;
            //取得选择医生人数;
            if Searchtype=0 then
               qr1.SQL.Text:=' select count(*) as num from t_dhxx '+
                                       ' where ((ztbz<>3) and (jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and isnull(oldyhid,'''')<>'''''+
                                       ' and hszh=' + inttostr(gblhszh)
            else
               qr1.SQL.Text:=' select count(*) as num from t_dhxx '+
                                       ' where ((ztbz<>3 and jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + ksid + ''''+
                                       ' and yhid='''+ fields[0].AsString+''''+
                                       ' and isnull(oldyhid,'''')<>'''''+
                                       ' and hszh=' + inttostr(gblhszh) ;
            qr1.Open;
            listitem.SubItems[10]:=qr1.Fields.Fields[0].AsString;
            qr1.Close;
            //取得随机呼叫患者人数;
            if Searchtype=0 then
               qr1.SQL.Text:=' select count(*) as num from t_dhxx '+
                                       ' where ((ztbz<>3 and jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and isnull(oldyhid,'''')='''''+
                                       ' and hszh=' + inttostr(gblhszh)
            else
               qr1.SQL.Text:=' select count(*) as num from t_dhxx '+
                                       ' where ((ztbz<>3 and jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + ksid + ''''+
                                       ' and yhid='''+ fields[0].AsString+''''+
                                       ' and isnull(oldyhid,'''')='''''+
                                       ' and hszh=' + inttostr(gblhszh) ;
            qr1.Open;
            listitem.SubItems[11]:=qr1.Fields.Fields[0].AsString;
            qr1.Close;

            AvgNum := 0 ;
            MaxCureTime := 0;
            MinCureTime := 999;
            LessNum := 0;
            AvgCureTime := 0;
            if Searchtype=0 then
               qr1.SQL.Text:=' select jzsj,yhid,jzjssj from t_dhxx '+
                                       ' where ghsj is not null and jzsj is not null ' +
                                       ' and ztbz in (1,2,5,7) ' +
                                       ' and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and hszh=' + inttostr(gblhszh)+
                                       ' order by yhid,jzsj'
            else
               qr1.SQL.Text:=' select jzsj,yhid,jzjssj from t_dhxx  '+
                                       ' where ghsj is not null and jzsj is not null ' +
                                       ' and ztbz in (1,2,5,7) '+
                                       ' and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + ksid + ''''+
                                       ' and yhid='''+ fields[0].AsString+''''+
                                       ' and hszh=' + inttostr(gblhszh) +
                                       ' order by yhid,jzsj';
            qr1.Open;
            with qr1 do
            begin
               while not qr1.Eof do
               begin
                  starttime:=fields.Fields[0].AsDateTime;
                  startuserid:=fields.Fields[1].AsString;
                  endtime:=fields.Fields[2].AsDateTime;
                  if True then //startuserid=enduserid then
                  begin
                       TempMaxCureTime := round((endtime- starttime)*24*60);
                       //'判断就诊时间是否在正常范围内
                       If (TempMaxCureTime <= 60) And (TempMaxCureTime >= 1) Then
                       begin
                          If TempMaxCureTime <= bzslsj Then
                          begin
                             LessNum := LessNum + 1;
                             TotalAcceptless := TotalAcceptless + 1;
                           end;

                          //'是否为最长就诊时间
                          If TempMaxCureTime > MaxCureTime Then
                             MaxCureTime := TempMaxCureTime;

                          If TempMaxCureTime < MinCureTime Then
                             MinCureTime := TempMaxCureTime;
                          AvgNum := AvgNum + 1 ;
                          AvgCureTime := AvgCureTime + TempMaxCureTime ;
                       End;
                  end;
                  qr1.next;
               end;
              //'显示平均就诊时间
              If AvgNum > 0 Then
              begin
                 listitem.SubItems[5]:= inttostr(AvgCureTime div AvgNum);
                 //'计算总就诊时间和个数
                 TotalAvgAccept := TotalAvgAccept + AvgCureTime;
                 //'统计的个数
                 TotalAvgAcceptNum := TotalAvgAcceptNum + AvgNum;
                 //'显示就诊<Y(%)
                 listitem.SubItems[9]:= inttostr(round(((LessNum / AvgNum) * 100))) + '%';
              end;
               //'显示人数<Y
              listitem.SubItems[8]:= inttostr(lessnum);

              //'显示最短,最长就诊时间
              if  mincuretime=999 then
                 listitem.SubItems[6]:= ''
              else
                 listitem.SubItems[6]:= inttostr(mincuretime);

              listitem.SubItems[7]:= inttostr(maxcuretime);
              If MaxCureTime > TotalMaxCureTime Then       //     '总的最长就诊时间
                 TotalMaxCureTime := MaxCureTime;
              If MinCureTime < TotalMinCureTime Then     //       '总的最短就诊时间
                 TotalMinCureTime := MinCureTime;
              close;
            end;
            Next;
            i:=i+1;
            progressbar.position:=20+round((i *80)/total);
         end;
         Close;
      end;
  //        '显示合并项
      listItem:=listview.Items.Add;
      for i:=0 to 9  do
          listitem.subitems.add('');
      listitem.Caption:='合    计';
      listitem.SubItems[1]:=inttostr(TotalFristCure);
      listitem.SubItems[2]:=inttostr(TotalSecCure);
      listitem.SubItems[3]:=inttostr(TotalNoCall);
      listitem.SubItems[4]:=inttostr(totalksrs);
      If TotalAvgAcceptNum > 0 Then
         listitem.SubItems[5]:= Inttostr(TotalAvgAccept div TotalAvgAcceptNum);
      if  TotalMinCureTime=999 then
         listitem.SubItems[6]:=''
      else
         listitem.SubItems[6]:=inttostr(TotalMinCureTime);
      listitem.SubItems[7]:=inttostr(TotalMaxCureTime);
      listitem.SubItems[8]:=inttostr(TotalAcceptless);
      If TotalAvgAcceptNum > 0 Then
         listitem.SubItems[9]:=inttostr(round(100 * TotalAcceptless / TotalAvgAcceptNum)) +'%'
      else
         listitem.SubItems[9]:='';//'不统计';
      progressbar.Position:=100;
      result:=true;
    except
        begin
          listview.clear;
          progressbar.position:=0;
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
    FreeAndNil(qr1);
  end;
end;

//召回统计
function Tdmdbaccess.SetFZTJlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const bzslsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime):boolean;
var
  listItem:Tlistitem;
  i,total:integer;

  cmdstr:widestring;
  searchType :integer;
  TotalFristCure :integer;         // '总的初诊数
  TotalSecCure :integer;             //   '总的复诊数
  TotalNoCall:integer;//总的弃号数
  Totalksrs:integer;//总人数
  ksrs:integer;//科室人数
  TotalWaitNum :integer;             //              '总的等候人数
  TotalDoctNum :integer;             //                '总的医生数
  TotalAvgWaitTime :integer;             //            '总的平均等待时间
  TotalAvgWaitNum :integer;             //             '平均等待时间统计的个数
  TotalMaxWaitTime :integer;             //           '总的最长等待时间
  TotalAvgAccept:integer;             //            '总的平均就诊时间
  TotalAvgAcceptNum :integer;             //         '平均就诊时间统计个数
  TotalMaxCureTime :integer;             //          '总的最长就诊时间
  TotalMinCureTime :integer;             //            '总的最短就诊时间
  TotalQh :integer;             //                    '总的弃号数
  TotalWaitless:integer;             //               '总的等待小于基准
  TotalAcceptless :integer;             //              '总的就诊小于基准

//
  AvgAccept :integer;             //                    '平均就诊时间
  MaxCureTime :integer;             //                    '最长就诊时间
  MinCureTime :integer;             //                   '最短就诊时间
  TempMaxCureTime :integer;             //                '当前就诊时间
  AvgCureTime :integer;             //                    '当前全部就诊时间
  AvgNum :integer;             //                         '当前全部就诊次数
  starttime :Tdatetime;             //                     '起始时间
  endtime :Tdatetime;             //                       '结束时间
  StartUserID :string;             //                '起始UserID
  EndUserID :string;             //                    '结束UserID
  LessNum :integer;             //                     '小于基准受理时间个数
  qr,qr1:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  qr1:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr1.Connection := ADOConnection;
    try
        listview.Columns.Clear;
        listview.Clear;
        ProgressBar.Position:=0;
        for i:=0 to 1 do
           listview.Columns.add;
        listview.Columns[0].Caption:=ttl_ks+'名称';
        listview.Columns[1].Caption:=ttl_fz+'人次数';
        for i:=0 to 1 do
        begin
            listview.columns[i].Alignment:=taCenter;
            listview.Columns[i].Width:=(Length(listview.Columns[i].Caption)+1) * ListView.Canvas.TextWidth('A');// .Font.Size ;
        end;
        progressbar.Position:=10;
        if length(ksid)>0 then
        begin
            cmdstr:='select ksid,ksmc from t_ks '+
                  ' Where hszh=' + inttostr(gblhszh)+
                  ' and ksid='+quotedstr(ksid)+
                  ' and ksid in (select ksid from t_fz_brxx'+
                  ' where ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                  ' and hszh=' + inttostr(gblhszh)+')';
            searchType:=0 ;
        end
        else
        begin
            cmdstr:='select ksid,ksmc from t_ks '+
                  ' Where hszh=' + inttostr(gblhszh)+
                  ' and ksid in (select ksid from t_fz_brxx'+
                  ' where ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                  ' and hszh=' + inttostr(gblhszh)+')';;
            searchType:=0;
        end;
        TotalMinCureTime:=999;

        //开始统计
      qr.Close;
      qr.SQL.Text:=cmdstr;
      qr.Open;
      total:=qr.RecordCount;
      ///////////将数据放入LISTVIEW中.
      with qr do
      begin
         while not qr.Eof do
         begin
            listItem:=listview.Items.Add;
            for i:=0 to 1  do
                listitem.subitems.add('');
  //          ListItem.Caption := Fields[0].AsString;
            If SearchType = 0 Then
               ListItem.Caption := Fields[1].AsString
            Else
            begin
               listitem.Caption:=ksmc;
               ListItem.SubItems[0] := Fields[1].AsString;
            end;
            ksrs:=0;
            /////////取得召回人次数;
            qr1.Close;
            if Searchtype=0 then
               qr1.SQL.Text:=' select count(*) as num from t_fz_brxx '+
                                       ' where ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and hszh=' + inttostr(gblhszh)
            else
               qr1.SQL.Text:=' select count(*) as num from t_fz_brxx '+
                                       ' where ghsj between ''' + cdatetostr(kssj) +'''' +
                                       ' and '''+ cdatetostr(jssj) + ''''+
                                       ' and ksid=''' + fields[0].AsString + ''''+
                                       ' and hszh=' + inttostr(gblhszh);
            qr1.Open;

            listitem.SubItems[1]:=qr1.Fields.Fields[0].AsString;
            TotalFristCure := TotalFristCure + qr1.Fields.Fields[0].AsInteger;
            ksrs:=ksrs+ qr1.Fields.Fields[0].AsInteger;
            //取得复诊人数;
            qr1.Close;
            Next;
            i:=i+1;
            progressbar.position:=20+round((i *80)/total);
         end;
         Close;
      end;
  //        '显示合并项
      listItem:=listview.Items.Add;
      for i:=0 to 1  do
          listitem.subitems.add('');
      listitem.Caption:='合    计';
      listitem.SubItems[1]:=inttostr(TotalFristCure);
      progressbar.Position:=100;
      result:=true;
    except
        begin
          listview.clear;
          progressbar.position:=0;
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
    FreeAndNil(qr1);
  end;
end;

//取号时间统计
function Tdmdbaccess.SetQHRSTJlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const bzslsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime):boolean;
var
  listItem:Tlistitem;
  i,total:integer;

  cmdstr:widestring;
  searchType :integer;
  TotalFristCure :integer;         // '总的初诊数
  TotalSecCure :integer;             //   '总的复诊数
  TotalNoCall:integer;//总的弃号数
  Totalksrs:integer;//总人数
  ksrs:integer;//科室人数
  TotalWaitNum :integer;             //              '总的等候人数
  TotalDoctNum :integer;             //                '总的医生数
  TotalAvgWaitTime :integer;             //            '总的平均等待时间
  TotalAvgWaitNum :integer;             //             '平均等待时间统计的个数
  TotalMaxWaitTime :integer;             //           '总的最长等待时间
  TotalAvgAccept:integer;             //            '总的平均就诊时间
  TotalAvgAcceptNum :integer;             //         '平均就诊时间统计个数
  TotalMaxCureTime :integer;             //          '总的最长就诊时间
  TotalMinCureTime :integer;             //            '总的最短就诊时间
  TotalQh :integer;             //                    '总的弃号数
  TotalWaitless:integer;             //               '总的等待小于基准
  TotalAcceptless :integer;             //              '总的就诊小于基准

//
  AvgAccept :integer;             //                    '平均就诊时间
  MaxCureTime :integer;             //                    '最长就诊时间
  MinCureTime :integer;             //                   '最短就诊时间
  TempMaxCureTime :integer;             //                '当前就诊时间
  AvgCureTime :integer;             //                    '当前全部就诊时间
  AvgNum :integer;             //                         '当前全部就诊次数
  starttime :Tdatetime;             //                     '起始时间
  endtime :Tdatetime;             //                       '结束时间
  StartUserID :string;             //                '起始UserID
  EndUserID :string;             //                    '结束UserID
  LessNum :integer;             //                     '小于基准受理时间个数
  qr,qr1:TADOQuery;

begin
  qr:=TADOQuery.Create(nil);
  qr1:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr1.Connection := ADOConnection;
    try
        listview.Columns.Clear;
        listview.Clear;
        ProgressBar.Position:=0;
        for i:=0 to 10 do
           listview.Columns.add;
        listview.Columns[0].Caption:=ttl_ks+'/时间段';
        for i:= 1 to 10 do
        begin
          listview.Columns[i].Caption:=format('%.2d',[8+i-1])+':00';
        end;
        for i:=0 to 10 do
        begin
            listview.columns[i].Alignment:=taCenter;
            listview.Columns[i].Width:=(Length(listview.Columns[i].Caption)+1) * ListView.Canvas.TextWidth('A');// .Font.Size ;
        end;
        progressbar.Position:=10;
        if cdatetostr(kssj)=cdatetostr(date) then
        begin
          if length(ksid)>0 then
          begin
              cmdstr:='select ksid,ksmc from t_ks '+
                    ' Where hszh=' + inttostr(gblhszh)+
                    ' and ksid='+quotedstr(ksid);
              searchType:=0 ;
          end
          else
          begin
              cmdstr:='select ksid,ksmc from t_ks '+
                    ' Where hszh=' + inttostr(gblhszh)+
                    ' and ksid in (select ksid from t_dhxx'+
                    ' where hszh=' + inttostr(gblhszh)+
                    ' group by ksid)';
              searchType:=0;
          end;
        end
        else
        begin
          if length(ksid)>0 then
          begin
              cmdstr:='select ksid,ksmc from t_ks '+
                    ' Where hszh=' + inttostr(gblhszh)+
                    ' and ksid='+quotedstr(ksid);
              searchType:=0 ;
          end
          else
          begin
              cmdstr:='select ksid,ksmc from t_ks '+
                    ' Where hszh=' + inttostr(gblhszh)+
                    ' and ksid in (select ksid from t_jzjl where ghsj between ''' + cdatetostr(kssj) +'''' +
                    ' and '''+ cdatetostr(jssj) + ''''+' and hszh=' + inttostr(gblhszh)+
                    'group by ksid)';
              searchType:=0;
          end;
        end;
        TotalMinCureTime:=999;

        //开始统计
      qr.Close;
      qr.SQL.Text:=cmdstr;
      qr.Open;
      total:=qr.RecordCount;
      ///////////将数据放入LISTVIEW中.
      with qr do
      begin
         while not qr.Eof do
         begin
            listItem:=listview.Items.Add;
            for i:=0 to 9  do
                listitem.subitems.add('');
            If SearchType = 0 Then
               ListItem.Caption := Fields[1].AsString
            Else
            begin
               listitem.Caption:=Fields[1].AsString;
            end;
            ksrs:=0;
            /////////取得召回人次数;
            qr1.Close;
            for i:=0 to 9 do
            begin
              if  cdatetostr(kssj)=cdatetostr(date) then
              begin
                   qr1.SQL.Text:=' select count(*) as num from t_dhxx '+
                                           ' where ghsj between ''' + cdatetostr(kssj) +'''' +
                                           ' and '''+ cdatetostr(jssj) + ''''+
                                           ' and ksid=''' + fields[0].AsString + ''''+
                                           ' and hszh=' + inttostr(gblhszh)+
                                           ' and by7='+quotedstr(format('%.2d',[8+i])+':00'+'-'+format('%.2d',[8+i+1])+':00');
              end
              else
              begin
                   qr1.SQL.Text:=' select count(*) as num from t_jzjl '+
                                           ' where ghsj between ''' + cdatetostr(kssj) +'''' +
                                           ' and '''+ cdatetostr(jssj) + ''''+
                                           ' and ksid=''' + fields[0].AsString + ''''+
                                           ' and hszh=' + inttostr(gblhszh)+
                                           ' and by7='+quotedstr(format('%.2d',[8+i])+':00'+'-'+format('%.2d',[8+i+1])+':00');
              end;
              qr1.Open;
              listitem.SubItems[i]:=qr1.Fields.Fields[0].AsString;
            end;
            //TotalFristCure := TotalFristCure + qr1.Fields.Fields[0].AsInteger;
            //ksrs:=ksrs+ qr1.Fields.Fields[0].AsInteger;
            //取得复诊人数;
            qr1.Close;
            Next;
            i:=i+1;
            progressbar.position:=20+round((i *80)/total);
         end;
         Close;
      end;
  //        '显示合并项
//      listItem:=listview.Items.Add;
//      for i:=0 to 1  do
//          listitem.subitems.add('');
//      listitem.Caption:='合    计';
//      listitem.SubItems[1]:=inttostr(TotalFristCure);
      progressbar.Position:=100;
      result:=true;
    except
        begin
          listview.clear;
          progressbar.position:=0;
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
    FreeAndNil(qr1);
  end;
end;

function tdmdbaccess.SetHMXXlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const bzddsj:integer;
             const bzslsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime;
             const noperson:boolean;
             const aWait,aDiscard:Boolean):boolean;
var
  listItem:Tlistitem;
  i,j,total:integer;
  rownum:integer;
  cmdstr,wherestr:widestring;
  searchType :integer;
  tmpcol:integer;
  tmpjgs:integer;
  tmpjgm:integer;

  TotalFristCure :integer;         // '总的初诊数
  TotalSecCure :integer;             //   '总的复诊数
  TotalWaitNum :integer;             //              '总的等候人数
  TotalDoctNum :integer;             //                '总的医生数
  TotalAvgWaitTime :integer;             //            '总的平均等待时间
  TotalAvgWaitNum :integer;             //             '平均等待时间统计的个数
  TotalMaxWaitTime :integer;             //           '总的最长等待时间
  TotalAvgAccept:integer;             //            '总的平均就诊时间
  TotalAvgAcceptNum :integer;             //         '平均就诊时间统计个数
  TotalMaxCureTime :integer;             //          '总的最长就诊时间
  TotalMinCureTime :integer;             //            '总的最短就诊时间
  TotalQh :integer;             //                    '总的弃号数
  TotalWaitless:integer;             //               '总的等待小于基准
  TotalAcceptless :integer;             //              '总的就诊小于基准

  tempavg:integer;

//
  AvgAccept :integer;             //                    '平均就诊时间
  MaxCureTime :integer;             //                    '最长就诊时间
  MinCureTime :integer;             //                   '最短就诊时间
  TempMaxCureTime :integer;             //                '当前就诊时间
  AvgCureTime :integer;             //                    '当前全部就诊时间
  AvgNum :integer;             //                         '当前全部就诊次数
  TotalCuretime:integer;
  TotalNum:integer;
  starttime :Tdatetime;             //                     '起始时间
  endtime :Tdatetime;             //                       '结束时间
  StartUserID :string;             //                '起始UserID
  EndUserID :string;             //                    '结束UserID
  LessNum :integer;             //                     '小于基准受理时间个数
  lesswaitnum:integer;

  days :integer;
  totalwatinum:integer;
  qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
        listview.Columns.Clear;
        listview.Clear;
        ProgressBar.Position:=0;
        days :=round(jssj-1-kssj);
        if noperson then
        begin
           for i:=0 to 9 do
             listview.Columns.add;
          listview.Columns[0].Caption:='序号';
          //listview.Columns[1].Caption:='    日    期    ';
          //listview.Columns[2].Caption:='号    码';
          listview.Columns[1].Caption:=' 窗口号 ';
          listview.Columns[2].Caption:='    业务名称   ';
          listview.Columns[3].Caption:='    取票时间   ';
          listview.Columns[4].Caption:='  开始'+ttl_jz+'时间  ';
          listview.Columns[5].Caption:=' 等候时间 ';
          listview.Columns[6].Caption:='  结束'+ttl_jz+'时间  ';
          listview.Columns[7].Caption:=' '+ttl_jz+'时间 ';
          //listview.Columns[6].Caption:='    员工号码   ';
          listview.Columns[8].Caption:=' 顾客状态 ';
          listview.Columns[9].Caption:='  备注  ';

          for i:=0 to 9 do
          begin
              listview.columns[i].Alignment:=taCenter;
              listview.Columns[i].Width:=(Length(listview.Columns[i].Caption)+1) * ListView.Canvas.TextWidth('A');//.Font.Size ;
          end;
          progressbar.Position:=10;

          for i :=0 to days do
          begin
              progressbar.Position:=10+round((((i+1) div (days+1))*80) / 100);
              if cdatetostr(kssj+i)=cdatetostr(date) then
              begin
                wherestr:=' and t_dhxx.hszh=' + inttostr(gblhszh);
                if length(ksid)>0 then
                begin
                   wherestr:=wherestr  + ' and t_dhxx.ksid='''  + ksid +'''';
                end;
                if not aWait then
                  wherestr := wherestr  + ' and t_dhxx.jzbz<>1';
                if not aDiscard then
                  wherestr := wherestr  + ' and t_dhxx.ztbz<>3';

                 cmdstr:=' select '+
                         ' fjmc '''+ttl_zs+''','+
                         ' ksmc ''业务名称'','+
                         ' convert(varchar(16),ghsj,120) ''取票时间'','+
                         ' convert(varchar(16),jzsj,120) ''开始受理时间'','+
                         ' case when jzsj is null then '''' '+
                         ' else convert(varchar,datediff(s,ghsj,jzsj)/60) +''分''+'+
                         ' convert(varchar,datediff(s,ghsj,jzsj) % 60)+''秒'' end as ''等候时间'','+
                         ' convert(varchar(16),jzjssj,120) ''结束受理时间'','+
                         ' case when jzsj is null then '''' '+
                         ' when jzjssj is null then '''' '+
                         ' else convert(varchar,datediff(s,jzsj,jzjssj)/60) +''分''+'+
                         ' convert(varchar,datediff(s,jzsj,jzjssj) % 60)+''秒'' end as '''+ttl_jz+'时间'','+
                         ' case when  jzjssj is null then ('+
                         ' case  when jzbz=1 then ''在等待'' when (jzbz=0 and t_dhxx.ztbz=3) then ''弃号'' else ''已呼叫'' end)'+
                         ' else ''已受理'' end ''顾客状态'' '+
                         ' from t_dhxx left outer join t_ks on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
                         ' left outer join t_yh on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh '+
                         ' left outer join t_hjzd on  t_dhxx.ckhm=t_hjzd.zdid and t_dhxx.hszh=t_hjzd.hszh '+
                         ' where convert(varchar(10),ghsj,120)='''+cdatetostr(kssj+i)+''''+
                         wherestr+
                         ' order by ''取票时间''';
              end
              else
              begin
                wherestr:=' and t_jzjl.hszh=' + inttostr(gblhszh);
                if length(ksid)>0 then
                begin
                   wherestr:=wherestr  + ' and t_jzjl.ksid='''  + ksid +'''';
                end;
                if not aWait then
                  wherestr := wherestr  + ' and t_jzjl.jzbz<>1';
                if not aDiscard then
                  wherestr := wherestr  + ' and t_jzjl.ztbz<>3';
                cmdstr:=' select '+
                         ' fjmc '''+ttl_zs+''','+
                         ' ksmc ''业务名称'','+
                         ' convert(varchar(16),ghsj,120) ''取票时间'','+
                         ' convert(varchar(16),jzsj,120) ''开始受理时间'','+
                         ' case when jzsj is null then '''' '+
                         ' else convert(varchar,datediff(s,ghsj,jzsj)/60) +''分''+'+
                         ' convert(varchar,datediff(s,ghsj,jzsj) % 60)+''秒'' end as ''等候时间'','+
                         ' convert(varchar(16),jzjssj,120) ''结束受理时间'','+
                         ' case when jzsj is null then '''' '+
                         ' when jzjssj is null then '''' '+
                         ' else convert(varchar,datediff(s,jzsj,jzjssj)/60) +''分''+'+
                         ' convert(varchar,datediff(s,jzsj,jzjssj) % 60)+''秒'' end as '''+ttl_jz+'时间'','+
                         ' case when  jzjssj is null then ('+
                         ' case  when jzbz=1 then ''在等待'' when (jzbz=0 and t_jzjl.ztbz=3) then ''弃号'' else ''已呼叫'' end)'+
                         ' else ''已受理'' end ''顾客状态'' '+
                         ' from t_jzjl left outer join t_ks on t_jzjl.ksid=t_ks.ksid and t_jzjl.hszh=t_ks.hszh '+
                         ' left outer join t_yh on t_jzjl.yhid=t_yh.yhid and t_jzjl.hszh=t_yh.hszh '+
                         ' left outer join t_hjzd on  t_jzjl.ckhm=t_hjzd.zdid and t_jzjl.hszh=t_hjzd.hszh '+
                         ' where jzbz=0 and '+
                         ' convert(varchar(10),ghsj,120)='''+cdatetostr(kssj+i)+''''+
                         wherestr+
                         ' order by ''取票时间''';
              end;
              qr.Close;
              qr.SQL.Text := cmdstr;
              //adoquery1.SQL.Text:=cmdstr;
              qr.Open;
              rownum:=1;
              while not qr.Eof do
              begin
                  listitem:=listview.Items.Add;
                  listitem.Caption:=inttostr(rownum);
                  for j:=0 to 8 do
                  begin
                      listitem.SubItems.add('');
                  end;
                  for j:=1 to 8 do
                  begin
                     try
                     listitem.subitems[j-1]:=qr.Fields.Fields[j-1].AsString ;
                     except
                     listitem.subitems[j-1]:='';
                     end;
                  end;
                  listitem.subitems[8]:='';
                  qr.next;
                  rownum:=rownum+1;
              end;
               qr.Close;
          end;
        end;
        progressbar.Position:=100;
        result:=true;
    except
        begin
          listview.clear;
          progressbar.position:=0;
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
//工作状况日报分析
function Tdmdbaccess.SetGzZKRBlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const yhid:string;
             const yhmc:string;
             const bzddsj:integer;
             const bzslsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime;
             const noperson:boolean):boolean;
var
  listItem:Tlistitem;
  i,j,total:integer;
  cmdstr,wherestr:widestring;
  searchType :integer;


  TotalFristCure :integer;         // '总的初诊数
  TotalSecCure :integer;             //   '总的复诊数
  TotalWaitNum :integer;             //              '总的等候人数
  TotalDoctNum :integer;             //                '总的医生数
  TotalAvgWaitTime :integer;             //            '总的平均等待时间
  TotalAvgWaitNum :integer;             //             '平均等待时间统计的个数
  TotalMaxWaitTime :integer;             //           '总的最长等待时间
  TotalAvgAccept:integer;             //            '总的平均就诊时间
  TotalAvgAcceptNum :integer;             //         '平均就诊时间统计个数
  TotalMaxCureTime :integer;             //          '总的最长就诊时间
  TotalMinCureTime :integer;             //            '总的最短就诊时间
  TotalQh :integer;             //                    '总的弃号数
  TotalWaitless:integer;             //               '总的等待小于基准
  TotalAcceptless :integer;             //              '总的就诊小于基准

  tempavg:integer;

//
  AvgAccept :integer;             //                    '平均就诊时间
  MaxCureTime :integer;             //                    '最长就诊时间
  MinCureTime :integer;             //                   '最短就诊时间
  TempMaxCureTime :integer;             //                '当前就诊时间
  AvgCureTime :integer;             //                    '当前全部就诊时间
  AvgNum :integer;             //                         '当前全部就诊次数
  TotalCuretime:integer;
  TotalNum:integer;
  starttime :Tdatetime;             //                     '起始时间
  endtime :Tdatetime;             //                       '结束时间
  StartUserID :string;             //                '起始UserID
  EndUserID :string;             //                    '结束UserID
  LessNum :integer;             //                     '小于基准受理时间个数
  lesswaitnum:integer;

  days :integer;
  totalwatinum:integer;
  qr :TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
        listview.Columns.Clear;
        listview.Clear;
        ProgressBar.Position:=0;
        days :=round(jssj-1-kssj);
        for i:=0 to 12 do
           listview.Columns.add;
        listview.Columns[0].Caption:='日    期';
        listview.Columns[1].Caption:='星  期';
        listview.Columns[2].Caption:=ttl_cz+'人数';
        listview.Columns[3].Caption:=ttl_fz+'人数';
        listview.Columns[4].Caption:='未呼叫人数';
        listview.Columns[5].Caption:='总人数';
        listview.Columns[6].Caption:='员工数';
        listview.Columns[7].Caption:='平均等待时间';
        listview.Columns[8].Caption:='最长等待时间';
        listview.Columns[9].Caption:='平均受理时间';
        listview.Columns[10].Caption:='最长受理时间';
        listview.Columns[11].Caption:='等待<X(%)';
        listview.Columns[12].Caption:='受理<Y(%)';

        for i:=0 to 12 do
        begin
            listview.columns[i].Alignment:=taCenter;
            listview.Columns[i].Width:=(Length(listview.Columns[i].Caption)+1) * ListView.Canvas.TextWidth('A');//.Font.Size ;
        end;
        progressbar.Position:=10;
        wherestr:=' and hszh=' + inttostr(gblhszh);
        if length(ksid)>0 then
        begin
           wherestr:=wherestr  + ' and ksid='''  + ksid +'''';
        end;
        if length(yhid)>0 then
        begin
           wherestr:=wherestr + ' and yhid=''' + yhid + '''';
        end;

        for i :=0 to days do
        begin
            qr.Close;
            qr.SQL.Text:=' select count(*) as numb from t_jzjl '+
                                       ' where ghsj is not null and jzsj is not null '+
                                       ' and jzbz=0'+
                                       ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                       wherestr  ;
            qr.Open;
            totalwatinum:=qr.Fields.Fields[0].AsInteger;
            if noperson then
            begin
                if totalwatinum>0 then
                begin
                      //日期
                      listitem:=listview.Items.Add;
                      listitem.Caption:=cdatetostr(kssj+i);
                      for j:=0 to 12 do
                      begin
                          listitem.SubItems.add('');
                      end;
                      //星期
                      listitem.subitems[0]:= WeekdayStr(kssj+i);
                      //取得一天初诊人数
                      qr.Close;
                      qr.sql.Text:=' select count(*) as num from t_jzjl '+
                                                 ' where (ztbz=1 or ztbz=5  or ztbz=7) and jzbz=''0'' '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      listitem.SubItems[1]:=qr.Fields.Fields[0].AsString;
                      //加到总的初诊人数
                      TotalFristCure := TotalFristCure + qr.Fields.Fields[0].AsInteger;
                      //取得一天复诊人数;
                      qr.Close;
                      qr.SQL.Text:=' select count(*) as num from t_jzjl '+
                                                 ' where ztbz=2 and jzbz=''0'' '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      listitem.SubItems[2]:=qr.Fields.Fields[0].AsString;
                      //加到总的复诊人数。
                      TotalSecCure := TotalSecCure + qr.Fields.Fields[0].AsInteger;
                      //取得当天上班医生人数
                      qr.Close;
                      qr.SQL.Text:=' select distinct YHID from t_jzjl '+
                                                 ' where yhid is not null '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      listitem.SubItems[5]:=inttostr(qr.RecordCount);
                      //加到总的上班医生人次数。
                      TotalDoctNum := TotalDoctNum + qr.RecordCount;
                      //取得平均等待时间
                      qr.Close;
                      qr.SQL.Text:=' select avg(datediff(n,ghsj,jzsj)) as numb from t_jzjl '+
                                                 ' where ghsj is not null and jzsj is not null '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      listitem.SubItems[6]:=qr.Fields.Fields[0].AsString;
                      tempavg := qr.Fields.Fields[0].asinteger;

                      qr.Close;
                      TotalAvgWaitTime := TotalAvgWaitTime + tempavg * totalwatinum;
                      //       '总的平均等待时间
                      //加到总的等待人数
                      //listitem.SubItems[4]:=inttostr(totalwatinum);

                      TotalAvgWaitNum := TotalAvgWaitNum + totalwatinum;
                      qr.Close;

                      //取得最长等待时间
                      qr.SQL.Text:=' select max(datediff(n,ghsj,jzsj)) as numb from t_jzjl '+
                                                 ' where ghsj is not null and jzsj is not null '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      listitem.SubItems[7]:=qr.Fields.Fields[0].AsString;
                      //如果当天的最长等待时间，则取代原先的最长等待时间。
                      if qr.Fields.Fields[0].asinteger>totalmaxwaittime then
                         TotalMaxWaitTime:=  qr.Fields.Fields[0].asinteger;

                      qr.Close;
                      //得到所有病人的就诊间隔时间。并且得到最长就诊间隔，及最小就诊间隔，总的就诊时间

                      AvgNum := 0 ;
                      MaxCureTime := 0;
                      MinCureTime := 999;
                      LessNum := 0;
                      AvgCureTime := 0;
                      TotalNum := 0;
                      TotalCureTime:=0;
                      TempMaxCureTime:=0;

                      qr.sql.Text:=' select jzsj,yhid,jzjssj from t_jzjl  '+
                                                 ' where  jzsj is not null ' +
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr +
                                                 ' order by yhid,jzsj';
                      qr.Open;
                      with qr do
                      begin
                         while not qr.Eof do
                         begin
                            starttime:=fields.Fields[0].AsDateTime;
                            startuserid:=fields.Fields[1].AsString;
                            endtime:=fields.Fields[2].AsDateTime;
                            {enduserid:=fields.Fields[1].AsString;}
                            if True then //startuserid=enduserid then
                            begin
                                 TempMaxCureTime := round((endtime- starttime)*24*60);
                                 //'判断就诊时间是否在正常范围内
                                 If (TempMaxCureTime <= 60) And (TempMaxCureTime >= 1) Then
                                 begin
                                    If TempMaxCureTime <= bzslsj Then
                                    begin
                                       LessNum := LessNum + 1;
                                       TotalAcceptless := TotalAcceptless + 1;
                                     end;

                                    //'是否为最长就诊时间
                                    If TempMaxCureTime > MaxCureTime Then
                                       MaxCureTime := TempMaxCureTime;

                                    If TempMaxCureTime < MinCureTime Then
                                       MinCureTime := TempMaxCureTime;
                                     //当天的统计人数
                                    TotalNum := TotalNum + 1;
                                    //总的就诊时间
                                    TotalCureTime := TotalCureTime + TempMaxCureTime;
            //                        AvgNum := AvgNum + 1 ;
            //                        AvgCureTime := AvgCureTime + TempMaxCureTime ;
                                 End;
                            end;
                            qr.next;
                         end;
                         close;
                      end;


                      //'显示平均就诊时间
                      If TotalNum > 0 Then
                      begin
                         AvgCureTime:= round(TotalCureTime / TotalNum) ;
                         listitem.SubItems[8]:= inttostr(AvgCureTime);

                         //'计算总就诊时间和个数
                         TotalAvgAccept := TotalAvgAccept + AvgCureTime;
                         //'统计的个数
                         TotalAvgAcceptNum := TotalAvgAcceptNum + TotalNum;
                         //'显示就诊<Y(%)
                         listitem.SubItems[11]:= inttostr(round(((LessNum / TotalNum) * 100))) + '%';
                      end;

                      //'取得并显示最长就诊时间

                      listitem.SubItems[9]:= inttostr(maxcuretime);
                      If MaxCureTime > TotalMaxCureTime Then       //     '总的最长就诊时间
                         TotalMaxCureTime := MaxCureTime;
                      If MinCureTime < TotalMinCureTime Then     //       '总的最短就诊时间
                         TotalMinCureTime := MinCureTime;

                      //取得一天弃号人数
                      qr.Close;
                      qr.SQL.Text:=' select count(*) as num from t_jzjl '+
                                                 ' where (jzbz=''1'' or (ztbz=3 and jzbz=''0'')) '+
                                                 ' and datediff(day,ghsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      listitem.SubItems[3]:=qr.Fields.Fields[0].AsString;
                      //加到总的弃号人数
                      TotalQh := TotalQh + qr.Fields.Fields[0].AsInteger;

                      listitem.SubItems[4]:=inttostr(strtoint(listitem.SubItems[1])+strtoint(listitem.SubItems[2])+strtoint(listitem.SubItems[3]));

                      //取得当天等待时间小于基准时间（BZDDSJ）的人数
                      qr.Close;
                      qr.SQL.Text :=' select count(*) as num from t_jzjl '+
                                                 ' where ghsj is not null and jzsj is not null '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 ' and datediff(n,ghsj,jzsj)<=' +  inttostr(bzddsj)+
                                                 wherestr  ;
                      qr.Open;
                      lesswaitnum :=  qr.Fields.Fields[0].AsInteger;

                       //取得当天就诊的病人人数
                      qr.Close;
                      qr.sql.Text :=' select count(*) as num from t_jzjl '+
                                                 ' where ghsj is not null and jzsj is not null '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      TotalWaitNum :=  qr.Fields.Fields[0].AsInteger;
                      if TotalWaitNum > 0 then
                      begin
                         listitem.SubItems[10]:=inttostr(round((lesswaitnum / TotalWaitNum) * 100)) + '%';
                         TotalWaitless := TotalWaitless + lesswaitnum;
                      end;
                end
            end
            else
            begin
                      //日期
                      listitem:=listview.Items.Add;
                      listitem.Caption:=cdatetostr(kssj+i);
                      for j:=0 to 12 do
                      begin
                          listitem.SubItems.add('');
                      end;
                      //星期
                      listitem.subitems[0]:= WeekdayStr(kssj+i);
                      //取得一天初诊人数
                      qr.Close;
                      qr.SQL.Text :=' select count(*) as num from t_jzjl '+
                                                 ' where (ztbz=1 or ztbz=5 or ztbz=7) and jzbz=''0'' '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      listitem.SubItems[1]:=qr.Fields.Fields[0].AsString;
                      //加到总的初诊人数
                      TotalFristCure := TotalFristCure + qr.Fields.Fields[0].AsInteger;
                      //取得一天复诊人数;
                      qr.Close;
                      qr.sql.Text:=' select count(*) as num from t_jzjl '+
                                                 ' where ztbz=2 and jzbz=''0'' '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      listitem.SubItems[2]:=qr.Fields.Fields[0].AsString;
                      //加到总的复诊人数。
                      TotalSecCure := TotalSecCure + qr.Fields.Fields[0].AsInteger;
                      //取得当天上班医生人数
                      qr.Close;
                      qr.SQL.Text:=' select distinct YHID from t_jzjl '+
                                                 ' where yhid is not null '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      listitem.SubItems[5]:=inttostr(qr.RecordCount);
                      //加到总的上班医生人次数。
                      TotalDoctNum := TotalDoctNum + qr.RecordCount;
                      //取得平均等待时间
                      qr.Close;
                      qr.SQL.Text:=' select avg(datediff(n,ghsj,jzsj)) as numb from t_jzjl '+
                                                 ' where ghsj is not null and jzsj is not null '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      listitem.SubItems[6]:=qr.Fields.Fields[0].AsString;
                      tempavg := qr.Fields.Fields[0].asinteger;

                      qr.Close;
                      TotalAvgWaitTime := TotalAvgWaitTime + tempavg * totalwatinum;
                      //       '总的平均等待时间

                      TotalAvgWaitNum := TotalAvgWaitNum + totalwatinum;
                      qr.Close;

                      //取得最长等待时间
                      qr.SQL.Text:=' select max(datediff(n,ghsj,jzsj)) as numb from t_jzjl '+
                                                 ' where ghsj is not null and jzsj is not null '+
                                                 ' and ztbz<>''2'' '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      listitem.SubItems[7]:=qr.Fields.Fields[0].AsString;
                      //如果当天的最长等待时间，则取代原先的最长等待时间。
                      if qr.Fields.Fields[0].asinteger>totalmaxwaittime then
                         TotalMaxWaitTime:=  qr.Fields.Fields[0].asinteger;

                      qr.Close;
                      //得到所有病人的就诊间隔时间。并且得到最长就诊间隔，及最小就诊间隔，总的就诊时间

                      AvgNum := 0 ;
                      MaxCureTime := 0;
                      MinCureTime := 999;
                      LessNum := 0;
                      AvgCureTime := 0;
                      TotalNum := 0;
                      TotalCureTime:=0;
                      TempMaxCureTime:=0;

                      qr.SQL.Text:=' select jzsj,yhid,jzjssj from t_jzjl  '+
                                                 ' where  jzsj is not null ' +
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr +
                                                 ' order by yhid,jzsj';
                      qr.Open;
                      with qr do
                      begin
                         while not qr.Eof do
                         begin
                            starttime:=fields.Fields[0].AsDateTime;
                            startuserid:=fields.Fields[1].AsString;
                            endtime:=fields.Fields[2].AsDateTime;
                            {enduserid:=fields.Fields[1].AsString;}
                            if True then //startuserid=enduserid then
                            begin
                                 TempMaxCureTime := round((endtime- starttime)*24*60);
                                 //'判断就诊时间是否在正常范围内
                                 If (TempMaxCureTime <= 60) And (TempMaxCureTime >= 1) Then
                                 begin
                                    If TempMaxCureTime <= bzslsj Then
                                    begin
                                       LessNum := LessNum + 1;
                                       TotalAcceptless := TotalAcceptless + 1;
                                     end;

                                    //'是否为最长就诊时间
                                    If TempMaxCureTime > MaxCureTime Then
                                       MaxCureTime := TempMaxCureTime;

                                    If TempMaxCureTime < MinCureTime Then
                                       MinCureTime := TempMaxCureTime;
                                     //当天的统计人数
                                    TotalNum := TotalNum + 1;
                                    //总的就诊时间
                                    TotalCureTime := TotalCureTime + TempMaxCureTime;
            //                        AvgNum := AvgNum + 1 ;
            //                        AvgCureTime := AvgCureTime + TempMaxCureTime ;
                                 End;
                            end;
                            qr.next;
                         end;
                         close;
                      end;


                      //'显示平均就诊时间
                      If TotalNum > 0 Then
                      begin
                         AvgCureTime:=round(TotalCureTime / TotalNum);
                         listitem.SubItems[8]:= inttostr(AvgCureTime);
                         //'计算总就诊时间和个数
                         TotalAvgAccept := TotalAvgAccept + TotalCureTime;
                         //'统计的个数
                         TotalAvgAcceptNum := TotalAvgAcceptNum + TotalNum;
                         //'显示就诊<Y(%)
                         listitem.SubItems[11]:= inttostr(round(((LessNum / TotalNum) * 100))) + '%';
                      end;

                      //'取得并显示最长就诊时间

                      listitem.SubItems[9]:= inttostr(maxcuretime);
                      If MaxCureTime > TotalMaxCureTime Then       //     '总的最长就诊时间
                         TotalMaxCureTime := MaxCureTime;
                      If MinCureTime < TotalMinCureTime Then     //       '总的最短就诊时间
                         TotalMinCureTime := MinCureTime;

                      //取得一天弃号人数
                      qr.Close;
                      qr.SQL.Text:=' select count(*) as num from t_jzjl '+
                                                 ' where (jzbz=''1'' or (ztbz=3 and jzbz=''0'')) '+
                                                 ' and datediff(day,ghsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      listitem.SubItems[3]:=qr.Fields.Fields[0].AsString;
                      //加到总的弃号人数
                      TotalQh := TotalQh + qr.Fields.Fields[0].AsInteger;
                      //总的等待人数
                      //listitem.SubItems[4]:=inttostr(totalwatinum+qr.Fields.Fields[0].AsInteger);
                      listitem.SubItems[4]:=inttostr(strtoint(listitem.SubItems[1])+strtoint(listitem.SubItems[2])+strtoint(listitem.SubItems[3]));
                      //取得当天等待时间小于基准时间（BZDDSJ）的人数
                      qr.Close;
                      qr.SQL.Text:=' select count(*) as num from t_jzjl '+
                                                 ' where ghsj is not null and jzsj is not null '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 ' and datediff(n,ghsj,jzsj)<=' +  inttostr(bzddsj)+
                                                 wherestr  ;
                      qr.Open;
                      lesswaitnum :=  qr.Fields.Fields[0].AsInteger;

                       //取得当天就诊的病人人数
                      qr.Close;
                      qr.SQL.Text:=' select count(*) as num from t_jzjl '+
                                                 ' where ghsj is not null and jzsj is not null '+
                                                 ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                                 wherestr  ;
                      qr.Open;
                      TotalWaitNum :=  qr.Fields.Fields[0].AsInteger;
                      if TotalWaitNum > 0 then
                      begin
                         listitem.SubItems[10]:=inttostr(round((lesswaitnum / TotalWaitNum) * 100)) + '%';
                         TotalWaitless := TotalWaitless + lesswaitnum;
                      end;
            end;
            progressbar.Position:=20+round((i/days)*80)   ;
         end;
          //日期
        listitem:=listview.Items.Add;
        listitem.Caption:='合计';
        for j:=0 to 12 do
        begin
            listitem.SubItems.add('');
        end;
        listitem.SubItems[1]:=inttostr(TotalFristCure);
        listitem.SubItems[2]:=inttostr(TotalSecCure);
        listitem.SubItems[4]:=inttostr(TotalFristCure+TotalSecCure+TotalQh);//TotalAvgWaitNum);
        listitem.SubItems[5]:=inttostr(TotalDoctNum);
     //   listitem.SubItems[5]:=inttostr(TotalDoctNum);
        If TotalAvgWaitNum > 0 Then
           listitem.SubItems[6]:=inttostr(round(TotalAvgWaitTime / TotalAvgWaitNum))
        else
           listitem.SubItems[6]:='';//'不统计';
        listitem.SubItems[7]:=inttostr(TotalMaxWaitTime);
        If TotalAvgAcceptNum > 0 Then
           listitem.SubItems[8]:=inttostr(round(TotalAvgAccept / TotalAvgAcceptNum))
        else
           listitem.SubItems[8]:='';//'不统计';
        listitem.SubItems[9]:=inttostr(TotalMaxCureTime);
        listitem.SubItems[3]:=inttostr(TotalQh);
        If TotalAvgWaitNum > 0 Then
           listitem.SubItems[10]:= inttostr(round(TotalWaitless * 100 / TotalAvgWaitNum)) + '%'
        else
           listitem.SubItems[10]:='';//'不统计';
        If TotalAvgAcceptNum > 0 Then
           listitem.SubItems[11]:=  inttostr(round(TotalAcceptless * 100 / TotalAvgAcceptNum)) +'%'
        else
           listitem.SubItems[11]:='';//'不统计';
        progressbar.Position:=100;
        result:=true;
    except
        begin
          listview.clear;
          progressbar.position:=0;
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

//工作状况时报分析
function Tdmdbaccess.SetGzZKSBlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const yhid:string;
             const yhmc:string;
             const bzddsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime;
             const sdkssj:tdatetime;
             const sdjssj:tdatetime):boolean;
var
  listItem:Tlistitem;
  i,j,total:integer;
  cmdstr,wherestr:widestring;
  searchType :integer;


  TotalFristCure :integer;         // '总的初诊数
  TotalSecCure :integer;             //   '总的复诊数
  TotalWaitNum :integer;             //              '总的等候人数
  TotalDoctNum :integer;             //                '总的医生数
  TotalAvgWaitTime :integer;             //            '总的平均等待时间
  TotalAvgWaitNum :integer;             //             '平均等待时间统计的个数
  TotalMaxWaitTime :integer;             //           '总的最长等待时间
  TotalAvgAccept:integer;             //            '总的平均就诊时间
  TotalAvgAcceptNum :integer;             //         '平均就诊时间统计个数
  TotalMaxCureTime :integer;             //          '总的最长就诊时间
  TotalMinCureTime :integer;             //            '总的最短就诊时间
  TotalQh :integer;             //                    '总的弃号数
  TotalWaitless:integer;             //               '总的等待小于基准
  TotalAcceptless :integer;             //              '总的就诊小于基准

  tempavg:integer;

//
  AvgAccept :integer;             //                    '平均就诊时间
  MaxCureTime :integer;             //                    '最长就诊时间
  MinCureTime :integer;             //                   '最短就诊时间
  TempMaxCureTime :integer;             //                '当前就诊时间
  AvgCureTime :integer;             //                    '当前全部就诊时间
  AvgNum :integer;             //                         '当前全部就诊次数
  TotalCuretime:integer;
  TotalNum:integer;
  starttime :Tdatetime;             //                     '起始时间
  endtime :Tdatetime;             //                       '结束时间
  StartUserID :string;             //                '起始UserID
  EndUserID :string;             //                    '结束UserID
  LessNum :integer;             //                     '小于基准受理时间个数
  lesswaitnum:integer;

  hours :integer;
  hh:integer;
  qr:TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
        listview.Columns.Clear;
        listview.Clear;
        ProgressBar.Position:=0;
        hours :=round((sdjssj-sdkssj)* 24);
        for i:=0 to 10 do
           listview.Columns.add;
        listview.Columns[0].Caption:='  从  ';
        listview.Columns[1].Caption:='  到  ';
        listview.Columns[2].Caption:=ttl_cz+'人数';
        listview.Columns[3].Caption:=ttl_fz+'人数';
        listview.Columns[4].Caption:='等候人数';
        listview.Columns[5].Caption:='员工数';
        listview.Columns[6].Caption:='平均等待时间';
        listview.Columns[7].Caption:='最长等待时间';
   //     listview.Columns[8].Caption:='平均受理时间';
   //     listview.Columns[9].Caption:='最长受理时间';
        listview.Columns[8].Caption:='弃号人数';
        listview.Columns[9].Caption:='等待<X';
        listview.Columns[10].Caption:='等待<Y(%)';

        for i:=0 to 10 do
        begin
            listview.columns[i].Alignment:=taCenter;
            listview.Columns[i].Width:=(Length(listview.Columns[i].Caption)) * ListView.Font.Size ;
        end;
        progressbar.Position:=10;
        wherestr:=' and hszh=' + inttostr(gblhszh);
        if length(ksid)>0 then
        begin
            wherestr:=wherestr+ ' and ksid='''  + ksid +'''' ;
        end;
        if length(yhid)>0 then
        begin
            wherestr:=wherestr + ' and yhid=''' + yhid + '''';
        end;

        for i :=0 to hours do
        begin
            //日期
            listitem:=listview.Items.Add;
            hh:=round((sdkssj-int(sdkssj))*24)+i;
            listitem.Caption:=inttostr(hh) + ':00';
            for j:=0 to 12 do
            begin
                listitem.SubItems.add('');
            end;
            //星期
            listitem.subitems[0]:=inttostr(hh+1) + ':00' ;
            //取得一天初诊人数
            qr.Close;
            qr.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where (ztbz=1 or ztbz=5  or ztbz=7) and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj)+ ''''+
                                       ' and '''+ cdatetostr(jssj)+''''+
                                       ' and datepart(hh,jzsj)=' + inttostr(hh) +
                                       wherestr  ;
            qr.Open;
            listitem.SubItems[1]:=qr.Fields.Fields[0].AsString;
            //加到总的初诊人数
            TotalFristCure := TotalFristCure + qr.Fields.Fields[0].AsInteger;
            //取得一天复诊人数;
            qr.Close;
            qr.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where ztbz=2 and jzbz=''0'' '+
                                       ' and jzsj between ''' + cdatetostr(kssj)+ ''''+
                                       ' and '''+ cdatetostr(jssj)+''''+
                                       ' and datepart(hh,jzsj)=' + inttostr(hh) +
                                       wherestr  ;
            qr.Open;
            listitem.SubItems[2]:=qr.Fields.Fields[0].AsString;
            //加到总的复诊人数。
            TotalSecCure := TotalSecCure + qr.Fields.Fields[0].AsInteger;
            if length(yhid)=0 then
            begin
              //取得一天等待人数;
              qr.Close;
              qr.SQL.Text:=' select count(*) as num from t_jzjl '+
                                         ' where jzsj between ''' + cdatetostr(kssj)+ ''''+
                                         ' and '''+ cdatetostr(jssj)+''''+
                                         ' and datepart(hh,jzsj)=' + inttostr(hh) +
                                         //' and datepart(hh,jzsj)<>'+ inttostr(hh) +
                                         wherestr  ;
              qr.Open;
              listitem.SubItems[3]:=qr.Fields.Fields[0].AsString;
              //加到总的等待人数。
              TotalWaitNum := TotalWaitNum + qr.Fields.Fields[0].AsInteger;
            end;

            //取得当天上班医生人数
            qr.Close;
            qr.SQL.Text:=' select distinct YHID from t_jzjl '+
                                       ' where yhid is not null '+
                                       ' and jzsj between ''' + cdatetostr(kssj)+ ''''+
                                       ' and '''+ cdatetostr(jssj)+''''+
                                       ' and datepart(hh,jzsj)=' + inttostr(hh) +
                                       wherestr  ;
            qr.Open;
            listitem.SubItems[4]:=inttostr(qr.RecordCount);
            //加到总的上班医生人次数。
            TotalDoctNum := TotalDoctNum + qr.RecordCount;
            //取得平均等待时间
            qr.Close;
            qr.SQL.Text:=' select avg(datediff(n,ghsj,jzsj)) as numb from t_jzjl '+
                                       ' where ghsj is not null and jzsj is not null '+
                                       ' and jzsj between ''' + cdatetostr(kssj)+ ''''+
                                       ' and '''+ cdatetostr(jssj)+''''+
                                       ' and datepart(hh,jzsj)=' +inttostr(hh) +
                                       wherestr  ;
            qr.Open;
            listitem.SubItems[5]:=qr.Fields.Fields[0].AsString;
            tempavg := qr.Fields.Fields[0].asinteger;

            qr.Close;
            qr.SQL.Text:=' select count(*) as numb from t_jzjl '+
                                       ' where ghsj is not null and jzsj is not null '+
                                       ' and jzsj between ''' + cdatetostr(kssj)+ ''''+
                                       ' and '''+ cdatetostr(jssj)+''''+
                                       ' and datepart(hh,jzsj)=' + inttostr(hh) +
                                       wherestr  ;
            qr.Open;
            //加到总的等待时间
            TotalAvgWaitTime := TotalAvgWaitTime + tempavg * qr.Fields.Fields[0].asinteger;
            //       '总的平均等待时间

            TotalAvgWaitNum := TotalAvgWaitNum + qr.Fields.Fields[0].asinteger;
            qr.Close;

            //取得最长等待时间
            qr.SQL.Text:=' select max(datediff(n,ghsj,jzsj)) as numb from t_jzjl '+
                                       ' where ghsj is not null and jzsj is not null '+
                                       ' and jzsj between ''' + cdatetostr(kssj)+ ''''+
                                       ' and '''+ cdatetostr(jssj)+''''+
                                       ' and datepart(hh,jzsj)=' + inttostr(hh+1)+
                                       wherestr  ;
            qr.Open;
            listitem.SubItems[6]:=qr.Fields.Fields[0].AsString;
            //如果当天的最长等待时间，则取代原先的最长等待时间。
            if qr.Fields.Fields[0].asinteger>totalmaxwaittime then
               TotalMaxWaitTime:=  qr.Fields.Fields[0].asinteger;

            qr.Close;

            //取得一天弃号人数
            qr.Close;
            qr.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where (jzbz=''1'' or (ztbz=3 and jzbz=''0'')) '+
                                       ' and ghsj between ''' + cdatetostr(kssj)+ ''''+
                                       ' and '''+ cdatetostr(jssj)+''''+
                                       ' and datepart(hh,ghsj)=' + inttostr(hh) +
                                       wherestr  ;
            qr.Open;
            listitem.SubItems[7]:=qr.Fields.Fields[0].AsString;
            //加到总的弃号人数
            TotalQh := TotalQh + qr.Fields.Fields[0].AsInteger;

            //取得当天等待时间小于基准时间（BZDDSJ）的人数
            qr.Close;
            qr.SQL.Text:=' select count(*) as num from t_jzjl '+
                                       ' where ghsj is not null and jzsj is not null '+
                                       ' and jzsj between ''' + cdatetostr(kssj)+ ''''+
                                       ' and '''+ cdatetostr(jssj)+''''+
                                       ' and datepart(hh,jzsj)=' + inttostr(hh) +
                                       ' and datediff(n,ghsj,jzsj)<=' +  inttostr(bzddsj)+
                                       wherestr  ;
            qr.Open;
            lesswaitnum :=  qr.Fields.Fields[0].AsInteger;
            listitem.SubItems[8]:=inttostr(lesswaitnum);
            TotalWaitless := TotalWaitless + lesswaitnum;
             //取得当天就诊的病人人数
            qr.Close;
            qr.SQL.Text :=' select count(*) as num from t_jzjl '+
                                       ' where ghsj is not null and jzsj is not null '+
                                       ' and jzsj between ''' + cdatetostr(kssj)+ ''''+
                                       ' and '''+ cdatetostr(jssj)+''''+
                                       ' and datepart(hh,jzsj)=' + inttostr(hh) +
                                       wherestr  ;
            qr.Open;
            TotalWaitNum :=  qr.Fields.Fields[0].AsInteger;
            if TotalWaitNum > 0 then
               listitem.SubItems[9]:=inttostr(round((lesswaitnum / TotalWaitNum) * 100)) + '%'
            else
               listitem.SubItems[9]:='';//'不统计';
            progressbar.Position:=20+round((i/hours)*80)   ;
         end;
          //日期
        listitem:=listview.Items.Add;
        listitem.Caption:='合计';
        for j:=0 to 10 do
        begin
            listitem.SubItems.add('');
        end;
        listitem.SubItems[1]:=inttostr(TotalFristCure);
        listitem.SubItems[2]:=inttostr(TotalSecCure);
        listitem.SubItems[3]:=inttostr(TotalAvgWaitNum);
        listitem.SubItems[4]:=inttostr(TotalDoctNum);
     //   listitem.SubItems[5]:=inttostr(TotalDoctNum);
        If TotalAvgWaitNum > 0 Then
           listitem.SubItems[5]:=inttostr(round(TotalAvgWaitTime / TotalAvgWaitNum))
        else
           listitem.SubItems[5]:='';//'不统计';
        listitem.SubItems[6]:=inttostr(TotalMaxWaitTime);
         listitem.SubItems[7]:=inttostr(TotalQh);
         listitem.SubItems[8]:= inttostr(TotalWaitless);
        If TotalAvgWaitNum > 0 Then
           listitem.SubItems[9]:=  inttostr(round(TotalWaitless * 100 / TotalAvgWaitNum)) + '%'
        else
           listitem.SubItems[9]:= '';//'不统计';
        progressbar.Position:=100;
        result:=true;
    except
        begin
          listview.clear;
          progressbar.position:=0;
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;


//就诊时间分析 (ztbz  =1表示初诊，2表示复诊，0，表示初诊及复诊。
function Tdmdbaccess.SetJZSJFXlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const yhid:string;
             const yhmc:string;
             const bzjzsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime;
             const ztbz:integer;
             const noperson:boolean):boolean;
var
  listItem:Tlistitem;
  i,j:integer;

  cmdstr:widestring;
  wherestr:widestring;

  days:integer;
  starttime :Tdatetime;             //                     '起始时间
  endtime :Tdatetime;             //                       '结束时间
  startuserid:string;
  enduserid:string;


  jzsj:integer;//就诊的时间（分钟);
  sum:array [0..10] of integer;

  less5:integer;
  less10:integer;
  less15:integer;
  less20:integer;
  less25:integer;
  less30:integer;
  less40:integer;
  less60:integer;
  more60:integer;
  curenum:integer;
  lessYnum :integer;
  lessYB:integer;
  qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
        listview.Columns.Clear;
        listview.Clear;
        ProgressBar.Position:=0;
        for i:=0 to 13 do
           listview.Columns.add;
        listview.Columns[0].Caption:=' 日    期 ';
        listview.Columns[1].Caption:='星  期';
        listview.Columns[2].Caption:=' <05';
        listview.Columns[3].Caption:=' <10';
        listview.Columns[4].Caption:=' <15';
        listview.Columns[5].Caption:=' <20';
        listview.Columns[6].Caption:=' <25';
        listview.Columns[7].Caption:=' <30';
        listview.Columns[8].Caption:=' <40';
        listview.Columns[9].Caption:=' <60';
        listview.Columns[10].Caption:=' >60';
        listview.Columns[11].Caption:='受理人数';
        listview.Columns[12].Caption:='人数<Y';
        listview.Columns[13].Caption:='<Y(%)';
        for i:=0 to 13 do
            listview.Columns[i].Width:=(Length(listview.Columns[i].Caption)) * ListView.Font.Size ;
        progressbar.Position:=10;
        for i:=0 to 10 do
            sum[i]:=0;
        wherestr:=' and hszh=' + inttostr(gblhszh);
        if length(ksid)>0 then
        begin
            wherestr:=' and ksid='''  + ksid +'''' ;
        end;
        if length(yhid)>0 then
        begin
            wherestr:=wherestr + ' and yhid=''' + yhid + '''';
        end;

        days :=round(jssj-1-kssj);
        for i :=0 to days do
        begin

            qr.Close;
            //得到所有病人的就诊间隔时间。并且得到最长就诊间隔，及最小就诊间隔，总的就诊时间

            less5:=0;
            less10:=0;
            less15:=0;
            less20:=0;
            less25:=0;
            less30:=0;
            less40:=0;
            less60:=0;
            more60:=0;
            curenum:=0;
            lessYnum:=0;
            lessYB:=0;

            if ztbz=0 then
               cmdstr:=' select jzsj,yhid,jzjssj from t_jzjl  '+
                                       ' where  jzsj is not null ' +
                                       ' and jzbz=''0'' and ztbz in(1,2,5,7) '+
                                       ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                       wherestr +
                                       ' order by yhid,jzsj'
            else if ztbz=1 then
               cmdstr:=' select jzsj,yhid,jzjssj from t_jzjl  '+
                                       ' where  jzsj is not null ' +
                                       ' and jzbz=''0'' and (ztbz =1 or ztbz=5  or ztbz=7) '+
                                       ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                       wherestr +
                                       ' order by yhid,jzsj'
            else
               cmdstr:=' select jzsj,yhid,jzjssj from t_jzjl  '+
                                       ' where  jzsj is not null ' +
                                       ' and jzbz=''0'' and ztbz =2 '+
                                       ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                       wherestr +
                                       ' order by yhid,jzsj';


            qr.SQL.Text:=cmdstr;
            qr.Open;
            with qr do
            begin
               while not qr.Eof do
               begin
                  CureNum := CureNum + 1;
                  sum[9]:=sum[9]+1;
                  starttime:=fields.Fields[0].AsDateTime;
                  startuserid:=fields.Fields[1].asstring;
                  endtime:=fields.Fields[2].AsDateTime;

                  begin
                     //endtime:=fields.Fields[0].AsDateTime;
                     //enduserid:=fields.Fields[1].asstring;
                     //如果是同一医生
                     if True then //startuserid=enduserid then
                     begin
                        jzsj:=round((endtime-starttime)*24*60);
                        if jzsj<=bzjzsj then
                        begin
                           lessYnum:=lessYnum+1;
                           sum[10]:=sum[10]+1;
                        end;
                        if jzsj<=5 then
                        begin
                           less5:=less5+1;
                           sum[0]:=sum[0]+1;
                        end
                        else if jzsj<=10 then
                        begin
                           less10:=less10+1;
                           sum[1]:=sum[1]+1;
                        end
                        else if jzsj<=15 then
                        begin
                           less15:=less15+1;
                           sum[2]:=sum[2]+1;
                        end
                        else if jzsj<=20 then
                        begin
                           less20:=less20+1;
                           sum[3]:=sum[3]+1;
                        end
                        else if jzsj<=25 then
                        begin
                           less25:=less25+1;
                           sum[4]:=sum[4]+1;
                        end
                        else if jzsj<=30 then
                        begin
                           less30:=less30+1;
                           sum[5]:=sum[5]+1;
                        end
                        else if jzsj<=40 then
                        begin
                           less40:=less40+1;
                           sum[6]:=sum[6]+1;
                        end
                        else if jzsj<=60 then
                        begin
                           less60:=less60+1;
                           sum[7]:=sum[7]+1;
                        end
                        else
                        begin
                           more60:=more60+1;
                           sum[8]:=sum[8]+1;
                        end
                      end;
                   end;
                   qr.next;
               end;
               close;
            end;
            if noperson then
            begin
                if CureNum>0 then
                begin
                    //日期
                    listitem:=listview.Items.Add;
                    listitem.Caption:=cdatetostr(kssj+i);
                    for j:=0 to 13 do
                    begin
                        listitem.SubItems.add('');
                    end;
                    //星期
                    listitem.subitems[0]:= WeekdayStr(kssj+i);
                    listitem.subitems[1]:= inttostr(less5);
                    listitem.subitems[2]:= inttostr(less10);
                    listitem.subitems[3]:= inttostr(less15);
                    listitem.subitems[4]:= inttostr(less20);
                    listitem.subitems[5]:= inttostr(less25);
                    listitem.subitems[6]:= inttostr(less30);
                    listitem.subitems[7]:= inttostr(less40);
                    listitem.subitems[8]:= inttostr(less60);
                    listitem.subitems[9]:= inttostr(more60);
                    listitem.subitems[10]:= inttostr(curenum);
                    listitem.subitems[11]:= inttostr(lessYnum);
                    if curenum>0 then
                       listitem.subitems[12]:= inttostr(round((lessYnum/curenum) * 100))+'%'
                    else
                       listitem.subitems[12]:= '';//'不统计'   ;
                end
            end
            else
            begin
                    //日期
                    listitem:=listview.Items.Add;
                    listitem.Caption:=cdatetostr(kssj+i);
                    for j:=0 to 13 do
                    begin
                        listitem.SubItems.add('');
                    end;
                    //星期
                    listitem.subitems[0]:= WeekdayStr(kssj+i);
                    listitem.subitems[1]:= inttostr(less5);
                    listitem.subitems[2]:= inttostr(less10);
                    listitem.subitems[3]:= inttostr(less15);
                    listitem.subitems[4]:= inttostr(less20);
                    listitem.subitems[5]:= inttostr(less25);
                    listitem.subitems[6]:= inttostr(less30);
                    listitem.subitems[7]:= inttostr(less40);
                    listitem.subitems[8]:= inttostr(less60);
                    listitem.subitems[9]:= inttostr(more60);
                    listitem.subitems[10]:= inttostr(curenum);
                    listitem.subitems[11]:= inttostr(lessYnum);
                    if curenum>0 then
                       listitem.subitems[12]:= inttostr(round((lessYnum/curenum) * 100))+'%'
                    else
                       listitem.subitems[12]:= '';//'不统计'   ;
            end;
            progressbar.Position:=20+round((i/days)*80)   ;
        end;
        listitem:=listview.Items.Add;
        listitem.Caption:='合计';
        for j:=0 to 13 do
        begin
            listitem.SubItems.add('');
        end;
        listitem.SubItems[0]:='';
        for i:=1 to 11 do
            listitem.SubItems[i]:=inttostr(sum[i-1]);
        progressbar.Position:=100;
        result:=true;
    except
        begin
          listview.clear;
          progressbar.position:=0;
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

//等待时间分析
function Tdmdbaccess.SetDDSJFXlist(var ListView:TTeThemeSListView;
             var ProgressBar:TTeThemeProgressBar;
             const ksid :string;
             const ksmc :string;
             const yhid:string;
             const yhmc:string;
             const bzddsj:integer;
             const kssj:tdatetime;
             const jssj:tdatetime;
             const ztbz:integer;
             const noperson:boolean):boolean;
var
  listItem:Tlistitem;
  i,j:integer;

  cmdstr:widestring;
  wherestr:widestring;

  days:integer;
  starttime :Tdatetime;             //                     '起始时间
  endtime :Tdatetime;             //                       '结束时间
  ddsj:integer;//等待就诊的时间（分钟);


  less5:integer;
  less10:integer;
  less15:integer;
  less20:integer;
  less25:integer;
  less30:integer;
  less40:integer;
  less60:integer;
  more60:integer;
  curenum:integer;
  lessXnum :integer;
  lessXB:integer;
  sum:array [0..10] of integer;
  qr:TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
        listview.Columns.Clear;
        listview.Clear;
        ProgressBar.Position:=0;
        for i:=0 to 13 do
           listview.Columns.add;
        listview.Columns[0].Caption:=' 日    期 ';
        listview.Columns[1].Caption:='星  期';
        listview.Columns[2].Caption:=' <05';
        listview.Columns[3].Caption:=' <10';
        listview.Columns[4].Caption:=' <15';
        listview.Columns[5].Caption:=' <20';
        listview.Columns[6].Caption:=' <25';
        listview.Columns[7].Caption:=' <30';
        listview.Columns[8].Caption:=' <40';
        listview.Columns[9].Caption:=' <60';
        listview.Columns[10].Caption:=' >60';
        listview.Columns[11].Caption:=ttl_jz+'人数';
        listview.Columns[12].Caption:='人数<X';
        listview.Columns[13].Caption:='<X(%)';
        for i:=0 to 13 do
            listview.Columns[i].Width:=(Length(listview.Columns[i].Caption)) * ListView.Font.Size ;
        progressbar.Position:=10;
        wherestr:=' and hszh=' + inttostr(gblhszh);
        if length(ksid)>0 then
        begin
            wherestr:=wherestr +' and ksid='''  + ksid +'''' ;
        end;
        if length(yhid)>0 then
        begin
            wherestr:=wherestr + ' and yhid=''' + yhid + '''';
        end;

        days :=round(jssj-1-kssj);
        for i:=0 to 10 do
            sum[i]:=0;
        for i :=0 to days do
        begin
            qr.Close;
            //得到所有病人的就诊间隔时间。并且得到最长就诊间隔，及最小就诊间隔，总的就诊时间

            less5:=0;
            less10:=0;
            less15:=0;
            less20:=0;
            less25:=0;
            less30:=0;
            less40:=0;
            less60:=0;
            more60:=0;
            curenum:=0;
            lessxnum:=0;
            lessxB:=0;

            if ztbz=0 then
               cmdstr:=' select ghsj,jzsj from t_jzjl  '+
                                       ' where  jzsj is not null ' +
                                       ' and jzbz=''0'' and ztbz in(1,2,5,7) '+
                                       ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                       wherestr +
                                       ' order by yhid,jzsj'
            else if ztbz=1 then
               cmdstr:=' select ghsj,jzsj from t_jzjl  '+
                                       ' where  jzsj is not null ' +
                                       ' and jzbz=''0'' and (ztbz =1  or ztbz=5  or ztbz=7)'+
                                       ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                       wherestr +
                                       ' order by yhid,jzsj'
            else
               cmdstr:=' select ghsj,jzsj from t_jzjl  '+
                                       ' where  jzsj is not null ' +
                                       ' and jzbz=''0'' and ztbz =2 '+
                                       ' and datediff(day,jzsj,''' + cdatetostr(kssj+i)+ ''')=0'+
                                       wherestr +
                                       ' order by yhid,jzsj';


            qr.SQL.Text:=cmdstr;
            qr.Open;
            with qr do
            begin
               while not qr.Eof do
               begin
                  starttime:=fields.Fields[0].AsDateTime;
                  endtime:=fields.Fields[1].Asdatetime;
                  ddsj:=round((endtime-starttime)*24*60);
                  if ddsj<=bzddsj then
                  begin
                     lessXnum:=lessXnum+1;
                     sum[10]:=sum[10]+1;
                  end;
                  curenum:=curenum+1;
                  sum[9]:=sum[9]+1;
                  if ddsj<=5 then
                  begin
                     less5:=less5+1;
                     sum[0]:=sum[0]+1;
                  end
                  else if ddsj<=10 then
                  begin
                     less10:=less10+1;
                     sum[1]:=sum[1]+1;
                  end
                  else if ddsj<=15 then
                  begin
                     less15:=less15+1;
                     sum[2]:=sum[2]+1;
                  end
                  else if ddsj<=20 then
                  begin
                     less20:=less20+1;
                     sum[3]:=sum[3]+1;
                  end
                  else if ddsj<=25 then
                  begin
                     less25:=less25+1;
                     sum[4]:=sum[4]+1;
                  end
                  else if ddsj<=30 then
                  begin
                     less30:=less30+1;
                     sum[5]:=sum[5]+1;
                  end
                  else if ddsj<=40 then
                  begin
                     less40:=less40+1;
                     sum[6]:=sum[6]+1;
                  end
                  else if ddsj<=60 then
                  begin
                     less60:=less60+1;
                     sum[7]:=sum[7]+1;
                  end
                  else
                  begin
                     more60:=more60+1;
                     sum[8]:=sum[8]+1;
                  end;
                  next;
               end;
               close;
            end;
            if noperson  then
            begin
                if  (curenum>0) then
                begin
                      //日期
                      listitem:=listview.Items.Add;
                      listitem.Caption:=cdatetostr(kssj+i);
                      for j:=0 to 13 do
                      begin
                          listitem.SubItems.add('');
                      end;
                      //星期
                      listitem.subitems[0]:= WeekdayStr(kssj+i);

                      listitem.subitems[1]:= inttostr(less5);
                      listitem.subitems[2]:= inttostr(less10);
                      listitem.subitems[3]:= inttostr(less15);
                      listitem.subitems[4]:= inttostr(less20);
                      listitem.subitems[5]:= inttostr(less25);
                      listitem.subitems[6]:= inttostr(less30);
                      listitem.subitems[7]:= inttostr(less40);
                      listitem.subitems[8]:= inttostr(less60);
                      listitem.subitems[9]:= inttostr(more60);
                      listitem.subitems[10]:= inttostr(curenum);
                      listitem.subitems[11]:= inttostr(lessXnum);
                      if curenum>0 then
                         listitem.subitems[12]:= inttostr(round((lessxnum/curenum) * 100))+'%'
                      else
                         listitem.subitems[12]:='';// '不统计'   ;
                end;
            end
            else
            begin
                  //日期
                  listitem:=listview.Items.Add;
                  listitem.Caption:=cdatetostr(kssj+i);
                  for j:=0 to 13 do
                  begin
                      listitem.SubItems.add('');
                  end;
                  //星期
                  listitem.subitems[0]:= WeekdayStr(kssj+i);

                  listitem.subitems[1]:= inttostr(less5);
                  listitem.subitems[2]:= inttostr(less10);
                  listitem.subitems[3]:= inttostr(less15);
                  listitem.subitems[4]:= inttostr(less20);
                  listitem.subitems[5]:= inttostr(less25);
                  listitem.subitems[6]:= inttostr(less30);
                  listitem.subitems[7]:= inttostr(less40);
                  listitem.subitems[8]:= inttostr(less60);
                  listitem.subitems[9]:= inttostr(more60);
                  listitem.subitems[10]:= inttostr(curenum);
                  listitem.subitems[11]:= inttostr(lessXnum);
                  if curenum>0 then
                     listitem.subitems[12]:= inttostr(round((lessxnum/curenum) * 100))+'%'
                  else
                     listitem.subitems[12]:= '';//'不统计'   ;
            end;
            progressbar.Position:=20+round((i/days)*80)   ;
        end;
            listitem:=listview.Items.Add;
            listitem.Caption:= '合计';
            for j:=0 to 13 do
            begin
                listitem.SubItems.add('');
            end;
            listitem.SubItems[0]:='';
            for i:=1 to 11 do
              listitem.subitems[i]:= inttostr(sum[i-1]);
  {          listitem.subitems[2]:= inttostr(less10);
            listitem.subitems[3]:= inttostr(less15);
            listitem.subitems[4]:= inttostr(less20);
            listitem.subitems[5]:= inttostr(less25);
            listitem.subitems[6]:= inttostr(less30);
            listitem.subitems[7]:= inttostr(less40);
            listitem.subitems[8]:= inttostr(less60);
            listitem.subitems[9]:= inttostr(more60);
            listitem.subitems[10]:= inttostr(curenum);
            listitem.subitems[11]:= inttostr(lessXnum);
  }
        progressbar.Position:=100;
        result:=true;
    except
        begin
          listview.clear;
          progressbar.position:=0;
          result := False;
          Exit;
        end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

//将Listview中的数据转到EXCEL工作表中

function Tdmdbaccess.ListViewToExcel(var listview:TTeThemeSListView;
          var progressbar:TTeThemeProgressBar;
         const BBTitle:string;
         const BBTitle1:string;
         const BBTitle2:string;
         const BBYHMC:string):boolean ;
var
  xl:Variant;
  r :integer;
  c :integer;
  c1:integer;
  sheetnum:integer;
  i:integer;
  row2 :string;
  CurR:integer;
  linepersheet:integer;
begin
  inherited;
  try
     progressbar.Position:=0;
       xl := CreateoleObject('Excel.Application');
       xl.Visible := True;
       xl.Caption := '应用程序调用 Microsoft Excel';
       xl.Workbooks.Add;
     progressbar.Position:=20;
     linepersheet:=listview.Items.Count;//
       sheetnum:=listview.Items.Count div linepersheet;
       if listview.Items.Count mod linepersheet>0 then
          sheetnum:= sheetnum+1;
       ///       '有多张表
       if sheetnum>3 then
          for i:=3 to sheetnum do
              xl.worksheets.add;
       For i := 1 To SheetNum do
       begin
           xl.WorkSheets[i].Activate;
///           '打标题，合并A1到A+Tolcolnum
           xl.Range['A1'].ColumnWidth:=3;
           xl.Range['B1', chr(65+listview.Columns.count)+'1'].Merge ;
           xl.Range['B1'].Value := '工作量分析表';
           xl.Range['B1'].VerticalAlignment := xlCenter ;
           xl.Range['B1'].HorizontalAlignment := xlCenter;
           xl.Range['B1'].Font.Size := 18;
           xl.range['B1'].font.bold:=true;
 //          '项目名称和x,y等
           xl.Range['B2',  chr(65+listview.Columns.count)+'2'].Merge;
           xl.Range['B2'].VerticalAlignment:= xlCenter;
           xl.Range['B2'].HorizontalAlignment := xlleft;
           xl.Range['B2'].Font.Size := 10;
           xl.Range['B2'].Value := BBTitle1;

           xl.Range['B3',  chr(65+listview.Columns.count)+'3'].Merge;
           xl.Range['B3'].VerticalAlignment:= xlCenter;
           xl.Range['B3'].HorizontalAlignment := xlleft;
           xl.Range['B3'].Font.Size := 10;
           xl.Range['B3'].Value := BBTitle2;
           xl.Range['B3'].RowHeight:= 20;

           //'设置列宽
           For c := 0 To listview.Columns.Count-1 do
           begin
               row2:=chr(65+c+1)+ '1';
               xl.Range[row2].ColumnWidth :=length(listview.Columns[c].Caption) ;
           end;
           //设置列标题。
           for c:=0 to listview.Columns.Count-1 do
           begin
              row2:=chr(65+c+1) + '4';
               xl.Range[row2].select;
               xl.ActiveCell.value:=listview.Columns[c].Caption;
               xl.ActiveCell.HorizontalAlignment := xlCenter;
               xl.ActiveCell.VerticalAlignment := xlCenter;
               xl.ActiveCell.Font.Size := 10;
               xl.activecell.font.bold:=true;
           end;
           //'计算本页的行数
           CurR := 5;
           For r := (i - 1) * linepersheet  To i * linepersheet-1  do
           begin
               If r < listview.Items.Count  Then
               begin
                  c1 := 1;
//                  '写入每一行中的列
                  For c := 0 To listview.Columns.Count-1 do
                  begin
                         row2:= Chr(65 + c1) + inttostr(CurR);
                         xl.Range[row2].Select;
                         if c=0 then
                            xl.ActiveCell.Value := '''' +listview.Items[r].Caption
                         else
                            xl.ActiveCell.Value := '''' +listview.Items[r].SubItems[c-1];
//                         '设置列格式
                         xl.ActiveCell.HorizontalAlignment := xlCenter;
                         xl.ActiveCell.VerticalAlignment := xlCenter;
                         xl.ActiveCell.Font.Size := 10;
                         c1 := c1 + 1;
                  end;
               end
               Else
               begin
//                  '写空的列
                  For c1 := 0 To listview.Columns.Count-1 do
                  begin
                      row2:= Chr(65 + c1+1) + inttostr(CurR);
                      xl.Range[row2].Select;
                      xl.ActiveCell.Value := '';
                  end;
               end;
               CurR := CurR + 1;
           end;
           progressbar.Position:=20+round(r/listview.items.count)*80;
//           '画边线
           xl.Range['B4', chr(65+listview.Columns.count)+inttostr(linepersheet+4)].Borders.LineStyle := xlContinuous;
           xl.Range['B4',  chr(65+listview.Columns.count)+inttostr(linepersheet+4)].Borders.Weight := xlThin;

           xl.Range['B'+inttostr(linepersheet+5),  chr(65+listview.Columns.count)+inttostr(linepersheet+5)].Merge;
           xl.Range['B'+inttostr(linepersheet+5)].Font.Size := 9;
           xl.Range['B'+inttostr(linepersheet+5)].Value := '制表时间：' + cdatetostr(date) +' '+ ctimetostr(time) +'    ' + '制表员:'+ BBYHMC + '          '+  '第' + inttostr(i)+  '页/共' + inttostr(sheetnum) +'页';
       end;
     progressbar.Position:=100;
     result:=true;
  except
      begin
        listview.clear;
        progressbar.position:=0;
        result := False;
        Exit;
      end;
  end;
end;
//将Listview中的数据转到EXCEL工作表中

function Tdmdbaccess.ListViewToExcelEx(var listview:TTeThemeSListView;
          var progressbar:TTeThemeProgressBar;
         const BBTitle:string;
         const BBTitle1:string;
         const BBTitle2:string;
         const BBYHMC:string;
         const aline:integer):boolean ;
var
  xl:Variant;
  r :integer;
  c :integer;
  c1:integer;
  sheetnum:integer;
  i:integer;
  row2 :string;
  CurR:integer;

begin
  inherited;
  try
     progressbar.Position:=0;
       xl := CreateoleObject('Excel.Application');
       xl.Visible := False;
       xl.Caption := '应用程序调用 Microsoft Excel';
       xl.Workbooks.Add;
     progressbar.Position:=20;
       sheetnum:=listview.Items.Count div aline;
       if listview.Items.Count mod aline>0 then
          sheetnum:= sheetnum+1;
       ///       '有多张表
       if sheetnum>3 then
          for i:=4 to sheetnum do
              xl.worksheets.add;
       For i := 1 To SheetNum do
       begin
           xl.WorkSheets[i].Activate;
           xl.WorkSheets[i].Name := '第'+inttostr(i)+'页' ;
///           '打标题，合并A1到A+Tolcolnum
           xl.Range['A1'].ColumnWidth:=1;
           xl.Range['B1', chr(65+listview.Columns.count)+'1'].Merge ;
           xl.Range['B1'].Value := BBTitle;
           xl.Range['B1'].VerticalAlignment := xlCenter ;
           xl.Range['B1'].HorizontalAlignment := xlCenter;
           xl.Range['B1'].Font.Size := 18;
           xl.range['B1'].font.bold:=true;
 //          '项目名称和x,y等
           xl.Range['B2',  chr(65+listview.Columns.count)+'2'].Merge;
           xl.Range['B2'].VerticalAlignment:= xlCenter;
           xl.Range['B2'].HorizontalAlignment := xlleft;
           xl.Range['B2'].Font.Size := 10;
           xl.Range['B2'].Value := BBTitle1;

           xl.Range['B3',  chr(65+listview.Columns.count)+'3'].Merge;
           xl.Range['B3'].VerticalAlignment:= xlCenter;
           xl.Range['B3'].HorizontalAlignment := xlleft;
           xl.Range['B3'].Font.Size := 6;
           xl.Range['B3'].Value := BBTitle2;
           xl.Range['B3'].RowHeight:= 5;

           //'设置列宽
           For c := 0 To listview.Columns.Count-1 do
           begin
               row2:=chr(65+c+1)+ '1';
               xl.Range[row2].ColumnWidth :=length(listview.Columns[c].Caption) ;
           end;
           //设置列标题。
           for c:=0 to listview.Columns.Count-1 do
           begin
              row2:=chr(65+c+1) + '4';
               xl.Range[row2].select;
               xl.ActiveCell.value:=listview.Columns[c].Caption;
               xl.ActiveCell.HorizontalAlignment := xlCenter;
               xl.ActiveCell.VerticalAlignment := xlCenter;
               xl.ActiveCell.Font.Size := 10;
               xl.activecell.font.bold:=true;
           end;
           //'计算本页的行数
           CurR := 5;
           For r := (i - 1) * aline  To i * aline-1  do
           begin
               If r < listview.Items.Count  Then
               begin
                  c1 := 1;
//                  '写入每一行中的列
                  For c := 0 To listview.Columns.Count-1 do
                  begin
                         row2:= Chr(65 + c1) + inttostr(CurR);
                         xl.Range[row2].Select;
                         if c=0 then
                            xl.ActiveCell.Value := '''' +listview.Items[r].Caption
                         else
                            xl.ActiveCell.Value := '''' +listview.Items[r].SubItems[c-1];
//                         '设置列格式
                         xl.ActiveCell.HorizontalAlignment := xlCenter;
                         xl.ActiveCell.VerticalAlignment := xlCenter;
                         xl.ActiveCell.Font.Size := 10;
                         c1 := c1 + 1;
                  end;
               end
               Else
               begin
//                  '写空的列
                  For c1 := 0 To listview.Columns.Count-1 do
                  begin
                      row2:= Chr(65 + c1+1) + inttostr(CurR);
                      xl.Range[row2].Select;
                      xl.ActiveCell.Value := '';
                  end;
               end;
               CurR := CurR + 1;
           end;
           progressbar.Position:=20+round(r/listview.items.count)*80;
//           '画边线
           xl.Range['B4', chr(65+listview.Columns.count)+inttostr(aline+4)].Borders.LineStyle := xlContinuous;
           xl.Range['B4',  chr(65+listview.Columns.count)+inttostr(aline+4)].Borders.Weight := xlThin;

           xl.Range['B'+inttostr(aline+5),  chr(65+listview.Columns.count)+inttostr(aline+5)].Merge;
           xl.Range['B'+inttostr(aline+5)].Font.Size := 9;
           xl.Range['B'+inttostr(aline+5)].Value := '制表时间：' + cdatetostr(date) +' '+ ctimetostr(time) +'    ' + '制表员:'+ BBYHMC + '          '+  '第' + inttostr(i)+  '页/共' + inttostr(sheetnum) +'页';
       end;
     progressbar.Position:=100;
     xl.Visible := True;
     result:=true;
  except
      begin
        listview.clear;
        progressbar.position:=0;
        result := False;
        Exit;
      end;
  end;
end;
    // 检查时间段复位。
function Tdmdbaccess.CheckSjdFw(const Sj:Tdatetime):boolean;
var
tmpsjdbz:integer;
tmpkssj:string;
tmpjssj:string;
rest:boolean;
qr:TADOQuery;
cmdstr:string;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      tmpsjdbz:=0;
      qr.Close;
      //查询科室信息.
      qr.SQL.Text:='SELECT sjdbz,sjdmc,sjdkssj,sjdjssj '+
                ' from t_sjdsz ' +
                ' WHERE HSZH =' + inttostr(gblhszh) +
                ' and CONVERT(datetime, CONVERT(varchar(10), SJDKSSJ, 8), 102) <=convert(datetime,'''+ ctimetostr(time)+''''+',102)' +
                ' and CONVERT(datetime, CONVERT(varchar(10), SJDJSSJ, 8), 102) >convert(datetime,'''+ ctimetostr(time)+''''+',102)' ;

      qr.Open;
      with qr do
      begin
         if  not qr.Eof then
         begin
            tmpsjdbz:=fields.Fields[0].AsInteger;
            tmpkssj:=ctimetostr(fields.Fields[2].AsDateTime);
            tmpjssj:=ctimetostr(fields.Fields[3].AsDateTime);
         end;
         Close;
      end;
      if tmpsjdbz<>gblsjdbz then
      begin
        if gblSJDFW=1 then
        begin
           if gblblts<=0 then
           begin
             cmdstr:='delete from t_xsxx where hszh='+inttostr(gblhszh);
             ADOConnection.execute(cmdstr,cmdtext);
           end
           else
           begin
             cmdStr :='delete from t_xsxx where ztbz=0 and hszh='+inttostr(gblhszh);
             ADOConnection.execute(cmdstr,cmdtext);
           end;
   //      需要复位。
           rest := QingChuSJD(gblsjdbz,1);
           //rest:=QingChu(tmpkssj,tmpjssj,0,0,1);
        end;
         gblsjdbz:=tmpsjdbz;
         result:=true;
      end
      else
          result:=false;

    //dddd/
    except
       result:=false;
       exit;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
    // 检查时间段复位。
function Tdmdbaccess.CheckZDFw():integer;
var
tmpzdfw:integer;
qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      tmpzdfw:=0;
      qr.Close;
      //查询科室信息.
      qr.SQL.Text:='SELECT ZDFW '+
                ' from t_ZDFW ' +
                ' WHERE HSZH =' + inttostr(gblhszh);
      qr.Open;
      with qr do
      begin
         if  not qr.Eof then
         begin
            tmpzdfw:=fields.Fields[0].AsInteger;
         end;
         Close;
      end;
      result:=tmpzdfw;
    except
       result:=0;
       exit;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
   //终端取号
function Tdmdbaccess.ZDQuHao(const AJH:string):Boolean;
var
  ksid:string; //科室ID
  ksmc:string; //科室名称;
  ajmc:string;//按键名称
  retB:boolean;
  qr : TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try

       qr.Close;
       qr.SQL.Text:=' select t_qhajsz.ksid,t_ks.ksmc,ajmc from t_QHAJSZ ' +
                ' inner join t_ks on t_Qhajsz.ksid =t_ks.ksid and t_qhajsz.hszh=t_ks.hszh ' +
                ' where ajh=' + ajh +''+
                ' and t_qhajsz.hszh=' + inttostr(gblhszh);
       qr.Open;
       with qr do
       begin
          if not qr.Eof then
          begin
             ksid:=fields.Fields[0].AsString;
             ksmc:=fields.Fields[1].AsString;
             ajmc:=fields.Fields[2].AsString;
             retB:=quhao(ksid,ksmc,'','','',ajmc,'','','','','','');
          end
          else
          begin
             result:=false;
             close;
             exit;
          end;
          close;
       end;
      result:=true;
    except
      begin
        result := False;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

{function TdmDBAccess.SetItems_temp(var XComboBox: TXTeThemeComboBox;
  const TypeName: string): Boolean;
var
  Items: TStrings;
  IDItems: TStrings;
begin
  Items := TStringList.Create;
  IDItems := TStringList.Create;
  try
    with ADOStoredProc do
    begin
      ProcedureName  := 'MY_GetItems';
      Parameters.Clear;
      Parameters.CreateParameter('TypeName',
        ftString, pdInput, 128, TypeName);
      Parameters.CreateParameter('gblHSZH',
        ftInteger, pdInput, 4, gblHSZH);
      Open;

      while not ADOStoredProc.Eof do
      begin
          if (TypeName <> 'PDWB') AND (TypeName <> 'XSZD')  AND (TypeName <> 'XSFS')  then
          begin
            Items.Add(Fields[0].AsString
              + '.' + Fields[1].AsString);
            IDItems.Add(Fields[0].AsString);
            Next;
          end
          else
          begin
            Items.Add(Fields[0].AsString);
            IDItems.Add(Fields[0].AsString);
            Next;
          end;
      end;

      Close;
    end;

    XComboBox.Items := Items;
    XComboBox.IDItems := IDItems;
    Items.Clear;
    IDItems.Clear;
  except
    begin
      result := False;
      Exit;
    end;
  end;
  result := True;
end;
}
function TdmDBAccess.YHstopCall(const zdid, cmd: string): string;
var
    zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string;
    qr:TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
   try
        qr.Close;
        //在等待T_hjzd表中查找zdid.
        qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                                ' t_hjzd left outer join t_yh on ' +
                                ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                                ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
        qr.Open;
        ///////////将中.
        with qr do
        begin
           if not qr.Eof  then
             begin
              zdyhid:=fields.fields[4].asstring ;
              zdyhmc:=fields.fields[5].asstring;
              fjh:=fields.Fields[1].AsString;
              fjmc:=fields.Fields[6].AsString;
              zth:=fields.Fields[2].AsString;
              ztmc:=fields.Fields[3].AsString;
              if ( zdyhid <>'')  then
                 begin
                 close;
                 end
              else
                 begin
                 if (cmd='37') or (cmd='67') then
                 result:=zdid+cmd + '还没有登录!    请登录工号'
                 else
                 result:=zdid+cmd + '028888';///没有登录.
                 close;
                 exit;
                 end;
              end
           else
             begin
               if (cmd='37') or (cmd='67') then
               result:=zdid+cmd + '无此呼叫器!    请管理员设置!'
               else
               result:=zdid + cmd + '038888';  ///没有此呼叫器
               close ;
               exit;
             end;
        end;
        WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,'','','暂停服务','',ZDYHID,ZDYHMC,'','','',0,1,'','','');
        if (cmd='37') or (cmd='67') then
        result:=zdid+cmd + '暂停成功!     '
        else
        result:=zdid + cmd + '017777';  //已经发出暂停信号
        adoquery.SQL.Clear;
        adoquery.sql.Text:=' update t_hjzd set zt=''暂停'',state=''暂停'' '+
                           ',calltime=getdate()'+
                           ' where hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid;
        adoquery.ExecSQL;
        if (gblCallWithGrpState=1) and (gblCallWithGrpStateAtPause=1) then
          ChangeFirstGrpState(zdyhid,0);
   except
         if (cmd='37') or (cmd='67') then
         result:=zdid+cmd + '暂停失败!    '
         else
         result:=zdid + cmd + '007788';  //发出暂停信号失败
   end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.YHcontinueCall(const zdid, cmd: string): string;
var
    zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string;
    hjksnum:integer;
    intFieldsIndex:integer;
    hjks:array[1..20] of CallGroup_Info;
//    hjksid:array [1..3] of string;
//    hjksmc:array [1..3] of string;
    qr:TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
   try
        qr.Close;
        //在等待T_hjzd表中查找zdid.
        qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                                ' t_hjzd left outer join t_yh on ' +
                                ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                                ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
        qr.Open;
        ///////////将中.
        with qr do
        begin
           if not qr.Eof  then
             begin
              zdyhid:=fields.fields[4].asstring ;
              zdyhmc:=fields.fields[5].asstring;
              fjh:=fields.Fields[1].AsString;
              fjmc:=fields.Fields[6].AsString;
              zth:=fields.Fields[2].AsString;
              ztmc:=fields.Fields[3].AsString;
              if ( zdyhid <>'')  then
                 begin
                 close;
                 end
              else
                 begin
                 if (cmd='37') or (cmd='67') then
                 result:=zdid+cmd + '还没有登录!    请登录工号'
                 else
                 result:=zdid+cmd + '028888';///没有登录.
                 close;
                 exit;
                 end;
              end
           else
             begin
                 if (cmd='37') or (cmd='67') then
                 result:=zdid+cmd + '无此呼叫器!    请管理员设置!'
                 else
                 result:=zdid + cmd + '038888';  ///没有此呼叫器
               close ;
               exit;
             end;
        end;
              qr.close;
              qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
                        ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
                        ' FROM t_YH LEFT OUTER JOIN ' +
                        ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
                        ' LEFT OUTER JOIN  ' +
                        ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
                        ' LEFT OUTER JOIN  ' +
                        ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
                        ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
              qr.Open;

             //登出后显示暂停服务
               if not qr.Eof  then
               begin
//                  hjksnum:=1;
//                  for intFieldsIndex:=2 to 7 do
//                  begin
//                      if intFieldsIndex mod 2 =0 then Continue ;
//                      if qr.fields.fields[intFieldsIndex].asstring<>''  then
//                         begin
//                           hjksid[hjksnum]:=qr.fields.Fields[intFieldsIndex-1].AsString;
//                           hjksmc[hjksnum]:=qr.fields.Fields[intFieldsIndex].AsString;
//                           hjksnum:=hjksnum+1;
//                         end;
//                  end;
                  GetYHCallKS(zdyhid,hjksnum,hjks);
                  if hjksnum>0 then
                   begin
                     WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[1].TGroupid,hjks[1].TGroupName,'继续服务','',ZDYHID,ZDYHMC,'','','',0,1,'','','');
                   end
                   else
                   begin
                     WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,'','','继续服务','',zdyhid,ZDYHMC,'','','',0,1,'','','');
                   end;
                   qr.close;
                   if (gblCallWithGrpState=1) and (gblCallWithGrpStateAtPause=1) then
                    ChangeFirstGrpState(zdyhid,1);
               end
               else
               begin
                   qr.Close;
               end;

//        WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,'','','继续服务','',ZDYHID,ZDYHMC,'','',0,1);
         if (cmd='37') or (cmd='67') then
         result:=zdid+cmd + '取消暂停成功!  '
         else
         result:=zdid + cmd + '016666';  //已经发出暂停信号
        adoquery.SQL.Clear;
        adoquery.sql.Text:=' update t_hjzd set zt=''继续'',state=''继续'' '+
                           ',calltime=getdate()'+
                           ' where hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid  ;
        adoquery.ExecSQL;
        //
    //if gblzbrs>0 then   //20131114修改
    begin
      //在等待T_YH表中查找YHID信息.
      qr.SQL.Clear;
      qr.Parameters.Clear;
      qr.SQL.Text :='select y.yhid,y.yhmc,yk.ksid,k.ksmc '+
          ' from t_yh y,t_yh_ks yk,t_ks k '+
          ' where y.hszh=yk.hszh and y.yhid=yk.yhid '+
          ' and yk.hszh=k.hszh and yk.ksid=k.ksid'+
          ' and yk.seq=1'+
          ' and y.hszh=:p1 and y.yhid=:p2';
      qr.Parameters.ParamByName('p1').Value :=gblHSZH;
      qr.Parameters.ParamByName('p2').Value :=zdyhid;
      qr.Open;
      ///////////将中.
      with qr do
      begin
         if not qr.Eof  then
         begin
//            hjksnum:=1;
//            for intFieldsIndex:=2 to 7 do
//            begin
//                if intFieldsIndex mod 2 =0 then Continue ;
//                if fields.fields[intFieldsIndex].asstring<>''  then
//                   begin
//                     hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                     hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                     hjksnum:=hjksnum+1;
//                   end;
//            end;
            if (hjksnum>0) and (dmDBAccess.DB_GetGroupPrepareCount(hjks[1].TGroupid)>0) then
             begin
               WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[1].TGroupid,hjks[1].TGroupName,'','',ZDYHID,ZDYHMC,'','','',0,1,'','','');
                 gbledit_ks[gbledit_ks_count].ksid:=hjks[1].TGroupid;
                 gbledit_ks[gbledit_ks_count].ksmc:=hjks[1].TGroupName;
                 gbledit_ks_count:=gbledit_ks_count+1;
             end;
             close;
         end
         else
         begin
             Close;
         end;
      end;
    end;


   except
         if (cmd='37') or (cmd='67') then
         result:=zdid+cmd + '取消暂停失败!  '
         else
         result:=zdid + cmd + '006688';  //发出暂停信号失败
   end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.GetZDZT(const zdid: string): string;
var
    zdyhid,zdyhmc,fjh,fjmc,zth,ztmc,zt:string;
    qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
     try
          qr.Close;
          //在等待T_hjzd表中查找zdid.
          qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc,zt from  ' +
                                  ' t_hjzd left outer join t_yh on ' +
                                  ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                                  ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
          qr.Open;
          ///////////将中.
          with qr do
          begin
             if not qr.Eof  then
               begin
                zdyhid:=fields.fields[4].asstring ;
                zdyhmc:=fields.fields[5].asstring;
                fjh:=fields.Fields[1].AsString;
                fjmc:=fields.Fields[6].AsString;
                zth:=fields.Fields[2].AsString;
                ztmc:=fields.Fields[3].AsString;
                zt:=fields.Fields[7].AsString ;
                if ( zdyhid <>'')  then
                   begin
                   close;
                   end
                else
                   begin
                   result:='没有登录';///没有登录.
                   close;
                   exit;
                   end;
                end
             else
               begin
                 result:='';  ///没有此呼叫器
                 close ;
                 exit;
               end;
          end;
          //WriteDispMsgTT(zdid,fjh,fjmc,zth,'','','继续服务','',ZDYHID,ZDYHMC,'','',0);
          result:=zt;  //返回呼叫器状态
     except
          result:='';  //
     end;
  finally
    FreeAndNil(qr);
  end;
end;
function TdmDBAccess.GetRoom(const ARoomName: string): string;
var
    fjh:string;
    qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
     try
          qr.Close;
          //在等待T_hjzd表中查找zdid.
          qr.SQL.Text:=' select zdid from t_hjzd ' +
                                  ' where hszh=' + inttostr(gblhszh) + ' and fjmc=''' + ARoomName +'''';
          qr.Open;
          ///////////将中.
          with qr do
          begin
             if not qr.Eof  then
             begin
                fjh:=fields.Fields[0].AsString;
                Result :='01'+fjh;
             end
             else
             begin
               result:='01'+'1';  ///没有此呼叫器
               close ;
               exit;
             end;
          end;
     except
          result:='01'+'1';   //
     end;
  finally
    FreeAndNil(qr);
  end;
end;
//得到终端ID（参数:用户id,房间号）
function TdmDBAccess.GetZDID(const Ayhid: string;const Afjh:string): string;
var
    zdid:string;
    qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
     try
          qr.Close;
          //在等待T_hjzd表中查找zdid.
          qr.SQL.Text:=' select zdid from t_hjzd ' +
                                  ' where hszh=' + inttostr(gblhszh) +
                                  ' and yhid=' + quotedstr(Ayhid)+
                                  ' and fjh='+Afjh;
          qr.Open;
          ///////////将中.
          with qr do
          begin
             if not qr.Eof  then
             begin
                zdid:=fields.Fields[0].AsString;
                if zdid='' then
                  zdid :='00';
                if length(zdid)<2 then
                  zdid :='0'+zdid;
                Result :=zdid;
             end
             else
             begin
               result:='00';  ///没有此呼叫器
               close ;
               exit;
             end;
          end;
     except
          result:='00';   //
     end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.GetDBValue(const TypeName,ID,AfieldName:string): string;
var
    qr:TAdoquery;
    tmpstr:string;
begin
   qr:=Tadoquery.Create(nil);
   qr.Connection:=adoconnection;
   try
      if  typename ='HJZD' then
         tmpstr:='select '+Afieldname+' from t_hjzd'+
                 ' where zdid='+id +' and hszh='+inttostr(gblhszh)
      else if typename ='YH' then
         tmpstr:='select '+Afieldname+' from t_yh'+
                 ' where yhid='''+id +''' and hszh='+inttostr(gblhszh)
      else if TypeName ='KS' then
         tmpstr:='select '+Afieldname+' from t_ks'+
                 ' where ksid='''+id +''' and hszh='+inttostr(gblhszh)
      else if TypeName ='XSZD' then
         tmpstr:='select '+Afieldname+' from t_xszd'+
                 ' where xspid='''+id +''' and hszh='+inttostr(gblhszh)
      else if TypeName ='ZSLX' then
         tmpstr:='select '+Afieldname+' from t_RoomType'+
                 ' where Type='''+id +''''
      else if TypeName =D012 then
         tmpstr:='select '+Afieldname+' from t_qhajsz'+
                 ' where ajh='+id
      else if TypeName ='JZZT' then
         tmpstr:='select '+Afieldname+' from t_jzzt'+
                 ' where ztbz='+id +
                 ' and hszh='+inttostr(gblhszh)
      else if TypeName =D030 then
         tmpstr:='select '+Afieldname+' from t_yh_ks_week'+
                 ' where yhid='+quotedstr(id) +
                 ' and hszh='+inttostr(gblhszh)
      else if TypeName ='DQSJ' then
         tmpstr:='select convert(varchar,getdate(),120) '
      else if TypeName =D013 then
         tmpstr:='select '+Afieldname+' from t_ks_xszd'+
                 ' where ksid='+quotedstr(id) +
                 ' and hszh='+inttostr(gblhszh)
      else if TypeName ='DHXX' then
         tmpstr:='select '+Afieldname+' from t_dhxx'+
                 ' where id='+(id)
//                 +' and hszh='+inttostr(gblhszh)
      else
         tmpstr:='select '''' ';
      qr.SQL.Text:=tmpstr;
      qr.Open;
      if qr.Eof then
         result:=''
      else
      begin
         result:=qr.fields.fields[0].asstring;
         if (Afieldname='priorityid') or
            (Afieldname='LC') then
          begin
            if Result='' then Result:='0';
          end;
      end;
      qr.Close;
      FreeAndNil(qr);
   except
     if TypeName='KS' then
        if Afieldname='yysjdjh' then Result :=''
        else if Afieldname='opencheckin' then Result :='1'
        else  Result :='0'
     else if TypeName ='ZSLX' then
        Result :='0'
     else if TypeName ='HJZD' then
        Result :='0'
     else
        result:='';  //
        FreeAndNil(qr);
   end;
end;
function TdmDBAccess.SetDBValue(const TypeName,ID,AFieldName,AValue:string): boolean;
var
    qr:TAdoquery;
    tmpstr:string;
begin
   qr:=Tadoquery.Create(nil);
   qr.Connection:=adoconnection;
   try
      if  typename ='HJZD' then
         tmpstr:='update t_hjzd set '+Afieldname+'='+(Avalue)+
                 ' where zdid='+id+' and hszh='+inttostr(gblhszh)
      else if typename ='YH' then
         tmpstr:='update t_yh set '+Afieldname+'='+AValue+
                 ' where yhid='''+id+''' and hszh='+inttostr(gblhszh)
      else if TypeName ='KS' then
         tmpstr:='update t_ks set '+Afieldname+'='+(AValue)+
                 ' where ksid='''+id+''' and hszh='+inttostr(gblhszh)
      else if TypeName ='XSZD' then
         tmpstr:='update t_xszd set '+Afieldname+'='+(AValue)+
                 ' where xspid='''+id+''' and hszh='+inttostr(gblhszh)
      else if TypeName =D012 then
         tmpstr:='update t_qhajsz set '+Afieldname+'='+(AValue)+
                 ' where ajh='+id+' and hszh='+inttostr(gblhszh)
      else if TypeName =D000 then
         tmpstr:='update t_hsz set '+Afieldname+'='+(AValue)+
                 ' where hszh='+inttostr(gblhszh)
      else if TypeName =D030 then
      begin
        tmpstr :='select 1 from t_yh_ks_week where yhid=:p1 and hszh=:p2';
        qr.SQL.Text := tmpstr;
        qr.Parameters.ParamByName('p1').Value := ID;
        qr.Parameters.ParamByName('p2').Value := gblHSZH;
        qr.Open;
        if qr.Eof then  //没有这个用户的周排班
        begin
          qr.Close;
          qr.SQL.Clear;
          qr.Parameters.Clear;
          qr.SQL.Text :='insert into t_yh_ks_week(yhid,ksid,hszh,xq) '+
            ' values(:p1,:p2,:p3,:p4)';
          qr.Parameters.ParamByName('p1').Value := ID;
          qr.Parameters.ParamByName('p2').Value := '';
          qr.Parameters.ParamByName('p3').Value := gblHSZH;
          qr.Parameters.ParamByName('p4').Value := '';
          qr.ExecSQL;
        end
        else
          qr.Close;
        qr.SQL.Clear;
        qr.Parameters.Clear;
        tmpstr :=' update t_yh_ks_week set '+Afieldname+'='+(AValue)+
                 ' where hszh='+inttostr(gblhszh)+
                 ' and yhid='+ QuotedStr(ID);
      end
      else
      begin
         result:=false;
         FreeAndNil(qr);
         exit;
      end;
      qr.SQL.Text:=tmpstr;
      if qr.execsql>0 then
         result:=true
      else
         result:=false;
      qr.Close;
      FreeAndNil(qr);
   except
        result:=false;  //
        FreeAndNil(qr);
   end;
end;
function TdmDBAccess.ksJzh(const JRID,kssxid,KSID, NewKsid,newksmc:string;const number:integer):Boolean;
var
    newhszh:integer;
    cmdStr:wideString;
    qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
          result:=true;
          qr.Close;
          qr.SQL.Text:='select  hszh from t_ks where ksid = ' + QuotedStr(newksid);
          qr.Open;                         {DISTINCT}
          ///////////将中.
         if  qr.Eof  then
         begin
            result := false;  ///有错误发生.
            Exit;
         end;
        newhszh:=qr.Fields.Fields[0].AsInteger;
        cmdStr:='insert into t_ksJzh  '+
                     '(frmHsz,frmKsid,toHsz,toKsid,toksmc,clbz,tmpid,zhsj) '+
                'values (' +
                    inttostr(gblhszh) + ',' + QuotedStr(ksid) +','+
                    inttostr(newhszh) + ',' + QuotedStr(newKsid) +','+
                    ''''+newksmc+''''+',1,'+ JRID+ ','+ ''''+cdatetostr(today)+ ' '+ctimetostr(now)+''''+')';
        adoconnection.Execute(cmdstr ,cmdText);
        //修改T_dhxx中的数据，将本条数据临时改为已就诊0
        cmdstr:=' UPDATE t_dhxx SET JZBZ=''0''' +
                ' ,yhid='''  + ''''+
                ' ,kssxid=0'+
                ' ,jzsj=''' + '''' +
                ' where id=' + jrid ;
        adoconnection.Execute(cmdstr,cmdText);
        //重新排序
        cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +          //'-' + inttostr(number)  +
                ' where kssxid >' + inttostr(strtoint(kssxid)-number) +
                ' and ksid=''' +KSID + '''' +
                ' and hszh=' + inttostr(gblHszh);
        adoconnection.Execute(cmdstr,cmdText);
    except
      begin
        result := false;  ///有错误发生.
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.arraypatientfrmother(const hszh:integer): boolean;
var
    cmdstr:string;
    //toksid,
    tmpid,tohsz:integer;
    toksid:string;
    toksmc:string;
    ddrs:integer;
    qr:TADOQuery;
begin
  qr :=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    //gbledit_ks_count:=0;
    result:=false;
    try
        qr.Close;
        cmdstr:='select toksid,toksmc,tmpid,tohsz from t_ksJzh(nolock) where tohsz=' + inttostr(gblhszh)+' and clbz=1';
        qr.SQL.Text:=cmdstr;
        qr.Open;
        if qr.Eof then exit;
        while not qr.Eof do
        begin
            toksid:=qr.Fields.Fields[0].AsString;
            toksmc:=qr.Fields.Fields[1].AsString;
            tmpid:=qr.Fields.Fields[2].AsInteger;
            tohsz:=qr.Fields.Fields[3].AsInteger;
            cmdstr:='select * from t_dhxx (nolock) where (jzbz=1)  and'+
              ' (ksid=' + QuotedStr((toksid)) + ')'+
              ' and (hszh= '+ inttostr(tohsz)+')';
            ddrs:=adoconnection.Execute(cmdstr,cmdtext).RecordCount;
            cmdstr:='update t_dhxx set JZBZ=1,hszh= ' + inttostr(gblhszh) +
                    ' , ksid= ' + QuotedStr(toksid) +
                    ' ,kssxid = ' +inttostr(ddrs+1) +
                    ' ,yhid='''''+
                    ' ,ZTBZ = '''+'4'+''''    +
                    '  where id=' + inttostr(tmpid);
//                        ' and ksid= ' + inttostr(toksid)
            adoconnection.Execute(cmdstr,cmdtext);
            //把已处理记录的标志改成0
            cmdstr:='update t_ksJzh set clbz=0 where tmpid=' + inttostr(tmpid);
            adoconnection.Execute(cmdstr,cmdtext);

            gbledit_ks_count:=gbledit_ks_count+1 ;
            gbledit_ks[gbledit_ks_count-1].ksid:=(toksid);
            gbledit_ks[gbledit_ks_count-1].ksmc:=toksmc;
            qr.Next;
        end;
        result:=true;
    except
       on E: Exception do
       begin

          //showmessage(e.message+    '  EoleExcetpion');
          addlog('ErrorLog.txt',e.Message+' '+cmdstr);
          errproc();
          result:=false;
          //disconnect;
          //sleep(1000);
          //connect;
          exit ;
       end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.GetUserID(const TypeName, ID: string; var param1,
  param2, param3, param4, param5, param6, param7: string; param8: integer;var param9,
  param10, param11,param12:string): Boolean;
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_GetuserID';
      Parameters.Clear;
      Parameters.CreateParameter('TypeName',
        ftString, pdInput, 10, TypeName);
      Parameters.CreateParameter('ID',
        ftString, pdInput, 10, ID);
      Parameters.CreateParameter('inparam1',
        ftString, pdInput, 80, '');
      Parameters.CreateParameter('inparam2',
        ftString, pdInput, 80, '');
      Parameters.CreateParameter('param1',
        ftString, pdOutput,200, '');
      Parameters.CreateParameter('param2',
        ftString, pdOutput, 50, '');
      Parameters.CreateParameter('param3',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param4',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param5',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param6',
        ftString, pdOutput, 80, '');
      Parameters.CreateParameter('param7',
        ftString, pdOutput, 10, '');
      Parameters.CreateParameter('param8',
        ftInteger, pdInput, 4, param8);
      Parameters.CreateParameter('param9',
        ftString, pdOutput, 10, param9);
      Parameters.CreateParameter('param10',
        ftString, pdOutput, 10, param10);
      Parameters.CreateParameter('param11',
        ftString, pdOutput, 10, param11);
      Parameters.CreateParameter('param12',
        ftString, pdOutput, 10, param12);

      ExecProc;
      param1 := VarToStr(Parameters.ParamValues['param1']);
      param2 := VarToStr(Parameters.ParamValues['param2']);
      param3 := VarToStr(Parameters.ParamValues['param3']);
      param4 := VarToStr(Parameters.ParamValues['param4']);
      param5 := VarToStr(Parameters.ParamValues['param5']);
      param6 := VarToStr(Parameters.ParamValues['param6']);
      param7 := vartostr(parameters.ParamValues['param7']);
      param9 := vartostr(parameters.ParamValues['param9']);
      param10 := vartostr(parameters.ParamValues['param10']);
      param11 := vartostr(parameters.ParamValues['param11']);
      param12 := vartostr(parameters.ParamValues['param12']);
      Close;
    end;
  except
    begin
      {用户信息取得失败}
      result := False;
      Exit;
    end;
  end;

  {用户信息取得成功}
  result := True;
end;

function TdmDBAccess.GetInsideFunction(const AoldFunction:string): string;
var
retint:integer;
tmpFunCode:string;
qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
     try
          qr.Close;
          //在等待T_hjzd表中查找zdid.
          qr.SQL.Text:='select ShowCode,FunCode from  ' +
                                  't_FUNCDZB (nolock) '+
                                  'where t_FUNCDZB.hszh=' + inttostr(gblhszh) + ' and t_FUNCDZB.ShowCode=''' + AoldFunction+'''' ;
          qr.Open;
          ///////////将中.
          with qr do
          begin
             if not qr.Eof  then
             begin
                tmpFuncode:=fields.fields[1].asstring ;
                if ( tmpFuncode <>'')  then
                begin
                   close;
                   result:=tmpFunCode;
                end
                else
                begin
                   result:=AoldFunction;
                   close;
                   exit;
                end;
             end
             else
               begin
                 result:=AoldFunction;
                 close ;
                 exit;
               end;
          end;
     except
          result:=AoldFunction;  //
     end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.NewuserID(const TypeName, ID, param1, param2, param3,
  param4, param5, param6, param7, param8, param9: string;
  param10: integer;param11,param12,param13: string): Boolean;
var
  intResult: Integer;
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_NewuserID';
      Parameters.Clear;
      Parameters.CreateParameter('TypeName',
        ftString, pdInput, 128, TypeName);
      Parameters.CreateParameter('ID',
        ftString, pdInput, 10, ID);
      Parameters.CreateParameter('param1',
        ftString, pdInput, 200, param1);
      Parameters.CreateParameter('param2',
        ftString, pdInput, 50, param2);
      Parameters.CreateParameter('param3',
        ftString, pdInput, 10, param3);
      Parameters.CreateParameter('param4',
        ftString, pdInput, 80, param4);
      Parameters.CreateParameter('param5',
        ftString, pdInput, 10, param5);
      Parameters.CreateParameter('param6',
        ftString, pdInput, 10, param6);
      Parameters.CreateParameter('param7',
        ftString, pdInput, 20, param7);
      Parameters.CreateParameter('param8',
        ftString, pdInput, 10, param8);
      Parameters.CreateParameter('param9',
        ftString, pdInput, 10, param9);
      Parameters.CreateParameter('param11',
        ftString, pdInput, 10, param11);
      Parameters.CreateParameter('param12',
        ftString, pdInput, 10, param12);
      Parameters.CreateParameter('param13',
        ftString, pdInput, 10, param13);
      Parameters.CreateParameter('param10',
        ftInteger, pdInput, 4, param10);
      Parameters.CreateParameter('ModeId',
        ftInteger, pdInput, 4, strtoint(ModeId));
      Parameters.CreateParameter('Result',
        ftInteger, pdOutput, 0, 1);

      ExecProc;
      intResult := Parameters.ParamValues['Result'];
      Close;
      if intResult = 1 then
      begin
        //用户登录失败
        result := False;
        Exit;
      end;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;
  //用户登录成功
  result := True;
end;

function TdmDBAccess.EdituserID(const Typename, ID, parm1, parm2, parm3,
  parm4, parm5, parm6, parm7, parm8, parm10, parm11,  parm12: string): Boolean;
var
  intResult: Integer;
begin
  try
    with ADOStoredProc do
    begin
      ProcedureName := 'MY_EdituserID';
      Parameters.Clear;
      Parameters.CreateParameter('Typename',
        ftString, pdInput, 128, Typename);
      Parameters.CreateParameter('ID',
        ftString, pdInput, 10, ID);
      Parameters.CreateParameter('parm1',          //诊室号码
        ftString, pdInput, 500, parm1);
      Parameters.CreateParameter('parm2',          //诊室名称
        ftString, pdInput, 80, parm2);
      Parameters.CreateParameter('parm3',          //诊台号码
        ftString, pdInput, 40, parm3);
      Parameters.CreateParameter('parm4',          //备注
        ftString, pdInput, 80, parm4);
      Parameters.CreateParameter('parm5',          //用户ID
        ftString, pdInput, 80, parm5);
      Parameters.CreateParameter('parm6',
        ftString, pdInput, 80, parm6);
      Parameters.CreateParameter('parm7',
        ftString, pdInput, 10, parm7);
      Parameters.CreateParameter('parm8',
        ftString, pdInput, 10, parm8);
      Parameters.CreateParameter('parm10',
        ftString, pdInput, 10, parm10);
      Parameters.CreateParameter('parm11',
        ftString, pdInput, 10, parm11);
      Parameters.CreateParameter('parm12',
        ftString, pdInput, 10, parm12);
      Parameters.CreateParameter('gblHSZH',
        ftInteger, pdInput, 4, gblHSZH);
      Parameters.CreateParameter('ModeId',
        ftInteger, pdInput, 4, strtoint(ModeId));
      Parameters.CreateParameter('Result',
        ftInteger, pdOutput, 0, 1);


      ExecProc;
      intResult := Parameters.ParamValues['Result'];
      Close;
      if intResult = 1 then
      begin
        //用户修改失败
        result := False;
        Exit;
      end;
    end;
  except
    begin
      result := False;
      Exit;
    end;
  end;

  //用户修改成功
  result := True;
end;

procedure TdmDBAccess.ShowData(const lvwDataList:TTeThemeSListView);
var
   ListItem: TListItem;
   msID:array of integer;
   i,j:integer;
   Msnumber,maxdispNunber:integer;
begin
    lvwDataList.Items.Clear;
    ADOQuery.Connection:=dmDBAccess.ADOConnection;
    ADOQuery.Active:=false;
    AdoQuery.SQL.Clear;
    AdoQuery.SQL.Add('SELECT DISTINCT XSMS FROM t_XSNRSZ where HSZH= ');
    AdoQuery.SQL.Add(inttostr(gblHSZH));
    AdoQuery.Open;
    i:=0;
    if   AdoQuery.RecordCount   > 0  then
        begin
            setlength(MsID,AdoQuery.RecordCount);
            while not AdoQuery.Eof  do
            begin
                 MsID[i]:=AdoQuery.FieldByName('XSMS').AsInteger;
                 AdoQuery.next;
                 i:=i+1;
            end;
            Msnumber:=i;
            ADOQuery.Close;;
            AdoQuery.SQL.Clear;
//            AdoQuery.SQL.Add('SELECT MAX(COUNT) AS maxdispNunber FROM (SELECT XSMS, COUNT(*) AS COUNT FROM t_XSNRSZ GROUP BY XSMS) DERIVEDTBL');
            AdoQuery.SQL.Add('SELECT MAX(COUNT) AS maxdispNunber FROM (SELECT XSMS, COUNT(*) AS COUNT FROM t_XSNRSZ 	where HSZH =');
            AdoQuery.SQL.Add(inttostr(gblHSZH));
            AdoQuery.SQL.Add('	GROUP BY XSMS) DERIVEDTBL');
            AdoQuery.Open;

            //显示每种显示方式的列标题
            maxdispNunber:=AdoQuery.FieldByName('maxdispNunber').AsInteger;
                if lvwDataList.Columns.Count = 0 then
                begin
                    lvwDataList.Columns.Add.Caption:='显示方式';
                    lvwDataList.Column[0].Width :=length('显示方式'+inttostr(i+1))* lvwDataList.Canvas.TextWidth('A');
                    for i:=1 to maxdispNunber do
                    begin
                        lvwDataList.Columns.Add.Caption:='显示项目'+inttostr(i);
                        lvwDataList.Column[i].Width:= (length('显示项目  '))* lvwDataList.Canvas.TextWidth('A');
                    end;
                end;
            for i:=0 to Msnumber-1 do
            begin
                ADOQuery.Close;;
                AdoQuery.SQL.Clear;
                AdoQuery.SQL.Add('SELECT * FROM t_XSNRSZ (nolock) where xsms= ');
                AdoQuery.SQL.Add(inttostr(MsID[i]));
                AdoQuery.SQL.Add('AND HSZH =');
                AdoQuery.SQL.Add(inttostr(gblHSZH));
                AdoQuery.Open;
                if not ADOQuery.Eof then
                begin
                    ListItem := lvwDataList.Items.Add;
                    ListItem.Caption := inttostr(MsID[i]);
                end;
                for j:=0 to ADOQuery.RecordCount-1 do
                begin
                     if   not AnsiContainsText(ADOQuery.FieldByName('xsnr').AsString,'任意字符')  then
                        ListItem.SubItems.Add(ADOQuery.FieldByName('xsnr').AsString)
 //                       ListItem.
                     else
                        ListItem.SubItems.Add(ADOQuery.FieldByName('xxnr').AsString);
                     ADOQuery.Next;
                end;
            end;
    end;
    ADOQuery.Close;;
end;
{*******************************************************************************
*函数名:CheckTm;
astrtm:卡号
acklx:卡类型，'1'磁卡，'5'芯片卡或非接卡
                                           *
*函数机能:检测等待列表中有无by4=StrTm病人信息,有则激活此病人.*
*******************************************************************************}
function Tdmdbaccess.CheckTm(const astrTm :string;const acklx:string):Boolean;
var
  cmdStr:wideString;
  tmpquery:tadoquery;
  i:integer;
  mr:integer;
  jrid,ksid,ksmc,brdm,brxm,ghhm,id,kssxid,by4,newksid,yhid:string;
  keepYH:Integer;
  intRet:integer;
  strTm:string;
  by7,by1,by5:string;
  retDB_Wakeupbyid:integer;
  blWeiFenZhen:boolean;
  weifenzhenrs,rs:integer;
  insertdt:tdatetime;
begin
try
   addlog('cardlog.txt','进入激活进程'+',卡号:'+astrtm+'' );
   strTm :=astrTM;
   if Length(strTm)=28 then //白玉兰卡
   begin
     strTm:=Copy(strTm,1,gblCardNoLen);
   end;
  with adoconnection do
  begin
       tmpquery:=tadoquery.Create(nil);
       tmpquery.Connection:=adoconnection;
       if gblChongxinFenZhen=1 then
       begin
         tmpquery.SQL.Clear;
         //--处理未分诊病人--
         tmpquery.SQL.Add('Select top 10 kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
           ',brdm,jzbz,d.ztbz,by5,by1,by7,yhid'+
           ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
           ' and d.hszh=k.hszh'+
           ' where by4=''' + strTm+''''+
           ' and d.hszh='+inttostr(gblHSZH)+
           ' and k.fenzhen=1'+
           //' and d.jzbz in (1,2)'+
           ' order by d.ghsj desc,d.ksid desc');
         try
           tmpquery.Open;
         except
           tmpquery.SQL.Clear;
           tmpquery.SQL.Add('Select top 10 kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
             ',brdm,jzbz,d.ztbz,by5,by1,by7,yhid'+
             ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
             ' and d.hszh=k.hszh'+
             ' where by4=''' + strTm+''''+
             ' and d.hszh='+inttostr(gblHSZH)+
             ' and k.memo=''未分诊'''+
             //' and d.jzbz in (1,2)'+
             ' order by d.ghsj desc,d.ksid desc');
           tmpquery.Open;
         end;
         rs :=tmpquery.RecordCount;
         weifenzhenrs :=0;
         if tmpquery.RecordCount>0 then
         begin
           //gbledit_ks_count :=0;
           while not tmpquery.Eof do
           begin

             //如果没有在已分诊科室中，则
             //重新分配一个号码并打印
             if ((tmpquery.fieldbyname('jzbz').AsString='1')
              or (tmpquery.fieldbyname('jzbz').AsString='2')) then //如果未分诊
             begin
               weifenzhenrs :=weifenzhenrs+1;
               jrid :=  tmpquery.fieldbyname('id').AsString;
               ksid := tmpquery.fieldbyname('ksid').AsString;
               newksid := 'FZ'+ksid;
               ksmc := tmpquery.fieldbyname('ksmc').AsString;
               brdm := tmpquery.fieldbyname('brdm').AsString;
               brxm := tmpquery.fieldbyname('brxm').AsString;
               by4  := strTm;
               by7 :=  tmpquery.fieldbyname('by7').AsString;
               by1 :=  tmpquery.fieldbyname('by1').AsString;
               //frmmain.ActionQhExecute(nil);   //不能显示？？？
                if not Assigned(frmSDQHMR) then
                begin
                  application.CreateForm(tfrmSDQHMR,frmSDQHMR);
                end;
                frmSDQHMR.chkSJD.Checked := false;
                with frmSDQHMR do
                begin
                   frmSDQHMR.QHBy1 := by1;
                   frmSDQHMR.QHBy7 := by7;
                   frmSDQHMR.editBRDM.Text := strtm;
                   frmSDQHMR.EditBRXM.Text := brxm;
                   frmSDQHMR.edtcardno.Text := by4;
                   QHKsid :=newksid;
                end;
                intret :=frmsdqhmr.ShowModal;
                if intret=1 then
                begin
                  //分诊成功后将此病人激活//或者将此病人弃号//
                  dmdbaccess.Qh(jrid,kssxid,ksid);
                  insertnotifygrouptorefresh(gblhszh,ksid,gblhszh);
                end;
               //showmessage(inttostr(intret));
               //dmdbaccess.QuHao(ksid,ksmc,brdm,brxm,'',ksmc,'','','',by4);
             end;
             tmpquery.Next;
             //
           end;
           if weifenzhenrs>0 then
             blweiFenZhen := true;
         end;
         tmpquery.close;
         if not blWeiFenZhen then
         begin
             tmpquery.sql.clear;
             tmpquery.SQL.Add('Select kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
             ',brdm,jzbz,d.ztbz,by5,by1,by7,yhid'+
             ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
             ' and d.hszh=k.hszh'+
             ' where by4=''' + strTm+''''+
             ' and d.hszh='+inttostr(gblHSZH)+
             ' and k.fenzhen=0 '+
             ' order by d.ksid desc');
           try
             tmpquery.Open;
           except
             tmpquery.sql.clear;
             tmpquery.SQL.Add('Select kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
             ',brdm,jzbz,d.ztbz,by5,by1,by7,yhid'+
             ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
             ' and d.hszh=k.hszh'+
             ' where by4=''' + strTm+''''+
             ' and d.hszh='+inttostr(gblHSZH)+
             ' and isnull(k.memo,'''')<>''未分诊'''+
             ' order by d.ksid desc');
             tmpquery.Open;
           end;

           if tmpquery.RecordCount>0 then
           begin
             //gbledit_ks_count :=0;
             while not tmpquery.Eof do
             begin
               if ((tmpquery.FieldByName('jzbz').AsString='2')
                    and (tmpquery.FieldByName('ztbz').AsString='6')) then//未激活
                 begin
                   if tmpquery.RecordCount>1 then
                   begin
                     if Application.MessageBox(pchar(ttl_br+'信息:'+ #13#10+
                                 ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+ #13#10+
                                 ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+ #13#10+
                                 ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring+#13#10+
                                 '是否激活?'),
                                 '激活',MB_YESNO)= IDYES then
                     begin
                       //激活;
                     end
                     else
                     begin
                       tmpquery.Next;
                       Continue;
                     end;
                   end;
                   retDB_Wakeupbyid :=DB_Wakeupbyid(tmpquery.fieldbyname('id').AsString,gblHSZH,False);
                   if  retDB_Wakeupbyid<>-1 then
                   begin
                     addlog('cardlog.txt','激活成功'+','+ttl_br+'信息:'+
                                 ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                                 ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                                 ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring );
    //               cmdstr:=' UPDATE t_dhxx ' +
    //                      ' set jzbz=''1'',ztbz=''1'' '+
    //                      ' where id='+tmpquery.fieldbyname('id').AsString +
    //                      ' and hszh=' + inttostr(gblHSZH);
    //               execute(cmdstr,cmdtext);
                     gbledit_ks[gbledit_ks_count].ksid:=tmpquery.fieldbyname('ksid').AsString;
                     gbledit_ks[gbledit_ks_count].ksmc:=tmpquery.fieldbyname('ksmc').AsString;
                     gbledit_ks_count:=gbledit_ks_count+1;
                     result:=true;
                     frmmain.sbrInfo.Panels.Items[0].Text:= '刷卡成功,'+ttl_br+'信息:'+
                                   ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                                   ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                                   ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring;

                   //需要将此病人安排在准备号之后，大号码之前，小号码之后。
                   //add by wugang @2012-11-08
                     if (gblYYSJDJH=1)  //--预约时间段到后才能呼叫
                      and (tmpquery.FieldByName('by1').AsString='88') //是预约病人
                      //and (tmpquery.FieldByName('by7').AsString>FormatDateTime('hh:nn',now))
                      and (retDB_Wakeupbyid=2) then  //预约时间段未到
                     begin
    //                   PutWakeupIDAtPos(tmpquery.fieldbyname('id').AsString,gblHSZH);
    //                   if tmpquery.FieldByName('by1').AsString='88' then
    //                   begin
    //                     SZYXJ(tmpquery.fieldbyname('id').AsString,'88');
    //                   end;
                     end
                     else
                     begin
                       PutWakeupIDAtPos(tmpquery.fieldbyname('id').AsString,gblHSZH);
    //                   if tmpquery.FieldByName('by1').AsString='88' then
    //                   begin
    //                     SZYXJ(tmpquery.fieldbyname('id').AsString,'88');
    //                   end;
                     end;
                   //add end
                   end
                   else
                   begin
                     frmmain.sbrInfo.Panels.Items[0].Text:= '刷卡成功,激活操作失败!'+ttl_br+'信息:'+
                                 ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                                 ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                                 ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring;
                     addlog('cardlog.txt','刷卡成功,激活操作失败!'+ttl_br+'信息:'+
                                 ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                                 ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                                 ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring);
                   end;
                 end
                 //增加功能如果是在排队中,则弹出选择功能对话框(对话框中包括
                 {
                 选择医生
                 选择优先级
                 弃号
                 等
                 }
               else if tmpquery.FieldByName('jzbz').AsString='1' then //在排队中
               begin
                    ksid:= tmpquery.fieldbyname('ksid').AsString;
                    ksmc:= tmpquery.fieldbyname('ksmc').AsString;
                    ghhm:= tmpquery.fieldbyname('ghhm').AsString;
                    id:= tmpquery.fieldbyname('id').AsString;
                    kssxid:= tmpquery.fieldbyname('kssxid').AsString;
                    brxm:= tmpquery.fieldbyname('brxm').AsString;
                    brdm:= tmpquery.fieldbyname('brdm').AsString;
                    yhid := tmpquery.fieldbyname('yhid').AsString;
                    frmmain.sbrInfo.Panels.Items[0].Text:= '刷卡成功,'+ttl_br+'信息:'+
                                 ' '+ttl_ks+':'+ksmc+
                                 ' 姓名:'+brxm+
                                 ' '+ttl_ghhm+':'+ghhm;
                     addlog('cardlog.txt','刷卡成功,在排队中!'+ttl_br+'信息:'+
                                 ' '+ttl_ks+':'+ksmc+
                                 ' 姓名:'+brxm+
                                 ' '+ttl_ghhm+':'+ghhm);
                    application.CreateForm(tfrmSelectFunc,frmSelectFunc);
                    frmSelectFunc.CardNo := strTM;
                    frmSelectFunc.PName := brxm;
                    frmSelectFunc.Ksmc := ksmc;
                    frmSelectFunc.Ghhm := ghhm;
                    frmSelectFunc.Sxid := kssxid;
                    frmSelectFunc.Ysxm := getdbvalue('YH',yhid,'YHMC');
                    frmSelectFunc.Top:=frmMain.Height-frmmain.ClientHeight+frmmain.Panel1.Top;
                    frmSelectFunc.Left:=(frmMain.Width-frmmain.ClientWidth) div 2+frmmain.Panel1.Left;
                    frmSelectFunc.Width:=frmMain.Panel1.Width;
                    frmSelectFunc.Height:=frmMain.Panel1.Height;
                    frmSelectFunc.ShowModal;
                    mr:=frmSelectFunc.ModalResult;
                    FreeAndNil(frmSelectFunc);
                    if mr=100 then//选择医生
                    begin
                      for i:=0 to GroupNumber-1 do
                      begin
                        if GroupSerial[i].ksid=ksid then
                        begin
                          if DbgDhxxArray[i].Visible then
                            DbgDhxxArray[i].SetFocus;
                          WinGroupIndex:=i;
                          SeleId:=id;
                          seleksid :=ksid;
                          if AdoqdhxxArray[i].Locate('id',id,[]) then
                            frmMain.ActionXZYSExecute(self);
                          Break;
                        end;
                      end;
                    end
                    else if mr=101 then ////选择优先
                    begin
                      for i:=0 to GroupNumber-1 do
                      begin
                        if GroupSerial[i].ksid=ksid then
                        begin
                          if DbgDhxxArray[i].Visible then
                            DbgDhxxArray[i].SetFocus;
                          WinGroupIndex:=i;
                          SeleId:=id;
                          seleksid :=ksid;
                          if AdoqdhxxArray[i].Locate('id',id,[]) then
                            frmMain.ActionSZYXJExecute(self);
                          Break;
                        end;
                      end;
                    end
                    else if mr=102 then////弃号
                    begin
                      for i:=0 to GroupNumber-1 do
                      begin
                        if GroupSerial[i].ksid=ksid then
                        begin
                          if DbgDhxxArray[i].Visible then
                            DbgDhxxArray[i].SetFocus;
                          WinGroupIndex:=i;
                          SeleId:=id;
                          seleksid :=ksid;
                          DbgDhxxArray[i].SelectedRows.Clear;
                          if AdoqdhxxArray[i].Locate('id',id,[]) then
                            frmMain.ActionQiHaoExecute(self);
                          Break;
                        end;
                      end;
                    end
                    else if mr=103 then  //提前//退后
                    begin
                      for i:=0 to GroupNumber-1 do
                      begin
                        if GroupSerial[i].ksid=ksid then
                        begin
                          if DbgDhxxArray[i].Visible then
                            DbgDhxxArray[i].SetFocus;
                          WinGroupIndex:=i;
                          SeleId:=id;
                          seleksid :=ksid;
                          DbgDhxxArray[i].SelectedRows.Clear;
                          if AdoqdhxxArray[i].Locate('id',id,[]) then
                            frmMain.ActionTQTHExecute(self);
                          Break;
                        end;
                      end;
                    end
                    else if mr=104 then ////换科室
                    begin
                      for i:=0 to GroupNumber-1 do
                      begin
                        if GroupSerial[i].ksid=ksid then
                        begin
                          if DbgDhxxArray[i].Visible then
                            DbgDhxxArray[i].SetFocus;
                          WinGroupIndex:=i;
                          SeleId:=id;
                          seleksid :=ksid;
                          if AdoqdhxxArray[i].Locate('id',id,[]) then
                            frmMain.ActionHKSExecute(self);
                          Break;
                        end;
                      end;
                    end;

                    result:=true;
               end
                 //增加功能如果是在已呼叫中,则弹出是否召回对话框
               else if tmpquery.FieldByName('jzbz').AsString='0' then //已呼叫
               begin
                  by5 := tmpquery.fieldbyname('by5').AsString;
                  ksid:= tmpquery.fieldbyname('ksid').AsString;
                  ksmc:= tmpquery.fieldbyname('ksmc').AsString;
                  ghhm:= tmpquery.fieldbyname('ghhm').AsString;
                  id:= tmpquery.fieldbyname('id').AsString;
                  kssxid:= tmpquery.fieldbyname('kssxid').AsString;
                  brxm:= tmpquery.fieldbyname('brxm').AsString;
                  brdm:= tmpquery.fieldbyname('brdm').AsString;
                  if by5='退号' then
                  begin
                    frmmain.sbrInfo.Panels.Items[0].Text:= '已退号,'+ttl_br+'信息:'+
                                 ' '+ttl_ks+':'+ksmc+
                                 ' 姓名:'+brxm+
                                 ' '+ttl_ghhm+':'+ghhm;
                     addlog('cardlog.txt','刷卡成功,已退号,'+ttl_br+'信息:'+
                                 ' '+ttl_ks+':'+ksmc+
                                 ' 姓名:'+brxm+
                                 ' '+ttl_ghhm+':'+ghhm);
                    intRet:= Application.MessageBox(
                         pchar('此号已退：<'+ksmc+' '+ ghhm+'号'+brxm +'>!')
                         ,pchar('已退号'),MB_OK+MB_ICONINFORMATION);
                  end
                  else
                  begin
                    frmmain.sbrInfo.Panels.Items[0].Text:= '刷卡成功,'+ttl_br+'信息:'+
                                 ' '+ttl_ks+':'+ksmc+
                                 ' 姓名:'+brxm+
                                 ' '+ttl_ghhm+':'+ghhm;
                     addlog('cardlog.txt','刷卡成功,已呼叫过,'+ttl_br+'信息:'+
                                 ' '+ttl_ks+':'+ksmc+
                                 ' 姓名:'+brxm+
                                 ' '+ttl_ghhm+':'+ghhm);
                    for i:=0 to GroupNumber-1 do
                    begin
                      if GroupSerial[i].ksid=ksid then
                      begin
                        if DbgDhxxArray[i].Visible then
                          DbgDhxxArray[i].SetFocus;
                        WinGroupIndex:=i;
                        //SeleId:=id;
                        //if AdoqdhxxArray[i].Locate('id',id,[]) then
                        //begin
                         // result := Application.MessageBox(PChar(Text), PChar(Caption), Flags);
                         intRet:= Application.MessageBox(
                         pchar('要召回<'+ksmc+' '+ ghhm+'号'+brxm +'>,并保留选择'+ttl_yh+'吗?            '+#13#10+
                         '◆选择<是>将召回并保留原选择'+ttl_yh+'      '+#13+#10+
                         '◆选择<否>将召回但不保留原选择'+ttl_yh+'      '+#13+#10+
                         '◆选择<取消>将不召回!'+'           ')
                         ,pchar('是否召回?'),MB_YESNOCANCEL+mb_iconquestion);
                         if intRet=IDYES then
                         begin
                           keepYH:=1 ;
                           if FZZH(id,ksid,keepyh,'',1) then
                           begin
                             dmDBAccess.SetGroupCount(lblcountarray[i],ksid,gblHSZH);
                              SetDHXXItems(dbgDhxxarray[i],lblksmcarray[i]
                              ,ksid,gblhszh,adoqDhxxArray[i]);
                           end
                         end
                         else if intRet=IDNO then
                         begin
                           keepYH:=0;
                           if FZZH(id,ksid,keepyh,'',1) then
                           begin
                             dmDBAccess.SetGroupCount(lblcountarray[i],ksid,gblHSZH);
                              SetDHXXItems(dbgDhxxarray[i],lblksmcarray[i]
                              ,ksid,gblhszh,adoqDhxxArray[i]);
                           end
                         end;
                        Break;
                      end;
                    end;
                  end;
                  result:=true;
                //
               end
               else
               begin
                  ksmc:= tmpquery.fieldbyname('ksmc').AsString;
                  ghhm:= tmpquery.fieldbyname('ghhm').AsString;
                  brxm:= tmpquery.fieldbyname('brxm').AsString;
                  frmmain.sbrInfo.Panels.Items[0].Text:= '已激活未到时,'+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+ksmc+
                               ' 姓名:'+brxm+
                               ' '+ttl_ghhm+':'+ghhm;
                   addlog('cardlog.txt','刷卡成功,已激活未到时,'+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+ksmc+
                               ' 姓名:'+brxm+
                               ' '+ttl_ghhm+':'+ghhm);
               end;
               tmpquery.Next;
             end;
           end
           else
           begin
               result:=false;
               frmmain.sbrInfo.Panels.Items[0].Text:= '刷卡,没有找到此卡号病人信息!'+'卡号:'+strTM;
               addlog('cardlog.txt','刷卡成功,未找到,'+ttl_br+'信息:'+'卡号:'+strTM);
           end;
           tmpquery.Close;
           if gblWakeupOtherNurseStation<>'' then
           begin
             //激活其它护士站号码。
             WakeupOtherNurseStationNumber(strTm);
           end;
         end;
       end
       else
       begin


//         tmpquery.SQL.Clear;
//         //--处理未分诊科室病人--
//         tmpquery.SQL.Add('Select kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
//           ',brdm,jzbz,d.ztbz,by5,by1,by7'+
//           ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
//           ' and d.hszh=k.hszh'+
//           ' where by4=''' + strTm+''''+
//           ' and d.hszh='+inttostr(gblHSZH)+
//           ' and k.fenzhen=1'+
//           ' order by d.ksid desc');
//         try
//           tmpquery.Open;
//         except
//           tmpquery.SQL.Clear;
//           tmpquery.SQL.Add('Select kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
//             ',brdm,jzbz,d.ztbz,by5,by1,by7'+
//             ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
//             ' and d.hszh=k.hszh'+
//             ' where by4=''' + strTm+''''+
//             ' and d.hszh='+inttostr(gblHSZH)+
//             ' and k.memo=''未分诊'''+
//             ' order by d.ksid desc');
//           tmpquery.Open;
//         end;
//         rs := tmpquery.RecordCount;
//         tmpquery.Close;
//         if blweifenzhen then
//         begin
//           if rs>weifenzhenrs then  blweifenzhen := false;
//         end;
         tmpquery.sql.clear;
         tmpquery.SQL.Text :='select 1 from sys.all_objects where name=''t_his_brkh''';
         tmpquery.Open;
         if not tmpquery.Eof then
         begin
           tmpquery.Close;
           tmpquery.sql.clear;
           tmpquery.SQL.Text :='select 1 from t_dhxx where by4=''' + strTm+'''';
           tmpquery.Open;
           if not tmpquery.Eof then //如果有这人卡号的病人
           begin
             tmpquery.Close; //不需要处理.
           end
           else
           begin
             tmpquery.Close;
             tmpquery.sql.clear;
             tmpquery.SQL.Text :='select status,brid from t_his_brkh where ckhm=''' + strTm+'''';
             tmpquery.Open;
             if tmpquery.Eof then   //没有这个磁卡与brid对应的数据
             begin
               tmpquery.Close;
               tmpquery.sql.clear;
               //插入一条磁卡号
               tmpquery.SQL.Text :='insert into t_his_brkh(ckhm,cklx) select ' + quotedstr(strTm)+','+quotedstr(acklx);
               tmpquery.ExecSQL;
               insertdt := now;
               tmpquery.Close;
               addlog('cardlog.txt','写入t_his_brkh表:'+strTm);
               while (now-insertdt)*24*60*60<3 do  //等待接口程序将brid写回到此表中,超时时间为3秒
               begin
                 application.ProcessMessages;
                 tmpquery.sql.clear;
                 tmpquery.SQL.Text :='select status,brid from t_his_brkh(nolock) where ckhm=''' + strTm+'''';
                 tmpquery.Open;
                 if not tmpquery.Eof then
                 begin
                   if trim(tmpquery.FieldByName('status').AsString)='1' then
                   begin
                     brdm := trim(tmpquery.FieldByName('brid').AsString);
                     tmpquery.Close;
                     tmpquery.sql.clear;
                     //插入一条磁卡号
//                     tmpquery.SQL.Text :='update t_ghxx set by4=''' + strTm+''''+
//                      ' where brdm='''+tmpquery.FieldByName('brid').AsString+'''';
//                     tmpquery.ExecSQL;
                     tmpquery.SQL.Text :='update t_dhxx set by4=''' + strTm+''''+
                      ' where brdm='''+brdm+'''';
                     tmpquery.ExecSQL;
                     break;
                   end;
                 end;
                 tmpquery.Close;
                 sleep(100);
               end;
             end
             else
             begin
               if trim(tmpquery.FieldByName('status').asstring)='1' then
               begin
                 brdm := trim(tmpquery.FieldByName('brid').AsString);
                 tmpquery.Close;
                 tmpquery.sql.clear;
                 //修改等待表中的病人卡号
                 tmpquery.SQL.Text :='update t_dhxx set by4=''' + strTm+''''+
                  ' where brdm='''+brdm+'''';
                 tmpquery.ExecSQL;
               end;
               tmpquery.Close;
             end;
           end;
         end;
         tmpquery.Close;

         blWeiFenZhen := false;
         if not blWeiFenZhen then
         begin
           tmpquery.sql.clear;
           tmpquery.SQL.Add('Select kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
           ',brdm,jzbz,d.ztbz,by5,by1,by7,yhid'+
           ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
           ' and d.hszh=k.hszh'+
           ' where by4=''' + strTm+''''+
           ' and d.hszh='+inttostr(gblHSZH)+
           //' and k.fenzhen=0 '+
           ' order by d.ksid desc');
         try
           tmpquery.Open;
         except
           tmpquery.sql.clear;
           tmpquery.SQL.Add('Select kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
           ',brdm,jzbz,d.ztbz,by5,by1,by7,yhid'+
           ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
           ' and d.hszh=k.hszh'+
           ' where by4=''' + strTm+''''+
           ' and d.hszh='+inttostr(gblHSZH)+
           //' and isnull(k.memo,'''')<>''未分诊'''+
           ' order by d.ksid desc');
           tmpquery.Open;
         end;

         if tmpquery.RecordCount>0 then
         begin
           //gbledit_ks_count :=0;
           while not tmpquery.Eof do
           begin
             if ((tmpquery.FieldByName('jzbz').AsString='2')
                  and (tmpquery.FieldByName('ztbz').AsString='6')) then//未激活
               begin
                 if tmpquery.RecordCount>1 then
                 begin
                   if Application.MessageBox(pchar(ttl_br+'信息:'+ #13#10+
                               ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+ #13#10+
                               ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+ #13#10+
                               ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring+#13#10+
                               '是否激活?'),
                               '激活',MB_YESNO)= IDYES then
                   begin
                     //激活;
                   end
                   else
                   begin
                     tmpquery.Next;
                     Continue;
                   end;
                 end;
                 retDB_Wakeupbyid :=DB_Wakeupbyid(tmpquery.fieldbyname('id').AsString,gblHSZH,False);
                 if  retDB_Wakeupbyid<>-1 then
                 begin
                   addlog('cardlog.txt','激活成功'+','+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                               ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                               ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring );
  //               cmdstr:=' UPDATE t_dhxx ' +
  //                      ' set jzbz=''1'',ztbz=''1'' '+
  //                      ' where id='+tmpquery.fieldbyname('id').AsString +
  //                      ' and hszh=' + inttostr(gblHSZH);
  //               execute(cmdstr,cmdtext);
                   gbledit_ks[gbledit_ks_count].ksid:=tmpquery.fieldbyname('ksid').AsString;
                   gbledit_ks[gbledit_ks_count].ksmc:=tmpquery.fieldbyname('ksmc').AsString;
                   gbledit_ks_count:=gbledit_ks_count+1;
                   result:=true;
                   frmmain.sbrInfo.Panels.Items[0].Text:= '刷卡成功,'+ttl_br+'信息:'+
                                 ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                                 ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                                 ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring;

                 //需要将此病人安排在准备号之后，大号码之前，小号码之后。
                 //add by wugang @2012-11-08
                   if (gblYYSJDJH=1)  //--预约时间段到后才能呼叫
                    and (tmpquery.FieldByName('by1').AsString='88') //是预约病人
                    //and (tmpquery.FieldByName('by7').AsString>FormatDateTime('hh:nn',now))
                    and (retDB_Wakeupbyid=2) then  //预约时间段未到
                   begin
  //                   PutWakeupIDAtPos(tmpquery.fieldbyname('id').AsString,gblHSZH);
  //                   if tmpquery.FieldByName('by1').AsString='88' then
  //                   begin
  //                     SZYXJ(tmpquery.fieldbyname('id').AsString,'88');
  //                   end;
                   end
                   else
                   begin
                     PutWakeupIDAtPos(tmpquery.fieldbyname('id').AsString,gblHSZH);
  //                   if tmpquery.FieldByName('by1').AsString='88' then
  //                   begin
  //                     SZYXJ(tmpquery.fieldbyname('id').AsString,'88');
  //                   end;
                   end;
                 //add end
                 end
                 else
                 begin
                   frmmain.sbrInfo.Panels.Items[0].Text:= '刷卡成功,激活操作失败!'+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                               ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                               ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring;
                   addlog('cardlog.txt','刷卡成功,激活操作失败!'+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                               ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                               ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring);
                 end;
               end
               //增加功能如果是在排队中,则弹出选择功能对话框(对话框中包括
               {
               选择医生
               选择优先级
               弃号
               等
               }
             else if tmpquery.FieldByName('jzbz').AsString='1' then //在排队中
             begin
                  ksid:= tmpquery.fieldbyname('ksid').AsString;
                  ksmc:= tmpquery.fieldbyname('ksmc').AsString;
                  ghhm:= tmpquery.fieldbyname('ghhm').AsString;
                  id:= tmpquery.fieldbyname('id').AsString;
                  kssxid:= tmpquery.fieldbyname('kssxid').AsString;
                  brxm:= tmpquery.fieldbyname('brxm').AsString;
                  brdm:= tmpquery.fieldbyname('brdm').AsString;
                  yhid:=tmpquery.fieldbyname('yhid').AsString;
                  frmmain.sbrInfo.Panels.Items[0].Text:= '刷卡成功,'+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+ksmc+
                               ' 姓名:'+brxm+
                               ' '+ttl_ghhm+':'+ghhm;
                   addlog('cardlog.txt','刷卡成功,在排队中!'+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+ksmc+
                               ' 姓名:'+brxm+
                               ' '+ttl_ghhm+':'+ghhm);
                  application.CreateForm(tfrmSelectFunc,frmSelectFunc);
                  frmSelectFunc.CardNo := strTM;
                  frmSelectFunc.PName := brxm;
                  frmSelectFunc.Ksmc := ksmc;
                  frmSelectFunc.Ghhm := ghhm;
                  frmSelectFunc.Sxid := kssxid;
                  frmSelectFunc.Ysxm := getdbvalue('YH',yhid,'YHMC');
                  frmSelectFunc.Top:=frmMain.Height-frmmain.ClientHeight+frmmain.Panel1.Top;
                  frmSelectFunc.Left:=(frmMain.Width-frmmain.ClientWidth) div 2+frmmain.Panel1.Left;
                  frmSelectFunc.Width:=frmMain.Panel1.Width;
                  frmSelectFunc.Height:=frmMain.Panel1.Height;
                  frmSelectFunc.ShowModal;
                  mr:=frmSelectFunc.ModalResult;
                  FreeAndNil(frmSelectFunc);
                  if mr=100 then//选择医生
                  begin
                    for i:=0 to GroupNumber-1 do
                    begin
                      if GroupSerial[i].ksid=ksid then
                      begin
                        if DbgDhxxArray[i].Visible then
                          DbgDhxxArray[i].SetFocus;
                        WinGroupIndex:=i;
                        SeleId:=id;
                        seleksid :=ksid;
                        if AdoqdhxxArray[i].Locate('id',id,[]) then
                          frmMain.ActionXZYSExecute(self);
                        Break;
                      end;
                    end;
                  end
                  else if mr=101 then ////选择优先
                  begin
                    for i:=0 to GroupNumber-1 do
                    begin
                      if GroupSerial[i].ksid=ksid then
                      begin
                        if DbgDhxxArray[i].Visible then
                          DbgDhxxArray[i].SetFocus;
                        WinGroupIndex:=i;
                        SeleId:=id;
                        seleksid :=ksid;
                        if AdoqdhxxArray[i].Locate('id',id,[]) then
                          frmMain.ActionSZYXJExecute(self);
                        Break;
                      end;
                    end;
                  end
                  else if mr=102 then////弃号
                  begin
                    for i:=0 to GroupNumber-1 do
                    begin
                      if GroupSerial[i].ksid=ksid then
                      begin
                        if DbgDhxxArray[i].Visible then
                          DbgDhxxArray[i].SetFocus;
                        WinGroupIndex:=i;
                        SeleId:=id;
                        seleksid :=ksid;
                        DbgDhxxArray[i].SelectedRows.Clear;
                        if AdoqdhxxArray[i].Locate('id',id,[]) then
                          frmMain.ActionQiHaoExecute(self);
                        Break;
                      end;
                    end;
                  end
                  else if mr=103 then  //提前//退后
                  begin
                    for i:=0 to GroupNumber-1 do
                    begin
                      if GroupSerial[i].ksid=ksid then
                      begin
                        if DbgDhxxArray[i].Visible then
                          DbgDhxxArray[i].SetFocus;
                        WinGroupIndex:=i;
                        SeleId:=id;
                        seleksid :=ksid;
                        DbgDhxxArray[i].SelectedRows.Clear;
                        if AdoqdhxxArray[i].Locate('id',id,[]) then
                          frmMain.ActionTQTHExecute(self);
                        Break;
                      end;
                    end;
                  end
                  else if mr=104 then ////换科室
                    begin
                      for i:=0 to GroupNumber-1 do
                      begin
                        if GroupSerial[i].ksid=ksid then
                        begin
                          if DbgDhxxArray[i].Visible then
                            DbgDhxxArray[i].SetFocus;
                          WinGroupIndex:=i;
                          SeleId:=id;
                          seleksid :=ksid;
                          if AdoqdhxxArray[i].Locate('id',id,[]) then
                            frmMain.ActionHKSExecute(self);
                          Break;
                        end;
                      end;
                    end;

                  result:=true;
             end
               //增加功能如果是在已呼叫中,则弹出是否召回对话框
             else if tmpquery.FieldByName('jzbz').AsString='0' then //已呼叫
             begin
                by5 := tmpquery.fieldbyname('by5').AsString;
                ksid:= tmpquery.fieldbyname('ksid').AsString;
                ksmc:= tmpquery.fieldbyname('ksmc').AsString;
                ghhm:= tmpquery.fieldbyname('ghhm').AsString;
                id:= tmpquery.fieldbyname('id').AsString;
                kssxid:= tmpquery.fieldbyname('kssxid').AsString;
                brxm:= tmpquery.fieldbyname('brxm').AsString;
                brdm:= tmpquery.fieldbyname('brdm').AsString;
                if by5='退号' then
                begin
                  frmmain.sbrInfo.Panels.Items[0].Text:= '已退号,'+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+ksmc+
                               ' 姓名:'+brxm+
                               ' '+ttl_ghhm+':'+ghhm;
                   addlog('cardlog.txt','刷卡成功,已退号,'+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+ksmc+
                               ' 姓名:'+brxm+
                               ' '+ttl_ghhm+':'+ghhm);
                  intRet:= Application.MessageBox(
                       pchar('此号已退：<'+ksmc+' '+ ghhm+'号'+brxm +'>!')
                       ,pchar('已退号'),MB_OK+MB_ICONINFORMATION);
                end
                else
                begin
                  frmmain.sbrInfo.Panels.Items[0].Text:= '刷卡成功,'+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+ksmc+
                               ' 姓名:'+brxm+
                               ' '+ttl_ghhm+':'+ghhm;
                   addlog('cardlog.txt','刷卡成功,已呼叫过,'+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+ksmc+
                               ' 姓名:'+brxm+
                               ' '+ttl_ghhm+':'+ghhm);
                  for i:=0 to GroupNumber-1 do
                  begin
                    if GroupSerial[i].ksid=ksid then
                    begin
                      if DbgDhxxArray[i].Visible then
                        DbgDhxxArray[i].SetFocus;
                      WinGroupIndex:=i;
                      //SeleId:=id;
                      //if AdoqdhxxArray[i].Locate('id',id,[]) then
                      //begin
                       // result := Application.MessageBox(PChar(Text), PChar(Caption), Flags);
                       intRet:= Application.MessageBox(
                       pchar('要召回<'+ksmc+' '+ ghhm+'号'+brxm +'>,并保留选择'+ttl_yh+'吗?            '+#13#10+
                       '◆选择<是>将召回并保留原选择'+ttl_yh+'      '+#13+#10+
                       '◆选择<否>将召回但不保留原选择'+ttl_yh+'      '+#13+#10+
                       '◆选择<取消>将不召回!'+'           ')
                       ,pchar('是否召回?'),MB_YESNOCANCEL+mb_iconquestion);
                       if intRet=IDYES then
                       begin
                         keepYH:=1 ;
                         if FZZH(id,ksid,keepyh,'',1) then
                         begin
                           dmDBAccess.SetGroupCount(lblcountarray[i],ksid,gblHSZH);
                            SetDHXXItems(dbgDhxxarray[i],lblksmcarray[i]
                            ,ksid,gblhszh,adoqDhxxArray[i]);
                         end
                       end
                       else if intRet=IDNO then
                       begin
                         keepYH:=0;
                         if FZZH(id,ksid,keepyh,'',1) then
                         begin
                           dmDBAccess.SetGroupCount(lblcountarray[i],ksid,gblHSZH);
                            SetDHXXItems(dbgDhxxarray[i],lblksmcarray[i]
                            ,ksid,gblhszh,adoqDhxxArray[i]);
                         end
                       end;
                      Break;
                    end;
                  end;
                end;
                result:=true;
              //
             end
             else
             begin
                ksmc:= tmpquery.fieldbyname('ksmc').AsString;
                ghhm:= tmpquery.fieldbyname('ghhm').AsString;
                brxm:= tmpquery.fieldbyname('brxm').AsString;
                frmmain.sbrInfo.Panels.Items[0].Text:= '已激活未到时,'+ttl_br+'信息:'+
                             ' '+ttl_ks+':'+ksmc+
                             ' 姓名:'+brxm+
                             ' '+ttl_ghhm+':'+ghhm;
                 addlog('cardlog.txt','刷卡成功,已激活未到时,'+ttl_br+'信息:'+
                             ' '+ttl_ks+':'+ksmc+
                             ' 姓名:'+brxm+
                             ' '+ttl_ghhm+':'+ghhm);
             end;
             tmpquery.Next;
           end;
         end
         else
         begin
             tmpquery.sql.clear;
             tmpquery.SQL.Add('Select kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
             ',brdm,jzbz,d.ztbz,by5,by1,by7,yhid'+
             ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
             ' and d.hszh=k.hszh'+
             ' where by4=''' + strTm+''''+
             ' order by d.ksid desc');
             try
               tmpquery.Open;
               if not tmpquery.Eof then
               begin
                 tmpquery.close;//
                 //显示一个界面，提示病人的其它护士站排队信息
                  application.CreateForm(tfrmqthszbrxx, frmqthszbrxx);
                  with frmqthszbrxx do
                  begin
                    frmqthszbrxx.br_cardno := strtm;
                    ShowModal;
                    free;
                  end;
               end;
             except
             end;

             result:=false;
             frmmain.sbrInfo.Panels.Items[0].Text:= '刷卡,没有找到此卡号病人信息!'+'卡号:'+strTM;
             addlog('cardlog.txt','刷卡成功,未找到,'+ttl_br+'信息:'+'卡号:'+strTM);
         end;
         tmpquery.Close;
         if gblWakeupOtherNurseStation<>'' then
         begin
           //激活其它护士站号码。
           WakeupOtherNurseStationNumber(strTm);
         end;
       end  //当前护士站没有找到病人，查询其它护士站的信息,查询到则显示
       else
       begin
         tmpquery.sql.clear;
         tmpquery.SQL.Add('Select kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
         ',brdm,jzbz,d.ztbz,by5,by1,by7,yhid'+
         ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
         ' and d.hszh=k.hszh'+
         ' where by4=''' + strTm+''''+
         ' order by d.ksid desc');
         try
           tmpquery.Open;
           if not tmpquery.Eof then
           begin
             tmpquery.close;//
             //显示一个界面，提示病人的其它护士站排队信息
              application.CreateForm(tfrmqthszbrxx, frmqthszbrxx);
              with frmqthszbrxx do
              begin
                frmqthszbrxx.br_cardno := strtm;
                ShowModal;
                free;
              end;
           end;
         except
         end;
       end;
       FreeAndNil(tmpquery);
       end;
     end;
except on e:Exception do
  begin
    addlog('cardlog.txt','刷卡激活进程出错'+e.Message);
    result := False;
    Exit;
  end;
end;

end;

//查询其它护士站病人信息//
function TdmDBAccess.SetQTHSZItems(var ListView: TTeThemeSListView;
  const acardno, abrdm, abrxm: string): Boolean;
var
  ListItem: TListItem;
  intFieldIndex: integer;
  qr:TADOQuery;
  wherestr:string;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    listview.Columns.Clear;
    ListView.Items.Clear;
    try
      qr.Close;
      if acardno<>'' then
      begin
        wherestr := wherestr +' and t_dhxx.by4='+quotedstr(acardno);
      end;
      if abrdm<>'' then
      begin
        wherestr := wherestr +' and t_dhxx.brdm='+quotedstr(abrdm);
      end;
      if abrxm<>'' then
      begin
        wherestr := wherestr +' and t_dhxx.abrxm='+quotedstr(abrxm);
      end;

      //在等待T_DHXX表中查找科室为KSID的本护士站的就诊的病人信息.
      qr.SQL.Text:=' select h.hszmc as ''    护士站    '''+
                               ',k.ksmc as ''  科室名称  '''+
                               ',t_dhxx.brxm as ''姓  名'''+
                               ',t_dhxx.ghhm as '''+ttl_ghhm+''''+
                               ',t_dhxx.kssxid as ''当前排位'' '+
                               ',t_yh.yhmc as '''+ttl_yh+'姓名'''+
                               ',t_dhxx.ckhm as '''+ttl_zs+''''+
                               ',t_dhxx.ghsj as ''    挂  号  时  间    '''+
                               ',t_dhxx.jzsj as ''    叫  号  时  间    '''+
                               ',t_dhxx.by7 as "预约时段" '+
                               ',t_dhxx.yxjid as "优先级" '+
                               ',s.sjdmc as "时间段" '+
                               ',t_dhxx.by6 as "号别" '+
                               ',t_dhxx.brdm as '''+ttl_br+'编号'''+
                               ' from  ' +
                              ' t_dhxx left OUTER join t_YH on t_dhxx.yhid=t_YH.yhid and t_dhxx.hszh=t_YH.hszh ' +
                              ' left outer join t_sjdsz s on t_dhxx.sjdbz=s.sjdbz and t_dhxx.hszh=s.hszh '+
                              ' left outer join t_hsz h on t_dhxx.hszh=h.hszh '+
                              ' left outer join t_ks k on t_dhxx.hszh=k.hszh and t_dhxx.ksid=k.ksid '+
                              ' where t_dhxx.hszh<>' + inttostr(gblhszh) +
                              wherestr+
                              ' order by t_dhxx.sjdbz,t_dhxx.by6,replicate(''0'',10-len(ghhm))+ghhm  ';
//                              ' order by replicate(''0'',10-len(ghhm))+ghhm  ';
      qr.Open;
      for intfieldindex:=0 to qr.Fields.Count-1 do
      begin
         listview.Columns.Add;
         listview.Columns[intfieldindex].Caption:=qr.Fields.Fields[intfieldindex].FieldName;
         listview.Columns[intfieldindex].Width := (Length(listview.Columns[intfieldindex].Caption)+2) * ListView.Canvas.TextWidth('A');
      end;
      //listview.Columns.Add;
//      if qr.Fields.Count>7 then
//      begin
//        listview.Columns[7].Caption:=qr.Fields.Fields[7].FieldName;
//        listview.Columns[7].Width := 0;
//      end;
//      if qr.Fields.Count>10 then
//      begin
//        //listview.Columns[7].Caption:=qr.Fields.Fields[7].FieldName;
//        listview.Columns[10].Width := 0;
//      end;
      ///////////将数据放入LISTVIEW中.
      with qr do
      begin
         while not qr.Eof do
         begin
            listItem:=listview.Items.add;
            ListItem.Caption := Fields[0].AsString;
            for intFieldIndex := 1 to qr.Fields.Count-1 do
            begin
               ListItem.SubItems.Add(fields.Fields[intFieldIndex].AsString);
            end;
            Next;
         end;
         Close;
      end;
    except
      begin
        result := False;
        Exit;
      end;
    end;
    result := True;
  finally
    FreeAndNil(qr);
  end;
end;


{*******************************************************************************
*函数名:GetCardInfo;
*参数
*astrtm ：卡号
*patinfo是长度为6的字符串数组
*其中数组内容为
*0  姓名
*1  生日   yyyymmdd
*2  性别
*3  床号
*4  电话号码
*5  地址                                         *
*函数机能:从HIS接口表中查询病人信息并返回.*
*返回值：true --找到此卡号信息
false --未找到此卡号信息.
*******************************************************************************}
function Tdmdbaccess.GetCardInfo(const astrTm :string;aksrq:string;ajsrq:string;
  var patinfo:array of string):Boolean;
var
  cmdStr:wideString;
  tmpquery:tadoquery;
  i:integer;
  mr:integer;
  ksid,ksmc,brdm,brxm,ghhm,id,kssxid:string;
  keepYH:Integer;
  intRet:integer;
  strTm:string;
  tmpadosp:TADOStoredProc;
begin
  Result :=False;

  if gblEnterKHXX<>1 then
  begin
    addlog('errorlog.txt','EnterKHXX='+inttostr(gblEnterKHXX));
  end;
  AdoConnHis.ConnectionString := gblKHXXConnstr;
  try
//    AdoConnHis.Open;
    AdoConnHis.Connected := true;
  except
    addlog('errorlog.txt','连接HIS数据库失败!'+gblKHXXConnstr);
    Result := False;
    Exit;
  end;
   strTm :=astrTM;
   if Length(strTm)=28 then //白玉兰卡
   begin
     strTm:=Copy(strTm,1,gblCardNoLen);
   end;
    tmpquery:= tadoquery.Create(nil);
    try
      if gblKHXXLB=8 then
      begin

          try
            for i:=0 to 5 do
            begin
              patinfo[i] :='';
            end;
             tmpquery.Connection:=AdoConnHis;
             tmpquery.SQL.Text:='select *'+
              ' from '+ gblHisViewName+' where cardno=:p1 and Flag=0';
             tmpquery.Parameters.ParamByName('p1').Value := strTm;
             tmpquery.Open;
             if not tmpquery.Eof then
             begin
               patinfo[0] := tmpquery.fieldbyname('patname').AsString;
               try
                 patinfo[1] := tmpquery.fieldbyname('birthday').AsString;
               except
               end;
               try
                 patinfo[2] := tmpquery.fieldbyname('sex').AsString;
               except
               end;
               try
                 patinfo[3] := tmpquery.fieldbyname('bedno').AsString;
               except
               end;
               try
                 patinfo[4] := tmpquery.fieldbyname('tel').AsString;
               except
               end;
               try
                 patinfo[5] := tmpquery.fieldbyname('addr').AsString;
               except
               end;
               try
                 patinfo[6] := tmpquery.fieldbyname('ysdm').AsString;
               except
                 patinfo[6] := '-';
               end;
               try
                 patinfo[7] := tmpquery.fieldbyname('ysxm').AsString;
               except
                 patinfo[7] := '-';
               end;
               Result := True;
             end;
             tmpquery.Close;
          except on e:Exception do
            begin
              addlog('errorlog.txt','查询接口表'+gblhisviewname+'出错:'+e.Message);
              Result :=False;
            end
          end;
      end
      else if gblKHXXLB=30 then
      begin
        try
          try
            for i:=0 to 5 do
            begin
              patinfo[i] :='';
            end;
            tmpadosp := TADOStoredProc.Create(nil);
            tmpadosp.Connection := AdoConnHis;
            tmpadosp.ProcedureName :=gblHisViewName;//'proc_jh_brxx';
            tmpadosp.Parameters.CreateParameter('cardno',ftString,pdInput,30,strTm);
            tmpadosp.Open;
            if not  tmpadosp.Eof then
            begin
                 patinfo[0] := tmpadosp.fieldbyname('patname').AsString;
                 try
                   patinfo[1] := tmpadosp.fieldbyname('birthday').AsString;
                 except
                 end;
                 try
                   patinfo[2] := tmpadosp.fieldbyname('sex').AsString;
                 except
                 end;
                 try
                   patinfo[3] := tmpadosp.fieldbyname('bedno').AsString;
                 except
                 end;
                 try
                   patinfo[4] := tmpadosp.fieldbyname('tel').AsString;
                 except
                 end;
                 try
                   patinfo[5] := tmpadosp.fieldbyname('addr').AsString;
                 except
                 end;
               try
                 patinfo[6] := tmpquery.fieldbyname('ysdm').AsString;
               except
                 patinfo[6] := '-';
               end;
               try
                 patinfo[7] := tmpquery.fieldbyname('ysxm').AsString;
               except
                 patinfo[7] := '-';
               end;
                 Result := True;
            end;
          except on e:Exception do
            begin
              addlog('errorlog.txt','执行存储过程'+gblhisviewname+'出错:'+e.Message);
              Result :=False;
            end
          end;
        finally
          FreeAndNil(tmpadosp);
        end;
      end
      else if gblKHXXLB=31 then
      begin
        try
          try
            for i:=0 to 5 do
            begin
              patinfo[i] :='';
            end;
            tmpadosp := TADOStoredProc.Create(nil);
            tmpadosp.Connection := AdoConnHis;
            tmpadosp.ProcedureName :=gblHisViewName;//'proc_jh_brxx';
            tmpadosp.Parameters.CreateParameter('cardno',ftString,pdInput,30,strTm);
            tmpadosp.Parameters.CreateParameter('kssj',ftString,pdInput,10,aksrq);
            tmpadosp.Parameters.CreateParameter('jssj',ftString,pdInput,10,ajsrq);
            tmpadosp.Open;
            if not  tmpadosp.Eof then
            begin
                 patinfo[0] := tmpadosp.fieldbyname('patname').AsString;
                 try
                   patinfo[1] := tmpadosp.fieldbyname('birthday').AsString;
                 except
                 end;
                 try
                   patinfo[2] := tmpadosp.fieldbyname('sex').AsString;
                 except
                 end;
                 try
                   patinfo[3] := tmpadosp.fieldbyname('bedno').AsString;
                 except
                 end;
                 try
                   patinfo[4] := tmpadosp.fieldbyname('tel').AsString;
                 except
                 end;
                 try
                   patinfo[5] := tmpadosp.fieldbyname('addr').AsString;
                 except
                 end;
               try
                 patinfo[6] := tmpquery.fieldbyname('ysdm').AsString;
               except
                 patinfo[6] := '-';
               end;
               try
                 patinfo[7] := tmpquery.fieldbyname('ysxm').AsString;
               except
                 patinfo[7] := '-';
               end;
                 Result := True;
            end;
          except on e:Exception do
            begin
              addlog('errorlog.txt','执行存储过程'+gblhisviewname+'出错:'+e.Message);
              Result :=False;
            end
          end;
        finally
          FreeAndNil(tmpadosp);
        end;
      end;
    finally
      FreeAndNil(tmpquery);
      AdoConnHis.Close;
    end;
end;
{*******************************************************************************
*函数名:WakeUpByID;
                                           *
*函数机能:检测等待列表中有无autoid=strID未激活病人信息,有则激活此病人.*
*******************************************************************************}
function Tdmdbaccess.WakeUpByID(const strID :string):Boolean;
var
  cmdStr:wideString;
  tmpquery:tadoquery;
  i:integer;
  mr:integer;
  ksid,ksmc,brdm,brxm,ghhm,id,kssxid,by7:string;
  keepYH:Integer;
  RetDB_Wakeupbyid:integer;
  qr1:tadoquery;

begin
try
  addlog('cardlog.txt','进入手动激活进程'+',id='+strid);
  with adoconnection do
  begin
       tmpquery:=tadoquery.Create(nil);
       tmpquery.Connection:=adoconnection;
       tmpquery.SQL.Clear;
       {tmpquery.SQL.Add('Select t_dhxx.id,t_dhxx.ksid,t_ks.ksmc,t_dhxx.brxm,t_dhxx.ghhm from t_dhxx left outer join t_ks on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh where t_dhxx.jzbz=''2'' and t_dhxx.ztbz=''6'' and by4=''' + strTm+'''');}
       tmpquery.SQL.Add('Select kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
         ',brdm,jzbz,d.ztbz,by1,by7'+
         ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
         ' and d.hszh=k.hszh'+
         ' where d.id=' + strID);
//         t_dhxx.jzbz=''2'' and t_dhxx.ztbz=''6'' and
       tmpquery.Open;

       if tmpquery.RecordCount>0 then
       begin
         gbledit_ks_count :=0;
         while not tmpquery.Eof do
         begin
           if ((tmpquery.FieldByName('jzbz').AsString='2')
                and (tmpquery.FieldByName('ztbz').AsString='6')) then//未激活
           begin
//             cmdstr:=' UPDATE t_dhxx ' +
//                    ' set jzbz=''1'',ztbz=''1'' '+
//                    ' where id='+tmpquery.fieldbyname('id').AsString +
//                    ' and hszh=' + inttostr(gblHSZH);
//             execute(cmdstr,cmdtext);

             frmmain.sbrInfo.Panels.Items[0].Text:= '激活成功,'+ttl_br+'信息:'+
                           ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                           ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                           ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring;
             addlog('cardlog.txt','激活成功,'+ttl_br+'信息:'+
                           ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                           ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                           ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring);
             //需要将此病人安排在准备号之后，大号码之前，小号码之后。
             //add by wugang @2012-11-08
             RetDB_Wakeupbyid :=DB_Wakeupbyid(tmpquery.fieldbyname('id').AsString,gblHSZH,False);
             if  RetDB_Wakeupbyid<>-1 then
             begin
               by7 := tmpquery.fieldbyname('by7').AsString;
               if (gblYYSJDJH=1)  //--预约时间段到后才能呼叫
                  and (tmpquery.FieldByName('by1').AsString='88') //是预约病人
                  and (RetDB_Wakeupbyid=2)   then
                  //and (by7>FormatDateTime('hh:nn',now+1/60/24))
               begin
               end
               else
               begin
                 PutWakeupIDAtPos(tmpquery.fieldbyname('id').AsString,gblHSZH);
                 if ((tmpquery.FieldByName('by1').AsString<>'88') and (tmpquery.FieldByName('by1').AsString<>'0')) then
                 begin
                   SZYXJ(tmpquery.fieldbyname('id').AsString,tmpquery.FieldByName('by1').AsString);
                 end;
               end;
               gbledit_ks[gbledit_ks_count].ksid:=tmpquery.fieldbyname('ksid').AsString;
               gbledit_ks[gbledit_ks_count].ksmc:=tmpquery.fieldbyname('ksmc').AsString;
               gbledit_ks_count:=gbledit_ks_count+1;

               printno(tmpquery.fieldbyname('id').AsString);
              qr1 := TADOQuery.Create(nil);
              try
                try
                  qr1.Connection := ADOConnection;
                   qr1.SQL.Text :=' update t_dhxx set dybz=1 where id=:s1';
                   qr1.Parameters.ParamByName('s1').Value := tmpquery.fieldbyname('id').AsString;
                   try
                     qr1.ExecSQL;
                   except

                   end;
                except
                end;
              finally
                freeandnil(qr1);
              end;
             end;
             //add end
             result:=true;
           end ;
           tmpquery.Next;
         end;
       end
       else
       begin
           result:=false;
           frmmain.sbrInfo.Panels.Items[0].Text:= '激活,没有找到此ID号的病人信息!'+'ID:'+strid;
           addlog('cardlog.txt','激活,没有找到此ID号的病人信息!'+'ID:'+strid);
       end;
       tmpquery.Close;
       FreeAndNil(tmpquery);
     end;
except
  begin
    result := False;
    Exit;
  end;
end;
end;
{*******************************************************************************
*函数名:PutWakeupIDToPos;
                                           *
*函数机能:将某一病人放到准备号码之后，小号码与大号码之间.*
*******************************************************************************}
function Tdmdbaccess.PutWakeupIDAtPos(const aid:string;const ahszh:Integer):Boolean;
var
  cmdStr:wideString;
  ydfsmc:string;
  ydfs,ydws:integer;
  Maxkssxid:integer;
  ddbrfzZDXSID:integer;
  ddbrfzZxXSID:integer;
  ddbrZBXSID:integer;
  zhbrxsid:Integer;
  yybrxsid:Integer;
  tmpadoquery:Tadoquery;
//  tmpadoquery1:Tadoquery;
  slKssxid:integer;
  tmpghhm:string;
  tmpyxjgws:integer;
  tmpby7,tmpksid:string;
  tmpsjdbz:string;
  y:integer;
begin
  //2014-09-12//替换为调用存储过程处理 吴刚
  if DB_PutWakeupIDAtPos(aid,ahszh) then
  begin
    result:=true;
    //如果调用存储过程成功，则退出
    exit;
  end;
  /////////////////////////////////////
  try
      tmpadoquery:=Tadoquery.Create(nil);
      tmpadoquery.Connection:=Adoconnection;
      tmpadoquery.Sql.Text:='select ghhm,by7,ksid,kssxid,sjdbz from t_dhxx where id='+aid;
      tmpadoquery.open;
      if not tmpadoquery.eof then
      begin
         tmpghhm:=tmpadoquery.fieldbyname('ghhm').asstring;
         tmpby7 :=tmpadoquery.fieldbyname('by7').asstring;
         tmpksid :=tmpadoquery.fieldbyname('ksid').asstring;
         slKssxid :=tmpadoquery.fieldbyname('kssxid').AsInteger;
         tmpsjdbz := tmpadoquery.fieldbyname('sjdbz').asstring;
      end;
      tmpadoquery.close;
    //得到准备号码位置
      if gblNeedZBXYS=0 then
      begin
      tmpadoquery.Sql.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
          ' t_dhxx ' +
          ' where ksid=(select ksid from t_dhxx where id='+aid+')'+
          ' and ztbz=5 '+
          ' and jzbz=1 ' +
          ' and hszh=' + inttostr(ahszh)+
          ' and id<>'+aid;
      end
      else
      begin
      tmpadoquery.Sql.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
          ' t_dhxx ' +
          ' where ksid=(select ksid from t_dhxx where id='+aid+')'+
          ' and ztbz=5 '+
          ' and jzbz=1 ' +
          ' and hszh=' + inttostr(ahszh)+
          //' and yhid=(select yhid from t_dhxx where id='+aid+')'+
          ' and id<>'+aid;
      end;
      tmpadoquery.Open;
      if tmpadoquery.Eof then
         ddbrZBXSID:=0
      else
         ddbrZBXSID:=tmpadoquery.Fields.Fields[0].AsInteger;
      tmpadoquery.close;

      //得到预约病人的位置
      tmpadoquery.SQL.Text :=' select  max(KSSXID) as max_SXID  from  ' +
        ' t_dhxx ' +
        ' where ksid=(select ksid from t_dhxx where id='+aid+')'+
        ' and yxjid=88'+
        ' and jzbz=1 ' +
        ' and hszh=' + inttostr(ahszh)+
        ' and id<>'+aid;
      tmpadoquery.Open;
      if not tmpadoquery.Eof then
      begin
         yybrxsid:=tmpadoquery.Fields.Fields[0].AsInteger;
         if yybrxsid>ddbrZBXSID then
         begin
             ddbrZBXSID := yybrxsid;
         end;
      end;
      tmpadoquery.Close;

      //得到ghhm小于aid对应ghhm的最大序号
      if gblfzzhtype=1 then
      begin
        tmpadoquery.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=(select ksid from t_dhxx where id='+aid+')'+
            //' and yxjid=''' + yxjID + ''''+
            ' and jzbz=1 and ztbz<>5 ' +
            ' and hszh=' + inttostr(ahszh)+
            //' and kssxid<(select kssxid from t_dhxx where id='+aid+')'+
            ' and replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
            ' and id<>'+aid;
      end
      else
      begin
      tmpadoquery.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
          ' t_dhxx ' +
          ' where ksid=(select ksid from t_dhxx where id='+aid+')'+
          //' and yxjid=''' + yxjID + ''''+
          ' and yxjid<>1'+
          ' and jzbz=1 and ztbz<>5 ' +
          ' and hszh=' + inttostr(ahszh)+
          //' and kssxid<(select kssxid from t_dhxx where id='+aid+')'+
          ' and replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
          ' and id<>'+aid;
      end;
      //getMaxSeqStr(jrid,tmpghhm,tmpby7,YXJID);

      tmpadoquery.Open;
      if tmpadoquery.Eof then
         ddbrfzZDXSID:=0
      else
         ddbrfzZDXSID:=tmpadoquery.Fields.Fields[0].AsInteger;

      tmpadoquery.Close;
    //得到ghhm大于aid对应ghhm的最小序号
      if gblfzzhtype=1 then
      begin
        tmpadoquery.SQL.Text :=' select  Min(KSSXID) as Min_SXID  from  ' +
          ' t_dhxx ' +
          ' where ksid=(select ksid from t_dhxx where id='+aid+')'+
          //' and yxjid=''' + yxjID + ''''+
          ' and jzbz=1 and ztbz<>5' +
          ' and hszh=' + inttostr(ahszh)+
          ' and replicate(''0'',10-len(ghhm))+ghhm>replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
          ' and id<>'+aid;
      end
      else
      begin
        tmpadoquery.SQL.Text :=' select  Min(KSSXID) as Min_SXID  from  ' +
          ' t_dhxx ' +
          ' where ksid=(select ksid from t_dhxx where id='+aid+')'+
          //' and yxjid=''' + yxjID + ''''+
          ' and yxjid<>1'+
          ' and jzbz=1 and ztbz<>5' +
          ' and hszh=' + inttostr(ahszh)+
          ' and replicate(''0'',10-len(ghhm))+ghhm>replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
          ' and id<>'+aid;
      end;
      //getMinSeqStr(jrid,tmpghhm,tmpby7,YXJID);
      tmpadoquery.Open;
      if tmpadoquery.Eof then
         ddbrfzZxXSID:=0
      else
         ddbrfzZxXSID:=tmpadoquery.Fields.Fields[0].AsInteger;
      tmpadoquery.Close;



    //得到yxjid=1 的序号 (即召回病人)
    //不管召回病人的位置//20140529吴刚修改。
//      tmpadoquery.SQL.Text :=' select  Min(KSSXID) as Min_SXID  from  ' +
//        ' t_dhxx ' +
//        ' where ksid=(select ksid from t_dhxx where id='+aid+')'+
//        //' and yxjid=''' + yxjID + ''''+
//        ' and yxjid=1'+
//        ' and jzbz=1 and ztbz<>5' +
//        ' and hszh=' + inttostr(ahszh)+
//        //' and replicate(''0'',10-len(ghhm))+ghhm>replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
//        ' and id<>'+aid;
//      //getMinSeqStr(jrid,tmpghhm,tmpby7,YXJID);
//      tmpadoquery.Open;
//      if not tmpadoquery.Eof then
//      begin
//         zhbrxsid:=tmpadoquery.Fields.Fields[0].AsInteger;
//         if ddbrfzZDXSID=zhbrxsid-1 then
//         begin
//             ddbrfzZDXSID := zhbrxsid;
//         end;
//      end;
//      tmpadoquery.Close;

      if (ddbrfzZDXSID=0) and (ddbrfzZxXSID=0) then
      begin
        //插入到ddbrZBXSID+1位置
        ydfsmc :='移动到';
        ydws:=ddbrZBXSID+1;
      end
      else if (ddbrfzZDXSID=0) and (ddbrfzZxXSID>0) then
      begin
        //插入到ddbrfzZxXSID-1位置
        ydfsmc :='移动到';
        ydws:=ddbrfzZxXSID-1;
        if ydws<1 then ydws:=1;
        if ydws<=ddbrZBXSID then ydws:=ddbrZBXSID+1;
      end
      else
      begin
        //插入到ddbrfzZDXSID+1位置
        ydfsmc :='移动到';
        ydws:=ddbrfzZDXSID+1;
        if ydws<1 then ydws:=1;
        if ydws<=ddbrZBXSID then ydws:=ddbrZBXSID+1;
      end;
      //应该加上时间段位置 2014-09-11 吴刚
      y:=GetLargeSjdbzPos(tmpksid,tmpsjdbz,tmpghhm,aid,ahszh);
      if (y>0) and (ydws>y) then ydws:=y;
      y:=GetMinSjdbzPos(tmpksid,tmpsjdbz,aid,ahszh);
      if (y>0) and (ydws<=y) then ydws:=y+1;
      //y:=GetSameSjdbzPos(tmpksid,tmpsjdbz,tmpghhm,aid,ahszh);
      //if (y>0) and (ydws>y) then ydws:=y+1;
      //////////////////////

      //seleksid:=tmpksid;
      //seleid:=aid;
      TQTH(aid,tmpksid,inttostr(slkssxid),ydfs,ydws);
      result:=true;
  except
    begin
      result := False;
      Exit;
    end;
  end;
end;
{*******************************************************************************
*函数名:CheckTm;
                                           *
*函数机能:检测等待列表中有无by4=StrTm病人信息,有则激活此病人.*
*******************************************************************************}
function Tdmdbaccess.GetSBCardNo():String;
var
  cmdStr:string;
  cardno:string;
  name:string;
  sex:string;
  sfzh:string;
  lxdh:string;
  txdz:string;
  yzbm:string;
  //ss:TScicreader;
begin
  try
    if gblSBType=1 then //上海医保卡
    begin
      cardno := GetSHSBCardNO();
    end
    else if gblSBType=2 then //丽水医保卡
    begin
      cardno := GetLSSBCardNO();
    end
    else if gblSBTYpe=3 then //苏北健康卡
    begin
      cardno :=GetSBYYJKKCardNO();
//      try
//        try
//          ss :=  TScicreader.Create(nil);
//          cardno := ss.ReadRFCard();
//        except
//          cardno :='';
//        end;
//      finally
//        freeandnil(ss);
//      end;
    end
    else if gblSBType=4 then //宁波医保卡
    begin
      cardno :=GetNBSBCardNO();
    end
    else if gblSBType=5 then //台州医保卡
    begin
      cardno :=GetTZSBCardNO();
    end
    else if gblSBType=6 then //嘉兴
    begin
      cardno :=GetJXSBCardNO();
    end
    else if gblSBType=7 then //
    begin
      cardno := GetSHSBCardNO4();
    end;

    result := cardno;
  except on e:Exception do
    begin
      addlog('cardlog.txt','读医保卡错!医保类型:'+ inttostr(gblSBType)+ ' '+ e.Message);
      result := '';
    end;
  end;
end;
{*******************************************************************************
*函数名:CheckTm;
                                           *
*函数机能:检测等待列表中有无by4=StrTm病人信息,有则激活此病人.*
*******************************************************************************}
function Tdmdbaccess.GetSBCardNo_F10():String;
var
  cmdStr:string;
  cardno:string;
  name:string;
  sex:string;
  sfzh:string;
  lxdh:string;
  txdz:string;
  yzbm:string;
  // ss:TScicreader;
begin
  try
    if gblSBType=1 then //上海医保卡
    begin
      cardno := GetSHSBCardNO();
    end
    else if gblSBType=2 then //丽水医保卡
    begin
      cardno := GetLSSBCardNO();
    end
    else if gblSBTYpe=3 then //苏北健康卡
    begin
      cardno :=GetSBYYJKKCardNO();
//      cardno :='';
//      try
//        try
//          ss :=  TScicreader.Create(nil);
//          cardno := ss.ReadRFCard();
//        except
//          cardno :='';
//        end;
//      finally
//        freeandnil(ss);
//      end;
    end
    else if gblSBType=4 then //宁波医保卡-健康卡
    begin
      cardno :=GetNBJKKCardNO();
    end
    else if gblSBType=5 then //台州健康卡、市民卡
    begin
      cardno :=GetTZJKKCardNO();
    end
    else if gblSBType=6 then //嘉兴社保卡
    begin
      cardno :=GetJXSBCardNO();
    end
    else if gblSBType=7 then //
    begin
      cardno := GetSHSBCardNO4();
    end;
    result := cardno;
  except on e:Exception do
    begin
      addlog('cardlog.txt','F10读医保卡错!医保类型:'+ inttostr(gblSBType)+ ' '+ e.Message);
      result := '';
    end;
  end;
end;
{*******************************************************************************
*函数名:CheckTm;
                                           *
*函数机能:检测等待列表中有无by4=StrTm病人信息,有则激活此病人.*
*******************************************************************************}
function Tdmdbaccess.GetSHSBCardNo():String;
var
  cmdStr:string;
  cardno:string;
  name:string;
  sex:string;
  sfzh:string;
  lxdh:string;
  txdz:string;
  yzbm:string;
begin
  try
    if GetBZKxx(CardNo,Name,Sex ,sfzh,lxdh,txdz,yzbm)=0 then
    begin
//           label1.Font.Color:=clTeal;
//           label1.Caption:='读取社保卡信息成功!!';
       result:=cardno;
    end
    else
    begin
//           label1.Font.Color:=clRed;
//           label1.Caption:='读取社保卡信息错误!!';
       result:='';
    end;
  except on e:Exception do
    begin
      addlog('cardlog.txt','读医保卡错!'+e.Message);
      result := '';
    end;
  end;
end;


{*******************************************************************************
*函数名:GetSHSBCardNo5;
                                           *
*函数机能:获取二维码医保卡号.*
*******************************************************************************}
function Tdmdbaccess.GetSHSBCardNo5(const sQRCode:string):String;
var
  cmdStr:string;
  cardno:string;
  name:string;
  sex:string;
  sfzh:string;
  lxdh:string;
  txdz:string;
  yzbm:string;
begin
  try
    if GetBZKxx5(sQRCode,CardNo)=0 then
    begin
       result:=cardno;
    end
    else
    begin
       result:='';
    end;
  except on e:Exception do
    begin
      addlog('cardlog.txt','读医保卡错!'+e.Message);
      result := '';
    end;
  end;
end;
{*******************************************************************************
*函数名:CheckTm;
                                           *
*函数机能:检测等待列表中有无by4=StrTm病人信息,有则激活此病人.*
*******************************************************************************}
function Tdmdbaccess.GetSHSBCardNo4():String;
var
  cmdStr:string;
  cardno:string;
  name:string;
  sex:string;
  sfzh:string;
  lxdh:string;
  txdz:string;
  yzbm:string;
begin
  try
    if GetBZKxxHX(CardNo,Name,Sex ,sfzh,lxdh,txdz,yzbm)=0 then
    begin
//           label1.Font.Color:=clTeal;
//           label1.Caption:='读取社保卡信息成功!!';
       result:=cardno;
    end
    else
    begin
//           label1.Font.Color:=clRed;
//           label1.Caption:='读取社保卡信息错误!!';
       result:='';
    end;
  except on e:Exception do
    begin
      addlog('cardlog.txt','读医保卡错!'+e.Message);
      result := '';
    end;
  end;
end;
{copyright @2005-4-28 by da.wu}
{在数据库表中插公告信息}
function Tdmdbaccess.FBGG(const Aggnr:string;const Abfyy:integer;const Ayywj:string;const Axssc:integer;const Axsph:string;const AHSZH:integer):boolean;
var
  cmdStr:wideString;
  tmpquery:tadoquery;
  retint:integer;
begin
  try
     with adoconnection do
     begin
       tmpquery:=tadoquery.Create(nil);
       tmpquery.Connection:=adoconnection;
       tmpquery.SQL.Clear;
       tmpquery.SQL.text:=' Insert Into ' +
                          ' t_ggxx(ggnr,bfyy,yywj,xssc,xsph,hszh,ztbz) '+
                          ' values('+
                          ' '''+Aggnr+''''+
                          ','+inttostr(Abfyy)+
                          ','''+Ayywj+''''+
                          ','+inttostr(Axssc)+
                          ','''+Axsph+''''+
                          ','+inttostr(Ahszh)+
                          ',1'+
                          ')';

       retint:=tmpquery.ExecSQL ;
       if retint=0 then
          result:=false;
       tmpquery.Close;
       FreeAndNil(tmpquery);
       result:=true;
     end;
  except
    begin
      result := False;
      Exit;
    end;
  end;
end;
Function Tdmdbaccess.ContinueKs(const AYHID:String):integer;
var
  ksid:string;
  cmdstr:widestring;
  qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
     Cmdstr:='update t_YH set ztbz=''0'' where yhid='''+AYHID+''''+ ' and hszh='+inttostr(gblhszh);
     Adoconnection.Execute(cmdstr,cmdtext);

    qr.Close;
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, t_YH.KSID2, t_YH.KSID3' +
              ' FROM t_YH '+
              ' WHERE (t_YH.YHID = ''' + AYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;

    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
           if qr.FieldByName('Ksid1').asstring<>'' then
           begin
               ksid:= qr.FieldByName('Ksid1').asstring;
               Cmdstr:='update t_ks set ztbz=''0'' where ksid='''+ksid+''''+ ' and hszh='+inttostr(gblhszh);
               Adoconnection.Execute(cmdstr,cmdtext);
           end;
           if qr.FieldByName('Ksid2').asstring<>'' then
           begin
               ksid:= qr.FieldByName('Ksid2').asstring;
               Cmdstr:='update t_ks set ztbz=''0'' where ksid='''+ksid+''''+ ' and hszh='+inttostr(gblhszh);
               Adoconnection.Execute(cmdstr,cmdtext);
           end;
           if qr.FieldByName('Ksid3').asstring<>'' then
           begin
               ksid:= qr.FieldByName('Ksid3').asstring;
               Cmdstr:='update t_ks set ztbz=''0'' where ksid='''+ksid+''''+ ' and hszh='+inttostr(gblhszh);
               Adoconnection.Execute(cmdstr,cmdtext);
           end;
           Result:=1;
            // select * from t_hjzd h inner join t_yh y on h.yhid=y.yhid and h.hszh=y.hszh where h.yhid<>'' and h.hszh=1
       end
       else
       begin
           Result:=0;
       end;
       qr.Close;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
Function Tdmdbaccess.PauseKs(const AYHID:String):integer;
var
  tmpquery:Tadoquery;
  ksid:string;
  cmdstr:widestring;
  qr:TADOQuery ;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
     Cmdstr:='update t_Yh set ztbz=''1'' where yhid='''+AYHID+''''+ ' and hszh='+inttostr(gblhszh);
     Adoconnection.Execute(cmdstr,cmdtext);

    qr.Close;
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, t_YH.KSID2, t_YH.KSID3' +
              ' FROM t_YH '+
              ' WHERE (t_YH.YHID = ''' + AYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;

    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
           tmpquery:=tadoquery.Create(nil);
           tmpquery.Connection:=adoconnection;
           tmpquery.SQL.Clear;
           if qr.FieldByName('Ksid1').asstring<>'' then
           begin
               ksid:= qr.FieldByName('Ksid1').asstring;
               tmpquery.SQL.Clear;
               tmpquery.SQL.Add(' select * from t_hjzd h inner join t_yh y on h.yhid=y.yhid and h.hszh=y.hszh where h.yhid<>'''' and h.hszh='+inttostr(gblHszh));
               tmpquery.SQL.Add(' and (y.ksid1='''+ksid+ ''' or y.ksid2='''+ksid+''' or y.ksid3='''+ksid+''')');
               tmpquery.Open;
               if tmpquery.RecordCount=1 then
               //暂停此队列
               begin
                 Cmdstr:='update t_ks set ztbz=''1'' where ksid='''+ksid+''''+ ' and hszh='+inttostr(gblhszh);
                 Adoconnection.Execute(cmdstr,cmdtext);
               end;
               tmpquery.Close;
           end;
           if qr.FieldByName('Ksid2').asstring<>'' then
           begin
               ksid:= qr.FieldByName('Ksid2').asstring;
               tmpquery.SQL.Clear;
               tmpquery.SQL.Add(' select * from t_hjzd h inner join t_yh y on h.yhid=y.yhid and h.hszh=y.hszh where h.yhid<>'''' and h.hszh='+inttostr(gblHszh));
               tmpquery.SQL.Add(' and (y.ksid1='''+ksid+ ''' or y.ksid2='''+ksid+''' or y.ksid3='''+ksid+''')');
               tmpquery.Open;
               if tmpquery.RecordCount=1 then
               //暂停此队列
               begin
                 Cmdstr:='update t_ks set ztbz=''1'' where ksid='''+ksid+''''+ ' and hszh='+inttostr(gblhszh);
                 Adoconnection.Execute(cmdstr,cmdtext);
               end;
               tmpquery.Close;
           end;
           if qr.FieldByName('Ksid3').asstring<>'' then
           begin
               ksid:= qr.FieldByName('Ksid3').asstring;
               tmpquery.SQL.Clear;
               tmpquery.SQL.Add(' select * from t_hjzd h inner join t_yh y on h.yhid=y.yhid and h.hszh=y.hszh where h.yhid<>'''' and h.hszh='+inttostr(gblHszh));
               tmpquery.SQL.Add(' and (y.ksid1='''+ksid+ ''' or y.ksid2='''+ksid+''' or y.ksid3='''+ksid+''')');
               tmpquery.Open;
               if tmpquery.RecordCount=1 then
               //暂停此队列
               begin
                 Cmdstr:='update t_ks set ztbz=''1'' where ksid='''+ksid+''''+ ' and hszh='+inttostr(gblhszh);
                 Adoconnection.Execute(cmdstr,cmdtext);
               end;
               tmpquery.Close;
           end;

           FreeAndNil(tmpquery);
           Result:=1;
            // select * from t_hjzd h inner join t_yh y on h.yhid=y.yhid and h.hszh=y.hszh where h.yhid<>'' and h.hszh=1
       end
       else
       begin
           Result:=0;
       end;
       qr.Close;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
function TdmDBAccess.YHGetZdid(const AIP:string):string;
var
  tmpzdid:integer;
  qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
   try
        qr.Close;
        //在等待T_hjzd表中查找ip=Aip的zdid.
        qr.SQL.Text:=' select zdid,IP from  ' +
                                ' t_hjzd  ' +
                                ' where ip=''' + AIP + ''' and hszh=' + inttostr(gblhszh) ;
        qr.Open;
        ///////////返回数据
        with qr do
        begin
           if not qr.Eof  then
           begin
              tmpzdid:=fields.fields[0].AsInteger ;
              if tmpzdid<10 then
                 Result:='0'+inttostr(tmpzdid)
              else
                 Result:=inttostr(tmpzdid);
           end
           else
              Result:='';
        end;
   except
        result:='';//出错返回未找到信息
   end;
  finally
    FreeAndNil(qr);
  end;
end;
function TdmDBAccess.YHSendWaitNum(const Aksid:string;const Atype:integer):string;
var
  tmpzdid:integer;
  zdidstr:string;
  tmpIp:string;
  i:integer;
  ret:string;
  tmpAdoquery:Tadoquery;
  drv2:Boolean;
begin
   try
        tmpadoquery:=Tadoquery.Create(nil);
        tmpadoquery.Connection:=adoconnection;

        //在等待T_hjzd表中查找ip=Aip的zdid.
        tmpadoquery.SQL.Text:=' select zdid,ip from  ' +
                                ' t_hjzd  ' +
                                ' where yhid in (Select yhid from t_yh_ks where'+
																' ksid='+quotedstr(Aksid)+
                                ' and hszh='+inttostr(gblHSZH)+')'+
                                ' and hszh=' + inttostr(gblhszh);
        tmpadoquery.Open;
        ///////////返回数据
           if not tmpadoquery.Eof  then
           begin
              while not tmpadoquery.Eof do
              begin
                tmpzdid:=tmpadoquery.fieldbyname('zdid').AsInteger  ;
                tmpIp:=tmpadoquery.fieldbyname('ip').AsString;
                if tmpzdid<10 then
                   zdidstr:='0'+inttostr(tmpzdid)
                else
                   zdidstr:=inttostr(tmpzdid);
                for i:=0 to frmmain.ServerSocket1.Socket.ActiveConnections-1 do
                begin
                   if tmpip=frmmain.ServerSocket1.Socket.Connections[i].RemoteAddress then
                   begin
                      if Atype=0 then
                      begin
                         ret:=YHgetwaitnum(zdidstr,'DA');
                         ret:=ret+'|';
                         frmmain.ServerSocket1.Socket.Connections[i].SendText(ret);
                      end;
                      ret:=GetSendList(zdidstr,'DD');
                      ret:=ret+'|' ;
                      frmmain.ServerSocket1.Socket.Connections[i].SendText(ret);
                      //break;
                   end;
                end;
                for i:=0 to frmmain.ServerSocket2.Socket.ActiveConnections-1 do
                begin
                   if tmpip=frmmain.ServerSocket2.Socket.Connections[i].RemoteAddress then
                   begin
                      if Atype=0 then
                      begin
                         ret:=YHgetwaitnum(zdidstr,'DA');
                         ret:=ret+'|';
                         frmmain.ServerSocket2.Socket.Connections[i].SendText(ret);
                      end;
                      ret:=GetSendList(zdidstr,'DD');
                      ret:=ret+'|' ;
                      frmmain.ServerSocket2.Socket.Connections[i].SendText(ret);
                      //break;
                   end;
                end;
                 if (Atype=0) and (gblYJHJ=1) then//如果是无人变有人时发送等待人数到硬件呼叫
                 begin
                   drv2:=false;
                   if uppercase(gsprogram1)='YJQDVER2.EXE' then
                      drv2:=true
                   else if uppercase(gsprogram2)='YJQDVER2.EXE' then
                      drv2:=true
                   else if uppercase(gsprogram3)='YJQDVER2.EXE' then
                      drv2:=true
                   else if uppercase(gsprogram4)='YJQDVER2.EXE' then
                      drv2:=true;
                   if drv2 then
                   ret:=dmdbaccess.YHGetWaitNum(zdidstr,'38')
                   else
                   ret:=dmdbaccess.YHGetWaitNum(zdidstr,'05');
                   if (gblhostname2<>'') and (tmpzdid>gblhardwarelow) then
                   begin
                     if tmpzdid-gblhardwarelow<10 then
                        zdidstr:='0'+inttostr(tmpzdid-gblhardwarelow)
                     else
                        zdidstr:=inttostr(tmpzdid-gblhardwarelow);
                     ret:= zdidstr+copy(ret,3,Length(ret)-2);
                     frmMain.clientsocket2.Socket.SendText(ret);
                   end
                   else
                   begin
                     frmMain.clientsocket1.Socket.SendText(ret);
                   end;
                 end;
                tmpadoquery.next;
              end;
           end
           else
              Result:='';
           tmpadoquery.Close;
           FreeAndNil(tmpadoquery);

   except
        result:='';//出错返回未找到信息
        tmpadoquery.Close;
        FreeAndNil(tmpadoquery);
   end;
end;
//
//发送预设病人数到呼叫终端。
//
function TdmDBAccess.YHSendWaitNumSZ(const Aksid:string;const Atype:integer):string;
var
  tmpzdid:integer;
  zdidstr:string;
  tmpIp:string;
  i:integer;
  ret:string;
  tmpAdoquery:Tadoquery;
  drv2:Boolean;
begin
   try
        tmpadoquery:=Tadoquery.Create(nil);
        tmpadoquery.Connection:=adoconnection;

        //在等待T_hjzd表中查找ip=Aip的zdid.
        tmpadoquery.SQL.Text:=' select zdid,ip from  ' +
                                ' t_hjzd  ' +
                                ' where yhid in (Select yhid from t_yh_ks_sz where'+
																' ksid='+quotedstr(Aksid)+
                                ' and hszh='+inttostr(gblHSZH)+')'+
                                ' and hszh=' + inttostr(gblhszh);
        tmpadoquery.Open;
        ///////////返回数据
           if not tmpadoquery.Eof  then
           begin
              while not tmpadoquery.Eof do
              begin
                tmpzdid:=tmpadoquery.fieldbyname('zdid').AsInteger  ;
                tmpIp:=tmpadoquery.fieldbyname('ip').AsString;
                if tmpzdid<10 then
                   zdidstr:='0'+inttostr(tmpzdid)
                else
                   zdidstr:=inttostr(tmpzdid);
                for i:=0 to frmmain.ServerSocket1.Socket.ActiveConnections-1 do
                begin
                   if tmpip=frmmain.ServerSocket1.Socket.Connections[i].RemoteAddress then
                   begin
                      if Atype=0 then
                      begin
                         ret:=zdidstr+'G1'+'01'+Aksid+','+
                          inttostr(dmdbaccess.GetHJWaitNumKS(Aksid));
                         ret:=ret+'|';
                         frmmain.ServerSocket1.Socket.Connections[i].SendText(ret);
                      end;
                      //break;
                   end;
                end;
                for i:=0 to frmmain.ServerSocket2.Socket.ActiveConnections-1 do
                begin
                   if tmpip=frmmain.ServerSocket2.Socket.Connections[i].RemoteAddress then
                   begin
                      if Atype=0 then
                      begin
                         ret:=zdidstr+'G1'+'01'+Aksid+','+
                          inttostr(dmdbaccess.GetHJWaitNumKS(Aksid));
                         ret:=ret+'|';
                         frmmain.ServerSocket2.Socket.Connections[i].SendText(ret);
                      end;
                      //break;
                   end;
                end;
                tmpadoquery.next;
              end;
           end
           else
              Result:='';
           tmpadoquery.Close;
           FreeAndNil(tmpadoquery);

   except
        result:='';//出错返回未找到信息
        tmpadoquery.Close;
        FreeAndNil(tmpadoquery);
   end;
end;
procedure TdmDBAccess.addlog(filename:string;s:string);
var
fLog: textfile;
begin
if fileexists(ExtractFilePath(Paramstr(0))+fileName) then
begin
Assignfile(fLog,ExtractFilePath(Paramstr(0))+filename);
append(fLog);
writeln(flog,DateTimetostr(now)+' '+s);
closeFile(fLog);
end;
end;

{*******************************************************************************
*函数名:CXHMPXKS;
                                           *
*函数机能:某一科室重新按挂号号码排序病人                                      *
*******************************************************************************}
//function TdmDBAccess.CXHMPXKS(const Aksid:string):boolean;
//var
//  cmdStr:wideString;
//  i,j:integer;
//  qr:tadoquery;
//begin
//  try
//     qr:=TADOQuery.Create(nil);
//     qr.Connection := ADOConnection;
//     qr.SQL.Text :=' select  id  from  ' +
//        ' t_dhxx ' +
//        ' where ksid=''' + Aksid + ''''+
//        ' and jzbz<>''0'' ' +
//        ' and hszh=' + inttostr(gblhszh) +
//        ' order by replicate(''0'',10-len(ghhm))+ghhm ';
//      qr.Open;
//      j:=1;
//      while not qr.Eof do
//      begin
//             cmdstr:=' UPDATE t_dhxx ' +
//                    ' Set kssxid='+inttostr(j)+
//                    ' where id='+qr.fieldbyname('id').AsString ;
//             adoconnection.execute(cmdstr,cmdtext);
//         j:=j+1;
//         qr.Next;
//      end;
//      qr.Close;
//      gbledit_ks_count:=1;
//      gbledit_ks[gbledit_ks_count-1].ksid:=Aksid;
//      gbledit_ks[gbledit_ks_count-1].ksmc:='';
//      result:=true;
//      FreeAndNil(qr);
//  except
//    begin
//      if qr<>nil then
//        FreeAndNil(qr);
//      result := False;
//      Exit;
//    end;
//  end;
//
//end;
function TdmDBAccess.CXHMPXKS(const Aksid:string):boolean;
var
  cmdStr:wideString;
  i,j:integer;
  qr:tadoquery;
begin
  if DB_ReSortGroup(aksid,gblhszh) then //执行存储过程成功
  begin
    gbledit_ks_count:=1;
    gbledit_ks[gbledit_ks_count-1].ksid:=Aksid;
    gbledit_ks[gbledit_ks_count-1].ksmc:='';
    result:=true;
    exit;
  end;
  try
    //先排准备号
     qr:=TADOQuery.Create(nil);
     qr.Connection := ADOConnection;
     qr.SQL.Text :=' select  id  from  ' +
        ' t_dhxx ' +
        ' where ksid=''' + Aksid + ''''+
        ' and jzbz=1 and ztbz=5 ' +
        ' and hszh=' + inttostr(gblhszh) +
        ' order by replicate(''0'',10-len(ghhm))+ghhm ';
      qr.Open;
      j:=1;
      while not qr.Eof do
      begin
             cmdstr:=' UPDATE t_dhxx ' +
                    ' Set kssxid='+inttostr(j)+
                    ' where id='+qr.fieldbyname('id').AsString ;
             adoconnection.execute(cmdstr,cmdtext);
         j:=j+1;
         qr.Next;
      end;
      qr.Close;
      //再排预约号
     qr:=TADOQuery.Create(nil);
     qr.Connection := ADOConnection;
     qr.SQL.Text :=' select  id  from  ' +
        ' t_dhxx ' +
        ' where ksid=''' + Aksid + ''''+
        ' and jzbz=1 and (yxjid=78) and ztbz<>5 ' +
        ' and hszh=' + inttostr(gblhszh) +
        ' order by replicate(''0'',10-len(ghhm))+ghhm ';
      qr.Open;
      //j:=1;
      while not qr.Eof do
      begin
             cmdstr:=' UPDATE t_dhxx ' +
                    ' Set kssxid='+inttostr(j)+
                    ' where id='+qr.fieldbyname('id').AsString ;
             adoconnection.execute(cmdstr,cmdtext);
         j:=j+1;
         qr.Next;
      end;
      qr.Close;
      //再排预约号
     qr:=TADOQuery.Create(nil);
     qr.Connection := ADOConnection;
     qr.SQL.Text :=' select  id  from  ' +
        ' t_dhxx ' +
        ' where ksid=''' + Aksid + ''''+
        ' and jzbz=1 and (yxjid=88 or yxjid=89 or yxjid=18) and ztbz<>5 ' +
        ' and hszh=' + inttostr(gblhszh) +
        ' order by by7,replicate(''0'',10-len(ghhm))+ghhm ';
      qr.Open;
      //j:=1;
      while not qr.Eof do
      begin
             cmdstr:=' UPDATE t_dhxx ' +
                    ' Set kssxid='+inttostr(j)+
                    ' where id='+qr.fieldbyname('id').AsString ;
             adoconnection.execute(cmdstr,cmdtext);
         j:=j+1;
         qr.Next;
      end;
      qr.Close;
      //再普通号
     qr:=TADOQuery.Create(nil);
     qr.Connection := ADOConnection;
     qr.SQL.Text :=' select  id  from  ' +
        ' t_dhxx ' +
        ' where ksid=''' + Aksid + ''''+
        ' and jzbz=1 and (yxjid<>78 and yxjid<>88 and yxjid<>89 and yxjid<>18) and ztbz<>5 ' +
        ' and hszh=' + inttostr(gblhszh) +
        ' order by sjdbz,replicate(''0'',10-len(ghhm))+ghhm ';
      qr.Open;
      //j:=1;
      while not qr.Eof do
      begin
             cmdstr:=' UPDATE t_dhxx ' +
                    ' Set kssxid='+inttostr(j)+
                    ' where id='+qr.fieldbyname('id').AsString ;
             adoconnection.execute(cmdstr,cmdtext);
         j:=j+1;
         qr.Next;
      end;
      qr.Close;
      //再未到时号
     qr:=TADOQuery.Create(nil);
     qr.Connection := ADOConnection;
     qr.SQL.Text :=' select  id  from  ' +
        ' t_dhxx ' +
        ' where ksid=''' + Aksid + ''''+
        ' and jzbz=2 and ztbz=8 and (by1=88)' +
        ' and hszh=' + inttostr(gblhszh) +
        ' order by by7,replicate(''0'',10-len(ghhm))+ghhm ';
      qr.Open;
      //j:=1;
      while not qr.Eof do
      begin
             cmdstr:=' UPDATE t_dhxx ' +
                    ' Set kssxid='+inttostr(j)+
                    ' where id='+qr.fieldbyname('id').AsString ;
             adoconnection.execute(cmdstr,cmdtext);
         j:=j+1;
         qr.Next;
      end;
      qr.Close;
      //再未激活号
     qr:=TADOQuery.Create(nil);
     qr.Connection := ADOConnection;
     qr.SQL.Text :=' select  id  from  ' +
        ' t_dhxx ' +
        ' where ksid=''' + Aksid + ''''+
        ' and jzbz=2 and ztbz=6 ' +
        ' and hszh=' + inttostr(gblhszh) +
        ' order by sjdbz,replicate(''0'',10-len(ghhm))+ghhm ';
      qr.Open;
      //j:=1;
      while not qr.Eof do
      begin
             cmdstr:=' UPDATE t_dhxx ' +
                    ' Set kssxid='+inttostr(j)+
                    ' where id='+qr.fieldbyname('id').AsString ;
             adoconnection.execute(cmdstr,cmdtext);
         j:=j+1;
         qr.Next;
      end;
      qr.Close;

      gbledit_ks_count:=1;
      gbledit_ks[gbledit_ks_count-1].ksid:=Aksid;
      gbledit_ks[gbledit_ks_count-1].ksmc:='';
      result:=true;
      FreeAndNil(qr);
  except
    begin
      if qr<>nil then
        FreeAndNil(qr);
      result := False;
      Exit;
    end;
  end;

end;

{*******************************************************************************
*函数名:CXHMPXKS_ghsj;
                                           *
*函数机能:某一科室重新按挂号号码排序病人                                      *
*******************************************************************************}
function TdmDBAccess.CXHMPXKS_ghsj(const Aksid:string):boolean;
var
  cmdStr:wideString;
  i,j:integer;
  qr:tadoquery;
begin
  try
     qr:=TADOQuery.Create(nil);
     qr.Connection := ADOConnection;
     qr.SQL.Text :=' select  id  from  ' +
        ' t_dhxx ' +
        ' where ksid=''' + Aksid + ''''+
        ' and jzbz<>''0'' ' +
        ' and hszh=' + inttostr(gblhszh) +
        ' order by convert(varchar(10),ghsj,112),replicate(''0'',10-len(ghhm))+ghhm ';
      qr.Open;
      j:=1;
      while not qr.Eof do
      begin
             cmdstr:=' UPDATE t_dhxx ' +
                    ' Set kssxid='+inttostr(j)+
                    ' where id='+qr.fieldbyname('id').AsString ;
             adoconnection.execute(cmdstr,cmdtext);
         j:=j+1;
         qr.Next;
      end;
      qr.Close;
      gbledit_ks_count:=1;
      gbledit_ks[gbledit_ks_count-1].ksid:=Aksid;
      gbledit_ks[gbledit_ks_count-1].ksmc:='';
      result:=true;
      FreeAndNil(qr);
  except
    begin
      if qr<>nil then
        FreeAndNil(qr);
      result := False;
      Exit;
    end;
  end;


end;

{*******************************************************************************
*函数名:CXPXKSXX;
                                           *
*函数机能:重新按挂号号码排序病人                                      *
*******************************************************************************}
function TdmDBAccess.CXPXKSXX():boolean;
var
  cmdStr:wideString;
  i,j:integer;
  qr:tadoquery;
begin
  try
     qr:=TADOQuery.Create(nil);
     qr.Connection := ADOConnection;
     for i :=1 to gbledit_ks_count do
     begin
         qr.SQL.Text :=' select  id  from  ' +
            ' t_dhxx ' +
            ' where ksid=''' + gbledit_ks[i-1].ksid + ''''+
            ' and jzbz<>''0'' ' +
            ' and hszh=' + inttostr(gblhszh) +
            ' order by replicate(''0'',10-len(ghhm))+ghhm  ';
        qr.Open;
        j:=1;
        while not qr.Eof do
        begin
               cmdstr:=' UPDATE t_dhxx ' +
                      ' Set kssxid='+inttostr(j)+
                      ' where id='+qr.fieldbyname('id').AsString ;
               adoconnection.execute(cmdstr,cmdtext);
           j:=j+1;
           qr.Next;
        end;
        qr.Close;

     end;
     result:=true;
    FreeAndNil(qr);
  except
    begin
      if qr<>nil then FreeAndNil(qr);
      result := False;
      Exit;
    end;
  end;

end;

{*******************************************************************************
*函数名:YHInsertTopCall;
                                           *
*函数机能:插到窗口前面                                    *
*******************************************************************************}
function TdmDBAccess.YHInsertTopCall(const ZDID: string; const cmd:string;const Callno:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   cmdstrks:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc:string;
   DDRS:integer;
   iscall :boolean;
   tmpquery:tADOQUERY;
   tmpksid:string;
   tmpyhid:string;
   tmpksmc:string;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////查看登录情况.
    with qr do
    begin
       if not qr.Eof  then
         begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             if (cmd='42') then
              result:=zdid +cmd  +'还没有登录!    请登录工号'
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
          end
       else
         begin
           if (cmd='42') then
              result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置!'
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
         end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.sql.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM (((t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH) ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH) ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH) ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
           if (cmd='42') then
              result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置!'
           else
             result:=zdid + cmd + '048888';  //没有找到呼叫的队列
             exit;
           end;
           close;
       end
       else
       begin
           if (cmd='42') then
              result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置!'
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    ////查找T_DHXX表中此队列的病人.
    if hjksnum>0 then
    begin
       cmdstr:='';
       cmdstrks:='';
       for i:=1 to hjksnum do
       begin
          if length(cmdstrks)>0 then
             cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
          else
             cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
       end;
       if Length(cmdstrks)>0 then
          cmdstrks :='('+ cmdstrks+')';
        cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where (' + cmdstrks  +')' +
               ' and t_dhxx.jzbz=''1''' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh) ;
        qr.SQL.Text:=cmdstr;
        qr.Open;
        ddrs:=qr.RecordCount;
        qr.Close ;
       //找到最近呼叫的客户
       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where (' + cmdstrks  +')' +
               ' and t_dhxx.jzbz=''0''' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.yhid=''' + zdyhid + ''''+
               ' and t_dhxx.jzsj is not null ' +
               ' order by t_dhxx.jzsj desc ';
        qr.SQL.Text:=cmdstr;
        qr.Open;
        ///////////.
        with qr do
        begin
           if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的客户信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                for i:=1 to hjksnum do
                begin
                    if hjks[i].TGroupid= fields.Fields[6].AsString then
                       break;
                end;
               // DDRs:=RecordCount;

               ////找到窗口CallNO的呼叫终端的呼叫队列，并将当前客户转换到此队列中。
               {}
               tmpquery:=tadoquery.Create(nil);
               tmpquery.Connection:=adoconnection;
               tmpquery.SQL.Clear;
               cmdstr:=' select zdid,fjh,zth,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and FJH=' + callno ;
               tmpquery.SQL.Add(cmdstr);
               tmpquery.Open;
               if tmpquery.Eof then
               begin
                  iscall:=false;
               end
               else
               begin
                  //取得登录CALLNO的登录用户
                  tmpyhid:=tmpquery.fieldbyname('yhid').asstring;
               end;
               tmpquery.Close;
               if length(tmpyhid)=0 then
                  iscall:=false
               else
               begin
                   //查找此用户的呼叫科室
                 tmpquery.SQL.Clear;
                 cmdstr:= 'SELECT t_YH.YHID, t_YH.YHMC,' +
                          ' t_YH.KSID1, table1.KSMC AS ksmc1 ' +
                          ' FROM (t_YH LEFT OUTER JOIN ' +
                          ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH) ' +
                          ' WHERE (t_YH.YHID = ''' + tmpYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
                 tmpquery.SQL.Add(cmdstr);
                 tmpquery.Open;
                 if tmpquery.Eof then
                    iscall:=false
                 else
                 begin
                   tmpksid:=tmpquery.fieldbyname('ksid1').asstring;
                   tmpksmc:=tmpquery.fieldbyname('ksmc1').asstring;
                   if (tmpksid=hjks[1].TGroupid) then
                   begin
                      FZZH(jrid,tmpksid,0,'',1);
                      xzys(jrid,tmpyhid);
                      if tqth(jrid,tmpksid,'1',0,1) then
                      begin
                         gbledit_ks_count:=1;
                         gbledit_ks[gbledit_ks_count-1].ksid:=tmpksid;
                         gbledit_ks[gbledit_ks_count-1].ksmc:=tmpksmc;
                      end;
                   end
                   else
                   begin
                     //FZZH(jrid,hjksid[1],0,'');
                     xzys(jrid,tmpyhid);
                     if hks(jrid,'1',hjks[1].TGroupid,tmpksid) then
                     begin
                        if tqth(jrid,tmpksid,'1',0,1) then
                        begin
                           gbledit_ks_count:=2;
                           gbledit_ks[0].ksid:=tmpksid;
                           gbledit_ks[0].ksmc:=tmpksmc;
                           gbledit_ks[1].ksid:=hjks[1].TGroupid;
                           gbledit_ks[1].ksmc:=hjks[i].TGroupName;
                        end;
                     end;
                   end;
                   //////////////////////////////////////////////////////////////////
                    if cmd='92' then
                       result:=zdid +cmd  +'016666'
                    else if cmd='42' then
                       result:=zdid +cmd  +'插前操作成功!  '+getstrwithnotbadcode(brxm,8)+'人数'+inttostr(DDRS)
                    else
                       result:=zdid +cmd  +'016666' + ',' +BRXM + ',' + inttostr(DDRS);
                    iscall:=true;
                 end;
                end;
                FreeAndNil(tmpquery);
            end;
            close;
        end;
       end;
       if iscall=false  then
          begin
            if cmd='42' then
               result:=zdid +cmd  +'插前操作失败!  '+'没有呼叫过号码!'
            else
            result:=zdid +cmd  +'007777'  ;
          end;


  except
    begin
      if cmd='42' then
         result:=zdid +cmd  +'插前操作失败!  '+'操作时有错误!'
      else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
{*******************************************************************************
*函数名:YHInsertBottomCall;
                                           *
*函数机能:插到窗口后面                                    *
*******************************************************************************}
function TdmDBAccess.YHInsertBottomCall(const ZDID: string; const cmd:string;const Callno:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array[1..20] of CallGroup_Info;
   cmdstr:widestring;
   cmdstrks:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc:string;
   DDRS:integer;
   iscall :boolean;
   tmpquery:tADOQUERY;
   tmpksid:string;
   tmpyhid:string;
   tmpksmc:string;
   qr : TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      result:='';
      iscall:=false;
      qr.Close;
      //在等待T_hjzd表中查找zdid.
      qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                              ' t_hjzd left outer join t_yh on ' +
                              ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                              ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
      qr.Open;
      ///////////查看登录情况.
      with qr do
      begin
         if not qr.Eof  then
           begin
            zdyhid:=fields.fields[4].asstring ;
            zdyhmc:=fields.fields[5].asstring;
            fjh:=fields.Fields[1].AsString;
            fjmc:=fields.Fields[6].AsString;
            zth:=fields.Fields[2].AsString;
            ztmc:=fields.Fields[3].AsString;
            if ( zdyhid <>'')  then
               begin
               close;
               end
            else
               begin
              if (cmd='35') or (cmd='63') then
                 result:=zdid +cmd  +'还没有登录!    '+'请登录工号'
              else
               result:=zdid+cmd + '028888';///没有登录.
               close;
               exit;
               end;
            end
         else
           begin
              if (cmd='35') or (cmd='63') then
                 result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置!'
              else
               result:=zdid + cmd + '038888';  ///没有此呼叫器
             close ;
             exit;
           end;
      end;
      //在等待T_YH表中查找YHID信息.
      qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
                ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
                ' FROM (((t_YH LEFT OUTER JOIN ' +
                ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH) ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH) ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH) ' +
                ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
      qr.Open;
      ///////////将中.
      with qr do
      begin
         if not qr.Eof  then
         begin
//            hjksnum:=1;
//            for intFieldsIndex:=2 to 7 do
//            begin
//                if intFieldsIndex mod 2 =0 then Continue ;
//                if fields.fields[intFieldsIndex].asstring<>''  then
//                   begin
//                     hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                     hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                     hjksnum:=hjksnum+1;
//                   end;
//            end;
            GetYHCallKS(zdyhid,hjksnum,hjks);
            if hjksnum=0 then
             begin
              if (cmd='35') or (cmd='63') then
                 result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置! '
              else
                 result:=zdid + cmd + '048888';  //没有找到呼叫的队列
               exit;
             end;
             close;
         end
         else
         begin
              if (cmd='35') or (cmd='63') then
                 result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置!'
              else
               result:=zdid + cmd + '008888';  //没有此用户号
             Close;
             exit;
         end;
      end;
      ////查找T_DHXX表中此队列的病人.
      if hjksnum>0 then
      begin
         cmdstr:='';
         cmdstrks:='';
         for i:=1 to hjksnum do
         begin
            if length(cmdstrks)>0 then
               cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
            else
               cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
         end;
         if Length(cmdstrks)>0 then
            cmdstrks :='('+ cmdstrks+')';
          cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where (' + cmdstrks  +')' +
                 ' and t_dhxx.jzbz=''1''' +
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) ;
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ddrs:=qr.RecordCount;
          qr.Close ;
         //找到最近呼叫的客户
         cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where (' + cmdstrks  +')' +
                 ' and t_dhxx.jzbz=''0''' +
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and t_dhxx.yhid=''' + zdyhid + ''''+
                 ' and t_dhxx.jzsj is not null ' +
                 ' order by t_dhxx.jzsj desc ';
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////.
          with qr do
          begin
             if not qr.Eof  then
              begin
                  //在T_DHXX表中查找到要呼叫的客户信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  GHHM:=fields.fields[3].asstring;
                  YXJID:=Fields.Fields[4].asString;
                  yxjmc:=fields.fields[5].asstring;
                  for i:=1 to hjksnum do
                  begin
                      if hjks[i].TGroupid= fields.Fields[6].AsString then
                         break;
                  end;
                 // DDRs:=RecordCount;

                 ////找到窗口CallNO的呼叫终端的呼叫队列，并将当前客户转换到此队列中。
                 {}
                 tmpquery:=tadoquery.Create(nil);
                 tmpquery.Connection:=adoconnection;
                 tmpquery.SQL.Clear;
                 cmdstr:=' select zdid,fjh,zth,t_hjzd.yhid,yhmc,fjmc from  ' +
                              ' t_hjzd left outer join t_yh on ' +
                              ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                              ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and FJH=' + callno ;
                 tmpquery.SQL.Add(cmdstr);
                 tmpquery.Open;
                 if tmpquery.Eof then
                 begin
                    iscall:=false;
                 end
                 else
                 begin
                    //取得登录CALLNO的登录用户
                    tmpyhid:=tmpquery.fieldbyname('yhid').asstring;
                 end;
                 tmpquery.Close;
                 if length(tmpyhid)=0 then
                    iscall:=false
                 else
                 begin
                     //查找此用户的呼叫科室
                   tmpquery.SQL.Clear;
                   cmdstr:= ' SELECT t_YH.YHID, t_YH.YHMC,' +
                            ' t_YH.KSID1, table1.KSMC AS ksmc1 ' +
                            ' FROM (t_YH LEFT OUTER JOIN ' +
                            ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH) ' +
                            ' WHERE (t_YH.YHID = ''' + tmpYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;

                   tmpquery.SQL.Add(cmdstr);
                   tmpquery.Open;
                   if tmpquery.Eof then
                      iscall:=false
                   else
                   begin
                     tmpksid:=tmpquery.fieldbyname('ksid1').asstring;
                     tmpksmc:=tmpquery.fieldbyname('ksmc1').asstring;
                     if (tmpksid=hjks[1].TGroupid) then
                     begin
                        FZZH(jrid,tmpksid,0,'',1);
                        xzys(jrid,tmpyhid);
                        if tqth(jrid,tmpksid,'1',2,50) then
                        begin
                           gbledit_ks_count:=1;
                           gbledit_ks[gbledit_ks_count-1].ksid:=tmpksid;
                           gbledit_ks[gbledit_ks_count-1].ksmc:=tmpksmc;
                        end;
                     end
                     else
                     begin
                       //FZZH(jrid,hjksid[1],0,'');
                       xzys(jrid,tmpyhid);
                       if hks(jrid,'1',hjks[1].TGroupid,tmpksid) then
                       begin
                             gbledit_ks_count:=2;
                             gbledit_ks[0].ksid:=tmpksid;
                             gbledit_ks[0].ksmc:=tmpksmc;
                             gbledit_ks[1].ksid := hjks[1].TGroupid;
                             gbledit_ks[1].ksmc := hjks[i].TGroupName;
                       end;
                     end;
                     //////////////////////////////////////////////////////////////////
                      if cmd='85' then
                         result:=zdid +cmd  +'016666'
                      else if (cmd='35') or (cmd='63') then
                         result:=zdid +cmd  +'插后操作成功!  '+getstrwithnotbadcode(brxm,8)+'人数'+inttostr(DDRS)
                      else
                         result:=zdid +cmd  +'016666' + ',' +BRXM + ',' + inttostr(DDRS);
                      iscall:=true;
                   end;
                  end;
                  FreeAndNil(tmpquery);
              end;
              close;
          end;
         end;
         if iscall=false  then
            begin
             if (cmd='35') or (cmd='63') then
                result:=zdid +cmd  +'插后操作失败!  '+'没有呼叫号码!'
             else
              result:=zdid +cmd  +'007777'  ;
            end;


    except
      begin
        if (cmd='35') or (cmd='63') then
          result:=zdid +cmd  +'插后操作失败!  '+'操作时有错误!'
        else
        result := zdid + cmd + '068888';  ///有错误发生.
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:YHMoveToNext;
                                           *
*函数机能:转移到下一个流程队列                                   *
*******************************************************************************}
function TdmDBAccess.YHMoveToNext(const ZDID: string; const cmd:string;const Callno:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   cmdstrks:widestring;
   ksid,kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,lc:string;
   DDRS:integer;
   iscall :boolean;
   tmpquery:tADOQUERY;
   tmpksid:string;
   tmpyhid:string;
   tmpksmc:string;
   qr : TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      result:='';
      iscall:=false;
      qr.Close;
      //在等待T_hjzd表中查找zdid.
      qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                              ' t_hjzd left outer join t_yh on ' +
                              ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                              ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
      qr.Open;
      ///////////查看登录情况.
      with qr do
      begin
         if not qr.Eof  then
           begin
            zdyhid:=fields.fields[4].asstring ;
            zdyhmc:=fields.fields[5].asstring;
            fjh:=fields.Fields[1].AsString;
            fjmc:=fields.Fields[6].AsString;
            zth:=fields.Fields[2].AsString;
            ztmc:=fields.Fields[3].AsString;
            if ( zdyhid <>'')  then
               begin
               close;
               end
            else
               begin
              if (cmd='45')  then
                 result:=zdid +cmd  +'还没有登录!    '+'请登录工号'
              else
               result:=zdid+cmd + '028888';///没有登录.
               close;
               exit;
               end;
            end
         else
           begin
              if (cmd='45')  then
                 result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置!'
              else
               result:=zdid + cmd + '038888';  ///没有此呼叫器
             close ;
             exit;
           end;
      end;
      //在等待T_YH表中查找YHID信息.
      qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
                ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
                ' FROM (((t_YH LEFT OUTER JOIN ' +
                ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH) ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH) ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH) ' +
                ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
      qr.Open;
      ///////////将中.
      with qr do
      begin
         if not qr.Eof  then
         begin
//            hjksnum:=1;
//            for intFieldsIndex:=2 to 7 do
//            begin
//                if intFieldsIndex mod 2 =0 then Continue ;
//                if fields.fields[intFieldsIndex].asstring<>''  then
//                   begin
//                     hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                     hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                     hjksnum:=hjksnum+1;
//                   end;
//            end;
            GetYHCallKS(zdyhid,hjksnum,hjks);
            if hjksnum=0 then
             begin
              if (cmd='45')  then
                 result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置! '
              else
                 result:=zdid + cmd + '048888';  //没有找到呼叫的队列
               exit;
             end;
             close;
         end
         else
         begin
              if (cmd='45') then
                 result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置!'
              else
               result:=zdid + cmd + '008888';  //没有此用户号
             Close;
             exit;
         end;
      end;
      ////查找T_DHXX表中此队列的病人.
      if hjksnum>0 then
      begin
         cmdstr:='';
         cmdstrks:='';
         for i:=1 to hjksnum do
         begin
            if length(cmdstrks)>0 then
               cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
            else
               cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
         end;
         if Length(cmdstrks)>0 then
            cmdstrks :='('+ cmdstrks+')';
          cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where (' + cmdstrks  +')' +
                 ' and t_dhxx.jzbz=''1''' +
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) ;
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ddrs:=qr.RecordCount;
          qr.Close ;
          //if length(callno)=0 then
          begin
         //找到最近呼叫的客户
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,lc from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where (' + cmdstrks  +')' +
                 ' and t_dhxx.jzbz=''0''' +
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and t_dhxx.yhid=''' + zdyhid + ''''+
                 ' and t_dhxx.jzsj is not null ' +
                 ' order by t_dhxx.jzsj desc ';
          end;
//          else
//          begin
//            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,lc from  ' +
//                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
//                 ' where (' + cmdstrks  +')' +
//                 ' and t_dhxx.jzbz=''0''' +
//                 ' and t_dhxx.ghhm='+quotedstr(callno)+
//                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
//                 ' and t_dhxx.yhid=''' + zdyhid + ''''+
//                 ' and t_dhxx.jzsj is not null ' +
//                 ' order by t_dhxx.jzsj desc ';
//          end;
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////.
          with qr do
          begin
             if not qr.Eof  then
              begin
                  //在T_DHXX表中查找到要呼叫的客户信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  GHHM:=fields.fields[3].asstring;
                  YXJID:=Fields.Fields[4].asString;
                  yxjmc:=fields.fields[5].asstring;
                  lc := fields.fields[7].asstring;
                  if lc='' then
                    lc:='0';
                  ksid :=fields.Fields[6].AsString;
                  for i:=1 to hjksnum do
                  begin
                      if hjks[i].TGroupid= ksid then
                         break;
                  end;
                 // DDRs:=RecordCount;

                 ////找到窗口CallNO的呼叫终端的呼叫队列，并将当前客户转换到此队列中。
                 {}
                 tmpquery:=tadoquery.Create(nil);
                 tmpquery.Connection:=adoconnection;
                 tmpquery.SQL.Clear;
                 cmdstr:=' select 1 from  ' +
                              ' t_lc  ' +
                              ' where hszh=' + inttostr(gblhszh) + ' and LCID=' + lc ;
                 tmpquery.SQL.Add(cmdstr);
                 tmpquery.Open;
                 if tmpquery.Eof then
                 begin
                    iscall:=false;
                 end
                 else
                 begin
                   iscall := True;
                 end;
                 tmpquery.Close;
                 if iscall then
                 begin
                     //查找此用户的呼叫科室
                   tmpquery.SQL.Clear;
                   cmdstr:= ' select top 1 ksid  from t_lcxx'+
                     ' where lcid='+lc+
                     ' and lcxh>(select lcxh from t_lcxx'+
                      ' where lcid='+lc+' and ksid='+quotedstr(ksid)+')'+
                     ' order by lcxh';
                   tmpquery.SQL.Add(cmdstr);
                   tmpquery.Open;
                   if tmpquery.Eof then
                      iscall:=false
                   else
                   begin
                     tmpksid:=tmpquery.fieldbyname('ksid').asstring;
                     tmpksmc:=tmpquery.fieldbyname('ksid').asstring;
                     if (tmpksid=ksid) then
                     begin
                        FZZH(jrid,tmpksid,0,'',1);
                        //xzys(jrid,tmpyhid);
                        if tqth(jrid,tmpksid,'1',2,500) then
                        begin
                           gbledit_ks_count:=1;
                           gbledit_ks[gbledit_ks_count-1].ksid:=tmpksid;
                           gbledit_ks[gbledit_ks_count-1].ksmc:=tmpksmc;
                        end;
                     end
                     else
                     begin
                       //FZZH(jrid,hjksid[1],0,'');
                       //xzys(jrid,tmpyhid);
                       if hks(jrid,'1',ksid,tmpksid) then
                       begin
                             //TQTH(jrid,ksid,0,0,1);
                             //if True then//如果是插前则插入到队列最前面。
                             //  TQTH(jrid,ksid,0,0,1);
                             SZYXJ(JRID,'99'); //设置优先级为换队列
                             gbledit_ks_count:=2;
                             gbledit_ks[0].ksid:=tmpksid;
                             gbledit_ks[0].ksmc:=tmpksmc;
                             gbledit_ks[1].ksid:=ksid;
                       end;
                     end;
                     //////////////////////////////////////////////////////////////////
                      if cmd='95' then
                         result:=zdid +cmd  +'016666'
                      else if (cmd='45') then
                         result:=zdid +cmd  +'插后操作成功!  '+getstrwithnotbadcode(brxm,8)+'人数'+inttostr(DDRS)
                      else
                        result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS);//+','+brdm+','+by4+','+hjks[i].TGroupid;
                         //result:=zdid +cmd  +'016666' + ',' +BRXM + ',' + inttostr(DDRS);
                      iscall:=true;
                   end;
                  end;
                  FreeAndNil(tmpquery);
              end;
              close;
          end;
         end;
         if iscall=false  then
            begin
             if (cmd='45') then
                result:=zdid +cmd  +'插后操作失败!  '+'没有呼叫号码!'
             else
              result:=zdid +cmd  +'007777'  ;
            end;


    except
      begin
        if (cmd='45') then
          result:=zdid +cmd  +'插后操作失败!  '+'操作时有错误!'
        else
        result := zdid + cmd + '068888';  ///有错误发生.
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
{*******************************************************************************
*函数名:YHMoveToNext;
                                           *
*函数机能:转移到下一个流程队列                                   *
*******************************************************************************}
function TdmDBAccess.YHMoveToNextByID(const ZDID: string; const cmd:string;const ajrid:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   cmdstrks:widestring;
   ksid,kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,lc:string;
   DDRS:integer;
   iscall :boolean;
   tmpquery:tADOQUERY;
   tmpksid:string;
   tmpyhid:string;
   tmpksmc:string;
   qr : TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      result:='';
      iscall:=false;
      qr.Close;
      //在等待T_hjzd表中查找zdid.
      qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                              ' t_hjzd left outer join t_yh on ' +
                              ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                              ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
      qr.Open;
      ///////////查看登录情况.
      with qr do
      begin
         if not qr.Eof  then
           begin
            zdyhid:=fields.fields[4].asstring ;
            zdyhmc:=fields.fields[5].asstring;
            fjh:=fields.Fields[1].AsString;
            fjmc:=fields.Fields[6].AsString;
            zth:=fields.Fields[2].AsString;
            ztmc:=fields.Fields[3].AsString;
            if ( zdyhid <>'')  then
               begin
               close;
               end
            else
               begin
              if (cmd='45')  then
                 result:=zdid +cmd  +'还没有登录!    '+'请登录工号'
              else
               result:=zdid+cmd + '028888';///没有登录.
               close;
               exit;
               end;
            end
         else
           begin
              if (cmd='45')  then
                 result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置!'
              else
               result:=zdid + cmd + '038888';  ///没有此呼叫器
             close ;
             exit;
           end;
      end;
      //在等待T_YH表中查找YHID信息.
      qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
                ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
                ' FROM (((t_YH LEFT OUTER JOIN ' +
                ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH) ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH) ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH) ' +
                ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
      qr.Open;
      ///////////将中.
      with qr do
      begin
         if not qr.Eof  then
         begin
//            hjksnum:=1;
//            for intFieldsIndex:=2 to 7 do
//            begin
//                if intFieldsIndex mod 2 =0 then Continue ;
//                if fields.fields[intFieldsIndex].asstring<>''  then
//                   begin
//                     hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                     hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                     hjksnum:=hjksnum+1;
//                   end;
//            end;
            GetYHCallKS(zdyhid,hjksnum,hjks);
            if hjksnum=0 then
             begin
              if (cmd='45')  then
                 result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置! '
              else
                 result:=zdid + cmd + '048888';  //没有找到呼叫的队列
               exit;
             end;
             close;
         end
         else
         begin
              if (cmd='45') then
                 result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置!'
              else
               result:=zdid + cmd + '008888';  //没有此用户号
             Close;
             exit;
         end;
      end;
      ////查找T_DHXX表中此队列的病人.
      if hjksnum>0 then
      begin
         cmdstr:='';
         cmdstrks:='';
         for i:=1 to hjksnum do
         begin
            if length(cmdstrks)>0 then
               cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
            else
               cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
         end;
         if Length(cmdstrks)>0 then
            cmdstrks :='('+ cmdstrks+')';
          cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where (' + cmdstrks  +')' +
                 ' and t_dhxx.jzbz=''1''' +
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) ;
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ddrs:=qr.RecordCount;
          qr.Close ;
          if length(ajrid)>0 then
          begin
         //找到最近呼叫的客户
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,lc from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where id='+ajrid+
//                 (' + cmdstrks  +')' +
//                 ' and t_dhxx.jzbz=''0''' +
//                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
//                 ' and t_dhxx.yhid=''' + zdyhid + ''''+
//                 ' and t_dhxx.jzsj is not null ' +
                 ' order by t_dhxx.jzsj desc ';
          end
          else
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,lc from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where (' + cmdstrks  +')' +
                 ' and t_dhxx.jzbz=''0''' +
//                 ' and t_dhxx.ghhm='+quotedstr(callno)+
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and t_dhxx.yhid=''' + zdyhid + ''''+
                 ' and t_dhxx.jzsj is not null ' +
                 ' order by t_dhxx.jzsj desc ';
          end;
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////.
          with qr do
          begin
             if not qr.Eof  then
              begin
                  //在T_DHXX表中查找到要呼叫的客户信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  GHHM:=fields.fields[3].asstring;
                  YXJID:=Fields.Fields[4].asString;
                  yxjmc:=fields.fields[5].asstring;
                  lc := fields.fields[7].asstring;
                  if lc='' then
                    lc:='0';
                  ksid :=fields.Fields[6].AsString;
                  for i:=1 to hjksnum do
                  begin
                      if hjks[i].TGroupid= ksid then
                         break;
                  end;
                 // DDRs:=RecordCount;

                 ////找到窗口CallNO的呼叫终端的呼叫队列，并将当前客户转换到此队列中。
                 {}
                 tmpquery:=tadoquery.Create(nil);
                 tmpquery.Connection:=adoconnection;
                 tmpquery.SQL.Clear;
                 cmdstr:=' select 1 from  ' +
                              ' t_lc  ' +
                              ' where hszh=' + inttostr(gblhszh) + ' and LCID=' + lc ;
                 tmpquery.SQL.Add(cmdstr);
                 tmpquery.Open;
                 if tmpquery.Eof then
                 begin
                    iscall:=false;
                 end
                 else
                 begin
                   iscall := True;
                 end;
                 tmpquery.Close;
                 if iscall then
                 begin
                     //查找此用户的呼叫科室
                   tmpquery.SQL.Clear;
                   cmdstr:= ' select top 1 ksid  from t_lcxx'+
                     ' where lcid='+lc+
                     ' and lcxh>(select lcxh from t_lcxx'+
                      ' where lcid='+lc+' and ksid='+quotedstr(ksid)+')'+
                     ' order by lcxh';
                   tmpquery.SQL.Add(cmdstr);
                   tmpquery.Open;
                   if tmpquery.Eof then
                      iscall:=false
                   else
                   begin
                     tmpksid:=tmpquery.fieldbyname('ksid').asstring;
                     tmpksmc:=tmpquery.fieldbyname('ksid').asstring;
                     if (tmpksid=ksid) then
                     begin
                        FZZH(jrid,tmpksid,0,'',1);
                        //xzys(jrid,tmpyhid);
                        if tqth(jrid,tmpksid,'1',2,500) then
                        begin
                           gbledit_ks_count:=1;
                           gbledit_ks[gbledit_ks_count-1].ksid:=tmpksid;
                           gbledit_ks[gbledit_ks_count-1].ksmc:=tmpksmc;
                        end;
                     end
                     else
                     begin
                       //FZZH(jrid,hjksid[1],0,'');
                       //xzys(jrid,tmpyhid);
                       if hks(jrid,'1',ksid,tmpksid) then
                       begin
                             //TQTH(jrid,ksid,0,0,1);
                             //if True then//如果是插前则插入到队列最前面。
                             //  TQTH(jrid,ksid,0,0,1);
                             SZYXJ(JRID,'99'); //设置优先级为换队列
                             gbledit_ks_count:=2;
                             gbledit_ks[0].ksid:=tmpksid;
                             gbledit_ks[0].ksmc:=tmpksmc;
                             gbledit_ks[1].ksid:=ksid;
                       end;
                     end;
                     //////////////////////////////////////////////////////////////////
                      if cmd='95' then
                         result:=zdid +cmd  +'016666'
                      else if (cmd='45') then
                         result:=zdid +cmd  +'插后操作成功!  '+getstrwithnotbadcode(brxm,8)+'人数'+inttostr(DDRS)
                      else
                        result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS);//+','+brdm+','+by4+','+hjks[i].TGroupid;
                         //result:=zdid +cmd  +'016666' + ',' +BRXM + ',' + inttostr(DDRS);
                      iscall:=true;
                   end;
                  end;
                  FreeAndNil(tmpquery);
              end;
              close;
          end;
         end;
         if iscall=false  then
            begin
             if (cmd='45') then
                result:=zdid +cmd  +'插后操作失败!  '+'没有呼叫号码!'
             else
              result:=zdid +cmd  +'007777'  ;
            end;


    except
      begin
        if (cmd='45') then
          result:=zdid +cmd  +'插后操作失败!  '+'操作时有错误!'
        else
        result := zdid + cmd + '068888';  ///有错误发生.
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
//这个函数有点问题，取医生的呼叫科室不正确（t_yh_ks)
function TdmDBAccess.AutoFillzbbr():boolean;
var
   zdid,zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
   hjrs:integer;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info ;
   qr:Tadoquery;
   zdzt,zdstate:string;
   wzbrs:integer;
   zdqr:Tadoquery;
   dt1:tdatetime;
   dttime:double;
begin
  //此处需要修改//应该根据医生的准备人数来安排人员，否则会出现终端号在前的医生分配病人较多的情况//
  //吴刚20170502
  ////////////////////////////////////////////////////////////////////////////////////////////////
    dt1 := now;
    addlog('errorlog.txt','自动准备开始');
  try
    //if (gblzbrs=0) or (gblNeedZBXYS=0) then
    //20131114修改
//    if (gblzbrs=0) then // or (gblNeedZBXYS=0) then
//    begin
//     result:=false ;
//     exit;
//    end;
    zdqr:=Tadoquery.Create(nil);
    zdqr.Connection:=adoconnection;
    //在T_hjzd表中查找已经登录并且没有暂停的呼叫终端
    zdqr.SQL.Text:='select zdid,fjh,zth,ztmc,h.yhid,yhmc,fjmc,hjrs,zt,state,'+
                    'yk.ksid,k.ksmc,y.prepare1,'+
                    ' (select COUNT(*) from t_DHXX(nolock) where JZBZ=1 and ZTBZ=5 and YHID=h.YHID and ksid=yk.KSID) as zbrs'+
                    ' from t_hjzd h(nolock),t_yh y(nolock),t_ks k(nolock),t_yh_ks yk(nolock)'+
                    ' where h.hszh=y.hszh and h.yhid=y.yhid'+
                    ' and y.hszh=k.hszh '+
                    ' and y.hszh=yk.hszh and y.yhid=yk.yhid and yk.seq=1'+
                    ' and yk.ksid=k.ksid'+
                    ' and (h.ksid1=''0'' or h.ksid1=yk.ksid)'+
                    ' and zt not in (''暂停'')'+
                    ' and h.hszh='+inttostr(gblhszh)+
                    ' order by zbrs,calltime';
    zdqr.Open;
    ///////////
    with zdqr do
    begin
       //gbledit_ks_count:=0;
       if not zdqr.Eof  then
         begin
           qr:=Tadoquery.Create(nil);
           qr.Connection:=adoconnection;
           while not zdqr.eof do
           begin
              application.ProcessMessages;
              zdid:=fields.fields[0].asstring ;
              zdyhid:=fields.fields[4].asstring ;
              zdyhmc:=fields.fields[5].asstring;
              fjh:=fields.Fields[1].AsString;
              fjmc:=fields.Fields[6].AsString;
              zth:=fields.Fields[2].AsString;
              ztmc:=fields.Fields[3].AsString;
              hjrs:=fields.Fields[7].AsInteger;
              zdzt:=fields.Fields[8].AsString;
              zdstate:=fields.Fields[9].AsString;
              hjksnum :=1;
              hjks[1].TGroupid:=fields.Fields[10].AsString;
              hjks[1].TGroupName:=fields.Fields[11].AsString;
              qr.SQL.Text:='select count(*) rs from t_dhxx(nolock)'+
                      ' where ksid='''+hjks[1].TGroupid+''''+
                      ' and (yhid='''' or yhid is null or yhid='+quotedstr(zdyhid)+')'+
                      ' and jzbz=1 and ztbz<>5'+
                      ' and hszh='+inttostr(gblhszh);
              qr.Open ;
              wzbrs:=qr.fieldbyname('rs').asinteger;
              qr.close;
               //补充相应窗口的准备人数
              if (gblNeedZBXYS=1) and ((gblBRDYS=1) or (GetDBValue('KS',hjks[1].TGroupid,'seldoctor')='1')) then
              begin
                qr.SQL.Text:='select count(*) rs from t_dhxx(nolock)'+
                        ' where ksid='''+hjks[1].TGroupid+''''+
                        ' and yhid='''+zdyhid+''''+
                        ' and jzbz=1 and ztbz=5'+
                        ' and hszh='+inttostr(gblhszh);
              end
              else
              begin
                qr.SQL.Text:='select count(*) rs from t_dhxx(nolock)'+
                        ' where ksid='''+hjks[1].TGroupid+''''+
                        ' and jzbz=1 and ztbz=5'+
                        ' and hszh='+inttostr(gblhszh);
              end ;
              qr.Open ;
//              if (qr.fieldbyname('rs').asinteger<gblzbrs) and (wzbrs>0) then
              if (qr.fieldbyname('rs').asinteger<
                dmDBAccess.DB_GetGroupPrepareCount(hjks[1].TGroupid))
                and (wzbrs>0) then
              begin
  //               qr.Close;
                 //补充相应员工的准备人数
                 writedispmsg(zdid,fjh,fjmc,zth,ztmc,hjks[1].TGroupid,hjks[1].TGroupName
                  ,'','',zdyhid,zdyhmc,'0','','',0,100+qr.fieldbyname('rs').asinteger,'','','');
                 gbledit_ks[gbledit_ks_count].ksid:=hjks[1].TGroupid;
                 gbledit_ks[gbledit_ks_count].ksmc:=hjks[1].TGroupName;
                 gbledit_ks_count:=gbledit_ks_count+1;
              end;
              qr.Close;
              zdqr.next;
           end;
           qr.Close;
           FreeAndNil(qr);
           result:=true;
         end
       else
         begin
           result:=true;
         end;
         close ;
    end;
    FreeAndNil(zdqr);
  except
    result:=false;
  end;
  dttime := (now-dt1)*24*60*60;
  addlog('errorlog.txt','自动准备完成'+' '+vartostr(dttime));
end;
function TdmDBAccess.YHQZCall(const zdid, cmd: string): string;
var
    zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string;
    qr:TADOQuery;
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
   if getzdzt(zdid)<>'求助' then
   begin
       try
            qr.Close;
            //在等待T_hjzd表中查找zdid.
            qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                                    ' t_hjzd left outer join t_yh on ' +
                                    ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                                    ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
            qr.Open;
            ///////////
            with qr do
            begin
               if not qr.Eof  then
                 begin
                  zdyhid:=fields.fields[4].asstring ;
                  zdyhmc:=fields.fields[5].asstring;
                  fjh:=fields.Fields[1].AsString;
                  fjmc:=fields.Fields[6].AsString;
                  zth:=fields.Fields[2].AsString;
                  ztmc:=fields.Fields[3].AsString;
                  if ( zdyhid <>'')  then
                     begin
                     close;
                     end
                  else
                     begin
                     if (cmd='39') then
                     result:=zdid+cmd + '还没有登录!    请登录工号'
                     else
                     result:=zdid+cmd + '028888';///没有登录.
                     close;
                     exit;
                     end;
                  end
               else
                 begin
                   if (cmd='39') then
                   result:=zdid+cmd + '无此呼叫器!    请管理员设置!'
                   else
                   result:=zdid + cmd + '038888';  ///没有此呼叫器
                   close ;
                   exit;
                 end;
            end;
      //        WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,'','','服务','',ZDYHID,ZDYHMC,'','',0,1);
            if (cmd='39') then
            result:=zdid+cmd + '求助接收成功! '
            else
            result:=zdid + cmd + '017777';  //已经发出求助信号
            adoquery.SQL.Clear;
            adoquery.sql.Text:=' update t_hjzd set zt=''求助'',state=''求助'' '+
                               ',calltime=getdate()'+
                               ' where hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid;
            adoquery.ExecSQL;

       except
             if (cmd='39') then
             result:=zdid+cmd + '求助接收失败! '
             else
             result:=zdid + cmd + '007788';  //发出暂停信号失败
       end;
   end
   else  //getzdid(zdid)=求助///
   begin
       try
            qr.Close;
            //在等待T_hjzd表中查找zdid.
            qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                                    ' t_hjzd left outer join t_yh on ' +
                                    ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                                    ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
            qr.Open;
            ///////////
            with qr do
            begin
               if not qr.Eof  then
                 begin
                  zdyhid:=fields.fields[4].asstring ;
                  zdyhmc:=fields.fields[5].asstring;
                  fjh:=fields.Fields[1].AsString;
                  fjmc:=fields.Fields[6].AsString;
                  zth:=fields.Fields[2].AsString;
                  ztmc:=fields.Fields[3].AsString;
                  if ( zdyhid <>'')  then
                     begin
                     close;
                     end
                  else
                     begin
                     if (cmd='39') then
                     result:=zdid+cmd + '还没有登录!    请登录工号'
                     else
                     result:=zdid+cmd + '028888';///没有登录.
                     close;
                     exit;
                     end;
                  end
               else
                 begin
                   if (cmd='39') then
                   result:=zdid+cmd + '无此呼叫器!    请管理员设置!'
                   else
                   result:=zdid + cmd + '038888';  ///没有此呼叫器
                   close ;
                   exit;
                 end;
            end;
      //        WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,'','','服务','',ZDYHID,ZDYHMC,'','',0,1);
            if (cmd='39') then
            result:=zdid+cmd + '取消求助成功! '
            else
            result:=zdid + cmd + '017777';  //已经发出取消求助信号
            adoquery.SQL.Clear;
            adoquery.sql.Text:=' update t_hjzd set zt='''' '+
                               ',calltime=getdate()'+
                               ' where hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid;
            adoquery.ExecSQL;

       except
             if (cmd='39') then
             result:=zdid+cmd + '取消求助失败! '
             else
             result:=zdid + cmd + '007788';  //发出暂停信号失败
       end;
   end;
  finally
    FreeAndNil(qr);
  end;
end;
function TdmDBAccess.YHToNextTurn(const ZDID,cmd:string;const Nksid:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   cmdstrks:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,DQksid:string;
   lcid,lcxh:string;
   DDRS:integer;
   iscall :boolean;
   tmpquery:tADOQUERY;
   tmpksid:string;
   tmpyhid:string;
   tmpksmc:string;
   tmpturnghhm:string;
   tmpturnksid:string;
   ps:integer;
   qr:TADOQuery;
   hjrs,yhjrs:Integer;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection :=ADOConnection;
  try
    ps:=FoundChar(',',Nksid);
    if ps>0 then
    begin
      tmpturnksid := Copy(Nksid,1,ps-1);
      tmpturnghhm := Copy(Nksid,ps+1,Length(Nksid)-ps);
    end
    else
      tmpturnksid := Nksid;
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc,hjrs from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////查看登录情况.
    with qr do
    begin
       if not qr.Eof  then
         begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          hjrs:=fields.Fields[7].asInteger;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
            if (cmd='35') or (cmd='63') then
               result:=zdid +cmd  +'还没有登录!    '+'请登录工号'
            else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
          end
       else
         begin
            if (cmd='35') or (cmd='63') then
               result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置!'
            else
             result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
         end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM (((t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH) ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH) ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH) ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
            if (cmd='35') or (cmd='63') then
               result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置! '
            else
               result:=zdid + cmd + '048888';  //没有找到呼叫的队列
             exit;
           end;
           close;
       end
       else
       begin
            if (cmd='35') or (cmd='63') then
               result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置!'
            else
             result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    ////查找T_DHXX表中此队列的病人.
    if hjksnum>0 then
    begin
       cmdstr:='';
       cmdstrks:='';
       for i:=1 to hjksnum do
       begin
          if length(cmdstrks)>0 then
             cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
          else
             cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
       end;
       if Length(cmdstrks)>0 then
          cmdstrks :='('+ cmdstrks+')';
        cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where (' + cmdstrks  +')' +
               ' and t_dhxx.jzbz=''1''' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh) ;
        qr.SQL.Text:=cmdstr;
        qr.Open;
        ddrs:=qr.RecordCount;
        qr.Close ;
       //找到最近呼叫的客户
       if Length(tmpturnghhm)>0 then
         cmdstr:=' select '+'top '+inttostr(hjrs)+' id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where (' + cmdstrks  +')' +
               ' and t_dhxx.jzbz=''0''' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               //' and t_dhxx.yhid=''' + zdyhid + ''''+
               ' and t_dhxx.ghhm='''+tmpturnghhm+''''+
               ' and t_dhxx.jzsj is not null ' +
               ' order by t_dhxx.jzsj desc'
       else
         cmdstr:=' select '+'top '+inttostr(hjrs)+' id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where (' + cmdstrks  +')' +
               ' and t_dhxx.jzbz=''0''' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.yhid=''' + zdyhid + ''''+
               ' and t_dhxx.jzsj is not null ' +
               ' order by t_dhxx.jzsj desc,replicate(''0'',10-len(ghhm))+ghhm desc';
        qr.SQL.Text:=cmdstr;
        qr.Open;
        ///////////.
        with qr do
        begin
            qr.Last;
            yhjrs :=0;
            while  (not qr.bof) and (yhjrs<hjrs) do //  then
            begin
                //在T_DHXX表中查找到要呼叫的客户信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                DQksid:=fields.fields[6].asstring;
                for i:=1 to hjksnum do
                begin
                    if hjks[i].TGroupid= fields.Fields[6].AsString then
                       break;
                end;
               // DDRs:=RecordCount;

               {}
               tmpquery:=tadoquery.Create(nil);
               tmpquery.Connection:=adoconnection;
               tmpquery.SQL.Clear;
{
               ////找到窗口CallNO的呼叫终端的呼叫队列，并将当前客户转换到此队列中。
               cmdstr:=' select zdid,fjh,zth,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and FJH=' + callno ;

}
{
       ////找到流程中设置的访科室的下一个呼叫队列，并将当前客户转换到此队列中。
               cmdstr:=' select lcid,lcxh from t_lcxx where ksid='''+DQksid+'''' ;
               tmpquery.SQL.Add(cmdstr);
               tmpquery.Open;
               if tmpquery.Eof then
               begin
                  iscall:=false;
               end
               else
               begin
                  //取得当前科室的流程号及流程序号
                  lcid:=tmpquery.fieldbyname('lcid').asstring;
                  lcxh:=tmpquery.fieldbyname('lcxh').asstring;
                   tmpquery.Close;
                   tmpquery.SQL.Clear;


                   //取得流程中下一科室代码号
                   Nksid:='';
                   cmdstr:=' select ksid from t_lcxx where lcid='+lcid+' and lcxh='+inttostr(strtoint(lcxh)+1) ;
                   tmpquery.SQL.Add(cmdstr);
                   tmpquery.Open;
                   if tmpquery.Eof then
                   begin
                      iscall:=false;
                   end
                   else
                   begin
                      //取得当前科室的流程号及流程序号
                      Nksid:=tmpquery.fieldbyname('ksid').asstring;
                   end;
                   tmpquery.Close;
               end;
}

{

               if length(tmpyhid)=0 then
                  iscall:=false
               else
               begin
                   //查找此用户的呼叫科室
                 tmpquery.SQL.Clear;
                 cmdstr:= ' SELECT t_YH.YHID, t_YH.YHMC,' +
                          ' t_YH.KSID1, table1.KSMC AS ksmc1 ' +
                          ' FROM (t_YH LEFT OUTER JOIN ' +
                          ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH) ' +
                          ' WHERE (t_YH.YHID = ''' + tmpYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;

                 tmpquery.SQL.Add(cmdstr);
                 tmpquery.Open;
                 if tmpquery.Eof then
                    iscall:=false
                 else
                 begin
                   tmpksid:=tmpquery.fieldbyname('ksid1').asstring;
                   tmpksmc:=tmpquery.fieldbyname('ksmc1').asstring;
}
                   //if (Nksid='') then
                   if (tmpturnksid='') then
                   begin
                      close;
                      Break;
                   end
                   else
                   begin
                     //FZZH(jrid,DQksid,0,'');
                     //xzys(jrid,Nksid);
                     //if hks(jrid,'1',DQksid,Nksid) then
                     if hks(jrid,'1',DQksid,tmpturnksid) then
                     begin
                           gbledit_ks_count:=2;
                           gbledit_ks[0].ksid:=tmpturnksid;
                           gbledit_ks[0].ksmc:=tmpturnksid;
                           gbledit_ks[1].ksid:=DQksid;
                     end;
                   end;
                   //////////////////////////////////////////////////////////////////
                    if cmd='85' then
                       result:=zdid +cmd  +'016666'
                    else if (cmd='35') or (cmd='63') then
                       result:=zdid +cmd  +'插后操作成功!  '+getstrwithnotbadcode(brxm,8)+'人数'+inttostr(DDRS)
                    else
                       result:=zdid +cmd  +'016666' + ',' +BRXM + ',' + inttostr(DDRS);
                    iscall:=true;
              yhjrs:=yhjrs+1;
              qr.Prior;
            end;
                //end;
            FreeAndNil(tmpquery);
            //end;
            close;
        end;
       end;
       if iscall=false  then
          begin
           if (cmd='35') or (cmd='63') then
              result:=zdid +cmd  +'插后操作失败!  '+'没有呼叫号码!'
           else
            result:=zdid +cmd  +'007777'  ;
          end;


  except
    begin
      if (cmd='35') or (cmd='63') then
        result:=zdid +cmd  +'插后操作失败!  '+'操作时有错误!'
      else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
function TdmDBAccess.YHPJ(const ZDID,cmd:string;pj:string): string;
var
  adoquery_pd:Tadoquery;
  adoquery_pj:Tadoquery;
  yhid:string;
  hszh:integer;
  yhmc:string;
  ckh:integer;
  ksid1:string;
  ksid2:string;
  ksid3:string;
  ksid:string;
  ghhm:string;
  brxm:string;
  jzsj:string;
  jzjssj:string;
begin
         adoquery_pd:=Tadoquery.Create(nil);
         adoquery_pd.Connection:=adoconnection;
         adoquery_pj:=Tadoquery.Create(nil);
         adoquery_pj.Connection:=adoconnection;
         result:=zdid+cmd+'010000';
         //保存评价信息.
         /////////////////////////
         adoquery_pd.SQL.Text:='select t_hjzd.hszh,t_hjzd.zdid,t_hjzd.fjh,t_yh.yhid,t_yh.yhmc,t_yh.ksid1,t_yh.ksid2,t_yh.ksid3 from t_hjzd,t_yh where t_hjzd.yhid=t_yh.yhid'+
                               ' and t_hjzd.hszh=t_yh.hszh'+
                               ' and t_hjzd.zdid='+ZDID+
                               ' and t_hjzd.hszh='+inttostr(gblhszh);
         try
         adoquery_pd.Open;
         if not adoquery_pd.Eof then
         begin
            yhid:=adoquery_pd.fieldbyname('yhid').AsString;
            hszh:=adoquery_pd.fieldbyname('hszh').AsInteger;
            yhmc:=adoquery_pd.fieldbyname('yhmc').AsString;
            ckh:=adoquery_pd.fieldbyname('fjh').AsInteger;
            ksid1:=adoquery_pd.fieldbyname('ksid1').AsString;
            ksid2:=adoquery_pd.fieldbyname('ksid2').AsString;
            ksid3:=adoquery_pd.fieldbyname('ksid3').AsString;
         end;
         adoquery_pd.Close;
         adoquery_pd.SQL.Text:='select top 1 ksid,ghhm,jzsj,jzjssj,brxm from t_dhxx'+
                               ' where yhid='''+yhid+''''+
                               ' and jzbz=0'+
                               ' and ghsj>=convert(varchar(10),getdate(),120)'+
                               ' order by jzsj desc';
         except
            result:=zdid+cmd+'010000';
         end;
         try
         adoquery_pd.Open;
         if not adoquery_pd.Eof then
         begin
            ksid:=adoquery_pd.fieldbyname('ksid').AsString;
            jzsj:=cdatetostr(adoquery_pd.fieldbyname('jzsj').AsDateTime)+' ' +ctimetostr(adoquery_pd.fieldbyname('jzsj').AsDateTime);
            jzjssj:=cdatetostr(adoquery_pd.fieldbyname('jzjssj').AsDateTime)+' ' +ctimetostr(adoquery_pd.fieldbyname('jzjssj').AsDateTime);
            ghhm:=adoquery_pd.fieldbyname('ghhm').AsString;
            brxm:=adoquery_pd.fieldbyname('brxm').AsString;
         end
         else
            ksid:=ksid1;
         adoquery_pd.Close;
         except
            ksid:=ksid1;
         end;
         if gblappconn then
         begin
           adoquery_pj.Connection := adoconnApp;
           adoquery_pj.SQL.Text:=' Insert into t_pjxx(zdid, ckh, yhid, ajsj, ajh, ywid,ghhm,brxm,jzsj,jzjssj,hszh) '+
                                 ' values('+zdid+','+inttostr(ckh)+
                                 ','+''''+ yhid+''''+','+''''+cdatetostr(now)+' '+ctimetostr(now)+''''+
                                 ','+pj+','+''''+ksid+''''+
                                 ','''+ghhm+''''+
                                 ','''+brxm+''''+
                                 ','''+jzsj+''''+
                                 ','''+jzjssj+''''+
                                 ','+inttostr(hszh)+
                                 ')';
           try
             adoquery_pj.ExecSQL;
           except
             result:=zdid+cmd+'000000';
           end;
           FreeAndNil(adoquery_pj);
         end
         else
         begin
           adoquery_pj.Connection := ADOConnection;
           adoquery_pj.SQL.Text:=' Insert into t_pjxx(zdid, ckh, yhid, ajsj, ajh, ywid,ghhm,brxm,jzsj,jzjssj,hszh) '+
                                 ' values('+zdid+','+inttostr(ckh)+
                                 ','+''''+ yhid+''''+','+''''+cdatetostr(now)+' '+ctimetostr(now)+''''+
                                 ','+pj+','+''''+ksid+''''+
                                 ','''+ghhm+''''+
                                 ','''+brxm+''''+
                                 ','''+jzsj+''''+
                                 ','''+jzjssj+''''+
                                 ','+inttostr(hszh)+
                                 ')';
           try
             adoquery_pj.ExecSQL;
           except
             result:=zdid+cmd+'000000';
           end;
           FreeAndNil(adoquery_pj);
         end;
         FreeAndNil(adoquery_pd);
end;
{*******************************************************************************
*函数名:YHDontCall;
                                           *
*函数机能:忽略刚呼叫的病人.                                          *
*******************************************************************************}
function TdmDBAccess.YHDontCall(const ZDID: string; const cmd:string;const Abrdm:string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array[1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc:string;
   DDRS:integer;
   iscall :boolean;
   ydws:integer;   //忽略移动的位数
   hlcs,yhlcs:integer;  //已忽略次数
   ztbz:string;
   qr:tadoquery;
   ghsj:string;
   qry:tadoquery;
   tmpbrdm:string;
   tmpkssxid:integer;
begin
  tmpbrdm:= Abrdm;
  qry := TADOQuery.Create(nil);
  try
    qry.Connection := ADOConnection;
    try
      result:='';
      iscall:=false;
      qry.Close;
      //在等待T_hjzd表中查找zdid.
      qry.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                              ' t_hjzd left outer join t_yh on ' +
                              ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                              ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
      qry.Open;
      ///////////将中.
      with qry do
      begin
         if not qry.Eof  then
           begin
            zdyhid:=fields.fields[4].asstring ;
            zdyhmc:=fields.fields[5].asstring;
            fjh:=fields.Fields[1].AsString;
            fjmc:=fields.Fields[6].AsString;
            zth:=fields.Fields[2].AsString;
            ztmc:=fields.Fields[3].AsString;
            if ( zdyhid <>'')  then
               begin
               close;
               end
            else
               begin
               //result:=zdid+cmd + '028888';///没有登录.
               if (cmd='34') then
               result:=zdid+cmd + '还没有登录!    请登录工号     '///没有登录.
               else
               result:=zdid+cmd + '028888';///没有登录.
               close;
               exit;
               end;
            end
         else
           begin
             //result:=zdid + cmd + '038888';  ///没有此呼叫器
             if (cmd='34') then
               result:=zdid+cmd + '无此呼叫器!    请管理员设置!'///没有登录.
             else
             result:=zdid + cmd + '038888';  ///没有此呼叫器
             close ;
             exit;
           end;
      end;
      //在等待T_YH表中查找YHID信息.
      qry.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
                ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
                ' FROM t_YH LEFT OUTER JOIN ' +
                ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
                ' LEFT OUTER JOIN  ' +
                ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
                ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
      qry.Open;
      ///////////将中.
      with qry do
      begin
         if not qry.Eof  then
         begin
//            hjksnum:=1;
//            for intFieldsIndex:=2 to 7 do
//            begin
//                if intFieldsIndex mod 2 =0 then Continue ;
//                if fields.fields[intFieldsIndex].asstring<>''  then
//                   begin
//                     hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                     hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                     hjksnum:=hjksnum+1;
//                   end;
//            end;
            GetYHCallKS(zdyhid,hjksnum,hjks);
            if hjksnum=0 then
             begin
               //result:=zdid + cmd + '048888';  //没有找到呼叫的科室
               if (cmd='34') then
                  result:=zdid+cmd + '未设置呼叫队列!请管理员设置!'
               else
                  result:=zdid+ cmd + '048888';  //没有找到呼叫的科室
               exit;
             end;
             close;
         end
         else
         begin
             //result:=zdid + cmd + '008888';  //没有此用户号
             if (cmd='34') then
               result:=zdid+cmd + '未设置此工号!  请管理员设置!'
             else
               result:=zdid + cmd + '008888';  //没有此用户号
             Close;
             exit;
         end;
      end;
      ////查找T_DHXX表中此科室的病人.
      if hjksnum>0 then
      begin
         cmdstr:='';
         for i:=1 to hjksnum do
         begin
            if length(cmdstr)>0 then
               cmdstr:=cmdstr + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
            else
               cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
         end;
         if length(cmdstr)>0 then cmdstr :='('+cmdstr+')';
         qry.Close;
         if tmpbrdm='' then
         begin
           cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,yhlcs,ztbz from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where ' + cmdstr +
                 ' and t_dhxx.jzbz=''0''' +
                 ' and t_dhxx.ztbz<>7'+
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and t_dhxx.yhid=''' + zdyhid + ''''+
                 ' and t_dhxx.jzsj is not null ' +
                 ' order by t_dhxx.jzsj desc ';
         end
         else
         begin
           cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,yhlcs,ztbz from  ' +
                 ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                 ' where ' + cmdstr +
                 ' and t_dhxx.ztbz<>7'+
                 ' and t_dhxx.jzbz=''0''' +
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and t_dhxx.brdm='+quotedstr(tmpbrdm) +
                 //' and t_dhxx.yhid=''' + zdyhid + ''''+
                 ' and t_dhxx.jzsj is not null ' +
                 ' order by t_dhxx.jzsj desc ';
         end;
          qry.SQL.Text:=cmdstr;
          qry.Open;
          ///////////将中.
          with qry do
          begin
             if not qry.Eof  then
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  GHHM:=fields.fields[3].asstring;
                  YXJID:=Fields.Fields[4].asString;
                  yxjmc:=fields.fields[5].asstring;
                  yhlcs:=fields.fields[7].AsInteger;
                  ztbz :=fields.fields[8].AsString;
                  qr := TADOQuery.Create(nil);
                  try
                    qr.Connection := ADOConnection;
                    for i:=1 to hjksnum do
                    begin
                        if hjks[i].TGroupid= fields.Fields[6].AsString then
                        begin
                                  //查询忽略次数
                                  if  gblhlfs=1 then
                                  begin
                                        qr.Close;
                                        cmdstr:='select hlcs from t_ks_hlydws where ksid= '
                                          + hjks[i].TGroupid + ' and hszh= ' + inttostr(gblhszh);
                                        qr.SQL.Text:=cmdstr;
                                        qr.Open;
                                        if qr.Eof then
                                              hlcs:=gblhlcs
                                        else
                                        hlcs:=qr.Fields.Fields[0].AsInteger;
                                        qr.Close;
                                  end
                                  else
                                  begin
                                        hlcs:=gblhlcs;
                                  end;

                                  //确定移动位数
                                  if  gblhlydfs=1 then
                                  begin
                                     qr.Close;
                                     cmdstr:='select ydws from t_ks_hlydws where ksid= '
                                      + hjks[i].TGroupid + ' and hszh= ' + inttostr(gblhszh);
                                     qr.SQL.Text:=cmdstr;
                                     qr.Open;
                                     if qr.Eof then
                                        ydws:=gblhlydws   //如果科室移动位数未设置，则按照统一的位数来移动
                                     else
                                        ydws:=qr.Fields.Fields[0].AsInteger;
                                     qr.Close;
                                 end
                                 else
                                    ydws:=gblhlydws;
                           break;
                        end;
                    end;
                  finally
                    FreeAndNil(qr);
                  end;
                  if (ztbz='7') then
                  begin
                    //已经完成的。不做操作
                  end
                  else if (yhlcs>=hlcs) then
                  begin
                  ////已经忽略的次数大于等于可忽略的次数,直接呼叫下一位，对本次呼叫的病人不作操作
                          //修改T_dhxx中的数据，将本条数据改为已就诊，已完成
                          cmdstr:=' UPDATE t_dhxx SET yhid='''''+
                                  ' ,jzsj=getdate(),ztbz=3' +
                                  ' where id=' + jrid ;
                          adoconnection.Execute(cmdstr ,cmdText);
                  end
                  else
                  begin

                          //DDRs:=RecordCount;
          {                result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS);
                          //并将数据放入显示信息表中
                          //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                          WriteDispMsgTT(zdid,fjh,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,DDRS,1);
          }
                          //修改T_dhxx中的数据，将其它的信息顺序修改
                          cmdstr:=' Select 1  from t_dhxx (nolock)' +
                                  ' where ksid=''' +hjks[i].TGroupid + '''' +
                                  ' and jzbz=1'+
                                  ' and hszh=' + inttostr(gblHszh);
                          DDRs:=adoconnection.execute(cmdstr,cmdtext).RecordCount;
                          if gblfzays=1 then  //召回按医生排
                          begin
                            //查询选择些医生的病人当前的排位置
                            cmdstr:='select isnull(max(kssxid),0) as maxkssxid from ('+
                                    ' Select top '+inttostr(ydws)+' kssxid from t_dhxx (nolock)' +
                                    ' where ksid=''' +hjks[i].TGroupid + '''' +
                                    ' and jzbz=1'+
                                    ' and yhid='+quotedstr(zdyhid)+
                                    ' and hszh=' + inttostr(gblHszh)+
                                    ' order by kssxid'+
                                    ') as a ';
                            tmpkssxid:=adoconnection.execute(cmdstr,cmdtext).Fields[0].Value;
                            if tmpkssxid<>0 then
                            begin
                              ydws := tmpkssxid+1;
                              kssxid:= inttostr(ydws);
                            end
                            else
                            begin
                              if ddrs>=ydws+1 then
                              begin
                                 kssxid:=inttostr(ydws+1)
                              end
                              else
                              begin
                                 kssxid:=inttostr(ddrs+1);
                              end;
                            end;
                          end
                          else
                          begin
                            if ddrs>=ydws+1 then
                            begin
                               kssxid:=inttostr(ydws+1)
                            end
                            else
                            begin
                               kssxid:=inttostr(ddrs+1);
                            end;
                          end;
                          qr := TADOQuery.Create(nil);
                          qr.Connection := ADOConnection;
                          cmdstr:='select ghsj from t_dhxx'+
                                  ' where kssxid>='+kssxid+
                                  ' and jzbz=''1'''+
                                  ' and ksid='''+hjks[i].TGroupid+''''+
                                  ' and hszh='+ inttostr(gblHSZH)+
                                  ' order by ghsj';
                          qr.SQL.Text :=cmdstr;
                          ghsj:='';
                          try
                            qr.Open;
                            if not qr.Eof then
                              ghsj :=CDateToStr(qr.fieldbyname('ghsj').AsDateTime)+' '
                                  +ctimetostr(qr.fieldbyname('ghsj').AsDateTime)
                            else
                            begin
                              qr.Close;
                              cmdstr:='select ghsj from t_dhxx'+
                                      ' where ksid='''+hjks[i].TGroupid+''''+
                                      ' and jzbz=''1'''+
                                      ' and hszh='+ inttostr(gblHSZH)+
                                      ' order by ghsj desc';
                              qr.SQL.Text :=cmdstr;
                              qr.Open;
                              if not qr.Eof then
                              begin
                                ghsj:=CDateToStr(qr.fieldbyname('ghsj').AsDateTime)+' '
                                  +ctimetostr(qr.fieldbyname('ghsj').AsDateTime+1/60/60/24);
                              end;
                            end;
                          except

                          end;
                          qr.Close;
                          FreeAndNil(qr);
                          cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid+1' +
                                  ' where kssxid >=' + kssxid +
                                  ' and ksid=''' +hjks[i].TGroupid + '''' +
                                  ' and hszh=' + inttostr(gblHszh);
                          adoconnection.Execute(cmdstr ,cmdText);
                          //修改T_dhxx中的数据，将本条数据改为未就诊
                          if gblchongxinfenzhen=1 then
                          cmdstr:=' UPDATE t_dhxx SET JZBZ=''1''' +
                                  ' ,ztbz=''2'''+
                                  ' ,yxjid=1'+
                                  ' ,jzsj=null' +
                                  ' ,kssxid=' + kssxid +
                                  ' ,yhlcs= ' + inttostr(yhlcs+1) +
                                  ' where id=' + jrid
                          else if ghsj='' then
                          begin
                            if gbldontcallkeepyhid=1 then
                            begin
                              cmdstr:=' UPDATE t_dhxx SET JZBZ=''1''' +
                                      ' ,ztbz=''2'''+
                                      ' ,yxjid=1'+
                                      ' ,jzsj=null' +
                                      ' ,kssxid=' + kssxid +
                                      ' ,yhlcs= ' + inttostr(yhlcs+1) +
                                      ' where id=' + jrid;
                            end
                            else
                            begin
                              cmdstr:=' UPDATE t_dhxx SET JZBZ=''1''' +
                                      ' ,ztbz=''2'''+
                                      ' ,yxjid=1'+
                                      ' ,yhid='''''+
                                      ' ,jzsj=null' +
                                      ' ,kssxid=' + kssxid +
                                      ' ,yhlcs= ' + inttostr(yhlcs+1) +
                                      ' where id=' + jrid;
                            end;
                          end
                          else
                          begin
                            if gbldontcallkeepyhid=1 then
                            begin
                              cmdstr:=' UPDATE t_dhxx SET JZBZ=''1''' +
                                  ' ,ztbz=''2'''+
                                  ' ,yxjid=1'+
                                  ' ,jzsj=null' +
                                  ' ,kssxid=' + kssxid +
                                  ' ,ghsj=convert(datetime,'+''''+ghsj+''''+',102)'+
                                  ' ,yhlcs= ' + inttostr(yhlcs+1) +
                                  ' where id=' + jrid
                            end
                            else
                            begin
                              cmdstr:=' UPDATE t_dhxx SET JZBZ=''1''' +
                                  ' ,ztbz=''2'''+
                                  ' ,yxjid=1'+
                                  ' ,yhid='''''+
                                  ' ,jzsj=null' +
                                  ' ,kssxid=' + kssxid +
                                  ' ,ghsj=convert(datetime,'+''''+ghsj+''''+',102)'+
                                  ' ,yhlcs= ' + inttostr(yhlcs+1) +
                                  ' where id=' + jrid

                            end;
                          end;
                          adoconnection.Execute(cmdstr ,cmdText);
                          gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid;
                          gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;
                          gbledit_ks_count:=gbledit_ks_count+1;
                  end;
                  result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS);
                  {
                  if cmd='84' then
                     result:=YHCallNext(zdid,'82')      //硬件呼叫
                  else if cmd='34' then
                     result:=YHCallNext(zdid,'32')     //硬件呼叫2
                  else
                     result:=YHCallNext(zdid,'D5');     //软件呼叫}
                  iscall:=true;
              end;
              close;
          end;
      end;
         if iscall=false  then
            begin
              //result:=zdid +cmd  +'000000'  ;
             if (cmd='34')  then
               result:=zdid+cmd + '忽略失败                   !'
             else
             result:=zdid + cmd + '000000';
            end;
    except
      begin
        //result := zdid + cmd + '068888';  ///有错误发生.
         if (cmd='34')  then
            result:=zdid+cmd + '忽略失败                   !'
         else
            result:=zdid + cmd + '068888';
        Exit;
      end;
    end;
  finally
    FreeAndNil(qry);
  end;
end;
{*******************************************************************************
*函数名:NurseLeave;
                                           *
*函数机能:护士离开(1-离开,2-回岗.                                          *
*******************************************************************************}
function TdmDBAccess.NurseLeave(const AFlag:integer): string;
var
   qr:tadoquery;
   tmpid:string;
   retDB_Wakeupbyid:integer;
begin
  try
    Result:='-1';
    qr:=TADOQuery.Create(nil);
    qr.Connection :=ADOConnection;
    if AFlag=1 then//离开
    begin
       //修改  20190318 逐条激活未激活病人//
       //1.找到未激活病人
       //2.循环激活每个病人
//       qr.SQL.Text :=' update t_dhxx set jzbz=1,ztbz=1 '+
//                     ' where jzbz=2 and ztbz=6'+
//                     ' and hszh='+inttostr(gblHSZH)
      qr.SQL.Text :=' select * from t_dhxx where jzbz=2 and ztbz=6 and hszh='+inttostr(gblHSZH)+
         ' order by id ';
      qr.Open;
      while not qr.Eof do
      begin
        //逐个激活//
        tmpid := qr.fieldbyname('id').AsString;
         retDB_Wakeupbyid :=DB_Wakeupbyid(tmpid,gblHSZH,False);
         if  retDB_Wakeupbyid<>-1 then
         begin
           //需要将此病人安排在准备号之后，大号码之前，小号码之后。
           //add by wugang @2012-11-08
           if (gblYYSJDJH=1)  //--预约时间段到后才能呼叫
            and (qr.FieldByName('by1').AsString='88') //是预约病人
            //and (tmpquery.FieldByName('by7').AsString>FormatDateTime('hh:nn',now))
            and (retDB_Wakeupbyid=2) then  //预约时间段未到
           begin

           end
           else
           begin
             PutWakeupIDAtPos(tmpid,gblHSZH);
           end;
         end;
        qr.Next;
      end;
      qr.Close;
    end
    else if AFlag=2 then //回岗
    begin
       qr.SQL.Text :=' update t_dhxx set jzbz=2 '+
                     ' where jzbz=1 and ztbz=6'+
                     ' and hszh='+inttostr(gblHSZH);
      try
        qr.ExecSQL;
        Result :='0';
      except
        Result:='-1';
      end;
    end;

    FreeAndNil(qr);
  except
    begin
      result :='-1';
      FreeAndNil(qr);
      Exit;
    end;
  end;
end;
function TdmDBAccess.GetScreenSoundStr(const Aksid: string;fjh:string;fjmc:string;
             zth:string;ztmc:string;ksmc:string;
             ghhm:string;brxm:string;yhmc:string;yxjmc:string;
             by6:string;acallnos:string;acallnames:string;by4:string;
             zbharray:array of string;zbxmarray:array of string;
             zbby4:string;zbxx:string): string;
var
  qr:TADOQuery;
  nr,xxnr,tmpstr,strSound,memo:string;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr.SQL.Text :=' select ksid,s.bfnr,s.xxnr,s.memo from t_ks k,t_synrsz s'+
//      ' where k.yyms=s.yyms'+
      ' where s.yyms=99'+
      ' and k.hszh='+inttostr(gblHSZH)+' and k.ksid='+quotedstr(Aksid)+
      ' order by bfsx ';
    qr.open;
    if qr.Eof then
      Result :=''
    else
    begin
      strSound:='';
      while not qr.Eof do
      begin
        tmpstr:='';
         nr:=qr.fieldbyname('bfnr').AsString;
         xxnr:=qr.fieldbyname('xxnr').AsString;
         memo := qr.fieldbyname('memo').AsString;
         if nr=ttl_ghhm then
         begin
            tmpstr:=ghhm;
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr =ttl_br+'姓名' then
            tmpstr:=brxm
         else if nr =ttl_zs+'号码' then
         begin
            tmpstr:=fjh;
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr = ttl_zs+'名称' then
            tmpstr:=fjmc
         else if nr =ttl_zt+'号码' then
         begin
            tmpstr:=zth;
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr =ttl_zt+'名称' then
            tmpstr:=ztmc
         else if nr=ttl_ks+'名称' then
            tmpstr:=ksmc
         else if nr =ttl_yh+'姓名' then
            tmpstr:=yhmc
         else if nr = '优先名称' then
            tmpstr:=yxjmc
         else if nr ='任意字符' then
            tmpstr:=xxnr
         else if nr = '准备信息' then
            tmpstr:=zbxx
         else if nr ='准备号码1' then
         begin
            tmpstr:=zbharray[0];
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr ='准备号码2' then
         begin
            tmpstr:=zbharray[1];
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr ='准备号码3' then
         begin
            tmpstr:=zbharray[2];
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr ='准备号码4' then
         begin
            tmpstr:=zbharray[3];
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr ='准备号码5' then
         begin
            tmpstr:=zbharray[4];
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr ='准备号码6' then
         begin
            tmpstr:=zbharray[5];
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr ='准备号码7' then
         begin
            tmpstr:=zbharray[6];
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr ='准备号码8' then
         begin
            tmpstr:=zbharray[7];
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr ='准备号码9' then
         begin
            tmpstr:=zbharray[8];
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr ='准备号码10' then
         begin
            tmpstr:=zbharray[9];
            tmpstr:=getReadStr(tmpstr,memo);
         end
         else if nr ='准备姓名1' then
            tmpstr:=zbxmarray[0]
         else if nr ='准备姓名2' then
            tmpstr:=zbxmarray[1]
         else if nr ='准备姓名3' then
            tmpstr:=zbxmarray[2]
         else if nr ='准备姓名4' then
            tmpstr:=zbxmarray[3]
         else if nr ='准备姓名5' then
            tmpstr:=zbxmarray[4]
         else if nr ='准备姓名5' then
            tmpstr:=zbxmarray[5]
         else if nr ='准备姓名7' then
            tmpstr:=zbxmarray[6]
         else if nr ='准备姓名8' then
            tmpstr:=zbxmarray[7]
         else if nr ='准备姓名9' then
            tmpstr:=zbxmarray[8]
         else if nr ='准备姓名10' then
            tmpstr:=zbxmarray[9]
         else if nr ='准备标识1' then
            tmpstr:=getpartstr(zbby4,'1')
         else if nr ='准备标识2' then
            tmpstr:=getpartstr(zbby4,'2')
         else if nr ='准备标识3' then
            tmpstr:=getpartstr(zbby4,'3')
         else if nr ='准备标识4' then
            tmpstr:=getpartstr(zbby4,'4')
         else if nr ='准备标识5' then
            tmpstr:=getpartstr(zbby4,'5')
         else if nr ='准备标识6' then
            tmpstr:=getpartstr(zbby4,'6')
         else if nr ='准备标识7' then
            tmpstr:=getpartstr(zbby4,'7')
         else if nr ='准备标识8' then
            tmpstr:=getpartstr(zbby4,'8')
         else if nr ='准备标识9' then
            tmpstr:=getpartstr(zbby4,'9')
         else if nr ='准备标识10' then
            tmpstr:=getpartstr(zbby4,'10')
         else if nr = '备用6' then
            tmpstr:=by6
         else if nr = '标识' then
            tmpstr:=getpartstr(by4,'1')
         else
         begin
            tmpstr:=xxnr;
         end;
         tmpstr :=ReplaceNoTTS(tmpstr);
         strSound := strSound+tmpstr;
         qr.Next;
      end;
      Result :=StrSound;
    end;
    qr.Close;
  finally
    qr.Free;
  end;
end;
function TdmDBAccess.ReplaceNoTTS(const SourceStr:string):string;
var
  tmpstr:string;
  txtFile:textFile;
  s:string;
  filename:string;
  strs,strr:string;
begin
     tmpstr:= SourceStr;
     filename:=ExtractFilePath(paramstr(0))+'\ttsdll\replacetts.txt';
     if (filename<>'') and FileExists(filename) then
     begin
        AssignFile(txtfile,filename);
        Reset(txtfile);
        while not eof(txtfile) do
        begin
            readln(txtfile,s);
            strs:=trim(copy(s,1,2));
            strr:=trim(copy(s,5,2));
            tmpstr:=AnsiReplaceStr(tmpstr,strs,strr);
        end;
        closeFile(txtfile);
{      tmpstr:=AnsiReplaceStr(tmpstr,'B','必');
      tmpstr:=AnsiReplaceStr(tmpstr,'','西');
      tmpstr:=AnsiReplaceStr(tmpstr,'B','军');}
      end;
      result:=tmpstr;
end;
function TdmDBAccess.YHAutoCallNext(const ksid: string;
  const ACount: integer): Boolean;
var
  qr:TADOQuery;
  idx:integer;
  zdid,cmd:string;
  strRet:string;
  drv2:Boolean;
begin
  Result := False;
  if gblYJHJ<>1 then exit;
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    //查询硬件呼叫终端登录状态
//    qr.SQL.Text :='select zdid from t_hjzd where hszh='+inttostr(gblHSZH)+
//      ' and state in (''空闲'',''登录'',''继续'',''忽略'') '+
//      ' and (ip='''' or ip is null) and yhid<>'''''+
//      ' and yhid in (select yhid from t_yh where (ksid1='+quotedstr(ksid)+
//      ' or ksid2='+quotedstr(ksid)+' or ksid3='+quotedstr(ksid)+') '+
//      ' and hszh='+inttostr(gblHSZH)+')'+
//      ' order by calltime';
    qr.SQL.Text :='select zdid from t_hjzd where hszh='+inttostr(gblHSZH)+
      ' and state in (''空闲'',''登录'',''继续'',''忽略'') '+
      ' and (ip='''' or ip is null) and yhid<>'''''+
      ' and yhid in (select yhid from t_yh_ks where (ksid='+quotedstr(ksid)+') '+
      ' and hszh='+inttostr(gblHSZH)+')'+
      ' order by calltime';
    qr.Open;
    if not qr.Eof then
    begin
      idx := qr.fieldbyname('zdid').AsInteger;
      if idx>9 then
        zdid := IntToStr(idx)
      else
        zdid :='0'+IntToStr(idx);

      qr.Close;
      drv2:=false;
      if uppercase(gsprogram1)='YJQDVER2.EXE' then
        drv2:=true
      else if uppercase(gsprogram2)='YJQDVER2.EXE' then
        drv2:=true
      else if uppercase(gsprogram3)='YJQDVER2.EXE' then
        drv2:=true
      else if uppercase(gsprogram4)='YJQDVER2.EXE' then
        drv2:=true;
      //顺呼
      if drv2 then
        cmd :='32'
      else
        cmd :='82';  //(requst='82') or (requst='32') or (requst='67')
      //zdid在此处有问题.应该与两个硬件驱动有关系。
      strRet:=dmdbaccess.YHCallNextKeySet(zdid,cmd,'');

      if Copy(strRet,5,2)='01' then
      begin
        Result :=True;
        frmMain.clientsocket1.Socket.SendText(strRet);
        Sleep(100);
        if gblhardwaretype=2 then
        begin
          if cmd='82' then
          begin
            strRet:=dmdbaccess.YHGetWaitNum(zdid,'88');
            frmMain.clientsocket1.Socket.SendText(strRet);
          end;
        end;
      end;
      if gbledit_ks_count>0 then
         frmMain.SXKSXX();
    end
    else
    begin
      qr.Close;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.ChangeFirstGrpState(const AYHID: String;
  const AState: Integer): Integer;
var
  qr :TADOQuery;
  intRet:integer;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    if AState=0 then
    begin
      if gblCallWithGrpStateAtPause=0 then
//        qr.SQL.Text :=' update t_ks set ztbz=0 where ksid=('+
//          ' select ksid1 from t_yh where yhid='+quotedstr(AYHID)+' and hszh='+inttostr(gblHSZH)+')'+
//          ' and ksid not in (select ksid1 from t_yh where yhid<>'+quotedstr(AYHID) +
//          ' and hszh='+inttostr(gblHSZH)+' and yhid in (select yhid from t_hjzd'+
//          ' where yhid<>'''' and yhid is not null and hszh='+inttostr(gblHSZH)+'))'
        qr.SQL.Text :=' update t_ks set ztbz=0 where ksid=('+
          ' select ksid from t_yh_ks where yhid='+quotedstr(AYHID)+
          ' and seq=1'+
          ' and hszh='+inttostr(gblHSZH)+')'+
          ' and ksid not in (select ksid from t_yh_ks where yhid<>'+quotedstr(AYHID) +
          ' and seq=1'+
          ' and hszh='+inttostr(gblHSZH)+' and yhid in (select yhid from t_hjzd'+
          ' where yhid<>'''' and yhid is not null and hszh='+inttostr(gblHSZH)+'))'
      else
//        qr.SQL.Text :=' update t_ks set ztbz=0 where ksid=('+
//          ' select ksid1 from t_yh where yhid='+quotedstr(AYHID)+' and hszh='+inttostr(gblHSZH)+')'+
//          ' and ksid not in (select ksid1 from t_yh where yhid<>'+quotedstr(AYHID) +
//          ' and hszh='+inttostr(gblHSZH)+' and yhid in (select yhid from t_hjzd'+
//          ' where ((yhid<>'''' and yhid is not null) and  zt<>''暂停'') '+
//          ' and hszh='+inttostr(gblHSZH)+' ))';
        qr.SQL.Text :=' update t_ks set ztbz=0 where ksid=('+
          ' select ksid from t_yh_ks where yhid='+quotedstr(AYHID)+
          ' and seq=1 '+
          ' and hszh='+inttostr(gblHSZH)+')'+
          ' and ksid not in (select ksid from t_yh_ks where yhid<>'+quotedstr(AYHID) +
          ' and seq=1 '+
          ' and hszh='+inttostr(gblHSZH)+' and yhid in (select yhid from t_hjzd'+
          ' where ((yhid<>'''' and yhid is not null) and  zt<>''暂停'') '+
          ' and hszh='+inttostr(gblHSZH)+' ))';
      try
        intRet := qr.ExecSQL;
        if intRet>0 then
          Result := 1
        else
          Result :=0;
      except
        Result :=0;
      end;
    end
    else
    begin
//      qr.SQL.Text :=' update t_ks set ztbz=1 where ksid=('+
//        ' select ksid1 from t_yh where yhid='+quotedstr(AYHID)+' and hszh='+inttostr(gblHSZH)+')';
      qr.SQL.Text :=' update t_ks set ztbz=1 where ksid=('+
        ' select ksid from t_yh_ks where yhid='+quotedstr(AYHID)+
        ' and seq=1'+
        ' and hszh='+inttostr(gblHSZH)+')';

      try
        intRet := qr.ExecSQL;
        if intRet>0 then
          Result := 1
        else
          Result :=0;
      except
        Result :=0;
      end;
    end;
  finally
    qr.Free;
  end;
end;

function TdmDBAccess.YHGetKeySet(const zdid, cmd, Callno: string): string;
var
  StrTemp:string;
  qr: TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
   qr.Connection := ADOConnection;
   try
      qr.Close;
      //在等待T_hjzd表中查找ip=Aip的zdid.
      qr.SQL.Text:=' select DISTINCT ajmc from t_qhajsz where hszh= '+inttostr(gblhszh)+
        ' and  ksid=(select ksid1 from t_yh where hszh= '+inttostr(gblhszh)+
        ' and yhid=(select yhid from t_hjzd '+
        ' where zdid='+zdid+' and hszh='+inttostr(gblhszh)+
        ' ))';
      qr.Open;
      ///////////返回数据
      with qr do
      begin
         if not qr.Eof  then
         begin
           while not qr.Eof do
           begin
            StrTemp:=fields.fields[0].AsString ;
            Result:=Result+StrTemp+',';
            qr.Next;
           end;
         end
         else
            Result:='';
      end;
      if Result ='' then
        Result := zdid+cmd+'00'
      else
        Result := zdid+cmd+'01'+ Result;
   except
     result:=zdid+cmd+'00'+ '';//出错返回未找到信息
   end;
  finally
    FreeAndNil(qr);
  end;
end;
//得到用户的预设呼叫科室
function TdmDBAccess.YHCallGroupSet(const zdid, cmd, Callno: string): string;
var
  StrTemp:string;
  qr: TADOQuery;
  zdyhid:string ;
  zdyhmc:string;
  fjh:String;
  fjmc:String;
  zth:String;
  ztmc:String;
begin
  qr := TADOQuery.Create(nil);
  try
   qr.Connection := ADOConnection;
   try
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Clear;
    qr.Parameters.Clear;
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=:p1' +' and zdid=:p2';
    qr.Parameters.ParamByName('p1').Value := gblHSZH;
    qr.Parameters.ParamByName('p2').Value := strtoint(zdid);
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
           begin
            result:=zdid+cmd + '028888';///没有登录.
            close;
            exit;
           end;
       end
       else
       begin
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
      qr.Close;
      qr.SQL.Clear;
      qr.Parameters.Clear;
      //在等待T_hjzd表中查找ip=Aip的zdid.
      qr.SQL.Text:=' select seq,yk.ksid,ksmc,zcgh,prepare,yk.callcount from t_yh_ks_sz yk' +
        ' left outer join t_ks k on yk.hszh=k.hszh and yk.ksid=k.ksid'+
        ' where yhid=:p1 and yk.hszh=:p2'+
        ' order by seq';
      qr.Parameters.ParamByName('p1').Value := zdyhid;
      qr.Parameters.ParamByName('p2').Value := gblHSZH;
      qr.Open;
      ///////////返回数据
      with qr do
      begin
         if not qr.Eof  then
         begin
           while not qr.Eof do
           begin
            StrTemp:=fields.fields[0].AsString +'^';   //顺序
            StrTemp:=StrTemp+fields.fields[1].AsString +'^';//科室代码
            StrTemp:=StrTemp+fields.fields[2].AsString +'^';//科室名称
            StrTemp:=StrTemp+fields.fields[3].AsString +'^';//支持挂号
            StrTemp:=StrTemp+fields.fields[4].AsString +'^';//准备
            StrTemp:=StrTemp+fields.fields[5].AsString ;//呼叫人数
            Result:=Result+StrTemp+';';
            qr.Next;
           end;
         end
         else
            Result:='';
      end;
      if Result ='' then
        Result := zdid+cmd+'00'
      else
        Result := zdid+cmd+'01'+ Result;
   except
     result:=zdid+cmd+'00'+ '';//出错返回未找到信息
   end;
  finally
    FreeAndNil(qr);
  end;
end;
function TdmDBAccess.YHCallNextKeySet(const zdid, cmd,
  Akeyset: string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
//   callcount:array[1..3] of Integer;
//   calledcount:array[1..3] of Integer;
//   ksCallState:array[1..3] of integer;//0-科室无人,1-呼叫人数到,2-呼叫成功
   clearCalledCount:Boolean;
   i,j:integer;
   hjksnum:integer;
   cmdstr:widestring;
   cmdstrks:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,ztbz,yhlcs:string;
   zdzt,zdstate:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   tmpghhm:string;
   hjfs:integer;
   tmpksid:string;
   tmpksmc:string;
   hjrs:integer;//呼叫人数
   yhjrs:integer;//
   by6:string;
   qr:Tadoquery;
   ksbrdys:string;
   nextdelay:Integer;
   strCallnos,strCallnames,strby4:string;
   qr1 : TADOQuery;
   strKeyStr:string;
   hjks:array [1..20] of CallGroup_Info;
   prepareinfo:string;
begin
  i:= FoundChar(',',Akeyset);
  if i>0 then
  begin
    j:=1;
    strKeyStr :=QuotedStr(getpartstr(AnsiReplaceStr(Akeyset,',','|'),IntToStr(j)));
    while i>0 do
    begin
      i:= FoundChar(',',Akeyset,i+1);
      if i>0 then
      begin
        j:=j+1;
        strKeyStr:= strKeyStr+','+QuotedStr(getpartstr(AnsiReplaceStr(Akeyset,',','|'),IntToStr(j)));
      end
      else
        Break;
    end;
  end
  else
    j:=0;
  if j>0 then
    strKeyStr :=' and by6 in ('+ strKeyStr+')'
  else
    strKeyStr :='';
  qr1 := TADOQuery.Create(nil);
  try
    qr1.Connection := ADOConnection;
  try
    //gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    qr1.Close;
    //在等待T_hjzd表中查找zdid.
    qr1.sql.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc,hjrs,zt,state'+
                            ',case when callnexttime is NULL then 999999 else '+
                            ' datediff(s,callnexttime,getdate()) end as nextdelay'+
                            ' from t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    try
      qr1.Open;
    except
      qr1.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc,hjrs,zt,state'+
                            ',999999 as nextdelay'+
                            ' from t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
      qr1.Open;
    end;
    ///////////将中.
    with qr1 do
    begin
       if not qr1.Eof  then
         begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          hjrs:=fields.Fields[7].AsInteger;
          zdzt:=fields.Fields[8].AsString;
          zdstate:=fields.Fields[9].AsString;
          nextdelay := fields.Fields[10].AsInteger;
           if ( zdyhid <>'')  then
           begin
             close;
             //2017-10-20 删除，吴刚,不判断顺呼间隔
//             if nextdelay>=gblSHJG then
//               close
//             else
//             begin
//               if (cmd='32') or (cmd='67') then
//                 result:=zdid+cmd + '顺呼太快  !    请稍候再试     '///没有登录.
//               else
//                 result:=zdid+cmd + '068888';///没有登录.
//               close;
//               exit;
//             end;
           end
           else
             begin
             if (cmd='32') or (cmd='67') then
             result:=zdid+cmd + '还没有登录!    请登录工号     '///没有登录.
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
          end
       else
         begin
           if (cmd='32') or (cmd='67') then
             result:=zdid+cmd + '无此呼叫器!    请管理员设置!'///没有登录.
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
         end;
    end;
    yhjrs:=0;
    //在等待T_YH表中查找YHID信息.
    if gblCallWithGrpState=0 then
    begin
      qr1.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')';
    end
    else
    begin
      qr1.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' and table2.ztbz=0'+
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' and table3.ztbz=0'+
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')';
    end;
    qr1.Open;
    //////////.
    with qr1 do
    begin
       if not qr1.Eof  then
       begin
          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   callcount[hjksnum]:=StrToInt(GetDBValue(D001,zdyhid,'CallCount'+inttostr(hjksnum)));
//                   calledcount[hjksnum]:=StrToInt(GetDBValue(D001,zdyhid,'CalledCounts'+inttostr(hjksnum)));
//                   ksCallState[hjksnum]:=-1;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
//          if hjksnum=1 then
//           begin
//           if (cmd='32') or (cmd='67') then
//             result:=zdid+cmd + '未设置呼叫队列!请管理员设置!'
//           else
//             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
//             exit;
//           end;
           close;

           //add by wugang @20111028
           GetYHCallKS(zdyhid,hjksnum,hjks);
           if hjksnum=0 then
           begin
             if (cmd='32') or (cmd='67') then
               result:=zdid+cmd + '未设置呼叫队列!请管理员设置!'
             else
               result:=zdid + cmd + '048888';  //没有找到呼叫的科室
               exit;
           end;
           if hjksnum>0 then hjksnum:=hjksnum+1;
           ///////add end/////////////
       end
       else
       begin
           if (cmd='32') or (cmd='67') then
             result:=zdid+cmd + '未设置此工号!  请管理员设置!'
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    //修改呼叫终端状态
    try
      adoconnection.Execute('update t_hjzd set state=''顺呼'''+
        ',calltime=getdate(),callnexttime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
    except
      adoconnection.Execute('update t_hjzd set state=''顺呼'''+
        ',calltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
    end;
    ////查找T_DHXX表中此科室的病人.
    if hjksnum>1 then
    begin
       qr:= TADOQuery.Create(nil);
       qr.Connection := ADOConnection;

       cmdstr:='';
       cmdstrks:='';
       i:=1;
       for i:=1 to hjksnum-1 do
       begin
//          if length(cmdstrks)>0 then
//             cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjksid[i] +''''
//          else
//             cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
          if length(cmdstrks)>0 then
             cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
          else
             cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
       end;
       //查询出上一个呼叫病人。//
       if Length(cmdstrks)>0 then
          cmdstrks :='('+ cmdstrks+')';
       cmdstr:=' select top 1 id,jzjssj,ztbz,yhlcs from' +
               ' t_dhxx ' +
               ' where (' + cmdstrks  +')' +
               ' and t_dhxx.jzbz=0' +
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.yhid=''' + zdyhid + ''''+
               ' and t_dhxx.jzsj is not null ' +
               ' order by t_dhxx.jzsj desc ';
        qr.SQL.Text := cmdstr;
        qr.Open ;
        jrid:='';
        if not qr.Eof  then
        begin
            //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
            jrid:=qr.fields.Fields[0].AsString;
            ztbz := qr.fields.Fields[2].AsString;
            yhlcs := qr.fields.Fields[3].AsString;
            if qr.fields.Fields[1].AsString='' then
            begin
              cmdstr:=' UPDATE t_dhxx '+
                      ' SET jzjssj=getdate()' +
                      ' where id=' + jrid ;
              adoconnection.Execute(cmdstr ,cmdText);
            end;
        end;
        qr.Close;
        cmdstr:='';
        //2017-05-02此处增加功能：判断前一个呼叫病人的完成状态和忽略状态
        //如果是完成状态或忽略次数已到设定次数，则可以顺呼一下位，否则不能顺呼.
        if length(jrid)>0 then
        begin
          if gblcheckprevpatient=1 then
          begin
             if (ztbz<>'7') and (strtoint(yhlcs)<gblhlcs) then  //没有完成，并且忽略次数没有到系统设置的忽略次
             begin
               //返回 不能呼叫//
               if (cmd='32') or (cmd='67') then
                 result:=zdid+cmd + '顺呼太快  !    请先完成病人   '///先完成病人
               else
                 result:=zdid+cmd + '068888';///先完成病人
               exit;
             end;
           end;
        end;
        //////////////////////////////////////////////////////////////////////
        hjfs:=DB_GetHJFS(gblhszh,zdyhid);
       if hjfs=1 then
       begin
         for i:= 1 to hjksnum-1 do
         begin
           //if (calledcount[i]>=callcount[i]) and (callcount[i]>0) then
           if (hjks[i].TCalledCount>=hjks[i].TCallCount)
              and (hjks[i].TCallCount>0) then
           begin
              //ksCallState[i]:=1;
              hjks[i].TGroupState :=1;
              Continue;
           end
           //else if (callcount[i]=0) or  (calledcount[i]<callcount[i]) then//不指定呼叫人数
           else if (hjks[i].TCallCount=0) or  (hjks[i].TCalledCount<hjks[i].TCallCount) then//不指定呼叫人数
           begin
             //查询此科室等候人数:
              if zdzt='暂停' then
              begin
                //ksbrdys := dmdbaccess.GetDBValue('KS',hjksid[i],'SelDoctor');
                ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
                if ksbrdys='' then ksbrdys:='0';
                if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                //if gblBRDYS=1 then
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           //' where t_dhxx.ksid=''' + hjksid[i] + '''' +
                           ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.ztbz=5'+
                           ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
                           strKeyStr +
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                else
                   begin
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           //' where t_dhxx.ksid=''' + hjksid[i] + '''' +
                           ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.ztbz=5'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
                           //' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           strKeyStr +
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                   end   ;
              end
              else
              begin
                ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
                if ksbrdys='' then ksbrdys:='0';
                if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                //if gblBRDYS=1 then
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+

//                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           strKeyStr +
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                else
                   begin
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
//                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           strKeyStr +
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                   end   ;
              end;
              qr.SQL.Text := cmdstr;
              qr.Open;
              with qr do
              begin
                  if qr.Eof then
                  begin
                    //ksCallState[i]:=0;
                    hjks[i].TGroupState :=0;
                  end
                  else
                  begin
                    //ksCallState[i]:=2;
                    hjks[i].TGroupState :=2;
                    while  not qr.Eof  do
                    begin
                        //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                        jrid:=fields.Fields[0].AsString;
                        kssxid:=fields.fields[1].asstring;
                        Brxm:=Fields.Fields[2].AsString;
                        GHHM:=fields.fields[3].asstring;
                        YXJID:=Fields.Fields[4].asString;
                        yxjmc:=fields.fields[5].asstring;
                        DDRs:=RecordCount-1;
                        brdm:=fields.fields[6].asstring;
                        by4:=fields.fields[7].asstring;
                        by6:=fields.fields[8].asstring;
                        if cmd='82' then
                        begin
                           tmpghhm:=ghhm;
                           if length(tmpghhm)=0  then
                              tmpghhm:='0000'
                           else if length(tmpghhm)=1  then
                              tmpghhm:='000'+tmpghhm
                           else if length(tmpghhm)=2  then
                              tmpghhm:='00'+tmpghhm
                           else if length(tmpghhm)=3  then
                              tmpghhm:='0'+tmpghhm
                           else
                              tmpghhm:=RightStr(tmpghhm,4);
                           result:=zdid +cmd  +'01' + tmpghhm  ;
                        end
                        else if (cmd='32') or (cmd='67') then
                        begin
        {                   tmpghhm:=ghhm;
                           if length(tmpghhm)=0  then
                              tmpghhm:='0000'
                           else if length(tmpghhm)=1  then
                              tmpghhm:='000'+tmpghhm
                           else if length(tmpghhm)=2  then
                              tmpghhm:='00'+tmpghhm
                           else if length(tmpghhm)=3  then
                              tmpghhm:='0'+tmpghhm
                           else
                              tmpghhm:=copy(tmpghhm,1,4);}
                           result:=zdid+cmd + getstrwithnotbadcode(hjks[i].TGroupName,8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                        end
                        else
                           result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid;
                        //并将数据放入显示信息表中
                        //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                        gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid;//hjksid[i];
                        gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;//hjksmc[i];
                        gbledit_ks_count:=gbledit_ks_count+1;
                        //修改其它病人的排队序号
//                        cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                                ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
//                                ' and ksid=''' +hjks[i].TGroupid + '''' +
//                                ' and hszh=' + inttostr(gblHszh);
//                        adoconnection.Execute(cmdstr ,cmdText);
//                        //将这个科室已呼叫过的病人的kssxid-1
//                        cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                                ' where jzbz=0'+
//                                ' and ksid=''' +hjks[i].TGroupid + '''' +
//                                ' and hszh=' + inttostr(gblHszh);
//                        adoconnection.Execute(cmdstr ,cmdText);
//                        //修改T_dhxx中的数据，将本条数据改为就诊
//                        cmdstr:=' UPDATE t_dhxx SET JZBZ=0' +
//                                ' ,yhid=''' + zdyhid + ''''+
//                                ' ,ckhm='+fjh+
//                                ' ,jzsj=getdate()' +
//                                ' ,kssxid=0' +
//                                ' where id=' + jrid ;
//                        adoconnection.Execute(cmdstr ,cmdText);
                        doUpdatewaitlistpos(hjks[i].TGroupid,jrid,zdyhid,fjh,gblhszh);
                        DB_SetHisPatientStatus(jrid);
                      //添加显示信息
                      ///delete by wugang @2010-03-16
                      //将多个号的信息合到一条显示信息记录中.
                      //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                      ///delete end ///
                      ///add by wugang @2010-03-16
                      //将多个号的信息合到一条显示信息记录中.
                      strCallnos := strCallnos+ghhm+'|';
                      strCallnames := strCallnames+brxm+'|';
                      strby4 := strby4+by4+'|';
                      ///add end ///
                      iscall:=true;
                      yhjrs:=yhjrs+1;
                      if yhjrs=hjrs then
                      begin
                         //add by wugang @2010-03-16
                         //在呼叫人数到时将信息保存到显示信息表中.
                         WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                         ///add end///
                         //得到准备病人信息，并返回到结果中.
                         if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                         begin
                           prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                           result := result +','+prepareinfo;
                         end;
                         break;
                      end
                      else
                      begin
                         qr.Next;
                         //add by wugang @2010-03-16
                         //在呼叫人数到时将信息保存到显示信息表中.
                         if qr.Eof then
                         begin
                            WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                             //得到准备病人信息，并返回到结果中.
                           if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                           begin
                               prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                               result := result +','+prepareinfo;
                           end;
                         end;
                         ///add end ///
                      end;

                    end;
                  end;
                  close;
              end;//end with
              if hjks[i].TGroupState=0 then//ksCallState[i]=0 then
                 Continue
              else
              begin
                 //修改此员工此呼叫科室的呼叫人数;
//                 cmdstr :=' update t_yh set CalledCounts'+inttostr(i)+'=CalledCounts'+inttostr(i)+'+1'+
//                          ' where yhid='''+ZDYHID+''''+
//                          ' and hszh='+inttostr(gblhszh);
//                 qr.SQL.Text := cmdstr;
//                 try
//                   qr.ExecSQL;
//                   //calledcount[i]:= calledcount[i]+1;
//                   hjks[i].TCalledCount:= hjks[i].TCalledCount+1;
//                 except
//
//                 end;
                 cmdstr := ' update t_yh_ks set CalledCount=CalledCount+'+inttostr(yhjrs)+
                          ' where yhid='''+ZDYHID+''''+
                          ' and ksid='+quotedstr(hjks[i].TGroupid)+
                          ' and hszh='+inttostr(gblhszh);
                 qr.SQL.Text := cmdstr;
                 try
                   qr.ExecSQL;
                   //calledcount[i]:= calledcount[i]+1;
                   hjks[i].TCalledCount := hjks[i].TCalledCount+yhjrs;
                 except
                 end;
                 Break;
              end;
           end;
         end;
         if  not iscall then
         begin
           for i:=1 to hjksnum-1 do
           begin
             if hjks[i].TGroupState=1 then//ksCallState[i]=1 then
             begin
              if zdzt='暂停' then
              begin
                ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
                if ksbrdys='' then ksbrdys:='0';
                if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                //if gblBRDYS=1 then
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.ztbz=5'+
                           ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
//                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           strKeyStr +
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                else
                   begin
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.ztbz=5'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
//                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           strKeyStr +
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                   end   ;
              end
              else
              begin
                ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
                if ksbrdys='' then ksbrdys:='0';
                if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                //if gblBRDYS=1 then
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
//                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           strKeyStr +
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                else
                   begin
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6 from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
//                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                           strKeyStr +
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,replicate(''0'',10-len(ghhm))+ghhm '
                   end   ;
              end;
              qr.SQL.Text := cmdstr;
              qr.Open;
              ///////////将中.
              with qr do
              begin
                hjks[i].TGroupState :=2;
                  while  not qr.Eof  do
                  begin
                      //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                      jrid:=fields.Fields[0].AsString;
                      kssxid:=fields.fields[1].asstring;
                      Brxm:=Fields.Fields[2].AsString;
                      GHHM:=fields.fields[3].asstring;
                      YXJID:=Fields.Fields[4].asString;
                      yxjmc:=fields.fields[5].asstring;
                      DDRs:=RecordCount-1;
                      brdm:=fields.fields[6].asstring;
                      by4:=fields.fields[7].asstring;
                      by6:=fields.fields[8].asstring;
                      if cmd='82' then
                      begin
                         tmpghhm:=ghhm;
                         if length(tmpghhm)=0  then
                            tmpghhm:='0000'
                         else if length(tmpghhm)=1  then
                            tmpghhm:='000'+tmpghhm
                         else if length(tmpghhm)=2  then
                            tmpghhm:='00'+tmpghhm
                         else if length(tmpghhm)=3  then
                            tmpghhm:='0'+tmpghhm
                         else
                            tmpghhm:=RightStr(tmpghhm,4);
                         result:=zdid +cmd  +'01' + tmpghhm  ;
                      end
                      else if (cmd='32') or (cmd='67') then
                      begin
      {                   tmpghhm:=ghhm;
                         if length(tmpghhm)=0  then
                            tmpghhm:='0000'
                         else if length(tmpghhm)=1  then
                            tmpghhm:='000'+tmpghhm
                         else if length(tmpghhm)=2  then
                            tmpghhm:='00'+tmpghhm
                         else if length(tmpghhm)=3  then
                            tmpghhm:='0'+tmpghhm
                         else
                            tmpghhm:=copy(tmpghhm,1,4);}
                         result:=zdid+cmd + getstrwithnotbadcode(hjks[i].TGroupName,8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                      end
                      else
                         result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid;
                      //并将数据放入显示信息表中
                      //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                      gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid; //hjksid[i];
                      gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;  //hjksmc[i];
                      gbledit_ks_count:=gbledit_ks_count+1;
                      //修改其它病人的排队序号
//                      cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                              ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
//                              ' and ksid=''' +hjks[i].TGroupid + '''' +
//                              ' and hszh=' + inttostr(gblHszh);
//                      adoconnection.Execute(cmdstr ,cmdText);
//                      //将这个科室已呼叫过的病人的kssxid-1
//                      cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                              ' where jzbz=0'+
//                              ' and ksid=''' +hjks[i].TGroupid + '''' +
//                              ' and hszh=' + inttostr(gblHszh);
//                      adoconnection.Execute(cmdstr ,cmdText);
//                      //修改T_dhxx中的数据，将本条数据改为就诊
//                      cmdstr:=' UPDATE t_dhxx SET JZBZ=0' +
//                              ' ,yhid=''' + zdyhid + ''''+
//                              ' ,ckhm='+fjh+
//                              ' ,jzsj=getdate()' +
//                              ' ,kssxid=0' +
//                              ' where id=' + jrid ;
//                      adoconnection.Execute(cmdstr ,cmdText);
                      doUpdateWaitlistPos(hjks[i].TGroupid ,jrid,zdyhid,fjh,gblhszh);
                      DB_SetHisPatientStatus(jrid);
                      //添加显示信息
                      ///delete by wugang @2010-03-16
                      //将多个号的信息合到一条显示信息记录中.
                      //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                      ///delete end ///
                      ///add by wugang @2010-03-16
                      //将多个号的信息合到一条显示信息记录中.
                      strCallnos := strCallnos+ghhm+'|';
                      strCallnames := strCallnames+brxm+'|';
                      strby4 := strby4+by4+'|';
                      ///add end ///
                      iscall:=true;
                      yhjrs:=yhjrs+1;
                      if yhjrs=hjrs then
                      begin
                         //add by wugang @2010-03-16
                         //在呼叫人数到时将信息保存到显示信息表中.
                         WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                         ///add end///
                         //得到准备病人信息，并返回到结果中.
                         if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                         begin
                           prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                           result := result +','+prepareinfo;
                         end;
                         break;
                      end
                      else
                      begin
                         qr.Next;
                         //add by wugang @2010-03-16
                         //在呼叫人数到时将信息保存到显示信息表中.
                         if qr.Eof then
                         begin
                            WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                            //得到准备病人信息，并返回到结果中.
                           if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                           begin
                              prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                              result := result +','+prepareinfo;
                           end;
                         end;
                         ///add end ///
                      end;
                  end;
                  close;
              end;//end with
              if iscall then
              begin
                 //修改此员工此呼叫科室的呼叫人数;
//                 cmdstr :=' update t_yh set CalledCounts'+inttostr(i)+'=CalledCounts'+inttostr(i)+'+1'+
//                          ' where yhid='''+ZDYHID+''''+
//                          ' and hszh='+inttostr(gblhszh);
                 cmdstr := ' update t_yh_ks set CalledCount=CalledCount+'+inttostr(yhjrs)+
                          ' where yhid='''+ZDYHID+''''+
                          ' and ksid='+quotedstr(hjks[i].TGroupid)+
                          ' and hszh='+inttostr(gblhszh);
                 qr.SQL.Text := cmdstr;
                 try
                   qr.ExecSQL;
                   //calledcount[i]:= calledcount[i]+1;
                   hjks[i].TCalledCount := hjks[i].TCalledCount+yhjrs;
                 except
                 end;
                 break;
              end;
             end;
           end; //end for
         end;
         if iscall then
         begin
           clearCalledCount:=True;
           for i:=1 to hjksnum-1 do//查询是否要清除呼叫人数
           begin
             //if  (calledcount[i]<callcount[i]) and (callcount[i]>0) then
             cmdstr :=' update t_yh_ks set calledcount='+ IntToStr(hjks[i].TCalledCount)+
                  ' where yhid='+quotedstr(zdyhid)+
                  ' and ksid='+quotedstr(hjks[i].TGroupid)+
                  ' and hszh='+inttostr(gblHSZH);
             qr.SQL.Text :=cmdstr;
             try
               qr.ExecSQL;
             except
             end;
             if ((hjks[i].Tgroupstate=2) //已呼叫过
              and (hjks[i].TCalledCount<hjks[i].TCallCount) //未达到呼叫人数
              and (hjks[i].TCallCount>0))
              or (hjks[i].Tgroupstate=-1) then
             begin
               clearCalledCount:=False;
               Break;
             end
             else
             begin
               clearCalledCount:=true;
             end;
           end;

           if clearCalledCount then//将员工的呼叫人数清0
           begin
//             cmdstr :=' update t_yh set calledcounts1=0,calledcounts2=0,'+
//                  ' calledcounts3=0 '+
//                  ' where yhid='''+zdyhid+''''+
//                  ' and hszh='+inttostr(gblHSZH);
             cmdstr :=' update t_yh_ks set calledcount=0 '+
                  ' where yhid='''+zdyhid+''''+
                  ' and hszh='+inttostr(gblHSZH);
             qr.SQL.Text :=cmdstr;
             try
               qr.ExecSQL;
             except
             end;
           end;
         end;
       end
       else if hjfs=2 then
       begin
           cmdstrks:='';
           for i:=1 to hjksnum-1 do
           begin
//              if length(cmdstrks)>0 then
//                 cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjksid[i] +''''
//              else
//                 cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
              if length(cmdstrks)>0 then
                 cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
              else
                 cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;

           end;
         if Length(cmdstrks)>0 then
            cmdstrks :='('+ cmdstrks+')';
          ksbrdys := dmdbaccess.GetDBValue('KS',hjks[1].TGroupid,'SelDoctor');
          if ksbrdys='' then ksbrdys:='0';
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
//          if gblBRDYS=1 then
             cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,ksid from  ' +
                     ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' where (' +cmdstrks+')'+
                     ' and t_dhxx.jzbz=1' +
                     ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
//                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                     strKeyStr +
                     ' order by t_dhxx.yxjid desc,by7,replicate(''0'',10-len(ghhm))+ghhm,kssxid '
          else
             begin
             cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,ksid from  ' +
                     ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' where ('+cmdstrks+')'+
                     ' and t_dhxx.jzbz=1' +
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
//                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                     strKeyStr +
                     ' order by t_dhxx.yxjid desc,by7,replicate(''0'',10-len(ghhm))+ghhm,kssxid '
             end   ;
          qr.SQL.Text := cmdstr;
          qr.Open;

          ///////////将中.
          with qr do
          begin
             while not qr.Eof  do
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  GHHM:=fields.fields[3].asstring;
                  YXJID:=Fields.Fields[4].asString;
                  yxjmc:=fields.fields[5].asstring;
                  DDRs:=RecordCount-1;
                  brdm:=fields.fields[6].asstring;
                  by4:=fields.fields[7].asstring;
                  tmpksid:=fields.fields[8].asstring;
                  for i:=1 to hjksnum do
                  begin
                     if tmpksid=hjks[i].TGroupid then
                        tmpksmc:=hjks[i].TGroupName;//hjksmc[i];
                  end;
                  if cmd='82' then
                  begin
                     tmpghhm:=ghhm;
                     if length(tmpghhm)=0  then
                        tmpghhm:='0000'
                     else if length(tmpghhm)=1  then
                        tmpghhm:='000'+tmpghhm
                     else if length(tmpghhm)=2  then
                        tmpghhm:='00'+tmpghhm
                     else if length(tmpghhm)=3  then
                        tmpghhm:='0'+tmpghhm
                     else
                        tmpghhm:=RightStr(tmpghhm,4);
                     result:=zdid +cmd  +'01' + tmpghhm  ;
                  end
                  else if (cmd='32') or (cmd='67') then
                  begin
  {                   tmpghhm:=ghhm;
                     if length(tmpghhm)=0  then
                        tmpghhm:='0000'
                     else if length(tmpghhm)=1  then
                        tmpghhm:='000'+tmpghhm
                     else if length(tmpghhm)=2  then
                        tmpghhm:='00'+tmpghhm
                     else if length(tmpghhm)=3  then
                        tmpghhm:='0'+tmpghhm
                     else
                        tmpghhm:=copy(tmpghhm,1,4);}
                     result:=zdid+cmd + getstrwithnotbadcode(tmpksmc[i],8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                  end
                  else
                     result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+tmpksid;
                  //并将数据放入显示信息表中
                  //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                  gbledit_ks[gbledit_ks_count].ksid:=tmpksid;
                  gbledit_ks[gbledit_ks_count].ksmc:=tmpksmc;
                  gbledit_ks_count:=gbledit_ks_count+1;


//                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                          ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
//                          ' and ksid=''' +tmpksid + '''' +
//                          ' and hszh=' + inttostr(gblHszh);
//                  adoconnection.Execute(cmdstr ,cmdText);
//                  //将这个科室已呼叫过的病人的kssxid-1
//                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                          ' where jzbz=0'+
//                          ' and ksid=''' +tmpksid + '''' +
//                          ' and hszh=' + inttostr(gblHszh);
//                  adoconnection.Execute(cmdstr ,cmdText);
//                  //修改T_dhxx中的数据，将本条数据改为就诊
//                  cmdstr:=' UPDATE t_dhxx SET JZBZ=0' +
//                          ' ,yhid=''' + zdyhid + ''''+
//                          ' ,ckhm='+fjh+
//                          ' ,jzsj=getdate()' +
//                          ' ,kssxid=0' +
//                          ' where id=' + jrid ;
//                  adoconnection.Execute(cmdstr ,cmdText);
                 doUpdateWaitlistPos(tmpksid,jrid,zdyhid,fjh,gblhszh);
                 { //添加显示信息
                  WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,'',DDRS,1);
                  iscall:=true;
                  yhjrs:=yhjrs+1;
                  if yhjrs=hjrs then
                     break
                  else
                     qr.Next;
                     }
                  //添加显示信息
                  ///delete by wugang @2010-03-16
                  //将多个号的信息合到一条显示信息记录中.
                  //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,'',DDRS,1);
                  ///delete end ///
                  ///add by wugang @2010-03-16
                  //将多个号的信息合到一条显示信息记录中.
                  strCallnos := strCallnos+ghhm+'|';
                  strCallnames := strCallnames+brxm+'|';
                  strby4:=strby4+by4+'|';
                  ///add end ///
                  iscall:=true;
                  yhjrs:=yhjrs+1;
                  if yhjrs=hjrs then
                  begin
                     //add by wugang @2010-03-16
                     //在呼叫人数到时将信息保存到显示信息表中.
                     WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                     ///add end///
                     //得到准备病人信息，并返回到结果中.
                     if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                     begin
                       prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                       result := result +','+prepareinfo;
                     end;
                     break;
                  end
                  else
                  begin
                     qr.Next;
                     //add by wugang @2010-03-16
                     //在呼叫人数到时将信息保存到显示信息表中.
                     if qr.Eof then
                     begin
                        WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                         //得到准备病人信息，并返回到结果中.
                         if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                         begin
                           prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                           result := result +','+prepareinfo;
                         end;
                     end;
                     ///add end ///
                  end;
              end;
              close;
            end;
       end
       else if hjfs=3 then
       begin
           cmdstrks:='';
           for i:=1 to hjksnum-1 do
           begin
//              if length(cmdstrks)>0 then
//                 cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjksid[i] +''''
//              else
//                 cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
              if length(cmdstrks)>0 then
                 cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
              else
                 cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
           end;

          ksbrdys := dmdbaccess.GetDBValue('KS',hjks[1].TGroupid,'SelDoctor');
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          //if gblBRDYS=1 then
             cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,ksid from  ' +
                     ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' where (' +cmdstrks+')'+
                     ' and t_dhxx.jzbz=1' +
                     ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
//                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                     strKeyStr +
                     ' order by t_dhxx.yxjid desc,by7,ghsj,kssxid '
          else
             begin
             cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,ksid from  ' +
                     ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' where ('+cmdstrks+')'+
                     ' and t_dhxx.jzbz=1' +
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
//                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                     strKeyStr +
                     ' order by t_dhxx.yxjid desc,by7,ghsj,kssxid '
             end   ;
          qr.SQL.Text := cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
             while not qr.Eof  do
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  GHHM:=fields.fields[3].asstring;
                  YXJID:=Fields.Fields[4].asString;
                  yxjmc:=fields.fields[5].asstring;
                  DDRs:=RecordCount-1;
                  brdm:=fields.fields[6].asstring;
                  by4:=fields.fields[7].asstring;
                  tmpksid:=fields.fields[8].asstring;
                  for i:=1 to hjksnum do
                  begin
                     if tmpksid=hjks[i].TGroupid then
                        tmpksmc:=hjks[i].TGroupName;
                  end;
                  if cmd='82' then
                  begin
                     tmpghhm:=ghhm;
                     if length(tmpghhm)=0  then
                        tmpghhm:='0000'
                     else if length(tmpghhm)=1  then
                        tmpghhm:='000'+tmpghhm
                     else if length(tmpghhm)=2  then
                        tmpghhm:='00'+tmpghhm
                     else if length(tmpghhm)=3  then
                        tmpghhm:='0'+tmpghhm
                     else
                        tmpghhm:=RightStr(tmpghhm,4);
                     result:=zdid +cmd  +'01' + tmpghhm  ;
                  end
                  else if (cmd='32') or (cmd='67') then
                  begin
  {                   tmpghhm:=ghhm;
                     if length(tmpghhm)=0  then
                        tmpghhm:='0000'
                     else if length(tmpghhm)=1  then
                        tmpghhm:='000'+tmpghhm
                     else if length(tmpghhm)=2  then
                        tmpghhm:='00'+tmpghhm
                     else if length(tmpghhm)=3  then
                        tmpghhm:='0'+tmpghhm
                     else
                        tmpghhm:=copy(tmpghhm,1,4);}
                     result:=zdid+cmd + getstrwithnotbadcode(tmpksmc[i],8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                  end
                  else
                     result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+tmpksid;
                  //并将数据放入显示信息表中
                  //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                  gbledit_ks[gbledit_ks_count].ksid:=tmpksid;
                  gbledit_ks[gbledit_ks_count].ksmc:=tmpksmc;
                  gbledit_ks_count:=gbledit_ks_count+1;


//                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                          ' where kssxid >(select kssxid from t_dhxx where id=' + jrid +')'+
//                          ' and ksid=''' +tmpksid + '''' +
//                          ' and hszh=' + inttostr(gblHszh);
//                  adoconnection.Execute(cmdstr ,cmdText);
//                  //将这个科室已呼叫过的病人的kssxid-1
//                  cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                          ' where jzbz=0'+
//                          ' and ksid=''' +tmpksid + '''' +
//                          ' and hszh=' + inttostr(gblHszh);
//                  adoconnection.Execute(cmdstr ,cmdText);
//                  //修改T_dhxx中的数据，将本条数据改为就诊
//                  cmdstr:=' UPDATE t_dhxx SET JZBZ=0' +
//                          ' ,yhid=''' + zdyhid + ''''+
//                          ' ,ckhm='+fjh+
//                          ' ,jzsj=getdate()' +
//                          ' ,kssxid=0' +
//                          ' where id=' + jrid ;
//                  adoconnection.Execute(cmdstr ,cmdText);
                  doUpdateWaitlistPos(tmpksid,jrid,zdyhid,fjh,gblhszh);

                  DB_SetHisPatientStatus(jrid);
                  //添加显示信息
                  ///delete by wugang @2010-03-16
                  //将多个号的信息合到一条显示信息记录中.
                  //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                  ///delete end ///
                  ///add by wugang @2010-03-16
                  //将多个号的信息合到一条显示信息记录中.
                  strCallnos := strCallnos+ghhm+'|';
                  strCallnames := strCallnames+brxm+'|';
                  strby4 := strby4+by4+'|';
                  ///add end ///
                  iscall:=true;
                  yhjrs:=yhjrs+1;
                  if yhjrs=hjrs then
                  begin
                     //add by wugang @2010-03-16
                     //在呼叫人数到时将信息保存到显示信息表中.
                     WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                     ///add end///
                     //得到准备病人信息，并返回到结果中.
                     if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                     begin
                       prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                       result := result +','+prepareinfo;
                     end;
                     break;
                  end
                  else
                  begin
                     qr.Next;
                     //add by wugang @2010-03-16
                     //在呼叫人数到时将信息保存到显示信息表中.
                     if qr.Eof then
                     begin
                        WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                         //得到准备病人信息，并返回到结果中.
                         if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                         begin
                           prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                           result := result +','+prepareinfo;
                         end;
                     end;
                     ///add end ///
                  end;
              end;
              close;
            end;
       end;
       qr.Close;
       Freeandnil(qr);
     end;
       if iscall=false  then
          begin
            //写入此时此呼叫器空闲???
            // add by wugang @2010-07-20
            //修改呼叫终端状态
            try
              adoconnection.Execute('update t_hjzd set state=''空闲'''+
                ',calltime=getdate()'+
                ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
            except
              adoconnection.Execute('update t_hjzd set state=''空闲'''+
                ',calltime=getdate()'+
                ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
            end;
            /////////////////////////
            ///////add end////////
            if (cmd='32') or (cmd='67') then
            result:=zdid +cmd  +'等待人数:0     '+''
            else
            result:=zdid +cmd  +'000000'  ;
          end;


  except
    begin
       if (cmd='32') or (cmd='67') then
            result:=zdid +cmd  +'呼叫失败!      '+'呼叫时有错误!'
      else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    freeandnil(qr1);
  end;
end;
//顺呼功能//
//增加按优先类别呼叫功能//
function TdmDBAccess.YHCallNextKeySet_new(const zdid, cmd,
  Akeyset: string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
   clearCalledCount:Boolean;
   i,j:integer;
   hjksnum:integer;
   cmdstr:widestring;
   cmdstrks:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,ztbz,yhlcs:string;
   zdzt,zdstate:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   tmpghhm:string;
   hjfs:integer;
   tmpksid:string;
   tmpksmc:string;
   hjrs:integer;//呼叫人数
   yhjrs:integer;//
   by6,by3:string;
   yksdm:string;
   qr:Tadoquery;
   ksbrdys:string;
   nextdelay:Integer;
   strCallnos,strCallnames,strby4:string;
   qr1 : TADOQuery;
   strKeyStr:string;
   hjks:array [1..20] of CallGroup_Info;
   prepareinfo:string;
   yxhj,yxhjzs:integer; //科室优先呼叫
begin
  //加入按by6查询条件//
  i:= FoundChar(',',Akeyset);
  if i>0 then
  begin
    j:=1;
    strKeyStr :=QuotedStr(getpartstr(AnsiReplaceStr(Akeyset,',','|'),IntToStr(j)));
    while i>0 do
    begin
      i:= FoundChar(',',Akeyset,i+1);
      if i>0 then
      begin
        j:=j+1;
        strKeyStr:= strKeyStr+','+QuotedStr(getpartstr(AnsiReplaceStr(Akeyset,',','|'),IntToStr(j)));
      end
      else
        Break;
    end;
  end
  else
    j:=0;
  if j>0 then
    strKeyStr :=' and by6 in ('+ strKeyStr+')'
  else
    strKeyStr :='';

  qr1 := TADOQuery.Create(nil);
  try
    qr1.Connection := ADOConnection;
    try
    //1.查看登录状态
      result:='';
      iscall:=false;
      qr1.Close;
      //在等待T_hjzd表中查找zdid.
      qr1.sql.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc,hjrs,zt,state'+
                              ',case when callnexttime is NULL then 999999 else '+
                              ' datediff(s,callnexttime,getdate()) end as nextdelay'+
                              ' from t_hjzd left outer join t_yh on ' +
                              ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                              ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
      try
        qr1.Open;
      except
        qr1.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc,hjrs,zt,state'+
                              ',999999 as nextdelay'+
                              ' from t_hjzd left outer join t_yh on ' +
                              ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                              ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
        qr1.Open;
      end;
      ///////////将中.
      with qr1 do
      begin
         if not qr1.Eof  then
           begin
            zdyhid:=fields.fields[4].asstring ;
            zdyhmc:=fields.fields[5].asstring;
            fjh:=fields.Fields[1].AsString;
            fjmc:=fields.Fields[6].AsString;
            zth:=fields.Fields[2].AsString;
            ztmc:=fields.Fields[3].AsString;
            hjrs:=fields.Fields[7].AsInteger;
            zdzt:=fields.Fields[8].AsString;
            zdstate:=fields.Fields[9].AsString;
            nextdelay := fields.Fields[10].AsInteger;
             if ( zdyhid <>'')  then
             begin
               close;
             end
             else
               begin
               if (cmd='32') or (cmd='67') then
               result:=zdid+cmd + '还没有登录!    请登录工号     '///没有登录.
               else
               result:=zdid+cmd + '028888';///没有登录.
               close;
               exit;
               end;
            end
         else
           begin
             if (cmd='32') or (cmd='67') then
               result:=zdid+cmd + '无此呼叫器!    请管理员设置!'///没有登录.
             else
             result:=zdid + cmd + '038888';  ///没有此呼叫器
             close ;
             exit;
           end;
      end;
      yhjrs:=0;
      //在等待T_YH表中查找YHID信息.
      if gblCallWithGrpState=0 then
      begin
        qr1.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC ' +
                ' FROM t_YH '+
                ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')';
      end
      else
      begin
        qr1.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC ' +
                ' FROM t_YH '+
                ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')';
      end;
      qr1.Open;
      //////////.
      with qr1 do
      begin
         if not qr1.Eof  then
         begin
            hjksnum:=1;
             close;
             //add by wugang @20111028
             GetYHCallKS(zdyhid,hjksnum,hjks);
             if hjksnum=0 then
             begin
               if (cmd='32') or (cmd='67') then
                 result:=zdid+cmd + '未设置呼叫队列!请管理员设置!'
               else
                 result:=zdid + cmd + '048888';  //没有找到呼叫的科室
                 exit;
             end;
             if hjksnum>0 then hjksnum:=hjksnum+1;
             ///////add end/////////////
         end
         else
         begin
             if (cmd='32') or (cmd='67') then
               result:=zdid+cmd + '未设置此工号!  请管理员设置!'
             else
             result:=zdid + cmd + '008888';  //没有此用户号
             Close;
             exit;
         end;
      end;
      //修改呼叫终端状态
      try
        adoconnection.Execute('update t_hjzd set state=''顺呼'''+
          ',calltime=getdate(),callnexttime=getdate()'+
          ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
      except
        adoconnection.Execute('update t_hjzd set state=''顺呼'''+
          ',calltime=getdate()'+
          ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
      end;
      //2.查询呼叫科室//
      if hjksnum>1 then
      begin
         qr:= TADOQuery.Create(nil);
         qr.Connection := ADOConnection;
         cmdstr:='';
         cmdstrks:='';
         i:=1;
         for i:=1 to hjksnum-1 do
         begin
            if length(cmdstrks)>0 then
               cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
            else
               cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
         end;
         //查询出上一个呼叫病人。//
         if Length(cmdstrks)>0 then
            cmdstrks :='('+ cmdstrks+')';
         cmdstr:=' select top 1 id,jzjssj,ztbz,yhlcs from' +
                 ' t_dhxx ' +
                 ' where (' + cmdstrks  +')' +
                 ' and t_dhxx.jzbz=0' +
                 ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                 ' and t_dhxx.yhid=''' + zdyhid + ''''+
                 ' and t_dhxx.jzsj is not null ' +
                 ' order by t_dhxx.jzsj desc ';
          qr.SQL.Text := cmdstr;
          qr.Open ;
          jrid:='';
          if not qr.Eof  then
          begin
              //将上一个呼叫病人的jzjssj改为当前时间//
              jrid:=qr.fields.Fields[0].AsString;
              ztbz := qr.fields.Fields[2].AsString;
              yhlcs := qr.fields.Fields[3].AsString;
              if qr.fields.Fields[1].AsString='' then
              begin
                cmdstr:=' UPDATE t_dhxx '+
                        ' SET jzjssj=getdate()' +
                        ' where id=' + jrid ;
                adoconnection.Execute(cmdstr ,cmdText);
              end;
              doUnLockOtherGroupSamePat(jrid);
          end;
          qr.Close;
         //3.查询呼叫科室是否开启优先呼叫功能
         yxhj := getksyxhj(hjks[1].TGroupid);
//         yxhj:=0;
         if yxhj=1 then
         begin
           for i:= 1 to hjksnum-1 do
           begin
              //3.1 开启 查询诊室是否为优先呼叫诊室
              yxhjzs := getroomyxhj(zdid);
              ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
              if ksbrdys='' then ksbrdys:='0';
              if yxhjzs=1 then
              begin
              // 3.1.1  是,先查询科室对应的优先呼叫类别病人
              //  再查询其它类别病人//
                if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
                           ' and t_dhxx.yxjid in (select yxjid from t_ks_yxlb where hszh=t_dhxx.hszh and ksid=t_dhxx.ksid) '+
                           strKeyStr +
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                else
                   begin
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
                           ' and t_dhxx.yxjid in (select yxjid from t_ks_yxlb where hszh=t_dhxx.hszh and ksid=t_dhxx.ksid) '+
                           strKeyStr +
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                   end   ;
                  qr.SQL.Text := cmdstr;
                  qr.Open;
                  if qr.Eof then //如果没有找到此类别的病人，则找其它类别的病人
                  begin
                    qr.Close;
                    if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                               ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                               ' and t_dhxx.jzbz=1' +
                               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
                               ' and t_dhxx.yxjid not in (select yxjid from t_ks_yxlb where hszh=t_dhxx.hszh and ksid=t_dhxx.ksid) '+
                               strKeyStr +
                               ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                    else
                       begin
                       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                               ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                               ' and t_dhxx.jzbz=1' +
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
                               ' and t_dhxx.yxjid not in (select yxjid from t_ks_yxlb where hszh=t_dhxx.hszh and ksid=t_dhxx.ksid) '+
                               strKeyStr +
                               ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                       end   ;
                      qr.SQL.Text := cmdstr;
                      qr.Open;
                  end;
              end
              else
              begin
                // 3.1.2  否，先查询非科室对应的优先呼叫类别病人
                //  再查询科室对应的优先呼叫类别病人
                if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
                           ' and t_dhxx.yxjid not in (select yxjid from t_ks_yxlb where hszh=t_dhxx.hszh and ksid=t_dhxx.ksid) '+
                           strKeyStr +
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                else
                   begin
                   cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                           ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                           ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                           ' and t_dhxx.jzbz=1' +
                           ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                           ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                           ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
                           ' and t_dhxx.yxjid not in (select yxjid from t_ks_yxlb where hszh=t_dhxx.hszh and ksid=t_dhxx.ksid) '+
                           strKeyStr +
                           ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                   end   ;
                  qr.SQL.Text := cmdstr;
                  qr.Open;
                  if qr.Eof then //如果没有找到此类别的病人，则找其它类别的病人
                  begin
                    qr.Close;
                    if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                               ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                               ' and t_dhxx.jzbz=1' +
                               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
                               ' and t_dhxx.yxjid in (select yxjid from t_ks_yxlb where hszh=t_dhxx.hszh and ksid=t_dhxx.ksid) '+
                               strKeyStr +
                               ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                    else
                       begin
                       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                               ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                               ' and t_dhxx.jzbz=1' +
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
                               ' and t_dhxx.yxjid in (select yxjid from t_ks_yxlb where hszh=t_dhxx.hszh and ksid=t_dhxx.ksid) '+
                               strKeyStr +
                               ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                       end   ;
                      qr.SQL.Text := cmdstr;
                      qr.Open;
                  end;
              end;
              with qr do
              begin
                while not qr.Eof  do
                begin
                    //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                    jrid:=fields.Fields[0].AsString;
                    kssxid:=fields.fields[1].asstring;
                    Brxm:=Fields.Fields[2].AsString;
                    GHHM:=fields.fields[3].asstring;
                    YXJID:=Fields.Fields[4].asString;
                    yxjmc:=fields.fields[5].asstring;
                    DDRs:=RecordCount-1;
                    brdm:=fields.fields[6].asstring;
                    by4:=fields.fields[7].asstring;
                    by3:=fields.fields[9].asstring;
                    yksdm := fields.fields[10].asstring;
                    tmpksid:=hjks[i].TGroupid;
                    tmpksmc:=hjks[i].TGroupName;
                    //加入选择医生及排除医生的功能//
                    if not (yhcancall(jrid,zdyhid,ksbrdys)) then  //如果当前医生不能呼叫此病人，则取下一条数据//
                    begin
                      qr.Next;
                      continue;
                    end;
                    //呼叫成功
                    addyhcancall(jrid,zdyhid,'-1');   //插入排除医生信息
                    if cmd='82' then
                    begin
                       tmpghhm:=ghhm;
                       if length(tmpghhm)=0  then
                          tmpghhm:='0000'
                       else if length(tmpghhm)=1  then
                          tmpghhm:='000'+tmpghhm
                       else if length(tmpghhm)=2  then
                          tmpghhm:='00'+tmpghhm
                       else if length(tmpghhm)=3  then
                          tmpghhm:='0'+tmpghhm
                       else
                          tmpghhm:=RightStr(tmpghhm,4);
                       result:=zdid +cmd  +'01' + tmpghhm  ;
                    end
                    else if (cmd='32') or (cmd='67') then
                    begin
                       result:=zdid+cmd + getstrwithnotbadcode(tmpksmc,8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                    end
                    else
                    begin
                       if yksdm<>'' then
                       begin
                         result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+yksdm;
                       end
                       else
                         result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+tmpksid;
                    end;
                       //安徽省立result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+tmpksid+','+by3;
                    //并将数据放入显示信息表中
                    //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                    gbledit_ks[gbledit_ks_count].ksid:=tmpksid;
                    gbledit_ks[gbledit_ks_count].ksmc:=tmpksmc;
                    gbledit_ks_count:=gbledit_ks_count+1;

                    doUpdateWaitlistPos(tmpksid,jrid,zdyhid,fjh,gblhszh);

                    DB_SetHisPatientStatus(jrid);

                    doLockOtherGroupSamePat(jrid);

                    //添加显示信息
                    ///delete by wugang @2010-03-16
                    //将多个号的信息合到一条显示信息记录中.
                    //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                    ///delete end ///
                    ///add by wugang @2010-03-16
                    //将多个号的信息合到一条显示信息记录中.
                    strCallnos := strCallnos+ghhm+'|';
                    strCallnames := strCallnames+brxm+'|';
                    strby4 := strby4+by4+'|';
                    ///add end ///
                    iscall:=true;
                    yhjrs:=yhjrs+1;
                    if yhjrs=hjrs then
                    begin
                       //add by wugang @2010-03-16
                       //在呼叫人数到时将信息保存到显示信息表中.
                       WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                       ///add end///
                       //得到准备病人信息，并返回到结果中.
                       if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                       begin
                         prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                         result := result +','+prepareinfo;
                       end;
                       break;
                    end
                    else
                    begin
                       qr.Next;
                       //add by wugang @2010-03-16
                       //在呼叫人数到时将信息保存到显示信息表中.
                       if qr.Eof then
                       begin
                          WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                           //得到准备病人信息，并返回到结果中.
                           if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                           begin
                             prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                             result := result +','+prepareinfo;
                           end;
                       end;
                       ///add end ///
                    end;
                end;
                close;
              end;
              if iscall then
              begin
                break;
              end;
           end;
         end
         else
         begin
           //3.2 关闭 根据原呼叫规则呼叫
            cmdstr:='';
            //2017-05-02此处增加功能：判断前一个呼叫病人的完成状态和忽略状态
            //如果是完成状态或忽略次数已到设定次数，则可以顺呼一下位，否则不能顺呼.
            if length(jrid)>0 then
            begin
              if gblcheckprevpatient=1 then
              begin
                 if (ztbz<>'7') and (strtoint(yhlcs)<gblhlcs) then  //没有完成，并且忽略次数没有到系统设置的忽略次
                 begin
                   //返回 不能呼叫//
                   if (cmd='32') or (cmd='67') then
                     result:=zdid+cmd + '顺呼太快  !    请先完成病人   '///先完成病人
                   else
                     result:=zdid+cmd + '068888';///先完成病人
                   exit;
                 end;
               end;
            end;
            //////////////////////////////////////////////////////////////////////
            hjfs:=DB_GetHJFS(gblhszh,zdyhid);
           if hjfs=1 then  //按科室先后呼叫//
           begin
             for i:= 1 to hjksnum-1 do
             begin
               //if (calledcount[i]>=callcount[i]) and (callcount[i]>0) then
               if (hjks[i].TCalledCount>=hjks[i].TCallCount)
                  and (hjks[i].TCallCount>0) then
               begin
                  //ksCallState[i]:=1;
                  hjks[i].TGroupState :=1;
                  Continue;
               end
               //else if (callcount[i]=0) or  (calledcount[i]<callcount[i]) then//不指定呼叫人数
               else if (hjks[i].TCallCount=0) or  (hjks[i].TCalledCount<hjks[i].TCallCount) then//不指定呼叫人数
               begin
                 //查询此科室等候人数:
                  if zdzt='暂停' then
                  begin
                    //ksbrdys := dmdbaccess.GetDBValue('KS',hjksid[i],'SelDoctor');
                    ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
                    if ksbrdys='' then ksbrdys:='0';
                    if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                    //if gblBRDYS=1 then
                       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                               //' where t_dhxx.ksid=''' + hjksid[i] + '''' +
                               ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                               ' and t_dhxx.jzbz=1' +
                               ' and t_dhxx.ztbz=5'+
                               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
                               strKeyStr +
                               ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                    else
                       begin
                       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                               //' where t_dhxx.ksid=''' + hjksid[i] + '''' +
                               ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                               ' and t_dhxx.jzbz=1' +
                               ' and t_dhxx.ztbz=5'+
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
                               //' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                               strKeyStr +
                               ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                       end   ;
                  end
                  else
                  begin
                    ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
                    if ksbrdys='' then ksbrdys:='0';
                    if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                    //if gblBRDYS=1 then
                       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                               ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                               ' and t_dhxx.jzbz=1' +
                               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+

    //                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                               strKeyStr +
                               ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                    else
                       begin
                       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                               ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                               ' and t_dhxx.jzbz=1' +
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
    //                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                               strKeyStr +
                               ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                       end   ;
                  end;
                  qr.SQL.Text := cmdstr;
                  qr.Open;
                  with qr do
                  begin
                      if qr.Eof then
                      begin
                        //ksCallState[i]:=0;
                        hjks[i].TGroupState :=0;
                      end
                      else
                      begin
                        //ksCallState[i]:=2;
                        hjks[i].TGroupState :=2;
                        while  not qr.Eof  do
                        begin
                            //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                            jrid:=fields.Fields[0].AsString;
                            kssxid:=fields.fields[1].asstring;
                            Brxm:=Fields.Fields[2].AsString;
                            GHHM:=fields.fields[3].asstring;
                            YXJID:=Fields.Fields[4].asString;
                            yxjmc:=fields.fields[5].asstring;
                            DDRs:=RecordCount-1;
                            brdm:=fields.fields[6].asstring;
                            by4:=fields.fields[7].asstring;
                            by6:=fields.fields[8].asstring;
                            by3:=fields.fields[9].asstring;
                            yksdm:=fields.fields[10].asstring;
                            //加入选择医生及排除医生的功能//
                            if not (yhcancall(jrid,zdyhid,ksbrdys)) then  //如果当前医生不能呼叫此病人，则取下一条数据//
                            begin
                              qr.Next;
                              continue;
                            end;
                            //呼叫成功
                            addyhcancall(jrid,zdyhid,'-1');   //插入排除医生信息
                            if cmd='82' then
                            begin
                               tmpghhm:=ghhm;
                               if length(tmpghhm)=0  then
                                  tmpghhm:='0000'
                               else if length(tmpghhm)=1  then
                                  tmpghhm:='000'+tmpghhm
                               else if length(tmpghhm)=2  then
                                  tmpghhm:='00'+tmpghhm
                               else if length(tmpghhm)=3  then
                                  tmpghhm:='0'+tmpghhm
                               else
                                  tmpghhm:=RightStr(tmpghhm,4);
                               result:=zdid +cmd  +'01' + tmpghhm  ;
                            end
                            else if (cmd='32') or (cmd='67') then
                            begin
                               result:=zdid+cmd + getstrwithnotbadcode(hjks[i].TGroupName,8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                            end
                            else
                            begin
                              if yksdm<>'' then
                                result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+yksdm
                              else
                                result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid;
                            end;
                             //安徽省立  result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid+','+by3;
                            //并将数据放入显示信息表中
                            //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                            gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid;//hjksid[i];
                            gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;//hjksmc[i];
                            gbledit_ks_count:=gbledit_ks_count+1;
                            doUpdatewaitlistpos(hjks[i].TGroupid,jrid,zdyhid,fjh,gblhszh);
                            DB_SetHisPatientStatus(jrid);
                            doLockOtherGroupSamePat(jrid);

                          //添加显示信息
                          ///delete by wugang @2010-03-16
                          //将多个号的信息合到一条显示信息记录中.
                          //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                          ///delete end ///
                          ///add by wugang @2010-03-16
                          //将多个号的信息合到一条显示信息记录中.
                          strCallnos := strCallnos+ghhm+'|';
                          strCallnames := strCallnames+brxm+'|';
                          strby4 := strby4+by4+'|';
                          ///add end ///
                          iscall:=true;
                          yhjrs:=yhjrs+1;
                          if yhjrs=hjrs then
                          begin
                             //add by wugang @2010-03-16
                             //在呼叫人数到时将信息保存到显示信息表中.
                             WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                             ///add end///
                             //得到准备病人信息，并返回到结果中.
                             if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                             begin
                               prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                               result := result +','+prepareinfo;
                             end;
                             break;
                          end
                          else
                          begin
                             qr.Next;
                             //add by wugang @2010-03-16
                             //在呼叫人数到时将信息保存到显示信息表中.
                             if qr.Eof then
                             begin
                                WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                                 //得到准备病人信息，并返回到结果中.
                               if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                               begin
                                   prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                                   result := result +','+prepareinfo;
                               end;
                             end;
                             ///add end ///
                          end;

                        end;
                      end;
                      close;
                  end;//end with
                  if hjks[i].TGroupState=0 then//ksCallState[i]=0 then
                     Continue
                  else
                  begin
                     //修改此员工此呼叫科室的呼叫人数;
                     cmdstr := ' update t_yh_ks set CalledCount=CalledCount+'+inttostr(yhjrs)+
                              ' where yhid='''+ZDYHID+''''+
                              ' and ksid='+quotedstr(hjks[i].TGroupid)+
                              ' and hszh='+inttostr(gblhszh);
                     qr.SQL.Text := cmdstr;
                     try
                       qr.ExecSQL;
                       //calledcount[i]:= calledcount[i]+1;
                       hjks[i].TCalledCount := hjks[i].TCalledCount+yhjrs;
                     except
                     end;
                     Break;
                  end;
               end;
             end;
             if  not iscall then //如果没有呼叫到病人
             begin
               for i:=1 to hjksnum-1 do
               begin
                 if hjks[i].TGroupState=1 then//ksCallState[i]=1 then
                 begin
                  if zdzt='暂停' then
                  begin
                    ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
                    if ksbrdys='' then ksbrdys:='0';
                    if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                    //if gblBRDYS=1 then
                       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                               ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                               ' and t_dhxx.jzbz=1' +
                               ' and t_dhxx.ztbz=5'+
                               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
    //                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                               strKeyStr +
                               ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                    else
                       begin
                       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                               ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                               ' and t_dhxx.jzbz=1' +
                               ' and t_dhxx.ztbz=5'+
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
    //                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                               strKeyStr +
                               ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                       end   ;
                  end
                  else
                  begin
                    ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
                    if ksbrdys='' then ksbrdys:='0';
                    if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
                    //if gblBRDYS=1 then
                       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                               ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                               ' and t_dhxx.jzbz=1' +
                               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
    //                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                               strKeyStr +
                               ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                    else
                       begin
                       cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,by6,by3,yksdm from  ' +
                               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                               ' where t_dhxx.ksid=''' + hjks[i].TGroupid + '''' +
                               ' and t_dhxx.jzbz=1' +
                               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                               ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
    //                           ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                               strKeyStr +
                               ' order by t_dhxx.kssxid,t_dhxx.yxjid desc,sjdbz,replicate(''0'',10-len(ghhm))+ghhm '
                       end   ;
                  end;
                  qr.SQL.Text := cmdstr;
                  qr.Open;
                  ///////////将中.
                  with qr do
                  begin
                    hjks[i].TGroupState :=2;
                      while  not qr.Eof  do
                      begin
                          //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                          jrid:=fields.Fields[0].AsString;
                          kssxid:=fields.fields[1].asstring;
                          Brxm:=Fields.Fields[2].AsString;
                          GHHM:=fields.fields[3].asstring;
                          YXJID:=Fields.Fields[4].asString;
                          yxjmc:=fields.fields[5].asstring;
                          DDRs:=RecordCount-1;
                          brdm:=fields.fields[6].asstring;
                          by4:=fields.fields[7].asstring;
                          by6:=fields.fields[8].asstring;
                          by3:=fields.fields[9].asstring;
                          yksdm:=fields.fields[10].asstring;
                          //加入选择医生及排除医生的功能//
                          if not (yhcancall(jrid,zdyhid,ksbrdys)) then  //如果当前医生不能呼叫此病人，则取下一条数据//
                          begin
                            qr.Next;
                            continue;
                          end;
                          //呼叫成功
                          addyhcancall(jrid,zdyhid,'-1');   //插入排除医生信息
                          if cmd='82' then
                          begin
                             tmpghhm:=ghhm;
                             if length(tmpghhm)=0  then
                                tmpghhm:='0000'
                             else if length(tmpghhm)=1  then
                                tmpghhm:='000'+tmpghhm
                             else if length(tmpghhm)=2  then
                                tmpghhm:='00'+tmpghhm
                             else if length(tmpghhm)=3  then
                                tmpghhm:='0'+tmpghhm
                             else
                                tmpghhm:=RightStr(tmpghhm,4);
                             result:=zdid +cmd  +'01' + tmpghhm  ;
                          end
                          else if (cmd='32') or (cmd='67') then
                          begin
                             result:=zdid+cmd + getstrwithnotbadcode(hjks[i].TGroupName,8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                          end
                          else
                          begin
                            if yksdm<>'' then
                              result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+yksdm
                            else
                             result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid;
                          end;
                             //result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+hjks[i].TGroupid+','+by3;
                          //并将数据放入显示信息表中
                          //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                          gbledit_ks[gbledit_ks_count].ksid:=hjks[i].TGroupid; //hjksid[i];
                          gbledit_ks[gbledit_ks_count].ksmc:=hjks[i].TGroupName;  //hjksmc[i];
                          gbledit_ks_count:=gbledit_ks_count+1;
                          //修改其它病人的排队序号
                          doUpdateWaitlistPos(hjks[i].TGroupid ,jrid,zdyhid,fjh,gblhszh);
                          DB_SetHisPatientStatus(jrid);
                          doLockOtherGroupSamePat(jrid);
                          //添加显示信息
                          ///delete by wugang @2010-03-16
                          //将多个号的信息合到一条显示信息记录中.
                          //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                          ///delete end ///
                          ///add by wugang @2010-03-16
                          //将多个号的信息合到一条显示信息记录中.
                          strCallnos := strCallnos+ghhm+'|';
                          strCallnames := strCallnames+brxm+'|';
                          strby4 := strby4+by4+'|';
                          ///add end ///
                          iscall:=true;
                          yhjrs:=yhjrs+1;
                          if yhjrs=hjrs then
                          begin
                             //add by wugang @2010-03-16
                             //在呼叫人数到时将信息保存到显示信息表中.
                             WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                             ///add end///
                             //得到准备病人信息，并返回到结果中.
                             if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                             begin
                               prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                               result := result +','+prepareinfo;
                             end;
                             break;
                          end
                          else
                          begin
                             qr.Next;
                             //add by wugang @2010-03-16
                             //在呼叫人数到时将信息保存到显示信息表中.
                             if qr.Eof then
                             begin
                                WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,hjks[i].TGroupid,hjks[i].TGroupName,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                                //得到准备病人信息，并返回到结果中.
                               if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                               begin
                                  prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                                  result := result +','+prepareinfo;
                               end;
                             end;
                             ///add end ///
                          end;
                      end;
                      close;
                  end;//end with
                  if iscall then
                  begin
                     //修改此员工此呼叫科室的呼叫人数;
                     cmdstr := ' update t_yh_ks set CalledCount=CalledCount+'+inttostr(yhjrs)+
                              ' where yhid='''+ZDYHID+''''+
                              ' and ksid='+quotedstr(hjks[i].TGroupid)+
                              ' and hszh='+inttostr(gblhszh);
                     qr.SQL.Text := cmdstr;
                     try
                       qr.ExecSQL;
                       //calledcount[i]:= calledcount[i]+1;
                       hjks[i].TCalledCount := hjks[i].TCalledCount+yhjrs;
                     except
                     end;
                     break;
                  end;
                 end;
               end; //end for
             end;
             if iscall then
             begin
               clearCalledCount:=True;
               for i:=1 to hjksnum-1 do//查询是否要清除呼叫人数
               begin
                 //if  (calledcount[i]<callcount[i]) and (callcount[i]>0) then
                 cmdstr :=' update t_yh_ks set calledcount='+ IntToStr(hjks[i].TCalledCount)+
                      ' where yhid='+quotedstr(zdyhid)+
                      ' and ksid='+quotedstr(hjks[i].TGroupid)+
                      ' and hszh='+inttostr(gblHSZH);
                 qr.SQL.Text :=cmdstr;
                 try
                   qr.ExecSQL;
                 except
                 end;
                 if ((hjks[i].Tgroupstate=2) //已呼叫过
                  and (hjks[i].TCalledCount<hjks[i].TCallCount) //未达到呼叫人数
                  and (hjks[i].TCallCount>0))
                  or (hjks[i].Tgroupstate=-1) then
                 begin
                   clearCalledCount:=False;
                   Break;
                 end
                 else
                 begin
                   clearCalledCount:=true;
                 end;
               end;

               if clearCalledCount then//将员工的呼叫人数清0
               begin
                 cmdstr :=' update t_yh_ks set calledcount=0 '+
                      ' where yhid='''+zdyhid+''''+
                      ' and hszh='+inttostr(gblHSZH);
                 qr.SQL.Text :=cmdstr;
                 try
                   qr.ExecSQL;
                 except
                 end;
               end;
             end;
           end
           else if hjfs=2 then
           begin
               cmdstrks:='';
               for i:=1 to hjksnum-1 do
               begin
                  if length(cmdstrks)>0 then
                     cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
                  else
                     cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;

               end;
             if Length(cmdstrks)>0 then
                cmdstrks :='('+ cmdstrks+')';
              ksbrdys := dmdbaccess.GetDBValue('KS',hjks[1].TGroupid,'SelDoctor');
              if ksbrdys='' then ksbrdys:='0';
              if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
    //          if gblBRDYS=1 then
                 cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,ksid,by3,yksdm from  ' +
                         ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                         ' where (' +cmdstrks+')'+
                         ' and t_dhxx.jzbz=1' +
                         ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                         ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                         ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
    //                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                         strKeyStr +
                         ' order by t_dhxx.yxjid desc,by7,sjdbz,replicate(''0'',10-len(ghhm))+ghhm,kssxid '
              else
                 begin
                 cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,ksid,by3,yksdm from  ' +
                         ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                         ' where ('+cmdstrks+')'+
                         ' and t_dhxx.jzbz=1' +
                         ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                         ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
    //                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                         strKeyStr +
                         ' order by t_dhxx.yxjid desc,by7,sjdbz,replicate(''0'',10-len(ghhm))+ghhm,kssxid '
                 end   ;
              qr.SQL.Text := cmdstr;
              qr.Open;

              ///////////将中.
              with qr do
              begin
                 while not qr.Eof  do
                  begin
                      //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                      jrid:=fields.Fields[0].AsString;
                      kssxid:=fields.fields[1].asstring;
                      Brxm:=Fields.Fields[2].AsString;
                      GHHM:=fields.fields[3].asstring;
                      YXJID:=Fields.Fields[4].asString;
                      yxjmc:=fields.fields[5].asstring;
                      DDRs:=RecordCount-1;
                      brdm:=fields.fields[6].asstring;
                      by4:=fields.fields[7].asstring;
                      tmpksid:=fields.fields[8].asstring;
                      by3:=fields.fields[9].asstring;
                      yksdm:= fields.fields[10].asstring;
                      for i:=1 to hjksnum do
                      begin
                         if tmpksid=hjks[i].TGroupid then
                            tmpksmc:=hjks[i].TGroupName;//hjksmc[i];
                      end;
                      //加入选择医生及排除医生的功能//
                      if not (yhcancall(jrid,zdyhid,ksbrdys)) then  //如果当前医生不能呼叫此病人，则取下一条数据//
                      begin
                        qr.Next;
                        continue;
                      end;
                      //呼叫成功
                      addyhcancall(jrid,zdyhid,'-1');   //插入排除医生信息
                      if cmd='82' then
                      begin
                         tmpghhm:=ghhm;
                         if length(tmpghhm)=0  then
                            tmpghhm:='0000'
                         else if length(tmpghhm)=1  then
                            tmpghhm:='000'+tmpghhm
                         else if length(tmpghhm)=2  then
                            tmpghhm:='00'+tmpghhm
                         else if length(tmpghhm)=3  then
                            tmpghhm:='0'+tmpghhm
                         else
                            tmpghhm:=RightStr(tmpghhm,4);
                         result:=zdid +cmd  +'01' + tmpghhm  ;
                      end
                      else if (cmd='32') or (cmd='67') then
                      begin
                         result:=zdid+cmd + getstrwithnotbadcode(tmpksmc[i],8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                      end
                      else
                      begin
                        if yksdm<>'' then
                        result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+yksdm
                        else
                        result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+tmpksid;
                      end;
                         //result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+tmpksid+','+by3;
                      //并将数据放入显示信息表中
                      //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                      gbledit_ks[gbledit_ks_count].ksid:=tmpksid;
                      gbledit_ks[gbledit_ks_count].ksmc:=tmpksmc;
                      gbledit_ks_count:=gbledit_ks_count+1;

                      doUpdateWaitlistPos(tmpksid,jrid,zdyhid,fjh,gblhszh);
                      doLockOtherGroupSamePat(jrid);
                      ///delete by wugang @2010-03-16
                      //将多个号的信息合到一条显示信息记录中.
                      //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,'',DDRS,1);
                      ///delete end ///
                      ///add by wugang @2010-03-16
                      //将多个号的信息合到一条显示信息记录中.
                      strCallnos := strCallnos+ghhm+'|';
                      strCallnames := strCallnames+brxm+'|';
                      strby4:=strby4+by4+'|';
                      ///add end ///
                      iscall:=true;
                      yhjrs:=yhjrs+1;
                      if yhjrs=hjrs then
                      begin
                         //add by wugang @2010-03-16
                         //在呼叫人数到时将信息保存到显示信息表中.
                         WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                         ///add end///
                         //得到准备病人信息，并返回到结果中.
                         if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                         begin
                           prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                           result := result +','+prepareinfo;
                         end;
                         break;
                      end
                      else
                      begin
                         qr.Next;
                         //add by wugang @2010-03-16
                         //在呼叫人数到时将信息保存到显示信息表中.
                         if qr.Eof then
                         begin
                            WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                             //得到准备病人信息，并返回到结果中.
                             if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                             begin
                               prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                               result := result +','+prepareinfo;
                             end;
                         end;
                         ///add end ///
                      end;
                  end;
                  close;
                end;
           end
           else if hjfs=3 then
           begin
               cmdstrks:='';
               for i:=1 to hjksnum-1 do
               begin
                  if length(cmdstrks)>0 then
                     cmdstrks:=cmdstrks + ' or t_dhxx.ksid=''' + hjks[i].TGroupid +''''
                  else
                     cmdstrks:=cmdstrks+' t_dhxx.ksid=''' + hjks[i].TGroupid +'''' ;
               end;

              ksbrdys := dmdbaccess.GetDBValue('KS',hjks[1].TGroupid,'SelDoctor');
              if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
              //if gblBRDYS=1 then
                 cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,ksid,by3,yksdm from  ' +
                         ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                         ' where (' +cmdstrks+')'+
                         ' and t_dhxx.jzbz=1' +
                         ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
                         ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                         ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
    //                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                         strKeyStr +
                         ' order by t_dhxx.yxjid desc,by7,sjdbz,ghsj,kssxid '
              else
                 begin
                 cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,brdm,by4,ksid,by3,yksdm from  ' +
                         ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                         ' where ('+cmdstrks+')'+
                         ' and t_dhxx.jzbz=1' +
                         ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                         ' and ((t_dhxx.yxjid=1 and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblzhhjyssj)+')'+
                               ' or (t_dhxx.yxjid<>1 and  datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+'))'+
    //                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
                         strKeyStr +
                         ' order by t_dhxx.yxjid desc,by7,sjdbz,ghsj,kssxid '
                 end   ;
              qr.SQL.Text := cmdstr;
              qr.Open;
              ///////////将中.
              with qr do
              begin
                 while not qr.Eof  do
                  begin
                      //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                      jrid:=fields.Fields[0].AsString;
                      kssxid:=fields.fields[1].asstring;
                      Brxm:=Fields.Fields[2].AsString;
                      GHHM:=fields.fields[3].asstring;
                      YXJID:=Fields.Fields[4].asString;
                      yxjmc:=fields.fields[5].asstring;
                      DDRs:=RecordCount-1;
                      brdm:=fields.fields[6].asstring;
                      by4:=fields.fields[7].asstring;
                      tmpksid:=fields.fields[8].asstring;
                      by3:=fields.fields[9].asstring;
                      yksdm:=fields.fields[10].asstring;
                      for i:=1 to hjksnum do
                      begin
                         if tmpksid=hjks[i].TGroupid then
                            tmpksmc:=hjks[i].TGroupName;
                      end;
                      //加入选择医生及排除医生的功能//
                      if not (yhcancall(jrid,zdyhid,ksbrdys)) then  //如果当前医生不能呼叫此病人，则取下一条数据//
                      begin
                        qr.Next;
                        continue;
                      end;
                      //呼叫成功
                      addyhcancall(jrid,zdyhid,'-1');   //插入排除医生信息
                      if cmd='82' then
                      begin
                         tmpghhm:=ghhm;
                         if length(tmpghhm)=0  then
                            tmpghhm:='0000'
                         else if length(tmpghhm)=1  then
                            tmpghhm:='000'+tmpghhm
                         else if length(tmpghhm)=2  then
                            tmpghhm:='00'+tmpghhm
                         else if length(tmpghhm)=3  then
                            tmpghhm:='0'+tmpghhm
                         else
                            tmpghhm:=RightStr(tmpghhm,4);
                         result:=zdid +cmd  +'01' + tmpghhm  ;
                      end
                      else if (cmd='32') or (cmd='67') then
                      begin
                         result:=zdid+cmd + getstrwithnotbadcode(tmpksmc[i],8)+'人数'+getstrwithnotbadcode(inttostr(DDRS),3)+getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5);
                      end
                      else
                      begin
                        if yksdm<>'' then
                          result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+yksdm
                        else
                          result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+tmpksid;
                      end;
                         //result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','+brdm+','+by4+','+tmpksid+','+by3;
                      //并将数据放入显示信息表中
                      //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
                      gbledit_ks[gbledit_ks_count].ksid:=tmpksid;
                      gbledit_ks[gbledit_ks_count].ksmc:=tmpksmc;
                      gbledit_ks_count:=gbledit_ks_count+1;

                      doUpdateWaitlistPos(tmpksid,jrid,zdyhid,fjh,gblhszh);

                      DB_SetHisPatientStatus(jrid);
                      doLockOtherGroupSamePat(jrid);
                      //添加显示信息
                      ///delete by wugang @2010-03-16
                      //将多个号的信息合到一条显示信息记录中.
                      //WriteDispMsgTT(zdid,fjh,fjmc,zth,ztmc,hjksid[i],hjksmc[i],GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1);
                      ///delete end ///
                      ///add by wugang @2010-03-16
                      //将多个号的信息合到一条显示信息记录中.
                      strCallnos := strCallnos+ghhm+'|';
                      strCallnames := strCallnames+brxm+'|';
                      strby4 := strby4+by4+'|';
                      ///add end ///
                      iscall:=true;
                      yhjrs:=yhjrs+1;
                      if yhjrs=hjrs then
                      begin
                         //add by wugang @2010-03-16
                         //在呼叫人数到时将信息保存到显示信息表中.
                         WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                         ///add end///
                         //得到准备病人信息，并返回到结果中.
                         if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                         begin
                           prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                           result := result +','+prepareinfo;
                         end;
                         break;
                      end
                      else
                      begin
                         qr.Next;
                         //add by wugang @2010-03-16
                         //在呼叫人数到时将信息保存到显示信息表中.
                         if qr.Eof then
                         begin
                            WriteDispMsg(zdid,fjh,fjmc,zth,ztmc,tmpksid,tmpksmc,GHHM,BRxm,ZDYHID,ZDYHMC,YXJID,YXJMC,by6,DDRS,1,strCallnos,strCallnames,strby4);
                             //得到准备病人信息，并返回到结果中.
                             if (cmd<>'82') and (cmd<>'32') and (cmd<>'67') then
                             begin
                               prepareinfo := GetPrepareInfo(gblhszh,hjks[i].TGroupid,zdyhid);
                               result := result +','+prepareinfo;
                             end;
                         end;
                         ///add end ///
                      end;
                  end;
                  close;
                end;
           end;
           qr.Close;
           Freeandnil(qr);
         end;
      end;

      if iscall=false  then //没有成功呼叫到病人//
      begin
        //写入此时此呼叫器空闲
        // add by wugang @2010-07-20
        //修改呼叫终端状态
        try
          adoconnection.Execute('update t_hjzd set state=''空闲'''+
            ',calltime=getdate()'+
            ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
        except
          adoconnection.Execute('update t_hjzd set state=''空闲'''+
            ',calltime=getdate()'+
            ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
        end;
        /////////////////////////
        ///////add end////////
        if (cmd='32') or (cmd='67') then
        result:=zdid +cmd  +'等待人数:0     '+''
        else
        result:=zdid +cmd  +'000000'  ;
      end;
    except
      begin
        if (cmd='32') or (cmd='67') then
              result:=zdid +cmd  +'呼叫失败!      '+'呼叫时有错误!'
        else
        result := zdid + cmd + '068888';  ///有错误发生.
        Exit;
      end;
    end;
  finally
    freeandnil(qr1);
  end;
end;

function TdmDBAccess.UpdateHJZDDiscon(const Aip: string;
  const Aport: Integer): Boolean;
var
  qr:TADOQuery;
  zdid:string;
begin
  Result := True;
  if gblstaylogin=1 then   //如果连接断开时要保留登录状态
  begin
    exit;
  end
  else
  begin
    qr := TADOQuery.Create(nil);
    try
      qr.Connection := ADOConnection;
      qr.SQL.Text :=' select zdid from t_hjzd where ip='+quotedstr(Aip)+
        ' and port='+inttostr(Aport)+' and hszh='+inttostr(gblhszh)+
        ' and (yhid<>'''' and yhid is not null)';
      qr.Open;
      if not qr.Eof then //如果原来有用户登录着,则修改用户登录情况.
      begin
        //
        zdid := format('%2d',[qr.fieldbyname('zdid').AsInteger]);
        dmDBAccess.YHLogOut(zdid,'DE');
      end;
      qr.Close;
    finally
      FreeAndNil(qr);
    end;
  end;
end;
function TdmDBAccess.UpdateGroupHided(): Boolean;
var
  qr:TADOQuery;
  zdid:string;
begin
  Result := True;
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr.SQL.Text :='update t_ks set hided=0 '+
      ' where kfbz=0 and hszh='+inttostr(gblhszh);
    qr.ExecSQL;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.CheckLockIP(const Azdid, Aip: string): Boolean;
var
  qr:TADOQuery;
begin
  Result := False;
  if Aip='' then
    Result := true
  else
  begin
    qr := TADOQuery.Create(nil);
    try
      qr.Connection := ADOConnection;
      qr.SQL.Text :='select 1 from t_hjzd where lockip='+quotedstr(Aip)+
        ' and not (zdid='+azdid+' and hszh='+inttostr(gblHSZH)+')';
      qr.Open;
      if qr.Eof then
        Result := True
      else
        Result := False;
    finally
      FreeAndNil(qr);
    end;
  end;
end;
{*******************************************************************************
*函数名:YHYXJCall;
                                           *
*函数机能:设置优先级.                                          *
*******************************************************************************}

function TdmDBAccess.YHYXJCall(const zdid:string;const cmd:string;const CallNO :string):string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   tmpadoquery:Tadoquery;
   by6:string;
   ksbrdys:string;
   strCallNo,stryxjid:string;
   ps : integer;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection :=ADOConnection;
  try
    stryxjid := '';
    ps := FoundChar(',',CallNO);
    if ps>0 then
    begin
      strCallNo := Copy(CallNO,1,ps-1);
      stryxjid :=Copy(CallNO,ps+1,Length(CallNO)-ps);
    end
    else
      strCallNo := CallNO;
    //gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    qr.Close;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             if (cmd='40') or (cmd='57') then
              result:=zdid +cmd  +'还没有登录!    '+'请登录工号    '
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
       end
       else
       begin
           if (cmd='40') or (cmd='57') then
            result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置  '
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             if (cmd='40') or (cmd='57') then
              result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置! '
             else
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           if (cmd='40') or (cmd='57') then
            result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置  '
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    //修改呼叫终端状态
     adoconnection.Execute('update t_hjzd set state=''选呼'''+
        ',calltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);

    ////查找此科室的病人.
    if hjksnum>0 then
    begin
       for i:=1 to hjksnum do
       begin
//          cmdstr:=cmdstr+' t_dhxx.ksid=''' + hjksid[i] +'''' ;
//          if Length(strCallKsid)>0 then
//          begin
//            if strCallKsid<>hjksid[i] then
//             Continue;
//          end;
          ////////根据是不否使用选医生功能.
          if iscall then
              break;
          ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
          if ksbrdys='' then ksbrdys:='0';
          if (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
          //if gblBRDYS=1 then
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.ghhm=''' + trim(strCallNo) + ''''+
               ' and (yhid='''' or yhid is null or yhid =''' + zdyhid +''')'+
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
               ' order by t_dhxx.kssxid ';
          end
          else
          begin
            cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,ksid,jzbz,brdm,by4,by6 from  ' +
               ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
               ' where ksid=''' + hjks[i].TGroupid +''''+
               ' and t_dhxx.hszh=' +inttostr(gblhszh) +
               ' and t_dhxx.ghhm=''' + trim(strCallNo) + ''''+
               ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj)+
               ' order by t_dhxx.kssxid ';
          end;
          ////////////
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                GHHM:=fields.fields[3].asstring;
                YXJID:=Fields.Fields[4].asString;
                yxjmc:=fields.fields[5].asstring;
                JZBZ:=fields.fields[7].asstring;
                brdm:=fields.fields[8].asstring;
                by4:=fields.fields[9].asstring;
                by6:=fields.fields[10].asstring;
                if jzbz='0' then
                   DDRs:=DDRs
                else
                   DDRs:=DDrs-1;
                if (cmd='90') or (cmd='93') then
                begin
                  retstr:=ghhm;
                  if length(retstr)=0 then
                     retstr:='0000'
                  else if length(retstr)=1 then
                     retstr:='000'+retstr
                  else if length(retstr)=2 then
                     retstr:='00'+retstr
                  else if length(retstr)=3 then
                     retstr:='0'+retstr
                  else
                     retstr:=RightStr(retstr,4);
                   result:=zdid +cmd  +'01' + retstr;
                end
                else if (cmd='40') or (cmd='57') then
                  result:=zdid +cmd  +getstrwithnotbadcode(hjks[i].TGroupName,8)+'人数'+ getstrwithnotbadcode(inttostr(DDRS),3)+
                          getstrwithnotbadcode(brxm,8)+'  '+getstrwithnotbadcode(ghhm,5)
                 else
                   result:=zdid +cmd  +'01' + GHHM +',' +BRXM + ',' + inttostr(DDRS)+','
                    +brdm+','+by4+','+hjks[i].TGroupid;

                 //修改T_dhxx中的数据，将本条数据改为就诊
                cmdstr:=' UPDATE t_dhxx '+
                        ' SET yxjid='+stryxjid+
                        ' where id=' + jrid ;
                adoconnection.Execute(cmdstr ,cmdText);
                iscall:=true;
            end;
            close;
          end;

       end;
       if iscall=false  then
          begin
           if (cmd='40') or (cmd='57') then
            result:=zdid +cmd  +'选呼没有成功!  '+'未找到此号码! '
           else
            result:=zdid +cmd  +'000000'  ;
          end;
    end;
  except
    begin
       if (cmd='40') or (cmd='57') then
        result:=zdid +cmd  +'优先没有成功!  '+'操作时有错误! '
       else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;

function TdmDBAccess.GetYHCallKS(const Ayhid: string;
  var CallKsCount: Integer;
  var CallGroups: array of CallGroup_Info): Boolean;
var
  qr:TADOQuery;
  i:integer;

begin
  Result := False;
  qr := TADOQuery.Create(nil);
  try
    try
    qr.Connection := ADOConnection;
    qr.SQL.Text := 'select yk.ksid,k.ksmc,yk.zcgh,yk.prepare,yk.callcount,yk.calledcount from t_yh_ks yk,t_ks k'+
      ' where yk.ksid=k.ksid and yk.hszh=k.hszh'+
      ' and yk.yhid='+quotedstr(Ayhid)+
      ' and yk.hszh='+inttostr(gblHSZH)+
      ' order by seq';
    qr.Open;
    if qr.Eof then
    begin
      CallKsCount := 0;
      Result := True;
    end
    else
    begin
      CallKsCount :=qr.RecordCount;
      if CallKsCount>High(CallGroups) then CallKsCount := High(CallGroups);
      //SetLength(CallGroups1,CallKsCount+1);
      i:=0;
      while not qr.Eof do
      begin
        if i>High(CallGroups) then Break;
        CallGroups[i].TGroupid := qr.fieldbyname('ksid').AsString;
        CallGroups[i].TGroupName := qr.fieldbyname('ksmc').AsString;
        CallGroups[i].TReg := qr.fieldbyname('ZCGH').AsInteger;
        CallGroups[i].TPrepare := qr.fieldbyname('Prepare').AsInteger;
        CallGroups[i].TCallCount := qr.fieldbyname('CallCount').AsInteger;
        CallGroups[i].TCalledCount := qr.fieldbyname('CalledCount').AsInteger;
        CallGroups[i].TGroupState :=-1;
        qr.Next;
        i:=i+1;
      end;
      Result := True;
    end;
    qr.Close;
    except
      CallKsCount :=0;
      Result := False;
    end;
  finally
    FreeAndNil(qr);
  end;


end;
{函数名:GetYHPBCallKS
功能：得到某员工星期几的排班呼叫科室
参数:ayhid 员工代码
axq 星期几(1~7)
callkscount 得到的呼叫科室数量
callgroups 得到的呼叫科室信息数组
返回值
true 成功
false 失败
}
function TdmDBAccess.GetYHPBCallKS(const Ayhid: string;
  const AXQ:string;
  var CallKsCount: Integer;
  var CallGroups: array of CallGroup_Info): Boolean;
var
  qr:TADOQuery;
  i:integer;

begin
  Result := False;
  qr := TADOQuery.Create(nil);
  try
    try
    qr.Connection := ADOConnection;
    qr.SQL.Text := 'select yk.ksid,k.ksmc,yk.zcgh,yk.prepare,yk.callcount from t_pb_ks yk,t_ks k'+
      ' where yk.ksid=k.ksid and yk.hszh=k.hszh'+
      ' and yk.yhid='+quotedstr(Ayhid)+
      ' and yk.hszh='+inttostr(gblHSZH)+
      ' and yk.xq='+axq+
      ' order by seq';
    qr.Open;
    if qr.Eof then
    begin
      CallKsCount := 0;
      Result := True;
    end
    else
    begin
      CallKsCount :=qr.RecordCount;
      if CallKsCount>High(CallGroups) then CallKsCount := High(CallGroups);
      //SetLength(CallGroups1,CallKsCount+1);
      i:=0;
      while not qr.Eof do
      begin
        if i>High(CallGroups) then Break;
        CallGroups[i].TGroupid := qr.fieldbyname('ksid').AsString;
        CallGroups[i].TGroupName := qr.fieldbyname('ksmc').AsString;
        CallGroups[i].TReg := qr.fieldbyname('ZCGH').AsInteger;
        CallGroups[i].TPrepare := qr.fieldbyname('Prepare').AsInteger;
        CallGroups[i].TCallCount := qr.fieldbyname('CallCount').AsInteger;
        CallGroups[i].TCalledCount := 0;//qr.fieldbyname('CalledCount').AsInteger;
        CallGroups[i].TGroupState :=-1;
        qr.Next;
        i:=i+1;
      end;
      Result := True;
    end;
    qr.Close;
    except
      CallKsCount :=0;
      Result := False;
    end;
  finally
    FreeAndNil(qr);
  end;


end;
function TdmDBAccess.CheckFuncCode(const Azdid:string;const ARequst:string): string;
var
  blFound:boolean;
  s:string;
  l,i:integer;
begin
  //查看上次是否是功能键
  Result := ARequst;
  blFound:= false;
  for i:=Low(CallShifts) to High(CallShifts) do
  begin
    if CallShifts[i].TCallID = Azdid then
    begin
      blFound:= true;
      if CallShifts[i].TIsShift then
      begin
        CallShifts[i].TIsShift:= False;
        if ARequst='90' then
          Result :='93'
        else if ARequst='40' then
          Result :='43'
        else if ARequst='71' then
          Result :='93'
        else if ARequst='FF' then //如果是FF，则改为请评价功能
          Result :='94';
        Break;
      end
      else
      begin
        if ARequst='FF' then
        begin
          CallShifts[i].TIsShift:= True;
        end;
      end;
    end;
  end;
  if not blFound then
  begin
    l:=High(CallShifts)-Low(CallShifts)+1;
    SetLength(CallShifts,l+1);
    CallShifts[l].TCallID := Azdid;
    CallShifts[l].TIsShift := True;
  end;
end;
function TdmDBAccess.SendUdps: Boolean;
var
  i:integer;
begin
  try
    try
    for i :=0 to udpcounts-1 do
    begin
      if Length(Trim(udpiplist[i]))>0 then
         frmmain.IdUDPServer1.Send(udpiplist[i],udpport,'jhxx');
    end;
    except
    end;
  finally
    Result := True;
  end;
end;
function TdmDBAccess.ChangeUserGroup(const auser,
  newgroup: string): Boolean;
var
tmpquery:Tadoquery;
groups:array of string;
updatestr:string;
i,gpcount:Integer;
begin
  Result := False;
  tmpquery := TADOQuery.Create(nil);
  try
    tmpquery.Connection := ADOConnection;
    tmpquery.SQL.Text :='select * from t_yh_ks '+
      ' where hszh=:p1'+
      ' and yhid=:p2'+
      ' order by seq';
    tmpquery.Parameters.ParamByName('p1').Value := gblHSZH;
    tmpquery.Parameters.ParamByName('p2').Value := auser;
    tmpquery.Open;
    gpcount:=tmpquery.RecordCount;
    SetLength(groups,gpcount);
    i:=0;
    while not tmpquery.Eof do
    begin
      groups[i]:=tmpquery.fieldbyname('ksid').AsString;
      i:=i+1;
      tmpquery.Next;
    end;
    tmpquery.Close;
    if gpcount>0 then
    begin
      if (groups[0]=newgroup) then
      begin
        Result := True;
        exit;
      end;
      tmpquery.SQL.Clear;
      tmpquery.Parameters.Clear;
      if (groups[0]='') or (groups[0]='0') then
      begin
        //修改ksid1=newgroup;
        updatestr := 'update t_yh_ks set ksid=:v1'+
          ' where hszh=:p1'+
          ' and yhid=:p2'+
          ' and seq=1';
        tmpquery.SQL.Text :=updatestr;
        tmpquery.Parameters.ParamByName('p1').Value := gblHSZH;
        tmpquery.Parameters.ParamByName('p2').Value := auser;
        tmpquery.Parameters.ParamByName('v1').Value := newgroup;
        try
          tmpquery.ExecSQL;
        except
        end;
        Result := true;
        Exit;
      end
      else
      begin
        for i:=1 to gpcount-1 do
        begin
          if (groups[i]=newgroup) or (groups[i]='') or (groups[i]='0') then
          begin
            //修改原来的
            //修改ksid1=newgroup;
            updatestr := 'update t_yh_ks set ksid=:v1'+
              ' where hszh=:p1'+
              ' and yhid=:p2'+
              ' and seq=:p3';
            tmpquery.SQL.Text :=updatestr;
            tmpquery.Parameters.ParamByName('p1').Value := gblHSZH;
            tmpquery.Parameters.ParamByName('p2').Value := auser;
            tmpquery.Parameters.ParamByName('p3').Value := i+1;
            tmpquery.Parameters.ParamByName('v1').Value := groups[0];
            try
              tmpquery.ExecSQL;
            except
            end;
            updatestr := 'update t_yh_ks set ksid=:v1'+
              ' where hszh=:p1'+
              ' and yhid=:p2'+
              ' and seq=:p3';
            tmpquery.SQL.Text :=updatestr;
            tmpquery.Parameters.ParamByName('p1').Value := gblHSZH;
            tmpquery.Parameters.ParamByName('p2').Value := auser;
            tmpquery.Parameters.ParamByName('p3').Value := 1;
            tmpquery.Parameters.ParamByName('v1').Value := newgroup;
            try
              tmpquery.ExecSQL;
            except
            end;
            Result := True;
            Exit;
          end;
        end;
        //修改ksid1=newgroup;
        updatestr := 'update t_yh_ks set ksid=:v1'+
          ' where hszh=:p1'+
          ' and yhid=:p2'+
          ' and seq=:p3';
        tmpquery.SQL.Text :=updatestr;
        tmpquery.Parameters.ParamByName('p1').Value := gblHSZH;
        tmpquery.Parameters.ParamByName('p2').Value := auser;
        tmpquery.Parameters.ParamByName('p3').Value := 1;
        tmpquery.Parameters.ParamByName('v1').Value := newgroup;
        try
          tmpquery.ExecSQL;
        except
        end;
        Result := True;
      end;
    end
    else
    begin
      Result := False;
    end;
  finally
    FreeAndNil(tmpquery);
  end;
end;
function TdmDBAccess.getMaxSeqStr(jrid, tmpghhm, tmpby7,
  YXJID: string): string;
var
tmpquery:Tadoquery;
begin
  Result := '';
  tmpquery := TADOQuery.Create(nil);
  try
    tmpquery.Connection := ADOConnection;
    if YXJID='88' then
    begin

      //判断有没有和当前号是同一预约时段并且号码比这个号大的
      tmpquery.SQL.Text :='select count(*) as cnt from t_dhxx'+
          ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
          ' and yxjid=''' + yxjID + ''''+
          ' and jzbz<>''0''' +
          ' and hszh=' + inttostr(gblhszh)+
          ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
          ' and by7='+quotedstr(tmpby7)+
          ' and replicate(''0'',10-len(ghhm))+ghhm>replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
          ' and id<>'+jrid;
      tmpquery.Open;
      if tmpquery.FieldByName('cnt').AsInteger>0 then
      begin
        tmpquery.Close;
        Result:=' select  Min(KSSXID) as Min_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
            ' and yxjid=''' + yxjID + ''''+
            ' and jzbz<>''0''' +
            ' and hszh=' + inttostr(gblhszh)+
            ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
            ' and replicate(''0'',10-len(ghhm))+ghhm>replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
            ' and by7='+quotedstr(tmpby7)+
            ' and id<>'+jrid;
      end
      else
      begin
        tmpquery.Close;
        Result:=' select  Min(KSSXID) as Min_SXID  from  ' +
          ' t_dhxx ' +
          ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
          ' and yxjid=''' + yxjID + ''''+
          ' and jzbz<>''0''' +
          ' and hszh=' + inttostr(gblhszh)+
          ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
          ' and by7>'+quotedstr(tmpby7)+
          ' and id<>'+jrid;
      end;
    end
    else if YXJID='18' then
    begin
      Result:=' select  Min(KSSXID) as Min_SXID  from  ' +
        ' t_dhxx ' +
        ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
        ' and (yxjid=0 or yxjid=18)'+
        ' and jzbz<>''0''' +
        ' and hszh=' + inttostr(gblhszh)+
        ' and ghsj>=(select ghsj from t_dhxx where id='+jrid+')'+
        ' and id<>'+jrid;
    end
    else
    begin
      Result:=' select  Min(KSSXID) as Min_SXID  from  ' +
        ' t_dhxx ' +
        ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
        ' and yxjid=''' + yxjID + ''''+
        ' and jzbz<>''0''' +
        ' and hszh=' + inttostr(gblhszh)+
        ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
        ' and replicate(''0'',10-len(ghhm))+ghhm>replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
        ' and id<>'+jrid;
    end;
  finally
    FreeAndNil(tmpquery);
  end;
end;
function TdmDBAccess.getMinSeqStr(jrid, tmpghhm, tmpby7,
  YXJID: string): string;
var
tmpquery:Tadoquery;
begin
  Result := '';
  tmpquery := TADOQuery.Create(nil);
  try
    tmpquery.Connection := ADOConnection;
    if YXJID='88' then
    begin
      //判断有没有和当前号是同一预约时段并且号码比这个号大的
      tmpquery.SQL.Text :='select count(*) as cnt from t_dhxx'+
          ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
          ' and yxjid=''' + yxjID + ''''+
          ' and jzbz<>''0''' +
          ' and hszh=' + inttostr(gblhszh)+
          ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
          ' and by7='+quotedstr(tmpby7)+
          ' and replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
          ' and id<>'+jrid;
      tmpquery.Open;
      if tmpquery.FieldByName('cnt').AsInteger>0 then
      begin
        tmpquery.Close;
        Result:=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
            ' and yxjid=''' + yxjID + ''''+
            ' and jzbz<>''0''' +
            ' and hszh=' + inttostr(gblhszh)+
            ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
            ' and by7='+quotedstr(tmpby7)+
            ' and replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
            ' and id<>'+jrid;
      end
      else
      begin
        tmpquery.Close;
        Result:=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
            ' and yxjid=''' + yxjID + ''''+
            ' and jzbz<>''0''' +
            ' and hszh=' + inttostr(gblhszh)+
            ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
            ' and by7<'+quotedstr(tmpby7)+
            ' and id<>'+jrid;
      end;
    end
    else if YXJID='18' then
    begin
      Result:=' select  Max(KSSXID) as MAX_SXID  from  ' +
          ' t_dhxx ' +
          ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
          ' and (yxjid=0 or yxjid=18)'+
          ' and jzbz<>''0''' +
          ' and hszh=' + inttostr(gblhszh)+
          ' and ghsj<(select ghsj from t_dhxx where id='+jrid+')'+
          ' and id<>'+jrid;
    end
    else
    begin
      Result:=' select  Max(KSSXID) as MAX_SXID  from  ' +
          ' t_dhxx ' +
          ' where ksid=(select ksid from t_dhxx where id='+jrid+')'+
          ' and yxjid=''' + yxjID + ''''+
          ' and jzbz<>''0''' +
          ' and hszh=' + inttostr(gblhszh)+
          ' and kssxid<(select kssxid from t_dhxx where id='+jrid+')'+
          ' and replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
          ' and id<>'+jrid;
    end;
  finally
    FreeAndNil(tmpquery);
  end;
end;
function TdmDBAccess.CreateAView(const vname, vSql: string): Boolean;
var
tmpquery:Tadoquery;
begin
  Result := False;
  tmpquery := TADOQuery.Create(nil);
  try
    tmpquery.Connection := ADOConnection;
    tmpquery.SQL.Text :=' select 1 from sysobjects where name=:p1  and xtype=''V''';
    tmpquery.Parameters.ParamByName('p1').Value := vname;
    tmpquery.Open;
    if tmpquery.Eof then  //没有视图
    begin
      tmpquery.Close;
      tmpquery.SQL.Clear;
      tmpquery.Parameters.Clear;
      tmpquery.SQL.Text :=' create view ['+vname+']'+' as '+
        vSql;
      try
        tmpquery.ExecSQL;
        Result := True;
      except
        Result := False;
        addlog('errorlog.txt','建立视图错误:'+' create view ['+vname+']'+' as '+vSql);
      end;
    end
    else
      Result := True;
  finally
    FreeAndNil(tmpquery);
  end;
end;

function TdmDBAccess.DeleteAView(const vname: string): Boolean;
var
tmpquery:Tadoquery;
begin
  Result := False;
  tmpquery := TADOQuery.Create(nil);
  try
    tmpquery.Connection := ADOConnection;
    tmpquery.SQL.Text :=' select 1 from sysobjects where name=:p1  and xtype=''V''';
    tmpquery.Parameters.ParamByName('p1').Value := vname;
    tmpquery.Open;
    if not tmpquery.Eof then  //没有视图
    begin
      tmpquery.Close;
      tmpquery.SQL.Clear;
      tmpquery.Parameters.Clear;
      tmpquery.SQL.Text :=' drop view ['+vname+']';
      try
        tmpquery.ExecSQL;
        Result := True;
      except
        Result := False;
        addlog('errorlog.txt','删除视图错误:'+' drop view ['+vname+']');
      end;
    end
    else
      Result := True;
  finally
    FreeAndNil(tmpquery);
  end;
end;

function TdmDBAccess.SZPtYx(const JRID, YXJID: string): Integer;
var
  qr:TADOQuery;
  slKssxid:integer;
  tmpghhm:string;
  tmpyxjgws:integer;
  tmpby7:string;
  ydfsmc:string;
  ydfs,ydws:integer;
  ksid:string;
  y:Integer;
  tmphszh:Integer;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr.SQL.Clear;
    qr.Parameters.Clear;
    qr.Sql.Text:='select ghhm,by7,kssxid,ksid,hszh from t_dhxx where id=:p1';
    qr.Parameters.ParamByName('p1').Value := jrid;
    qr.open;
    if not qr.eof then
    begin
       ksid := qr.fieldbyname('ksid').AsString;
       slKssxid := qr.fieldbyname('kssxid').AsInteger;
       tmpghhm:=qr.fieldbyname('ghhm').asstring;
       tmpby7 :=qr.fieldbyname('by7').asstring;
       tmphszh := qr.fieldbyname('hszh').AsInteger;
    end;
    qr.Close;
    //得到优先的方式及位数   ->x
    qr.SQL.Clear;
    qr.Parameters.Clear;
    qr.SQL.Text:='select ydfs,ydws from t_yxjsz where ' +
                            ' yxjid=:p1 ' +
                            ' and hszh=:p2 ';
    qr.Parameters.ParamByName('p1').Value := YXJID;
    qr.Parameters.ParamByName('p2').Value := gblhszh;
    qr.Open;
    ydfsmc:='置前';
    ydws:=0;
    if not qr.Eof then
    begin
      ydfsmc:=qr.Fields.Fields[0].AsString;
      ydws:=qr.Fields.Fields[1].AsInteger;
    end;
    //得到同一队列同一优先级病人的最大kssxid;
    y:=GetYXBRMaxKssxid(ksid,yxjid,JRID);
    //算出优先位置           ->x
    if ydfsmc='置前' then
    begin
      if (y>0) and (ydws>0) then
        ydws := y+gblYXJGWS
      else
        ydws := slKssxid-ydws
    end
    else if ydfsmc='移动到' then
    begin
      if (y>0)  then
        ydws := y+gblYXJGWS
      else
        ydws :=ydws
    end
    else
    begin
      if (y>0) then
        ydws := y+gblYXJGWS
      else
        ydws := slKssxid-ydws
    end;
    if ydws<1 then ydws :=1;
    //查询准备病人最大位置y,并判断 x<=y ,则x=y+1;
    y :=GetZBBRMaxKSSXID(ksid,jrid,tmphszh);
    if (y>0) and (ydws<=y) then ydws := y+1;
    //查询已发短信病人的最大位置y,并判断  x<=y ,则x=y+1;
    y :=GetSendSmsMaxKSSXID(ksid,jrid,tmphszh);
    if (y>0) and (ydws<=y) then ydws := y+1;
    //查询预约病人的最大位置y,并判断  x<=y ,则x=y+1;
    y :=GetYYBRMaxKSSXID(ksid,'',jrid,IntToStr(sjdbz),tmphszh);
    if (y>0) and (ydws<=y) then ydws := y+1;
    //返回x
    if ydws>slKssxid then ydws:=slkssxid;
    Result := ydws;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.SZYyYx(const JRID, YXJID: string): Integer;
var
  qr:TADOQuery;
  slKssxid:integer;
  tmpghhm:string;
  tmpyxjgws:integer;
  tmpby7:string;
  ydfsmc:string;
  ydfs,ydws:integer;
  ksid:string;
  y:Integer;
  tmphszh:Integer;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr.SQL.Clear;
    qr.Parameters.Clear;
    qr.Sql.Text:='select ghhm,by7,kssxid,ksid,hszh from t_dhxx where id=:p1';
    qr.Parameters.ParamByName('p1').Value := jrid;
    qr.open;
    if not qr.eof then
    begin
       ksid := qr.fieldbyname('ksid').AsString;
       slKssxid := qr.fieldbyname('kssxid').AsInteger;
       tmpghhm:=qr.fieldbyname('ghhm').asstring;
       tmpby7 :=qr.fieldbyname('by7').asstring;
       tmphszh :=qr.fieldbyname('hszh').AsInteger;
    end;
    qr.Close;
    //得到优先的方式及位数   ->x=1
     ydws :=1;
    //加上间隔位数           ->x
    //ydws := ydws+ gblYXJGWS;
    //查询准备病人最大位置y,并判断 x<=y ,则x=y+1;
    y :=GetZBBRMaxKSSXID(ksid,jrid,tmphszh);
    if (y>0) and (ydws<=y) then ydws := y+1;
    //查询已发短信病人的最大位置y,并判断  x<=y ,则x=y+1;
    y :=GetSendSmsMaxKSSXID(ksid,jrid,tmphszh);
    if (y>0) and (ydws<=y) then ydws := y+1;
    //查询预约时间段在此时间之前的预约病人的最大位置y,并判断  x<=y ,则x=y+1;
    y :=GetYYBRMaxKSSXID(ksid,tmpby7,jrid,IntToStr(sjdbz),tmphszh);
    if (y>0) and (ydws<=y) then ydws := y+1;
    //如果得得出的ydws比原来的位置之后，则使用原来的位置。
    if slKssxid<ydws then ydws:=slkssxid;
    //返回x
    Result := ydws;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.GetSendSmsMaxKSSXID(const ksid,
  jrid: string;ahszh:Integer): Integer;
var
  qr:TADOQuery;
begin
  Result :=0;
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  try
    if jrid='0' then
    begin
      qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=:p1'+
            ' and (yxjid=78) '+
            ' and jzbz<>''0''' +
            ' and hszh=:p3';
      qr.Parameters.ParamByName('p1').Value := ksid;
      qr.Parameters.ParamByName('p3').Value := ahszh;
    end
    else
    begin
    qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
          ' t_dhxx ' +
          ' where ksid=(select ksid from t_dhxx where id=:p1)'+
          ' and (yxjid=78) '+
          ' and jzbz<>''0''' +
          ' and hszh=:p3' +
          //' and kssxid<(select kssxid from t_dhxx where id=:p4)'+
          ' and id<>:p5';
    qr.Parameters.ParamByName('p1').Value := jrid;
    qr.Parameters.ParamByName('p3').Value := ahszh;
    //qr.Parameters.ParamByName('p4').Value := JRID;
    qr.Parameters.ParamByName('p5').Value := JRID;
    end;
    qr.Open;
    Result :=qr.fieldbyname('MAX_SXID').AsInteger;
    qr.Close;
  finally
      FreeAndNil(qr);
  end;
end;

function TdmDBAccess.GetYYBRMaxKSSXID(const ksid, by7,
  jrid,sjdbz: string;ahszh:Integer): Integer;
var
  qr:TADOQuery;
begin
  Result :=0;
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  try
    if by7='' then
    begin
      if jrid='0' then
      begin
        qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
              ' t_dhxx ' +
              ' where ksid=:p1'+
              ' and (yxjid=88 or yxjid=89 or yxjid=18) '+
              ' and jzbz<>''0''' +
              ' and hszh=:p3'+
              ' and sjdbz<=:p4';
        qr.Parameters.ParamByName('p1').Value := jrid;
        qr.Parameters.ParamByName('p3').Value := ahszh;
        qr.Parameters.ParamByName('p4').Value := sjdbz;
        //qr.Parameters.ParamByName('p4').Value := JRID;
//        qr.Parameters.ParamByName('p5').Value := JRID;

      end
      else
      begin
        qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
              ' t_dhxx ' +
              ' where ksid=(select ksid from t_dhxx where id=:p1)'+
              ' and (yxjid=88 or yxjid=89 or yxjid=18) '+
              ' and jzbz<>''0''' +
              ' and hszh=:p3' +
              //' and kssxid<(select kssxid from t_dhxx where id=:p4)'+
              ' and id<>:p5';
        qr.Parameters.ParamByName('p1').Value := jrid;
        qr.Parameters.ParamByName('p3').Value := ahszh;
        //qr.Parameters.ParamByName('p4').Value := JRID;
        qr.Parameters.ParamByName('p5').Value := JRID;
      end;
    end
    else
    begin
      qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=(select ksid from t_dhxx where id=:p1)'+
            ' and (yxjid=88 or yxjid=89 or yxjid=18) '+
            ' and jzbz<>''0''' +
            ' and hszh=:p3' +
     //       ' and kssxid<(select kssxid from t_dhxx where id=:p4)'+
            ' and id<>:p5' +
            ' and by7<=:p6';
      qr.Parameters.ParamByName('p1').Value := jrid;
      qr.Parameters.ParamByName('p3').Value := ahszh;
      //qr.Parameters.ParamByName('p4').Value := JRID;
      qr.Parameters.ParamByName('p5').Value := JRID;
      qr.Parameters.ParamByName('p6').Value := by7;
    end;
    qr.Open;
    Result :=qr.fieldbyname('MAX_SXID').AsInteger;
    qr.Close;
  finally
      FreeAndNil(qr);
  end;
end;

function TdmDBAccess.GetZBBRMaxKSSXID(const ksid, jrid: string;const ahszh:Integer): Integer;
var
  qr:TADOQuery;
begin
  Result :=0;
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  try
    if jrid='0' then
    begin
      qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=:p1'+
            ' and jzbz<>''0''' +
            ' and ztbz=5'+
            ' and hszh=:p3';
      qr.Parameters.ParamByName('p1').Value := ksid;
      qr.Parameters.ParamByName('p3').Value := ahszh;
    end
    else
    begin
      qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=(select ksid from t_dhxx where id=:p1)'+
            ' and jzbz<>''0''' +
            ' and ztbz=5'+
            ' and hszh=:p3' +
  //          ' and kssxid<(select kssxid from t_dhxx where id=:p4)'+
  //          ' and replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
            ' and id<>:p5';
      qr.Parameters.ParamByName('p1').Value := jrid;
      qr.Parameters.ParamByName('p3').Value := ahszh;
      //qr.Parameters.ParamByName('p4').Value := JRID;
      qr.Parameters.ParamByName('p5').Value := JRID;
    end;
    qr.Open;
    Result :=qr.fieldbyname('MAX_SXID').AsInteger;
    qr.Close;
  finally
      FreeAndNil(qr);
  end;
end;

function TdmDBAccess.GetYXBRMaxKssxid(const ksid, yxjid,
  JRID: string): Integer;
var
  qr:TADOQuery;
begin
  Result :=0;
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  try
    qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
          ' t_dhxx ' +
          ' where ksid=(select ksid from t_dhxx where id=:p1)'+
          ' and yxjid=:p2'+
          ' and jzbz<>''0''' +
          ' and hszh=:p3' +
//          ' and kssxid<(select kssxid from t_dhxx where id=:p4)'+
//          ' and replicate(''0'',10-len(ghhm))+ghhm<replicate(''0'',10-len('''+tmpghhm+'''))+'''+tmpghhm+''''+
          ' and id<>:p5';
    qr.Parameters.ParamByName('p1').Value := jrid;
    qr.Parameters.ParamByName('p2').Value := yxjid;
    qr.Parameters.ParamByName('p3').Value := gblHSZH;
//    qr.Parameters.ParamByName('p4').Value := JRID;
    qr.Parameters.ParamByName('p5').Value := JRID;
    qr.Open;
    Result :=qr.fieldbyname('MAX_SXID').AsInteger;
    qr.Close;
  finally
      FreeAndNil(qr);
  end;
end;
function TdmDBAccess.GetYSBH: Boolean;
var
  qr:Tadoquery;
begin
  qr := tadoquery.create(nil);
  qr.Connection := ADOConnection;
  try
    try
      if 1=1 then
      begin
        qr.SQL.Text :='select ysbh,ysbhzf from t_hsz where hszh=:p1';
        qr.Parameters.ParamByName('p1').Value := gblHSZH;

        qr.Open;
        if not qr.Eof then
        begin
          gblYSBH := qr.fieldbyname('ysbh').AsInteger;
          gblYSBHZF := qr.fieldbyname('ysbhzf').AsString;
        end;
      end
      else
      begin
        qr.SQL.Text :='select ysbh,ysbhzf from pd_t_hsz where hszh=:p1';
        qr.Parameters.ParamByName('p1').Value := gblHSZH;
        qr.Open;
        if not qr.Eof then
        begin
          gblYSBH := qr.fieldbyname('ysbh').AsInteger;
          gblYSBHZF := qr.fieldbyname('ysbhzf').AsString;
        end;
      end;
      qr.Close;
    except
      gblYSBH :=0;
      gblYSBHZF :='';
    end;
  finally
    FreeAndNil(qr);
  end;
end;
function TdmDBAccess.ReplaceYSBH(const str:string;const YSBH:Integer;const YSBHZF:string):string;
var
  repPos,l:integer;
begin
  Result := str;
  l := Length(str);
  if l<2 then exit;
  if (Byte(str[1])<$7B)  then  //非中文
  begin
    Result := copy(str,1,1)+ysbhzf+copy(str,3,Length(str)-2);
  end
  else
  begin

    if l=4 then
    begin
      if YSBH=1 then
        Result := ysbhzf+copy(str,3,Length(str)-2)
      else
        Result := copy(str,1,2)+ysbhzf;
    end
    else if l=6 then
      Result := copy(str,1,2)+ysbhzf+copy(str,5,Length(str)-4)
    else if l=8 then
      Result := copy(str,1,2)+ysbhzf+copy(str,5,Length(str)-4)
    else
      Result := copy(str,1,2)+ysbhzf+copy(str,5,Length(str)-4)

  end;
//  if YSBH=0 then
//  begin
//    Result := str;
//    exit;
//  end;
//  if (Length(str)<Abs(YSBH)*2) then
//  begin
//    repPos := 3;
//  end
//  else if YSBH>0 then
//    repPos := (Abs(YSBH)-1)*2+1
//  else
//    repPos := Length(str)+(YSBH*2)+1;
//  Result := Copy(str,1,repPos-1)+YSBHZF+copy(str,repPos+2,Length(str)-repPos);
end;

function TdmDBAccess.GetMinSjdbzPos(const aksid, asjdbz,jrid: string;const ahszh:integer): Integer;
var
  qr:TADOQuery;
begin
  Result :=0;
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  try
    if jrid='0' then
    begin
      qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=:p1'+
            ' and jzbz=1' +
            ' and sjdbz<:p2'+
            ' and hszh=:p3';
      qr.Parameters.ParamByName('p1').Value := aksid;
      qr.Parameters.ParamByName('p2').Value := asjdbz;
      qr.Parameters.ParamByName('p3').Value := ahszh;//gblHSZH;
    end
    else
    begin
      qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=(select ksid from t_dhxx where id=:p1)'+
            ' and jzbz=1' +
            ' and sjdbz<:p2'+
            ' and hszh=:p3' +
            ' and id<>:p5';
      qr.Parameters.ParamByName('p1').Value := jrid;
      qr.Parameters.ParamByName('p2').Value := asjdbz;
      qr.Parameters.ParamByName('p3').Value := ahszh;//gblHSZH;
      qr.Parameters.ParamByName('p5').Value := JRID;
    end;
    qr.Open;
    Result :=qr.fieldbyname('MAX_SXID').AsInteger;
    qr.Close;
  finally
      FreeAndNil(qr);
  end;
end;

function TdmDBAccess.GetSameSjdbzPos(const aksid, asjdbz,
  aghhm,jrid: string;const ahszh:integer): Integer;
var
  qr:TADOQuery;
begin
  Result :=0;
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  try
    if jrid='0' then
    begin
      qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=:p1'+
            ' and jzbz=1' +
            ' and sjdbz=:p2'+
            ' and hszh=:p3'+
            ' and (replicate(''0'',10-len(ghhm))+ghhm<='+
            'replicate(''0'',10-len('+quotedstr(aghhm)+'))+'+quotedstr(aghhm)+')';
//            ' and (replicate(''0'',10-len(ghhm))+ghhm<=replicate(''0'',10-len(:p4))+:p5'+')';
      qr.Parameters.ParamByName('p1').Value := aksid;
      qr.Parameters.ParamByName('p2').Value := asjdbz;
      qr.Parameters.ParamByName('p3').Value := ahszh;//gblHSZH;
      //qr.Parameters.ParamByName('p4').Value := aghhm;
      //qr.Parameters.ParamByName('p5').Value := aghhm;
    end
    else
    begin
      qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=(select ksid from t_dhxx where id=:p1)'+
            ' and jzbz=1' +
            ' and sjdbz=:p2'+
            ' and hszh=:p3' +
            ' and id<>:p5'+
            ' and (replicate(''0'',10-len(ghhm))+ghhm<='+
            'replicate(''0'',10-len('+quotedstr(aghhm)+'))+'+quotedstr(aghhm)+')';
      qr.Parameters.ParamByName('p1').Value := jrid;
      qr.Parameters.ParamByName('p2').Value := asjdbz;
      qr.Parameters.ParamByName('p3').Value := ahszh;//gblHSZH;
      qr.Parameters.ParamByName('p5').Value := JRID;
//      qr.Parameters.ParamByName('p6').Value := aghhm;
//      qr.Parameters.ParamByName('p7').Value := aghhm;
    end;
    qr.Open;
    Result :=qr.fieldbyname('MAX_SXID').AsInteger;
    qr.Close;
  finally
      FreeAndNil(qr);
  end;
end;
function TdmDBAccess.GetLargeSjdbzPos(const aksid, asjdbz,
  aghhm,jrid: string;const ahszh:integer): Integer;
var
  qr:TADOQuery;
begin
  Result :=0;
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  try
    if jrid='0' then
    begin
      qr.SQL.Text :=' select  Min(KSSXID) as Min_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=:p1'+
            ' and jzbz<>''0''' +
            ' and sjdbz>:p2'+
            ' and hszh=:p3';
      qr.Parameters.ParamByName('p1').Value := aksid;
      qr.Parameters.ParamByName('p2').Value := asjdbz;
      qr.Parameters.ParamByName('p3').Value := ahszh;//gblHSZH;
      qr.Parameters.ParamByName('p4').Value := aghhm;
      qr.Parameters.ParamByName('p5').Value := aghhm;
    end
    else
    begin
      qr.SQL.Text :=' select  Min(KSSXID) as Min_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=(select ksid from t_dhxx where id=:p1)'+
            ' and jzbz<>''0''' +
            ' and sjdbz>:p2'+
            ' and hszh=:p3';
      qr.Parameters.ParamByName('p1').Value := jrid;
      qr.Parameters.ParamByName('p2').Value := asjdbz;
      qr.Parameters.ParamByName('p3').Value := ahszh;//gblHSZH;
    end;
    qr.Open;
    Result :=qr.fieldbyname('Min_SXID').AsInteger;
    if Result>0 then
    begin
      if Result <=GetZBBRMaxKSSXID(aksid,'0',ahszh) then
        Result :=GetZBBRMaxKSSXID(aksid,'0',ahszh)+1;
      if Result <=GetSendSmsMaxKSSXID(aksid,'0',ahszh) then
        Result :=GetSendSmsMaxKSSXID(aksid,'0',ahszh)+1;
      if Result <=GetYYBRMaxKSSXID(aksid,'','0',IntToStr(sjdbz),ahszh) then
        Result :=GetYYBRMaxKSSXID(aksid,'','0',IntToStr(sjdbz),ahszh)+1;
    end;
    qr.Close;
  finally
      FreeAndNil(qr);
  end;
end;
function TdmDBAccess.GetNotWakeupMaxKSSXID(const aksid, asjdbz,
  jrid: string;const ahszh:integer): Integer;
var
  qr:TADOQuery;
begin
  Result :=0;
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  try
    if jrid='0' then
    begin
      qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=:p1'+
            ' and jzbz=2' +
            ' and hszh=:p3';
      qr.Parameters.ParamByName('p1').Value := aksid;
      qr.Parameters.ParamByName('p3').Value := ahszh;//gblHSZH;
    end
    else
    begin
      qr.SQL.Text :=' select  Max(KSSXID) as MAX_SXID  from  ' +
            ' t_dhxx ' +
            ' where ksid=(select ksid from t_dhxx where id=:p1)'+
            ' and jzbz=2' +
            ' and hszh=:p3' +
            ' and id<>:p5';
      qr.Parameters.ParamByName('p1').Value := jrid;
      qr.Parameters.ParamByName('p3').Value := ahszh;//gblHSZH;
      qr.Parameters.ParamByName('p5').Value := JRID;
    end;
    qr.Open;
    Result :=qr.fieldbyname('MAX_SXID').AsInteger;
    qr.Close;
  finally
      FreeAndNil(qr);
  end;
end;

function TdmDBAccess.ReadHISPBForHide: Boolean;
var
  hisqr:TADOQuery;
  pdqr:TADOQuery;
  msKsdm : String;//                '科室代码
  msKsmc : String;//                '科室名称
begin
  pdqr:= TADOQuery.Create(nil);
  try
    pdqr.Connection :=ADOConnection;
    pdqr.SQL.Text :='';
  finally
    FreeAndNil(pdqr);
  end;
  hisqr:= TADOQuery.Create(nil);
  try
    hisqr.Connection := frmMain.ADOConnHis;
    hisqr.SQL.Text := pbview_name+ ' '+ pbgltj;
    try
      hisqr.Open;
      while not hisqr.Eof do
      begin

      end;
    except
      Exit;
    end;
  finally
    FreeAndNil(hisqr);
  end;
end;

function TdmDBAccess.CheckMzh: Boolean;
var
  qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  qr.SQL.Text :='select mzh from t_dhxx';
  try
    qr.Open;
    Result := True;
  except
    Result := False;
  end;
  qr.Close;
  FreeAndNil(qr);
end;
function TdmDBAccess.CheckXMSP: Boolean;
var
  qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  qr.SQL.Text :='select xmsp from t_dhxx';
  try
    qr.Open;
    Result := True;
  except
    Result := False;
  end;
  qr.Close;
  FreeAndNil(qr);
end;
function TdmDBAccess.CheckField(const afieldname:string): Boolean;
var
  qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  qr.SQL.Text :='select '+afieldname+' from t_dhxx';
  try
    qr.Open;
    Result := True;
  except
    Result := False;
  end;
  qr.Close;
  FreeAndNil(qr);
end;
function TdmDBAccess.getcalltermgif(const typename, aid: string): string;
var
  qr:TADOQuery;
  bf:TBlobField;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr.SQL.Text :=' select map from t_hjzd where '+
      ' hszh =:s0 and zdid=:s1';
    qr.Parameters.ParamByName('s0').Value := gblHSZH;
    qr.Parameters.ParamByName('s1').Value := aid;
    try
      qr.Open;
      if qr.Eof then
      begin
        Result :='defaultgif.gif';
      end
      else
      begin
        if not (qr.FieldByName('map').IsNull) then
        begin
          bf := TBlobField.Create(nil);
          bf :=TBlobField(qr.FieldByName('map'));
          bf.SaveToFile('hjzdgif.gif');
          Result :='hjzdgif.gif';
          //FreeAndNil(bf);
        end
        else
          Result :='defaultgif.gif';
      end;
    except
      Result :='defaultgif.gif';
    end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.UpdateRuntime(const ahszh: Integer): Boolean;
var
  qr:TADOQuery;
begin
  if debughook=1 then exit;

//  exit;//测试
  qr := TADOQuery.Create(nil);
  try
    try
      qr.Connection := ADOConnection;
      qr.SQL.Text :='update t_hsz set runtime=getdate()'+
          ' where hszh=:s1';
      qr.Parameters.ParamByName('s1').Value :=ahszh;
       if qr.ExecSQL>0 then
      begin
        Result := True;
      end
      else
        Result := False;
    except
      Result := False;
    end;
  finally
    FreeAndNil(qr);
  end;

end;

function TdmDBAccess.DB_WakeupByID(const aid: string;const ahszh:Integer;const aTQJH:boolean): integer;
var
  qr:TADOQuery;
  by7:string;
  by1:string;
begin
  Result := 0;
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  try
    if (gblYYSJDJH=1) or (gblYYSJDJH=2) then  //必须要到预约时间才能叫号
    begin
      qr.SQL.Text :='select by1,by7 from t_dhxx where id=:p1';
      qr.Parameters.ParamByName('p1').Value := aid;
      qr.Open;
      if not qr.Eof then
      begin

        by1 := qr.fieldbyname('by1').AsString;
        by7 := qr.fieldbyname('by7').AsString;
      end;
      qr.Close;
      qr.SQL.Clear;
      qr.Parameters.Clear;
            //1.如果是预约病人
      //如果未到预约时间段，则不能入队，只改在jzbz=2,ztbz=8,
      //如果已经到预约时段，则入队，改为jzbz=1,ztbz=1
      //2.如果是普通病人
      //如果已经到预约时段，则入队，改为jzbz=1,ztbz=1
      if ((by1<>'88'))then  //非预约病人
      begin
        qr.SQL.Text :=' UPDATE t_dhxx ' +
                          ' set jzbz=1,ztbz=1 '+
                          ' where id=:p1'+
                          ' and hszh=:p2';
        qr.Parameters.ParamByName('p1').Value := aid;
        qr.Parameters.ParamByName('p2').Value := ahszh;
        result :=1;
      end
      else  //预约病人
      begin
        if (by7>FormatDateTime('hh:nn',now+1/60/24)) then  //未到时间
        begin
          if not aTQJH then  //非提前叫号
          begin
            qr.SQL.Text :=' UPDATE t_dhxx ' +
                              ' set jzbz=2,ztbz=8 '+
                              ' where id=:p1'+
                              ' and hszh=:p2';
            qr.Parameters.ParamByName('p1').Value := aid;
            qr.Parameters.ParamByName('p2').Value := ahszh;
            result :=2;
          end
          else   //提前叫号
          begin
            qr.SQL.Text :=' UPDATE t_dhxx ' +
                              ' set jzbz=1,ztbz=1,yxjid=88 '+
                              ' where id=:p1'+
                              ' and hszh=:p2';
            qr.Parameters.ParamByName('p1').Value := aid;
            qr.Parameters.ParamByName('p2').Value := ahszh;
            result :=1;
          end;
        end
        else //已到预约时间
        begin
          qr.SQL.Text :=' UPDATE t_dhxx ' +
                            ' set jzbz=1,ztbz=1,yxjid=88 '+
                            ' where id=:p1'+
                            ' and hszh=:p2';
          qr.Parameters.ParamByName('p1').Value := aid;
          qr.Parameters.ParamByName('p2').Value := ahszh;
          result :=1;
        end;
      end;
    end
    else  //不到预约时间也可以叫号。
    begin
      qr.SQL.Text :=' UPDATE t_dhxx ' +
                        ' set jzbz=1,ztbz=1 '+
                        ' where id=:p1'+
                        ' and hszh=:p2';
      qr.Parameters.ParamByName('p1').Value := aid;
      qr.Parameters.ParamByName('p2').Value := ahszh;
      result :=1;
    end;
    try
      qr.ExecSQL;
      //Result := True;
    except
      Result := -1;
    end;
  finally
    freeandnil(qr);
  end;
end;
//****************************//
//函数名：DB_GetGroupPrepareCount
//功能：得到准备人数设置
//返回：该科室的准备人数
//如果该科室准备人数为0，则返回gblzbrs.
function TdmDBAccess.DB_GetGroupPrepareCount(
  const AGroupID: string): Integer;
var
  qr:TADOQuery;
begin
  Result := gblZBRS;
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  try
    qr.SQL.Text :=' select PrepareCount from t_ks ' +
                      ' where ksid=:p1'+
                      ' and hszh=:p2';
    qr.Parameters.ParamByName('p1').Value := AGroupID;
    qr.Parameters.ParamByName('p2').Value :=gblHSZH;
    try
      qr.Open;
      if qr.Eof then
      begin
        Result := gblZBRS;
      end
      else
      begin
        if qr.FieldByName('PrepareCount').AsInteger =-1 then
        begin
          Result :=gblZBRS;
        end
        else
          Result :=qr.fieldbyname('PrepareCount').AsInteger;
      end;
      qr.Close;
    except
      Result := gblZBRS;
    end;
  finally
    freeandnil(qr);
  end;
end;

function TdmDBAccess.YHSeleCall_ks(const KsID, Ghhm, AFJH: string;
  const Astatus: Integer): boolean;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   i :integer;
//   hjksnum:integer;
   cmdstr:widestring;
   tmpkssxid,tmpJRID,tmpGHHM,tmpBRXM,tmpYXJID,tmpyxjmc:string;
   DDRS:integer;
   iscall :boolean;
   ksmc:string;
   by6,by4:string;
   qr,tmpqr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
    //gbledit_ks_count:=0;
//    result:='';
    iscall:=false;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT ksid,ksmc from t_ks '+
              ' WHERE (ksid = ''' + ksid +''''+ ') AND (HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    if qr.RecordCount>0 then
       ksmc:=qr.fields.Fields[1].AsString;

    qr.Close;
    ////查找T_DHXX表中此科室的病人.
     cmdstr:=' select id,kssxid,brxm,ghhm,t_dhxx.yxjid,yxjmc,by6,by4 from  ' +
             ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
             ' where t_dhxx.ksid=''' + ksid + '''' +
             ' and t_dhxx.ghhm='''+ghhm+''''+
             ' and t_dhxx.jzbz=1' +
             ' and t_dhxx.hszh=' +inttostr(gblhszh) +
             ' order by t_dhxx.kssxid ';
    qr.SQL.Text:=cmdstr;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
        begin
            //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
            tmpjrid:=fields.Fields[0].AsString;
            tmpkssxid:=fields.fields[1].asstring;
            tmpBrxm:=Fields.Fields[2].AsString;
            tmpGHHM:=fields.fields[3].asstring;
            tmpYXJID:=Fields.Fields[4].asString;
            tmpyxjmc:=fields.fields[5].asstring;
            by6:=fields.Fields[6].AsString;
            by4:=fields.Fields[7].AsString+'|';
            DDRs:=RecordCount-1;
            //并将数据放入显示信息表中
            //WriteDispMsgTT(DeviceID As Long, GroupNo As Long, Qno As Long, UserID As String, Custname As String, Specail As String, WaitNum As Long)
//            gbledit_ks[gbledit_ks_count].ksid:=ksid;
//            gbledit_ks[gbledit_ks_count].ksmc:=ksmc;
//            gbledit_ks_count:=gbledit_ks_count+1;
//
//
//            cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//                    ' where kssxid >(select kssxid from t_dhxx where id=' + tmpjrid +')'+
//                    ' and ksid=''' +ksid + '''' +
//                    ' and hszh=' + inttostr(gblHszh);
//            adoconnection.Execute(cmdstr ,cmdText);
//            //修改T_dhxx中的数据，将本条数据改为就诊
//            cmdstr:=' UPDATE t_dhxx SET JZBZ=0' +
//                    ' ,yhid='''''+
//                    ' ,jzsj=getdate()' +
//                    ' ,kssxid=0' +
//                    ' where id=' + tmpjrid ;
//            adoconnection.Execute(cmdstr ,cmdText);
            if isint(AFJH) then
            begin
               fjh:=AFJH;
               zth :='0';
            end
            else
            begin
               fjh:='0';
               zth :='0';
            end;
            tmpqr:= TADOQuery.Create(nil);
            tmpqr.Connection := ADOConnection;
            tmpqr.SQL.Text := 'select fjmc,zth,ztmc from t_hjzd where fjh='+Afjh+
              ' and hszh='+inttostr(gblHSZH);
            try
              tmpqr.Open;
              if not tmpqr.Eof then
              begin
              fjmc := tmpqr.fieldbyname('fjmc').asstring;
              zth :=  tmpqr.fieldbyname('zth').asstring;
              ztmc := tmpqr.fieldbyname('ztmc').asstring;
              end;
              tmpqr.Close;
            finally
              FreeAndNil(tmpqr);
            end;
            //showmessage(fjh);
            //添加显示信息
            WriteDispMsg('0',fjh,fjmc,zth,ztmc,ksid,ksmc,tmpGHHM,tmpBRxm,'','',tmpYXJID,tmpYXJMC,by6,DDRS,1,'','',by4);
            iscall:=true;
        end;
        close;
    end;
    if iscall then
       result:=true
    else
       result:=false;
  except
    begin
      result := false;//zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;

function TdmDBAccess.WakeupOtherNurseStationNumber(
  const astrTm: string): Boolean;
var
  cmdStr:wideString;
  tmpquery:tadoquery;
  i:integer;
  mr:integer;
  ksid,ksmc,brdm,brxm,ghhm,id,kssxid:string;
  keepYH:Integer;
  intRet:integer;
  strTm:string;
  by5:string;
  RetDB_Wakeupbyid:integer;
begin
try
   addlog('cardlog.txt','进入激活进程'+',卡号:'+astrtm+'' );
   strTm :=astrTM;
   if Length(strTm)=28 then //白玉兰卡
   begin
     strTm:=Copy(strTm,1,gblCardNoLen);
   end;
  with adoconnection do
  begin
       tmpquery:=tadoquery.Create(nil);
       tmpquery.Connection:=adoconnection;
       tmpquery.SQL.Clear;
       {tmpquery.SQL.Add('Select t_dhxx.id,t_dhxx.ksid,t_ks.ksmc,t_dhxx.brxm,t_dhxx.ghhm from t_dhxx left outer join t_ks on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh where t_dhxx.jzbz=''2'' and t_dhxx.ztbz=''6'' and by4=''' + strTm+'''');}
       tmpquery.SQL.Add('Select kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
         ',brdm,jzbz,d.ztbz,by5,by1,by7,d.hszh'+
         ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
         ' and d.hszh=k.hszh'+
         ' where by4=''' + strTm+''''+
         ' and d.hszh in '+gblwakeupothernursestation);//+
         //' and d.jzbz=2 and d.ztbz=6'  );
       tmpquery.Open;

       if tmpquery.RecordCount>0 then
       begin
//         gbledit_ks_count :=0;
         while not tmpquery.Eof do
         begin
           if ((tmpquery.FieldByName('jzbz').AsString='2')
                and (tmpquery.FieldByName('ztbz').AsString='6')) then//未激活
           begin
               if tmpquery.RecordCount>=1 then
               begin
                 if Application.MessageBox(pchar('另一'+ttl_hsz+','+ttl_br+'信息:'+ #13#10+
                             ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+ #13#10+
                             ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+ #13#10+
                             ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring+#13#10+
                             '是否激活?'),
                             pchar('激活另一'+ttl_hsz+ttl_br),MB_YESNO)= IDYES then
                 begin
                   //激活;
                 end
                 else
                 begin
                   tmpquery.Next;
                   Continue;
                 end;
               end;
               RetDB_Wakeupbyid := DB_Wakeupbyid(tmpquery.fieldbyname('id').AsString,
                  tmpquery.fieldbyname('hszh').AsInteger,False);
               if  RetDB_Wakeupbyid<>-1 then
               begin
                 addlog('cardlog.txt','另一'+ttl_hsz+',激活成功'+','+ttl_br+'信息:'+
                             ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                             ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                             ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring );
                 result:=true;
                 frmmain.sbrInfo.Panels.Items[0].Text:= '另一'+ttl_hsz+',刷卡成功,'+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                               ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                               ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring;

               //需要将此病人安排在准备号之后，大号码之前，小号码之后。
               //add by wugang @2012-11-08
                 if (gblYYSJDJH=1)  //--预约时间段到后才能呼叫
                  and (tmpquery.FieldByName('by1').AsString='88') //是预约病人
                  and (RetDB_Wakeupbyid=2) then
                  //and (tmpquery.FieldByName('by7').AsString>FormatDateTime('hh:nn',now)) then  //预约时间段未到
                 begin
//                   PutWakeupIDAtPos(tmpquery.fieldbyname('id').AsString,gblHSZH);
//                   if tmpquery.FieldByName('by1').AsString='88' then
//                   begin
//                     SZYXJ(tmpquery.fieldbyname('id').AsString,'88');
//                   end;
                 end
                 else
                 begin
                   PutWakeupIDAtPos(tmpquery.fieldbyname('id').AsString,
                      tmpquery.fieldbyname('hszh').AsInteger);
//                   if tmpquery.FieldByName('by1').AsString='88' then
//                   begin
//                     SZYXJ(tmpquery.fieldbyname('id').AsString,'88');
//                   end;
                 end;
                 //写入数据到通知更新表中;
                 insertnotifygrouptorefresh(tmpquery.fieldbyname('hszh').AsInteger,
                    tmpquery.fieldbyname('ksid').AsString,gblHSZH);
               //add end
               end
               else
               begin
                 frmmain.sbrInfo.Panels.Items[0].Text:= '另一护士站,刷卡成功,激活操作失败!'+ttl_br+'信息:'+
                             ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                             ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                             ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring;
                 addlog('cardlog.txt','另一护士站,刷卡成功,激活操作失败!'+ttl_br+'信息:'+
                             ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                             ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                             ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring);
               end;
           end
           else if (tmpquery.FieldByName('jzbz').AsString='0') then
           begin
               if Application.MessageBox(pchar('另一'+ttl_hsz+','+ttl_br+'信息:'+ #13#10+
                           ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+ #13#10+
                           ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+ #13#10+
                           ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring+#13#10+
                           '是否召回?'),
                           pchar('召回另一'+ttl_hsz+ttl_br),MB_YESNO)= IDYES then
               begin
                 //召回;
               end
               else
               begin
                 tmpquery.Next;
                 Continue;
               end;
               if  FZZHByHszh(tmpquery.fieldbyname('id').AsString,
                  tmpquery.fieldbyname('ksid').AsString,0,
                  '',
                  tmpquery.fieldbyname('hszh').AsInteger) then
               begin
                 addlog('cardlog.txt','另一'+ttl_hsz+',召回成功'+','+ttl_br+'信息:'+
                             ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                             ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                             ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring );
                 result:=true;
                 frmmain.sbrInfo.Panels.Items[0].Text:= '另一'+ttl_hsz+',刷卡成功,'+ttl_br+'信息:'+
                               ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                               ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                               ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring;

               //需要将此病人安排在准备号之后，大号码之前，小号码之后。
               //add by wugang @2012-11-08
//                 PutWakeupIDAtPos(tmpquery.fieldbyname('id').AsString,
//                    tmpquery.fieldbyname('hszh').AsInteger);
//                 if tmpquery.FieldByName('by1').AsString='88' then
//                 begin
//                   SZYXJ(tmpquery.fieldbyname('id').AsString,'88');
//                 end;
                 //写入数据到通知更新表中;
                 insertnotifygrouptorefresh(tmpquery.fieldbyname('hszh').AsInteger,
                    tmpquery.fieldbyname('ksid').AsString,gblHSZH);
               //add end
               end
               else
               begin
                 frmmain.sbrInfo.Panels.Items[0].Text:= '另一护士站,刷卡成功,召回操作失败!'+ttl_br+'信息:'+
                             ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                             ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                             ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring;
                 addlog('cardlog.txt','另一护士站,刷卡成功,召回操作失败!'+ttl_br+'信息:'+
                             ' '+ttl_ks+':'+tmpquery.fieldbyname('ksmc').asstring+
                             ' 姓名:'+tmpquery.fieldbyname('brxm').asstring+
                             ' '+ttl_ghhm+':'+tmpquery.fieldbyname('ghhm').asstring);
               end;
           end;
           tmpquery.Next;
         end;
       end;
  end;
except

end;
end;
function TdmDBAccess.CheckNotifyGroupToRefresh(const ahszh: Integer): Boolean;
var
  qr,qr1:TADOQuery;
  groupcode:string;
  jrid:string;
begin
 // exit;//测试
  qr := TADOQuery.Create(nil);
  qr1 := TADOQuery.Create(nil);
  try
    try
      qr.Connection := ADOConnection;
      qr1.Connection := ADOConnection;
      qr.SQL.Text :='select groupcode from t_notifygrouptorefresh(nolock) '+
        'where nursestation=:s1 and status=''1'''+
        ' and exists(select 1 from t_dhxx where ksid=groupcode and hszh=nursestation)';
      qr.Parameters.ParamByName('s1').Value :=ahszh;
      qr.Open;
      if not qr.Eof then
      begin
        gbledit_ks[gbledit_ks_count].ksid:=qr.fieldbyname('groupcode').AsString;
        gbledit_ks[gbledit_ks_count].ksmc:=qr.fieldbyname('groupcode').AsString;
        gbledit_ks_count :=gbledit_ks_count+1;
        groupcode := qr.fieldbyname('groupcode').AsString;
        Result := True;
      end
      else
        Result := False;
      if Result then
      begin
        qr.SQL.Clear;
        qr.Parameters.Clear;
        qr.SQL.Text :='update t_notifygrouptorefresh set status=''0'''+
         ' where nursestation=:s1 and status=''1'''+
         ' and groupcode=:s2';
        qr.Parameters.ParamByName('s1').Value :=ahszh;
        qr.Parameters.ParamByName('s2').Value :=groupcode;
        qr.ExecSQL;
        qr.Close;
      end;
      //查询激活病人打印票单
      if (Result) and (gblJHDYPD=1) then
      begin
        qr.Close;
        qr.SQL.Clear;
        qr.Parameters.Clear;
        qr.SQL.Text :='select id from t_dhxx where jzbz=1 and dybz=0'+
            ' and hszh=:s1'+
            ' and ksid=:s2';
        qr.Parameters.ParamByName('s1').Value :=ahszh;
        qr.Parameters.ParamByName('s2').Value :=groupcode;
        qr.Open;
        while not qr.Eof do
        begin
          jrid:=qr.fieldbyname('id').asstring;
          printno(jrid);
          qr1.SQL.Text :=' update t_dhxx set dybz=1 where id=:s1';
          qr1.Parameters.ParamByName('s1').Value := jrid;
          try
            qr1.ExecSQL;
          except
          end;
          qr.Next;
        end;
        qr.Close;
      end;
    except
      Result := False;
    end;
  finally
    FreeAndNil(qr);
    FreeAndNil(qr1);
  end;

end;
function TdmDBAccess.insertnotifygrouptorefresh(const atohszh: Integer;
  const agroupid:string; const ahszh: Integer): Boolean;
var
  qr:TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    try
      qr.Connection := ADOConnection;
      qr.SQL.Text :='insert into t_notifygrouptorefresh(nursestation,groupcode,status,fromnursestation) '+
        'values(:p1,:p2,''1'',:p3)';
      qr.Parameters.ParamByName('p1').Value :=atohszh;
      qr.Parameters.ParamByName('p2').Value :=agroupid;
      qr.Parameters.ParamByName('p3').Value :=ahszh;
      qr.ExecSQL;
    except
      Result := False;
    end;
  finally
    FreeAndNil(qr);
  end;

end;
{*******************************************************************************
*函数名:FZZHByHszh;
                                           *
*函数机能:复诊召回指定护士站号                                          *
*******************************************************************************}
function TdmDBAccess.FZZHByHszh(const JRID:string;const KSID:string;
  const AkeepYH:integer;const AYHID:string;const ahszh:Integer):boolean;
var
  cmdStr:wideString;
  ddbrrs:integer;
  ddbrfzrs:integer;
  ddbrfzZDXSID:integer;
  tmpFzws:integer;
  yhid:string;
  qr:TADOQuery;
  ghhm:string;
  kssxid,tmpkssxid:Integer;
  y:integer;
  x,sjdbz:Integer;
begin
  //2014-09-16 改用存储过程  吴刚
  if DB_RebackPatientByID(JRID,ahszh,akeepyh,AYHID,gblfzzhtype,1) then
  begin
    result:=true;
    Exit;
  end;
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
       with adoconnection do
       begin
         if gblfzzhtype=1 then   //如果不按召回算法安排病人顺序只按号码大小序
         begin
           cmdstr:=' select ghhm,sjdbz from t_dhxx (nolock) where'+
                   ' id=:pid';
           qr.SQL.Clear;
           qr.Parameters.Clear;
           qr.SQL.Text:=cmdstr;
           qr.Parameters.ParamByName('pid').Value := JRID;
           qr.Open;
           if not qr.Eof then
           begin
              ghhm := qr.fieldbyname('ghhm').AsString ;
              sjdbz := qr.fieldbyname('sjdbz').AsInteger;
           end
           else
           begin
              ghhm :='';
              sjdbz :=1;// qr.fieldbyname('sjdbz').AsInteger;
           end;
           qr.Close;
            kssxid :=0;
            //得到准备病人最大kssxid.
            x := GetZBBRMaxKSSXID(ksid,JRID,ahszh);
            if (x>0) and (x>=kssxid) then
              kssxid :=x+1;
            //得到已发短信病人最大kssxid
            x := GetSendSmsMaxKSSXID(ksid,JRID,ahszh);
            if (x>0) and (x>=kssxid) then
              kssxid :=x+1;
            //得到预约病人最大kssxid
            x := GetYYBRMaxKSSXID(ksid,'',JRID,IntToStr(sjdbz),ahszh);
            if (x>0) and (x>=kssxid) then
              kssxid:= x+1;
           //先找到t_dhxx.sjdbz<sjdbz的病人最大kssxid
            x := GetMinSjdbzPos(ksid,IntToStr(sjdbz),JRID,ahszh);
            if (x>0) and (x>=kssxid) then
              kssxid:= x+1;
           //再找t_dhxx.sjdbz=sjdbz前且号码比ghhm小的病人最大kssxid
            x := GetSameSjdbzPos(ksid,IntToStr(sjdbz),ghhm,JRID,ahszh);
            if (x>0) and (x>=kssxid) then
              kssxid := x+1;
            if kssxid=0 then kssxid:=1;
           cmdstr:=' UPDATE t_dhxx ' +
                  ' Set kssxid=kssxid+1 ' +
                  ' where jzbz<>0 and ksid=''' + ksid +'''' +
                  ' and hszh=' + inttostr(ahszh)+
                  ' and kssxid>=' + inttostr(kssxid);
           execute(cmdstr,cmdtext);
           if (gblBRDYS=0)  or (AkeepYH=0) then
              cmdStr:=' UPDATE t_dhxx ' +
                  ' Set JZBZ=1' +
                  ',ztbz=2'+
                  ',yhlcs=0'+
                  ',jzsj=null' +
                  ',yhid=null' +
                  ',kssxid=' +inttostr(kssxid) +
                  ' where id=' +jrid
           else if AkeepYH=2 then
           begin
              cmdStr:=' UPDATE t_dhxx ' +
                  ' Set JZBZ=1' +
                  ',ztbz=2'+
                  ',yhlcs=0'+
                  ',jzsj=null' +
                  ',yhid=''' +Ayhid+''''+
                  ',kssxid=' +inttostr(kssxid) +
                  ' where id=' +jrid
           end
           else
           begin
              cmdStr:=' UPDATE t_dhxx ' +
                  ' Set JZBZ=1' +
                  ',ztbz=2'+
                  ',jzsj=null' +
                  ',yhlcs=0'+
                  ',kssxid=' +inttostr(kssxid) +
                  ' where id=' +jrid;
           end;
            execute(cmdstr,cmdtext);
           FreeAndNil(qr);
         end
         else
         begin
           //2013-07-08修改吴刚
           cmdstr:=' select ghhm,sjdbz from t_dhxx (nolock) where'+
                   ' id=:pid';
           qr.SQL.Clear;
           qr.Parameters.Clear;
           qr.SQL.Text:=cmdstr;
           qr.Parameters.ParamByName('pid').Value := JRID;
           qr.Open;
           if not qr.Eof then
           begin
              ghhm := qr.fieldbyname('ghhm').AsString ;
              sjdbz := qr.fieldbyname('sjdbz').AsInteger;
           end
           else
           begin
              ghhm :='';
              sjdbz :=1;// qr.fieldbyname('sjdbz').AsInteger;
           end;
           qr.Close;
            kssxid :=0;
            //得到准备病人最大kssxid.
            x := GetZBBRMaxKSSXID(ksid,JRID,ahszh);
            if (x>0) and (x>=kssxid) then
              kssxid :=x+1;
            //得到已发短信病人最大kssxid
            x := GetSendSmsMaxKSSXID(ksid,JRID,ahszh);
            if (x>0) and (x>=kssxid) then
              kssxid :=x+1;
            //得到预约病人最大kssxid
            x := GetYYBRMaxKSSXID(ksid,'',JRID,IntToStr(sjdbz),ahszh);
            if (x>0) and (x>=kssxid) then
              kssxid:= x+1;
           //先找到t_dhxx.sjdbz<sjdbz的病人最大kssxid
            x := GetMinSjdbzPos(ksid,IntToStr(sjdbz),JRID,ahszh);
            if (x>0) and (x>=kssxid) then
              kssxid:= x+1;
            if kssxid=0 then kssxid:=1;
            if (gblFZWS>kssxid) then
              kssxid := gblFZWS;
            if gblFZAYS=1 then
            begin
              qr.SQL.Text:=' select yhid from  ' +
                  ' t_dhxx ' +
                  ' where id='+JRID+
                  ' and hszh=' + inttostr(ahszh);
              qr.Open;
              if not qr.Eof then
                 yhid:=qr.Fields.Fields[0].Asstring
              else
                 yhid:='';
              qr.Close;
              //得到科室中选择当前复诊病人所选医生队列中等待并复诊的病人最大顺序号.
              qr.SQL.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
                  ' t_dhxx ' +
                  ' where ksid=''' + ksid + ''''+
                  ' and yhid='''+yhid+''''+
                  //' and jzbz<>''0''' +
                  ' and jzbz=1 ' +
                  ' and ztbz=2 ' +
                  ' and hszh=' + inttostr(ahszh);
              qr.Open;
              if qr.Fields.Fields[0].AsInteger=0 then
              begin
                 qr.Close;
                 qr.SQL.Text:=' select  top '+inttostr(gblfzws)+' KSSXID  from  ' +
                    ' t_dhxx ' +
                    ' where ksid=''' + ksid + ''''+
                    ' and yhid='''+yhid+''''+
                    //' and jzbz<>''0''' +
                    ' and jzbz=1 ' +
                    ' and hszh=' + inttostr(ahszh) +
                    ' order by KSSXID';
                 qr.Open;
                 if qr.Eof then
                    ddbrfzZDXSID:=0
                 else
                 begin
                    qr.Last;
                    ddbrfzZDXSID:=qr.Fields.Fields[0].AsInteger;
                 end;
                 qr.Close;
      //             ddbrfzZDXSID:=gblfzws;
              end
              else
              begin
                 ddbrfzZDXSID:=qr.Fields.Fields[0].AsInteger;
                 qr.Close;
              end;
            end
            else
            begin
              //得到科室中等待并复诊的病人最大顺序号.
              qr.SQL.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
                  ' t_dhxx ' +
                  ' where ksid=''' + ksid + ''''+
                  //' and jzbz<>''0''' +
                  ' and jzbz=1 ' +
                  ' and ztbz=2 ' +
                  ' and hszh=' + inttostr(ahszh);
              qr.Open;
              if qr.Fields.Fields[0].AsInteger=0 then
                 ddbrfzZDXSID:=0
              else
                 ddbrfzZDXSID:=qr.Fields.Fields[0].AsInteger;
              qr.Close;
            end;
            if (ddbrfzZDXSID>0) and (ddbrfzZDXSID>=kssxid) then
            begin
              kssxid :=ddbrfzZDXSID+1+gblfzjgws;
            end;

           //---------------------------------------
           //得到当前科室中的等待人数.
           qr.Close;
           qr.SQL.Text:=' select  Max(KSSXID) as MAX_SXID  from  ' +
              ' t_dhxx ' +
              ' where ksid=''' + ksid + ''''+
              //' and jzbz<>''0'' ' +
              ' and jzbz=1 ' +
              ' and hszh=' + inttostr(ahszh);
            qr.Open;
            ddbrrs:=qr.Fields.Fields[0].AsInteger;
           qr.Close;
          tmpFzws := kssxid;//+gblfzjgws;
          //得到时间段比sjdbz大的病人最小kssxid.
          x:=GetLargeSjdbzPos(ksid,IntToStr(sjdbz),ghhm,jrid,ahszh);
          if (x>0) and (tmpFzws>x) then
            tmpFzws := x;
          if ddbrrs>=tmpfzws then
          begin
             if 1<>1 then //ddbrfzZDXSID>=tmpFzws then
             //如果等待并且复诊的最大顺序大于要插入的位置
             //则将复诊的记录插入到ddbrfzZDXSID的后一位位置
             //将原来的等待队列中顺序号大于 要插入的位置向后退一位.
             begin
                 cmdstr:=' UPDATE t_dhxx ' +
                        ' Set kssxid=kssxid+1 ' +
                        ' where jzbz<>''0'' and ksid=''' + ksid +'''' +
                        ' and hszh=' + inttostr(ahszh)+
                        ' and kssxid>' + inttostr(ddbrfzZDXSID);
                 execute(cmdstr,cmdtext);
                 if (gblBRDYS=0)  or (AkeepYH=0) then
                    cmdStr:=' UPDATE t_dhxx ' +
                        ' Set JZBZ=1' +
                        ',ztbz=2'+
                        ',yxjid=1'+
                        ',by1=''0'''+ //取消此人的预约优先。
                        ',yhlcs=0'+
                        ',jzsj=null' +
                        ',yhid=null' +
                        ',kssxid=' +inttostr(ddbrfzZDXSID+1) +
                        ' where id=' +jrid
                 else if AkeepYH=2 then
                 begin
                    cmdStr:=' UPDATE t_dhxx ' +
                        ' Set JZBZ=1' +
                        ',ztbz=2'+
                        ',yxjid=1'+
                        ',by1=''0'''+ //取消此人的预约优先。
                        ',yhlcs=0'+
                        ',jzsj=null' +
                        ',yhid=''' +Ayhid+''''+
                        ',kssxid=' +inttostr(ddbrfzZDXSID+1) +
                        ' where id=' +jrid
                 end
                 else
                 begin
                    cmdStr:=' UPDATE t_dhxx ' +
                        ' Set JZBZ=1' +
                        ',ztbz=2'+
                        ',yxjid=1'+
                        ',by1=''0'''+ //取消此人的预约优先。
                        ',jzsj=null' +
                        ',yhlcs=0'+
                        ',kssxid=' +inttostr(ddbrfzZDXSID+1) +
                        ' where id=' +jrid;
                 end;
                  execute(cmdstr,cmdtext);
             end
             else
             //如果等待并且复诊的最大顺序小于要插入的位置
             //则将复诊的记录插入到gblFZWS的位置
             //并将原来的等待队列中顺序号大于要插入的位置向后退一位.
             begin
                 cmdstr:=' UPDATE t_dhxx ' +
                        ' Set kssxid=kssxid+1 ' +
                        ' where jzbz<>''0'' and ksid=''' + ksid +'''' +
                        ' and hszh=' + inttostr(ahszh)+
                        ' and kssxid>=' + inttostr(tmpFzws);
                 execute(cmdstr,cmdtext);
                 if (gblBRDYS=0)  or (AkeepYH=0) then
                    cmdStr:=' UPDATE t_dhxx ' +
                        ' Set JZBZ=''1''' +
                        ',ztbz=2'+
                        ',yxjid=1'+
                        ',by1=''0'''+ //取消此人的预约优先。
                        ',yhlcs=0'+
                        ',yhid=''''' +
                        ',jzsj=null' +
                        ',kssxid=' +inttostr(tmpFzws) +
                        ' where id=' +jrid
                 else if AkeepYH=2 then
                 begin
                    cmdStr:=' UPDATE t_dhxx ' +
                        ' Set JZBZ=''1''' +
                        ',ztbz=2'+
                        ',yxjid=1'+
                        ',by1=''0'''+ //取消此人的预约优先。
                        ',yhlcs=0'+
                        ',jzsj=null' +
                        ',yhid=''' +Ayhid+''''+
                        ',kssxid=' +inttostr(tmpFzws) +
                        ' where id=' +jrid
                 end
                 else
                    cmdStr:=' UPDATE t_dhxx ' +
                        ' Set JZBZ=''1''' +
                        ',ztbz=2'+
                        ',yxjid=1'+
                        ',by1=''0'''+ //取消此人的预约优先。
                        ',yhlcs=0'+
                        ',jzsj=null' +
                        ',kssxid=' +inttostr(tmpFzws) +
                        ' where id=' +jrid;
                  execute(cmdstr,cmdtext);
             end;
          end
          else
          //如果等待人数小于复诊召回要插入的位置就直接将本条记录的顺序号改为等待人数+1
          //即插入到最后.
          begin
             cmdstr:=' UPDATE t_dhxx ' +
                    ' Set kssxid=kssxid+1 ' +
                    ' where jzbz<>''0'' and ksid=''' + ksid +'''' +
                    ' and hszh=' + inttostr(ahszh)+
                    ' and kssxid>=' + inttostr(ddbrrs+1);
             execute(cmdstr,cmdtext);
             if (gblBRDYS=0) or (AkeepYH=0) then
                cmdStr:=' UPDATE t_dhxx ' +
                    ' Set JZBZ=''1''' +
                    ',ztbz=2'+
                    ',yxjid=1'+
                    ',by1=''0'''+ //取消此人的预约优先。
                    ',yhlcs=0'+
                    ',jzsj=null' +
                    ',yhid=''''' +
                    ',kssxid=' +inttostr(ddbrrs+1) +
                    ' where id=' +jrid
             else if AkeepYH=2 then
             begin
                cmdStr:=' UPDATE t_dhxx ' +
                    ' Set JZBZ=''1''' +
                    ',ztbz=2'+
                    ',yxjid=1'+
                    ',by1=''0'''+ //取消此人的预约优先。
                    ',yhlcs=0'+
                    ',jzsj=null' +
                    ',yhid=''' +Ayhid+''''+
                    ',kssxid=' +inttostr(ddbrrs+1) +
                    ' where id=' +jrid
             end
             else
                cmdStr:=' UPDATE t_dhxx ' +
                    ' Set JZBZ=''1''' +
                    ',ztbz=2'+
                    ',yxjid=1'+
                    ',by1=''0'''+ //取消此人的预约优先。
                    ',yhlcs=0'+
                    ',jzsj=null' +
                    ',kssxid=' +inttostr(ddbrrs+1) +
                    ' where id=' +jrid;
              execute(cmdstr,cmdtext);
          end;
           //如果召回的病人中有转移到其他科室但未处理的，把转移的标志改成已算处理
           cmdStr:='update t_ksJzh  set clbz=0 where tmpid = ' +  JRID;
           execute(cmdstr,cmdtext);
         end;
       end;
       result:=true;

    except
      begin
        result := False;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;


end;
function TdmDBAccess.InsertToOrder(const ahszh, arankid: Integer;
  const aksid: string; const aorderid: Integer): Boolean;
var
  qr:TADOQuery;
begin
  Result := True;
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      qr.SQL.Text :=' select * from t_ks_order '+
        ' where hszh=:p1 and ksid=:p2';
      qr.Parameters.ParamByName('p1').Value := ahszh;
      qr.Parameters.ParamByName('p2').Value := aksid;
      qr.Open;
      if qr.Eof then
      begin
        qr.Close;
        qr.SQL.Clear;
        qr.Parameters.Clear;
        qr.SQL.Text :=' insert into t_ks_order(hszh,rankid,ksid,orderid)'+
          ' values(:p1,:p2,:p3,:p4)';
        qr.Parameters.ParamByName('p1').Value := ahszh;
        qr.Parameters.ParamByName('p2').Value := arankid;
        qr.Parameters.ParamByName('p3').Value := aksid;
        qr.Parameters.ParamByName('p4').Value := aorderid;
        qr.ExecSQL;
      end
      else
        qr.Close;
    except
      Result := False;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.ClearOrderTable(const ahszh: Integer): Boolean;
var
  qr:TADOQuery;
begin
  Result := True;
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      qr.SQL.Text :=' delete t_ks_order where hszh=:p1';
      qr.Parameters.ParamByName('p1').Value := ahszh;
      qr.ExecSQL;
    except
      Result := False;
    end;
  finally
    FreeAndNil(qr);
  end;

end;

function TdmDBAccess.GetPatientAge(const aseleid: string): Integer;
var
  qr:TADOQuery;
begin
  Result := 0;
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      qr.SQL.Text :=' select nl from t_dhxx where id=:p1';
      qr.Parameters.ParamByName('p1').Value := aseleid;
      qr.Open;
      if qr.Eof then
        Result :=0
      else
        Result := StrToInt(qr.fieldbyname('nl').AsString);
      qr.Close;
    except
      Result := gblOldAge;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
//写入信息到记录表
//输入参数 logtype 记录类型，logmsg记录内容
//logtype   1001 打开程序，1002 关闭程序
//
//返回值 0成功，-1失败
function TdmDBAccess.WriteLogInfo(const logtype, logmsg: string): Integer;
var
  hostip,hostname:string;
  qr:TADOQuery;
  //aComputerName:array[0..255] of char;
begin
  //GetHostName(aComputerName,255);
  hostname:=GetComputerNameS();
  hostip := getuseip();
  Result := -1;
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      qr.SQL.Text :='insert into t_logmsg(logtype,logmsg,hostip,hostname,logtime,hszh)'+
        ' values(:p1,:p2,:p3,:p4,getdate(),:p5)';
      qr.Parameters.ParamByName('p1').Value := logtype;
      qr.Parameters.ParamByName('p2').Value := logmsg;
      qr.Parameters.ParamByName('p3').Value := hostip;
      qr.Parameters.ParamByName('p4').Value := hostname;
      qr.Parameters.ParamByName('p5').Value := gblHSZH;
      qr.ExecSQL;
      qr.Close;
      Result := 0;
    except
      Result := -1;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.DB_PutWakeupIDAtPos(const aid: string;
  const ahszh: Integer): Boolean;
var
  sp:TADOStoredProc;
begin
  try
    sp := TADOStoredProc.Create(nil);
    sp.Connection := ADOConnection;
    try
      sp.ProcedureName :='my_putwakeupidAtpos';
      sp.Parameters.CreateParameter('id',ftInteger,pdInput,4,aid);
      sp.Parameters.CreateParameter('hszh',ftInteger,pdInput,4,ahszh);
      sp.Parameters.CreateParameter('fzzhlx',ftInteger,pdInput,4,gblfzzhtype);
      sp.ExecProc;
      Result := True;
    except
      Result := False;
    end;
  finally
    FreeAndNil(sp);
  end;

end;
function TdmDBAccess.DB_ReSortGroup(const agroup: string;
  const ahszh: Integer): Boolean;
var
  sp:TADOStoredProc;
begin
  try
    sp := TADOStoredProc.Create(nil);
    sp.Connection := ADOConnection;
    try
      sp.ProcedureName :='my_ReSortGroup';
      sp.Parameters.CreateParameter('hszh',ftInteger,pdInput,4,ahszh);
      sp.Parameters.CreateParameter('ksid',ftString,pdInput,20,agroup);
      sp.ExecProc;
      Result := True;
    except
      Result := False;
    end;
  finally
    FreeAndNil(sp);
  end;

end;

function TdmDBAccess.DB_GetGroupPatientPos(const aksid: string;
  const asjdbz: Integer; const aghhm: string; const ahszh,
  ajzbz: Integer): Integer;
var
  sp:TADOStoredProc;
begin
  try
    sp := TADOStoredProc.Create(nil);
    sp.Connection := ADOConnection;
    try
      //sp.ProcedureName :='my_GetGroupPatientPos';
      sp.ProcedureName :='my_GetGroupPatientPos_noupdate';
      sp.Parameters.CreateParameter('ksid',ftString,pdInput,20,aksid);
      sp.Parameters.CreateParameter('sjdbz',ftInteger,pdInput,4,asjdbz);
      sp.Parameters.CreateParameter('ghhm',ftString,pdInput,10,aghhm);
      sp.Parameters.CreateParameter('hszh',ftInteger,pdInput,4,ahszh);
      sp.Parameters.CreateParameter('jzbz',ftInteger,pdInput,4,ajzbz);
      sp.Open;
      if sp.RecordCount>0 then
      begin
        Result := sp.fieldbyname('pos').AsInteger;
      end
      else
        Result :=0;
    except
      Result := 0;
    end;
  finally
    FreeAndNil(sp);
  end;

end;
function TdmDBAccess.DB_SetHisPatientStatus(const aid:string): Boolean;
var
  sp:TADOStoredProc;
begin
  if gblSetHisPatientStatus<>1 then
  begin
    Result := True;
    exit;
  end;
  try
    sp := TADOStoredProc.Create(nil);
    sp.Connection := ADOConnection;
    try
      //sp.ProcedureName :='my_GetGroupPatientPos';
      sp.ProcedureName :='SetHisPatientStatus';
      sp.Parameters.CreateParameter('jrid',ftInteger,pdInput,4,aid);
      sp.ExecProc;
      Result := True;
    except
      Result := False;
    end;
  finally
    FreeAndNil(sp);
  end;

end;


function TdmDBAccess.DB_SetSpecialPosByID(const aid:string;
  const ayxjid:string): Boolean;
var
  sp:TADOStoredProc;
begin
  try
    sp := TADOStoredProc.Create(nil);
    sp.Connection := ADOConnection;
    try
      sp.ProcedureName :='my_SetSpecialPosByID';
      sp.Parameters.CreateParameter('id',ftInteger,pdInput,4,aid);
      sp.Parameters.CreateParameter('yxjid',ftInteger,pdInput,4,ayxjid);
      sp.ExecProc;
      Result := True
    except
      Result := False;
    end;
  finally
    FreeAndNil(sp);
  end;

end;
//@id int,--病人在t_dhxx表中的id值，此值在t_dhxx表中唯一
//@hszh   int,  --护士站号
//@keepyh int, --保留上一次的医生 0-清除选择医生，1-使用新的医生@yhid ,2-保留原来医生
//@yhid varchar(20),   --医生工号
//@fzzhlx int --复诊召回类型  0-按系统设置的召回方式，1-按号码从小到大方式
function TdmDBAccess.DB_RebackPatientByID(const aid:string;
  const ahszh:Integer;const akeepyh:Integer;const ayhid:string;
  const afzzhtype:Integer;const afzorzh:integer): Boolean;
var
  sp:TADOStoredProc;
begin
  try
    sp := TADOStoredProc.Create(nil);
    sp.Connection := ADOConnection;
    try
      sp.ProcedureName :='my_RebackPatientByID_2way';
      sp.Parameters.CreateParameter('id',ftInteger,pdInput,4,aid);
      sp.Parameters.CreateParameter('hszh',ftInteger,pdInput,4,ahszh);
      sp.Parameters.CreateParameter('keepyh',ftInteger,pdInput,4,akeepyh);
      sp.Parameters.CreateParameter('yhid',ftString,pdInput,20,ayhid);
      sp.Parameters.CreateParameter('fzzhlx',ftInteger,pdInput,4,afzzhtype);
      sp.Parameters.CreateParameter('fzorzh',ftInteger,pdInput,4,afzorzh);
      sp.ExecProc;
      Result := True
    except
      begin
        try
            sp.ProcedureName :='my_RebackPatientByID';
            sp.Parameters.CreateParameter('id',ftInteger,pdInput,4,aid);
            sp.Parameters.CreateParameter('hszh',ftInteger,pdInput,4,ahszh);
            sp.Parameters.CreateParameter('keepyh',ftInteger,pdInput,4,akeepyh);
            sp.Parameters.CreateParameter('yhid',ftString,pdInput,20,ayhid);
            sp.Parameters.CreateParameter('fzzhlx',ftInteger,pdInput,4,afzzhtype);
            sp.ExecProc;
            Result := True;
        except
          Result := False;
        end;
      end;
    end;
  finally
    FreeAndNil(sp);
  end;

end;
function TdmDBAccess.ChangeUserShowGroup(const azdid, ayhid,
  aksid: string): Boolean;
var
  qr,qr1:TADOQuery;
  id:string;
  ksmc:string;
  xspid:string;
begin
  Result := False;
  qr:= TADOQuery.Create(nil);
  qr1:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr1.Connection := ADOConnection;
    try
      qr.SQL.Text :='select top 1 id as max_id from t_xsxx where hjid=:p1 and hszh=:p2'+
        ' and yhid=:p3 and ghhm=''欢迎光临'' order by id desc';
      qr.Parameters.ParamByName('p1').Value := azdid;
      qr.Parameters.ParamByName('p2').Value := gblHSZH;
      qr.Parameters.ParamByName('p3').Value := ayhid;
      qr.Open;
      if qr.Eof then
      begin
        qr.Close;
        Result := False;
      end
      else
      begin
        ksmc := GetDBValue(D003,aksid,'ksmc');
        xspid := GetDBValue(D013,aksid,'xspid');
        if xspid='' then xspid:='0';
        while not qr.Eof do
        begin
          id:=qr.fieldbyname('max_id').AsString;
          qr1.SQL.Clear;
          qr1.Parameters.Clear;
          if xspid='0' then
          begin
            qr1.SQL.Text :='update t_xsxx set ksid=:p1,ksmc=:p2'+
              ' where id=:p3';
            qr1.Parameters.ParamByName('p1').Value := aksid;
            qr1.Parameters.ParamByName('p2').Value := ksmc;
            qr1.Parameters.ParamByName('p3').Value := id;
          end
          else
          begin
            qr1.SQL.Text :='update t_xsxx set ksid=:p1,ksmc=:p2,xspid=:p4'+
              ' where id=:p3';
            qr1.Parameters.ParamByName('p1').Value := aksid;
            qr1.Parameters.ParamByName('p2').Value := ksmc;
            qr1.Parameters.ParamByName('p3').Value := id;
            qr1.Parameters.ParamByName('p4').Value := xspid;
          end;
          qr1.ExecSQL;
          qr1.Close;
          qr.Next
        end;
        qr.Close;
      end;
      Result := True;
    except
      Result := False;
    end;
  finally
    FreeAndNil(qr);
    FreeAndNil(qr1);
  end;
end;

function TdmDBAccess.GetWaitListByby7(const agroups: string;var pwaitnum:Integer): string;
var
  qr:TADOQuery;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,yhmc,YXJID,yxjmc,JZBZ,ztbz,by6,ksid,ksmc,brdm,by4:string;
   by7,mzh,xb,nl,strghsj:string;
   listwaitnum:Integer;
   listStrWait:string;   //在等待的病人列表
begin
  Result := '';
  pwaitnum :=0;
  listwaitnum:=0;
  listStrWait:='';
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try

//////
         if agroups<>'' then
         begin
          cmdstr :=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,'''' as mzh,'''' as xb,'''' as nl,ghsj,ksmc,t_dhxx.ksid from  ' +
                     ' t_dhxx left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left outer join t_ks on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh '+
                     ' where t_dhxx.ksid in (' + agroups+')'+
                     ' and jzbz<>0'+
                     ' and t_dhxx.hszh=:p1' +//inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>=:p2'+//inttostr(gblhjyssj)+
                     ' order by t_dhxx.by7,ghsj ';
          qr.SQL.Text := cmdstr;
          qr.Parameters.ParamByName('p1').Value := gblHSZH;
          qr.Parameters.ParamByName('p2').Value := gblHJYSSJ;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            while not qr.Eof  do
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                kssxid:=fields.fields[1].asstring;
                Brxm:=Fields.Fields[2].AsString;
                BRXM := ReplaceCallListPatName(BRXM);
                GHHM:=fields.fields[3].asstring;
                yhmc:=fields.fields[4].asstring;
                YXJID:=Fields.Fields[5].asString;
                yxjmc:=fields.fields[6].asstring;
                jzbz:=fields.Fields[7].asstring;
                ztbz:=fields.fields[8].asstring;
                by6:=fields.fields[9].asstring;
                brdm :=fields.fields[10].asstring;
                by4 := fields.fields[11].asstring;
                by7 := fields.fields[12].asstring;
                mzh :=fields.fields[13].asstring;
                xb :=fields.fields[14].asstring;
                nl :=fields.fields[15].asstring;
                strghsj := FormatDateTime('hh:nn',fields.fields[16].AsDateTime);
                ksmc := fields.fields[17].asstring;
                ksid := fields.fields[18].asstring;
                begin
                   if listwaitnum<99 then
                   begin
                     liststrwait := liststrwait +ghhm+spaces(4-length(ghhm)) +' '+'^'+
                              brxm+spaces(8-length(brxm))+'^';
                     liststrwait := liststrwait + ksmc+spaces(8-length(ksmc))+'^';
                     liststrwait := liststrwait + by6+spaces(8-length(by6))+'^';//+spaces(8-length(by6));
                     liststrwait:=liststrwait+yxjmc+spaces(8-length(yxjmc))+'^';//+spaces(8-length(yxjmc));
                     liststrwait := liststrwait +yhmc+spaces(8-length(yhmc))+'^';//+spaces(8-length(yhmc));
                     If Ztbz = '1' Then
                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'//  ttl_cz +spaces(8-length(ttl_cz))
                     Else If ztbz= '2' Then
                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'//  ttl_fz + spaces(8-length(ttl_fz))
                     Else If ztbz= '5' Then
                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'//  '准  备' + spaces(8-length('准  备'))
                     Else If ztbz= '6' Then
                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'//  '未激活' + spaces(8-length('未激活'))
                     else if ztbz='7' then
                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'//  '已完成' + spaces(8-length('已完成'))
                     Else
                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';// '未呼叫'+ spaces(8-length('未呼叫'));
                     liststrwait := liststrwait + ksid+'^';
                     liststrwait := liststrwait + brdm+'^';
                     liststrwait := liststrwait + by4+'^';
                     liststrwait := liststrwait + strghsj+'^';
                     liststrwait := liststrwait + by7+'^';
                     liststrwait := liststrwait + xb+'^';
                     liststrwait := liststrwait + nl+'^';
                     liststrwait := liststrwait + mzh+'^';
                     liststrwait := liststrwait + ztbz+'^';
                     liststrwait := liststrwait + jrid;
                     liststrwait := liststrwait + ';';
                     listwaitnum:=listwaitnum+1;
                   end;
                end;
                next;
            end;
           end;
         end;
//////
      qr.Close;
      Result := liststrwait;
      pwaitnum := listwaitnum;
    except
      Result := liststrwait;
      pwaitnum := listwaitnum;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
function TdmDBAccess.DB_GetServerTime(): TDateTime;
begin
  try
    result :=StrToDateTime(GetDBValue('DQSJ','a','a'));
  except
    result := Now;
  end;
end;
procedure TdmDBAccess.ShowPatGroupInfo(const acardno: string;aksrq:string;ajsrq:string;
  var lvwDataList: TTeThemeSListView);
var
  cmdStr:wideString;
  tmpquery:tadoquery;
  i,j:integer;
  mr:integer;
  ksid,ksmc,brdm,brxm,ghhm,id,kssxid:string;
  keepYH:Integer;
  intRet:integer;
  strTm:string;
  tmpadosp:TADOStoredProc;
  itm:TListItem;
  patinfo:array [0..5] of string;
begin
  //Result :=False;

  if gblEnterKHXX<>1 then
  begin
    addlog('errorlog.txt','EnterKHXX='+inttostr(gblEnterKHXX));
  end;
  AdoConnHis.ConnectionString := gblKHXXConnstr;
  try
    AdoConnHis.Open;
  except
    addlog('errorlog.txt','连接HIS数据库失败!'+gblKHXXConnstr);
    //Result := False;
    Exit;
  end;
   strTm :=acardno;
   if Length(strTm)=28 then //白玉兰卡
   begin
     strTm:=Copy(strTm,1,gblCardNoLen);
   end;
    tmpquery:= tadoquery.Create(nil);
    try
      if gblKHXXLB=8 then
      begin
          try
            for i:=0 to 5 do
            begin
              patinfo[i] :='';
            end;
             tmpquery.Connection:=AdoConnHis;
             tmpquery.SQL.Text:='select *'+
              ' from '+ gblHisViewName+' where cardno=:p1 and Flag=0';
             tmpquery.Parameters.ParamByName('p1').Value := strTm;
             tmpquery.Open;
             lvwdatalist.Columns.Clear;
             lvwdatalist.Items.Clear;
             lvwdatalist.Columns.Add;
             lvwdatalist.Column[0].Caption :='代码';
             lvwdatalist.Column[0].Width :=64;
             lvwdatalist.Columns.Add;
             lvwdatalist.Column[1].Caption :='项目名称';
             lvwdatalist.Column[1].Width :=80;
             lvwdatalist.Columns.Add;
             lvwdatalist.Column[2].Caption :='备注1';
             lvwdatalist.Column[2].Width :=80;
             lvwdatalist.Columns.Add;
             lvwdatalist.Column[3].Caption :='备注2';
             lvwdatalist.Column[3].Width :=80;
             lvwdatalist.Columns.Add;
             lvwdatalist.Column[4].Caption :='备注3';
             lvwdatalist.Column[4].Width :=80;
             while not tmpquery.Eof do
             begin
               try
               patinfo[0] := trim(tmpquery.fieldbyname('groupcode').AsString);
               except
               end;
               try
                 patinfo[1] := trim(tmpquery.fieldbyname('groupname').AsString);
               except
               end;
               try
                 patinfo[2] := trim(tmpquery.fieldbyname('spare1').AsString);
               except
               end;
               try
                 patinfo[3] := trim(tmpquery.fieldbyname('spare2').AsString);
               except
               end;
               try
                 patinfo[4] := trim(tmpquery.fieldbyname('spare3').AsString);
               except
               end;
               itm:=lvwdatalist.Items.Add();
               itm.Caption := patinfo[0];
               for j:= 1 to 4 do
               begin
                 itm.SubItems.Add(patinfo[j]);
               end;
               tmpquery.Next;
             end;
             //Result := True;
             tmpquery.Close;
          except on e:Exception do
            begin
              addlog('errorlog.txt','查询接口表'+gblhisviewname+'出错:'+e.Message);
              //Result :=False;
            end
          end;
      end
      else if gblKHXXLB=30 then
      begin
        try
          try
            for i:=0 to 5 do
            begin
              patinfo[i] :='';
            end;
            tmpadosp := TADOStoredProc.Create(nil);
            tmpadosp.Connection := AdoConnHis;
            tmpadosp.ProcedureName :=gblhisviewname ;//'proc_jh_brxx';
            tmpadosp.Parameters.CreateParameter('cardno',ftString,pdInput,30,strTm);
            tmpadosp.Open;
             lvwdatalist.Columns.Clear;
             lvwdatalist.Items.Clear;
             lvwdatalist.Columns.Add;
             lvwdatalist.Column[0].Caption :='项目代码';
             lvwdatalist.Column[0].Width :=64;
             lvwdatalist.Columns.Add;
             lvwdatalist.Column[1].Caption :='项目名称';
             lvwdatalist.Column[1].Width :=250;
            while not  tmpadosp.Eof do
            begin
               try
               patinfo[0] := tmpadosp.fieldbyname('groupcode').AsString;
               except
               end;
               try
                 patinfo[1] := tmpadosp.fieldbyname('groupname').AsString;
               except
               end;
               itm:=lvwdatalist.Items.Add();
               itm.Caption := patinfo[0];
               itm.SubItems.Add(patinfo[1]);
               tmpadosp.Next;
            end;
            //Result := True;
          except on e:Exception do
            begin
              addlog('errorlog.txt','执行存储过程'+gblhisviewname+'出错:'+e.Message);
              //Result :=False;
            end
          end;
        finally
          FreeAndNil(tmpadosp);
        end;
      end
      else if gblKHXXLB=31 then
      begin
        try
          try
            for i:=0 to 5 do
            begin
              patinfo[i] :='';
            end;
            tmpadosp := TADOStoredProc.Create(nil);
            tmpadosp.Connection := AdoConnHis;
            tmpadosp.ProcedureName :=gblhisviewname ;//'proc_jh_brxx';
            tmpadosp.Parameters.CreateParameter('cardno',ftString,pdInput,30,strTm);
            tmpadosp.Parameters.CreateParameter('kssj',ftString,pdInput,30,aksrq);
            tmpadosp.Parameters.CreateParameter('kssj',ftString,pdInput,30,ajsrq);
            tmpadosp.Open;
            lvwdatalist.Columns.Clear;
            lvwdatalist.Items.Clear;
            lvwdatalist.Columns.Add;
            lvwdatalist.Column[0].Caption :='项目代码';
            lvwdatalist.Column[0].Width :=64;
            lvwdatalist.Columns.Add;
            lvwdatalist.Column[1].Caption :='项目名称';
            lvwdatalist.Column[1].Width :=250;
            while not  tmpadosp.Eof do
            begin
               if (tmpadosp.fieldbyname('flag').AsString)='0' then
               begin
                 try
                 patinfo[0] := tmpadosp.fieldbyname('groupcode').AsString;
                 except
                 end;
                 try
                   patinfo[1] := tmpadosp.fieldbyname('groupname').AsString;
                 except
                 end;
                 itm:=lvwdatalist.Items.Add();
                 itm.Caption := patinfo[0];
                 itm.SubItems.Add(patinfo[1]);
               end;
               tmpadosp.Next;
            end;
            //Result := True;
          except on e:Exception do
            begin
              addlog('errorlog.txt','执行存储过程'+gblhisviewname+'出错:'+e.Message);
              //Result :=False;
            end
          end;
        finally
          FreeAndNil(tmpadosp);
        end;
      end;
    finally
      FreeAndNil(tmpquery);
      AdoConnHis.Close;
    end;
end;

function TdmDBAccess.getpatage(const abirthday: string): string;
var
  starttime:tdatetime;
  age:integer;
begin
  try
    starttime := strtodate(abirthday);
    if (Round(now-starttime) mod 365)=0 then
    begin
      age :=Round(now-starttime) div 365;
    end
    else
    begin
      age:=Round(now-starttime) div 365;
      age:= age+1;
    end;
    result :=inttostr(age);
  except
    result :='';
  end;
end;

function TdmDBAccess.GetSendListOrderByGHSJ(const zdid,
  cmd: string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjfs:integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,yhmc,YXJID,yxjmc,JZBZ,ztbz,by6,ksid,ksmc,brdm,by4:string;
   by7,mzh,xb,nl,strghsj,xmsp,yhid,sjdmc:string;
   DDRS:integer;
   iscall :boolean;
   listwaitNum:integer;//在等待的病人数
   listcallnum:integer;//已呼叫的病人数
   listStrWait:string;   //在等待的病人列表
   listStrCall:string;   //已呼叫的病人列表
   ksbrdys:string;
   tmphjksstr:string;
   qr:TADOQuery;
   blsend:boolean;
begin
  qr := TADOQuery.Create(nil);
  try
  try
    qr.Connection := ADOConnection;

    result:='';
    listStrWait:='' ;
    listStrCall:='';
    listwaitnum:=0;
    listcallnum:=0;
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text :=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,hjfs from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;

    qr.Open;
    ///////////得到登录信息
    with qr do
    begin
       if not qr.Eof  then
       begin
        zdyhid:=fields.fields[4].asstring ;
        zdyhmc:=fields.fields[5].asstring;
        fjh:=fields.Fields[1].AsString;
        //fjmc:=fields.Fields[6].AsString;
        zth:=fields.Fields[2].AsString;
        ztmc:=fields.Fields[3].AsString;
        hjfs := fields.Fields[6].AsInteger;
        if ( zdyhid <>'')  then
           begin
           close;
           end
        else
           begin
           result:=zdid+cmd + '028888';///没有登录.
           close;
           //qr.Free;
           exit;
           end;
       end
       else
       begin
         result:=zdid + cmd + '038888';  ///没有此呼叫器
         close ;
         //qr.Free;
         exit;
         end;
    end;
    //在T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////
    with qr do
    begin
       if not qr.Eof  then
       begin
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             qr.Close;
             //qr.Free;
             exit;
           end;
           close;
       end
       else
       begin
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           //qr.Free;
           exit;
       end;
    end;
    ////查找T_DHXX表中此科室的病人.
    tmphjksstr:='';
    if hjksnum>0 then
    begin
       tmphjksstr:=''''+hjks[1].TGroupid+'''';
       for i:=1 to hjksnum do
       begin
          if i>1 then
            tmphjksstr:=tmphjksstr+','''+hjks[i].TGroupid+'''';
       end;
       tmphjksstr := '('+tmphjksstr+')';
       if hjfs=1 then
       begin
         for i:=1 to hjksnum do
         begin
            ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
            if ksbrdys='' then ksbrdys:='0';
            if (gblshowallwait=0) and (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
            //if gblbrdys=1 then
            begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,t_dhxx.yhid,sjdmc  from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     ' order by t_dhxx.sjdbz,ghsj,replicate(''0'',10-len(ghhm))+ghhm  ';
            end
            else
            begin
                cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,t_dhxx.yhid,sjdmc  from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     ' order by t_dhxx.sjdbz,ghsj,replicate(''0'',10-len(ghhm))+ghhm ';
            end;
            qr.SQL.Text := cmdstr;
            qr.Open;
            ///////////将中.
            with qr do
            begin
              while not qr.Eof  do
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  BRXM := ReplaceCallListPatName(BRXM);
                  GHHM:=fields.fields[3].asstring;
                  yhmc:=fields.fields[4].asstring;
                  YXJID:=Fields.Fields[5].asString;
                  yxjmc:=fields.fields[6].asstring;
                  jzbz:=fields.Fields[7].asstring;
                  ztbz:=fields.fields[8].asstring;
                  by6:=fields.fields[9].asstring;
                  brdm :=fields.fields[10].asstring;
                  by4 := fields.fields[11].asstring;
                  by7 := fields.fields[12].asstring;
                  mzh :=fields.fields[13].asstring;
                  xb :=fields.fields[14].asstring;
                  nl :=fields.fields[15].asstring;
                  strghsj := FormatDateTime('hh:nn',fields.fields[16].AsDateTime);
                  xmsp := fields.fields[17].asstring;
                  yhid := fields.fields[18].asstring;
                  sjdmc:= fields.fields[19].asstring;
                  blsend := true;
                  if (jzbz='0') and ((gblhjbrpx=4) or (gblhjbrpx=5)) then
                  begin
                    if (yhid<>zdyhid) and (yhid<>'') then
                      blsend := false;
                  end;
                  if blsend then
                  begin
                     //if listwaitnum<99 then
                     begin
                       //1号码(ghhm)，2姓名(brxm)
                       liststrwait := liststrwait +ghhm+spaces(4-length(ghhm)) +' '+'^'+
                                brxm+spaces(8-length(brxm))+'^';
                       //3科室(ksmc)
                       liststrwait := liststrwait + hjks[i].TGroupName+spaces(8-length(hjks[i].TGroupName))+'^';
                       //4类别(by6)
                       liststrwait := liststrwait + by6+spaces(8-length(by6))+'^';//+spaces(8-length(by6));
                       //5优先级(yxjmc)
                       liststrwait:=liststrwait+yxjmc+spaces(8-length(yxjmc))+'^';//+spaces(8-length(yxjmc));
                       //6医生姓名(ysxm)
                       liststrwait := liststrwait +yhmc+spaces(8-length(yhmc))+'^';//+spaces(8-length(yhmc));
                       //7状态（ztmc)
                       if JZBZ='2' then //未激活
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'
                       else if JZBZ='1' then //等待中
                       begin
                         if ztbz ='1' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'
                         else if ztbz='2' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'
                         Else If ztbz= '5' Then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'
                         Else
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';
                       end
                       else if JZBZ='0' then //已呼叫
                       begin
                         if ztbz='7' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'
                         else if ztbz='3' then
                          liststrwait := liststrwait +GetStrWithnotBadCode('已弃号',8)+'^'
                         else
                          liststrwait := liststrwait +GetStrWithnotBadCode('已呼叫',8)+'^'
                       end;
  //                     If Ztbz = '1' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'//  ttl_cz +spaces(8-length(ttl_cz))
  //                     Else If ztbz= '2' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'//  ttl_fz + spaces(8-length(ttl_fz))
  //                     Else If ztbz= '5' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'//  '准  备' + spaces(8-length('准  备'))
  //                     Else If ztbz= '6' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'//  '未激活' + spaces(8-length('未激活'))
  //                     else if ztbz='7' then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'//  '已完成' + spaces(8-length('已完成'))
  //                     Else
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';// '未呼叫'+ spaces(8-length('未呼叫'));
                       //8科室代码 (ksid)
                       liststrwait := liststrwait + hjks[i].TGroupid+'^';
                       // 9病人代码(brdm)
                       liststrwait := liststrwait + brdm+'^';
                       // 10病人标识、卡号(by4)
                       liststrwait := liststrwait + by4+'^';
                       // 11挂号时间(ghsj)
                       liststrwait := liststrwait + strghsj+'^';
                       // 12预约时间(by7)
                       liststrwait := liststrwait + by7+'^';
                       // 13性别(xb)
                       liststrwait := liststrwait + xb+'^';
                       // 14年龄(nl)
                       liststrwait := liststrwait + nl+'^';
                       // 15门诊号(mzh)
                       liststrwait := liststrwait + mzh+'^';
                       // 16就诊标志(jzbz)
                       liststrwait := liststrwait + jzbz+'^';
                       // 17状态(ztbz)
                       liststrwait := liststrwait + ztbz+'^';
                       // 18记录id(id)
                       liststrwait := liststrwait + jrid+'^';
                       //19首拼
                       liststrwait := liststrwait + xmsp+'^';
                       liststrwait := liststrwait + sjdmc;
                       liststrwait := liststrwait + ';';
                       listwaitnum:=listwaitnum+1;
                     end;
                  end;
                  next;
              end;
            end;
            qr.Close;
         end;
       end
       else
       begin
            ksbrdys := dmdbaccess.GetDBValue('KS',hjks[1].TGroupid,'SelDoctor');
            if ksbrdys='' then ksbrdys:='0';
            if (gblshowallwait=0) and (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
            //if gblbrdys=1 then
            begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,ksmc,t_dhxx.yhid,sjdmc  from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid in ' + tmphjksstr +
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     ' order by t_dhxx.sjdbz,ghsj,replicate(''0'',10-len(ghhm))+ghhm ';
            end
            else
            begin
                cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,ksmc,t_dhxx.yhid,sjdmc from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_ks(nolock) on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid in ' + tmphjksstr +
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     ' order by t_dhxx.sjdbz,ghsj, replicate(''0'',10-len(ghhm))+ghhm';
            end;
            qr.SQL.Text := cmdstr;
            qr.Open;
            ///////////将中.
            with qr do
            begin
              while not qr.Eof  do
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  BRXM := ReplaceCallListPatName(BRXM);
                  GHHM:=fields.fields[3].asstring;
                  yhmc:=fields.fields[4].asstring;
                  YXJID:=Fields.Fields[5].asString;
                  yxjmc:=fields.fields[6].asstring;
                  jzbz:=fields.Fields[7].asstring;
                  ztbz:=fields.fields[8].asstring;
                  by6:=fields.fields[9].asstring;
                  brdm :=fields.fields[10].asstring;
                  by4 := fields.fields[11].asstring;
                  by7 := fields.fields[12].asstring;
                  mzh :=fields.fields[13].asstring;
                  xb :=fields.fields[14].asstring;
                  nl :=fields.fields[15].asstring;
                  strghsj := FormatDateTime('hh:nn',fields.fields[16].AsDateTime);
                  xmsp :=fields.fields[17].asstring;
                  ksmc :=fields.fields[18].asstring;
                  yhid := fields.fields[19].asstring;
                  sjdmc := fields.fields[20].asstring;
                  blsend := true;
                  if (jzbz='0') and ((gblhjbrpx=4) or (gblhjbrpx=5)) then
                  begin
                    if (yhid<>zdyhid) and (yhid<>'') then
                      blsend := false;
                  end;
                  if blsend then
                  begin
                     //if listwaitnum<99 then
                     begin
                       //1号码(ghhm)，2姓名(brxm)
                       liststrwait := liststrwait +ghhm+spaces(4-length(ghhm)) +' '+'^'+
                                brxm+spaces(8-length(brxm))+'^';
                       //3科室(ksmc)
                       liststrwait := liststrwait + ksmc+spaces(8-length(ksmc))+'^';
                       //4类别(by6)
                       liststrwait := liststrwait + by6+spaces(8-length(by6))+'^';//+spaces(8-length(by6));
                       //5优先级(yxjmc)
                       liststrwait:=liststrwait+yxjmc+spaces(8-length(yxjmc))+'^';//+spaces(8-length(yxjmc));
                       //6医生姓名(ysxm)
                       liststrwait := liststrwait +yhmc+spaces(8-length(yhmc))+'^';//+spaces(8-length(yhmc));
                       //7状态（ztmc)
                       if JZBZ='2' then //未激活
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'
                       else if JZBZ='1' then //等待中
                       begin
                         if ztbz ='1' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'
                         else if ztbz='2' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'
                         Else If ztbz= '5' Then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'
                         Else
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';
                       end
                       else if JZBZ='0' then //已呼叫
                       begin
                         if ztbz='7' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'
                         else if ztbz='3' then
                          liststrwait := liststrwait +GetStrWithnotBadCode('已弃号',8)+'^'
                         else
                          liststrwait := liststrwait +GetStrWithnotBadCode('已呼叫',8)+'^'
                       end;
  //                     If Ztbz = '1' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'//  ttl_cz +spaces(8-length(ttl_cz))
  //                     Else If ztbz= '2' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'//  ttl_fz + spaces(8-length(ttl_fz))
  //                     Else If ztbz= '5' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'//  '准  备' + spaces(8-length('准  备'))
  //                     Else If ztbz= '6' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'//  '未激活' + spaces(8-length('未激活'))
  //                     else if ztbz='7' then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'//  '已完成' + spaces(8-length('已完成'))
  //                     Else
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';// '未呼叫'+ spaces(8-length('未呼叫'));
                       //8科室代码 (ksid)
                       liststrwait := liststrwait + hjks[i].TGroupid+'^';
                       // 9病人代码(brdm)
                       liststrwait := liststrwait + brdm+'^';
                       // 10病人标识、卡号(by4)
                       liststrwait := liststrwait + by4+'^';
                       // 11挂号时间(ghsj)
                       liststrwait := liststrwait + strghsj+'^';
                       // 12预约时间(by7)
                       liststrwait := liststrwait + by7+'^';
                       // 13性别(xb)
                       liststrwait := liststrwait + xb+'^';
                       // 14年龄(nl)
                       liststrwait := liststrwait + nl+'^';
                       // 15门诊号(mzh)
                       liststrwait := liststrwait + mzh+'^';
                       // 16就诊标志(jzbz)
                       liststrwait := liststrwait + jzbz+'^';
                       // 17状态(ztbz)
                       liststrwait := liststrwait + ztbz+'^';
                       // 18记录id(id)
                       liststrwait := liststrwait + jrid+'^';
                       // 19首拼
                       liststrwait := liststrwait + xmsp+'^';

                       liststrwait := liststrwait + sjdmc;
                       liststrwait := liststrwait + ';';
                       listwaitnum:=listwaitnum+1;
                     end;
                  end;
                  next;
              end;
            end;
            qr.Close;

       end;
       if (listwaitnum>0)  then
       begin
           //result:=zdid + 'DD01'  + format('%4D',[listwaitnum]) + liststrwait;
           result:=zdid + 'DD11'  + format('%4D',[listwaitnum]) + liststrwait;
           //临时修改，九院20160628
           //result:=zdid + 'DD01'  + format('%4D',[listwaitnum]) + liststrwait;
       end
       else
       begin
            result:=zdid +'DD'  +'000000'  ;
       end;
     end
     else
        result:=zdid +'DD'  +'000000'  ;
     //qr.Free;
     exit;
  except
    begin
      result := zdid + cmd + '068888';  ///有错误发生.
      //qr.Free;
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.GetSendListOrderBySXID(const zdid,
  cmd: string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjfs:integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,yhmc,YXJID,yxjmc,JZBZ,ztbz,by6,ksid,ksmc,brdm,by4:string;
   by7,mzh,xb,nl,strghsj,xmsp,yhid,sjdmc:string;
   DDRS:integer;
   iscall :boolean;
   listwaitNum:integer;//在等待的病人数
   listcallnum:integer;//已呼叫的病人数
   listStrWait:string;   //在等待的病人列表
   listStrCall:string;   //已呼叫的病人列表
   ksbrdys:string;
   tmphjksstr:string;
   qr:TADOQuery;
   blsend:boolean;
begin
  qr := TADOQuery.Create(nil);
  try
  try
    qr.Connection := ADOConnection;

    result:='';
    listStrWait:='' ;
    listStrCall:='';
    listwaitnum:=0;
    listcallnum:=0;
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text :=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,hjfs from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;

    qr.Open;
    ///////////得到登录信息
    with qr do
    begin
       if not qr.Eof  then
       begin
        zdyhid:=fields.fields[4].asstring ;
        zdyhmc:=fields.fields[5].asstring;
        fjh:=fields.Fields[1].AsString;
        //fjmc:=fields.Fields[6].AsString;
        zth:=fields.Fields[2].AsString;
        ztmc:=fields.Fields[3].AsString;
        hjfs := 1;//fields.Fields[6].AsInteger;
        if ( zdyhid <>'')  then
           begin
           close;
           end
        else
           begin
           result:=zdid+cmd + '028888';///没有登录.
           close;
           //qr.Free;
           exit;
           end;
       end
       else
       begin
         result:=zdid + cmd + '038888';  ///没有此呼叫器
         close ;
         //qr.Free;
         exit;
         end;
    end;
    //在T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////
    with qr do
    begin
       if not qr.Eof  then
       begin
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             qr.Close;
             //qr.Free;
             exit;
           end;
           close;
       end
       else
       begin
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           //qr.Free;
           exit;
       end;
    end;
    ////查找T_DHXX表中此科室的病人.
    tmphjksstr:='';
    if hjksnum>0 then
    begin
       tmphjksstr:=''''+hjks[1].TGroupid+'''';
       for i:=1 to hjksnum do
       begin
          if i>1 then
            tmphjksstr:=tmphjksstr+','''+hjks[i].TGroupid+'''';
       end;
       tmphjksstr := '('+tmphjksstr+')';
       if hjfs=1 then
       begin
         for i:=1 to hjksnum do
         begin
            ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
            if ksbrdys='' then ksbrdys:='0';
            if (gblshowallwait=0) and (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
            //if gblbrdys=1 then
            begin
              if gblhavemzh=1 then
              begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,t_dhxx.yhid,sjdmc from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     //' order by kssxid,jzsj';
                     ' order by (case when jzbz=1 then 1 when jzbz=2 then 1 else 2 end),'+
                      ' (case when jzbz=0 then 999999 else kssxid end),'+
                      ' replicate(''0'',10-len(ghhm))+ghhm,ghsj ';
                     //' order by jzbz desc,kssxid,jzsj';
              end
              else
              begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,'''' mzh,'''' xb,'''' nl,ghsj,xmsp,t_dhxx.yhid,sjdmc from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     //' order by kssxid,jzsj';
                      ' order by (case when jzbz=1 then 1 when jzbz=2 then 1 else 2 end),'+
                      ' (case when jzbz=0 then 999999 else kssxid end),'+
                      ' replicate(''0'',10-len(ghhm))+ghhm,ghsj ';
              end;
            end
            else
            begin
              if gblhavemzh=1 then
              begin
                cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,t_dhxx.yhid,sjdmc from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     //' order by kssxid,jzsj';
                     //' order by jzbz desc,kssxid,jzsj';
                     ' order by (case when jzbz=1 then 1 when jzbz=2 then 1 else 2 end),'+
                      ' (case when jzbz=0 then 999999 else kssxid end),'+
                      ' replicate(''0'',10-len(ghhm))+ghhm,ghsj ';
              end
              else
              begin
                cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,'''' mzh,'''' xb,'''' nl,ghsj,xmsp,t_dhxx.yhid,sjdmc from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid=''' + hjks[i].TGroupid +''''+
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     //' order by kssxid,jzsj';
                     ' order by (case when jzbz=1 then 1 when jzbz=2 then 1 else 2 end),'+
                      ' (case when jzbz=0 then 999999 else kssxid end),'+
                      ' replicate(''0'',10-len(ghhm))+ghhm,ghsj ';
              end;
            end;
            qr.SQL.Text := cmdstr;
            qr.Open;
            ///////////将中.
            with qr do
            begin
              while not qr.Eof  do
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  BRXM := ReplaceCallListPatName(BRXM);
                  GHHM:=fields.fields[3].asstring;
                  yhmc:=fields.fields[4].asstring;
                  YXJID:=Fields.Fields[5].asString;
                  yxjmc:=fields.fields[6].asstring;
                  jzbz:=fields.Fields[7].asstring;
                  ztbz:=fields.fields[8].asstring;
                  by6:=fields.fields[9].asstring;
                  brdm :=fields.fields[10].asstring;
                  by4 := fields.fields[11].asstring;
                  by7 := fields.fields[12].asstring;
                  mzh :=fields.fields[13].asstring;
                  xb :=fields.fields[14].asstring;
                  nl :=fields.fields[15].asstring;
                  strghsj := FormatDateTime('hh:nn',fields.fields[16].AsDateTime);
                  xmsp := fields.fields[17].asstring;
                  yhid := fields.fields[18].asstring;
                  sjdmc := fields.fields[19].asstring;
                  blsend := true;
                  if (jzbz='0') and ((gblhjbrpx=4) or (gblhjbrpx=5)) then
                  begin
                    if (yhid<>zdyhid) and (yhid<>'') then
                      blsend := false;
                  end;
                  if blsend then
                  begin
                     //if listwaitnum<99 then
                     begin
                       //1号码(ghhm)，2姓名(brxm)
                       liststrwait := liststrwait +ghhm+spaces(4-length(ghhm)) +' '+'^'+
                                brxm+spaces(8-length(brxm))+'^';
                       //3科室(ksmc)
                       liststrwait := liststrwait + hjks[i].TGroupName+spaces(8-length(hjks[i].TGroupName))+'^';
                       //4类别(by6)
                       liststrwait := liststrwait + by6+spaces(8-length(by6))+'^';//+spaces(8-length(by6));
                       //5优先级(yxjmc)
                       liststrwait:=liststrwait+yxjmc+spaces(8-length(yxjmc))+'^';//+spaces(8-length(yxjmc));
                       //6医生姓名(ysxm)
                       liststrwait := liststrwait +yhmc+spaces(8-length(yhmc))+'^';//+spaces(8-length(yhmc));
                       //7状态（ztmc)
                       if JZBZ='2' then //未激活
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'
                       else if JZBZ='1' then //等待中
                       begin
                         if ztbz ='1' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'
                         else if ztbz='2' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'
                         Else If ztbz= '5' Then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'
                         Else
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';
                       end
                       else if JZBZ='0' then //已呼叫
                       begin
                         if ztbz='7' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'
                         else if ztbz='3' then
                          liststrwait := liststrwait +GetStrWithnotBadCode('已弃号',8)+'^'
                         else
                          liststrwait := liststrwait +GetStrWithnotBadCode('已呼叫',8)+'^'
                       end;
  //                     If Ztbz = '1' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'//  ttl_cz +spaces(8-length(ttl_cz))
  //                     Else If ztbz= '2' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'//  ttl_fz + spaces(8-length(ttl_fz))
  //                     Else If ztbz= '5' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'//  '准  备' + spaces(8-length('准  备'))
  //                     Else If ztbz= '6' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'//  '未激活' + spaces(8-length('未激活'))
  //                     else if ztbz='7' then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'//  '已完成' + spaces(8-length('已完成'))
  //                     Else
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';// '未呼叫'+ spaces(8-length('未呼叫'));
                       //8科室代码 (ksid)
                       liststrwait := liststrwait + hjks[i].TGroupid+'^';
                       // 9病人代码(brdm)
                       liststrwait := liststrwait + brdm+'^';
                       // 10病人标识、卡号(by4)
                       liststrwait := liststrwait + by4+'^';
                       // 11挂号时间(ghsj)
                       liststrwait := liststrwait + strghsj+'^';
                       // 12预约时间(by7)
                       liststrwait := liststrwait + by7+'^';
                       // 13性别(xb)
                       liststrwait := liststrwait + xb+'^';
                       // 14年龄(nl)
                       liststrwait := liststrwait + nl+'^';
                       // 15门诊号(mzh)
                       liststrwait := liststrwait + mzh+'^';
                       // 16就诊标志(jzbz)
                       liststrwait := liststrwait + jzbz+'^';
                       // 17状态(ztbz)
                       liststrwait := liststrwait + ztbz+'^';
                       // 18记录id(id)
                       liststrwait := liststrwait + jrid+'^';
                       //19首拼(xmsp)
                       liststrwait := liststrwait + xmsp+'^';
                       liststrwait := liststrwait + sjdmc;
                       liststrwait := liststrwait + ';';
                       listwaitnum:=listwaitnum+1;
                     end;
                  end;
                  next;
              end;
            end;
            qr.Close;
         end;
       end
       else
       begin
            ksbrdys := dmdbaccess.GetDBValue('KS',hjks[i].TGroupid,'SelDoctor');
            if ksbrdys='' then ksbrdys:='0';
            if (gblshowallwait=0) and (((ksbrdys='0') and (gblBRDYS=1)) or (ksbrdys='1')) then
            //if gblbrdys=1 then
            begin
                  cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,t_dhxx.yhid,sjdmc from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid in ' + tmphjksstr +
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and (t_dhxx.yhid='''+zdyhid+''''+' or t_dhxx.yhid is null or t_dhxx.yhid='''')'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12)then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     ' order by t_dhxx.sjdbz,ghsj,replicate(''0'',10-len(ghhm))+ghhm ';
            end
            else
            begin
                cmdstr:=' select t_dhxx.id,t_dhxx.kssxid,t_dhxx.brxm,t_dhxx.ghhm,t_yh.yhmc,'+
                     ' t_dhxx.yxjid,t_yxjsz.yxjmc,t_dhxx.jzbz,t_dhxx.ztbz,t_dhxx.by6,t_dhxx.brdm,by4,'+
                     ' by7,mzh,xb,nl,ghsj,xmsp,t_dhxx.yhid,sjdmc from  ' +
                     ' t_dhxx(nolock) left OUTER join t_yxjsz(nolock) on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' +
                     ' left OUTER join t_yh(nolock) on t_dhxx.yhid=t_yh.yhid and t_dhxx.hszh=t_yh.hszh ' +
                     ' left OUTER join t_sjdsz(nolock) on t_dhxx.sjdbz=t_sjdsz.sjdbz and t_dhxx.hszh=t_sjdsz.hszh ' +
                     ' where t_dhxx.ksid in ' + tmphjksstr +
                     ' and not (jzbz=0 and t_dhxx.ztbz=3)'+
                     ' and t_dhxx.hszh=' +inttostr(gblhszh) +
                     ' and datediff(S,t_dhxx.ghsj,getdate())>='+inttostr(gblhjyssj);
                  if (gblShowNoonNumber=0) and (hourof(now)<12) then
                  begin
                     cmdstr := cmdstr+' and ghsj<convert(varchar(10),t_dhxx.ghsj,120)+'' 12:00:00''';
                  end;
                     cmdstr := cmdstr+
                     ' order by t_dhxx.sjdbz,ghsj, replicate(''0'',10-len(ghhm))+ghhm';
            end;
            qr.SQL.Text := cmdstr;
            qr.Open;
            ///////////将中.
            with qr do
            begin
              while not qr.Eof  do
              begin
                  //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                  jrid:=fields.Fields[0].AsString;
                  kssxid:=fields.fields[1].asstring;
                  Brxm:=Fields.Fields[2].AsString;
                  BRXM := ReplaceCallListPatName(BRXM);
                  GHHM:=fields.fields[3].asstring;
                  yhmc:=fields.fields[4].asstring;
                  YXJID:=Fields.Fields[5].asString;
                  yxjmc:=fields.fields[6].asstring;
                  jzbz:=fields.Fields[7].asstring;
                  ztbz:=fields.fields[8].asstring;
                  by6:=fields.fields[9].asstring;
                  brdm :=fields.fields[10].asstring;
                  by4 := fields.fields[11].asstring;
                  by7 := fields.fields[12].asstring;
                  mzh :=fields.fields[13].asstring;
                  xb :=fields.fields[14].asstring;
                  nl :=fields.fields[15].asstring;
                  strghsj := FormatDateTime('hh:nn',fields.fields[16].AsDateTime);
                  xmsp := fields.fields[17].asstring;
                  yhid := fields.fields[18].asstring;
                  sjdmc := fields.fields[19].asstring;
                  blsend := true;
                  if (jzbz='0') and ((gblhjbrpx=4) or (gblhjbrpx=5)) then
                  begin
                    if (yhid<>zdyhid) and (yhid<>'') then
                      blsend := false;
                  end;
                  if blsend then
                  begin
                     //if listwaitnum<99 then
                     begin
                       //1号码(ghhm)，2姓名(brxm)
                       liststrwait := liststrwait +ghhm+spaces(4-length(ghhm)) +' '+'^'+
                                brxm+spaces(8-length(brxm))+'^';
                       //3科室(ksmc)
                       liststrwait := liststrwait + hjks[i].TGroupName+spaces(8-length(hjks[i].TGroupName))+'^';
                       //4类别(by6)
                       liststrwait := liststrwait + by6+spaces(8-length(by6))+'^';//+spaces(8-length(by6));
                       //5优先级(yxjmc)
                       liststrwait:=liststrwait+yxjmc+spaces(8-length(yxjmc))+'^';//+spaces(8-length(yxjmc));
                       //6医生姓名(ysxm)
                       liststrwait := liststrwait +yhmc+spaces(8-length(yhmc))+'^';//+spaces(8-length(yhmc));
                       //7状态（ztmc)
                       if JZBZ='2' then //未激活
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'
                       else if JZBZ='1' then //等待中
                       begin
                         if ztbz ='1' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'
                         else if ztbz='2' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'
                         Else If ztbz= '5' Then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'
                         Else
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';
                       end
                       else if JZBZ='0' then //已呼叫
                       begin
                         if ztbz='7' then
                          liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'
                         else if ztbz='3' then
                          liststrwait := liststrwait +GetStrWithnotBadCode('已弃号',8)+'^'
                         else
                          liststrwait := liststrwait +GetStrWithnotBadCode('已呼叫',8)+'^'
                       end;
  //                     If Ztbz = '1' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_cz,8)+'^'//  ttl_cz +spaces(8-length(ttl_cz))
  //                     Else If ztbz= '2' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_fz,8)+'^'//  ttl_fz + spaces(8-length(ttl_fz))
  //                     Else If ztbz= '5' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_zb,8)+'^'//  '准  备' + spaces(8-length('准  备'))
  //                     Else If ztbz= '6' Then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weijihuo,8)+'^'//  '未激活' + spaces(8-length('未激活'))
  //                     else if ztbz='7' then
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_yiwancheng,8)+'^'//  '已完成' + spaces(8-length('已完成'))
  //                     Else
  //                        liststrwait := liststrwait +GetStrWithnotBadCode(ttl_weihujiao,8)+'^';// '未呼叫'+ spaces(8-length('未呼叫'));
                       //8科室代码 (ksid)
                       liststrwait := liststrwait + hjks[i].TGroupid+'^';
                       // 9病人代码(brdm)
                       liststrwait := liststrwait + brdm+'^';
                       // 10病人标识、卡号(by4)
                       liststrwait := liststrwait + by4+'^';
                       // 11挂号时间(ghsj)
                       liststrwait := liststrwait + strghsj+'^';
                       // 12预约时间(by7)
                       liststrwait := liststrwait + by7+'^';
                       // 13性别(xb)
                       liststrwait := liststrwait + xb+'^';
                       // 14年龄(nl)
                       liststrwait := liststrwait + nl+'^';
                       // 15门诊号(mzh)
                       liststrwait := liststrwait + mzh+'^';
                       // 16就诊标志(jzbz)
                       liststrwait := liststrwait + jzbz+'^';
                       // 17状态(ztbz)
                       liststrwait := liststrwait + ztbz+'^';
                       // 18记录id(id)
                       liststrwait := liststrwait + jrid+'^';
                       //19首拼(xmsp)
                       liststrwait := liststrwait + xmsp+'^';
                       liststrwait := liststrwait + sjdmc;
                       liststrwait := liststrwait + ';';
                       listwaitnum:=listwaitnum+1;
                     end;
                  end;
                  next;
              end;
            end;
            qr.Close;

       end;
       if (listwaitnum>0)  then
       begin
          //result:=zdid + 'DD01'  + format('%4D',[listwaitnum]) + liststrwait;
          result:=zdid + 'DD11'  + format('%4D',[listwaitnum]) + liststrwait;
          //临时修改，九院20160628
          //result:=zdid + 'DD01'  + format('%4D',[listwaitnum]) + liststrwait;
       end
       else
       begin
          result:=zdid +'DD'  +'000000'  ;
       end;
     end
     else
        result:=zdid +'DD'  +'000000'  ;
     //qr.Free;
     exit;
  except
    begin
      result := zdid + cmd + '068888';  ///有错误发生.
      //qr.Free;
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
end;
//YHChangeVolue//
//功能：修改呼叫终端对应的小屏音量//
//参数:zdid 终端编号
//cmd 命令字
// avolue 音量大小 ,10~100.
//
//示例:
//http://192.168.2.59:9090/SetVolumn?volumn=30
//
//
//volumn= 0..100

function TdmDBAccess.YHChangeVolue(const zdid, cmd,
  avolue: string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
   i :integer;
   hjksnum:integer;
   hjks :array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   cmdstrks:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   tmpghhm:string;
   by6:string;
   ksbrdys:string;
   nextdelay:integer;
   qr:TADOQuery;
   hostip:string;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection :=ADOConnection;
  try
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc'+
                            ',case when recalltime is NULL then 999999 else '+
                            ' datediff(s,recalltime,getdate()) end as nextdelay'+
                            ' from t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    try
      qr.Open;
    except
      qr.sql.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc'+
                            ',999999 as nextdelay'+
                            ' from t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;

      qr.Open;
    end;
    ///////////
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          nextdelay :=fields.Fields[7].AsInteger;
          if ( zdyhid <>'')  then
          begin
            //已经登录
          end
          else
          begin
             if (cmd='33') or (cmd='66') then
             result:=zdid+cmd + '还没有登录!    请登录工号'
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
          end;
       end
       else
       begin
           if (cmd='33') or (cmd='66') then
           result:=zdid+cmd + '无此呼叫器!    请管理员设置!'
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
           close;
       end
       else
       begin
         if (cmd='33') or (cmd='66') then
            result:=zdid+cmd + '未设置此工号!  请管理员设置!'
         else
         result:=zdid + cmd + '008888';  //没有此用户号
         Close;
         exit;
       end;
    end;
    //修改呼叫终端状态
    try
      adoconnection.Execute('update t_hjzd set state=''改音量'''+
        ',calltime=getdate(),recalltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
    except
      adoconnection.Execute('update t_hjzd set state=''改音量'''+
        ',calltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
    end;
    ////查找呼叫终端对应的小屏ip地址//
    qr.SQL.Clear;
    qr.Parameters.Clear;
    qr.SQL.Text :='select hostip from t_hjzd_scr h,t_screen s '+
        'where h.hszh=:p1 and h.screenid=s.screenid and h.hszh=s.hszh '+
        'and hjzdid=:p2';
    qr.Parameters.ParamByName('p1').Value := gblhszh;
    qr.Parameters.ParamByName('p2').Value := zdid;
    qr.Open;
    if qr.Eof then
    begin
      result := zdid + cmd + '068888';  ///没有小屏
    end
    else
    begin
      //修改对应小屏音量
      hostip := qr.fieldbyname('hostip').asstring;
      if ChangeHostVolue(hostip,avolue) then
      begin
        result := zdid + cmd + '016666';  //修改成功
      end
      else
        result := zdid + cmd + '068888';  ///有错误发生.
    end;

  except
    begin
      if (cmd='33') or (cmd='66') then
      result:=zdid +cmd  +'音量失败!      '+'音量时有错误!'
      else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;


function TdmDBAccess.YHChangecheckinshow(const zdid, cmd,
  avolue: string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
   i :integer;
   hjksnum:integer;
   hjks :array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   cmdstrks:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   tmpghhm:string;
   by6:string;
   ksbrdys:string;
   nextdelay:integer;
   qr:TADOQuery;
   hostip:string;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection :=ADOConnection;
  try
    result:='';
    iscall:=false;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc'+
                            ',case when recalltime is NULL then 999999 else '+
                            ' datediff(s,recalltime,getdate()) end as nextdelay'+
                            ' from t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    try
      qr.Open;
    except
      qr.sql.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc'+
                            ',999999 as nextdelay'+
                            ' from t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;

      qr.Open;
    end;
    ///////////
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          nextdelay :=fields.Fields[7].AsInteger;
          if ( zdyhid <>'')  then
          begin
            //已经登录
          end
          else
          begin
             if (cmd='33') or (cmd='66') then
             result:=zdid+cmd + '还没有登录!    请登录工号'
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
          end;
       end
       else
       begin
           if (cmd='33') or (cmd='66') then
           result:=zdid+cmd + '无此呼叫器!    请管理员设置!'
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
           close;
       end
       else
       begin
         if (cmd='33') or (cmd='66') then
            result:=zdid+cmd + '未设置此工号!  请管理员设置!'
         else
         result:=zdid + cmd + '008888';  //没有此用户号
         Close;
         exit;
       end;
    end;
    //修改呼叫终端状态
    try
      adoconnection.Execute('update t_hjzd set state=''改医生显示'''+
        ',calltime=getdate(),recalltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
    except
      adoconnection.Execute('update t_hjzd set state=''改医生显示'''+
        ',calltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
    end;
    qr.SQL.Clear;
    qr.Parameters.Clear;
    qr.SQL.Text :='update t_hjzd set checkinshow='+avolue+
        'where hszh=:p1 and zdid=:p2';
    qr.Parameters.ParamByName('p1').Value := gblhszh;
    qr.Parameters.ParamByName('p2').Value := zdid;
    qr.ExecSQL;
    result := zdid + cmd + '016666';  //修改成功
  except
    begin
      if (cmd='33') or (cmd='66') then
      result:=zdid +cmd  +'修改失败!      '+'显示时有错误!'
      else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;

//向终端发出修改音量命令//
//参数:hostip 终端IP
//avolue 音量大小 0-100)
//返回值：true 成功
//false 失败

function TdmDBAccess.ChangeHostVolue(const hostip,
  avolue: string): boolean;
var
  ClientSocket1 :TClientSocket;
  s:string;
  sendtime:Tdatetime;
begin
  try
   try
     ClientSocket1 := TclientSocket.Create(nil);
     ClientSocket1.Host :=hostip;
     ClientSocket1.Port :=9090;
     ClientSocket1.ClientType := ctBlocking;
     ClientSocket1.Active := True;
     if ClientSocket1.Socket.Connected then
     begin
       //SetVolumn?volumn=30

       ClientSocket1.Socket.SendText('POST/SetVolumn?volumn='+avolue+' HTTP/1.1');
       sendtime :=now;
       while (ClientSocket1.Socket.ReceiveLength<=0) and ((now-sendtime)*24*60*60<2) do
       begin
         application.ProcessMessages;
         Sleep(5);
       end;
       s := ClientSocket1.Socket.ReceiveText();
       result := true;
     end;
     ClientSocket1.close;
   except
     result := false;
   end;
  finally
    freeandnil(clientsocket1);
  end;
end;

function TdmDBAccess.GetPrepareInfo(const ahszh: integer; agroupid,
  adocid: string): string;
var
  qr:TADOQuery;
  str:string;
begin
  Result :='';
  qr := TADOQuery.Create(nil);
  qr.Connection := ADOConnection;
  try
    qr.SQL.Text :=' select  ghhm,brxm,brdm  from  ' +
          ' t_dhxx ' +
          ' where ksid=:p1'+
          ' and jzbz=1' +
          ' and ztbz=5'+
          ' and hszh=:p3'+
          ' and (yhid is null or yhid='''' or yhid=:p4)'+
          ' order by kssxid';
    qr.Parameters.ParamByName('p1').Value := agroupid;
    qr.Parameters.ParamByName('p3').Value := ahszh;
    qr.Parameters.ParamByName('p4').Value := adocid;
    qr.Open;
    str :='';
    while not qr.Eof do
    begin
      str  :=str+qr.fieldbyname('ghhm').AsString+','+qr.fieldbyname('brdm').AsString+';';
      qr.Next;
    end;
    qr.Close;
    result := str;
  finally
      FreeAndNil(qr);
  end;
end;
function TdmDBAccess.GetTZSBCardNO:String;
var
  ps:pchar;
  kh:string;
  intret:integer;
  h:Thandle;
  //ReadSocialCardInfo:function(OutData:Pchar):integer; stdcall;
begin
//    try
//      h := LoadLibrary('SMK_JY.dll');
//    except
//      result :='';
//      exit;
//    end;

//    try
//      //if h>32 then
//      begin
//        //ReadSocialCardInfo := GetProcAddress(h, 'ReadSocialCardInfo');
//        ps := allocmem(255);
//        intret:= ReadSocialCardInfo(ps);
//        if intret<0 then
//        begin
//          //showmessage('调用成功,读卡错误:'+ps);
//          result :='';
//        end
//        else
//        begin
//          kh := ps; //
//          if (getpartstr(kh,'1')='1') then    //新医保卡
//          begin
//            kh := getpartstr(kh+'|','4');
//          end
//          else //老医保卡
//          begin
//             kh := getpartstr(kh+'|','2');  //取到第二个区的号码
//             kh := trim(copy(kh,1,19)); //取前19位卡号，去空格。
//          end;
//          result :=kh;
//          //showmessage('调用成功,内容:'+'卡号:'+kh+ ' '+ps);
//        end;
//        freemem(ps);
//      end
////      else
////      begin
////        result :='';
////        exit;
////      end;
//    except //finally
//      result :='';
//      //freelibrary(h);
//    end;
end;
function TdmDBAccess.GetNBSBCardNO:String;
var
  ps:pchar;
  kh:string;
  h:Thandle;
  //SendRcv2: function(const para1:pchar;const para2:pchar;para3:pchar):pchar; stdcall;//  ok
  proc_carddata:function():LPSTR;stdcall;
begin
    try
      h := LoadLibrary('YB_Card.dll');
    except
      result :='';
      exit;
    end;
    try
      if h>32 then
      begin
        proc_carddata := GetProcAddress(h, 'Carddata_Read');
        ps := proc_carddata();
        if pos('读卡错误',ps)>0 then
        begin
          //showmessage('调用成功,读卡错误:'+ps);
          result :='';
        end
        else
        begin
          kh := copy(ps,1,9);
          result :=kh;
          //showmessage('调用成功,内容:'+'卡号:'+kh+ ' '+ps);
        end;
      end
      else
      begin
        result :='';
        exit;
      end;
    finally
      freelibrary(h);
    end;
end;
Function Tdmdbaccess.GetSBYYJKKCardNO():string;
var
  str : string;
  h:Thandle;
  h2:Thandle;
  klb,gfbb,fkjgmc,fkjgdm,fkjgzs,fksj,kh,aqm,xpxlh,yycsdm:pchar;
  cardno:string;
  ir:integer;
  jj:array[0..5] of byte;
  i:integer;
  kk:array[0..15] of byte;
  outlen:integer;
begin
  result :='';
  //由于需要 vc++运行环境，暂时去除//2018-10-29 wugang
//  try
//    ir :=-1;
//    h:=opendevice(0);  //先读新的健康卡
//    if h>0 then
//    begin
//       getmem(klb,255);
//       getmem(gfbb,255);
//       getmem(fkjgmc,255);
//       getmem(fkjgdm,255);
//       getmem(fkjgzs,512);
//       getmem(fksj,255);
//       getmem(kh,255);
//       getmem(aqm,255);
//       getmem(xpxlh,255);
//       getmem(yycsdm,255);
//       //SendAPDU(h,0,
//       ir := iR_DDF1EF05Info(h,klb,gfbb,fkjgmc,fkjgdm,fkjgzs,fksj,kh,aqm,xpxlh,yycsdm);
//       if ir=0 then
//       begin
//         cardno :=kh;
//         cardno := copy(cardno,1,18);
//       end;
//       freemem(klb);
//       freemem(gfbb);
//       freemem(fkjgmc);
//       freemem(fkjgdm);
//       freemem(fkjgzs);
//       freemem(fksj);
//       freemem(kh);
//       freemem(aqm);
//       freemem(xpxlh);
//       freemem(yycsdm);
//    end;
//    if h>0 then
//    begin
//       closedevice(h);
//       h:=0;
//    end;
//    if ir<>0 then   //如果没有读到卡则读老卡
//    begin
//      cardno :='';
//      h2:=TF_OpenReader(1,9600,1);
//      if h2>0 then
//      begin
//         for i:=0 to 5 do
//         begin
//           jj[i]:=255;
//         end;
//         outlen:=4;
//         ir := TF_Mifare_Auth(h2,96,4,jj);
//         if ir=0 then
//         begin
//           ir :=TF_Mifare_Read (h2,4,kk);
//           if ir=0 then
//           begin
//             for i:=0 to 4 do
//             begin
//               cardno :=cardno+inttohex(kk[i],2);
//             end;
//           end;
//         end
//      end;
//      if h2>0 then
//      begin
//         TF_CloseReader(h2);
//         h2:=0;
//      end;
//    end;
//    if ir=0 then
//      result := cardno
//    else
//      result :='';
//  except  //出错处理
//    result :='';
//  end;
end;
//读宁波建康卡
function TdmDBAccess.GetNBJKKCardNO:String;
var
  ps:pchar;
  kh:string;
  h:Thandle;
 key:array[0..12]of char;
 snr1:array[0..10]of char;
 skey:array[0..6]of char;
 sRecData:array[0..11]of char;
 RecData:array[0..22]of char;
 sdata:array[0..32]of char;
 sWriteData:array[0..16]of char;
 val:array[0..3]of char ;
  //SendRcv2: function(const para1:pchar;const para2:pchar;para3:pchar):pchar; stdcall;//  ok
  //proc_carddata:function():LPSTR;stdcall;
  //handle
  icdev:longint;
  //fuction return value
  st:integer;
  brlen:smallint;
	rlen:word;

	data:array[0..39]of char;
  snr:array[0..39]of char;
  senddataasc:array[0..10]of char;   //获取随机数,ASC码形式
	senddata:array[0..5]of char;   //获取随机数
	datarecv:array[0..255]of char;
  datarecvasc:array[0..511]of char;
	dataa:array[0..79]of char;
  sbkey:string;
  ini:tinifile;
  i:integer;
//  function hex_asc(sHex:pchar;sAsc:pchar;ulLength:longint):smallint;stdcall;far;external 'mt_32.dll'name 'hex_asc';
//  function asc_hex(sAsc:pchar;sHex:pchar;ulLength:longint):smallint;stdcall;far;external 'mt_32.dll'name 'asc_hex';
//  function open_device(nPort:byte;ulBaud:dword):longint;stdcall;far;external 'mt_32.dll'name 'open_device';
//  function close_device(icdev:longint):smallint;stdcall;far;external 'mt_32.dll'name 'close_device';
//  //M1 Card//
//  function rf_card(icdev:longint;mode:byte;snr:pchar):smallint;stdcall;far;external 'mt_32.dll'name 'rf_card';
//  function rf_authentication_key(icdev:longint;mode:byte;add:byte;key:pchar):smallint;stdcall;far;external 'mt_32.dll'name 'rf_authentication_key';
//  function rf_read(icdev:longint;add:byte;data:pchar):smallint;stdcall;far;external 'mt_32.dll'name 'rf_read';
//  function rf_write(icdev:longint;add:byte;data:pchar):smallint;stdcall;far;external 'mt_32.dll'name 'rf_write';
//  function rf_initval(icdev:longint;add:byte;val:longint):smallint;stdcall;far;external 'mt_32.dll'name 'rf_initval';
//  function rf_decrement(icdev:longint;add:byte;val:longint):smallint;stdcall;far;external 'mt_32.dll'name 'rf_decrement';
//  function rf_increment(icdev:longint;add:byte;val:longint):smallint;stdcall;far;external 'mt_32.dll'name 'rf_increment';
//  function rf_readval(icdev:longint;add:byte;val:pchar):smallint;stdcall;far;external 'mt_32.dll'name 'rf_readval';

   hex_asc:function(sHex:pchar;sAsc:pchar;ulLength:longint):smallint;stdcall;
   asc_hex:function(sAsc:pchar;sHex:pchar;ulLength:longint):smallint;stdcall;
   open_device:function(nPort:byte;ulBaud:dword):longint;stdcall;
   close_device:function(icdev:longint):longint;stdcall;
   rf_card:function(icdev:longint;mode:byte;snr:pchar):smallint;stdcall;
   rf_authentication_key:function(icdev:longint;mode:byte;add:byte;key:pchar):smallint;stdcall;
   rf_read:function(icdev:longint;add:byte;data:pchar):smallint;stdcall;
begin
    result :='';
    try
      h := LoadLibrary('mt_32.dll');
    except
      result :='';
      exit;
    end;
    try
      if h>32 then
      begin
          sbkey := '008605748918';
          try
            ini:=tinifile.Create(ExtractFilepath(ParamStr(0))+'set.ini');
            sbkey:=ini.ReadString('SYS','SheBaokey','008605748918');
            ini.Free;
          except
          end;
          hex_asc := GetProcAddress(h, 'hex_asc');
          asc_hex := GetProcAddress(h, 'asc_hex');
          open_device := GetProcAddress(h, 'open_device');
          close_device := GetProcAddress(h, 'close_device');
          rf_card := GetProcAddress(h, 'rf_card');
          rf_authentication_key := GetProcAddress(h, 'rf_authentication_key');
          rf_read := GetProcAddress(h, 'rf_read');

          icdev:=open_device(0,115200);
          if(icdev > 0) then  //连接成功
          begin
           st:=rf_card(icdev,0,snr1);
           if st=0 then  //寻卡成功//
           begin
//             if(st<>0) then
//                //ListInfo.Items.Add('M1卡寻卡失败!')
//                result :=''
//             else
//                ListInfo.Items.Add('M1卡寻卡成功!');

             for i:=0 to 12 do
             begin
               if i<=length(sbkey) then
                 key[i]:=sbkey[i+1];//'ffffffffffff';
             end;
             asc_hex(key,skey,12);
             st:=rf_authentication_key(icdev,0,4,skey);
             if st=0 then  //认证成功
               begin
  //             if(st<>0) then
  //                ListInfo.Items.Add('M1卡密码认证失败!')
  //             else
  //                ListInfo.Items.Add('M1卡密码认证成功!');

               st:=rf_read(icdev,4,sRecData);
               if(st=0) then //读卡成功
                begin
//                  hex_asc(sRecData,RecData,255);
                  result :=srecdata;
                  result :=copy(result,1,12);
//                  ListInfo.Items.Add('M1卡读数据成功,数据:');
//                  ListInfo.Items.Add(RecData);
                end;

    //           sdata:='000102030405060708090a0b0c0d0e0f';
    //           asc_hex(sdata,sWriteData,32);
    //           st:=rf_write(icdev,48,sWriteData);
    //           if(st<>0) then
    //              ListInfo.Items.Add('M1卡写数据失败!')
    //           else
    //              ListInfo.Items.Add('M1卡写数据成功!');
  //               st:=rf_initval(icdev,48,100);
  //               if(st<>0) then
  //                  ListInfo.Items.Add('M1卡初始化失败!')
  //               else
  //                  ListInfo.Items.Add('M1卡初始化成功!');
    //           st:=rf_decrement(icdev,48,10);
    //           if(st<>0) then
    //              ListInfo.Items.Add('M1卡减值失败!')
    //           else
    //              ListInfo.Items.Add('M1卡减值成功!');
    //           st:=rf_increment(icdev,48,10);
    //           if(st<>0) then
    //              ListInfo.Items.Add('M1卡加值失败!')
    //           else
    //              ListInfo.Items.Add('M1卡加值成功!');
    //           st:=rf_readval(icdev,48,val);
    //           if(st<>0) then
    //              ListInfo.Items.Add('M1卡读值失败!')
    //           else
    //              ListInfo.Items.Add('M1卡读值成功!');
              end;
            end;
          end;
          st:=close_device(icdev);
//          if(st <> 0) then
//            ListInfo.Items.Add('断开连接失败!')
//          else
//            ListInfo.Items.Add('断开连接成功!');
            icdev:=0;
      end
      else
      begin
        result :='';
        exit;
      end;
    finally
      freelibrary(h);
    end;
end;
function TdmDBAccess.GetLSSBCardNo: String;
var
//  Dll_IC_InitComm:Function(port:integer):longint; stdcall;
//  Dll_IC_ExitComm:Function(icdev:longint):integer;stdcall;
//  Dll_IC_CpuReset_Hex:Function(icdev:longint;relen:smallint;data:pchar):integer;stdcall;
//  Dll_IC_CpuApdu_Hex:Function(icdev:longint;selen:smallint;sdata:pchar;relen:smallint;data:pchar):integer;stdcall;
//  Dll_IC_InitType:Function(icdev:longint;ictype:smallint):integer;stdcall;
  iInitComm:longint;
  sitype:smallint;
  rele:smallint;
  redata:pchar;
  //rid:pchar;
  cardid:string;
  hDll: THandle;
begin
  //result :='';
(*
 //初始化USB端口
 iInitComm:=IC_InitComm(101);

 try
   getmem(redata,2048);
   if iInitComm<0 then
   begin
     result :='';
     exit;
   end;
   //设置卡类型
   sitype:=IC_InitType(iInitComm,12);
   if sitype<>0 then
   begin
     result :='';
     exit;
   end;
 //cpu卡复位
   sitype:=IC_CpuReset_Hex(iInitComm,rele,redata);
   if sitype<>0 then
   begin
     //读附卡座
     sitype:=IC_InitType(iInitComm,13);
     if sitype<>0 then
     begin
       result :='';
       exit;
     end;
     sitype:=IC_CpuReset_Hex(iInitComm,rele,redata);
     if sitype<>0 then
     begin
       result :='';
       exit;
     end;
   end;
   //发命令
   sitype:=IC_CpuApdu_Hex(iInitComm,7,'00A40000023F00',rele,redata);
   if sitype<>0 then
   begin
     result :='';
     exit;
   end;
   sitype:=IC_CpuApdu_Hex(iInitComm,20,'00A404000F7378312E73682EC9E7BBE1B1A3D5CF',rele,redata);
   if sitype<>0 then
   begin
     result :='';
     exit;
   end;
   //选择EF06区数据.
   sitype:=IC_CpuApdu_Hex(iInitComm,7,'00A4020002EF06',rele,redata);
   if sitype<>0 then
   begin
     result :='';
     exit;
   end;
   //读取身份证号码
   sitype:=IC_CpuApdu_Hex(iInitComm,5,'00B2080014',rele,redata);
   if sitype<>0 then
   begin
     result :='';
     exit;
   end;

   cardid := redata;
   cardid := copy(cardid,5,length(cardid)-8);
   hex2asc(cardid,cardid,length(cardid) div 2);
   //list1.Items.Add('身份证号码:'+cardid);
   //hex2asc(recdata[4],information,rlen*2-8);
   result := cardid;
 finally
    if iInitComm>=0 then
    begin
      IC_ExitComm(iInitComm);
      iInitComm:=0;
    end;
   freemem(redata);
 end;
 *)

 {
  hDll := LoadLibrary('dcic32.dll');
  //hdll :=33;
  if hDll >= 32 then  //如果Dll无法加载则跳出
  begin
    Dll_IC_InitComm := GetProcAddress(hDll, 'IC_InitComm');
    Dll_IC_ExitComm:= GetProcAddress(hDll, 'IC_ExitComm');
    Dll_IC_CpuReset_Hex:= GetProcAddress(hDll, 'IC_CpuReset_Hex');
    Dll_IC_CpuApdu_Hex:= GetProcAddress(hDll, 'IC_CpuApdu_Hex');
    Dll_IC_InitType:= GetProcAddress(hDll, 'IC_InitType');
   //初始化USB端口
   iInitComm:=Dll_IC_InitComm(101);
   try
     getmem(redata,2048);
     addlog('cardlog.txt','GetLSSBCardNo-Dll_IC_InitComm!'+vartostr(iInitComm));
     if iInitComm<0 then
     begin
       result :='';
       exit;
     end;
     //设置卡类型
     sitype:=Dll_IC_InitType(iInitComm,12);
     addlog('cardlog.txt','GetLSSBCardNo-Dll_IC_InitType!'+vartostr(sitype));
     if sitype<>0 then
     begin
       result :='';
       exit;
     end;
   //cpu卡复位
     sitype:=Dll_IC_CpuReset_Hex(iInitComm,rele,redata);
     addlog('cardlog.txt','GetLSSBCardNo-Dll_IC_CpuReset_Hex!'+vartostr(sitype));
     if sitype<>0 then
     begin
       //读附卡座
       sitype:=Dll_IC_InitType(iInitComm,13);
       addlog('cardlog.txt','GetLSSBCardNo-Dll_IC_InitType2!'+vartostr(sitype));
       if sitype<>0 then
       begin
         result :='';
         exit;
       end;
       sitype:=Dll_IC_CpuReset_Hex(iInitComm,rele,redata);
       addlog('cardlog.txt','GetLSSBCardNo-Dll_IC_CpuReset_Hex2!'+vartostr(sitype));
       if sitype<>0 then
       begin
         result :='';
         exit;
       end;
     end;
     //发命令
     sitype:=Dll_IC_CpuApdu_Hex(iInitComm,7,'00A40000023F00',rele,redata);
     addlog('cardlog.txt','GetLSSBCardNo-Dll_IC_CpuApdu_Hex1!'+vartostr(sitype));
     if sitype<>0 then
     begin
       result :='';
       exit;
     end;
     sitype:=Dll_IC_CpuApdu_Hex(iInitComm,20,'00A404000F7378312E73682EC9E7BBE1B1A3D5CF',rele,redata);
     addlog('cardlog.txt','GetLSSBCardNo-Dll_IC_CpuApdu_Hex2!'+vartostr(sitype));
     if sitype<>0 then
     begin
       result :='';
       exit;
     end;
     //选择EF06区数据.
     sitype:=Dll_IC_CpuApdu_Hex(iInitComm,7,'00A4020002EF06',rele,redata);
     addlog('cardlog.txt','GetLSSBCardNo-Dll_IC_CpuApdu_Hex3!'+vartostr(sitype));
     if sitype<>0 then
     begin
       result :='';
       exit;
     end;
     //读取身份证号码
     sitype:=Dll_IC_CpuApdu_Hex(iInitComm,5,'00B2080014',rele,redata);
     addlog('cardlog.txt','GetLSSBCardNo-Dll_IC_CpuApdu_Hex4!'+vartostr(sitype));
     if sitype<>0 then
     begin
       result :='';
       exit;
     end;

     cardid := redata;
     cardid := copy(cardid,5,length(cardid)-8);
     hex2asc(cardid,cardid,length(cardid) div 2);
     addlog('cardlog.txt','GetLSSBCardNo-hex2asc!'+cardid);
     //list1.Items.Add('身份证号码:'+cardid);
     //hex2asc(recdata[4],information,rlen*2-8);
     result := cardid;
   finally
      if iInitComm>=0 then
      begin
        Dll_IC_ExitComm(iInitComm);
        addlog('cardlog.txt','GetLSSBCardNo-Dll_IC_ExitComm!');
        iInitComm:=0;
      end;
     freemem(redata);
   end;
  end;
  }
end;
function TdmDBAccess.hex2asc(strhex: string; var strasc: string;
  len: integer): integer;
var
  i:integer;
  h:string;
  a:string;
  rstr :string;
begin
  for i:=0 to len-1 do
  begin
    h:=copy(strhex,i*2+1,2);
    a := chr(strtoint('$'+h));
    rstr := rstr+a;
  end;
  strasc := rstr;
  result := 0;
end;
//设置//
//参数:hostip 终端IP
//avolue 音量大小 0-100)
//返回值：true 成功
//false 失败
function TdmDBAccess.DB_SetGroupPreparePos(const agroupcode:string;aid:string;
  aoldpos:integer;anewpos:integer): boolean;
var
  qry:Tadoquery;
begin
  result := true;
  qry := TADOQuery.Create(nil);
  try
    try
      qry.Connection := ADOConnection;
      qry.SQL.Text :='update t_dhxx set kssxid=kssxid+1'+
        ' where kssxid>=:p1 and ksid=:p2 and hszh=:p3 and jzbz<>0'+
        ' and kssxid<:p4';
      qry.Parameters.ParamByName('p1').Value := anewpos;
      qry.Parameters.ParamByName('p2').Value := agroupcode;
      qry.Parameters.ParamByName('p3').Value := gblhszh;
      qry.Parameters.ParamByName('p4').Value := aoldpos;
      qry.ExecSQL;
      qry.Close;
      qry.SQL.Clear;
      qry.Parameters.Clear;
      qry.SQL.Text :='update t_dhxx set kssxid=:p1'+
        ' where id=:p2';
      qry.Parameters.ParamByName('p1').Value := anewpos;
      qry.Parameters.ParamByName('p2').Value := aid;
      qry.ExecSQL;
      qry.Close;

      result := true;
    except
      result := false;
    end;
  finally
    freeandnil(qry);
  end;

end;

//返回值说明:
//-1表示出错
//0-表示没有数据
//>0 表示有多条数据
function TdmDBAccess.getPatInfobyBrdm(const abrdm: string;
  const aksdm:string;
  var patinfo: array of Print_Info): integer;
var
  qry:Tadoquery;
  i:integer;
begin
  result := 0;
  qry := TADOQuery.Create(nil);
  try
    try
      qry.Connection := ADOConnection;
      qry.SQL.Add(' select kssxid,brxm,ghhm,t_dhxx.ksid,t_ks.ksmc,t_YH.yhmc,t_jzzt.ztmc,t_yxjsz.yxjmc,'+
        'ghsj,t_dhxx.id,t_dhxx.by4,t_dhxx.by6,t_dhxx.by7,s.sjdmc from  ');
      qry.SQL.Add(' t_dhxx left OUTER join t_ks on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh ');
      qry.SQL.Add(' left OUTER join t_YH on t_dhxx.yhid=t_YH.yhid and t_dhxx.hszh=t_YH.hszh ');
      qry.SQL.Add(' left OUTER join t_jzzt on t_dhxx.ztbz=t_jzzt.ztbz and t_dhxx.hszh=t_jzzt.hszh');
      qry.SQL.Add(' left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' );
      qry.SQL.Add(' left OUTER join t_sjdsz s on t_dhxx.sjdbz=s.sjdbz and t_dhxx.hszh=s.hszh ' );
      qry.SQL.Add(' where t_dhxx.brdm=:p1 and t_dhxx.jzbz<>0 and t_dhxx.hszh=:p2');
      if (aksdm<>'') then
      begin
        qry.SQL.Add(' and t_dhxx.ksid=:p3');
      end;
      qry.SQL.Add(' order by t_dhxx.ksid,t_dhxx.kssxid ');
      qry.Parameters.ParamByName('p1').Value := abrdm;
      qry.Parameters.ParamByName('p2').Value := gblhszh;
      if (aksdm<>'') then
      begin
        qry.Parameters.ParamByName('p3').Value := aksdm;
      end;
      qry.Open;
      if qry.Eof then
        result :=0
      else
      begin
        result := qry.RecordCount;
        i:=0;
        while not qry.Eof do
        begin
          patinfo[i].TQno := qry.fieldbyname('ghhm').AsString;
          patinfo[i].TGroupCode := qry.fieldbyname('ksid').AsString;
          patinfo[i].TGroupName := qry.fieldbyname('ksmc').AsString;
          patinfo[i].TCustName := qry.fieldbyname('brxm').AsString;
          patinfo[i].TCustNo := abrdm;
          patinfo[i].TWaitNum := qry.fieldbyname('kssxid').AsString;
          qry.Next;
          i:=i+1;
        end;
      end;
    except
      result := -1;
    end;
  finally
    freeandnil(qry);
  end;

end;
//得到当前呼叫终端最后呼叫的病人信息//
//返回值说明:
//-1表示出错
//0-表示没有数据
//>0 表示有多条数据
function TdmDBAccess.getYHCallPatInfo(const azdid: string;
  var patinfo:Print_Info): integer;
var
  qry:Tadoquery;
  i:integer;
begin
  result := 0;
  qry := TADOQuery.Create(nil);
  try
    try
      qry.Connection := ADOConnection;
      qry.SQL.Add(' select top 1 kssxid,brdm,brxm,ghhm,t_dhxx.ksid,t_ks.ksmc,t_YH.yhmc,t_jzzt.ztmc,t_yxjsz.yxjmc,'+
        'ghsj,t_dhxx.id,t_dhxx.by4,t_dhxx.by6,t_dhxx.by7,s.sjdmc from  ');
      qry.SQL.Add(' t_dhxx left OUTER join t_ks on t_dhxx.ksid=t_ks.ksid and t_dhxx.hszh=t_ks.hszh ');
      qry.SQL.Add(' left OUTER join t_YH on t_dhxx.yhid=t_YH.yhid and t_dhxx.hszh=t_YH.hszh ');
      qry.SQL.Add(' left OUTER join t_jzzt on t_dhxx.ztbz=t_jzzt.ztbz and t_dhxx.hszh=t_jzzt.hszh');
      qry.SQL.Add(' left OUTER join t_yxjsz on t_dhxx.yxjid=t_yxjsz.yxjid and t_dhxx.hszh=t_yxjsz.hszh ' );
      qry.SQL.Add(' left OUTER join t_sjdsz s on t_dhxx.sjdbz=s.sjdbz and t_dhxx.hszh=s.hszh ' );
      qry.SQL.Add(' where jzbz=0 and t_dhxx.hszh=:p2');
      qry.SQL.add(' and t_dhxx.yhid=(select top 1 yhid from t_hjzd where hszh=:p3 and zdid=:p4)');
      qry.SQL.add(' order by jzsj desc');
      qry.Parameters.ParamByName('p2').Value := gblhszh;
      qry.Parameters.ParamByName('p3').Value := gblhszh;
      qry.Parameters.ParamByName('p4').Value := azdid;
      qry.Open;
      if qry.Eof then
        result :=0
      else
      begin
        result := qry.RecordCount;
        i:=0;
        if  not qry.Eof then
        begin
          patinfo.TQno := qry.fieldbyname('ghhm').AsString;
          patinfo.TGroupCode := qry.fieldbyname('ksid').AsString;
          patinfo.TGroupName := qry.fieldbyname('ksmc').AsString;
          patinfo.TCustName := qry.fieldbyname('brxm').AsString;
          patinfo.TCustNo := qry.fieldbyname('brdm').AsString;;
          patinfo.TWaitNum := qry.fieldbyname('kssxid').AsString;
        end;
      end;
    except
      result := -1;
    end;
  finally
    freeandnil(qry);
  end;

end;
function TdmDBAccess.isLogin(const azdid, ayhid: string;
  var yhxm:string;var ksmc:string): boolean;
var
  qry:Tadoquery;
  i:integer;
begin
  result := false;
  qry := TADOQuery.Create(nil);
  try
    try
      qry.Connection := ADOConnection;
      qry.SQL.Add(' select a.zdid,a.yhid,b.yhmc from t_hjzd a,t_yh b' );
      qry.SQL.Add(' where a.hszh=b.hszh and a.yhid=b.yhid and a.zdid=:p1 and a.hszh=:p2 and a.yhid=:p3');
      qry.Parameters.ParamByName('p1').Value := azdid;
      qry.Parameters.ParamByName('p2').Value := gblhszh;
      qry.Parameters.ParamByName('p3').Value := ayhid;
      qry.Open;
      if qry.Eof then
        result :=false
      else
      begin
        yhxm :=qry.fieldbyname('yhmc').asstring;
        qry.Close;
        qry.SQL.Clear;
        qry.Parameters.Clear;
        qry.SQL.Text :=' select a.ksid,b.ksmc from t_yh_ks a,t_ks b '+
          ' where a.hszh=b.hszh and a.ksid=b.ksid '+
          ' and a.hszh=:p2 and a.yhid=:p3 '+
          ' order by a.seq';
        qry.Parameters.ParamByName('p2').Value := gblhszh;
        qry.Parameters.ParamByName('p3').Value := ayhid;
        qry.Open;
        if qry.Eof then
        begin
          ksmc :='';
        end
        else
        begin
          ksmc := qry.fieldbyname('ksmc').AsString;
        end;
        qry.Close;
        result := true;
      end;
    except
      result := false;
    end;
  finally
    freeandnil(qry);
  end;
end;

function TdmDBAccess.isInGroup(const azdid, aksid: string): boolean;
var
  qry:Tadoquery;
  i:integer;
  newksid:string;
  intpos:integer;
  retint:integer;
begin
  newksid:=aksid;
  ////
  intpos:=foundchar('#',newksid);
  if intpos>0 then
  begin
    if RightStr(newksid,1)<>'#' then
      newksid := newksid+'#';
    newksid := AnsiReplaceStr(newksid,'#','|');
    newksid := getpartstr(newksid,'1');
  end;
  ///
  newksid:=trim(newksid);
  if newksid='' then
  begin
    result := true;
    exit;
  end;

  result := false;
  qry := TADOQuery.Create(nil);
  try
    try
      qry.Connection := ADOConnection;

      qry.Connection:=adoconnection;
      qry.SQL.Text:=' select 1 from dbo.sysobjects where'+
      ' id = object_id(N''[dbo].[My_InsertYszjks]'') '+
      ' and OBJECTPROPERTY(id, N''IsProcedure'') = 1';
      qry.Open;
      retint :=qry.RecordCount;
      if retint>0 then
      begin
        result := false;
        exit;
      end;
      qry.Close;
      qry.SQL.Add(' select 1 from t_yh_ks yk' );
      qry.SQL.Add(' where hszh=:p1 and yhid in (select yhid from t_hjzd h');
      qry.SQL.Add(' where zdid=:p2 and hszh=:p3)');
      qry.SQL.Add(' and ksid=:p4');
      qry.Parameters.ParamByName('p1').Value := gblhszh;
      qry.Parameters.ParamByName('p2').Value := azdid;
      qry.Parameters.ParamByName('p3').Value := gblhszh;
      qry.Parameters.ParamByName('p4').Value := newksid;
      qry.Open;
      if qry.Eof then
        result :=false
      else
      begin
        result := true;
      end;
    except
      result := false;
    end;
  finally
    freeandnil(qry);
  end;
end;

function TdmDBAccess.YHWakeupByID(const ZDID, cmd, ajrid: string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   tmpadoquery:Tadoquery;
   by6:string;
   ksbrdys:string;
   strCallNo,strCallKsid:string;
   ps : integer;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection :=ADOConnection;
  try
    result:='';
    iscall:=false;
    qr.Close;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
       end
       else
       begin
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    //修改呼叫终端状态
     adoconnection.Execute('update t_hjzd set state=''激活'''+
        ',calltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);
  if WakeUpByID(ajrid) then  //激活成功//
  begin
    result:=zdid+cmd+'01'+'6666';
  end
  else //激活失败//
  begin
    result:=zdid +cmd  +'000000'  ;
  end;
  except
    begin
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
//GotoNoonPause
//进入到中午休息状态
function TdmDBAccess.GotoNoonPause: boolean;
var
  qry:Tadoquery;
  i:integer;
  newksid:string;
  intpos:integer;
begin
  result := false;
  qry := TADOQuery.Create(nil);
  try
    try
      //update t_dhxx set ztbz=6,jzbz=2 where jzbz=1 and hszh=1 and
//id not in (select id from t_dhxx where jzbz<>0 and hszh=1 and kssxid<=10)
      qry.Connection := ADOConnection;
      for i:=0 to groupnumber-1 do
      begin
        newksid :=groupserial[i].ksid;
        qry.SQL.Clear;
        qry.Parameters.Clear;
        qry.SQL.Add(' update t_dhxx' );
        qry.SQL.Add(' set jzbz=2,ztbz=6');
        qry.SQL.Add(' where jzbz=1 and hszh=:p1 and ksid=:p2');
        qry.SQL.Add(' and id not in (select top 10 id from t_dhxx where jzbz=1 and ztbz<>5 and hszh=:p3 and ksid=:p4 order by kssxid)');
        qry.SQL.Add(' and id not in (select id from t_dhxx where jzbz=1 and ztbz=5 and hszh=:p5 and ksid=:p6)');
        qry.Parameters.ParamByName('p1').Value := gblhszh;
        qry.Parameters.ParamByName('p2').Value := newksid;
        qry.Parameters.ParamByName('p3').Value := gblhszh;
        qry.Parameters.ParamByName('p4').Value := newksid;
        qry.Parameters.ParamByName('p5').Value := gblhszh;
        qry.Parameters.ParamByName('p6').Value := newksid;
        qry.ExecSQL;
      end;
      result := true;
    except
      result := false;
    end;
  finally
    freeandnil(qry);
  end;
end;
//从中午休息状态恢复到工作状态
function TdmDBAccess.RebackWorking: boolean;
var
  qry:Tadoquery;
  i:integer;
  newksid:string;
  intpos:integer;
begin
  result := false;
  qry := TADOQuery.Create(nil);
  try
    try
      //update t_dhxx set ztbz=1,jzbz=1 where jzbz=2 and hszh=1
      qry.Connection := ADOConnection;
      qry.SQL.Add(' update t_dhxx' );
      qry.SQL.Add(' set jzbz=1,ztbz=1');
      qry.SQL.Add(' where jzbz=2 and hszh=:p1');
      qry.Parameters.ParamByName('p1').Value := gblhszh;
      qry.ExecSQL;
      result := true;
    except
      result := false;
    end;
  finally
    freeandnil(qry);
  end;
end;

function TdmDBAccess.YHGetSelfInfo(const zdid, cmd,
  CallNO: string): string;
var
  StrTemp:string;
  qr: TADOQuery;
  zdyhid:string ;
  zdyhmc:string;
  fjh:String;
  fjmc:String;
  zth:String;
  ztmc:String;
  Result1:string;
  zjbz:string;
  tmpstr:string;
begin
  zjbz := '0';
  qr := TADOQuery.Create(nil);
  try
   qr.Connection := ADOConnection;
   try
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Clear;
    qr.Parameters.Clear;
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=:p1' +' and zdid=:p2';
    qr.Parameters.ParamByName('p1').Value := gblHSZH;
    qr.Parameters.ParamByName('p2').Value := strtoint(zdid);
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
           begin
            result:=zdid+cmd + '028888';///没有登录.
            close;
           end;
       end
       else
       begin
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
      result :='';
      qr.Close;
      qr.SQL.Clear;
      qr.Parameters.Clear;
      //在等待T_hjzd表中查找ip=Aip的zdid.
      qr.SQL.Text:=' check_doctor_zj '+quotedstr(callno);
      qr.Open;
      if not qr.Eof then
      begin
        zjbz :='1';
        while not qr.Eof do
        begin
          StrTemp:=qr.fields.fields[2].AsString;//科室代码
          //strtemp := ansireplacestr(strtemp,'MY','');
          while leftstr(strtemp,1)='0' do
          begin
            strtemp := copy(strtemp,2,length(strtemp)-1);
          end;
          if leftstr(StrTemp,2)<>'MY'  then
            StrTemp := 'ZJ'+StrTemp+'^'
          else
            StrTemp := StrTemp+'^';
          tmpstr:= qr.fields.fields[3].AsString;
          tmpstr := ansireplacestr(tmpstr,'(名医)','');
          tmpstr := ansireplacestr(tmpstr,'名医','');
          if leftstr(StrTemp,2)<>'MY'  then
            tmpstr:= tmpstr+'-专家'
          else
            tmpstr:= tmpstr+'-名医';
          StrTemp:=StrTemp+tmpstr;//科室名称
          Result1:=Result1+StrTemp+';';
          qr.Next;
        end;
      end;
      qr.Close;
      qr.SQL.Clear;
      qr.Parameters.Clear;
      //在等待T_hjzd表中查找ip=Aip的zdid.
      qr.SQL.Text:=' select yhid,yhmc from t_yh'+
        ' where yhid=:p2';
      qr.Parameters.ParamByName('p2').Value := CallNO;
      qr.Open;
      ///////////返回数据
      with qr do
      begin
         if not qr.Eof  then
         begin
            StrTemp:=qr.fields.fields[0].AsString;
            strtemp:=strtemp +'^';//员工代码
            StrTemp:=StrTemp+qr.fields.fields[1].AsString+'^';//员工姓名
            StrTemp:=StrTemp+zjbz;//专家标志
            Result:=Result+StrTemp+';';
         end
         else
         begin
            Result:=CallNO+'^'+';';
         end;
      end;
      qr.Close;

      if (zjbz='1') then  //专家则发送专家科室代码
      begin
        result := result+result1;
      end;
      qr.SQL.Clear;
      qr.Parameters.Clear;
      //在等待T_hjzd表中查找ip=Aip的zdid.
      qr.SQL.Text:=' select ksid,ksmc from t_ks'+
        ' where hszh=:p2'+
        ' and len(ksid)<11'+
        ' order by ksid';
      qr.Parameters.ParamByName('p2').Value := gblHSZH;
      qr.Open;
      ///////////返回数据
      with qr do
      begin
         if not qr.Eof  then
         begin
           while not qr.Eof do
           begin
            StrTemp:=fields.fields[0].AsString +'^';//科室代码
            StrTemp:=StrTemp+fields.fields[1].AsString;//科室名称
            Result:=Result+StrTemp+';';
            qr.Next;
           end;
         end;
      end;
      if Result ='' then
        Result := zdid+cmd+'00'
      else
        Result := zdid+cmd+'01'+ Result;
   except
     result:=zdid+cmd+'00'+ '';//出错返回未找到信息
   end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.YHSetSelfInfo(const zdid, cmd,
  CallNO: string;const recIp:string;const recPort:integer): string;
var
  doctid,doctname,power,groupcode,groupname:string;
  qr,tmpquery: TADOQuery;
  seq:integer;
  tmpstr :string;
begin
  //如果此护士站没有此员工则添加
  tmpstr:=callno;
  tmpstr := ansireplacestr(tmpstr,'#','|');
  doctid:=getpartstr(tmpstr,'1');
  doctname :=getpartstr(tmpstr,'2');
  power :=getpartstr(tmpstr,'3');
  groupcode :=getpartstr(tmpstr,'4');
  groupname :=getpartstr(tmpstr,'5');
  qr := TADOQuery.Create(nil);
  try
   qr.Connection := ADOConnection;
   try
     qr.SQL.Clear;
     qr.Parameters.Clear;
     qr.SQL.Text:=' select yhid,yhmc from T_yh y '+
        ' where y.yhid='''+doctid+''' and y.hszh='+inttostr(gblhszh);
      qr.Open;
      if qr.Eof then//没有此员工
      begin
          tmpquery:=Tadoquery.Create(nil);
          tmpquery.Connection:=adoconnection;
          tmpquery.SQL.Text:=' Insert into t_yh(yhid,yhmc,qxid,ksid1,ztbz,hszh,zcgh1,zcgh2,zcgh3,prepare1,memo) '+
                             ' values('''+doctid+''','+
                             ' '''+doctname+''','+
                             '3,'+
                             ' '''+''+''','+
                             ' ''0'','+
                             ''+inttostr(gblhszh)+
                             ''+',1,0,0,1'+
                             ',''程序自动添加'''+
                             ')';
          tmpquery.ExecSQL;
          tmpquery.SQL.Text :='insert into t_zjxx(dm,xm,hszh)'+
            ' select '+quotedstr(doctid)+','+quotedstr(doctname)+
            ','+inttostr(gblHSZH)+' where not exists(select 1 from t_zjxx'+
            ' where dm='+quotedstr(doctid)+')';
          try
            tmpquery.ExecSQL;
          except
          end;
          tmpquery.SQL.Text :='update t_zjxx set zp=z.zp '+
            ' from t_zjxx inner join (select a.dm,b.zp from t_zjxx a,'+
            ' (select zp from t_zjxx where dm=''6666'') b '+
            ' where dm='+quotedstr(doctid) +' and a.zp is null) z'+
            ' on t_zjxx.dm=z.dm';
          try
            tmpquery.ExecSQL;
          except
          end;
          FreeAndNil(tmpquery);
      end;
      if power='1' then
      begin
        if leftstr(groupcode,2)='ZJ' then
        begin
          groupcode := copy(groupcode,3,length(groupcode)-2)+doctid;
          groupname := groupname+doctname+'专家';
        end
        else if leftstr(groupcode,2)='MY' then
        begin
          groupcode := groupcode+doctid;
          groupname := groupname+doctname+'名医';
        end
        else
        begin
          groupcode := groupcode+doctid;
          groupname := groupname+doctname+'专家';
        end;
        //查看有无此科室信息//
        qr.SQL.Clear;
        qr.Parameters.Clear;
        qr.SQL.Text:=' select 1 from t_ks'+
          ' where ksid=:p1 and hszh=:p2';
        qr.Parameters.ParamByName('p1').Value := groupcode;
        qr.Parameters.ParamByName('p2').Value := gblHSZH;
        qr.Open;
        if qr.RecordCount=0 then
        begin
            tmpquery:=Tadoquery.Create(nil);
            tmpquery.Connection:=adoconnection;
            tmpquery.SQL.Text:=' Insert into t_ks(KSID,KSMC,DQHM,QSHM,ZDHM,ZTBZ,HSZH,YYMS,KFBZ,hmpx,memo) '+
                               ' values('''+groupcode+''','+
                               ' '''+groupname+''','+
                               '1,1,9999,0,'+
                               ''+inttostr(gblhszh)+
                               ',5,0,1'+
                               ',''程序自动添加'''+
                               ')';
            seq:=tmpquery.ExecSQL;

            if seq>0 then //
            begin
              tmpquery.SQL.Text:=' insert into t_KS_XSZD(KSID,XSPID,HSZH,xsms,yyms)'+
                                 ' select '+quotedstr(groupcode)+',xspid,hszh,1,5'+
                                 ' from t_XSZD'+
                                  ' where HSZH='+inttostr(gblhszh);
              tmpquery.ExecSQL;
            end;
            //修改一个默认的yyms，从科室表里查询 
            try
              if (leftstr(groupcode,2)='MY') then
              begin
                tmpquery.SQL.Text:=' update t_ks set yyms=k1.yyms'+
                                   ' from t_ks k ,(select * from t_ks where ksid=''MY'') as k1 '+
                                   ' where k.ksid='+quotedstr(groupcode) +
                                   ' and k.hszh='+inttostr(gblhszh);
              end
              else
              begin
                tmpquery.SQL.Text:=' update t_ks set yyms=k1.yyms'+
                                   ' from t_ks k ,(select * from t_ks where ksid=''ZJ'') as k1 '+
                                   ' where k.ksid='+quotedstr(groupcode) +
                                   ' and k.hszh='+inttostr(gblhszh);
              end;
              tmpquery.ExecSQL;
            except
            end;

            //将已经有的挂号数据放入到本护士站
            tmpquery.SQL.Text:='  update t_ghxx set ztbz=1,hszh='+inttostr(gblhszh)+
                                ' where ksid='+quotedstr(groupcode)+' and HSZH<>'+inttostr(gblhszh);
            tmpquery.ExecSQL;
            FreeAndNil(tmpquery);
        end;
        qr.Close;
      end;
  //如果此护士站没有此员工的预设科室则添加
      qr.SQL.Clear;
      qr.Parameters.Clear;
      qr.SQL.Text:=' select 1 from t_yh_ks_sz'+
        ' where yhid=:p1 and hszh=:p2';
      qr.Parameters.ParamByName('p1').Value := doctid;
      qr.Parameters.ParamByName('p2').Value := gblHSZH;
      qr.Open;
      seq:= qr.RecordCount+1;
      qr.Close;
      qr.SQL.Clear;
      qr.Parameters.Clear;
      qr.SQL.Text:=' insert into  t_yh_ks_sz(HSZH,YHID,KSID,SEQ,ZCGH,Prepare,CallCount)'+
        ' select :p1,:p2,:p3,:p4,:p5,:p6,:p7 '+
        ' where not exists(select 1 from t_yh_ks_sz '+
        ' where hszh=:pa and yhid=:pb and ksid=:pc)';
      qr.Parameters.ParamByName('p1').Value := gblHSZH;
      qr.Parameters.ParamByName('p2').Value := doctid;
      qr.Parameters.ParamByName('p3').Value := groupcode;
      qr.Parameters.ParamByName('p4').Value := seq;
      qr.Parameters.ParamByName('p5').Value := 1;
      qr.Parameters.ParamByName('p6').Value := 1;
      qr.Parameters.ParamByName('p7').Value := 0;
      qr.Parameters.ParamByName('pa').Value := gblHSZH;
      qr.Parameters.ParamByName('pb').Value := doctid;
      qr.Parameters.ParamByName('pc').Value := groupcode;
      qr.ExecSQL;
      qr.Close;
      //登录
      result := dmdbaccess.YHLogin(zdid,'DF',doctid,doctname,recip,recport,'',1);
      //切换科室
      dmdbaccess.YHSeleKeShi(zdid,'DC',groupcode,doctid);
      //登录
      result := dmdbaccess.YHLogin(zdid,'DF',doctid,doctname,recip,recport,'',1);
//      qr.SQL.Clear;
//      qr.Parameters.Clear;
//      qr.SQL.Text:=' select 1 from t_yh_ks'+
//        ' where yhid=:p1 and hszh=:p2 and ksid=:p3';
//      qr.Parameters.ParamByName('p1').Value := doctid;
//      qr.Parameters.ParamByName('p2').Value := gblHSZH;
//      qr.Parameters.ParamByName('p3').Value := groupcode;
//      qr.Open;
//      seq:= qr.RecordCount+1;
//      qr.Close;
//      qr.SQL.Clear;
//      qr.Parameters.Clear;
//      qr.SQL.Text:=' insert into  t_yh_ks(HSZH,YHID,KSID,SEQ,ZCGH,Prepare,CallCount)'+
//        ' select :p1,:p2,:p3,:p4,:p5,:p6,:p7 '+
//        ' where not exists(select 1 from t_yh_ks '+
//        ' where hszh=:pa and yhid=:pb and ksid=:pc)';
//      qr.Parameters.ParamByName('p1').Value := gblHSZH;
//      qr.Parameters.ParamByName('p2').Value := doctid;
//      qr.Parameters.ParamByName('p3').Value := groupcode;
//      qr.Parameters.ParamByName('p4').Value := seq;
//      qr.Parameters.ParamByName('p5').Value := 1;
//      qr.Parameters.ParamByName('p6').Value := 1;
//      qr.Parameters.ParamByName('p7').Value := 0;
//      qr.Parameters.ParamByName('pa').Value := gblHSZH;
//      qr.Parameters.ParamByName('pb').Value := doctid;
//      qr.Parameters.ParamByName('pc').Value := groupcode;
//      qr.ExecSQL;
//      qr.Close;
   except
   end;
  finally
    FreeAndNil(qr);
  end;


end;

function TdmDBAccess.YHSetCallZJ(const zdid, cmd, CallNO, recIp: string;
  const recPort: integer): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc:string ;
   hjksid,hjksmc:string;
   isexsit :boolean;
   fjh,fjmc,zth,ztmc:string;
   YJPIP:string;
   i:integer;
   ksid1:string;
   tmpquery:Tadoquery;
   ksbrdys:string;
   qr:TADOQuery;
   LockGroup:string;
   RoomType:integer;
   TypePreStr:string;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   tmpstr:string;
   zjbz:string;//'1'-是，'0'-否.
begin
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    //gbledit_ks_count:=0;
    result:='';
    tmpstr := callno;
    tmpstr := ansireplacestr(tmpstr,',','|');
    tmpstr := tmpstr+'|';
    zdyhid := getpartstr(tmpstr,'1');
    zjbz:= getpartstr(tmpstr,'1');

    qr.Close;
      try
        qr.SQL.Text :=' check_doctor_zj '+quotedstr(zdyhid);
        qr.Open;
        if not qr.Eof then//是专家医生
        begin
          while not qr.Eof do
          begin
            zdyhid := qr.fieldbyname('ysdm').AsString;
            zdyhmc := qr.fieldbyname('ysxm').AsString;
            hjksid := qr.fieldbyname('ksid').AsString;
            hjksmc := qr.fieldbyname('ksmc').AsString;
            if zjbz='1' then
            begin
               tmpstr :=zdyhid+'#'+zdyhmc+'#'+'1#'+hjksid+'#'+hjksmc+'#';
            end
            else
            begin
               tmpstr :=zdyhid+'#'+zdyhmc+'#'+'0#'+hjksid+'#'+hjksmc+'#';
            end;
            result :=yhsetselfinfo(zdid,'G4',tmpstr,recIp,recPort);
            qr.Next;
          end;
        end;
      except
      end;
      qr.Close;
      if result ='' then
        result :=zdid+cmd+'00'
      else
        result :=result;
  finally
    freeandnil(qr);
  end;
end;

function TdmDBAccess.getReadStr(const astr, atype: string): string;
const
  Digits: array[2..5] of string = ('十', '百', '千', '万');
var
  datastr:string;
  i:integer;
begin
    result := astr;
    if (atype='读数') then  //123读成:  一二三 ,1002 读成:一零零二
    begin
      result := ansireplacestr(result,'1','一');
      result := ansireplacestr(result,'2','二');
      result := ansireplacestr(result,'3','三');
      result := ansireplacestr(result,'4','四');
      result := ansireplacestr(result,'5','五');
      result := ansireplacestr(result,'6','六');
      result := ansireplacestr(result,'7','七');
      result := ansireplacestr(result,'8','八');
      result := ansireplacestr(result,'9','九');
      result := ansireplacestr(result,'0','零');
    end
    else if (atype='读值') then //123读成:一百二十三,  1002读成:一千零二
    begin
      if isint(result) then//是数值
      begin
        datastr := inttostr(strtoint(result));
        result :='';
        for i:=5 downto 2 do
        begin
          if length(datastr)>=i then
          begin
            if copy(datastr,length(datastr)-i+1,1)='0' then
            begin
              result :=result+copy(datastr,length(datastr)-i+1,1);
            end
            else
              result :=result+copy(datastr,length(datastr)-i+1,1)+ Digits[i];
          end;
        end;
        while (pos('00',result)>0) do  //将多个连续0替换为一个0
        begin
          result := ansireplacestr(result,'00','0');
        end;
        result :=result+copy(datastr,length(datastr),1);
        result := ansireplacestr(result,'1','一');
        result := ansireplacestr(result,'2','二');
        result := ansireplacestr(result,'3','三');
        result := ansireplacestr(result,'4','四');
        result := ansireplacestr(result,'5','五');
        result := ansireplacestr(result,'6','六');
        result := ansireplacestr(result,'7','七');
        result := ansireplacestr(result,'8','八');
        result := ansireplacestr(result,'9','九');
        result := ansireplacestr(result,'0','零');
      end;
    end;
end;

function TdmDBAccess.DeleteOrder(const ahszh: Integer;
  const aksid: string): Boolean;
var
  qr:TADOQuery;
begin
  Result := True;
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      qr.SQL.Text :=' Delete t_ks_order'+
        ' where hszh=:p1 and ksid=:p2';
      qr.Parameters.ParamByName('p1').Value := ahszh;
      qr.Parameters.ParamByName('p2').Value := aksid;
      qr.ExecSQL;
    except
      Result := False;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.getwaitcount(const agroupcode: string;
  const asjdbz: integer): integer;
var
  qr:TADOQuery;
begin
  Result := 0;
  qr:= TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      qr.SQL.Text :=' select count(*) cnt from t_dhxx '+
        ' where hszh=:p1 and ksid=:p2'+
        ' and sjdbz=:p3';
      qr.Parameters.ParamByName('p1').Value := gblhszh;
      qr.Parameters.ParamByName('p2').Value := agroupcode;
      qr.Parameters.ParamByName('p3').Value := asjdbz;
      qr.Open;
      result := qr.fieldbyname('cnt').AsInteger ;
      qr.Close;
      qr.SQL.Text :=' select count(*) cnt from t_dhxx '+
        ' where hszh=:p1 and ksid=:p2'+
        ' and sjdbz=:p3 and jzbz=1 and ztbz=2 ';
      qr.Parameters.ParamByName('p1').Value := gblhszh;
      qr.Parameters.ParamByName('p2').Value := agroupcode;
      qr.Parameters.ParamByName('p3').Value := asjdbz-1;
      qr.Open;
      result := result+qr.fieldbyname('cnt').AsInteger ;
      qr.Close;
    except
      Result := 0;
    end;
  finally
    FreeAndNil(qr);
  end;

end;

function TdmDBAccess.SetHJZDDDRS(const zdid: string;
  const addrs: integer): integer;
var
  i:integer;
begin
  for i:=0 to gblhjzdsl-1 do
  begin
    if gblhjzdarray[i].zdid=zdid then
    begin
      gblhjzdarray[i].ddrs := addrs;
      break;
    end;
  end;
end;

function TdmDBAccess.SetHJZDIP(const zdid, aip: string;
  const aport: integer): integer;
var
  i:integer;
begin
  for i:=0 to gblhjzdsl-1 do
  begin
    if gblhjzdarray[i].zdid=zdid then
    begin
      gblhjzdarray[i].ip := aip;
      gblhjzdarray[i].port := aport;
      break;
    end;
  end;

end;

function TdmDBAccess.SetHJZDRecvtime(const zdid: string;
  const atime: tdatetime): integer;
var
  i:integer;
begin
  for i:=0 to gblhjzdsl-1 do
  begin
    if gblhjzdarray[i].zdid=zdid then
    begin
      gblhjzdarray[i].recvtime := atime;
      break;
    end;
  end;
end;

function TdmDBAccess.SetHJZDYHID(const zdid, ayhid: string): integer;
var
  i:integer;
begin
  for i:=0 to gblhjzdsl-1 do
  begin
    if gblhjzdarray[i].zdid=zdid then
    begin
      gblhjzdarray[i].yhid := ayhid;
      break;
    end;
  end;
end;

function TdmDBAccess.GetTZJKKCardNO: string;
var
  ps:pchar;
  kh:string;
  intret:integer;
  h:Thandle;
 // ReadCitizenTreatmentCardInfo:function(OutData:Pchar):integer; stdcall;
begin
//    try
//      h := LoadLibrary('SMK_JY.dll');
//    except
//      result :='';
//      exit;
//    end;
//    try
//      //if h>32 then
//      begin
//        //ReadCitizenTreatmentCardInfo := GetProcAddress(h, 'ReadCitizenTreatmentCardInfo');
//        ps := allocmem(255);
//        intret:= ReadCitizenTreatmentCardInfo(ps);
//        if intret<0 then
//        begin
//          //showmessage('调用成功,读卡错误:'+ps);
//          result :='';
//        end
//        else
//        begin
//          kh := ps; //
//          kh := getpartstr(kh+'|','11');
//          result :=kh;
//          //showmessage('调用成功,内容:'+'卡号:'+kh+ ' '+ps);
//        end;
//        freemem(ps);
//      end
////      else
////      begin
////        result :='';
////        exit;
////      end;
//    except//finally
//      //freelibrary(h);
//      result :='';
//    end;
end;

{*******************************************************************************
*函数名:YHSelectHJFS;
                                           *
*函数机能:设置呼叫方式(1-按科室,2-按号码，3-按时间)                                           *
*******************************************************************************}
function TdmDBAccess.YHSelectHJFS(const ZDID: string; const cmd:string;const ahjfs:string): string;
var
    zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string;
    YJPIP:string;
    i:integer;
    hjksnum:integer;
    intFieldsIndex:integer;
    hjks:array[1..20] of CallGroup_Info;
//     hjksid:array [1..3] of string;
//     hjksmc:array [1..3] of string;
     qr : TADOQuery;
begin
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
  try
      result:='';
        result:=zdid + cmd + '01'+'000000';  //
        qr.Close;
        //在等待T_hjzd表中查找zdid.
        qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                                ' t_hjzd left outer join t_yh on ' +
                                ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                                ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
        qr.Open;
        ///////////将中.
        with qr do
        begin
           if not qr.Eof  then
           begin
              zdyhid:=fields.fields[4].asstring ;
              zdyhmc:=fields.fields[5].asstring;
              fjh:=fields.Fields[1].AsString;
              fjmc:=fields.Fields[6].AsString;
              zth:=fields.Fields[2].AsString;
              ztmc:=fields.Fields[3].AsString;
              qr.close;
              qr.SQL.Text:=' update t_yh set hjfs='+ahjfs+'  where hszh='+inttostr(gblhszh) +' and yhid='+quotedstr(zdyhid);
              qr.ExecSQL;
           end;
        end;
  except
    begin
      result := zdid + cmd + '000000';  //
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.YHSetRollMsg(const ZDID, cmd, msg: string): string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   tmpadoquery:Tadoquery;
   by6:string;
   ksbrdys:string;
   strCallNo,strCallKsid:string;
   ps : integer;
   qr:TADOQuery;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection :=ADOConnection;
  try
    result:='';
    iscall:=false;
    qr.Close;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             if (cmd='40') or (cmd='57') or (cmd='43') then
              result:=zdid +cmd  +'还没有登录!    '+'请登录工号    '
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
       end
       else
       begin
           if (cmd='40') or (cmd='57') or (cmd='43') then
            result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置  '
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
//          hjksnum:=1;
//          for intFieldsIndex:=2 to 7 do
//          begin
//              if intFieldsIndex mod 2 =0 then Continue ;
//              if fields.fields[intFieldsIndex].asstring<>''  then
//                 begin
//                   hjksid[hjksnum]:=fields.Fields[intFieldsIndex-1].AsString;
//                   hjksmc[hjksnum]:=fields.Fields[intFieldsIndex].AsString;
//                   hjksnum:=hjksnum+1;
//                 end;
//          end;
//          GetYHCallKS(zdyhid,hjksnum,hjks);
//          if hjksnum=0 then
//           begin
//             if (cmd='40') or (cmd='57') or (cmd='43') then
//              result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置! '
//             else
//             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
//             exit;
//           end;
           close;
       end
       else
       begin
           if (cmd='40') or (cmd='57') or (cmd='43') then
            result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置  '
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;
    //修改呼叫终端状态
     adoconnection.Execute('update t_hjzd set state=''滚动信息'''+
        ',calltime=getdate()'+
        ' where zdid=' + zdid + ' and hszh=' + inttostr(gblhszh) ,cmdtext);

      cmdstr:='  update t_hjzd_gdxx set msg='+quotedstr(msg)+',flag=1,yhid='+quotedstr(zdyhid)+
              ' where hszh='+inttostr(gblHszh)+
              ' and hjzdid='+zdid +' and seq=0' ;
      adoconnection.Execute(cmdstr ,cmdText);

      cmdstr:=' insert into t_hjzd_gdxx '+
              ' (hszh,hjzdid,msg,seq,flag,yhid)'+
              ' select '+inttostr(gblHszh)+','+zdid+','+quotedstr(msg)+',0,1,'+quotedstr(zdyhid)+
              ' where not exists(select 1 from t_hjzd_gdxx where hszh='+inttostr(gblHszh)+
              ' and hjzdid='+zdid+' and seq=0)';
      adoconnection.Execute(cmdstr ,cmdText);
       if (cmd='40') or (cmd='57') or (cmd='43') then
        result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置  '
       else
        result:=zdid + cmd + '018888';
  except
    begin
       if (cmd='40') or (cmd='57') then
        result:=zdid +cmd  +'选呼没有成功!  '+'操作时有错误! '
       else
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;

function TdmDBAccess.GetJXSBCardNO: String;
var
  IC_ReadCardInfo_NoPin: function(outstr:pchar):longint; stdcall;
  hDll:Thandle;
  ps:Pchar;
  iret:longint;
  str:string;
  kh:string;
begin
  result :='';
  try
    hDll := LoadLibrary('ICCInter_JX_SB.dll');
    if hDll >= 32 then  //如果Dll无法加载则跳出
    begin
      try
        IC_ReadCardInfo_NoPin := GetProcAddress(hDll, 'IC_ReadCardInfo_NoPin');
        ps := allocmem(1000);
        iret := IC_ReadCardInfo_NoPin(ps);
        if iret=0 then
        begin
          str := ps;
          //1~330400D156000005000045C92CAFDD7D~3~A10181669~330103197605110011~程宁~1~330400~330400813561~
          str := ansireplacestr(str,'~','|');
          kh := getpartstr(str,'4');
          result := kh;
        end
        else
        begin
          result :='';
        end;
      except on e:exception do
        result :='';
      end;
    end;
    if hDll>=32 then
      freelibrary(hDll);
  except
    result :='';
  end;
end;

function TdmDBAccess.SetWincePJ: integer;
var
//  qrpd : TADOQuery;
  qrpj : TAdoquery;
  i:integer;
  hjzdid, pjqid ,pjqip,hosttype:string;

begin
//  qrpd := TADOQuery.Create(nil);
  qrpj := Tadoquery.Create(nil);
  try
//    qrpd.Connection := ADOConnection;
    qrpj.Connection := adoconnapp;
      try
        //在等待T_hjzd表中查找zdid.
        qrpj.SQL.Text:=' select yjdz ,zdid,ip,type from t_zdxx';
        qrpj.Open;
        gblwincepjcnt:=qrpj.RecordCount;
        setlength(gblwincepjarray,gblwincepjcnt);
        ///////////将中.
        i:=0;
        with qrpj do
        begin
           while not qrpj.Eof  do
           begin
              hjzdid:=fields.Fields[0].AsString;
              pjqid:=fields.Fields[1].AsString;
              pjqip:=fields.Fields[2].AsString;
              hosttype := fields.Fields[3].AsString;
              if hosttype='1' then  //wince小屏
              begin
                gblwincepjarray[i]:= Twincepj.create(hjzdid,pjqid,pjqip);
                (gblwincepjarray[i] as Twincepj).OnRecvPJ := frmmain.wincepjOnrecvpj;
              end
              else  //2安卓小屏
              begin
                gblwincepjarray[i]:= Tandroidpj.create(hjzdid,pjqid,pjqip);
                (gblwincepjarray[i] as Tandroidpj).OnRecvPJ := frmmain.wincepjOnrecvpj;
              end;
              qrpj.Next;
              i:=i+1;
           end;
        end;
        qrpj.close;
        result := gblwincepjcnt;
      except
       begin
        result :=0;
        Exit;
       end;
      end;
  finally
    FreeAndNil(qrpj);
  end;
end;
// InsertDefApp 功能:当有病人信息发下来时,插入一条默认评价信息,并记录此条信息的ID
//参数 userinfo:string,表示病人信息内容:
//王小二#30#男#卡号#病人编号#手机号码#身份证号#$
//相关的全局变量
//insertid 如果>0表示插入成功,并且为此条信息的ID
//         如果<0表示插入失败.
Function TdmDBAccess.InsertDefApp_UserInfo(const apjqid:string;
  const ayhid:string;
  const userinfo:string):integer;
var
  hid,ck:string;
  brxm,nl,xb,kh,brbh,sjhm,sfzh:string;
  tmpstr:string;
  ip1,ip2,ips:string;
  qrpj:Tadoquery;
  insertid:integer;
  strLoginUserid:string;
  strYwid:string;
begin
  strLoginUserid :=ayhid;  //登录的用户ID;
  strYwid := '' ;//业务代码;
  qrpj := Tadoquery.Create(nil);
  try
    qrpj.Connection := adoconnapp;
    try
      insertid :=-1;
      try
        tmpstr := AnsiReplaceStr(userinfo,'#','|');
        brxm := getpartstr(tmpstr,'1');
        nl := getpartstr(tmpstr,'2');
        xb := getpartstr(tmpstr,'3');
        kh:= getpartstr(tmpstr,'4');
        brbh := getpartstr(tmpstr,'5');
        sjhm := getpartstr(tmpstr,'6');
        sfzh := getpartstr(tmpstr,'7');
        hid := apjqid;
        qrpj.SQL.Clear;
        qrpj.Parameters.Clear;
        qrpj.SQL.Text := 'select zdid,ckh from t_ckxx where zdid=:p1';
        qrpj.Parameters.ParamByName('p1').Value:=hid;
        try
          qrpj.Open;
          if qrpj.Eof then
            ck :='0'
          else
          begin
            ck := qrpj.fieldbyname('ckh').AsString;
            hid := qrpj.fieldbyname('zdid').AsString;
          end;
          qrpj.Close;
        except
          ck :='0';
        end;
        qrpj.SQL.Clear;
        qrpj.Parameters.Clear;
        qrpj.SQL.Text :=' insert into t_pjxx(zdid, ckh, yhid, ajsj'+
           ',ajh, ywid,showed, status,brxm,sex,cardno,phoneno,idcode,nl,hostip)'+
           ' values(:p1,:p2,:p3'+
           ',getdate(),0'+''+
           ',:p4,0,0'+
           ',:p5,:p6,:p7'+
           ',:p8,:p9,:p10'+
           ',:p11)';
        qrpj.Parameters.ParamByName('p1').Value :=hid;
        qrpj.Parameters.ParamByName('p2').Value :=ck;
        qrpj.Parameters.ParamByName('p3').Value :=strLoginUserid;
        qrpj.Parameters.ParamByName('p4').Value :=strYwid;
        qrpj.Parameters.ParamByName('p5').Value :=brxm;
        qrpj.Parameters.ParamByName('p6').Value :=xb;
        qrpj.Parameters.ParamByName('p7').Value :=kh;
        qrpj.Parameters.ParamByName('p8').Value :=sjhm;
        qrpj.Parameters.ParamByName('p9').Value :=sfzh;
        qrpj.Parameters.ParamByName('p10').Value :=nl;
        qrpj.Parameters.ParamByName('p11').Value :=ip1;
        try
          qrpj.ExecSQL;
        except
          insertid:=-2;
        end;
        if insertid=-2 then
        begin
          insertid:=-1;
          try
            qrpj.ExecSQL;
          except
            insertid:=-2;
            //addlog('aaa.txt','bjpj插入缺省评价失败:'+ Form2.FADOQuery1.SQL.Text);
          end;
        end;

        if insertid <>-2 then
        begin
          try
            qrpj.SQL.Text := 'Select @@Identity as f1';
            qrpj.Open;
            if not qrpj.Eof then
              insertid:=qrpj.fieldbyname('f1').AsInteger;
          except
            insertid:=-3;
          end;
        end;
        Result := insertid;
      except
        Result := insertid;
      end;
    except
      Result := insertid;
    end;
  finally
  freeandnil(qrpj);
  end;
end;

function TdmDBAccess.PutPJValueToDb(const aValue: string;const apjqid:string;const apjxxid:integer;
  const ayhid:string): string;
var
  tmpstr:string;
  hid:string;
  ck:string;
  pjstr,strKey,strPhone:string;
  ip1,ip2,ips:string;
  insertid:integer;
  qrpj:Tadoquery;
  strLoginUserid,strYwid:string;
begin
  strLoginUserid:= ayhid ;
  qrpj := Tadoquery.Create(nil);
  try
    qrpj.Connection := adoconnapp;
    try
        insertid:=apjxxid;
        tmpstr :=aValue;
        pjstr := Copy(tmpstr,3,Length(tmpstr)-2);
        strKey := Copy(pjstr,3,2);
        if strKey='-1' then
          strPhone := Copy(pjstr,6,Length(pjstr)-6)
        else
          strPhone := '';
  //          addlog('aaa.txt','评价:'+pjstr);
        if insertid>=0 then   //已经插入过未评价信息
        begin
          if strKey='' then   //评价为空
          begin
            qrpj.SQL.Clear;
            qrpj.Parameters.Clear;
            qrpj.SQL.Text := 'update t_pjxx set ajsj=getdate()'+
            ' ,status=30'+
            ' where autoid=:p2';
            qrpj.Parameters.ParamByName('p2').Value :=insertid;
          end
          else  //有评价
          begin
            if strKey='-1' then  //投诉
            begin
              qrpj.SQL.Clear;
              qrpj.Parameters.Clear;
              qrpj.SQL.Text := 'update t_pjxx set ajsj=getdate()'+
              ',ajh=:p1,phoneno=:p2'+
              ',status=30'+
              ' where autoid=:p4';
              qrpj.Parameters.ParamByName('p1').Value :=strKey;
              qrpj.Parameters.ParamByName('p2').Value :=strPhone;
              qrpj.Parameters.ParamByName('p4').Value :=insertid;
            end
            else   //正常评价
            begin
              qrpj.SQL.Clear;
              qrpj.Parameters.Clear;
              qrpj.SQL.Text := 'update t_pjxx set ajsj=getdate()'+
              ',ajh=:p1'+
              ',status=30'+
              ' where autoid=:p4';
              qrpj.Parameters.ParamByName('p1').Value :=strKey;
              qrpj.Parameters.ParamByName('p4').Value :=insertid;
            end;
          end;

        try
          qrpj.ExecSQL;
        except
          //addlog('aaa.txt','bjpj更新评价失败net:'+ Form2.qrpj.SQL.Text);
        end;
      end
      else  //未插入过未评价信息
      begin
        //得到窗口代码
        hid := apjqid;
        qrpj.SQL.Clear;
        qrpj.Parameters.Clear;
        qrpj.SQL.Text := 'select ckh from t_ckxx where zdid=:p1';
        qrpj.Parameters.ParamByName('p1').Value:=hid;
        try
          qrpj.Open;
          if qrpj.Eof then
            ck :='0'
          else
            ck := qrpj.fieldbyname('ckh').AsString;
          qrpj.Close;
        except
          ck :='0';
        end;
        try
          if strKey='' then
          begin
            qrpj.SQL.Clear;
            qrpj.Parameters.Clear;
            qrpj.SQL.Text :=' insert into t_pjxx(zdid, ckh, yhid, ajsj'+
             ',hostip, ywid,showed, status)'+
             ' values(:p1,:p2,:p3'+
             ',getdate()'+''+',:p4'+
             ',:p5,0,31)';
            qrpj.Parameters.ParamByName('p1').Value:=hid;
            qrpj.Parameters.ParamByName('p2').Value:=ck;
            qrpj.Parameters.ParamByName('p3').Value:=strLoginUserid;
            qrpj.Parameters.ParamByName('p4').Value:='';
            qrpj.Parameters.ParamByName('p5').Value:=strYwid;
          end
          else
          begin
            if strKey='-1' then
            begin
              qrpj.SQL.Clear;
              qrpj.Parameters.Clear;
              qrpj.SQL.Text :=' insert into t_pjxx(zdid, ckh, yhid, ajsj,ajh'+
               ',hostip, ywid,showed, status,phoneno)'+
               ' values(:p1,:p2,:p3'+
               ',getdate()'+',:p4,:p5'+
               ',:p6,0,31'+
               ',:p7)' ;
              qrpj.Parameters.ParamByName('p1').Value:=hid;
              qrpj.Parameters.ParamByName('p2').Value:=ck;
              qrpj.Parameters.ParamByName('p3').Value:=strLoginUserid;
              qrpj.Parameters.ParamByName('p4').Value:=strKey;
              qrpj.Parameters.ParamByName('p5').Value:='';
              qrpj.Parameters.ParamByName('p6').Value:=strYwid;
              qrpj.Parameters.ParamByName('p7').Value:=strPhone;
            end
            else
            begin
              qrpj.SQL.Clear;
              qrpj.Parameters.Clear;
              qrpj.SQL.Text :=' insert into t_pjxx(zdid, ckh, yhid, ajsj,ajh'+
               ',hostip, ywid,showed, status)'+
               ' values(:p1,:p2,:p3'+
               ',getdate()'+',:p4,:p5'+
               ',:p6,0,31'+
               ')' ;
              qrpj.Parameters.ParamByName('p1').Value:=hid;
              qrpj.Parameters.ParamByName('p2').Value:=ck;
              qrpj.Parameters.ParamByName('p3').Value:=strLoginUserid;
              qrpj.Parameters.ParamByName('p4').Value:=strKey;
              qrpj.Parameters.ParamByName('p5').Value:='';
              qrpj.Parameters.ParamByName('p6').Value:=strYwid;
            end;
          end;
          qrpj.ExecSQL;
          qrpj.Close;
        except
          //addlog('aaa.txt','bjpj插入评价失败net:'+ Form2.qrpj.SQL.Text);
        end;
      end;
    except on e:Exception do
        //addlog('aaa.txt','PutValueToDb发生错误:'+e.message);
    end;
  finally
    freeandnil(qrpj);
  end;
end;
// 函数名：doPutSpecialForward
//wugang @2018-01-05
//功能:将科室agroupcode中序号大于aseq的优先病人向前提一位//
//参数：
//agroupcode:科室代码
//aseq:当前病人的序号//
function TdmDBAccess.doPutSpecialForward(const agroupcode: string;
  const aseq: integer): boolean;
var
    autoid,patautoid:string;
    kssxid,yxjid:integer;
    qr,qr_pat : TADOQuery;
    blRollback:boolean;
begin
  result := false;
  qr := TADOQuery.Create(nil);
  qr_pat := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr_pat.Connection := ADOConnection;
//    ADOConnection.BeginTrans;
//    blRollback := false;
  try
  //1.查询到科室agroupcode中所有kssxid>aseq的在等待的优先病人
  //2.对于每一个优先病人做以下处理
  //2.1.如果他的前一位是优先的不修改序号
  //2.2.如果他的前一位是普通病人，则将他的前一位序号+1，当前优先病人的序号-1.
        qr.Close;
        //在等待T_hjzd表中查找zdid.
        qr.SQL.Text:=' select id,kssxid,yxjid from  ' +
                                ' t_dhxx '+
                                ' where hszh=' + inttostr(gblhszh) +
                                ' and ksid=' + quotedstr(agroupcode)+
                                ' and jzbz<>0'+
                                ' and yxjid<>0'+
                                ' and kssxid>'+inttostr(aseq) +
                                ' order by kssxid ';
        qr.Open;
        ///////////将中.
        with qr do
        begin
           while not qr.Eof  do
           begin
              autoid:=fields.fields[0].asstring ;
              kssxid:=fields.fields[1].AsInteger;
              yxjid:=fields.Fields[2].AsInteger;
              //查询他之前的病人的优先级//
              qr_pat.SQL.Text :=' select yxjid,id from t_dhxx ' +
                                ' where hszh=' + inttostr(gblhszh) +
                                ' and ksid=' + quotedstr(agroupcode)+
                                ' and jzbz<>0'+
                                ' and kssxid='+inttostr(kssxid-1);
              qr_pat.Open;
              if not qr_pat.Eof then
              begin
                if qr_pat.FieldByName('yxjid').AsInteger=0 then  //前面的病人是普通病人//
                begin
                  patautoid := qr_pat.FieldByName('id').AsString;
                  //将他之前的这个病人退后一位//
                  qr_pat.Close;
                  qr_pat.sql.Text :=' update t_dhxx set kssxid=kssxid+1 '+
                    ' where id='+patautoid;
                  qr_pat.ExecSQL;
                  //当前优先病人提前一位
                  qr_pat.Close;
                  qr_pat.sql.Text :=' update t_dhxx set kssxid=kssxid-1 '+
                    ' where id='+autoid;
                  qr_pat.ExecSQL;
                end;
              end;
              qr_pat.Close;
              qr.Next;
           end;
        end;
        result := true;
//        ADOConnection.CommitTrans;
  except
    begin
//      ADOConnection.RollbackTrans;
//      blRollback := True;
      result := false;  //
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
    FreeAndNil(qr_pat);
  end;
end;
//将当前记录ajrid之后的病人向前提一位，
//将当前科室已就诊病人向前提一位，
//将当前记录改为已呼叫  jzbz=0,

function TdmDBAccess.doUpdateWaitlistPos(const agroupcode, ajrid,ayhid,afjh: string;
  const ahszh: integer): boolean;
var
    kssxid:integer;
    qr : TADOQuery;
    blRollback:boolean;
    retint:integer;
begin
//    cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//            ' where kssxid >(select kssxid from t_dhxx where id=' + tmpjrid +')'+
//            ' and ksid=''' +ksid + '''' +
//            ' and hszh=' + inttostr(gblHszh);
//    adoconnection.Execute(cmdstr ,cmdText);
//    //将这个科室已呼叫过的病人的kssxid-1
//    cmdstr:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//            ' where jzbz=0'+
//            ' and ksid=''' +ksid + '''' +
//            ' and hszh=' + inttostr(gblHszh);
//    adoconnection.Execute(cmdstr ,cmdText);
//    //修改T_dhxx中的数据，将本条数据改为就诊
//    cmdstr:=' UPDATE t_dhxx SET JZBZ=0' +
//            ' ,yhid='''''+
//            ' ,jzsj=getdate()' +
//            ' ,kssxid=0' +
//            ' where id=' + tmpjrid ;
//    adoconnection.Execute(cmdstr ,cmdText);

  result := false;
  qr := TADOQuery.Create(nil);

  try
    qr.Connection := ADOConnection;
//    blRollback:= false;
//    ADOConnection.BeginTrans;
    try
        qr.SQL.Text:=' select 1 from dbo.sysobjects where'+
        ' id = object_id(N''[dbo].[MY_UpdateWaitlistPos]'') '+
        ' and OBJECTPROPERTY(id, N''IsProcedure'') = 1';
        qr.Open;
        retint :=qr.RecordCount;
        if retint>0 then
        begin
        qr.SQL.Clear;
        qr.Parameters.Clear;
        qr.SQL.Text:=' MY_UpdateWaitlistPos '+quotedstr(agroupcode)+','+
          quotedstr(ajrid)+','+quotedstr(ayhid)+','+quotedstr(afjh)+','+inttostr(ahszh);
        qr.ExecSQL;
        qr.Close;
        end
        else
        begin
          qr.SQL.Text:=' select kssxid from t_dhxx(nolock) where id=:p1';
          qr.Parameters.ParamByName('p1').Value := ajrid;
          qr.Open;
          if not qr.Eof then
            kssxid := qr.fieldbyname('kssxid').AsInteger;
          qr.Close;
          qr.SQL.Clear;
          qr.Parameters.Clear;
          qr.SQL.Text:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
              ' where kssxid >=:p1'+//(select kssxid from t_dhxx where id=:p1)'+
              ' and ksid=:p2'+
              ' and hszh=:p3';
          qr.Parameters.ParamByName('p1').Value := kssxid;
          qr.Parameters.ParamByName('p2').Value := agroupcode;
          qr.Parameters.ParamByName('p3').Value := ahszh;
          qr.ExecSQL;
          qr.Close;
          //删除 此语句，此语句会导致死锁//
//          qr.SQL.Clear;
//          qr.Parameters.Clear;
//          qr.SQL.Text:=' UPDATE t_dhxx SET kssxid=kssxid-1' +
//              ' where jzbz=0'+
//              ' and ksid=:p2' +
//              ' and hszh=:p3';
//          qr.Parameters.ParamByName('p2').Value := agroupcode;
//          qr.Parameters.ParamByName('p3').Value := ahszh;
//          qr.ExecSQL;
//          qr.Close;
          qr.SQL.Clear;
          qr.Parameters.Clear;
          qr.SQL.Text:=' UPDATE t_dhxx SET JZBZ=0' +
              ' ,yhid=:p1'+
              ' ,ckhm=:p2'+
              ' ,jzsj=getdate()' +
              ' ,kssxid=0' +
              ' where id=:p3';
          qr.Parameters.ParamByName('p1').Value := ayhid;
          qr.Parameters.ParamByName('p2').Value := afjh;
          qr.Parameters.ParamByName('p3').Value := ajrid;
          qr.ExecSQL;
          qr.Close;
         end;
        result := true;
//        ADOConnection.CommitTrans;
  except
    begin
//      ADOConnection.RollbackTrans;
//      blRollback := True;
      result := false;  //
      Exit;
    end;
  end;
  finally
    FreeAndNil(qr);
  end;
end;
//得到科室是否开启优先类别呼叫
//返回值 1-开启，0-关闭
function TdmDBAccess.getksyxhj(const agroupcode: string): integer;
var
    yxhj:integer;
    qr : TADOQuery;
begin
  result := 0;
  yxhj:=0;
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      qr.SQL.Text:=' select yxhj from t_ks where ksid=:p1 and hszh=:p2';
      qr.Parameters.ParamByName('p1').Value := agroupcode;
      qr.Parameters.ParamByName('p2').Value := gblhszh;
      qr.Open;
      if not qr.Eof then
        yxhj := qr.fieldbyname('yxhj').AsInteger;
      qr.Close;
      result := yxhj;
    except
      begin
        result := 0;  //
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
//得到诊室是否为优先类别呼叫诊室
//返回值 1-开启，0-关闭
function TdmDBAccess.getroomyxhj(const azdid: string): integer;
var
    yxhj:integer;
    qr : TADOQuery;
begin
  result := 0;
  yxhj:=0;
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      qr.SQL.Text:=' select yxhj from t_hjzd where zdid=:p1 and hszh=:p2';
      qr.Parameters.ParamByName('p1').Value := azdid;
      qr.Parameters.ParamByName('p2').Value := gblhszh;
      qr.Open;
      if not qr.Eof then
        yxhj := qr.fieldbyname('yxhj').AsInteger;
      qr.Close;
      result := yxhj;
    except
      begin
        result := 0;  //
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;
//函数名yhcancall//
//作用:查询医生能否呼叫指定的病人
//参数:ajrid: t_dhxx表的id
//ayhid:医生工号
//返回值 :
//true:表示此医生可以呼叫此病人
//false:表示此医生不能呼叫此病人
function TdmDBAccess.yhcancall(const ajrid, ayhid,abrdys: string): boolean;
var
    yxhj:integer;
    qr : TADOQuery;
begin
  if gblkyhjdkstybr=1 then
  begin
    result := true;
    exit;
  end;
  if ((abrdys='0') and (gblbrdys=0)) then
  begin
    result := true;
    exit;
  end;
  result := false;
  yxhj:=0;
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      qr.SQL.Text:=' select 1 from t_dhxx where id=:p1 and yhid=:p2';
      qr.Parameters.ParamByName('p1').Value := ajrid;
      qr.Parameters.ParamByName('p2').Value := ayhid;
      qr.Open;
      if not qr.Eof then  //已经选择了此医生,则可以呼叫//
      begin
        result := true;
      end;
      qr.Close;
      if not result then
      begin
        qr.SQL.Clear;
        qr.Parameters.Clear;
        qr.SQL.Text:=' select 1 from t_dhxx_yh where dhxxid=:p1 and yhid=:p2 and flag=1';
        qr.Parameters.ParamByName('p1').Value := ajrid;
        qr.Parameters.ParamByName('p2').Value := ayhid;
        qr.Open;
        if not qr.Eof then  //已经选择了此医生,则可以呼叫//
        begin
          result := true;
        end;
        qr.Close;
        if not result then
        begin
          qr.SQL.Clear;
          qr.Parameters.Clear;
          qr.SQL.Text:=' select 1 from t_dhxx_yh where dhxxid=:p1 and flag=1';
          qr.Parameters.ParamByName('p1').Value := ajrid;
          qr.Open;
          if not qr.Eof then  //有选择其它医生，则不可以呼叫//
          begin
            result := false;
          end
          else //没有选择医生,则查询是否排除了此医生
          begin
            qr.close;
            qr.SQL.Clear;
            qr.Parameters.Clear;
            qr.SQL.Text:=' select 1 from t_dhxx_yh where dhxxid=:p1 and yhid=:p2 and flag=-1';
            qr.Parameters.ParamByName('p1').Value := ajrid;
            qr.Parameters.ParamByName('p2').Value := ayhid;
            qr.Open;
            if qr.Eof then  //没有排除此医生，则可以呼叫//
            begin
              result := true;
            end;
          end;
          qr.Close;
        end;
      end;
    except
      begin
        result := true;  //出错，则返回可以呼叫
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;


//函数名addyhcancall//
//作用:添加其它科室此病人的排除医生/选择医生
//参数:ajrid: t_dhxx表的id
//ayhid:医生工号
//aflag:1-选择医生，  -1 -排除医生
//返回值 :
//true:表示成功
//false:表示失败
function TdmDBAccess.addyhcancall(const ajrid, ayhid,
  aflag: string): boolean;
var
    yxhj:integer;
    qr : TADOQuery;
begin
  if gblkyhjdkstybr=1 then
  begin
    result := true;
    exit;
  end;
  result := false;
  yxhj:=0;
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      qr.SQL.Text:=' insert into t_dhxx_yh(hszh,ksid,ghhm,brdm,brxm,by4,dhxxid,yhid,flag)'+
                   ' select a.hszh,a.ksid,a.ghhm,a.brdm,a.brxm,a.by4,a.ID,:p1,:p2 '+
                   ' from t_dhxx a,(select hszh,ksid,ghhm,brdm,brxm,by4,ID from t_DHXX where ID=:p3) b '+
                   ' where a.BRDM=b.BRDM and a.BRXM=b.BRXM and a.hszh=b.hszh and a.KSID<>b.KSID and a.jzbz<>0';
      qr.Parameters.ParamByName('p1').Value := ayhid;
      qr.Parameters.ParamByName('p2').Value := aflag;
      qr.Parameters.ParamByName('p3').Value := ajrid;
      qr.ExecSQL;
      result := true;
    except
      begin
        result := false;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;


//函数名addyhcannotcall//
//作用:添加本科室此病人的排除医生
//参数:ajrid: t_dhxx表的id
//ayhid:医生工号
//aflag:1-选择医生，  -1 -排除医生
//返回值 :
//true:表示成功
//false:表示失败
function TdmDBAccess.addyhcannotcall(const ajrid: string): boolean;
var
    yxhj:integer;
    qr : TADOQuery;
begin
  if gblkyhjdkstybr=1 then
  begin
    result := true;
    exit;
  end;
  result := false;
  yxhj:=0;
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
      qr.SQL.Text:=' insert into t_dhxx_yh(hszh,ksid,ghhm,brdm,brxm,by4,dhxxid,yhid,flag)'+
                   ' select b.hszh,b.ksid,b.ghhm,b.brdm,b.brxm,b.by4,b.ID,a.YHID,-1 '+
                   ' from t_dhxx a,'+
                   '(select hszh,ksid,ghhm,brdm,brxm,by4,ID from t_DHXX where ID=:p1) b'+
                   ' where a.BRDM=b.BRDM and a.BRXM=b.BRXM and a.hszh=b.hszh '+
                   ' and a.KSID<>b.KSID and ISNULL(a.yhid,'''')<>'''''; //and a.JZBZ=0 
      qr.Parameters.ParamByName('p1').Value := ajrid;
      qr.ExecSQL;
      result := true;
    except
      begin
        result := false;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;

end;
//函数名doLockOtherGroupSamePat//
//作用:将此病人其它科室的号锁定(即改为未激活状态jzbz=2,ztbz=6)
//参数:ajrid: t_dhxx表的id
//返回值 :
//true:表示成功
//false:表示失败
function TdmDBAccess.doLockOtherGroupSamePat(const ajrid: string): boolean;
var
    qr,qr1: TADOQuery;
    hszh,ksid,brdm,brxm,jrid:string;
begin
  if gblsdqtksbr=0 then   //不锁定//
  begin
    result := true;
    exit;
  end;
  result := false;
  qr := TADOQuery.Create(nil);
  qr1 := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    qr1.Connection := ADOConnection;
    try
      qr.SQL.Text:=' select a.hszh,a.ksid,a.brdm,a.brxm,a.id from t_dhxx a,t_dhxx b'+
         ' where b.id=:p1 and a.brdm=b.brdm and a.brxm=b.brxm '+
         ' and a.brdm<>'''' and b.brxm<>'''''+
         ' and a.ksid<>b.ksid and a.jzbz=1';
      qr.Parameters.ParamByName('p1').Value := ajrid;
      qr.Open;
      while not qr.Eof do
      begin
        hszh := qr.fieldbyname('hszh').AsString;
        ksid := qr.fieldbyname('ksid').AsString;
        brdm := qr.fieldbyname('brdm').AsString;
        brxm := qr.fieldbyname('brxm').AsString;
        jrid := qr.fieldbyname('id').AsString;
        qr1.SQL.Clear;
        qr1.Parameters.Clear;
        qr1.SQL.Text := ' update t_dhxx set ztbz=6,jzbz=2 where id=:p1';
        qr1.Parameters.ParamByName('p1').Value :=jrid;
        if qr1.ExecSQL>0 then
        begin
          insertnotifygrouptorefresh(strtoint(hszh),ksid,strtoint(hszh));
        end;
        qr.Next;
      end;
      result := true;
    except
      begin
        result := false;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
    FreeAndNil(qr1);
  end;

end;
//函数名doUnLockOtherGroupSamePat//
//作用:将此病人其它科室的号激活(即改为未激活状态jzbz=1,ztbz=1)
//参数:ajrid: t_dhxx表的id
//返回值 :
//true:表示成功
//false:表示失败
function TdmDBAccess.doUnLockOtherGroupSamePat(
  const ajrid: string): boolean;
var
    qr,qr1: TADOQuery;
    hszh,ksid,brdm,brxm,jrid:string;
begin
  if gblsdqtksbr=0 then   //不锁定//
  begin
    result := true;
    exit;
  end;
  result := false;
  qr := TADOQuery.Create(nil);
  //qr1 := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    //qr1.Connection := ADOConnection;
    try
      qr.SQL.Text:=' select a.hszh,a.ksid,a.brdm,a.brxm,a.id from t_dhxx a,t_dhxx b'+
         ' where b.id=:p1 and a.brdm=b.brdm and a.brxm=b.brxm '+
         ' and a.brdm<>'''' and b.brxm<>'''''+
         ' and a.ksid<>b.ksid and a.jzbz=2';
      qr.Parameters.ParamByName('p1').Value := ajrid;
      qr.Open;
      while not qr.Eof do
      begin
//        hszh := qr.fieldbyname('hszh').AsString;
//        ksid := qr.fieldbyname('ksid').AsString;
//        brdm := qr.fieldbyname('brdm').AsString;
//        brxm := qr.fieldbyname('brxm').AsString;
        jrid := qr.fieldbyname('id').AsString;
        if wakeupbyid(jrid) then  //激活成功//刷新列表
        begin
          //insertnotifygrouptorefresh(strtoint(hszh),ksid,strtoint(hszh));
        end;
        qr.Next;
      end;
      result := true;
      if gbledit_ks_count>0 then //如果激活成功//
      begin
        frmmain.SXKSXX;
      end;
    except
      begin
        result := false;
        Exit;
      end;
    end;
  finally
    FreeAndNil(qr);
    //FreeAndNil(qr1);
  end;


end;

{*******************************************************************************
*函数名:YHAskRoom;
                                           *
*函数机能:得到号码对应的呼叫医生及诊室.                                          *
*******************************************************************************}

function TdmDBAccess.YHAskRoom(const zdid:string;const cmd:string;const CallNO :string):string;
var
   intFieldsIndex:integer;
   zdyhid,zdyhmc,fjh,fjmc,zth,ztmc:string ;
//   hjksid:array[1..3] of string;
//   hjksmc:array[1..3] of string ;
   i :integer;
   hjksnum:integer;
   hjks:array [1..20] of CallGroup_Info;
   cmdstr:widestring;
   kssxid,JRID,GHHM,BRXM,YXJID,yxjmc,JZBZ:string;
   brdm,by4:string;
   DDRS:integer;
   iscall :boolean;
   retstr:string;
   tmpadoquery:Tadoquery;
   by6,by3:string;
   ksbrdys:string;
   strCallNo,strCallKsid:string;
   ps : integer;
   qr:TADOQuery;
   ysxm:string;
begin
  qr:=TADOQuery.Create(nil);
  try
    qr.Connection :=ADOConnection;
  try
    strCallKsid := '';
    ps := FoundChar(',',CallNO);
    if ps>0 then
    begin
      strCallNo := Copy(CallNO,1,ps-1);
      strCallKsid :=Copy(CallNO,ps+1,Length(CallNO)-ps);
    end
    else
      strCallNo := CallNO;
    //gbledit_ks_count:=0;
    result:='';
    iscall:=false;
    qr.Close;
    //在等待T_hjzd表中查找zdid.
    qr.SQL.Text:=' select zdid,fjh,zth,ztmc,t_hjzd.yhid,yhmc,fjmc from  ' +
                            ' t_hjzd left outer join t_yh on ' +
                            ' t_hjzd.yhid =t_yh.yhid and t_hjzd.hszh=t_yh.hszh ' +
                            ' where t_hjzd.hszh=' + inttostr(gblhszh) + ' and zdid=' + zdid ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          zdyhid:=fields.fields[4].asstring ;
          zdyhmc:=fields.fields[5].asstring;
          fjh:=fields.Fields[1].AsString;
          fjmc:=fields.Fields[6].AsString;
          zth:=fields.Fields[2].AsString;
          ztmc:=fields.Fields[3].AsString;
          if ( zdyhid <>'')  then
             begin
             close;
             end
          else
             begin
             if (cmd='40') or (cmd='57') or (cmd='43') then
              result:=zdid +cmd  +'还没有登录!    '+'请登录工号    '
             else
             result:=zdid+cmd + '028888';///没有登录.
             close;
             exit;
             end;
       end
       else
       begin
           if (cmd='40') or (cmd='57') or (cmd='43') then
            result:=zdid +cmd  +'无此呼叫器!    '+'请管理员设置  '
           else
           result:=zdid + cmd + '038888';  ///没有此呼叫器
           close ;
           exit;
       end;
    end;
    //在等待T_YH表中查找YHID信息.
    qr.SQL.Text:='SELECT t_YH.YHID, t_YH.YHMC,' +
              ' t_YH.KSID1, table1.KSMC AS ksmc1, t_YH.KSID2,table2.KSMC AS ksmc2, t_YH.KSID3, table3.KSMC AS ksmc3 ' +
              ' FROM t_YH LEFT OUTER JOIN ' +
              ' t_KS table1 ON t_YH.KSID1 = table1.KSID AND t_YH.HSZH = table1.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table2 ON t_YH.KSID2 = table2.KSID AND t_YH.HSZH = table2.HSZH ' +
              ' LEFT OUTER JOIN  ' +
              ' t_KS table3 ON t_YH.KSID3 = table3.KSID AND t_YH.HSZH = table3.HSZH ' +
              ' WHERE (t_YH.YHID = ''' + ZDYHID +''''+ ') AND (t_YH.HSZH = ' + inttostr(gblHszh) +')'  ;
    qr.Open;
    ///////////将中.
    with qr do
    begin
       if not qr.Eof  then
       begin
          GetYHCallKS(zdyhid,hjksnum,hjks);
          if hjksnum=0 then
           begin
             if (cmd='40') or (cmd='57') or (cmd='43') then
              result:=zdid +cmd  +'未设置呼叫队列!'+'请管理员设置! '
             else
             result:=zdid + cmd + '048888';  //没有找到呼叫的科室
             exit;
           end;
           close;
       end
       else
       begin
           if (cmd='40') or (cmd='57') or (cmd='43') then
            result:=zdid +cmd  +'未设置此工号!  '+'请管理员设置  '
           else
           result:=zdid + cmd + '008888';  //没有此用户号
           Close;
           exit;
       end;
    end;

    ////查找此科室的病人.
    if hjksnum>0 then
    begin
       for i:=1 to hjksnum do
       begin
          if Length(strCallKsid)>0 then
          begin
            if strCallKsid<>hjks[i].TGroupid then
             Continue;
          end;
          ////////根据是否使用选医生功能.
          if iscall then
              break;
          cmdstr:=' select id,ghhm,y.yhmc,h.fjmc from  ' +
             ' t_dhxx left OUTER join t_yh y on t_dhxx.yhid=y.yhid and t_dhxx.hszh=y.hszh ' +
             ' left outer join t_hjzd h on t_dhxx.ckhm=h.fjh and t_dhxx.hszh=h.hszh '+
             ' where ksid=''' + hjks[i].TGroupid +''''+
             ' and t_dhxx.hszh=' +inttostr(gblhszh) +
             ' and t_dhxx.ghhm=''' + strCallNo + ''''+
             ' and jzbz=0 '+ //已被呼叫过，则不用指定医生
             ' order by t_dhxx.jzbz desc,t_dhxx.kssxid ';
          ////////////
          qr.SQL.Text:=cmdstr;
          qr.Open;
          ///////////将中.
          with qr do
          begin
            if not qr.Eof  then
            begin
                //在T_DHXX表中查找到要呼叫的病人信息,返回给呼叫终端.
                jrid:=fields.Fields[0].AsString;
                GHHM:=fields.fields[1].asstring;
                ysxm:=Fields.Fields[2].asString;
                fjmc:=fields.fields[3].asstring;
                result:=zdid +cmd  +'01' + ysxm +',' +fjmc;
                iscall:=true;
            end;
            close;
          end;

       end;
       if iscall=false  then
        begin
          result:=zdid +cmd  +'000000'  ;
        end;
    end;
  except
    begin
      result := zdid + cmd + '068888';  ///有错误发生.
      Exit;
    end;
  end;
  finally
    qr.Free;
  end;
end;
function TdmDBAccess.getHisPbYSDM(const anewksid, ayksdm: string;
  var pnewyhid: string): integer;
var
  sp:TADOStoredProc;
begin
  pnewyhid:='';
  try
    sp := TADOStoredProc.Create(nil);
    sp.Connection := ADOConnection;
    try
      //sp.ProcedureName :='my_GetGroupPatientPos';
      sp.ProcedureName :='my_HisPbYSDM';
      sp.Parameters.CreateParameter('newksid',ftString,pdInput,20,anewksid);
      sp.Parameters.CreateParameter('yksdm',ftString,pdInput,20,ayksdm);
      sp.Open;
      if sp.RecordCount>0 then
      begin
        pnewyhid := sp.fieldbyname('ygbh').AsString;
        Result  :=0;
      end
      else
       Result  :=-1;
    except
      Result := 0;
    end;
  finally
    FreeAndNil(sp);
  end;
end;
function TdmDBAccess.SetHisYSDM(const aby4: string;
  const anewyhid: string): integer;
var
  sp:TADOStoredProc;
begin
  try
    sp := TADOStoredProc.Create(nil);
    sp.Connection := ADOConnection;
    try
      //sp.ProcedureName :='my_GetGroupPatientPos';
      sp.ProcedureName :='my_SetHisYSDM';
      sp.Parameters.CreateParameter('SBXH',ftString,pdInput,20,aby4);
      sp.Parameters.CreateParameter('YGBH',ftString,pdInput,20,anewyhid);
      sp.ExecProc;
      Result :=0;
    except
      Result := 0;
    end;
  finally
    FreeAndNil(sp);
  end;
end;
function TdmDBAccess.Db_getysghxx(const anewbrdm, anewbrxm, aby4,
  anewyhid: string): boolean;
var
    qr,qr1: TADOQuery;
    hszh,ksid,brdm,brxm,jrid:string;
begin
  result := false;
  qr := TADOQuery.Create(nil);
  try
    qr.Connection := ADOConnection;
    try
//      qr.SQL.Text:='select 1 from t_dhxx '+
//       ' where  BRDM=:p1 and BRXM=:p2'+
//       ' and BY4=:p3 and YHID=:p4';
      qr.SQL.Text:='select 1 from t_dhxx '+
       ' where  BRDM=:p1 and BRXM=:p2'+
       ' and YHID=:p4';
      qr.Parameters.ParamByName('p1').Value := anewbrdm;
      qr.Parameters.ParamByName('p2').Value := anewbrxm;
      //qr.Parameters.ParamByName('p3').Value := aby4;
      qr.Parameters.ParamByName('p4').Value := anewyhid;
      qr.Open;
      if not qr.Eof then
      begin
        result := true;
      end
      else
        result := false;
      qr.Close;
    except
      begin
        result := false;
      end;
    end;
  finally
    FreeAndNil(qr);
  end;
end;

function TdmDBAccess.RequeueMarkedPat: boolean;
var
  tmpquery : Tadoquery;
  rs,weifenzhenrs:integer;
  kssxid,jrid,ksid,ksmc,brdm,brxm,by4,by7,by1,yhid:string;
  newksid:string;
begin
  if gblChongxinFenZhen=0 then //不重新分诊则退出//
  begin
    result := false;
    exit;
  end;
  try
  try
  with adoconnection do
  begin
       tmpquery:=tadoquery.Create(nil);
       tmpquery.Connection:=adoconnection;
       if gblChongxinFenZhen=1 then
       begin
         tmpquery.SQL.Clear;
         //--处理未分诊病人--
         tmpquery.SQL.Add('Select top 10 kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
           ',brdm,jzbz,d.ztbz,by5,by1,by7,yhid,by4'+
           ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
           ' and d.hszh=k.hszh'+
           ' where d.hszh='+inttostr(gblHSZH)+
           ' and ((k.fenzhen=1 and by1=88) or (k.fenzhen=2 and ghsj>convert(varchar(10),getdate(),120)))'+
           ' and d.jzbz in (1,2)'+
           //' and (by1=88)'+
           ' order by d.ghsj desc,d.ksid desc');
         try
           tmpquery.Open;
         except
           tmpquery.SQL.Clear;
           tmpquery.SQL.Add('Select top 10 kssxid,d.id,d.ksid,ksmc,brxm,ghhm'+
             ',brdm,jzbz,d.ztbz,by5,by1,by7,yhid,by4'+
             ' from t_dhxx d left outer join t_ks k on d.ksid=k.ksid '+
             ' and d.hszh=k.hszh'+
             ' where d.hszh='+inttostr(gblHSZH)+
             ' and k.memo=''未分诊'''+
             ' and d.jzbz in (1,2)'+
             ' and by1=88'+
             ' order by d.ghsj desc,d.ksid desc');
           tmpquery.Open;
         end;
         rs :=tmpquery.RecordCount;
         weifenzhenrs :=0;
         if tmpquery.RecordCount>0 then
         begin
           //gbledit_ks_count :=0;
           while not tmpquery.Eof do
           begin

             //如果没有在已分诊科室中，则
             //重新分配一个号码并打印
             if ((tmpquery.fieldbyname('jzbz').AsString='1')
              or (tmpquery.fieldbyname('jzbz').AsString='2')) then //如果未分诊
             begin
               weifenzhenrs :=weifenzhenrs+1;
               kssxid := tmpquery.fieldbyname('kssxid').AsString;
               jrid :=  tmpquery.fieldbyname('id').AsString;
               ksid := tmpquery.fieldbyname('ksid').AsString;
               newksid := 'FZ'+ksid;
               ksmc := tmpquery.fieldbyname('ksmc').AsString;
               brdm := tmpquery.fieldbyname('brdm').AsString;
               brxm := tmpquery.fieldbyname('brxm').AsString;
               yhid := tmpquery.fieldbyname('yhid').AsString;
               by4  := tmpquery.fieldbyname('by4').AsString;;
               by7 :=  tmpquery.fieldbyname('by7').AsString;
               by1 :=  tmpquery.fieldbyname('by1').AsString;
               //直接取一个新号码//
               if dmdbaccess.QuHao(newksid,ksmc,brdm,brxm,yhid,'',by7,'','',by4,'','') then
               begin
                  //分诊成功后将此病人激活//或者将此病人弃号//
                  dmdbaccess.Qh(jrid,kssxid,ksid);
                  insertnotifygrouptorefresh(gblhszh,ksid,gblhszh);
                end;
             end;
             tmpquery.Next;
           end;

         end;
         tmpquery.close;
      end;
  end;
    result := true;
  except
    result := false;
  end;
  finally
    freeandnil(tmpquery);
  end;
end;

function TdmDBAccess.ReadFromHzxxToDhxx(const hszh: integer;
  const AgroupID: string): boolean;
var
  i:integer;
  dyzs:integer;//打印票单张数;
  cmdStr:wideString; //SQL字符串;
  cmdstr_sjd:widestring;//SQL字符串
  kssxid,x:integer;
  tmpkssxid:integer;
  ksid:string; //科室ID
  ksmc:string; //科室名称;
  brxm:string; //病人姓名
  brdm:string;  //病人代码;
  ghhm:string;  //挂号号码;
  ghsj:tdatetime;//挂号时间
  ztbz:string;   //状态标志
  yhid:string;   //医生工号
  yhxm:string;//医生姓名.
  jzbz:string;   //读取标志.
  yxjid:integer;//优先级
  by1:integer;   //
  by2:integer;
  by3:string;
  by4:string;
  by5:string;
  by6:string;
  by7:string;
  lc:string;
  yksdm:string;
  rec_id:string;
  sjdbz:integer;   //时间段标志
  ddrs:integer;    //等待人数
  isExsit:boolean; //是否存在.
  maxkssxid:integer;
  dhztbz:string;
  tmpadoquery:tadoquery;
  jrid:string;
  tmpHMPX:integer;
  tmpghhm:integer;
  blRollback,bAtTime:Boolean;
  qr:Tadoquery;
  tmpadodataset,tmpadodataset1:Tadodataset;
  mzh,xb,nl:string;//门诊号，性别，年龄;
  xmsp:string;//姓名首拼
  rebackid:string;
  groupnumber_index:integer;
  yysjdjh:string;
begin
    //addlog('errorlog.txt','进入读取ReadFromGhxxToDhxx');
    if gblisreadhzxx then
    begin
      if (now-gblinreadhzxxtime)*24*60*60>60 then
      begin
        addlog('errorlog.txt','进入读取ReadFromHzxxToDhxx，读取时间超过1分钟.');
        gblisreadhzxx := false;
      end
      else
      begin
       result:=false;
       exit;
      end;
    end;
  try
    gblisreadhzxx:=true;
    gblinreadhzxxtime := now;
    tmpadodataset := tadodataset.Create(nil);
    tmpadodataset1 := tadodataset.Create(nil);
  try
    tmpadodataset.Connection := adoconnection;
    tmpadodataset1.Connection := adoconnection;
    //gbledit_ks_count:=0;
    if gblZDLD=1 then
    begin
       if gblSJDFW=1 then
          cmdstr_sjd:=' and sjdbz='+ inttostr(gblsjdbz)  +
                    ' and ghsj >=''' + cdatetostr(date) +'''' +
                    ' and ghsj <''' + cdatetostr(date+1) + ''''
       else
          cmdstr_sjd:=' and ghsj >=''' + cdatetostr(date) +'''' +
                    ' and ghsj <''' + cdatetostr(date+1) + '''';
       if gblyssj>0 then
          cmdstr_sjd:=cmdstr_sjd + ' and  DATEDIFF(s,ghsj, getdate())>' + inttostr(gblyssj)
       else
       begin
          tmpadodataset.Close;
          tmpadodataset.CommandText :='select readdelay from t_ks';
          try
            tmpadodataset.Open;
            cmdstr_sjd:=cmdstr_sjd + ' and  DATEDIFF(s,ghsj, getdate())>('+
            'select top 1 case readdelay when 0 then -24*3600 else readdelay end'+
            ' from t_ks where ksid=g.ksid and (hszh='+inttostr(hszh)+'))';
          except
          end;
          tmpadodataset.Close;
       end;
       ///从GHXX表中取数据
       tmpadodataset.Close;
       if gblhavemzh=1 then
       begin
       tmpadodataset.Commandtext:='SELECT g.id '+
              ' ,g.ksid ' +
              ' ,g.brxm,g.brdm'+
              ' ,g.ghhm,g.ghsj' +
              ' ,g.ztbz,g.yhid' +
              ' ,g.by1,g.by2' +
              ' ,g.by3,g.by4' +
              ' ,g.jzbz,g.sjdbz' +
              ' ,k.ksmc  '+
              ' ,g.by5,g.by6'+
              ',g.by7,g.lc'+
              ',g.mzh,g.xb,g.nl,g.yksdm'+
              ' from t_hzxx g(nolock) inner join  ' +
              ' t_ks k on (g.ksid =k.ksid and k.hszh='+inttostr(hszh)+
              ' and (g.hszh=k.hszh or g.hszh=0))' +
              ' WHERE (g.HSZH =' + inttostr(hszh) +' or g.hszh=0)'+
              ' and g.ztbz<>9' +
              cmdstr_sjd +
              ' order by id ';
       end
       else
       begin
       tmpadodataset.Commandtext:='SELECT g.id '+
              ' ,g.ksid ' +
              ' ,g.brxm,g.brdm'+
              ' ,g.ghhm,g.ghsj' +
              ' ,g.ztbz,g.yhid' +
              ' ,g.by1,g.by2' +
              ' ,g.by3,g.by4' +
              ' ,g.jzbz,g.sjdbz' +
              ' ,k.ksmc  '+
              ' ,g.by5,g.by6'+
              ',g.by7,g.lc'+
              ' from t_hzxx g(nolock) inner join  ' +
              ' t_ks k on (g.ksid =k.ksid and k.hszh='+inttostr(hszh)+
              ' and (g.hszh=k.hszh or g.hszh=0))' +
              ' WHERE (g.HSZH =' + inttostr(hszh) +' or g.hszh=0)'+
              ' and g.ztbz<>9' +
              cmdstr_sjd +
              ' order by id ';
       end;
       tmpadodataset.Open;
       //查询还未处理的病人(t_ghxx表中ztbz<>9)//
       with tmpadodataset do
       begin
         while  not tmpadodataset.Eof do
         begin
             application.ProcessMessages;

             rec_id:=fields.Fields[0].AsString;
//             dmdbaccess.addlog('errorlog.txt',formatdatetime('yyyy-mm-dd hh:nn:ss:zzz',now)+' 开始读取rec_id:'+rec_id);
             ksid:=trim(fields.Fields[1].AsString);
             brxm:=trim(fields.Fields[2].AsString);
             xmsp:=GetStrPYIndex(StringReplace(Trim(brxm),' ','',[rfReplaceAll]));;//得到首拼
             brdm:=trim(fields.Fields[3].asstring);
             ghhm:=trim(fields.fields[4].asstring);
             ghsj:=fields.Fields[5].AsDateTime;
             ztbz:=fields.Fields[6].AsString;
             yhid:=trim(fields.Fields[7].AsString);
             yxjid:=fields.Fields[8].AsInteger;
             by1:=fields.Fields[8].AsInteger;
             by2:=fields.Fields[9].AsInteger;
             by3:=fields.Fields[10].AsString;
             by4:=trim(fields.Fields[11].AsString);
             jzbz:=fields.Fields[12].AsString;
             yysjdjh :=getdbvalue(D003,ksid,'yysjdjh');
             if yysjdjh='1' then
             begin
               yysjdjh := '2';
             end
             else if  yysjdjh='0' then
             begin
               yysjdjh := '0';
             end
             else
                yysjdjh :=inttostr(gblyysjdjh);

             //if ztbz='2' then  //召回//
             begin
               ADOConnection.BeginTrans;
               blRollback := False;
               rebackid :='';
               try
                 try
                   cmdstr:=' UPDATE t_hzxx ' +
                         ' set ztbz=9 ' +
                         ' where id=' + rec_id;
                   adoconnection.Execute(cmdstr,cmdtext);

                   tmpadodataset1.Close;
                   tmpadodataset1.Commandtext:=' select ksid,brdm,id from t_dhxx ' +
                          ' where ksid=''' +ksid +''''+
                          ' and brdm='+quotedstr(brdm)+
                          ' and ghhm='+quotedstr(ghhm)+
                          ' and jzbz=0 ' +
                          ' and hszh=' + inttostr(gblhszh);
                   tmpadodataset1.Open;
                   if not tmpadodataset1.Eof then
                   begin
                     rebackid := tmpadodataset1.fieldbyname('id').AsString;
                   end;
                   tmpadodataset1.Close;
                   ADOConnection.CommitTrans;
                 except
                   ADOConnection.RollbackTrans;
                   blRollback := True;
                   addlog('errorlog.txt','查询召回数据时有错误发生!'+cmdstr);
                 end;
               finally

               end;
               if rebackid<>'' then
               begin
                 //召回
                 if dmdbaccess.FZZH(rebackid,ksid,1,'',1) then
                 begin
                    isExsit:=false;
                    for i :=0 to gbledit_ks_count -1 do
                    begin
                       if gbledit_ks[i].ksid=fields.Fields[1].AsString then
                          begin
                             isexsit:=true;
                             break;
                          end;
                    end;
                    if gblFormType=1 then
                    begin
                      if dmDBAccess.GetDBValue('KS',fields.Fields[1].AsString,'hided')='1' then
                      begin
                        dmDBAccess.SetDBValue('KS',fields.Fields[1].AsString,'hided','0');
                        frmMain.ReflushGroupList();
                      end;
                    end;
                    if isexsit=false then
                    begin
                       gbledit_ks_count:=gbledit_ks_count +1;
                       gbledit_ks[gbledit_ks_count-1].ksid:=ksid;
                       gbledit_ks[gbledit_ks_count-1].ksmc:=ksmc;   //fields.Fields[];
                    end;
                 end;
               end;
             end;
             next;
             sleep(10);
         end;
         Close;
       end;
    end;
    result:=true;
    gblisreadhzxx:=false;
  except
    on e:Exception do
      begin
         //showmessage(e.message+'eoleexception');
         //disconnect;
         //sleep(1000);
         //connect;
         gblisreadhzxx:=false;
         addlog('ErrorLog.txt',e.Message+cmdstr);
         //errproc();
         result:=false;
         exit;
      end;
  end;
  finally
    gblisreadhzxx:=false;
    freeandnil(tmpadodataset);
    freeandnil(tmpadodataset1);
  end;

end;

end.